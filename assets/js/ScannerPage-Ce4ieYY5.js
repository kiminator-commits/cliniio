const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/main-FsBT3Y_8.js","assets/js/utils-DSBVV_PW.js","assets/js/vendor-DoALFvsH.js","assets/js/login-em2Hs6UG.js","assets/js/data-73RVSc-N.js","assets/js/ui-CbhfWbfq.js","assets/js/errors-CsB9ZK3e.js","assets/css/main-DtMVykw2.css"])))=>i.map(i=>d[i]);
import{j as e,m as q}from"./utils-DSBVV_PW.js";import{a as u,R as Xe}from"./vendor-DoALFvsH.js";import{ar as et,as as tt,c as de,i as Oe,e as Le,I as T,S as oe,at,j as qe,b as ue,m as rt,au as He,af as st,ag as ot,H as Se,r as Ke,Y as nt,av as lt,n as Ve,$ as ct,a as it,a0 as dt}from"./errors-CsB9ZK3e.js";import{u as W,T as Ge,a as Ce,P as ye,F as ut,b as _e,v as mt,I as Y,l as ht}from"./main-FsBT3Y_8.js";import{s as M,M as re,J as Pe,_ as pt,S as gt,u as Ye}from"./login-em2Hs6UG.js";import"./ui-CbhfWbfq.js";import"./data-73RVSc-N.js";class xt{static scanTool(a,t){const i=t.map(d=>d.barcode),o=i[Math.floor(Math.random()*i.length)],c=t.find(d=>d.barcode===o);return c?{success:!0,message:`Successfully processed ${c.name} for ${a} workflow`,tool:c}:{success:!1,message:"No tools available for scanning"}}}var ft=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const bt=()=>{const[r,a]=u.useState(!1),[t,i]=u.useState(""),[o,c]=u.useState(null),[d,n]=u.useState(""),{availableTools:s,addToolToCycle:l}=W();return{isScanning:r,scannedCode:t,scanResult:o,scanMessage:d,simulateScan:(f,g,p=!1)=>ft(null,null,function*(){var y;a(!0),n(`Scanning tool for ${f} workflow...`);try{if(f==="clean"){const{data:x}=yield M.from("tools").select("barcode").eq("status","clean").eq("facility_id","550e8400-e29b-41d4-a716-446655440000").limit(10);let b;!x||x.length===0?(console.log("🧪 No clean tools found in database, using mock data for testing"),b="TEST-CLEAN-001"):b=x[Math.floor(Math.random()*x.length)].barcode;const h=yield Ge.scanToolForCleanWorkflow(b);i(((y=h.tool)==null?void 0:y.barcode)||""),h.success&&h.tool?(l(h.tool.id),c("success"),n(h.message),p||setTimeout(g,2e3)):(c("error"),n(h.message))}else{setTimeout(()=>{var x;const b=xt.scanTool(f,s);i(((x=b.tool)==null?void 0:x.barcode)||""),b.success&&b.tool?(l(b.tool.id),c("success"),n(b.message),p||setTimeout(g,2e3)):(c("error"),n(b.message)),a(!1)},1e3);return}}catch(x){console.error("Error during scan:",x),c("error"),n("An unexpected error occurred during scanning.")}finally{a(!1)}})}};var yt=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const vt=r=>{var a;typeof window!="undefined"&&((a=window.toast)!=null&&a.error)?window.toast.error(r):console.warn("⚠️",r)},jt=({scannedData:r,toolId:a,onClose:t,batchMode:i=!1})=>{const{availableTools:o,currentCycle:c,addPhaseToCycle:d,startPhase:n,addToolToCycle:s}=W(),[l,m]=u.useState(!1),[f,g]=u.useState(null),[p,y]=u.useState([]),[x,b]=u.useState({show:!1,tool:null}),h=u.useCallback(C=>o.find(j=>j.barcode===C),[o]),N=u.useCallback(()=>a?o.find(C=>C.id===a):h(r),[a,o,h,r])(),R=u.useCallback(()=>!c||!N?!1:c.tools.includes(N.id),[c,N]),E=u.useCallback(C=>yt(null,null,function*(){if(!C||typeof C!="string"||C.trim()===""){vt("No barcode detected — please rescan.");return}const j=C.trim();console.info("✅ Scanned barcode received:",j),m(!0),g(null);try{yield new Promise(z=>setTimeout(z,1e3));const P=h(j);if(!P){g({type:"error",text:`Tool with barcode "${j}" not found in inventory.`});return}if(p.find(z=>z.id===P.id)){g({type:"error",text:`Tool "${P.name}" already scanned.`});return}const L=W.getState();if(L.checkToolReplacementNeeded&&L.checkToolReplacementNeeded(P.id)){b({show:!0,tool:P});return}y(z=>{const I=[...z,P];return g(i?{type:"success",text:`Tool "${P.name}" added to batch. Total: ${I.length} tools.`}:{type:"success",text:`Tool "${P.name}" scanned successfully. Ready for sterilization.`}),I})}catch(P){g({type:"error",text:"Failed to scan tool. Please try again."}),console.error("Scan error:",P)}finally{m(!1)}}),[h,i,p]),D=u.useCallback(()=>{if(!c)return null;const C=c.phases.find(P=>P.isActive),j=c.tools.length;return{cycleId:c.id,operator:c.operator,totalTools:j,activePhase:(C==null?void 0:C.name)||"No active phase",startTime:c.startTime}},[c]),$=u.useCallback(()=>{const C=(c==null?void 0:c.phases.some(z=>z.id==="bath1"&&z.isActive))||!1,{getTimer:j}=Ce.getState(),P=j("bath1"),L=(P==null?void 0:P.isRunning)||!1;return C||L},[c]),k=u.useCallback(()=>{y([]),g(null)},[]),A=u.useCallback(()=>{b({show:!1,tool:null}),g({type:"error",text:"Tool marked for replacement. Please replace with a new tool before continuing."})},[]),S=u.useCallback(()=>{x.tool&&(y(C=>[...C,x.tool]),g({type:"success",text:`Tool "${x.tool.name}" added despite needing replacement.`})),b({show:!1,tool:null})},[x.tool]),B=u.useCallback(()=>{b({show:!1,tool:null})},[]),H=u.useCallback(C=>{if(!C||C.length===0){console.warn("⚠️ handleSendToBath1 called with no tools.");return}if($()){g({type:"error",text:"⚠️ Bath 1 timer is already in process. Please wait for the current phase to complete before starting a new one."});return}try{C.forEach(P=>{s(P.id);const L=W.getState();console.log(`Tool ${P.id} status updated to bath1`)}),d("bath1",ye.bath1.name,ye.bath1.duration*60),n("bath1");const{startTimer:j}=Ce.getState();j("bath1",ye.bath1.duration*60),g({type:"success",text:`🚀 ${C.length} tools sent to Bath 1! Phase timer started.`}),y([]),t&&t()}catch(j){console.error("❌ Error in handleSendToBath1:",j),g({type:"error",text:"Failed to start Bath 1 phase. Please try again."})}},[s,d,n,g,t,$]);return u.useEffect(()=>{if(f){const C=setTimeout(()=>{g(null)},5e3);return()=>clearTimeout(C)}},[f]),{tool:N,currentCycle:c,isScanning:l,scanMessage:f,scannedTools:p,batchMode:i,handleScanTool:E,handleSendToBath1:H,clearScannedTools:k,isToolInCycle:R(),isBath1Active:$(),cycleStatus:D(),replacementAlert:x,handleReplaceTool:A,handleContinueAnyway:S,handleDismissReplacementAlert:B}},wt=()=>{const{setWorkflowType:r,setScannedData:a,scannedData:t}=W(),{isScanning:i,scanResult:o,scanMessage:c,simulateScan:d}=bt(),[n,s]=u.useState(""),[l,m]=u.useState(!1),[f,g]=u.useState("single"),p=z=>{console.log("ScannerPage: Workflow selected:",z),s(z),r(z),m(!1)},y=()=>{console.log("🔧 handleBackToWorkflow called"),s(""),r(""),a(""),m(!1),console.log("🔧 Returning to workflow selection...")},{scannedTools:x,handleSendToBath1:b,handleScanTool:h,scanMessage:v,isBath1Active:N,clearScannedTools:R,replacementAlert:E,handleReplaceTool:D,handleContinueAnyway:$,handleDismissReplacementAlert:k}=jt({scannedData:t||"",onClose:()=>{console.log("🔧 Dirty workflow onClose called - navigating back to sterilization page"),window.history.back()},batchMode:f==="batch"});return{selectedWorkflow:n,showWorkflowResult:l,scanMode:f,isScanning:i,scanResult:o,scanMessage:c,scannedData:t,scannedTools:x,dirtyScanMessage:v,isBath1Active:N,replacementAlert:E,handleWorkflowSelect:p,handleBackToWorkflow:y,handleScan:()=>{n&&(n==="clean"?d(n,()=>{setTimeout(()=>{m(!0)},1e3)},!1):d(n,()=>{},!1))},handleCloseWorkflow:()=>{m(!1),y()},handleReceiptUploadSuccess:z=>{console.log("Receipt uploaded successfully:",z),window.history.back()},handleReceiptUploadCancel:()=>{y()},handleDeleteTool:z=>{console.log("Delete tool:",z)},handleCancelAll:()=>{R(),console.log("Cancel all tools")},handleSendScannedToBath1:()=>{console.log("🧪 scannedTools.length:",x.length),console.log("🧪 handleSendToBath1:",typeof b),b(x)},handleScanModeChange:z=>{g(z),R()},handleScanTool:h,handleReplaceTool:D,handleContinueAnyway:$,handleDismissReplacementAlert:k,clearScannedTools:R}},Je=[{id:"clean",name:"Clean Tool",icon:et,color:"green",description:"Ready to use on patients",statusRequirement:"Complete → Dirty"},{id:"dirty",name:"Dirty Tool",icon:tt,color:"orange",description:"Ready for cleaning process",statusRequirement:"Dirty → Clean"},{id:"problem",name:"Tool Problem",icon:de,color:"red",description:"Report tool issues or problems",statusRequirement:"Any status → Problem"},{id:"import",name:"Import Autoclave Receipt",icon:Oe,color:"blue",description:"Import physical autoclave cycle documentation",statusRequirement:"Documentation"},{id:"packaging",name:"Packaging Workflow",icon:Le,color:"purple",description:"Tools that are ready for packaging",statusRequirement:"Complete → Packaged"}],Nt=r=>Je.find(a=>a.id===r),kt=r=>({green:"border-green-200 hover:border-green-300 bg-green-50 hover:bg-green-100",orange:"border-orange-200 hover:border-orange-300 bg-orange-50 hover:bg-orange-100",blue:"border-blue-200 hover:border-blue-300 bg-blue-50 hover:bg-blue-100",purple:"border-purple-200 hover:border-purple-300 bg-purple-50 hover:bg-purple-100",red:"border-red-200 hover:border-red-300 bg-red-50 hover:bg-red-100"})[r],St=r=>({green:"bg-green-100",orange:"bg-orange-100",blue:"bg-blue-100",purple:"bg-purple-100",red:"bg-red-100"})[r],Ct=r=>({green:"text-green-600",orange:"text-orange-600",blue:"text-blue-600",purple:"text-purple-600",red:"text-red-600"})[r],_t=r=>({green:"text-green-800",orange:"text-orange-800",blue:"text-blue-800",purple:"text-purple-800",red:"text-red-800"})[r],Pt=r=>({green:"text-green-600",orange:"text-orange-600",blue:"text-blue-600",purple:"text-purple-600",red:"text-red-600"})[r],Tt=r=>({green:"text-green-700",orange:"text-orange-700",blue:"text-blue-700",purple:"text-purple-700",red:"text-red-700"})[r],Rt=({workflow:r,onClick:a})=>e.jsx("button",{onClick:()=>a(r.id),className:`w-full p-4 rounded-lg border-2 transition-all duration-200 text-left ${kt(r.color)}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${St(r.color)}`,children:e.jsx(T,{path:r.icon,size:1.2,className:Ct(r.color)})}),e.jsxs("div",{children:[e.jsx("h4",{className:`font-semibold text-sm ${_t(r.color)}`,children:r.name}),e.jsx("p",{className:`text-xs ${Pt(r.color)}`,children:r.description}),e.jsx("p",{className:`text-xs mt-1 font-medium ${Tt(r.color)}`,children:r.statusRequirement})]})]})}),Et=({onWorkflowSelect:r})=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800 mb-4",children:"Select Workflow"}),e.jsx("div",{className:"space-y-3",children:Je.map(a=>e.jsx(Rt,{workflow:a,onClick:r},a.id))})]}),Te=({workflowId:r,color:a="blue"})=>{const t=Nt(r);if(!t)return null;const i=()=>({blue:"bg-blue-50 border-blue-200 text-blue-800 text-blue-600",orange:"bg-orange-50 border-orange-200 text-orange-800 text-orange-600",purple:"bg-purple-50 border-purple-200 text-purple-800 text-purple-600"})[a],[o,c,d,n]=i().split(" ");return e.jsxs("div",{className:`${o} border ${c} rounded-lg p-3`,children:[e.jsxs("h3",{className:`font-semibold ${d} text-sm mb-1`,children:[t.name," Workflow"]}),e.jsx("p",{className:`${n} text-xs`,children:t.description}),e.jsxs("div",{className:"mt-2 text-xs text-blue-500",children:[e.jsx("strong",{children:"Tool Status:"})," ",t.statusRequirement]})]})},Re=({isScanning:r,scanMessage:a,onScan:t,size:i="large",showCameraStatus:o=!0})=>{const c=i==="large",d=c?"w-48 h-32":"w-32 h-24",n=c?"w-4 h-4":"w-3 h-3",s=c?"p-4":"p-3",l=c?1.5:1.2,m=c?"w-2 h-2":"w-1.5 h-1.5",f="text-xs",g=c?"bottom-4 right-4":"bottom-2 right-2",p=c?"h-48":"h-32",y=c?"text-lg":"text-base",x=c?"text-sm":"text-xs",b=()=>a?typeof a=="string"?a:a.text:null,h=()=>a?typeof a=="string"?"success":a.type:null;return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("div",{className:`relative bg-black rounded-lg ${p} flex items-center justify-center`,children:[e.jsxs("div",{className:`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-2 border-[#4ECDC4] ${d} rounded-lg`,children:[e.jsx("div",{className:`absolute top-0 left-0 ${n} border-t-2 border-l-2 border-[#4ECDC4] rounded-tl`}),e.jsx("div",{className:`absolute top-0 right-0 ${n} border-t-2 border-r-2 border-[#4ECDC4] rounded-tr`}),e.jsx("div",{className:`absolute bottom-0 left-0 ${n} border-b-2 border-l-2 border-[#4ECDC4] rounded-bl`}),e.jsx("div",{className:`absolute bottom-0 right-0 ${n} border-b-2 border-r-2 border-[#4ECDC4] rounded-br`})]}),o&&e.jsxs("div",{className:`absolute ${g} flex items-center`,children:[e.jsx("div",{className:`${m} rounded-full bg-red-500 mr-1 animate-pulse`}),e.jsx("span",{className:`text-white ${f}`,children:"Camera active"})]}),e.jsx("button",{onClick:t,disabled:r,className:`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 ${s} rounded-full transition-all duration-200 ${r?"bg-gray-600 cursor-not-allowed":"bg-[#4ECDC4] hover:bg-[#3db8b0] shadow-lg hover:shadow-xl"}`,children:e.jsx(T,{path:oe,size:l,className:`${r?"text-gray-400":"text-white"}`})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:`${y} font-medium text-gray-800 mb-1`,children:r?"Scanning...":"Click to Scan"}),e.jsx("p",{className:`text-gray-600 ${x}`,children:r?"Position barcode in camera view":"Use camera to scan tool barcode"})]})]}),a&&e.jsx(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`mt-3 p-3 rounded-lg ${h()==="success"?"bg-green-100 border border-green-200":"bg-red-100 border border-red-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{path:oe,size:.8,className:h()==="success"?"text-green-600":"text-red-600"}),e.jsx("span",{className:`font-medium text-sm ${h()==="success"?"text-green-800":"text-red-800"}`,children:b()})]})})]})};var $t=Object.defineProperty,zt=Object.defineProperties,Ut=Object.getOwnPropertyDescriptors,Ee=Object.getOwnPropertySymbols,Ft=Object.prototype.hasOwnProperty,Bt=Object.prototype.propertyIsEnumerable,$e=(r,a,t)=>a in r?$t(r,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[a]=t,ze=(r,a)=>{for(var t in a||(a={}))Ft.call(a,t)&&$e(r,t,a[t]);if(Ee)for(var t of Ee(a))Bt.call(a,t)&&$e(r,t,a[t]);return r},Dt=(r,a)=>zt(r,Ut(a)),K=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const se=()=>K(null,null,function*(){return yield ut.getCurrentFacilityId()});class J{static compressImage(a,t=1200,i=.8){return K(this,null,function*(){return new Promise((o,c)=>{const d=document.createElement("canvas"),n=d.getContext("2d"),s=new Image;s.onload=()=>{const l=Math.min(t/s.width,t/s.height),m=s.width*l,f=s.height*l;d.width=m,d.height=f,n==null||n.drawImage(s,0,0,m,f),d.toBlob(g=>{if(g){const p=new File([g],a.name,{type:"image/jpeg",lastModified:Date.now()});o(p)}else c(new Error("Failed to compress image"))},"image/jpeg",i)},s.onerror=()=>c(new Error("Failed to load image")),s.src=URL.createObjectURL(a)})})}static uploadReceipt(a,t,i){return K(this,null,function*(){try{const o=i||(yield se()),c=re(o),{data:{user:d},error:n}=yield c.auth.getUser();if(n||!d)throw new Error("User not authenticated. Please log in again.");const{data:s,error:l}=yield c.from("users").select("facility_id").eq("id",d.id).single();if(l||!(s!=null&&s.facility_id))throw new Error("User facility not found");if(s.facility_id!==o)throw new Error("Unauthorized: tenant mismatch");const m=yield this.compressImage(a.photoFile),f=new Date().toISOString().replace(/[:.]/g,"-"),g=`${d.id}/autoclave-receipt-${a.batchCode}-${f}.jpg`,{error:p}=yield c.storage.from("autoclave-receipts").upload(g,m,{cacheControl:"3600",upsert:!1});if(p)throw new Error(`Failed to upload file: ${p.message}`);const{data:y,error:x}=yield c.storage.from("autoclave-receipts").createSignedUrl(g,3600);if(x)throw x;console.info(`[AutoclaveReceipt] Signed URL created for tenant ${o} → ${g}`);const{data:b,error:h}=yield c.from("autoclave_receipts").insert({receipt_number:a.batchCode,autoclave_id:null,facility_id:s.facility_id,tenant_id:o,photo_url:y.signedUrl,created_at:new Date().toISOString()}).select().single();if(h)throw yield c.storage.from("autoclave-receipts").remove([g]),new Error(`Failed to save receipt metadata: ${h.message}`);return this.mapDatabaseReceipt(b)}catch(o){throw console.error("Error uploading autoclave receipt:",o),o}})}static getReceiptsByBatch(a,t){return K(this,null,function*(){try{const i=t||(yield se()),o=re(i),{data:{user:c},error:d}=yield o.auth.getUser();if(d||!c)throw new Error("User not authenticated. Please log in again.");const{data:n,error:s}=yield o.from("users").select("facility_id").eq("id",c.id).single();if(s||!(n!=null&&n.facility_id))throw new Error("User facility not found");if(n.facility_id!==i)throw new Error("Unauthorized: tenant mismatch");const m=o.from("autoclave_receipts").select("*").eq("receipt_number",a).eq("tenant_id",i),{data:f,error:g}=yield m.order("created_at",{ascending:!1});if(g)throw new Error(`Failed to fetch receipts: ${g.message}`);return f.map(this.mapDatabaseReceipt)}catch(i){throw console.error("Error fetching receipts:",i),i}})}static getAllReceipts(a=50,t=0,i){return K(this,null,function*(){try{const o=i||(yield se()),c=re(o),{data:{user:d},error:n}=yield c.auth.getUser();if(n||!d)throw new Error("User not authenticated. Please log in again.");const{data:s,error:l}=yield c.from("users").select("facility_id").eq("id",d.id).single();if(l||!(s!=null&&s.facility_id))throw new Error("User facility not found");if(s.facility_id!==o)throw new Error("Unauthorized: tenant mismatch");const f=c.from("autoclave_receipts").select("*").eq("tenant_id",o),{data:g,error:p}=yield f.order("created_at",{ascending:!1}).range(t,t+a-1);if(p)throw new Error(`Failed to fetch receipts: ${p.message}`);return g.map(this.mapDatabaseReceipt)}catch(o){throw console.error("Error fetching all receipts:",o),o}})}static deleteReceipt(a,t){return K(this,null,function*(){try{const i=t||(yield se()),o=re(i),{data:{user:c},error:d}=yield o.auth.getUser();if(d||!c)throw new Error("User not authenticated. Please log in again.");const{data:n,error:s}=yield o.from("users").select("facility_id").eq("id",c.id).single();if(s||!(n!=null&&n.facility_id))throw new Error("User facility not found");if(n.facility_id!==i)throw new Error("Unauthorized: tenant mismatch");const m=o.from("autoclave_receipts").select("id").eq("id",a).eq("tenant_id",i),{data:f,error:g}=yield m.single();if(g)throw new Error(`Failed to fetch receipt: ${g.message}`);const p=o.from("autoclave_receipts").delete().eq("id",a).eq("tenant_id",i),{error:y}=yield p;if(y)throw new Error(`Failed to delete receipt: ${y.message}`)}catch(i){throw console.error("Error deleting receipt:",i),i}})}static getFacilitySettings(){return K(this,null,function*(){return{id:"default",facilityId:void 0,autoclaveHasPrinter:!1,receiptRetentionMonths:24,createdAt:new Date,updatedAt:new Date}})}static updateFacilitySettings(a){return K(this,null,function*(){const t=yield this.getFacilitySettings();return Dt(ze(ze({},t),a),{updatedAt:new Date})})}static cleanupExpiredReceipts(a){return K(this,null,function*(){var t;try{const i=a||(yield se()),o=re(i),{data:{user:c},error:d}=yield o.auth.getUser();if(d||!c)throw new Error("User not authenticated. Please log in again.");const{data:n,error:s}=yield o.from("users").select("facility_id").eq("id",c.id).single();if(s||!(n!=null&&n.facility_id))throw new Error("User facility not found");if(n.facility_id!==i)throw new Error("Unauthorized: tenant mismatch");const m=new Date;m.setMonth(m.getMonth()-24);const{data:f,error:g}=yield o.from("autoclave_receipts").select("id, photo_url").lt("created_at",m.toISOString()).eq("tenant_id",i);if(g)throw new Error(`Failed to fetch expired receipts: ${g.message}`);if(!f||f.length===0)return 0;for(const p of f){const y=(t=p.photo_url)==null?void 0:t.split("/").pop();y&&(yield o.storage.from("autoclave-receipts").remove([y])),yield o.from("autoclave_receipts").delete().eq("id",p.id)}return f.length}catch(i){throw console.error("Error cleaning up expired receipts:",i),i}})}static mapDatabaseReceipt(a){return{id:a.id,batchId:"",batchCode:a.receipt_number,cycleNumber:void 0,photoUrl:"",photoFilename:"",photoSize:0,temperatureEvidence:void 0,uploadedBy:"",uploadedAt:new Date(a.created_at),retentionUntil:new Date,isExpired:!1,createdAt:new Date(a.created_at),updatedAt:new Date(a.created_at)}}static mapDatabaseFacilitySettings(a){return{id:a.id,facilityId:a.facility_id,autoclaveHasPrinter:a.autoclave_has_printer,receiptRetentionMonths:a.receipt_retention_months,createdAt:new Date(a.created_at),updatedAt:new Date(a.updated_at)}}}var Q=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const At=()=>{const[r,a]=u.useState([]),[t,i]=u.useState(null),[o,c]=u.useState(!1),[d,n]=u.useState(null),s=u.useCallback((b,h)=>Q(null,null,function*(){c(!0),n(null);try{const v=yield J.uploadReceipt(b,h);return a(N=>[v,...N]),v}catch(v){const N=v instanceof Error?v.message:"Failed to upload receipt";throw n(N),v}finally{c(!1)}}),[]),l=u.useCallback(b=>Q(null,null,function*(){c(!0),n(null);try{const h=yield J.getReceiptsByBatch(b);return a(h),h}catch(h){const v=h instanceof Error?h.message:"Failed to load receipts";throw n(v),h}finally{c(!1)}}),[]),m=u.useCallback((b=50,h=0)=>Q(null,null,function*(){c(!0),n(null);try{const v=yield J.getAllReceipts(b,h);return a(v),v}catch(v){const N=v instanceof Error?v.message:"Failed to load receipts";throw n(N),v}finally{c(!1)}}),[]),f=u.useCallback(b=>Q(null,null,function*(){c(!0),n(null);try{yield J.deleteReceipt(b),a(h=>h.filter(v=>v.id!==b))}catch(h){const v=h instanceof Error?h.message:"Failed to delete receipt";throw n(v),h}finally{c(!1)}}),[]),g=u.useCallback(()=>Q(null,null,function*(){c(!0),n(null);try{const b=yield J.getFacilitySettings();return i(b),b}catch(b){const h=b instanceof Error?b.message:"Failed to load facility settings";throw n(h),b}finally{c(!1)}}),[]),p=u.useCallback(b=>Q(null,null,function*(){c(!0),n(null);try{const h=yield J.updateFacilitySettings(b);return i(h),h}catch(h){const v=h instanceof Error?h.message:"Failed to update facility settings";throw n(v),h}finally{c(!1)}}),[]),y=u.useCallback(()=>{n(null)},[]),x=u.useCallback(()=>{a([])},[]);return{receipts:r,facilitySettings:t,loading:o,error:d,uploadReceipt:s,loadReceiptsByBatch:l,loadAllReceipts:m,deleteReceipt:f,loadFacilitySettings:g,updateFacilitySettings:p,clearError:y,clearReceipts:x}};var It=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const Mt=()=>{const r=navigator.userAgent.toLowerCase(),t=["android","iphone","ipad","ipod","blackberry","windows phone","mobile","tablet"].some(d=>r.includes(d)),i="ontouchstart"in window||navigator.maxTouchPoints>0,o=window.innerWidth<=768,c="orientation"in window||"deviceorientation"in window;return t||i&&o||c},Wt=()=>It(null,null,function*(){try{return!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia?!1:(yield navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="videoinput").length>0}catch(r){return console.warn("Error checking camera access:",r),!1}});var Ot=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const Lt=({isMobile:r,hasCamera:a,onPhotoCapture:t,onCancel:i})=>{const[o,c]=u.useState(!1),d=u.useRef(null),n=u.useRef(null),s=u.useRef(null),l=u.useCallback(()=>Ot(null,null,function*(){if(!r){alert("Camera access is only available on mobile devices. Please use the file upload option instead.");return}if(!a){alert("No camera detected on this device. Please use file upload instead.");return}try{const g=yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});d.current&&(d.current.srcObject=g,s.current=g,c(!0))}catch(g){console.error(g),alert("Unable to access camera. Please use file upload instead.")}}),[r,a]),m=u.useCallback(()=>{s.current&&(s.current.getTracks().forEach(g=>g.stop()),s.current=null),c(!1)},[]),f=u.useCallback(()=>{if(d.current&&n.current){const g=d.current,p=n.current,y=p.getContext("2d");y&&(p.width=g.videoWidth,p.height=g.videoHeight,y.drawImage(g,0,0),p.toBlob(x=>{if(x){const b=new File([x],`receipt-${Date.now()}.jpg`,{type:"image/jpeg"}),h=URL.createObjectURL(x);t(b,h),m()}},"image/jpeg",.8))}},[t,m]);return!r||!a?null:e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",onClick:l,className:"w-full flex items-center justify-center space-x-2 px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:[e.jsx(T,{path:at,size:1.2}),e.jsx("span",{children:"Take Photo"})]}),o&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-4 max-w-sm w-full mx-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("video",{ref:d,autoPlay:!0,playsInline:!0,className:"w-full h-64 object-cover rounded-md",children:e.jsx("track",{kind:"captions"})}),e.jsx("canvas",{ref:n,className:"hidden"})]}),e.jsxs("div",{className:"flex space-x-2 mt-4",children:[e.jsxs("button",{type:"button",onClick:f,className:"flex-1 flex items-center justify-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors",children:[e.jsx(T,{path:qe,size:1}),e.jsx("span",{children:"Capture"})]}),e.jsxs("button",{type:"button",onClick:m,className:"flex-1 flex items-center justify-center space-x-2 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors",children:[e.jsx(T,{path:ue,size:1}),e.jsx("span",{children:"Cancel"})]})]})]})})]})};var Ue=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const qt=({photoFile:r,photoPreview:a,isMobile:t,onFileSelect:i,onClearPhoto:o})=>{const c=u.useRef(null),d=l=>Ue(null,null,function*(){if(l.type==="image/jpeg")return l;const m=yield createImageBitmap(l),f=document.createElement("canvas");f.width=m.width,f.height=m.height;const g=f.getContext("2d");if(!g)return l;g.drawImage(m,0,0);const p=yield new Promise(y=>f.toBlob(x=>y(x),"image/jpeg",.8));return p?new File([p],l.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}):l}),n=u.useCallback(l=>Ue(null,null,function*(){var m;const f=(m=l.target.files)==null?void 0:m[0];if(f&&f.type.startsWith("image/")){let g=f;g=yield d(g);const p=new FileReader;p.onload=y=>{var x;const b=(x=y.target)==null?void 0:x.result;i(g,b)},p.readAsDataURL(g)}}),[i]),s=u.useCallback(()=>{var l;(l=c.current)==null||l.click()},[]);return e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{htmlFor:"photo-upload",className:"block text-sm font-medium text-gray-700",children:"Receipt Photo *"}),a?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:a,alt:"Receipt preview",className:"w-full h-48 object-cover rounded-md border border-gray-300"}),e.jsx("button",{type:"button",onClick:o,className:"absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors",children:e.jsx(T,{path:ue,size:.8})})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Photo captured: ",(r==null?void 0:r.name)||"Receipt photo"]}),e.jsx("p",{className:"text-xs text-blue-600",children:"Note: Photos are uploaded directly to Cliniio and not stored on your device"})]}):e.jsxs("div",{className:"space-y-2",children:[!t&&e.jsx("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-md mb-2",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{path:rt,size:1,className:"text-yellow-600"}),e.jsx("p",{className:"text-sm text-yellow-800",children:"Camera access is only available on mobile devices. Please use the file upload option below."})]})}),e.jsxs("button",{type:"button",onClick:s,className:"w-full flex items-center justify-center space-x-2 px-4 py-3 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors",children:[e.jsx(T,{path:He,size:1.2}),e.jsx("span",{children:"Choose File"})]}),e.jsx("input",{ref:c,id:"photo-upload",type:"file",accept:"image/*",onChange:n,className:"hidden"}),e.jsx("p",{className:"text-xs text-blue-600 text-center",children:"Photos are uploaded directly to Cliniio and not stored on your device"})]})]})},Ht=({cycleNumber:r,temperatureEvidence:a,onCycleNumberChange:t,onTemperatureEvidenceChange:i})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"cycleNumber",className:"block text-sm font-medium text-gray-700",children:"Cycle Number (Optional)"}),e.jsx("input",{type:"text",id:"cycleNumber",value:r,onChange:o=>t(o.target.value),className:"mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"e.g., CYC-2024-001"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"temperatureEvidence",className:"block text-sm font-medium text-gray-700",children:"Temperature Evidence (Optional)"}),e.jsx("textarea",{id:"temperatureEvidence",value:a,onChange:o=>i(o.target.value),rows:3,className:"mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"e.g., Temperature reached 121°C for 4 minutes"})]})]});var Fe=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const Qe=({batchCode:r,operator:a,onSuccess:t,onCancel:i})=>{const{uploadReceipt:o,loading:c,error:d}=At(),[n,s]=u.useState(null),[l,m]=u.useState(null),[f,g]=u.useState(""),[p,y]=u.useState(""),[x,b]=u.useState(!1),[h,v]=u.useState(!1),[N,R]=u.useState(null);u.useEffect(()=>{Fe(null,null,function*(){const S=Mt(),B=yield Wt();b(S),v(B)})},[]),u.useEffect(()=>()=>{l&&l.startsWith("blob:")&&URL.revokeObjectURL(l)},[l]);const E=u.useCallback((A,S)=>{s(A),m(S)},[]),D=u.useCallback((A,S)=>{s(A),m(S)},[]),$=u.useCallback(()=>{l&&l.startsWith("blob:")&&URL.revokeObjectURL(l),s(null),m(null)},[l]),k=u.useCallback(A=>Fe(null,null,function*(){if(A.preventDefault(),!n){alert("Please select or capture a photo of the receipt");return}try{const S={batchCode:r,cycleNumber:f||void 0,photoFile:n,temperatureEvidence:p||void 0};R("Compressing image for optimal storage...");const B=yield o(S,a);l&&l.startsWith("blob:")&&URL.revokeObjectURL(l);const H=B.photoSize<n.size?` (compressed from ${(n.size/1024).toFixed(1)}KB to ${(B.photoSize/1024).toFixed(1)}KB)`:"";R(`Receipt uploaded successfully!${H}`),t==null||t(B)}catch(S){console.error("Error uploading receipt:",S);const B=S instanceof Error?S.message:"Error uploading receipt";R(`Upload failed: ${B}`)}}),[n,r,f,p,o,a,t,l]);return e.jsxs("div",{className:"p-6 bg-white rounded-lg shadow-lg max-w-md mx-auto",children:[e.jsx("div",{className:"mb-4",children:e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Upload Autoclave Receipt"})}),e.jsxs("form",{onSubmit:k,className:"space-y-4",children:[e.jsx("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-md",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"Batch Code:"})," ",r]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Lt,{isMobile:x,hasCamera:h,onPhotoCapture:E}),x&&h&&e.jsx("div",{className:"text-center text-gray-500 text-sm",children:"or"}),e.jsx(qt,{photoFile:n,photoPreview:l,isMobile:x,onFileSelect:D,onClearPhoto:$})]}),e.jsx(Ht,{cycleNumber:f,temperatureEvidence:p,onCycleNumberChange:g,onTemperatureEvidenceChange:y}),d&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-md",children:e.jsx("p",{className:"text-sm text-red-800",children:d})}),N&&e.jsx("div",{className:`p-3 rounded-md ${N.includes("successfully")?"bg-green-50 border border-green-200":N.includes("failed")?"bg-red-50 border border-red-200":"bg-blue-50 border border-blue-200"}`,children:e.jsx("p",{className:`text-sm ${N.includes("successfully")?"text-green-800":N.includes("failed")?"text-red-800":"text-blue-800"}`,children:N})}),e.jsx("button",{type:"submit",disabled:!n||c,className:"w-full flex items-center justify-center space-x-2 px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Uploading..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(T,{path:He,size:1.2}),e.jsx("span",{children:"Upload Receipt"})]})})]}),e.jsx("div",{className:"flex justify-center pt-2",children:e.jsx("button",{onClick:i,className:"px-3 py-1 text-gray-600 hover:text-gray-800 transition-colors text-sm",children:"← Back to Workflow Selection"})})]})},Kt=[{type:"damaged",label:"Damaged",description:"Physical damage or broken parts"},{type:"improperly_cleaned",label:"Improperly Cleaned",description:"Rust, residue, or staining"},{type:"worn_out",label:"Worn Out",description:"Excessive wear or dull edges"},{type:"other",label:"Other",description:"Other issues not listed above"}],Vt=({selectedProblemType:r,onProblemTypeSelect:a})=>e.jsx("div",{className:"space-y-3",children:Kt.map(t=>e.jsx("button",{onClick:()=>a(t.type),className:`w-full p-4 rounded-lg border-2 transition-all duration-200 text-left ${r===t.type?"border-red-300 bg-red-50":"border-gray-200 hover:border-red-200 bg-white hover:bg-red-50"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-800",children:t.label}),e.jsx("p",{className:"text-sm text-gray-600",children:t.description})]}),r===t.type&&e.jsx(T,{path:qe,size:1,className:"text-red-600"})]})},t.type))}),Gt=()=>{const[r,a]=u.useState(!1),t=u.useRef(null);return u.useEffect(()=>{if("webkitSpeechRecognition"in window||"SpeechRecognition"in window){const c=window.SpeechRecognition||window.webkitSpeechRecognition;t.current=new c,t.current.continuous=!1,t.current.interimResults=!1,t.current.lang="en-US",t.current.onresult=d=>{const n=d.results[0][0].transcript;return a(!1),n},t.current.onerror=d=>{console.error("Speech recognition error:",d.error),a(!1)},t.current.onend=()=>{a(!1)}}},[]),{isRecording:r,startRecording:c=>{t.current&&(a(!0),t.current.onresult=d=>{const n=d.results[0][0].transcript;c(n),a(!1)},t.current.start())},stopRecording:()=>{t.current&&t.current.stop()}}},Yt=({value:r,onChange:a})=>{const{isRecording:t,startRecording:i,stopRecording:o}=Gt(),c=()=>{t?o():i(d=>{a(d)})};return e.jsxs(q.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"space-y-3",children:[e.jsx("label",{htmlFor:"problem-description",className:"block text-sm font-medium text-gray-700",children:"Describe the problem"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("textarea",{id:"problem-description",value:r,onChange:d=>a(d.target.value),placeholder:"Describe the issue...",className:"flex-1 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 resize-none",rows:3}),e.jsx("button",{onClick:c,className:`p-3 rounded-md transition-colors ${t?"bg-red-500 text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,title:t?"Stop recording":"Voice input",children:e.jsx(T,{path:t?st:ot,size:1})})]}),t&&e.jsx("p",{className:"text-sm text-red-600",children:"Recording... Speak now"})]})};var Jt=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const Qt=({onClose:r})=>{const[a,t]=u.useState(!1),[i,o]=u.useState(""),[c,d]=u.useState(null),[n,s]=u.useState(""),[l,m]=u.useState(!1),[f,g]=u.useState(null),[p,y]=u.useState(""),[x,b]=u.useState(!1),{availableTools:h,markToolAsProblem:v}=W(),N=()=>{t(!0),s("Scanning tool..."),setTimeout(()=>{const E=h.filter(k=>k.barcode).map(k=>k.barcode);if(E.length===0){d("error"),s("No tools available for scanning"),t(!1);return}const D=E[Math.floor(Math.random()*E.length)],$=h.find(k=>k.barcode===D);$?(o(D),d("success"),s(`Successfully scanned ${$.name}`),m(!0)):(d("error"),s("Tool not found in system")),t(!1)},1e3)},R=()=>Jt(null,null,function*(){if(!(!f||!i)){b(!0);try{const{data:{user:E},error:D}=yield M.auth.getUser();if(D||!E){s("Authentication error. Please log in again.");return}const $=yield Ge.scanToolForProblemWorkflow(i,f,p||"No additional notes provided",E.id);if($.success){s($.message);const k=h.find(A=>A.barcode===i);k&&console.log(`Tool ${k.id} marked as problem: ${f}`),setTimeout(()=>{r()},2e3)}else s($.message)}catch(E){console.error("Error reporting tool problem:",E),s("Error reporting tool problem. Please try again.")}finally{b(!1)}}});return e.jsxs("div",{className:"space-y-6",children:[l?e.jsxs(q.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},className:"space-y-4",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800 mb-2",children:"Report Tool Problem"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Tool: ",i]})]}),e.jsx(Vt,{selectedProblemType:f,onProblemTypeSelect:g}),f==="other"&&e.jsx(Yt,{value:p,onChange:y}),e.jsxs("div",{className:"flex space-x-3 pt-4",children:[e.jsx("button",{onClick:()=>m(!1),className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors",children:"Back"}),e.jsx("button",{onClick:R,disabled:!f||x,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:x?"Processing...":"Report Problem"})]}),e.jsx("div",{className:"flex justify-center pt-2",children:e.jsx("button",{onClick:r,className:"px-3 py-1 text-gray-600 hover:text-gray-800 transition-colors text-sm",children:"← Back to Workflow Selection"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-red-800 mb-1",children:"Tool Problem Workflow"}),e.jsx("p",{className:"text-red-600 text-sm",children:"Report tool issues or problems"}),e.jsxs("div",{className:"mt-2 text-xs text-red-500",children:[e.jsx("strong",{children:"Tool Status:"})," Any status → Problem"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs("div",{className:"relative bg-black rounded-lg h-48 flex items-center justify-center",children:[e.jsxs("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-2 border-[#4ECDC4] w-48 h-32 rounded-lg",children:[e.jsx("div",{className:"absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-[#4ECDC4] rounded-tl"}),e.jsx("div",{className:"absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-[#4ECDC4] rounded-tr"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-[#4ECDC4] rounded-bl"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-[#4ECDC4] rounded-br"})]}),e.jsxs("div",{className:"absolute bottom-4 right-4 flex items-center",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500 mr-2 animate-pulse"}),e.jsx("span",{className:"text-white text-xs",children:"Camera active"})]}),e.jsx("button",{onClick:N,disabled:a,className:`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-4 rounded-full transition-all duration-200 ${a?"bg-gray-600 cursor-not-allowed":"bg-[#4ECDC4] hover:bg-[#3db8b0] shadow-lg hover:shadow-xl"}`,children:e.jsx(T,{path:oe,size:1.5,className:`${a?"text-gray-400":"text-white"}`})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800 mb-2",children:a?"Scanning...":"Click to Scan"}),e.jsx("p",{className:"text-gray-600 text-sm",children:a?"Position barcode in camera view":"Use camera to scan tool barcode"})]})]}),c&&e.jsx(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`mt-4 p-4 rounded-lg ${c==="success"?"bg-green-100 border border-green-200":"bg-red-100 border border-red-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{path:oe,size:1,className:c==="success"?"text-green-600":"text-red-600"}),e.jsx("span",{className:`font-medium ${c==="success"?"text-green-800":"text-red-800"}`,children:n})]})})]})]}),!l&&e.jsx("div",{className:"flex justify-center pt-2",children:e.jsx("button",{onClick:r,className:"px-3 py-1 text-gray-600 hover:text-gray-800 transition-colors text-sm",children:"← Back to Workflow Selection"})})]})},Zt=()=>{const r=new Date,a=Math.floor((r.getTime()-new Date(r.getFullYear(),0,0).getTime())/(1e3*60*60*24)),t=a%26,i=a%9+1;return`${String.fromCharCode(65+t)}${i}`},Xt=()=>Zt();var ea=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const ta=({scannedData:r,toolId:a})=>{const{availableTools:t}=W(),[i]=u.useState(Xt()),[o,c]=u.useState(!1),d=u.useCallback(l=>t.find(m=>m.barcode===l),[t]),n=u.useCallback(()=>a?t.find(l=>l.id===a):d(r),[a,t,d,r]);u.useEffect(()=>{const l=n();l&&l.currentPhase==="complete"&&r&&console.log(`Tool ${l.id} marked as dirty`)},[r,n,i]);const s=()=>ea(null,null,function*(){try{yield navigator.clipboard.writeText(i),c(!0),setTimeout(()=>c(!1),2e3)}catch(l){console.error("Failed to copy code:",l)}});return{tool:n(),traceabilityCode:i,copied:o,handleCopyCode:s}},aa=({traceabilityCode:r,copied:a,onCopyCode:t})=>e.jsx(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},className:"bg-blue-50 border-2 border-blue-300 rounded-lg p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-3",children:[e.jsx(T,{path:Se,size:1.2,className:"text-blue-600"}),e.jsx("h4",{className:"text-lg font-semibold text-blue-800",children:"Traceability Code"})]}),e.jsx("p",{className:"text-blue-700 mb-4 text-sm",children:"Enter this code in your patient chart for compliance tracking"}),e.jsx("div",{className:"bg-white border-2 border-blue-400 rounded-lg p-4 mb-4",children:e.jsx("div",{className:"text-4xl font-bold text-blue-800 tracking-wider font-mono",children:r})}),e.jsxs("button",{onClick:t,className:`flex items-center gap-2 mx-auto px-4 py-2 rounded-lg transition-all duration-200 ${a?"bg-green-500 text-white":"bg-blue-600 hover:bg-blue-700 text-white"}`,children:[e.jsx(T,{path:a?Ke:nt,size:1}),e.jsx("span",{children:a?"Copied!":"Copy Code"})]}),e.jsxs("button",{onClick:()=>{const i=`EMR-${Date.now()}-${Math.random().toString(36).substr(2,6).toUpperCase()}`;navigator.clipboard.writeText(i),alert(`EMR ID generated and copied: ${i}`)},className:"flex items-center gap-2 mx-auto mt-3 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all duration-200",children:[e.jsx(T,{path:Se,size:1}),e.jsx("span",{children:"Generate EMR ID"})]})]})});function ra({scannedData:r,onClose:a,toolId:t}){const{tool:i,traceabilityCode:o,copied:c,handleCopyCode:d}=ta({scannedData:r,toolId:t});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(q.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(T,{path:Ke,size:1.2,className:"text-green-600"}),e.jsx("h3",{className:"text-lg font-semibold text-green-800",children:"Tool Ready for Use"})]}),e.jsx("p",{className:"text-green-700 mb-2",children:i?`${i.name} is clean and ready for patient use.`:"Tool is clean and ready for patient use."}),e.jsxs("p",{className:"text-sm text-green-600",children:["Scanned: ",r]})]}),e.jsx(aa,{traceabilityCode:o,copied:c,onCopyCode:d}),e.jsxs(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.4},className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-md font-semibold text-orange-800 mb-2",children:"Status Update"}),e.jsxs("p",{className:"text-orange-700 mb-2",children:[e.jsx("strong",{children:'Tool has been marked as "dirty"'})," and will need sterilization after use."]}),e.jsx("p",{className:"text-sm text-orange-600",children:"This change is automatically reflected in the inventory system."})]}),e.jsx(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.6},className:"flex gap-2",children:e.jsx("button",{onClick:a,className:"flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition-colors font-medium",children:"Confirm & Close"})})]})}var ce=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const _=r=>typeof r=="string"?r:"",ie=r=>typeof r=="number"?r:0,Be=r=>typeof r=="boolean"?r:!1,Z=r=>{if(typeof r=="string"){const a=new Date(r);return isNaN(a.getTime())?void 0:a}},De=r=>{switch(r){case"active":return"available";case"dirty":return"maintenance";case"clean":return"available";case"problem":return"problem";case"new_barcode":return"available";default:return"available"}};function sa(r){const a=Date.now().toString(36).toUpperCase(),t=Math.random().toString(36).substr(2,4).toUpperCase();return`PKG-${r.slice(0,4).toUpperCase()}-${a}-${t}`}class Ae{static getToolsReadyForPackaging(){return ce(this,null,function*(){let t=null;for(let i=1;i<=3;i++)try{if(!Pe.getState().authToken){if(i<3){yield new Promise(g=>setTimeout(g,i*500));continue}throw new Error("User not authenticated")}const{data:{user:c},error:d}=yield M.auth.getUser();if(d||!c)throw new Error("User not authenticated");const{data:n,error:s}=yield M.from("users").select("facility_id").eq("id",c.id).single();if(s||!n)throw new Error("User facility not found");const{data:l,error:m}=yield M.from("tools").select("*").eq("facility_id",n.facility_id).eq("status","active");if(m)throw new Error(`Failed to fetch tools: ${m.message}`);return(l||[]).map(g=>{const p=g;return{id:_(p.tool_id),name:_(p.tool_name),barcode:_(p.barcode),type:_(p.tool_type),category:_(p.category)||"general",currentPhase:_(p.current_phase),status:De(_(p.current_phase)),lastSterilized:_(p.last_sterilized)||void 0,cycleCount:ie(p.cycle_count),maxCycles:ie(p.max_cycles)||void 0,location:_(p.location)||void 0,notes:_(p.notes)||void 0}})}catch(o){if(t=o instanceof Error?o:new Error("Unknown error"),i===3)throw console.error(`Error fetching tools ready for packaging (attempt ${i}/3):`,o),t;yield new Promise(c=>setTimeout(c,i*500))}throw t||new Error("Failed to fetch tools after all retries")})}static createPackage(a,t,i){return ce(this,null,function*(){try{if(!Pe.getState().authToken)throw new Error("User not authenticated");const{FacilityService:c}=yield pt(()=>import("./main-FsBT3Y_8.js").then(R=>R.Z),__vite__mapDeps([0,1,2,3,4,5,6,7])),d=yield c.getCurrentFacilityId(),{data:{user:n},error:s}=yield M.auth.getUser();if(s||!n)throw new Error("User not authenticated");const l=n.id,m=sa(d),{data:f,error:g}=yield M.from("sterilization_batches").insert({id:crypto.randomUUID(),cycle_id:crypto.randomUUID(),facility_id:d,batch_name:`Package ${m}`,batch_type:"routine",status:"packaged",package_id:m,package_type:t.packageType,package_size:t.packageSize,chemical_indicator_added:!0,packaged_by:l,packaged_at:new Date().toISOString(),requested_by:l,total_items:a.length,notes:t.notes}).select().single();if(g)throw new Error(`Failed to create package: ${g.message}`);const p=f,y=a.map(R=>({batch_id:p.id,tool_id:R,item_name:"Tool",item_type:"sterilization_tool",quantity:1,package_type:t.packageType,package_configuration:{package_size:t.packageSize,notes:t.notes}})),x=a.map(R=>_e.updateToolStatus(R,"active"));yield Promise.all(x),yield _e.touchTools(a);const h=yield new gt().getCurrentUser(),v=h?{id:h.facility_id}:null;yield M.from("audit_logs").insert({created_by:(h==null?void 0:h.id)||"unknown",facility_id:(v==null?void 0:v.id)||"unknown",module:"sterilization",action:"package_created",table_name:"sterilization_batches",record_id:p.id,old_values:{},new_values:{package_id:m,package_type:t.packageType,total_items:a.length,status:"packaged"},metadata:{package_id:m,tool_count:a.length,operator_name:i,package_info:t}});const N={id:_(p.id),packageId:_(p.package_id),batchName:_(p.batch_name),batchType:_(p.batch_type),status:_(p.status),packageType:_(p.package_type),packageSize:_(p.package_size),chemicalIndicatorAdded:Be(p.chemical_indicator_added),packagedBy:_(p.packaged_by),packagedAt:Z(p.packaged_at)||new Date,totalItems:ie(p.total_items),createdAt:Z(p.created_at)||new Date,updatedAt:Z(p.updated_at)||new Date};return{success:!0,message:`Package ${m} created successfully with ${a.length} tools`,batch:N,packageId:_(m)}}catch(o){return console.error("Error creating package:",o),{success:!1,message:o instanceof Error?o.message:"Failed to create package"}}})}static getPackageById(a){return ce(this,null,function*(){try{const{data:t,error:i}=yield M.from("sterilization_batches").select("*").eq("package_id",a).single();if(i||!t)return null;const o=t;return{id:_(o.id),packageId:_(o.package_id),batchName:_(o.batch_name),batchType:_(o.batch_type),status:_(o.status),packageType:_(o.package_type),packageSize:_(o.package_size),chemicalIndicatorAdded:Be(o.chemical_indicator_added),packagedBy:_(o.packaged_by),packagedAt:Z(o.packaged_at)||new Date,totalItems:ie(o.total_items),createdAt:Z(o.created_at)||new Date,updatedAt:Z(o.updated_at)||new Date}}catch(t){return console.error("Error fetching package:",t),null}})}static getToolsInPackage(a){return ce(this,null,function*(){try{const{data:t,error:i}=yield M.from("sterilization_batches").select("id").eq("package_id",a).single();if(i||!t)throw new Error("Package not found");const o=t,{data:c,error:d}=yield M.from("sterilization_cycle_tools").select(`
          tool_id,
          tools (
            id,
            tool_name,
            barcode,
            tool_type,
            status,
            last_sterilized,
            sterilization_count,
            location,
            manufacturer,
            model,
            serial_number,
            maintenance_due_date,
            notes,
            metadata
          )
        `).eq("cycle_id",o.id);if(d)throw new Error(`Failed to fetch package tools: ${d.message}`);return(c||[]).map(n=>{const l=n.tools;if(!l)throw new Error("Tool data not found");return{id:l.id,name:l.tool_name,barcode:l.barcode,type:l.tool_type,category:l.category||"general",currentPhase:l.status,status:De(l.status),location:l.location,notes:l.notes||void 0,cycleCount:l.cycle_count||0,lastSterilized:l.last_sterilized}})}catch(t){throw console.error("Error fetching package tools:",t),t}})}}var X=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const oa=(r,a)=>{const{currentSession:t,startPackagingSession:i,addToolToSession:o,removeToolFromSession:c,generateBatchId:d,assignBatchIdToSession:n,endPackagingSession:s}=W(),{currentUser:l}=Ye(),[m,f]=u.useState(""),[g,p]=u.useState(""),[y,x]=u.useState(""),[b,h]=u.useState(null),[v,N]=u.useState({packageType:"",packageSize:"",notes:""}),[R,E]=u.useState(!1),[D,$]=u.useState(!1),[k,A]=u.useState([]),[S,B]=u.useState([]),[H,C]=u.useState(!1),[j,P]=u.useState(""),[L,z]=u.useState(null),I=W(w=>w.currentBatch)||null,me=W(w=>w.batchLoading)||!1,ee=u.useCallback(()=>X(null,null,function*(){try{const w=yield Ae.getToolsReadyForPackaging();A(w)}catch(w){console.error("Error loading tools ready for packaging:",w),x("Error loading tools ready for packaging")}}),[]),te=u.useCallback(w=>X(null,null,function*(){p(w),h(null),x("Processing scan...");const F=k.find(U=>U.barcode===w);if(!F){h("error"),x("Tool not found or not ready for packaging");return}if(S.find(U=>U.id===F.id)){h("error"),x("Tool already added to package");return}if(B(U=>[...U,F]),o(w),a&&I){const U=W.getState().addToolToBatch;U(F.id)}h("success"),x(`Successfully added ${F.name} to package`),setTimeout(()=>{p(""),x(""),h(null)},2e3)}),[k,S,o,a,I]),ne=u.useCallback(()=>{if(k.length===0){h("error"),x("No tools available for packaging");return}const w=k[Math.floor(Math.random()*k.length)];te(w.barcode)},[k,te]),he=u.useCallback(w=>X(null,null,function*(){if(!t){x("Please start a packaging session first");return}try{x("Creating new autoclave load...");const F=w?`${w}${Math.floor(1e3+Math.random()*9e3)}`:d();n(F);const U=W.getState().createBatch;yield U(m,!0),x("New autoclave load created successfully!"),setTimeout(()=>{x("")},2e3)}catch(F){x("Error creating new autoclave load"),console.error("Error creating new autoclave load:",F)}}),[t,m,d,n]),pe=u.useCallback(()=>{if(!(I!=null&&I.batchCode)){x("Please create a batch first before uploading receipts");return}$(!0)},[I==null?void 0:I.batchCode]),we=u.useCallback(()=>{$(!1),x("Receipt uploaded successfully!"),setTimeout(()=>{x("")},2e3)},[]),ge=u.useCallback(()=>{$(!1)},[]),le=u.useCallback(()=>X(null,null,function*(){try{x("Creating package...");const w=yield Ae.createPackage(S.map(F=>F.id),v,m);w.success?(x(w.message),B([]),E(!1),yield ee(),setTimeout(()=>{r()},3e3)):x(w.message)}catch(w){console.error("Error finalizing package:",w),x("Error creating package. Please try again.")}}),[S,v,m,ee,r]),xe=u.useCallback(()=>X(null,null,function*(){if(!j){alert("Please scan a location barcode first.");return}const w={batchId:(t==null?void 0:t.currentBatchId)||"",toolsCount:S.length,assignedLocation:j,technicianId:l==null?void 0:l.id},F=yield mt(w);if(z(F.status),F.status==="invalid_location"){alert(`⚠️ Location "${j}" is not valid for this facility. Please check the location name.`);return}try{t!=null&&t.currentBatchId&&(yield M.from("sterilization_batches").update({location_barcode:j}).eq("id",t.currentBatchId)),yield M.from("inventory_items").update({scanned_location:j}).in("id",S.map(U=>U.id)),alert(`✅ Location ${j} assigned successfully`),C(!1),P(""),yield le()}catch(U){console.error("Error assigning location:",U),alert("Error assigning location. Please try again.")}}),[j,S,t,l,le]),Ne=u.useCallback(()=>X(null,null,function*(){if(S.length===0){x("No tools selected for packaging");return}if(!v.packageType){x("Please select a package type");return}C(!0)}),[S,v]),fe=u.useCallback(()=>{s(),B([]),x(""),h(null),r()},[s,r]),ke=u.useCallback(w=>{const F=S.find(U=>U.id===w);if(F&&(B(U=>U.filter(O=>O.id!==w)),c(F.barcode),a&&I)){const U=W.getState().removeToolFromBatch;U(w)}},[S,c,a,I]),be=u.useCallback(()=>{if(!m.trim()){x("Please enter operator name");return}i(m,"default-facility")},[m,i]);return{operatorName:m,scannedBarcode:g,scanMessage:y,scanResult:b,packageInfo:v,showPackageForm:R,showReceiptUpload:D,scannedTools:S,batchLoading:me,currentSession:t,availableTools:k,isAssigning:H,locationCode:j,locationStatus:L,setOperatorName:f,setScannedBarcode:p,setPackageInfo:N,setShowPackageForm:E,setLocationCode:P,setIsAssigning:C,handleScan:te,simulateScan:ne,handleNewAutoclaveLoad:he,handleImportReceipt:pe,handleReceiptUploadSuccess:we,handleReceiptUploadCancel:ge,handleFinalizePackage:Ne,handleAssignLocation:xe,handleEndSession:fe,handleRemoveTool:ke,handleStartSession:be,loadToolsReadyForPackaging:ee}},na=({operatorName:r,isBatchMode:a,onEndSession:t})=>e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800",children:"Packaging Workflow"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a?"Batch Mode":"Single Tool Mode"," - Operator:"," ",r]})]}),e.jsxs("button",{onClick:t,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:[e.jsx(Y,{path:ue,size:1.5}),e.jsx("span",{className:"sr-only",children:"Close"})]})]}),la=({scannedBarcode:r,scanMessage:a,scanResult:t,onScan:i,onBarcodeChange:o,onSimulateScan:c,onNewAutoclaveLoad:d,onImportReceipt:n,currentBatchCode:s,availableTools:l})=>{const m=f=>{f.key==="Enter"&&i(r)};return e.jsxs("div",{className:"mb-6 p-4 bg-purple-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Y,{path:lt,size:1.2,className:"text-purple-600"}),e.jsx("h4",{className:"font-medium text-purple-800",children:"Scanner"})]}),e.jsx("button",{onClick:c,disabled:l.length===0,className:`px-3 py-1 text-sm rounded-md transition-colors ${l.length===0?"bg-gray-400 text-gray-200 cursor-not-allowed":"bg-purple-600 text-white hover:bg-purple-700"}`,children:"Simulate Scan"})]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(Y,{path:Ve,size:1,className:"text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Tools Ready for Packaging"})]}),e.jsxs("p",{className:"text-sm text-blue-700",children:[l.length," tools available for packaging"]}),l.length>0&&e.jsx("div",{className:"mt-2 text-xs text-blue-600",children:e.jsxs("p",{children:["Available barcodes:"," ",l.slice(0,3).map(f=>f.barcode).join(", "),l.length>3&&`... and ${l.length-3} more`]})})]}),s&&e.jsx("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-md mb-4",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("span",{className:"font-medium",children:"Current Batch:"})," ",s]})}),e.jsxs("div",{className:"flex space-x-2 mb-4",children:[d&&e.jsxs("button",{onClick:d,className:"flex-1 flex items-center justify-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors",children:[e.jsx(Y,{path:ct,size:1}),e.jsx("span",{children:"+ New Autoclave Load"})]}),n&&e.jsxs("button",{onClick:n,className:"flex-1 flex items-center justify-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:[e.jsx(Y,{path:Oe,size:1}),e.jsx("span",{children:"Import Receipt"})]})]}),t&&e.jsx("div",{className:`p-3 rounded-md mb-3 ${t==="success"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:a}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{type:"text",value:r,onChange:f=>o(f.target.value),onKeyPress:m,className:"flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"Enter barcode manually or scan..."}),e.jsx("button",{onClick:()=>i(r),disabled:!r.trim(),className:"px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"Scan Tool"})]})]})},ca=({scannedTools:r,onRemoveTool:a,onFinalizePackage:t})=>e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h4",{className:"font-medium text-gray-800",children:["Scanned Tools (",r.length,")"]}),r.length>0&&e.jsx("button",{onClick:t,className:"px-3 py-1 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors",children:"Finalize Package"})]}),r.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Y,{path:Le,size:2,className:"mx-auto mb-2 text-gray-300"}),e.jsx("p",{children:"No tools scanned yet"}),e.jsx("p",{className:"text-sm",children:"Scan tools to add them to the package"})]}):e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:r.map(i=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-md",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-800",children:i.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Barcode: ",i.barcode]})]}),e.jsxs("button",{onClick:()=>a(i.id),className:"p-1 text-red-500 hover:text-red-700 transition-colors",children:[e.jsx(Y,{path:it,size:1}),e.jsx("span",{className:"sr-only",children:"Remove"})]})]},i.id))})]});var ia=Object.defineProperty,da=Object.defineProperties,ua=Object.getOwnPropertyDescriptors,Ie=Object.getOwnPropertySymbols,ma=Object.prototype.hasOwnProperty,ha=Object.prototype.propertyIsEnumerable,Me=(r,a,t)=>a in r?ia(r,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[a]=t,ve=(r,a)=>{for(var t in a||(a={}))ma.call(a,t)&&Me(r,t,a[t]);if(Ie)for(var t of Ie(a))ha.call(a,t)&&Me(r,t,a[t]);return r},je=(r,a)=>da(r,ua(a));const pa=({packageInfo:r,batchLoading:a,onPackageInfoChange:t,onFinalizePackage:i,onCancel:o,packageTypes:c,packageSizes:d})=>{const n=m=>{t(je(ve({},r),{packageType:m}))},s=m=>{t(je(ve({},r),{packageSize:m}))},l=m=>{t(je(ve({},r),{notes:m}))};return e.jsxs("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-800 mb-3",children:"Package Information"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"package-type",className:"block text-sm font-medium text-gray-700 mb-1",children:"Package Type"}),e.jsxs("select",{id:"package-type",value:r.packageType,onChange:m=>n(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select package type"}),c.map(m=>e.jsx("option",{value:m,children:m.charAt(0).toUpperCase()+m.slice(1)},m))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"package-size",className:"block text-sm font-medium text-gray-700 mb-1",children:"Package Size"}),e.jsxs("select",{id:"package-size",value:r.packageSize,onChange:m=>s(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select package size"}),d.map(m=>e.jsx("option",{value:m,children:m.charAt(0).toUpperCase()+m.slice(1).replace("-"," ")},m))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"package-notes",className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes (Optional)"}),e.jsx("textarea",{id:"package-notes",value:r.notes,onChange:m=>l(m.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",rows:2,placeholder:"Additional notes about the package..."})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-4",children:[e.jsx("button",{onClick:o,className:"px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:i,disabled:a||!r.packageType||!r.packageSize,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 transition-colors",children:a?"Processing...":"Generate Batch Code"})]})]})},ga=({operatorName:r,onOperatorNameChange:a,onStartSession:t,onCancel:i})=>e.jsxs("div",{className:"p-6 bg-white rounded-lg shadow-lg max-w-md mx-auto",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-4",children:"Packaging Workflow"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"operator-name",className:"block text-sm font-medium text-gray-700 mb-2",children:"Operator Name"}),e.jsx("input",{id:"operator-name",type:"text",value:r,onChange:o=>a(o.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500",placeholder:"Enter your name"})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{onClick:i,className:"px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:t,disabled:!r.trim(),className:"px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50 transition-colors",children:"Start Session"})]})]});var We=(r,a,t)=>new Promise((i,o)=>{var c=s=>{try{n(t.next(s))}catch(l){o(l)}},d=s=>{try{n(t.throw(s))}catch(l){o(l)}},n=s=>s.done?i(s.value):Promise.resolve(s.value).then(c,d);n((t=t.apply(r,a)).next())});const xa=({onClose:r,isBatchMode:a})=>{const{currentUser:t}=Ye(),[i,o]=u.useState(!1),[c,d]=u.useState(["pouch","wrap","container","tray"]),[n,s]=u.useState(["small","medium","large","extra-large"]),[l,m]=u.useState("PKG-"),[f,g]=u.useState(25),[p,y]=u.useState(!1),[x,b]=u.useState(null);u.useEffect(()=>{We(null,null,function*(){try{if(!(t!=null&&t.facility_id))return;const{data:V,error:Ze}=yield M.from("facility_settings").select("packaging_settings").eq("facility_id",t.facility_id).single();if(Ze)console.warn("No packaging settings found, using defaults");else if(V!=null&&V.packaging_settings){const ae=V.packaging_settings;d(G=>ae.packageTypes||G),s(G=>ae.packageSizes||G),m(G=>ae.batchPrefix||G),g(G=>ae.maxToolsPerBatch||G),y(!!ae.requireReceiptUpload)}}catch(V){console.error("Error loading packaging settings:",V)}finally{o(!0)}})},[t]);const h=oa(r,a);Xe.useEffect(()=>{h!=null&&h.loadToolsReadyForPackaging&&h.loadToolsReadyForPackaging()},[h]);const v=O=>{if(H.length>=f){alert(`❗ Maximum batch size reached. You can only package up to ${f} tools per batch.`);return}h==null||h.handleScan(O)},N=O=>We(null,null,function*(){b({url:O.photoUrl,id:O.id});try{O&&(j!=null&&j.currentBatchId)&&(t!=null&&t.facility_id)&&(yield ht(O.id||O.photoUrl||"unknown",j.currentBatchId,(t==null?void 0:t.name)||"Unknown Operator",t.facility_id))}catch(V){console.error("Failed to log receipt upload audit event:",V)}h==null||h.handleReceiptUploadSuccess()}),R=()=>{if(p&&(!x||!x.url)){alert("📄 Receipt upload required before completing this batch.");return}h==null||h.handleFinalizePackage()};if(!i)return e.jsx("p",{className:"text-sm text-gray-500",children:"Loading Packaging Settings..."});if(!h)return e.jsx("div",{className:"p-6 bg-white rounded-lg shadow-lg max-w-2xl mx-auto",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading packaging workflow..."})]})});const{operatorName:E,scannedBarcode:D,scanMessage:$,scanResult:k,packageInfo:A,showPackageForm:S,showReceiptUpload:B,scannedTools:H,batchLoading:C,currentSession:j,availableTools:P,isAssigning:L,locationCode:z,locationStatus:I,setOperatorName:me,setScannedBarcode:ee,setPackageInfo:te,setShowPackageForm:ne,setLocationCode:he,setIsAssigning:pe,handleScan:we,simulateScan:ge,handleNewAutoclaveLoad:le,handleImportReceipt:xe,handleReceiptUploadSuccess:Ne,handleReceiptUploadCancel:fe,handleFinalizePackage:ke,handleAssignLocation:be,handleEndSession:w,handleRemoveTool:F,handleStartSession:U}=h;return j?B?e.jsx(Qe,{batchCode:j.currentBatchId||"",operator:E,onSuccess:N,onCancel:fe}):L?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[99999] p-4",children:e.jsx("div",{className:"bg-white rounded-xl overflow-hidden w-full max-w-md shadow-2xl",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Room Assignment"}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"location",className:"block text-sm font-medium text-gray-700 mb-2",children:"Scan or enter location barcode:"}),e.jsx("input",{id:"location",type:"text",value:z,onChange:O=>he(O.target.value),placeholder:"e.g., ROOM-1-CUPBOARD-A",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>pe(!1),className:"px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:be,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors",children:"Assign Location"})]}),I&&e.jsxs("p",{className:"text-sm text-gray-600",children:["Location Status: ",I]})]})]})})}):e.jsxs("div",{className:"p-6 bg-white rounded-lg shadow-lg max-w-2xl mx-auto",children:[e.jsx(na,{operatorName:E,isBatchMode:a,onEndSession:w}),e.jsx(la,{scannedBarcode:D,scanMessage:$,scanResult:k,onScan:v,onBarcodeChange:ee,onSimulateScan:ge,onNewAutoclaveLoad:()=>le(l),onImportReceipt:xe,currentBatchCode:j.currentBatchId||void 0,availableTools:P}),e.jsx(ca,{scannedTools:H,onRemoveTool:F,onFinalizePackage:()=>ne(!0)}),p&&!x&&e.jsxs("div",{className:"mb-4 rounded-md bg-yellow-100 border border-yellow-300 px-4 py-3 text-sm text-yellow-800 flex items-center gap-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-yellow-700",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{children:"Receipt upload required before finalizing this batch."})]}),S&&e.jsx(pa,{packageInfo:A,batchLoading:C,onPackageInfoChange:te,onFinalizePackage:R,onCancel:()=>ne(!1),packageTypes:c,packageSizes:n}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("p",{children:["Session ID: ",j==null?void 0:j.id]}),e.jsxs("p",{children:["Started:"," ",j!=null&&j.startedAt?new Date(j.startedAt).toLocaleTimeString():"N/A"]}),e.jsxs("p",{children:["Tools Ready: ",P.length]})]})]}):e.jsx(ga,{operatorName:E,onOperatorNameChange:me,onStartSession:U,onCancel:r})},fa=({tool:r,onDismiss:a,onReplace:t,onContinue:i})=>{const o=(r.maxCycles||200)-r.cycleCount;return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{path:de,size:1.5,className:"text-red-500"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Tool Replacement Required"})]}),e.jsx("button",{onClick:a,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(T,{path:ue,size:1})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(T,{path:Ve,size:1,className:"text-red-500 mt-0.5"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-red-800 font-medium mb-2",children:[r.name," (Barcode: ",r.barcode,")"]}),e.jsxs("p",{className:"text-red-700 text-sm",children:["This tool has completed ",e.jsx("strong",{children:r.cycleCount})," ","sterilization cycles and has reached the maximum recommended limit of ",r.maxCycles||200," cycles."]}),o<=0&&e.jsx("p",{className:"text-red-700 text-sm font-medium mt-2",children:"⚠️ This tool has exceeded the maximum cycle limit and should be replaced immediately."}),o>0&&o<=5&&e.jsxs("p",{className:"text-orange-700 text-sm font-medium mt-2",children:["⚠️ Only ",o," cycle",o!==1?"s":""," remaining before replacement is required."]})]})]})}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Cycle Information"}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Current Cycles:"}),e.jsx("span",{className:"font-medium",children:r.cycleCount})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Maximum Cycles:"}),e.jsx("span",{className:"font-medium",children:r.maxCycles||200})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Cycles Remaining:"}),e.jsx("span",{className:`font-medium ${o<=0?"text-red-600":o<=5?"text-orange-600":"text-green-600"}`,children:o<=0?"Exceeded":o})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Recommendation"}),e.jsx("p",{className:"text-blue-800 text-sm",children:"For patient safety and compliance, it is recommended to replace this tool with a new one. Continued use beyond the cycle limit may compromise sterilization effectiveness."})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:t,className:"flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-medium",children:"Replace Tool"}),e.jsx("button",{onClick:i,className:"flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors font-medium",children:"Continue Anyway"})]}),e.jsx("div",{className:"mt-3 text-center",children:e.jsx("button",{onClick:a,className:"text-gray-500 hover:text-gray-700 text-sm transition-colors",children:"Dismiss"})})]})})},ba=u.memo(()=>{const{selectedWorkflow:r,scannedData:a,showWorkflowResult:t,scanMode:i,isScanning:o,scanMessage:c,scannedTools:d,dirtyScanMessage:n,isBath1Active:s,replacementAlert:l,handleWorkflowSelect:m,handleBackToWorkflow:f,handleScan:g,handleCloseWorkflow:p,handleReceiptUploadSuccess:y,handleReceiptUploadCancel:x,handleDeleteTool:b,handleCancelAll:h,handleSendScannedToBath1:v,handleScanModeChange:N,handleScanTool:R,handleReplaceTool:E,handleContinueAnyway:D,handleDismissReplacementAlert:$}=wt();return e.jsxs(e.Fragment,{children:[e.jsx(q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-black bg-opacity-30 z-40",onClick:()=>window.history.back()}),e.jsx(q.div,{initial:{x:"100%"},animate:{x:0},exit:{x:"100%"},transition:{duration:.3,ease:"easeInOut"},className:"fixed inset-y-0 right-0 w-[40%] bg-white shadow-2xl z-50",children:e.jsx("div",{className:"h-full flex flex-col",children:e.jsxs("div",{className:"bg-white overflow-hidden h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Sterilization Scanner"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Scan tools for sterilization workflows"})]}),e.jsx("div",{className:"p-4 overflow-y-auto flex-1 hide-scrollbar",style:{maxHeight:"calc(100vh - 120px)"},children:r?r==="import"?e.jsx("div",{children:e.jsx(Qe,{batchCode:"",operator:"",onSuccess:y,onCancel:x})}):r==="problem"?e.jsx("div",{children:e.jsx(Qt,{onClose:f})}):r==="clean"&&t?e.jsx("div",{children:e.jsx(ra,{scannedData:a,onClose:p})}):r==="packaging"?e.jsx("div",{children:e.jsx(xa,{onClose:f,isBatchMode:i==="batch"})}):r==="dirty"?e.jsxs("div",{className:"space-y-4",children:[e.jsx(Te,{workflowId:"dirty",color:"orange"}),s&&e.jsx("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(T,{path:de,size:.8,className:"text-red-600"}),e.jsx("span",{className:"text-red-700 text-xs font-medium",children:"Bath 1 is currently active"})]})}),l.show&&l.tool&&e.jsx(fa,{tool:l.tool,onDismiss:$,onReplace:E,onContinue:D}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>N("single"),className:`px-3 py-1.5 rounded text-sm transition-colors ${i==="single"?"bg-blue-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Single Scan"}),e.jsx("button",{onClick:()=>N("batch"),className:`px-3 py-1.5 rounded text-sm transition-colors ${i==="batch"?"bg-green-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Batch Scan"})]}),e.jsx(Re,{isScanning:o,scanMessage:n,onScan:R,size:"small"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h4",{className:"font-medium text-gray-800 text-sm",children:["Scanned Tools (",d.length,")"]}),d.length===0?e.jsxs("div",{className:"bg-gray-50 border-2 border-dashed border-gray-300 p-4 rounded text-center",children:[e.jsx(T,{path:oe,size:1.5,className:"text-gray-400 mx-auto mb-1"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"No tools scanned yet"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Use the scanner above to add tools"})]}):e.jsx("div",{className:"max-h-32 overflow-y-auto space-y-1 scrollbar-hide hide-scrollbar",children:d.map(k=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-100 p-2 rounded",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-sm",children:k.name}),e.jsxs("span",{className:"text-gray-600 text-xs ml-2",children:["(",k.barcode,")"]})]}),e.jsx("button",{onClick:()=>b(k.id),className:"text-red-500 hover:text-red-700 p-1",title:"Remove tool",children:e.jsx(T,{path:dt,size:.7})})]},k.id))})]}),s&&e.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(T,{path:de,size:1,className:"text-orange-600"}),e.jsx("span",{className:"text-orange-800 text-sm font-medium",children:"⚠️ Bath 1 timer is already in process"})]}),e.jsx("p",{className:"text-orange-600 text-xs mt-1",children:"Please wait for the current Bath 1 phase to complete before starting a new one."})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:h,disabled:d.length===0,className:`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${d.length===0?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-gray-100 text-gray-700 border border-gray-300 hover:bg-gray-200"}`,children:"Cancel"}),e.jsx("button",{onClick:v,disabled:d.length===0||s,className:`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${d.length===0||s?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-[#4ECDC4] text-white hover:bg-[#3db8b0]"}`,title:s?"Bath 1 timer is already in process":void 0,children:"Send to Bath 1"})]}),e.jsx("div",{className:"flex justify-center pt-2",children:e.jsx("button",{onClick:f,className:"px-3 py-1 text-gray-600 hover:text-gray-800 transition-colors text-sm",children:"← Back to Workflow Selection"})})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Te,{workflowId:r,color:"blue"}),e.jsx(Re,{isScanning:o,scanMessage:c,onScan:g,size:"large"}),e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:f,className:"px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors",children:"← Back to Workflow Selection"})})]}):e.jsx(Et,{onWorkflowSelect:m})})]})})})]})});ba.displayName="ScannerPage";export{ba as default};
