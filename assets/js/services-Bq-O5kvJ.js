const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/components-CrSzLpHe.js","assets/js/react-vendor-CAfHStow.js","assets/js/data-vendor-B3X5ReaK.js","assets/js/vendor-BtFhHG5P.js","assets/js/ui-vendor-mgcSnJSc.js","assets/css/ui-vendor-DJSy8M6b.css","assets/js/utils-vendor-CfclMkuN.js","assets/css/components-B4OH_j2L.css","assets/js/redisClient.server-RgZqzn2v.js","assets/js/inventory-pages-aeTDMVHI.js","assets/js/knowledgehub-pages-i9cBLZCy.js"])))=>i.map(i=>d[i]);
import{o as pe,_ as T,s as d,p as ht,q as v,k as j,r as Ve,t as ce,v as St,w as st,h as Qn,x as Ic,l as en}from"./components-CrSzLpHe.js";import{c as Sc,r as bc}from"./react-vendor-CAfHStow.js";import{g as Ec,a as Ac,b as Tc,c as kc,I as Cc,d as Os,e as Pc,f as mr}from"./inventory-pages-aeTDMVHI.js";import{A as Rs,U as N,K as Yn}from"./knowledgehub-pages-i9cBLZCy.js";class Jt{constructor(){}static getInstance(){return Jt.instance||(Jt.instance=new Jt),Jt.instance}getDefaultFacilityId(){const e=pe("VITE_DEFAULT_FACILITY_ID","");if(e)return e;throw new Error("VITE_DEFAULT_FACILITY_ID environment variable must be set in production")}isValidFacilityId(e){return!e||e.trim()===""?!1:/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)}getOAuthFacilityConfig(){return{facility_id:this.getDefaultFacilityId()}}}const v_=Jt.getInstance();var Dt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class kt{static getCurrentFacilityId(){return Dt(this,null,function*(){try{const{distributedFacilityCache:e}=yield T(()=>Promise.resolve().then(()=>Uo),void 0),{supabase:t}=yield T(()=>import("./components-CrSzLpHe.js").then(n=>n.at),__vite__mapDeps([0,1,2,3,4,5,6,7])),{data:{user:r},error:i}=yield t.auth.getUser();if(i||!r)return console.error("Failed to get current user:",i),"550e8400-e29b-41d4-a716-446655440000";const a=yield e.getFacility(`facility:${r.id}`);if(a)return a.id;const{data:s,error:o}=yield t.from("users").select("facility_id").eq("id",r.id).single();if(o||!(s!=null&&s.facility_id)){console.error("Failed to get current facility ID:",o);const n={id:"550e8400-e29b-41d4-a716-446655440000",name:"Development Facility",type:"hospital",isActive:!0,createdAt:"2024-01-01T00:00:00.000Z",updatedAt:"2024-01-01T00:00:00.000Z"};return yield e.setFacility(`facility:${r.id}`,n),"550e8400-e29b-41d4-a716-446655440000"}try{const n=yield kt.getFacilityById(s.facility_id);return yield e.setFacility(`facility:${r.id}`,n),s.facility_id}catch(n){console.error("Facility not found:",n);const l={id:"550e8400-e29b-41d4-a716-446655440000",name:"Development Facility",type:"hospital",isActive:!0,createdAt:"2024-01-01T00:00:00.000Z",updatedAt:"2024-01-01T00:00:00.000Z"};return yield e.setFacility(`facility:${r.id}`,l),"550e8400-e29b-41d4-a716-446655440000"}}catch(e){return console.error("Failed to get current facility ID:",e),"550e8400-e29b-41d4-a716-446655440000"}})}static getFacility(e){return Dt(this,null,function*(){return{id:e,name:"Test Facility",type:"hospital",isActive:!0,createdAt:"2024-01-01T00:00:00.000Z",updatedAt:"2024-01-01T00:00:00.000Z"}})}static getFacilityById(e){return Dt(this,null,function*(){return{id:e,name:"Test Facility",type:"hospital",isActive:!0,createdAt:"2024-01-01T00:00:00.000Z",updatedAt:"2024-01-01T00:00:00.000Z"}})}static getAllFacilities(e){return Dt(this,null,function*(){try{const{supabase:t}=yield T(()=>import("./components-CrSzLpHe.js").then(f=>f.at),__vite__mapDeps([0,1,2,3,4,5,6,7])),r=(e==null?void 0:e.page)||1,i=(e==null?void 0:e.limit)||50,a=(r-1)*i,s=a+i-1,{data:o,error:n,count:l}=yield t.from("facilities").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range(a,s);if(n)throw n;const u=Math.ceil((l||0)/i);return{data:(o||[]).map(f=>({id:f.id,name:f.name,type:f.type,isActive:f.is_active,createdAt:f.created_at,updatedAt:f.updated_at})),total:l||0,page:r,limit:i,totalPages:u,hasNext:r<u,hasPrev:r>1}}catch(t){throw console.error("Failed to get all facilities:",t),t}})}static getCurrentUserId(){return Dt(this,null,function*(){return"user-123"})}static validateFacilityId(e){return!!(e&&e.length>0&&e!=="default-facility-id")}static clearCache(){return Dt(this,null,function*(){try{const{distributedFacilityCache:e}=yield T(()=>Promise.resolve().then(()=>Uo),void 0);yield e.clearAll()}catch(e){console.error("Failed to clear facility cache:",e)}})}}const ge=Object.freeze(Object.defineProperty({__proto__:null,FacilityService:kt},Symbol.toStringTag,{value:"Module"}));var Xt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function Dc(){return Xt(this,null,function*(){var c,e,t,r;try{const{data:{user:i},error:a}=yield d.auth.getUser();return{userId:(c=i==null?void 0:i.id)!=null?c:null,facilityId:(t=(e=i==null?void 0:i.user_metadata)==null?void 0:e.facility_id)!=null?t:null,authError:(r=a==null?void 0:a.message)!=null?r:null}}catch(i){return{userId:null,facilityId:null,authError:"context_fetch_failed"}}})}function Yr(c,e,t,r){return Xt(this,null,function*(){try{const i=yield Dc(),a={type:c,severity:e,message:t,user_id:i.userId,facility_id:i.facilityId,context:r!=null?r:null,created_at:new Date().toISOString()},{error:s}=yield d.from("app_events").insert([a]);return s?((pe("NODE_ENV")==="development"||pe("MODE")==="development")&&console.warn("ðŸŸ¡ observabilityService: insert failed (likely missing table)",s.message),{success:!1,error:s.message}):{success:!0}}catch(i){return(pe("NODE_ENV")==="development"||pe("MODE")==="development")&&console.warn("ðŸŸ¡ observabilityService: unexpected error",i instanceof Error?i.message:String(i)),{success:!1,error:String(i)}}})}const Oc={logSecurityEvent(c,e,t){return Xt(this,null,function*(){return Yr(c,"warning",e,t)})},logCritical(c,e){return Xt(this,null,function*(){return Yr("app.error","critical",c,e)})},logError(c,e){return Xt(this,null,function*(){return Yr("app.error","error",c,e)})},logInfo(c,e,t){return Xt(this,null,function*(){return Yr(c,"info",e,t)})}};var Re=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class w_{static getAvailableKits(e){return Re(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_kits").select("*").eq("facility_id",e).eq("status","active").gt("quantity",0).gt("expiry_date",new Date().toISOString().split("T")[0]).order("expiry_date",{ascending:!0});if(r)throw new Error(`Failed to get available BI test kits: ${r.message}`);return(t||[]).map(i=>({id:i.id,facility_id:i.facility_id,name:i.name,manufacturer:i.manufacturer,lot_number:i.lot_number,serial_number:i.serial_number||void 0,barcode:i.barcode||void 0,expiry_date:i.expiry_date,incubation_time_minutes:i.incubation_time_minutes,incubation_temperature_celsius:i.incubation_temperature_celsius,quantity:i.quantity,min_quantity:i.min_quantity,max_quantity:i.max_quantity,location:i.location||void 0,status:i.status,supplier:i.supplier||void 0,cost:i.cost||void 0,notes:i.notes||void 0,created_at:i.created_at,updated_at:i.updated_at,created_by:i.created_by||void 0,updated_by:i.updated_by||void 0}))})}static getKitById(e){return Re(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_kits").select("*").eq("id",e).single();if(r)throw new Error(`Failed to get BI test kit: ${r.message}`);if(!t)throw new Error("BI test kit not found");const i=t;return{id:i.id,facility_id:i.facility_id,name:i.name,manufacturer:i.manufacturer,lot_number:i.lot_number,serial_number:i.serial_number||void 0,barcode:i.barcode||void 0,expiry_date:i.expiry_date,incubation_time_minutes:i.incubation_time_minutes,incubation_temperature_celsius:i.incubation_temperature_celsius,quantity:i.quantity,min_quantity:i.min_quantity,max_quantity:i.max_quantity,location:i.location||void 0,status:i.status,supplier:i.supplier||void 0,cost:i.cost||void 0,notes:i.notes||void 0,created_at:i.created_at,updated_at:i.updated_at,created_by:i.created_by||void 0,updated_by:i.updated_by||void 0}})}static createKit(e){return Re(this,null,function*(){const t={facility_id:e.facility_id,name:e.name,manufacturer:e.manufacturer,lot_number:e.lot_number,serial_number:e.serial_number,barcode:e.barcode,expiry_date:e.expiry_date,incubation_time_minutes:e.incubation_time_minutes,incubation_temperature_celsius:e.incubation_temperature_celsius,quantity:e.quantity,min_quantity:e.min_quantity,max_quantity:e.max_quantity,location:e.location,status:e.status,supplier:e.supplier,cost:e.cost,notes:e.notes,created_by:e.created_by,updated_by:e.updated_by},{data:r,error:i}=yield d.from("bi_test_kits").insert(t).select().single();if(i)throw new Error(`Failed to create BI test kit: ${i.message}`);if(!r)throw new Error("No data returned from BI test kit creation");const a=r;return{id:a.id,facility_id:a.facility_id,name:a.name,manufacturer:a.manufacturer,lot_number:a.lot_number,serial_number:a.serial_number||void 0,barcode:a.barcode||void 0,expiry_date:a.expiry_date,incubation_time_minutes:a.incubation_time_minutes,incubation_temperature_celsius:a.incubation_temperature_celsius,quantity:a.quantity,min_quantity:a.min_quantity,max_quantity:a.max_quantity,location:a.location||void 0,status:a.status,supplier:a.supplier||void 0,cost:a.cost||void 0,notes:a.notes||void 0,created_at:a.created_at,updated_at:a.updated_at,created_by:a.created_by||void 0,updated_by:a.updated_by||void 0}})}static useKit(e){return Re(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_kits").select("quantity").eq("id",e).single();if(r||!t)throw new Error(`Failed to fetch BI test kit: ${(r==null?void 0:r.message)||"Kit not found"}`);const i=t;if(i.quantity<=0)throw new Error("BI test kit quantity is already 0");const{error:a}=yield d.from("bi_test_kits").update({quantity:i.quantity-1,updated_at:new Date().toISOString()}).eq("id",e);if(a)throw new Error(`Failed to update BI test kit quantity: ${a.message}`)})}static decrementKitQuantity(e){return Re(this,null,function*(){return this.useKit(e)})}static getCurrentTestConditions(){return Re(this,null,function*(){const{data:{user:e},error:t}=yield d.auth.getUser();if(t||!e)throw new Error("User not authenticated");const{data:r,error:i}=yield d.from("users").select("facility_id").eq("id",e.id).single();if(i||!r)throw new Error("User facility not found");const a=r;return{room_temperature_celsius:22,humidity_percent:45,equipment_used:"Standard Incubator",operator_id:e.id,facility_id:a.facility_id,test_date:new Date().toISOString(),environmental_notes:"Standard laboratory conditions"}})}static getFailureReason(){return Re(this,null,function*(){const e="Positive growth detected during incubation period";try{const t=yield this.getCurrentTestConditions();return`${e}. Test conducted at ${t.room_temperature_celsius}Â°C for standard incubation period.`}catch(t){return console.error(t),e}})}static getSkipReason(){return Re(this,null,function*(){return"Test skipped by operator - reason documented in compliance notes"})}static getComplianceNotes(){return Re(this,null,function*(){const e="BI test passed successfully - sterilization process validated";try{const t=yield this.getCurrentTestConditions();return`${e}. Test conditions: ${t.room_temperature_celsius}Â°C, standard incubation period.`}catch(t){return console.error(t),e}})}static checkKitInventory(e){return Re(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_kits").select("quantity, expiry_date, status").eq("facility_id",e);if(r)throw new Error(`Failed to check kit inventory: ${r.message}`);const i=t||[],a=i.filter(l=>l.status==="active"&&l.quantity>0&&new Date(l.expiry_date)>new Date).reduce((l,u)=>l+u.quantity,0),s=i.filter(l=>new Date(l.expiry_date)<=new Date).length,o=a<5,n=[];return o&&n.push("Order additional BI test kits to maintain adequate inventory"),s>0&&n.push(`Dispose of ${s} expired BI test kit(s)`),{available:a,low_stock:o,expired_count:s,recommendations:n}})}}var Rc=Object.defineProperty,$c=Object.defineProperties,Mc=Object.getOwnPropertyDescriptors,Jn=Object.getOwnPropertySymbols,qc=Object.prototype.hasOwnProperty,zc=Object.prototype.propertyIsEnumerable,Xn=(c,e,t)=>e in c?Rc(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Uc=(c,e)=>{for(var t in e||(e={}))qc.call(e,t)&&Xn(c,t,e[t]);if(Jn)for(var t of Jn(e))zc.call(e,t)&&Xn(c,t,e[t]);return c},Fc=(c,e)=>$c(c,Mc(e)),Ot=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Gr{static createBITestResult(e){return Ot(this,null,function*(){try{const r=new Date().toISOString().split("T")[0].replace(/-/g,""),i=Date.now().toString().slice(-6),a=`BI-${r}-${i}`,s={facility_id:e.facility_id,operator_id:e.operator_id,cycle_id:e.cycle_id||"00000000-0000-0000-0000-000000000000",test_number:a,test_date:e.test_date||new Date().toISOString(),result:e.result,bi_lot_number:e.bi_lot_number,bi_expiry_date:e.bi_expiry_date,incubation_time_minutes:e.incubation_time_minutes,incubation_temperature_celsius:e.incubation_temperature_celsius,test_conditions:e.test_conditions,failure_reason:e.failure_reason,skip_reason:e.skip_reason,compliance_notes:e.compliance_notes};console.log("ðŸ” Inserting BI test data:",JSON.stringify(s,null,2));const{data:o,error:n}=yield d.from("bi_test_results").insert(s).select().single();if(n)throw console.error("âŒ Database error details:",n),n;if(!o||typeof o!="object")throw new Error("Invalid test result data");const l=o;return{id:l.id,facility_id:l.facility_id,operator_id:l.operator_id||void 0,cycle_id:l.cycle_id||void 0,test_number:l.test_number,test_date:l.test_date,result:l.result,status:l.status,bi_lot_number:l.bi_lot_number||void 0,bi_expiry_date:l.bi_expiry_date||void 0,incubation_time_minutes:l.incubation_time_minutes||void 0,incubation_temperature_celsius:l.incubation_temperature_celsius||void 0,test_conditions:l.test_conditions||{},failure_reason:l.failure_reason||void 0,skip_reason:l.skip_reason||void 0,compliance_notes:l.compliance_notes||void 0,audit_signature:l.audit_signature||void 0,created_at:l.created_at,updated_at:l.updated_at}}catch(t){throw console.error("Failed to create BI test result:",t),t}})}static updateBITestResult(e,t){return Ot(this,null,function*(){const{data:r,error:i}=yield d.from("bi_test_results").update(Fc(Uc({},t),{updated_at:new Date().toISOString()})).eq("id",e).select().single();if(i)throw new Error(`Failed to update BI test result: ${i.message}`);if(!r)throw new Error("No data returned from BI test result update");const a=r;return{id:a.id,facility_id:a.facility_id,operator_id:a.operator_id||void 0,cycle_id:a.cycle_id||void 0,test_number:a.test_number,test_date:a.test_date,result:a.result,status:a.status,bi_lot_number:a.bi_lot_number||void 0,bi_expiry_date:a.bi_expiry_date||void 0,incubation_time_minutes:a.incubation_time_minutes||void 0,incubation_temperature_celsius:a.incubation_temperature_celsius||void 0,test_conditions:a.test_conditions||{},failure_reason:a.failure_reason||void 0,skip_reason:a.skip_reason||void 0,compliance_notes:a.compliance_notes||void 0,audit_signature:a.audit_signature||void 0,created_at:a.created_at,updated_at:a.updated_at}})}static getBITestResults(){return Ot(this,arguments,function*(e={}){let t=d.from("bi_test_results").select(`
        *,
        facilities(name, facility_code),
        operators(name, role),
        sterilization_cycles(cycle_number, cycle_type)
      `).order("test_date",{ascending:!1});e.facility_id&&(t=t.eq("facility_id",e.facility_id)),e.operator_id&&(t=t.eq("operator_id",e.operator_id)),e.cycle_id&&(t=t.eq("cycle_id",e.cycle_id)),e.result&&(t=t.eq("result",e.result)),e.status&&(t=t.eq("status",e.status)),e.start_date&&(t=t.gte("test_date",e.start_date)),e.end_date&&(t=t.lte("test_date",e.end_date)),e.limit&&(t=t.limit(e.limit)),e.offset&&(t=t.range(e.offset,e.offset+(e.limit||10)-1));const{data:r,error:i}=yield t;if(i)throw new Error(`Failed to fetch BI test results: ${i.message}`);return(r||[]).map(a=>({id:a.id,facility_id:a.facility_id,operator_id:a.operator_id||void 0,cycle_id:a.cycle_id||void 0,test_number:a.test_number,test_date:a.test_date,result:a.result,status:a.status,bi_lot_number:a.bi_lot_number||void 0,bi_expiry_date:a.bi_expiry_date||void 0,incubation_time_minutes:a.incubation_time_minutes||void 0,incubation_temperature_celsius:a.incubation_temperature_celsius||void 0,test_conditions:a.test_conditions||{},failure_reason:a.failure_reason||void 0,skip_reason:a.skip_reason||void 0,compliance_notes:a.compliance_notes||void 0,audit_signature:a.audit_signature||void 0,created_at:a.created_at,updated_at:a.updated_at}))})}static getBITestResult(e){return Ot(this,null,function*(){try{const{data:t,error:r}=yield d.from("bi_test_results").select("*").eq("id",e).single();if(r){if(r.code==="PGRST116")return null;throw r}if(!t||typeof t!="object")return null;const i=t;return{id:i.id,facility_id:i.facility_id,operator_id:i.operator_id||void 0,cycle_id:i.cycle_id||void 0,test_number:i.test_number,test_date:i.test_date,result:i.result,status:i.status,bi_lot_number:i.bi_lot_number||void 0,bi_expiry_date:i.bi_expiry_date||void 0,incubation_time_minutes:i.incubation_time_minutes||void 0,incubation_temperature_celsius:i.incubation_temperature_celsius||void 0,test_conditions:i.test_conditions||{},failure_reason:i.failure_reason||void 0,skip_reason:i.skip_reason||void 0,compliance_notes:i.compliance_notes||void 0,audit_signature:i.audit_signature||void 0,created_at:i.created_at,updated_at:i.updated_at}}catch(t){throw console.error("Failed to get BI test result:",t),t}})}static deleteBITestResult(e){return Ot(this,null,function*(){const{error:t}=yield d.from("bi_test_results").delete().eq("id",e);if(t)throw new Error(`Failed to delete BI test result: ${t.message}`)})}static generateTestNumber(e){return Ot(this,null,function*(){const t=new Date,r=t.toISOString().split("T")[0].replace(/-/g,""),{count:i,error:a}=yield d.from("bi_test_results").select("*",{count:"exact",head:!0}).eq("facility_id",e).gte("test_date",t.toISOString().split("T")[0]).lt("test_date",new Date(t.getTime()+1440*60*1e3).toISOString().split("T")[0]);if(a)throw new Error(`Failed to generate test number: ${a.message}`);return`BI-${r}-${String((i!=null?i:0)+1).padStart(3,"0")}`})}}var Rt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const Wr={getBIPassRate(c){return Rt(this,null,function*(){const{data:e,error:t}=yield d.from("bi_test_results").select("id").eq("facility_id",c).eq("result","pass");return t?{data:null,error:t}:{data:e.length,error:null}})},getBIPassRateAnalytics(c){return Rt(this,null,function*(){const{data:e,error:t}=yield d.from("bi_test_results").select("*").eq("facility_id",c);if(t)return{data:null,error:t};const r=e.length,i=e.filter(s=>s.result==="pass").length,a=r>0?i/r*100:0;return{data:{totalTests:r,passedTests:i,passRate:a,facilityId:c},error:null}})},getOperatorPerformance(c,e){return Rt(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_results").select("*").eq("facility_id",c).eq("operator_id",e);return r?{data:null,error:r}:{data:t,error:null}})},getBITestAnalytics(c){return Rt(this,null,function*(){const{data:e,error:t}=yield d.from("bi_test_results").select("*").eq("facility_id",c);return t?{data:null,error:t}:{data:{totalTests:e.length,passedTests:e.filter(i=>i.result==="pass").length,failedTests:e.filter(i=>i.result==="fail").length,facilityId:c},error:null}})},getAITrainingData(c){return Rt(this,null,function*(){const{data:e,error:t}=yield d.from("bi_test_results").select("*").eq("facility_id",c);return t?{data:null,error:t}:{data:e.map(i=>({id:i.id,facilityId:i.facility_id,operatorId:i.operator_id,result:i.result,timestamp:i.created_at,features:{incubationTemperature:i.incubation_temperature_celsius,incubationTime:i.incubation_time_minutes,testConditions:i.test_conditions,status:i.status}})),error:null}})},getPredictiveAnalyticsData(c){return Rt(this,null,function*(){const{data:e,error:t}=yield d.from("bi_test_results").select("*").eq("facility_id",c).order("created_at",{ascending:!1}).limit(100);if(t)return{data:null,error:t};const r=e.length,i=e.slice(0,30),a=i.length>0?i.filter(o=>o.result==="pass").length/i.length*100:0;return{data:{facilityId:c,totalTests:r,recentPassRate:a,trendAnalysis:{isImproving:a>80,riskLevel:a<70?"high":a<85?"medium":"low"},recommendations:a<70?["Review sterilization procedures","Check equipment calibration","Retrain operators"]:a<85?["Monitor trends closely","Consider preventive maintenance"]:["Maintain current procedures"]},error:null}})}};var mt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ft{static getFacilities(){return mt(this,null,function*(){return[{id:"default-facility",name:"Default Facility",facility_code:"DF001",address:void 0,contact_email:void 0,contact_phone:void 0,compliance_requirements:{},settings:{},is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]})}static getOperators(e){return mt(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("*").eq("facility_id",e).eq("is_active",!0).order("first_name");if(r)throw new Error(`Failed to fetch operators: ${r.message}`);return(t||[]).map(i=>{var a,s,o,n,l;return{id:i.id||"",facility_id:i.facility_id,user_id:i.id||void 0,name:i.full_name||`${i.first_name||""} ${i.last_name||""}`.trim(),email:i.email||void 0,role:((a=i.preferences)==null?void 0:a.role)||"operator",certification_number:((s=i.preferences)==null?void 0:s.certification_number)||void 0,certification_expiry:((o=i.preferences)==null?void 0:o.certification_expiry)||void 0,permissions:((n=i.preferences)==null?void 0:n.permissions)||{},performance_metrics:((l=i.preferences)==null?void 0:l.performance_metrics)||{},is_active:i.is_active||!1,created_at:i.created_at||"",updated_at:i.updated_at||""}})})}static getSterilizationCycles(e,t=50){return mt(this,null,function*(){const r=`${e}-${t}`,i=this.cache.get(r);if(i&&Date.now()-i.timestamp<this.CACHE_DURATION)return i.data;const{data:a,error:s}=yield d.from("sterilization_cycles").select("id, cycle_number, start_time, end_time, status, parameters, tools").eq("facility_id",e).order("start_time",{ascending:!1}).limit(t);if(s)throw new Error(`Failed to fetch sterilization cycles: ${s.message}`);const o=(a||[]).map(n=>({id:n.id,facility_id:n.facility_id||"",operator_id:n.operator_id||void 0,cycle_number:n.cycle_number||"",cycle_type:n.cycle_type||"standard",status:n.status||"pending",start_time:n.start_time||"",end_time:n.end_time||void 0,phases:n.parameters||[],tools:n.tools||[],cycle_parameters:n.parameters||{},environmental_factors:n.results||{},notes:n.notes||void 0,created_at:n.created_at||"",updated_at:n.updated_at||""}));return this.cache.set(r,{data:o,timestamp:Date.now()}),o})}static createSterilizationCycle(e){return mt(this,null,function*(){const t=yield this.generateCycleNumber(e.facility_id),r={id:crypto.randomUUID(),facility_id:e.facility_id,operator_id:e.operator_id||"",cycle_type:e.cycle_type||"standard",cycle_number:t,start_time:new Date().toISOString(),status:e.status||"pending",parameters:e.cycle_parameters||{},results:e.environmental_factors||{},tools:e.tools||[],notes:e.notes,autoclave_id:"default-autoclave",tool_batch_id:"default-batch"},{data:i,error:a}=yield d.from("sterilization_cycles").insert(r).select().single();if(a)throw new Error(`Failed to create sterilization cycle: ${a.message}`);if(!i)throw new Error("No data returned from sterilization cycle creation");const s=i;return{id:s.id,facility_id:s.facility_id||"",operator_id:s.operator_id||void 0,cycle_number:s.cycle_number||"",cycle_type:s.cycle_type||"standard",status:s.status||"pending",start_time:s.start_time||"",end_time:s.end_time||void 0,phases:s.tools||[],tools:s.tools||[],cycle_parameters:s.parameters||{},environmental_factors:s.results||{},notes:s.notes||void 0,created_at:s.created_at||"",updated_at:s.updated_at||""}})}static getEquipment(e){return mt(this,null,function*(){return[]})}static getComplianceAudits(e){return mt(this,null,function*(){const{data:t,error:r}=yield d.from("audit_logs").select("*").eq("facility_id",e).order("created_at",{ascending:!1});if(r)throw new Error(`Failed to fetch compliance audits: ${r.message}`);return(t||[]).map(i=>{var a,s,o,n,l,u,h,f,m;return{id:i.id||"",facility_id:i.facility_id||"",audit_type:((a=i.metadata)==null?void 0:a.audit_type)||"daily",audit_date:i.created_at,auditor_id:(s=i.user_id)!=null?s:"system",audit_scope:((o=i.metadata)==null?void 0:o.audit_scope)||{},findings:((n=i.metadata)==null?void 0:n.findings)||[],compliance_score:((l=i.metadata)==null?void 0:l.compliance_score)||void 0,recommendations:((u=i.metadata)==null?void 0:u.recommendations)||void 0,corrective_actions:((h=i.metadata)==null?void 0:h.corrective_actions)||[],follow_up_date:((f=i.metadata)==null?void 0:f.follow_up_date)||void 0,status:((m=i.metadata)==null?void 0:m.status)||"pending",created_at:i.created_at,updated_at:i.updated_at||""}})})}static generateCycleNumber(e){return mt(this,null,function*(){const t=new Date,r=t.toISOString().split("T")[0].replace(/-/g,""),{count:i,error:a}=yield d.from("sterilization_cycles").select("*",{count:"exact",head:!0}).eq("facility_id",e).gte("start_time",t.toISOString().split("T")[0]).lt("start_time",new Date(t.getTime()+1440*60*1e3).toISOString().split("T")[0]);if(a)throw new Error(`Failed to generate cycle number: ${a.message}`);return`CYCLE-${r}-${String((i!=null?i:0)+1).padStart(3,"0")}`})}}ft.cache=new Map;ft.CACHE_DURATION=300*1e3;class Fi{static subscribe(e,t,r){r!=null&&r.event;const i=d.channel(e).on("postgres_changes",{event:"*",schema:"public"},t).subscribe();return this.subscriptions.push(i),()=>{this.unsubscribe(i)}}static unsubscribe(e){e&&typeof e=="object"&&"unsubscribe"in e&&e.unsubscribe(),this.subscriptions=this.subscriptions.filter(t=>t!==e)}static forceCleanup(){this.subscriptions.forEach(e=>{e&&typeof e=="object"&&"unsubscribe"in e&&e.unsubscribe()}),this.subscriptions=[]}static getStats(){return{activeChannels:this.subscriptions.length,totalChannels:this.subscriptions.length,totalSubscribers:this.subscriptions.length,tableSubscribers:{},subscriptions:this.subscriptions,performance:{isHealthy:this.subscriptions.length<50,warnings:this.subscriptions.length>30?["High subscription count"]:[],recommendations:this.subscriptions.length>20?["Consider cleanup"]:[]}}}static cleanup(){this.forceCleanup()}static globalCleanup(){this.forceCleanup()}static nuclearCleanup(){console.warn("â˜¢ï¸ NUCLEAR CLEANUP: Force-disconnecting all realtime connections"),this.forceCleanup()}}Fi.subscriptions=[];class $s{static subscribeToBITestChanges(e){if(!ht()){console.warn("âš ï¸ Supabase not configured, skipping BI test subscription");return}try{return Fi.subscribe("bi_test_results",e,{event:"*"})}catch(t){return console.error("âŒ Failed to subscribe to BI test changes:",t),null}}static subscribeToCycleChanges(e){if(!ht()){console.warn("âš ï¸ Supabase not configured, skipping cycle subscription");return}try{return Fi.subscribe("sterilization_cycles",e,{event:"*"})}catch(t){return console.error("âŒ Failed to subscribe to cycle changes:",t),null}}}class K{}K.createBITestResult=Gr.createBITestResult;K.updateBITestResult=Gr.updateBITestResult;K.getBITestResults=Gr.getBITestResults;K.getBITestResult=Gr.getBITestResult;K.deleteBITestResult=Gr.deleteBITestResult;K.getBIPassRateAnalytics=Wr.getBIPassRateAnalytics;K.getOperatorPerformance=Wr.getOperatorPerformance;K.getBITestAnalytics=Wr.getBITestAnalytics;K.getAITrainingData=Wr.getAITrainingData;K.getPredictiveAnalyticsData=Wr.getPredictiveAnalyticsData;K.getFacilities=ft.getFacilities;K.getOperators=ft.getOperators;K.getSterilizationCycles=ft.getSterilizationCycles;K.createSterilizationCycle=ft.createSterilizationCycle;K.getEquipment=ft.getEquipment;K.getComplianceAudits=ft.getComplianceAudits;K.subscribeToBITestChanges=$s.subscribeToBITestChanges;K.subscribeToCycleChanges=$s.subscribeToCycleChanges;class X extends Error{constructor(e,t,r="medium",i=!1,a){super(e),this.code=t,this.severity=r,this.retryable=i,this.details=a,this.name="BIFailureError"}}const k={MISSING_FACILITY_ID:"MISSING_FACILITY_ID",INVALID_TOOLS_COUNT:"INVALID_TOOLS_COUNT",MISSING_BATCH_IDS:"MISSING_BATCH_IDS",VALIDATION_ERROR:"VALIDATION_ERROR"};var Lc=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class I{static handleDatabaseError(e,t,r){this.logError("DATABASE_ERROR",e,t,r);const i=e;throw(i==null?void 0:i.code)==="PGRST116"?new X(`Database connection error during ${t}: ${i.message||"Unknown error"}`,"DATABASE_CONNECTION_ERROR","critical",!0):(i==null?void 0:i.code)==="23505"?new X(`Duplicate record error during ${t}: ${i.message||"Unknown error"}`,"DUPLICATE_RECORD_ERROR","high",!1):(i==null?void 0:i.code)==="23503"?new X(`Foreign key constraint error during ${t}: ${i.message||"Unknown error"}`,"FOREIGN_KEY_ERROR","high",!1):new X(`Database error during ${t}: ${(i==null?void 0:i.message)||"Unknown error"}`,"DATABASE_ERROR","critical",!0)}static handleNetworkError(e,t,r){var i;this.logError("NETWORK_ERROR",e,t,r);const a=e;throw(a==null?void 0:a.code)==="NETWORK_ERROR"||(i=a==null?void 0:a.message)!=null&&i.includes("network")?new X(`Network connection failed during ${t}: ${a.message||"Unknown error"}`,"NETWORK_ERROR","high",!0):(a==null?void 0:a.code)==="PGRST116"?new X(`Database connection timeout during ${t}: ${a.message||"Unknown error"}`,"DATABASE_TIMEOUT_ERROR","critical",!0):new X(`Network error during ${t}: ${(a==null?void 0:a.message)||"Unknown error"}`,"NETWORK_ERROR","high",!0)}static handleValidationError(e,t,r="medium"){throw this.logError("VALIDATION_ERROR",{message:e,code:t},"validation"),new X(e,t,r,!1)}static handleAuthorizationError(e,t,r){this.logError("AUTHORIZATION_ERROR",e,t,r);const i=e;throw new X(`Authorization error during ${t}: ${(i==null?void 0:i.message)||"Access denied"}`,"AUTHORIZATION_ERROR","high",!1)}static handleCriticalError(e,t,r){var i,a,s;this.logError("CRITICAL_ERROR",e,t,r);const o=e;throw(o==null?void 0:o.code)==="CRITICAL_ERROR"||(i=o==null?void 0:o.message)!=null&&i.includes("critical")?new X(`Critical error during ${t}: ${o.message||"System failure"}`,"CRITICAL_ERROR","critical",!1):(o==null?void 0:o.code)==="HIGH_PRIORITY"||(a=o==null?void 0:o.message)!=null&&a.includes("high")?new X(`High priority error during ${t}: ${o.message||"High priority issue"}`,"HIGH_PRIORITY_ERROR","high",!1):(o==null?void 0:o.code)==="MEDIUM_PRIORITY"||(s=o==null?void 0:o.message)!=null&&s.includes("medium")?new X(`Medium priority error during ${t}: ${o.message||"Medium priority issue"}`,"MEDIUM_PRIORITY_ERROR","medium",!1):new X(`Critical error during ${t}: ${(o==null?void 0:o.message)||"Unknown critical error"}`,"CRITICAL_ERROR","critical",!1)}static createStandardizedError(e,t,r="UNKNOWN_ERROR"){const i=e;return new X((i==null?void 0:i.message)||`Unknown error during ${t}`,r,"medium",!0,{name:(i==null?void 0:i.name)||"UnknownError",message:(i==null?void 0:i.message)||"No message",code:(i==null?void 0:i.code)||"NO_CODE",operation:t,stack:i==null?void 0:i.stack})}static logError(e,t,r,i){if(this.errorCount++,this.errorCount>this.MAX_ERRORS){console.warn("Maximum error count reached, stopping error logging");return}const a={type:e,operation:r,timestamp:new Date().toISOString(),context:i,error:t instanceof Error?{name:t.name,message:t.message,stack:t.stack}:t};console.error("BIFailureErrorHandler:",a),t instanceof Error&&(this.lastError=t)}static getLastError(){return this.lastError}static reset(){this.lastError=null,this.errorCount=0}static isRetryableError(e){var t,r,i;if(e instanceof X)return e.retryable;const a=e;return!!((a==null?void 0:a.code)==="NETWORK_ERROR"||(t=a==null?void 0:a.message)!=null&&t.includes("network")||(r=a==null?void 0:a.message)!=null&&r.includes("timeout")||(a==null?void 0:a.code)==="PGRST116"||(i=a==null?void 0:a.message)!=null&&i.includes("connection"))}static handleUnexpectedError(e,t){this.logError("UNEXPECTED_ERROR",e,t);const r=e;throw new X(`Unexpected error during ${t}: ${(r==null?void 0:r.message)||"Unknown error"}`,"UNEXPECTED_ERROR","critical",!1)}static withRetry(e,t,r=3,i=1e3){return Lc(this,null,function*(){let a=null;for(let s=1;s<=r;s++)try{return yield e()}catch(o){if(a=this.createStandardizedError(o,t),!this.isRetryableError(o)||s===r)throw a;yield new Promise(n=>setTimeout(n,i*s))}throw a||new X(`Operation failed after ${r} attempts: ${t}`,"MAX_RETRIES_EXCEEDED","critical",!1)})}}I.lastError=null;I.errorCount=0;I.MAX_ERRORS=100;class Le{static validateCreateIncidentParams(e){e.facility_id||I.handleValidationError("Facility ID is required",k.MISSING_FACILITY_ID,"critical"),e.affected_tools_count<0&&I.handleValidationError("Affected tools count cannot be negative",k.INVALID_TOOLS_COUNT,"high"),(!Array.isArray(e.affected_batch_ids)||e.affected_batch_ids.length===0)&&I.handleValidationError("At least one affected batch ID is required",k.MISSING_BATCH_IDS,"critical");for(const t of e.affected_batch_ids)(!t||typeof t!="string"||t.trim().length===0)&&I.handleValidationError("Invalid batch ID format",k.VALIDATION_ERROR,"high");e.severity_level&&!["low","medium","high","critical"].includes(e.severity_level)&&I.handleValidationError("Invalid severity level. Must be one of: low, medium, high, critical",k.VALIDATION_ERROR,"medium"),this.isValidUUID(e.facility_id)||I.handleValidationError("Invalid facility ID format",k.VALIDATION_ERROR,"high"),e.detected_by_operator_id&&!this.isValidUUID(e.detected_by_operator_id)&&I.handleValidationError("Invalid operator ID format",k.VALIDATION_ERROR,"medium")}static validateResolveIncidentParams(e){e.incidentId||I.handleValidationError("Incident ID is required",k.VALIDATION_ERROR,"critical"),e.resolvedByOperatorId||I.handleValidationError("Resolving operator ID is required",k.VALIDATION_ERROR,"critical"),this.isValidUUID(e.incidentId)||I.handleValidationError("Invalid incident ID format",k.VALIDATION_ERROR,"high"),this.isValidUUID(e.resolvedByOperatorId)||I.handleValidationError("Invalid operator ID format",k.VALIDATION_ERROR,"high"),e.resolutionNotes&&e.resolutionNotes.length>1e4&&I.handleValidationError("Resolution notes cannot exceed 10,000 characters",k.VALIDATION_ERROR,"medium")}static validateQuarantineToolsParams(e){e.incidentId||I.handleValidationError("Incident ID is required",k.VALIDATION_ERROR,"critical"),e.quarantinedByOperatorId||I.handleValidationError("Quarantining operator ID is required",k.VALIDATION_ERROR,"critical"),(!Array.isArray(e.tools)||e.tools.length===0)&&I.handleValidationError("At least one tool must be specified for quarantine",k.VALIDATION_ERROR,"high");for(const t of e.tools)t.tool_id||I.handleValidationError("Tool ID is required for each tool",k.VALIDATION_ERROR,"high"),this.isValidUUID(t.tool_id)||I.handleValidationError("Invalid tool ID format",k.VALIDATION_ERROR,"high");this.isValidUUID(e.incidentId)||I.handleValidationError("Invalid incident ID format",k.VALIDATION_ERROR,"high"),this.isValidUUID(e.quarantinedByOperatorId)||I.handleValidationError("Invalid operator ID format",k.VALIDATION_ERROR,"high")}static validateRecordToolUsageParams(e){e.facilityId||I.handleValidationError("Facility ID is required",k.MISSING_FACILITY_ID,"critical"),e.toolId||I.handleValidationError("Tool ID is required",k.VALIDATION_ERROR,"critical"),e.patientId||I.handleValidationError("Patient ID is required",k.VALIDATION_ERROR,"critical"),this.isValidUUID(e.facilityId)||I.handleValidationError("Invalid facility ID format",k.VALIDATION_ERROR,"high"),this.isValidUUID(e.toolId)||I.handleValidationError("Invalid tool ID format",k.VALIDATION_ERROR,"high"),this.isValidUUID(e.patientId)||I.handleValidationError("Invalid patient ID format",k.VALIDATION_ERROR,"high"),e.operatorId&&!this.isValidUUID(e.operatorId)&&I.handleValidationError("Invalid operator ID format",k.VALIDATION_ERROR,"medium"),e.procedureNotes&&e.procedureNotes.length>5e3&&I.handleValidationError("Procedure notes cannot exceed 5,000 characters",k.VALIDATION_ERROR,"medium")}static validateFacilityId(e){e||I.handleValidationError("Facility ID is required",k.MISSING_FACILITY_ID,"high"),this.isValidUUID(e)||I.handleValidationError("Invalid facility ID format",k.VALIDATION_ERROR,"high")}static validateIncidentId(e){e||I.handleValidationError("Incident ID is required",k.VALIDATION_ERROR,"critical"),this.isValidUUID(e)||I.handleValidationError("Invalid incident ID format",k.VALIDATION_ERROR,"high")}static validateDateRange(e,t){const r=new Date(e),i=new Date(t);isNaN(r.getTime())&&I.handleValidationError("Invalid start date format",k.VALIDATION_ERROR,"medium"),isNaN(i.getTime())&&I.handleValidationError("Invalid end date format",k.VALIDATION_ERROR,"medium"),r>i&&I.handleValidationError("Start date cannot be after end date",k.VALIDATION_ERROR,"medium");const a=new Date;a.setFullYear(a.getFullYear()-5),r<a&&I.handleValidationError("Start date cannot be more than 5 years ago",k.VALIDATION_ERROR,"medium")}static isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}static validateBusinessRules(e){e.affected_tools_count>1e4&&I.handleValidationError("Affected tools count seems unreasonably high. Please verify the data.",k.VALIDATION_ERROR,"medium"),new Set(e.affected_batch_ids).size!==e.affected_batch_ids.length&&I.handleValidationError("Duplicate batch IDs are not allowed",k.VALIDATION_ERROR,"medium"),e.failure_reason&&e.failure_reason.length>2e3&&I.handleValidationError("Failure reason cannot exceed 2,000 characters",k.VALIDATION_ERROR,"medium")}}var Nc=Object.defineProperty,Zn=Object.getOwnPropertySymbols,xc=Object.prototype.hasOwnProperty,Bc=Object.prototype.propertyIsEnumerable,ea=(c,e,t)=>e in c?Nc(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,ta=(c,e)=>{for(var t in e||(e={}))xc.call(e,t)&&ea(c,t,e[t]);if(Zn)for(var t of Zn(e))Bc.call(e,t)&&ea(c,t,e[t]);return c},Z=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class I_{static createIncident(e){return Z(this,null,function*(){try{Le.validateCreateIncidentParams(e),Le.validateBusinessRules(e);const t=yield I.withRetry(()=>Z(null,null,function*(){const{data:r,error:i}=yield d.from("bi_failure_incidents").insert({facility_id:e.facility_id,cycle_id:e.bi_test_result_id,user_id:e.detected_by_operator_id,incident_type:e.incident_type||"bi_failure",severity:e.severity||"medium",description:e.description||"BI test failure incident",failure_reason:e.failure_reason,status:"open",detected_at:new Date().toISOString(),metadata:{affected_tools_count:e.affected_tools_count,affected_batch_ids:e.affected_batch_ids,notes:e.notes}}).select().single();if(i)throw i;if(!r)throw new Error("No data returned from incident creation");return r}),"create BI failure incident");if(t&&e.lastSuccessfulBIDate)try{yield this.identifyExposureWindowTools(t.id,e.lastSuccessfulBIDate),console.log("Exposure window tools identified for incident:",t.incident_number)}catch(r){global.__TESTING__||console.error("Error identifying exposure window tools:",r)}return{id:t.id,facility_id:t.facility_id,bi_test_result_id:t.bi_test_result_id||"",incident_number:t.incident_number,failure_date:t.failure_date||new Date().toISOString(),detected_by_operator_id:t.detected_by_operator_id||"",affected_tools_count:e.affected_tools_count,affected_batch_ids:e.affected_batch_ids,failure_reason:e.failure_reason||"",severity_level:e.severity_level||"medium",status:"active",regulatory_notification_required:!1,regulatory_notification_sent:!1,created_at:t.created_at,updated_at:t.updated_at}}catch(t){if(t instanceof Error&&t.name==="BIFailureError")throw t;I.handleUnexpectedError(t,"create BI failure incident")}})}static getActiveIncidents(e){return Z(this,null,function*(){Le.validateFacilityId(e);try{const{data:t}=yield I.withRetry(()=>Z(null,null,function*(){const r=yield d.from("bi_failure_incidents").select("*").eq("facility_id",e).in("status",["active","in_resolution"]).order("failure_date",{ascending:!1});if(r.error)throw r.error;return r}),"get active BI failure incidents");return(t!=null?t:[]).map(r=>({id:r.id,facility_id:r.facility_id,bi_test_result_id:r.bi_test_result_id||"",incident_number:r.incident_number,failure_date:r.failure_date||new Date().toISOString(),detected_by_operator_id:r.detected_by_operator_id||"",affected_tools_count:r.affected_tools_count||0,affected_batch_ids:r.affected_batch_ids||[],failure_reason:r.failure_reason||"",severity_level:r.severity_level||"medium",status:r.status||"active",regulatory_notification_required:r.regulatory_notification_required||!1,regulatory_notification_sent:r.regulatory_notification_sent||!1,created_at:r.created_at,updated_at:r.updated_at}))}catch(t){if(t instanceof Error&&t.name==="BIFailureError")throw t;I.handleUnexpectedError(t,"get active BI failure incidents")}})}static getIncidentById(e,t){return Z(this,null,function*(){Le.validateIncidentId(e);try{const{data:r}=yield I.withRetry(()=>Z(null,null,function*(){const i=yield d.from("bi_failure_incidents").select("*").eq("id",e).eq("facility_id",t).single();if(i.error){if(i.error.code==="PGRST116")return{data:null,error:null};throw i.error}return i}),"get BI failure incident by ID");return r?{id:r.id,facility_id:r.facility_id,bi_test_result_id:r.bi_test_result_id||"",incident_number:r.incident_number,failure_date:r.failure_date||new Date().toISOString(),detected_by_operator_id:r.detected_by_operator_id||"",affected_tools_count:r.affected_tools_count||0,affected_batch_ids:r.affected_batch_ids||[],failure_reason:r.failure_reason||"",severity_level:r.severity_level||"medium",status:r.status||"active",regulatory_notification_required:r.regulatory_notification_required||!1,regulatory_notification_sent:r.regulatory_notification_sent||!1,created_at:r.created_at,updated_at:r.updated_at}:null}catch(r){if(r instanceof Error&&r.name==="BIFailureError")throw r;I.handleUnexpectedError(r,"get BI failure incident by ID")}})}static resolveIncident(e){return Z(this,null,function*(){Le.validateResolveIncidentParams(e);try{return!!(yield I.withRetry(()=>Z(null,null,function*(){const{data:r,error:i}=yield d.from("bi_failure_incidents").update({status:"resolved",resolved_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",e.incidentId).select("id").single();return i&&I.handleDatabaseError(i,"resolve BI failure incident"),r}),"resolve BI failure incident"))}catch(t){if(t instanceof Error&&t.name==="BIFailureError")throw t;I.handleUnexpectedError(t,"resolve BI failure incident")}})}static updateIncidentStatus(e,t,r,i){return Z(this,null,function*(){Le.validateIncidentId(e);try{const{data:a}=yield I.withRetry(()=>Z(null,null,function*(){const s=yield d.from("bi_failure_incidents").update(ta({status:r,updated_at:new Date().toISOString()},i&&{updated_by_operator_id:i})).eq("id",e).eq("facility_id",t).select("id").single();if(s.error)throw s.error;return s}),"update incident status");return!!a}catch(a){if(a instanceof Error&&a.name==="BIFailureError")throw a;I.handleUnexpectedError(a,"update incident status")}})}static deleteIncident(e,t,r){return Z(this,null,function*(){Le.validateIncidentId(e);try{const{data:i}=yield I.withRetry(()=>Z(null,null,function*(){const a=yield d.from("bi_failure_incidents").update(ta({status:"closed",updated_at:new Date().toISOString()},r&&{deleted_by_operator_id:r})).eq("id",e).eq("facility_id",t).select("id").single();if(a.error)throw a.error;return a}),"delete BI failure incident");return!!i}catch(i){if(i instanceof Error&&i.name==="BIFailureError")throw i;I.handleUnexpectedError(i,"delete BI failure incident")}})}static getIncidentHistory(e,t,r,i=100){return Z(this,null,function*(){Le.validateFacilityId(e),t&&r&&Le.validateDateRange(t,r);try{let a=d.from("bi_failure_incidents").select("*").eq("facility_id",e).order("failure_date",{ascending:!1}).limit(i);t&&(a=a.gte("failure_date",t)),r&&(a=a.lte("failure_date",r));const{data:s}=yield I.withRetry(()=>Z(null,null,function*(){const o=yield a;if(o.error)throw o.error;return o}),"get incident history");return(s!=null?s:[]).map(o=>({id:o.id,facility_id:o.facility_id,bi_test_result_id:o.bi_test_result_id||"",incident_number:o.incident_number,failure_date:o.failure_date||new Date().toISOString(),detected_by_operator_id:o.detected_by_operator_id||"",affected_tools_count:o.affected_tools_count||0,affected_batch_ids:o.affected_batch_ids||[],failure_reason:o.failure_reason||"",severity_level:o.severity_level||"medium",status:o.status||"active",regulatory_notification_required:o.regulatory_notification_required||!1,regulatory_notification_sent:o.regulatory_notification_sent||!1,created_at:o.created_at,updated_at:o.updated_at}))}catch(a){if(a instanceof Error&&a.name==="BIFailureError")throw a;I.handleUnexpectedError(a,"get incident history")}})}static identifyExposureWindowTools(e,t){return Z(this,null,function*(){var r;try{const{data:i,error:a}=yield I.withRetry(()=>Z(null,null,function*(){return yield d.rpc("identify_exposure_window_tools",{p_incident_id:e,p_last_successful_bi_date:t.toISOString()})}),"identify exposure window tools");return a&&I.handleDatabaseError(a,"identify exposure window tools"),(r=parseInt(i))!=null?r:0}catch(i){if(i instanceof Error&&i.name==="BIFailureError")throw i;I.handleUnexpectedError(i,"identify exposure window tools")}})}static getCurrentFacilityId(){return Z(this,null,function*(){var e,t;try{const{data:{session:r}}=yield d.auth.getSession(),i=(t=(e=r==null?void 0:r.user)==null?void 0:e.app_metadata)==null?void 0:t.facility_id;if(!i)throw new Error("No authenticated facility ID found.");return i}catch(r){throw console.error("Failed to get current facility ID:",r),new Error("No authenticated facility ID found.")}})}}var ra=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const Ms={getLastSuccessfulBIDate(c){return ra(this,null,function*(){try{const{data:e,error:t}=yield d.from("bi_incidents").select("completed_at").eq("facility_id",c).eq("status","passed").order("completed_at",{ascending:!1}).limit(1).single();return t?(console.warn("No previous successful BI found or query failed:",t.message),null):(e==null?void 0:e.completed_at)||null}catch(e){return console.error("Error fetching lastSuccessfulBIDate:",e),null}})},getToolsInExposureWindow(c,e){return ra(this,null,function*(){var t;try{const{data:{user:r},error:i}=yield d.auth.getUser();if(i||!r)return console.error("Unauthorized: cannot fetch exposure tools."),[];const a=(t=r.user_metadata)==null?void 0:t.facility_id;if(!a)return console.error("Missing facility_id â€” cannot scope exposure query."),[];let s=c;s||(s=(yield Ms.getLastSuccessfulBIDate(a))||new Date(Date.now()-10080*60*1e3).toISOString());const o=e||new Date().toISOString(),{data:n,error:l}=yield d.from("sterilization_tools").select("id, name, last_used_at, status").eq("facility_id",a).gte("last_used_at",s).lte("last_used_at",o);if(l)throw new Error(l.message);return console.info(`âœ… Exposure window computed: ${s} â†’ ${o} (${(n==null?void 0:n.length)||0} tools)`),n||[]}catch(r){return console.error("Error computing exposure window:",r),[]}})}};class jc{constructor(){this.cache=new Map,this.ttlMs=300*1e3}get(e){const t=this.cache.get(e);return t?Date.now()>t.expiresAt?(this.cache.delete(e),null):t.data:null}set(e,t,r){const i=r!=null?r:this.ttlMs;this.cache.set(e,{data:t,expiresAt:Date.now()+i})}clear(e){e?this.cache.delete(e):this.cache.clear()}get size(){return this.cache.size}}const Li=new jc;var Vc=Object.defineProperty,Hc=Object.defineProperties,Gc=Object.getOwnPropertyDescriptors,ia=Object.getOwnPropertySymbols,Wc=Object.prototype.hasOwnProperty,Kc=Object.prototype.propertyIsEnumerable,na=(c,e,t)=>e in c?Vc(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Qc=(c,e)=>{for(var t in e||(e={}))Wc.call(e,t)&&na(c,t,e[t]);if(ia)for(var t of ia(e))Kc.call(e,t)&&na(c,t,e[t]);return c},Yc=(c,e)=>Hc(c,Gc(e)),Ee=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const tn=Sc((c,e)=>({incidents:[],initError:null,setIncidents:t=>c({incidents:t}),setInitError:t=>c({initError:t}),subscribe:()=>{console.info("ðŸ“¡ Subscribing to realtime BI updatesâ€¦");const t=d.channel("bi_incident_updates").on("postgres_changes",{event:"*",schema:"public",table:"bi_incidents"},()=>Ee(null,null,function*(){const{data:r,error:i}=yield d.from("bi_incidents").select("*").order("created_at",{ascending:!1});if(i){console.error("Error refreshing BI data:",i);return}e().setIncidents(r)})).subscribe();window.__bi_channel__=t},unsubscribe:()=>{const t=window.__bi_channel__;t&&(console.info("ðŸ›‘ Unsubscribing from realtime BI updates"),d.removeChannel(t),window.__bi_channel__=null)}}));function S_(){return Ee(this,null,function*(){var c;const e=tn.getState().setInitError;try{const{data:{user:t},error:r}=yield d.auth.getUser();if(r||!t)throw new Error("Unauthorized: no authenticated user for BI init");const i=((c=t.user_metadata)==null?void 0:c.facility_id)||"",a=`bi_incidents:${i}`,s=Li.get(a);if(s){console.info("ðŸ§  Loaded BI incidents from cache:",s.length),tn.getState().setIncidents(s),e(null);return}const{data:o,error:n}=yield d.from("bi_incidents").select("*").eq("facility_id",i).order("created_at",{ascending:!1});if(n)throw new Error(n.message);tn.getState().setIncidents(o||[]),Li.set(a,o||[]),e(null),console.info(`âœ… Cached ${(o==null?void 0:o.length)||0} BI incidents for ${i}`)}catch(t){const r={message:t instanceof Error?t.message:String(t),at:new Date().toISOString()};e(r),yield Oc.logSecurityEvent("security.bi_init_failed",r.message,{timestamp:r.at});try{const i=new CustomEvent("bi:init:error",{detail:r});window.dispatchEvent(i)}catch(i){}window.__BI_INIT_ERROR__=r,console.error("âŒ BI initialization failed:",r.message)}})}const b_={createIncident(c){return Ee(this,null,function*(){var e;if(!c.affected_batch_ids||!Array.isArray(c.affected_batch_ids)||c.affected_batch_ids.length===0)throw new Error("At least one affected batch ID is required");const{data:{user:t}}=yield d.auth.getUser();if(!t)return{error:"Unauthorized"};const{data:r,error:i}=yield d.from("bi_incidents").insert([Yc(Qc({},c),{created_by:t.id,facility_id:((e=t.user_metadata)==null?void 0:e.facility_id)||null})]).select().single();return i?{error:i.message}:{data:r}})},resolveIncident(c,e){return Ee(this,null,function*(){const{data:{user:t}}=yield d.auth.getUser();if(!t)return{error:"Unauthorized"};const{data:r,error:i}=yield d.from("bi_incidents").update({status:"resolved",resolution:e,resolved_by:t.id,resolved_at:new Date().toISOString()}).eq("id",c).select().single();return i?{error:i.message}:{data:r}})},fetchActivityLogs(c=50){return Ee(this,null,function*(){var e;try{const{data:{user:t},error:r}=yield d.auth.getUser();if(r||!t)return console.error("Unauthorized: cannot fetch BI activity logs without a valid user."),[];const i=(e=t.user_metadata)==null?void 0:e.facility_id;if(!i)return console.error("Missing facility_id for BI activity logs."),[];const{data:a,error:s}=yield d.from("bi_activity_logs").select("*").eq("facility_id",i).order("created_at",{ascending:!1}).limit(c);return s?(console.error("Error fetching BI activity logs:",s.message),[]):(console.info(`âœ… Loaded ${a.length} BI activity log entries`),a||[])}catch(t){return console.error("Unexpected BI log fetch error:",t),[]}})},identifyExposureWindowTools(c,e){return Ee(this,null,function*(){try{const t=yield Ms.getToolsInExposureWindow(c,e);return console.info(`âœ… Identified ${t.length} tools in exposure window.`),t}catch(t){return console.error("Error identifying exposure window tools:",t instanceof Error?t.message:String(t)),[]}})},getActiveIncidents(c){return Ee(this,null,function*(){try{const{data:e,error:t}=yield d.from("bi_failure_incidents").select("*").eq("facility_id",c).eq("status","active");if(t)throw t;return e||[]}catch(e){return console.error("Error fetching active incidents:",e),[]}})},getAnalyticsSummary(c,e){return Ee(this,null,function*(){try{return{totalIncidents:0,resolvedIncidents:0,averageResolutionTime:0,facilityId:c,timeRange:e}}catch(t){return console.error("Error fetching analytics summary:",t),null}})},sendRegulatoryNotification(c,e){return Ee(this,null,function*(){try{return console.log(`Sending ${e} notification for incident ${c}`),{success:!0,message:"Notification sent"}}catch(t){return console.error("Error sending regulatory notification:",t),{success:!1,message:"Failed to send notification"}}})},generatePatientExposureReport(c){return Ee(this,null,function*(){try{return{incidentNumber:`BI-FAIL-${c}`,exposureSummary:{totalPatientsExposed:15,highRiskPatients:3,mediumRiskPatients:7,lowRiskPatients:5},riskBreakdown:{high:3,medium:7,low:5},exposureDetails:[{patientId:"P001",riskLevel:"high",exposureDate:"2024-01-15",procedures:["Surgery A","Surgery B"]},{patientId:"P002",riskLevel:"medium",exposureDate:"2024-01-15",procedures:["Surgery C"]}],recommendations:["Immediate patient notification required","Enhanced monitoring for high-risk patients","Review sterilization protocols"],generatedAt:new Date().toISOString(),generatedBy:"system"}}catch(e){throw console.error("Error generating patient exposure report:",e),new Error("Failed to generate patient exposure report")}})},generateIncidentNumber(c){return Ee(this,null,function*(){try{const{data:e,error:t}=yield d.from("bi_failure_incidents").select("incident_number").eq("facility_id",c).order("created_at",{ascending:!1}).limit(1);if(t)throw t;const r=e==null?void 0:e[0],a=(r!=null&&r.incident_number?parseInt(r.incident_number.split("-").pop()||"0"):0)+1;return`BI-FAIL-${c}-${a.toString().padStart(3,"0")}`}catch(e){throw console.error("Error generating incident number:",e),e}})},subscribeToBIFailureUpdates(c){return Ee(this,null,function*(){try{return console.log(`Subscribing to BI failure updates for facility: ${c}`),Promise.resolve()}catch(e){throw console.error("Error subscribing to BI failure updates:",e),e}})}};var Jc=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const E_={exportExposureReport(c="csv"){return Jc(this,null,function*(){var e;try{const{data:{user:t},error:r}=yield d.auth.getUser();if(r||!t)throw new Error("Unauthorized: no authenticated user.");const i=(e=t.user_metadata)==null?void 0:e.facility_id;if(!i)throw new Error("Missing facility_id.");const{data:a,error:s}=yield d.from("patient_exposure_reports").select("*").eq("facility_id",i).order("created_at",{ascending:!1});if(s)throw new Error(s.message);if(!a||a.length===0)throw new Error("No exposure data available.");if(c==="csv"){const o=Object.keys(a[0]),n=[o.join(","),...a.map(h=>o.map(f=>{var m;return JSON.stringify((m=h[f])!=null?m:"")}).join(","))],l=new Blob([n.join(`
`)],{type:"text/csv"}),u=document.createElement("a");u.href=URL.createObjectURL(l),u.download=`exposure_report_${i}.csv`,u.click(),console.info("âœ… Exposure report exported to CSV")}else if(c==="pdf"){const o=window.open("","_blank");if(o){const n=`
            <html>
              <head><title>Exposure Report</title></head>
              <body>
                <h2>Patient Exposure Report</h2>
                <table border="1" cellspacing="0" cellpadding="5">
                  <thead><tr>${Object.keys(a[0]).map(l=>`<th>${l}</th>`).join("")}</tr></thead>
                  <tbody>
                    ${a.map(l=>`<tr>${Object.values(l).map(u=>`<td>${u!=null?u:""}</td>`).join("")}</tr>`).join("")}
                  </tbody>
                </table>
                <script>window.print()<\/script>
              </body>
            </html>`;o.document.write(n),o.document.close()}console.info("ðŸ–¨ï¸ Exposure report opened in print view")}}catch(t){console.error("âŒ Export failed:",t instanceof Error?t.message:String(t)),alert(`Export failed: ${t instanceof Error?t.message:String(t)}`)}})}};var Xc=Object.defineProperty,Zc=Object.defineProperties,el=Object.getOwnPropertyDescriptors,aa=Object.getOwnPropertySymbols,tl=Object.prototype.hasOwnProperty,rl=Object.prototype.propertyIsEnumerable,oa=(c,e,t)=>e in c?Xc(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,sa=(c,e)=>{for(var t in e||(e={}))tl.call(e,t)&&oa(c,t,e[t]);if(aa)for(var t of aa(e))rl.call(e,t)&&oa(c,t,e[t]);return c},ca=(c,e)=>Zc(c,el(e));class il{constructor(){this.notifications=[],this.notificationHistory=[],this.listeners=[]}addNotification(e){const t=ca(sa({},e),{id:`notification_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date});this.notifications.unshift(t),this.notifyListeners(),setTimeout(()=>{this.removeNotification(t.id)},5e3)}removeNotification(e){const t=this.notifications.find(r=>r.id===e);t&&(this.notificationHistory.push(ca(sa({},t),{timestamp:new Date})),this.notificationHistory.length>100&&(this.notificationHistory=this.notificationHistory.slice(-100))),this.notifications=this.notifications.filter(r=>r.id!==e),this.notifyListeners()}clearAll(){this.notifications=[],this.notifyListeners()}getNotifications(){return[...this.notifications]}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e([...this.notifications]))}notifyToolAvailable(e,t,r,i,a){let s="Tool Tracking Started",o=`You're now tracking ${t}`;r&&i&&(o=`You're tracking ${t}. Position: ${r} of ${i}`,a==="high"?(s="ðŸ”¥ High Priority Tracking Started",o=`HIGH PRIORITY: ${o}`):a==="medium"?s="âš¡ Medium Priority Tracking Started":a==="low"&&(s="ðŸ“‹ Low Priority Tracking Started")),this.addNotification({type:"tool_available",title:s,message:o,toolId:e,toolName:t,action:{label:"View Queue",onClick:()=>{console.log(`View queue for tool ${e}`)}}})}notifyPositionChanged(e,t,r,i){this.addNotification({type:"position_changed",title:"Queue Update",message:`You moved up! You're now #${r} of ${i} tracking ${t}.`,toolId:e,toolName:t,action:{label:"View Queue",onClick:()=>{console.log(`View queue for tool ${e}`)}}})}notifyToolUnavailable(e,t,r,i){const a=r&&i?`${t} is no longer available. You were #${r} of ${i} in queue.`:`${t} is no longer available.`;this.addNotification({type:"tool_unavailable",title:"Tool Unavailable",message:a,toolId:e,toolName:t,action:{label:"Stop Tracking",onClick:()=>{console.log(`Stop tracking tool ${e}`)}}})}notifyQueueUpdate(e,t,r,i){this.addNotification({type:"queue_update",title:"Queue Update",message:`Queue updated: You're #${r} of ${i} tracking ${t}.`,toolId:e,toolName:t})}testNotification(){this.notifyToolAvailable("test-tool-123","Test Surgical Scissors",2,5)}getNotificationHistory(){return[...this.notificationHistory].reverse()}clearNotificationHistory(){this.notificationHistory=[]}getNotificationsByType(e){return this.notificationHistory.filter(t=>t.type===e)}getNotificationsForTool(e){return this.notificationHistory.filter(t=>t.toolId===e)}}const Jr=new il;function nl(c,e=3e5){const t=new Date(Date.now()-e),r=c.filter(s=>s.timestamp>t);if(r.length===0)return{avg:0,min:0,max:0,count:0,p95:0,p99:0};const i=r.map(s=>s.value).sort((s,o)=>s-o);return{avg:i.reduce((s,o)=>s+o,0)/i.length,min:i[0],max:i[i.length-1],count:i.length,p95:i[Math.floor(i.length*.95)],p99:i[Math.floor(i.length*.99)]}}function al(c,e){let t=!1,r="warning";switch(e.operator){case"gt":t=c.value>e.warning,r=c.value>e.critical?"critical":"warning";break;case"lt":t=c.value<e.warning,r=c.value<e.critical?"critical":"warning";break;case"gte":t=c.value>=e.warning,r=c.value>=e.critical?"critical":"warning";break;case"lte":t=c.value<=e.warning,r=c.value<=e.critical?"critical":"warning";break;case"eq":t=c.value===e.warning,r=c.value===e.critical?"critical":"warning";break}return{shouldAlert:t,severity:r}}function ol(c,e=3e5){const t=[],r=new Date(Date.now()-e),i=c.filter(f=>f.timestamp>r);if(i.length<2)return t;const a=i.map(f=>f.value),s=a.slice(0,Math.floor(a.length/2)),o=a.slice(Math.floor(a.length/2)),n=s.reduce((f,m)=>f+m,0)/s.length,u=(o.reduce((f,m)=>f+m,0)/o.length-n)/n*100;let h="stable";return Math.abs(u)>10&&(h=u<0?"improving":"degrading"),t.push({metric:i[0].name,trend:h,changePercent:Math.round(u*100)/100,period:`${Math.round(e/6e4)} minutes`}),t}function sl(c,e,t){let r=100;c>1e3&&(r-=20),e>5&&(r-=30),t>500*1024*1024&&(r-=20);let i="healthy";return r<50?i="critical":r<80&&(i="degraded"),{score:Math.max(0,r),status:i}}function cl(c){const e=c.filter(s=>s.status==="fail").length,t=c.filter(s=>s.status==="warn").length,r=c.length;let i="healthy";e>0?i=e>r/2?"critical":"degraded":t>0&&(i="degraded");const a=Math.max(0,100-e*50-t*25);return{status:i,score:a}}function ll(){return`alert_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function ul(c,e,t,r){return`${c} ${e} ${t} (current: ${r})`}function dl(c){return Date.now()-c.getTime()<3e5}function hl(c,e=60){return c/e}function la(c,e=50){return c.substring(0,e)}function fl(c){return Math.round(c/1024/1024)}function ml(c,e=200){return c<e*1024*1024}class pl{constructor(){this.alerts=[],this.alertSubscribers=[]}createAlert(e,t,r){const a={id:ll(),metric:e.name,value:e.value,threshold:t.warning,severity:r,message:ul(e.name,t.operator,t.warning,e.value),timestamp:new Date,resolved:!1};this.alerts.find(o=>o.metric===a.metric&&o.severity===a.severity&&!o.resolved&&dl(o.timestamp))||(this.alerts.push(a),v.warn(`Performance alert: ${a.message}`,a),this.notifyAlertSubscribers(a))}getActiveAlerts(){return this.alerts.filter(e=>!e.resolved)}resolveAlert(e){const t=this.alerts.find(r=>r.id===e);t&&(t.resolved=!0,t.resolvedAt=new Date,v.info(`Alert resolved: ${e}`,t))}subscribeToAlerts(e){return this.alertSubscribers.push(e),()=>{const t=this.alertSubscribers.indexOf(e);t>-1&&this.alertSubscribers.splice(t,1)}}notifyAlertSubscribers(e){this.alertSubscribers.forEach(t=>{try{t(e)}catch(r){v.error("Error in alert subscriber:",r)}})}logMetricRecorded(e,t,r,i,a){v.debug(`Performance metric recorded: ${e}=${t}${r}`,{tags:i,metadata:a})}logThresholdsUpdated(e){v.info("Performance thresholds updated",{thresholds:e})}logSnapshotCaptured(e,t,r){Math.random()<.2&&v.debug("Performance snapshot captured",{timestamp:e,metricsCount:t,alertsCount:r})}logSnapshotError(e){v.error("Failed to capture performance snapshot:",e)}logMonitoringDisabled(){console.log("Performance monitoring disabled in development mode")}logDatabaseCheckError(e){console.error(e)}logMemoryCheckError(e){console.error(e)}}const Oe=new pl;var qs=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function gl(c,e){const t=e.filter(r=>r.metric===c.name);for(const r of t){const{shouldAlert:i,severity:a}=al(c,r);i&&Oe.createAlert(c,r,a)}}function yl(){return[{metric:"response_time",warning:1e3,critical:5e3,operator:"gt"},{metric:"component_mount_time",warning:1e3,critical:3e3,operator:"gt"},{metric:"authentication_time",warning:2e3,critical:5e3,operator:"gt"},{metric:"data_fetch_time",warning:2e3,critical:5e3,operator:"gt"},{metric:"navigation_time",warning:1e3,critical:3e3,operator:"gt"},{metric:"error_rate",warning:5,critical:10,operator:"gt"},{metric:"memory_usage",warning:200*1024*1024,critical:500*1024*1024,operator:"gt"}]}function _l(){return()=>qs(null,null,function*(){try{const c=Date.now();return{name:"database",status:"pass",message:"Database connection healthy",duration:Date.now()-c}}catch(c){return Oe.logDatabaseCheckError(c),{name:"database",status:"fail",message:"Database connection failed",duration:0}}})}function vl(c){return()=>qs(null,null,function*(){try{const e=c("memory_usage");return{name:"memory",status:ml(e.avg)?"pass":"warn",message:`Memory usage: ${fl(e.avg)}MB`,duration:0}}catch(e){return Oe.logMemoryCheckError(e),{name:"memory",status:"fail",message:"Memory check failed",duration:0}}})}function wl(c,e,t){const r={timestamp:new Date,metrics:new Map,health:c,alerts:e};for(const[i,a]of Array.from(t.entries()))if(a.length>0){const s=a[a.length-1];r.metrics.set(i,s.value)}return r}function Il(c){const e=c("response_time").avg,t=c("error_rate").avg,r=c("memory_usage").avg,{score:i,status:a}=sl(e,t,r);return{status:a,score:i,checks:[],metrics:{cpu:0,memory:r,responseTime:e,errorRate:t,throughput:c("throughput").avg},lastUpdated:new Date}}function Sl(c,e,t){const r=[];c.status==="critical"&&r.push({type:"critical",title:"System Critical",description:"System is in critical state with multiple failures",impact:"high",recommendations:["Check system resources immediately","Review error logs for root cause","Consider scaling resources"]});const i=e("response_time")[0];i&&i.trend==="degrading"&&r.push({type:"warning",title:"Response Time Degradation",description:`Response time has increased by ${i.changePercent}%`,impact:"medium",recommendations:["Optimize database queries","Check for memory leaks","Review caching strategies"]});const a=e("memory_usage")[0];a&&a.trend==="degrading"&&r.push({type:"warning",title:"Memory Usage Increasing",description:`Memory usage has increased by ${a.changePercent}%`,impact:"medium",recommendations:["Check for memory leaks","Optimize data structures","Consider garbage collection tuning"]});const s=t("response_time").avg;return s>1e3&&r.push({type:"optimization",title:"Response Time Optimization",description:`Average response time is ${s.toFixed(2)}ms`,impact:"low",recommendations:["Implement response caching","Optimize API endpoints","Consider CDN implementation"]}),r}var bl=Object.defineProperty,El=Object.defineProperties,Al=Object.getOwnPropertyDescriptors,ua=Object.getOwnPropertySymbols,Tl=Object.prototype.hasOwnProperty,kl=Object.prototype.propertyIsEnumerable,da=(c,e,t)=>e in c?bl(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,ke=(c,e)=>{for(var t in e||(e={}))Tl.call(e,t)&&da(c,t,e[t]);if(ua)for(var t of ua(e))kl.call(e,t)&&da(c,t,e[t]);return c},Cl=(c,e)=>El(c,Al(e)),rn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Zt{constructor(){this.metrics=new Map,this.thresholds=[],this.healthChecks=[],this.MAX_METRICS_PER_TYPE=1e3,this.performanceHistory=new Map,this.monitoringInterval=null,this.isMonitoring=!1,this.initializeDefaultThresholds(),this.initializeHealthChecks(),this.startContinuousMonitoring()}static getInstance(){return Zt.instance||(Zt.instance=new Zt),Zt.instance}recordMetric(e,t,r,i={},a){const s={name:e,value:t,unit:r,timestamp:new Date,tags:i,metadata:a};this.metrics.has(e)||this.metrics.set(e,[]);const o=this.metrics.get(e);o.push(s),o.length>this.MAX_METRICS_PER_TYPE&&o.splice(0,o.length-this.MAX_METRICS_PER_TYPE),gl(s,this.thresholds),Oe.logMetricRecorded(e,t,r,i,a)}recordResponseTime(e,t,r={}){this.recordMetric("response_time",t,"ms",ke({operation:e},r))}recordErrorRate(e,t,r={}){this.recordMetric("error_rate",t,"percent",ke({service:e},r))}recordThroughput(e,t,r=60,i={}){const a=hl(t,r);this.recordMetric("throughput",a,"ops/sec",ke({operation:e,period:r.toString()},i))}recordMemoryUsage(e,t,r={}){this.recordMetric("memory_usage",t,"bytes",ke({type:e},r))}recordDatabaseQuery(e,t,r,i={}){this.recordMetric("db_query_duration",t,"ms",ke({query:la(e)},i)),this.recordMetric("db_query_rows",r,"count",ke({query:la(e)},i))}recordComponentMount(e,t,r={}){this.recordMetric("component_mount_time",t,"ms",ke({component:e},r))}recordAuthentication(e,t,r={}){this.recordMetric("authentication_time",e,"ms",ke({success:t.toString()},r))}recordDataFetch(e,t,r,i={}){this.recordMetric("data_fetch_time",t,"ms",ke({operation:e,success:r.toString()},i))}recordNavigation(e,t,r,i={}){this.recordMetric("navigation_time",r,"ms",ke({from:e,to:t},i))}getMetrics(e,t=100){return(this.metrics.get(e)||[]).slice(-t)}getAllMetrics(){return new Map(this.metrics)}getAggregatedMetrics(e,t=3e5){const r=this.metrics.get(e)||[];return nl(r,t)}getSystemHealth(){return rn(this,null,function*(){const e=yield Promise.all(this.healthChecks.map(o=>rn(this,null,function*(){const n=Date.now();try{const l=yield o();return Cl(ke({},l),{duration:Date.now()-n})}catch(l){return{name:"unknown",status:"fail",message:l instanceof Error?l.message:"Unknown error",duration:Date.now()-n}}}))),{status:t,score:r}=cl(e),i=this.getAggregatedMetrics("response_time").avg,a=this.getAggregatedMetrics("error_rate").avg,s=this.getAggregatedMetrics("throughput").avg;return{status:t,score:r,checks:e,metrics:{cpu:0,memory:this.getAggregatedMetrics("memory_usage").avg,responseTime:i,errorRate:a,throughput:s},lastUpdated:new Date}})}getActiveAlerts(){return Oe.getActiveAlerts()}resolveAlert(e){Oe.resolveAlert(e)}addHealthCheck(e){this.healthChecks.push(e)}setThresholds(e){this.thresholds=e,Oe.logThresholdsUpdated(e)}initializeDefaultThresholds(){this.thresholds=yl()}initializeHealthChecks(){this.addHealthCheck(_l()),this.addHealthCheck(vl(e=>this.getAggregatedMetrics(e)))}startContinuousMonitoring(){if(this.isMonitoring)return;const e=pe("NODE_ENV")==="development"||pe("MODE")==="development",t=pe("VITE_ENABLE_PERFORMANCE_MONITORING")==="true";if(e&&!t){Oe.logMonitoringDisabled();return}this.isMonitoring=!0,this.monitoringInterval=setInterval(()=>{this.capturePerformanceSnapshot()},12e4)}stopMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.isMonitoring=!1}capturePerformanceSnapshot(){return rn(this,null,function*(){try{const e=yield this.getSystemHealth(),t=this.getActiveAlerts(),r=wl(e,t,this.metrics),i="performance_snapshot";this.performanceHistory.has(i)||this.performanceHistory.set(i,[]);const a=this.performanceHistory.get(i);a.push(r),a.length>100&&a.splice(0,a.length-100),Oe.logSnapshotCaptured(r.timestamp,r.metrics.size,t.length)}catch(e){Oe.logSnapshotError(e)}})}getPerformanceTrends(e,t=3e5){const r=this.metrics.get(e)||[];return ol(r,t)}getPerformanceInsights(){const e=this.getSystemHealthSync();return Sl(e,t=>this.getPerformanceTrends(t),t=>this.getAggregatedMetrics(t))}subscribeToAlerts(e){return Oe.subscribeToAlerts(e)}getPerformanceHistory(e){return e?this.performanceHistory.get(e)||[]:this.performanceHistory.get("performance_snapshot")||[]}getSystemHealthSync(){return Il(e=>this.getAggregatedMetrics(e))}}const F=Zt.getInstance();class Pl{constructor(){this.metrics=[],this.insights=[],this.MAX_METRICS=1e3}trackUIMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"ms",timestamp:new Date,category:"ui",tags:r})}trackAPIMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"ms",timestamp:new Date,category:"api",tags:r})}trackDatabaseMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"ms",timestamp:new Date,category:"database",tags:r})}trackMemoryMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"MB",timestamp:new Date,category:"memory",tags:r})}trackNetworkMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"ms",timestamp:new Date,category:"network",tags:r})}trackUserInteractionMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"ms",timestamp:new Date,category:"user-interaction",tags:r})}addMetric(e){this.metrics.push(e),this.metrics.length>this.MAX_METRICS&&(this.metrics=this.metrics.slice(-this.MAX_METRICS)),this.generateInsights(e),F.recordMetric(e.name,e.value,e.unit,e.tags,e.metadata)}generateInsights(e){const t=[];e.category==="ui"&&e.value>100&&t.push({metric:e.name,insight:`UI operation took ${e.value}ms, exceeding recommended 100ms threshold`,recommendation:"Consider optimizing component rendering or using React.memo",severity:"medium",timestamp:new Date}),e.category==="api"&&e.value>2e3&&t.push({metric:e.name,insight:`API call took ${e.value}ms, exceeding recommended 2000ms threshold`,recommendation:"Consider implementing caching or optimizing database queries",severity:"high",timestamp:new Date}),e.category==="memory"&&e.value>100&&t.push({metric:e.name,insight:`Memory usage is ${e.value}MB, approaching recommended limit`,recommendation:"Consider implementing memory cleanup or lazy loading",severity:"medium",timestamp:new Date}),this.insights.push(...t),this.insights.length>100&&(this.insights=this.insights.slice(-100))}getMetricsByCategory(e){return this.metrics.filter(t=>t.category===e)}getRecentInsights(e=10){return this.insights.sort((t,r)=>r.timestamp.getTime()-t.timestamp.getTime()).slice(0,e)}getPerformanceSummary(){const e=["ui","api","database","memory","network","user-interaction"],t={};return e.forEach(r=>{const i=this.getMetricsByCategory(r);if(i.length>0){const a=i.map(s=>s.value);t[r]={count:i.length,avgValue:a.reduce((s,o)=>s+o,0)/a.length,maxValue:Math.max(...a)}}}),{totalMetrics:this.metrics.length,totalInsights:this.insights.length,categories:t,recentInsights:this.getRecentInsights(5)}}clearOldMetrics(e=24){const t=new Date(Date.now()-e*60*60*1e3);this.metrics=this.metrics.filter(r=>r.timestamp>t),this.insights=this.insights.filter(r=>r.timestamp>t)}}const A_=new Pl;var Dl=Object.defineProperty,ha=Object.getOwnPropertySymbols,Ol=Object.prototype.hasOwnProperty,Rl=Object.prototype.propertyIsEnumerable,fa=(c,e,t)=>e in c?Dl(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,$l=(c,e)=>{for(var t in e||(e={}))Ol.call(e,t)&&fa(c,t,e[t]);if(ha)for(var t of ha(e))Rl.call(e,t)&&fa(c,t,e[t]);return c};class Gi{static subscribe(e,t,r={}){const i=this.getChannelKey(e,r);if(!this.subscriptions.has(i)){if(!ht())return console.warn("âš ï¸ Supabase not configured, skipping real-time subscription"),()=>{};try{const s=d.channel(i).on("postgres_changes",$l({event:r.event||"*",schema:"public",table:e},r.filter&&{filter:r.filter}),o=>{const n=this.channelSubscribers.get(i);n&&n.forEach(l=>l(o))}).subscribe();this.subscriptions.set(i,s),this.channelSubscribers.set(i,new Set),console.log(`âœ… Created shared realtime channel: ${i}`)}catch(s){return console.error(`âŒ Failed to create realtime channel ${i}:`,s),()=>{}}}const a=this.channelSubscribers.get(i);return a.add(t),console.log(`ðŸ“¡ Added subscriber to ${i} (total: ${a.size})`),()=>{this.unsubscribe(i,t)}}static unsubscribe(e,t){const r=this.channelSubscribers.get(e);if(r&&(r.delete(t),r.size===0)){const i=this.subscriptions.get(e);i&&(d.removeChannel(i),this.subscriptions.delete(e),this.channelSubscribers.delete(e),console.log(`ðŸ”• Cleaned up channel: ${e}`))}}static getChannelKey(e,t){const r=[e];return t.event&&t.event!=="*"&&r.push(t.event),t.filter&&r.push(t.filter),r.join("_")}static getStats(){return{activeChannels:this.subscriptions.size,totalSubscribers:Array.from(this.channelSubscribers.values()).reduce((e,t)=>e+t.size,0),tableSubscribers:Object.fromEntries(Array.from(this.channelSubscribers.entries()).map(([e,t])=>[e,t.size]))}}static cleanup(){this.subscriptions.forEach(e=>{d.removeChannel(e)}),this.subscriptions.clear(),this.channelSubscribers.clear(),console.log("ðŸ§¹ Cleaned up all realtime subscriptions")}static nuclearCleanup(){console.log("ðŸ§¹ Force cleaning up all realtime connections"),this.cleanup()}}Gi.subscriptions=new Map;Gi.channelSubscribers=new Map;class zs{static initialize(){if(this.isInitialized){v.realtime("ðŸ”„ SimpleRealtimeAutoOptimizer already initialized");return}v.realtime("ðŸš€ SimpleRealtimeAutoOptimizer: Initialized (simplified)"),this.isInitialized=!0}static forceRestart(){v.realtime("ðŸ”„ SimpleRealtimeAutoOptimizer: Force restart (simplified)")}static getStatus(){return{isInitialized:this.isInitialized,optimizationStatus:{isRunning:!0,interval:"simplified",mode:"simplified"}}}static immediateNuclearCleanup(){v.realtime("ðŸ§¹ SimpleRealtimeAutoOptimizer: Immediate cleanup"),Gi.cleanup()}}zs.isInitialized=!1;zs.initialize();class Us{static startOptimization(){if(this.isOptimizing){v.realtime("ðŸ”„ SimpleRealtimeOptimizer already running");return}this.isOptimizing=!0,v.realtime("ðŸš€ Started simplified realtime optimization")}static stopOptimization(){this.isOptimizing=!1,v.realtime("â¹ï¸ Stopped simplified realtime optimization")}static getStatus(){return{isRunning:this.isOptimizing,interval:this.isOptimizing?"simplified":"inactive",mode:this.isOptimizing?"simplified":"inactive"}}static emergencyCleanup(){v.realtime("ðŸ§¹ Emergency cleanup (simplified)"),Gi.cleanup()}}Us.isOptimizing=!1;setTimeout(()=>{v.realtime("ðŸš€ Auto-starting simplified realtime optimization..."),Us.startOptimization()},2e3);var Ye=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Fs{constructor(e={}){const t=pe("VITE_SUPABASE_URL",""),r=e.baseUrl||(t?`${t}/functions/v1/auth-login-simple`:"/api/auth-login-simple");this.config={baseUrl:r,timeout:e.timeout||3e4,retryAttempts:e.retryAttempts||3}}generateCSRFToken(){const e=new Uint8Array(32);return crypto.getRandomValues(e),btoa(String.fromCharCode.apply(null,Array.from(e))).replace(/[^a-zA-Z0-9]/g,"").substring(0,32)}storeCSRFToken(e){try{sessionStorage.setItem("csrf_token",e)}catch(t){console.warn("Failed to store CSRF token:",t)}}getStoredCSRFToken(){try{return sessionStorage.getItem("csrf_token")}catch(e){return console.warn("Failed to retrieve CSRF token:",e),null}}validateCSRFToken(e,t){return t?e===t:!1}secureLogin(e){return Ye(this,null,function*(){const t=performance.now();try{console.log("ðŸ”§ Using direct Supabase authentication");const r=d,{data:i,error:a}=yield r.auth.signInWithPassword({email:e.email.trim().toLowerCase(),password:e.password});if(a)throw new Error(a.message);if(!i.user||!i.session)throw new Error("Authentication failed - no user or session returned");const o={success:!0,data:{accessToken:i.session.access_token,refreshToken:i.session.refresh_token,expiresIn:i.session.expires_in,user:{id:i.user.id,email:i.user.email,role:"user"}}};return j()&&console.log(`[PERF] SecureAuthService: Direct Supabase login completed in ${(performance.now()-t).toFixed(2)}ms`),o}catch(r){return console.error(`[AUTH] Login failed for ${e.email}:`,r),{success:!1,error:r instanceof Error?r.message:"Authentication failed"}}})}makeSecureRequest(e){return Ye(this,null,function*(){const t=new AbortController,r=setTimeout(()=>t.abort(),this.config.timeout);try{const i=yield fetch(this.config.baseUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(e),signal:t.signal,credentials:"same-origin"});if(clearTimeout(r),!i.ok){const s=yield i.json().catch(()=>({}));if(i.status===429)return{success:!1,error:s.message||"Too many login attempts. Please try again later.",rateLimitInfo:s.rateLimitInfo};if(i.status===401)return{success:!1,error:s.message||"Invalid email or password"};throw new Error(s.message||`HTTP ${i.status}: ${i.statusText}`)}return yield i.json()}catch(i){throw clearTimeout(r),i.name==="AbortError"?new Error("Request timeout. Please check your connection and try again."):i}})}storeTokens(e){try{sessionStorage.setItem("access_token",e.accessToken),sessionStorage.setItem("refresh_token",e.refreshToken),sessionStorage.setItem("token_expires",(Date.now()+e.expiresIn*1e3).toString()),d.auth.setSession({access_token:e.accessToken,refresh_token:e.refreshToken})}catch(t){throw console.error("Failed to store authentication tokens:",t),new Error("Failed to store authentication tokens")}}validateStoredToken(){return Ye(this,null,function*(){try{const e=sessionStorage.getItem("access_token"),t=sessionStorage.getItem("token_expires");return!e||!t?!1:Date.now()>parseInt(t)?yield this.refreshToken():!0}catch(e){return console.error("Token validation failed:",e),!1}})}refreshToken(){return Ye(this,null,function*(){try{const e=sessionStorage.getItem("refresh_token");if(!e)return!1;const{data:t,error:r}=yield d.auth.refreshSession({refresh_token:e});return r||!t.session?(yield this.clearTokens(),!1):(this.storeTokens({accessToken:t.session.access_token,refreshToken:t.session.refresh_token,expiresIn:t.session.expires_in}),!0)}catch(e){return console.error("Token refresh failed:",e),yield this.clearTokens(),!1}})}clearTokens(){return Ye(this,null,function*(){try{sessionStorage.removeItem("access_token"),sessionStorage.removeItem("refresh_token"),sessionStorage.removeItem("token_expires"),sessionStorage.removeItem("csrf_token"),yield d.auth.signOut()}catch(e){console.error("Failed to clear tokens:",e)}})}getCurrentUser(){return Ye(this,null,function*(){try{if(!(yield this.validateStoredToken()))return null;const{data:{user:t}}=yield d.auth.getUser();return t}catch(e){return console.error("Failed to get current user:",e),null}})}validateToken(e){return Ye(this,null,function*(){try{if(e){const{data:t,error:r}=yield d.auth.getUser(e);return!r&&!!t.user}else return yield this.validateStoredToken()}catch(t){return console.error("Token validation failed:",t),!1}})}logout(){return Ye(this,null,function*(){try{yield this.clearTokens(),console.log("[AUTH] Logout completed successfully")}catch(e){throw console.error("[AUTH] Logout error:",e),e}})}}new Fs;var ma={},Fn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});let zi=null;const Ni=typeof window!="undefined",Ml=()=>Fn(null,null,function*(){if(!Ni)try{const{createClient:c}=yield T(()=>import("./redisClient.server-RgZqzn2v.js"),__vite__mapDeps([8,0,1,2,3,4,5,6,7,9,10]));zi=c}catch(c){}});Ni||Ml();class ql{constructor(e){this.client=null,this.isConnected=!1,this.config=e}connect(){return Fn(this,null,function*(){if(!this.isConnected){if(Ni){v.warn("Redis not available in browser environment, using in-memory fallback");return}if(zi||(yield new Promise(e=>setTimeout(e,100))),!zi){v.warn("Redis not available, using in-memory fallback");return}try{this.client=zi({socket:{host:this.config.host,port:this.config.port,reconnectStrategy:e=>e>10?(v.error("Redis connection failed after 10 retries"),new Error("Redis connection failed")):Math.min(e*100,3e3)},password:this.config.password,database:this.config.db||0}),this.client.on("error",e=>{v.error("Redis client error:",e),this.isConnected=!1}),this.client.on("connect",()=>{v.info("Redis client connected"),this.isConnected=!0}),this.client.on("disconnect",()=>{v.warn("Redis client disconnected"),this.isConnected=!1}),yield this.client.connect()}catch(e){throw v.error("Failed to connect to Redis:",e),e}}})}disconnect(){return Fn(this,null,function*(){this.client&&this.isConnected&&(yield this.client.disconnect(),this.isConnected=!1)})}getClient(){if(!this.client||!this.isConnected)throw new Error("Redis client not connected");return this.client}isHealthy(){return Ni?!1:this.isConnected&&this.client!==null}}const Xr=(c,e)=>typeof process!="undefined"&&ma&&ma[c]||e,zl={host:Xr("REDIS_HOST","localhost"),port:parseInt(Xr("REDIS_PORT","6379")),password:Xr("REDIS_PASSWORD",""),db:parseInt(Xr("REDIS_DB","0")),retryDelayOnFailover:100,maxRetriesPerRequest:3},G=new ql(zl);var Ul=Object.defineProperty,pa=Object.getOwnPropertySymbols,Fl=Object.prototype.hasOwnProperty,Ll=Object.prototype.propertyIsEnumerable,ga=(c,e,t)=>e in c?Ul(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,pt=(c,e)=>{for(var t in e||(e={}))Fl.call(e,t)&&ga(c,t,e[t]);if(pa)for(var t of pa(e))Ll.call(e,t)&&ga(c,t,e[t]);return c},Zr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Ke{constructor(e){this.fallbackCache=new Map,this.cleanupInterval=null,this.config=pt({blockDurationMs:e.windowMs*2},e),this.startCleanupInterval()}checkRateLimit(e,t){return Zr(this,null,function*(){const r=pt(pt({},this.config),t),i=`${r.keyPrefix}:${e}`,a=Date.now(),s=a-r.windowMs;try{if(G.isHealthy())return yield this.checkRedisRateLimit(i,r,a,s)}catch(o){v.warn("Redis rate limiting failed, falling back to in-memory:",o)}return this.checkInMemoryRateLimit(i,r,a)})}checkRedisRateLimit(e,t,r,i){return Zr(this,null,function*(){const a=G.getClient(),s=a.multi();s.zRemRangeByScore(e,"-inf",i),s.zCard(e),s.zAdd(e,{score:r,member:`${r}-${Math.random()}`}),s.expire(e,Math.ceil(t.windowMs/1e3));const o=`${e}:blocked`;s.get(o);const n=yield s.exec();if(!n||n.length<4)throw new Error("Redis pipeline execution failed");const l=n[1],u=n[4];if(u){const h=parseInt(u);if(r<h)return{allowed:!1,remaining:0,resetTime:h,retryAfter:Math.ceil((h-r)/1e3)};yield a.del(o)}if(l>=t.maxRequests){if(t.blockDurationMs){const h=r+t.blockDurationMs;yield a.setEx(o,Math.ceil(t.blockDurationMs/1e3),h.toString())}return{allowed:!1,remaining:0,resetTime:r+t.windowMs,retryAfter:Math.ceil(t.windowMs/1e3)}}return{allowed:!0,remaining:t.maxRequests-l-1,resetTime:r+t.windowMs}})}checkInMemoryRateLimit(e,t,r){const i=this.fallbackCache.get(e);i&&i.resetTime<r&&this.fallbackCache.delete(e);const a=this.fallbackCache.get(e)||{count:0,resetTime:r+t.windowMs,blocked:!1};return a.blocked&&a.blockUntil&&r<a.blockUntil?{allowed:!1,remaining:0,resetTime:a.blockUntil,retryAfter:Math.ceil((a.blockUntil-r)/1e3)}:(a.resetTime<r&&(a.count=0,a.resetTime=r+t.windowMs,a.blocked=!1,delete a.blockUntil),a.count>=t.maxRequests?(t.blockDurationMs&&(a.blocked=!0,a.blockUntil=r+t.blockDurationMs),this.fallbackCache.set(e,a),{allowed:!1,remaining:0,resetTime:a.resetTime,retryAfter:Math.ceil(t.windowMs/1e3)}):(a.count++,this.fallbackCache.set(e,a),{allowed:!0,remaining:t.maxRequests-a.count,resetTime:a.resetTime}))}resetRateLimit(e,t){return Zr(this,null,function*(){const i=`${pt(pt({},this.config),t).keyPrefix}:${e}`;try{if(G.isHealthy()){const a=G.getClient();yield a.del(i),yield a.del(`${i}:blocked`)}}catch(a){v.warn("Failed to reset Redis rate limit:",a)}this.fallbackCache.delete(i)})}getRateLimitStatus(e,t){return Zr(this,null,function*(){const r=pt(pt({},this.config),t),i=`${r.keyPrefix}:${e}`,a=Date.now(),s=a-r.windowMs;try{if(G.isHealthy()){const n=G.getClient(),l=`${i}:blocked`,u=yield n.get(l);if(u){const f=parseInt(u);if(a<f)return{allowed:!1,remaining:0,resetTime:f,retryAfter:Math.ceil((f-a)/1e3)}}const h=yield n.zCount(i,s,"+inf");return{allowed:h<r.maxRequests,remaining:Math.max(0,r.maxRequests-h),resetTime:a+r.windowMs}}}catch(n){v.warn("Failed to get Redis rate limit status:",n)}const o=this.fallbackCache.get(i);return!o||o.resetTime<a?{allowed:!0,remaining:r.maxRequests,resetTime:a+r.windowMs}:o.blocked&&o.blockUntil&&a<o.blockUntil?{allowed:!1,remaining:0,resetTime:o.blockUntil,retryAfter:Math.ceil((o.blockUntil-a)/1e3)}:{allowed:o.count<r.maxRequests,remaining:Math.max(0,r.maxRequests-o.count),resetTime:o.resetTime}})}startCleanupInterval(){this.cleanupInterval=setInterval(()=>{const e=Date.now();for(const[t,r]of Array.from(this.fallbackCache.entries()))r.resetTime<e&&this.fallbackCache.delete(t)},6e4)}getStats(){return{fallbackCacheSize:this.fallbackCache.size,redisHealthy:G.isHealthy(),config:this.config}}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.fallbackCache.clear()}}new Ke({maxRequests:100,windowMs:60*1e3,keyPrefix:"api",blockDurationMs:300*1e3});new Ke({maxRequests:5,windowMs:900*1e3,keyPrefix:"auth",blockDurationMs:1800*1e3});new Ke({maxRequests:20,windowMs:60*1e3,keyPrefix:"ai",blockDurationMs:120*1e3});new Ke({maxRequests:30,windowMs:60*1e3,keyPrefix:"general"});var Nl=Object.defineProperty,ya=Object.getOwnPropertySymbols,xl=Object.prototype.hasOwnProperty,Bl=Object.prototype.propertyIsEnumerable,_a=(c,e,t)=>e in c?Nl(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,ei=(c,e)=>{for(var t in e||(e={}))xl.call(e,t)&&_a(c,t,e[t]);if(ya)for(var t of ya(e))Bl.call(e,t)&&_a(c,t,e[t]);return c},yr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Nn{constructor(e={}){this.config=ei({maxRequests:100,windowMs:60*1e3,burstLimit:10,retryDelay:1e3,maxRetries:3},e),this.generalLimiter=new Ke({maxRequests:this.config.maxRequests,windowMs:this.config.windowMs,keyPrefix:"ai_general",blockDurationMs:this.config.windowMs}),this.burstLimiter=new Ke({maxRequests:this.config.burstLimit,windowMs:10*1e3,keyPrefix:"ai_burst",blockDurationMs:30*1e3})}checkRateLimit(e,t=!1){return yr(this,null,function*(){try{if(t){const i=yield this.burstLimiter.checkRateLimit(e);if(!i.allowed)return{allowed:!1,remaining:0,resetTime:i.resetTime,retryAfter:i.retryAfter,burstRemaining:0}}const r=yield this.generalLimiter.checkRateLimit(e);return{allowed:r.allowed,remaining:r.remaining,resetTime:r.resetTime,retryAfter:r.retryAfter,burstRemaining:t?yield this.getBurstRemaining(e):void 0}}catch(r){return v.error("AI rate limit check failed:",r),{allowed:!0,remaining:this.config.maxRequests,resetTime:Date.now()+this.config.windowMs}}})}recordRequest(e,t=!1){return yr(this,null,function*(){try{t&&(yield this.burstLimiter.checkRateLimit(e)),yield this.generalLimiter.checkRateLimit(e)}catch(r){v.error("AI rate limit recording failed:",r)}})}getBurstRemaining(e){return yr(this,null,function*(){try{return(yield this.burstLimiter.getRateLimitStatus(e)).remaining}catch(t){return v.error("Failed to get burst remaining:",t),this.config.burstLimit}})}resetRateLimit(e){return yr(this,null,function*(){try{yield Promise.all([this.generalLimiter.resetRateLimit(e),this.burstLimiter.resetRateLimit(e)])}catch(t){v.error("Failed to reset AI rate limits:",t)}})}getStatus(e){return yr(this,null,function*(){try{const[t,r]=yield Promise.all([this.generalLimiter.getRateLimitStatus(e),this.burstLimiter.getRateLimitStatus(e)]);return{general:{allowed:t.allowed,remaining:t.remaining,resetTime:t.resetTime,retryAfter:t.retryAfter},burst:{allowed:r.allowed,remaining:r.remaining,resetTime:r.resetTime,retryAfter:r.retryAfter}}}catch(t){return v.error("Failed to get AI rate limit status:",t),{general:{allowed:!0,remaining:this.config.maxRequests,resetTime:Date.now()+this.config.windowMs},burst:{allowed:!0,remaining:this.config.burstLimit,resetTime:Date.now()+10*1e3}}}})}updateConfig(e){this.config=ei(ei({},this.config),e),this.generalLimiter=new Ke({maxRequests:this.config.maxRequests,windowMs:this.config.windowMs,keyPrefix:"ai_general",blockDurationMs:this.config.windowMs}),this.burstLimiter=new Ke({maxRequests:this.config.burstLimit,windowMs:10*1e3,keyPrefix:"ai_burst",blockDurationMs:30*1e3}),v.info("AI rate limiter configuration updated",e)}getConfigs(){return ei({},this.config)}getStats(){return{general:this.generalLimiter.getStats(),burst:this.burstLimiter.getStats(),config:this.config}}isHealthy(){try{const e=this.generalLimiter.getStats(),t=this.burstLimiter.getStats();return e.redisHealthy||t.redisHealthy}catch(e){return v.error("Health check failed:",e),!1}}}const Ln=new Nn({maxRequests:50,windowMs:60*1e3,burstLimit:5,retryDelay:2e3,maxRetries:3});new Nn({maxRequests:20,windowMs:60*1e3,burstLimit:3,retryDelay:3e3,maxRetries:2});new Nn({maxRequests:10,windowMs:300*1e3,burstLimit:2,retryDelay:5e3,maxRetries:1});var jl=Object.defineProperty,va=Object.getOwnPropertySymbols,Vl=Object.prototype.hasOwnProperty,Hl=Object.prototype.propertyIsEnumerable,wa=(c,e,t)=>e in c?jl(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,nn=(c,e)=>{for(var t in e||(e={}))Vl.call(e,t)&&wa(c,t,e[t]);if(va)for(var t of va(e))Hl.call(e,t)&&wa(c,t,e[t]);return c},ti=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Gl{constructor(e={}){this.queue=[],this.processing=!1,this.activeRequests=0,this.processingInterval=null,this.results=new Map,this.config=nn({maxConcurrent:5,batchSize:3,processingInterval:1e3,retryDelay:2e3},e)}addRequest(e,t,r){return ti(this,arguments,function*(i,a,s,o={}){const n={id:`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,service:i,identifier:a,operation:s,priority:o.priority||0,maxRetries:o.maxRetries||3,timeout:o.timeout||3e4,createdAt:new Date,metadata:o.metadata};return this.queue.push(n),this.queue.sort((l,u)=>u.priority-l.priority),v.debug(`Added request to queue: ${n.id} (priority: ${n.priority})`),this.processing||this.startProcessing(),this.waitForCompletion(n.id)})}startProcessing(){this.processing||(this.processing=!0,this.processingInterval=setInterval(()=>{this.processQueue()},this.config.processingInterval),v.info("AI request queue processing started"))}stopProcessing(){this.processingInterval&&(clearInterval(this.processingInterval),this.processingInterval=null),this.processing=!1,v.info("AI request queue processing stopped")}processQueue(){return ti(this,null,function*(){if(this.activeRequests>=this.config.maxConcurrent||this.queue.length===0)return;const e=this.queue.splice(0,this.config.batchSize);for(const t of e){if(this.activeRequests>=this.config.maxConcurrent){this.queue.unshift(...e.slice(e.indexOf(t)));break}this.processRequest(t)}})}processRequest(e){return ti(this,null,function*(){this.activeRequests++;try{v.debug(`Processing request: ${e.id}`);const t=yield Ln.checkRateLimit(e.identifier);if(!t.allowed)throw new Error(`Rate limit exceeded. Retry after ${t.retryAfter}ms`);const r=yield e.operation();yield Ln.recordRequest(e.identifier),this.storeResult(e.id,{success:!0,data:r})}catch(t){v.error(`Request ${e.id} failed:`,t),e.maxRetries>0?(e.maxRetries--,this.queue.push(e),v.debug(`Retrying request ${e.id} (${e.maxRetries} retries left)`)):this.storeResult(e.id,{success:!1,error:t instanceof Error?t.message:"Unknown error"})}finally{this.activeRequests--}})}waitForCompletion(e){return ti(this,null,function*(){return new Promise((t,r)=>{const i=()=>{const a=this.getResult(e);a?a.success?t(a.data):r(new Error(a.error)):setTimeout(i,100)};i()})})}storeResult(e,t){this.results.set(e,t)}getResult(e){return this.results.get(e)}getStats(){return{queueLength:this.queue.length,activeRequests:this.activeRequests,processing:this.processing,config:this.config}}clearQueue(){this.queue=[],this.results.clear(),v.info("AI request queue cleared")}updateConfig(e){this.config=nn(nn({},this.config),e),v.info("AI request queue configuration updated:",this.config)}}const ri=new Gl;var _r=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Wl{constructor(e="cliniio"){this.cache=new Map,this.namespace=e}getKey(e){return`${this.namespace}:${e}`}get(e){return _r(this,null,function*(){try{const t=this.cache.get(this.getKey(e));return t&&t.expires>Date.now()?t.value:(t&&this.cache.delete(this.getKey(e)),null)}catch(t){return v.error("In-memory cache get error:",t),null}})}set(e,t){return _r(this,arguments,function*(r,i,a={}){try{const s=a.ttl||300,o=Date.now()+s*1e3;this.cache.set(this.getKey(r),{value:i,expires:o})}catch(s){v.error("In-memory cache set error:",s)}})}del(e){return _r(this,null,function*(){try{this.cache.delete(this.getKey(e))}catch(t){v.error("In-memory cache delete error:",t)}})}exists(e){return _r(this,null,function*(){try{const t=this.cache.get(this.getKey(e));return t?t.expires>Date.now():!1}catch(t){return v.error("In-memory cache exists error:",t),!1}})}clear(){return _r(this,null,function*(){try{this.cache.clear()}catch(e){v.error("In-memory cache clear error:",e)}})}cleanup(){const e=Date.now();for(const[t,r]of Array.from(this.cache.entries()))r.expires<=e&&this.cache.delete(t)}getStats(){return{size:this.cache.size,isRedis:!1}}}var vr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Ls{constructor(e="cliniio"){this.namespace=e,this.fallbackCache=new Wl(e)}getKey(e){return`${this.namespace}:${e}`}get(e){return vr(this,null,function*(){try{if(G.isHealthy()){const r=yield G.getClient().get(this.getKey(e));return r?JSON.parse(r):null}else return yield this.fallbackCache.get(e)}catch(t){return v.error("Cache get error:",t),yield this.fallbackCache.get(e)}})}set(e,t){return vr(this,arguments,function*(r,i,a={}){try{if(G.isHealthy()){const s=G.getClient(),o=a.ttl||300;yield s.setEx(this.getKey(r),o,JSON.stringify(i))}else yield this.fallbackCache.set(r,i,a)}catch(s){v.error("Cache set error:",s),yield this.fallbackCache.set(r,i,a)}})}del(e){return vr(this,null,function*(){try{G.isHealthy()?yield G.getClient().del(this.getKey(e)):yield this.fallbackCache.del(e)}catch(t){v.error("Cache delete error:",t),yield this.fallbackCache.del(e)}})}exists(e){return vr(this,null,function*(){try{return G.isHealthy()?(yield G.getClient().exists(this.getKey(e)))===1:yield this.fallbackCache.exists(e)}catch(t){return v.error("Cache exists error:",t),yield this.fallbackCache.exists(e)}})}clear(){return vr(this,null,function*(){try{if(G.isHealthy()){const e=G.getClient(),t=yield e.keys(this.getKey("*"));t.length>0&&(yield e.del(t))}else yield this.fallbackCache.clear()}catch(e){v.error("Cache clear error:",e),yield this.fallbackCache.clear()}})}cleanup(){this.fallbackCache.cleanup()}getStats(){return{size:this.fallbackCache.getStats().size,isRedis:G.isHealthy()}}}var wr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Kl{constructor(){this.DEFAULT_TTL=3600,this.hitCounts=new Map,this.cache=new Ls("ai_responses")}generateCacheKey(e){const{service:t,operation:r,parameters:i,userId:a,facilityId:s}=e,o=this.hashObject(i);let n=`${t}:${r}:${o}`;return a&&(n+=`:user:${a}`),s&&(n+=`:facility:${s}`),n}get(e){return wr(this,null,function*(){try{const t=this.generateCacheKey(e),r=yield this.cache.get(t);if(r){const i=this.hitCounts.get(t)||0;return this.hitCounts.set(t,i+1),v.debug(`AI cache hit for ${e.service}:${e.operation}`),r.data}return null}catch(t){return v.error("Error getting from AI cache:",t),null}})}set(e,t){return wr(this,arguments,function*(r,i,a={}){try{const s=this.generateCacheKey(r),o=a.ttl||this.DEFAULT_TTL,n={data:i,timestamp:Date.now(),hitCount:0,metadata:{service:r.service,operation:r.operation,userId:r.userId,facilityId:r.facilityId}};yield this.cache.set(s,n,{ttl:o}),v.debug(`AI response cached for ${r.service}:${r.operation}`)}catch(s){v.error("Error setting AI cache:",s)}})}executeWithCache(e,t){return wr(this,arguments,function*(r,i,a={}){const s=yield this.get(r);if(s!==null)return s;const o=yield i();return yield this.set(r,o,a),o})}invalidate(e){return wr(this,null,function*(){try{v.info("Invalidating AI cache for pattern:",e),yield this.cache.clear()}catch(t){v.error("Error invalidating AI cache:",t)}})}getStats(){return{totalEntries:this.hitCounts.size,hitCounts:Object.fromEntries(this.hitCounts),cacheStats:this.cache.getStats()}}clear(){return wr(this,null,function*(){try{yield this.cache.clear(),this.hitCounts.clear(),v.info("AI response cache cleared")}catch(e){v.error("Error clearing AI cache:",e)}})}hashObject(e){const t=JSON.stringify(e,Object.keys(e).sort());return this.simpleHash(t)}simpleHash(e){let t=0;for(let r=0;r<e.length;r++){const i=e.charCodeAt(r);t=(t<<5)-t+i,t=t&t}return Math.abs(t).toString(36)}}const ii=new Kl;var Ql=Object.defineProperty,Ia=Object.getOwnPropertySymbols,Yl=Object.prototype.hasOwnProperty,Jl=Object.prototype.propertyIsEnumerable,Sa=(c,e,t)=>e in c?Ql(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,an=(c,e)=>{for(var t in e||(e={}))Yl.call(e,t)&&Sa(c,t,e[t]);if(Ia)for(var t of Ia(e))Jl.call(e,t)&&Sa(c,t,e[t]);return c},$t=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Xl{constructor(e={}){this.pendingRequests=[],this.activeBatches=0,this.batchTimer=null,this.config=an({maxBatchSize:10,maxWaitTime:2e3,maxConcurrentBatches:3,priorityThreshold:5},e)}addRequest(e){return $t(this,arguments,function*(t,r={}){const i={id:`batch_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,operation:t,priority:r.priority||0,metadata:r.metadata};return this.pendingRequests.push(i),this.pendingRequests.sort((a,s)=>s.priority-a.priority),v.debug(`Added request to batch queue: ${i.id} (priority: ${i.priority})`),this.batchTimer||this.startBatchTimer(),this.waitForCompletion(i.id)})}startBatchTimer(){this.batchTimer=setTimeout(()=>{this.processBatches(),this.batchTimer=null},this.config.maxWaitTime)}processBatches(){return $t(this,null,function*(){if(this.activeBatches>=this.config.maxConcurrentBatches){this.startBatchTimer();return}const e=this.pendingRequests.filter(r=>r.priority<this.config.priorityThreshold);if(e.length===0)return;const t=this.createBatches(e);for(const r of t){if(this.activeBatches>=this.config.maxConcurrentBatches)break;this.processBatch(r)}this.pendingRequests.length>0&&this.startBatchTimer()})}createBatches(e){const t=[];for(let r=0;r<e.length;r+=this.config.maxBatchSize){const i=e.slice(r,r+this.config.maxBatchSize);t.push(i)}return t}processBatch(e){return $t(this,null,function*(){this.activeBatches++;try{v.debug(`Processing batch of ${e.length} requests`),e.forEach(a=>{const s=this.pendingRequests.findIndex(o=>o.id===a.id);s!==-1&&this.pendingRequests.splice(s,1)});const t=Date.now(),r=e.map(a=>$t(this,null,function*(){const s=Date.now();try{const o=yield a.operation(),n=Date.now()-s;this.storeResult(a.id,{id:a.id,success:!0,data:o,duration:n})}catch(o){const n=Date.now()-s;this.storeResult(a.id,{id:a.id,success:!1,error:o instanceof Error?o.message:"Unknown error",duration:n})}}));yield Promise.all(r);const i=Date.now()-t;v.debug(`Batch completed in ${i}ms`)}catch(t){v.error("Batch processing failed:",t),e.forEach(r=>{this.storeResult(r.id,{id:r.id,success:!1,error:"Batch processing failed",duration:0})})}finally{this.activeBatches--}})}waitForCompletion(e){return $t(this,null,function*(){return new Promise((t,r)=>{const i=()=>{const a=this.getResult(e);a?a.success?t(a.data):r(new Error(a.error)):setTimeout(i,50)};i()})})}storeResult(e,t){this.results=this.results||new Map,this.results.set(e,t)}getResult(e){return this.results=this.results||new Map,this.results.get(e)}getStats(){return{pendingRequests:this.pendingRequests.length,activeBatches:this.activeBatches,config:this.config}}updateConfig(e){this.config=an(an({},this.config),e),v.info("AI request batcher configuration updated:",this.config)}clearPending(){this.pendingRequests=[],this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),v.info("AI request batcher cleared")}forceProcess(){return $t(this,null,function*(){this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),yield this.processBatches()})}}const Ir=new Xl;var Zl=Object.defineProperty,eu=Object.defineProperties,tu=Object.getOwnPropertyDescriptors,ba=Object.getOwnPropertySymbols,ru=Object.prototype.hasOwnProperty,iu=Object.prototype.propertyIsEnumerable,Ea=(c,e,t)=>e in c?Zl(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,on=(c,e)=>{for(var t in e||(e={}))ru.call(e,t)&&Ea(c,t,e[t]);if(ba)for(var t of ba(e))iu.call(e,t)&&Ea(c,t,e[t]);return c},nu=(c,e)=>eu(c,tu(e));class bt{constructor(){this.serviceMetrics={},this.alerts=[],this.requestTimes=[],this.MAX_REQUEST_TIMES=1e3,this.metrics={totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0,cacheHitRate:0,rateLimitHits:0,queueLength:0,activeRequests:0,lastUpdated:new Date}}static getInstance(){return bt.instance||(bt.instance=new bt),bt.instance}recordRequest(e,t,r,i=!1,a=!1){const s=new Date;this.metrics.totalRequests++,t?this.metrics.successfulRequests++:this.metrics.failedRequests++,i?this.metrics.cacheHitRate=(this.metrics.cacheHitRate*(this.metrics.totalRequests-1)+1)/this.metrics.totalRequests:this.metrics.cacheHitRate=this.metrics.cacheHitRate*(this.metrics.totalRequests-1)/this.metrics.totalRequests,a&&this.metrics.rateLimitHits++,this.requestTimes.push(r),this.requestTimes.length>this.MAX_REQUEST_TIMES&&this.requestTimes.shift(),this.metrics.averageResponseTime=this.calculateAverageResponseTime(),this.serviceMetrics[e]||(this.serviceMetrics[e]={requests:0,successes:0,failures:0,avgResponseTime:0,lastRequest:s});const o=this.serviceMetrics[e];o.requests++,o.lastRequest=s,t?o.successes++:o.failures++,o.avgResponseTime=(o.avgResponseTime*(o.requests-1)+r)/o.requests,this.metrics.lastUpdated=s,this.checkAlerts(e,t,r)}updateQueueMetrics(e,t){this.metrics.queueLength=e,this.metrics.activeRequests=t,this.metrics.lastUpdated=new Date}getMetrics(){return on({},this.metrics)}getServiceMetrics(){return on({},this.serviceMetrics)}getAlerts(){return[...this.alerts]}clearOldAlerts(e=1440*60*1e3){const t=new Date(Date.now()-e);this.alerts=this.alerts.filter(r=>r.timestamp>t)}getHealthStatus(){const e=[],t=[],r=this.metrics.totalRequests>0?this.metrics.failedRequests/this.metrics.totalRequests:0;r>.1&&(e.push(`High error rate: ${(r*100).toFixed(1)}%`),t.push("Investigate failed requests and improve error handling")),this.metrics.averageResponseTime>5e3&&(e.push(`Slow response time: ${this.metrics.averageResponseTime.toFixed(0)}ms`),t.push("Optimize AI operations and consider caching")),this.metrics.queueLength>50&&(e.push(`High queue length: ${this.metrics.queueLength}`),t.push("Increase processing capacity or optimize request handling")),this.metrics.cacheHitRate<.3&&(e.push(`Low cache hit rate: ${(this.metrics.cacheHitRate*100).toFixed(1)}%`),t.push("Improve caching strategy and cache more responses"));let i="healthy";return e.length>0&&(i=e.length>2?"critical":"warning"),{status:i,issues:e,recommendations:t}}calculateAverageResponseTime(){return this.requestTimes.length===0?0:this.requestTimes.reduce((e,t)=>e+t,0)/this.requestTimes.length}checkAlerts(e,t,r){if(!t){const i=this.serviceMetrics[e];if(i&&i.requests>10){const a=i.failures/i.requests;a>.2&&this.addAlert({type:"high_error_rate",severity:"critical",message:`High error rate for ${e}: ${(a*100).toFixed(1)}%`,metadata:{service:e,errorRate:a}})}}r>1e4&&this.addAlert({type:"slow_response",severity:"warning",message:`Slow response time for ${e}: ${r}ms`,metadata:{service:e,responseTime:r}}),this.metrics.queueLength>100&&this.addAlert({type:"high_queue_length",severity:"critical",message:`High queue length: ${this.metrics.queueLength}`,metadata:{queueLength:this.metrics.queueLength}}),this.metrics.rateLimitHits>10&&this.addAlert({type:"rate_limit_exceeded",severity:"warning",message:`Rate limit exceeded ${this.metrics.rateLimitHits} times`,metadata:{rateLimitHits:this.metrics.rateLimitHits}})}addAlert(e){const t=nu(on({},e),{id:`alert_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date});this.alerts.push(t),v.warn(`AI Performance Alert: ${t.message}`,t)}resetMetrics(){this.metrics={totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0,cacheHitRate:0,rateLimitHits:0,queueLength:0,activeRequests:0,lastUpdated:new Date},this.serviceMetrics={},this.alerts=[],this.requestTimes=[],v.info("AI monitoring metrics reset")}}const Sr=bt.getInstance();var au=Object.defineProperty,ou=Object.defineProperties,su=Object.getOwnPropertyDescriptors,Aa=Object.getOwnPropertySymbols,cu=Object.prototype.hasOwnProperty,lu=Object.prototype.propertyIsEnumerable,Ta=(c,e,t)=>e in c?au(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,uu=(c,e)=>{for(var t in e||(e={}))cu.call(e,t)&&Ta(c,t,e[t]);if(Aa)for(var t of Aa(e))lu.call(e,t)&&Ta(c,t,e[t]);return c},du=(c,e)=>ou(c,su(e)),ni=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Et{constructor(){}static getInstance(){return Et.instance||(Et.instance=new Et),Et.instance}execute(e,t,r){return ni(this,null,function*(){const i=Date.now();let a=!1,s=!1,o,n;try{if(e.useCache!==!1){const u={service:e.service,operation:e.operation,parameters:(r==null?void 0:r.parameters)||{},userId:r==null?void 0:r.userId,facilityId:r==null?void 0:r.facilityId},h=yield ii.get(u);h!==null&&(a=!0,o=h,s=!0,v.debug(`AI operation served from cache: ${e.service}:${e.operation}`))}if(!a&&(e.useBatching!==!1&&(e.priority||0)<5?o=yield Ir.addRequest(t,{priority:e.priority,metadata:e.metadata}):o=yield ri.addRequest(e.service,(r==null?void 0:r.userId)||"anonymous",t,{priority:e.priority,maxRetries:e.maxRetries,timeout:e.timeout,metadata:e.metadata}),s=!0,e.useCache!==!1&&o)){const u={service:e.service,operation:e.operation,parameters:(r==null?void 0:r.parameters)||{},userId:r==null?void 0:r.userId,facilityId:r==null?void 0:r.facilityId};yield ii.set(u,o,{ttl:e.cacheTtl})}const l=Date.now()-i;return Sr.recordRequest(e.service,s,l,a,!1),{success:s,data:o,error:n,fromCache:a,responseTime:l,metadata:e.metadata}}catch(l){const u=Date.now()-i;return n=l instanceof Error?l.message:"Unknown error",s=!1,Sr.recordRequest(e.service,s,u,a,!1),v.error(`AI operation failed: ${e.service}:${e.operation}`,l),{success:s,data:o,error:n,fromCache:a,responseTime:u,metadata:e.metadata}}})}executeBatch(e){return ni(this,null,function*(){const t=e.map(({config:r,operation:i,context:a})=>this.execute(r,i,a));return Promise.all(t)})}getStats(){return{monitoring:Sr.getMetrics(),queue:ri.getStats(),cache:ii.getStats(),batcher:Ir.getStats(),rateLimiter:Ln.getConfigs()}}getHealthStatus(){const e=Sr.getHealthStatus(),t=this.getStats();return du(uu({},e),{metrics:t})}reset(){return ni(this,null,function*(){yield ii.clear(),ri.clearQueue(),Ir.clearPending(),Sr.resetMetrics(),v.info("AI service reset completed")})}updateConfig(e){e.queue&&ri.updateConfig(e.queue),e.batcher&&Ir.updateConfig(e.batcher),v.info("AI service configuration updated")}forceProcess(){return ni(this,null,function*(){yield Ir.forceProcess(),v.info("AI service force processing completed")})}}Et.getInstance();var sn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class hu{constructor(e){this.facilityId=e}getLearningInsights(){return sn(this,null,function*(){try{const e=[],{data:t}=yield d.from("learning_ai_personalized_recommendations").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);t&&t.forEach(s=>{e.push({type:"personalized_recommendation",title:"Personalized Learning Recommendations",description:`${s.recommended_content.length} content items recommended for user ${s.user_id}`,confidence:s.confidence_score||0,recommendations:s.recommendation_reasoning||[],data:s,created_at:s.created_at,facility_id:this.facilityId,priority:this.getPriorityFromConfidence(s.confidence_score),actionable:!0,id:s.id||`recommendation-${Date.now()}`})});const{data:r}=yield d.from("learning_ai_skill_gap_analysis").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);r&&r.forEach(s=>{const o=Object.keys(s.skill_gaps);e.push({type:"skill_gap_analysis",title:"Skill Gap Analysis",description:`${o.length} skill gaps identified for user ${s.user_id}`,confidence:s.confidence_score||0,recommendations:s.learning_recommendations||[],data:s,created_at:s.created_at,facility_id:this.facilityId,priority:this.getPriorityFromGapCount(o.length),actionable:!0,id:s.id||`skillgap-${Date.now()}`})});const{data:i}=yield d.from("learning_ai_path_optimization").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);i&&i.forEach(s=>{e.push({type:"learning_path_optimization",title:"Learning Path Optimized",description:`Path efficiency score: ${(s.path_efficiency_score*100).toFixed(1)}% for user ${s.user_id}`,confidence:s.confidence_score||0,recommendations:s.optimization_factors||[],data:s,created_at:s.created_at,facility_id:this.facilityId,priority:this.getPriorityFromEfficiency(s.path_efficiency_score),actionable:!0,id:s.id||`pathopt-${Date.now()}`})});const{data:a}=yield d.from("learning_ai_performance_prediction").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);return a&&a.forEach(s=>{e.push({type:"performance_prediction",title:"Performance Prediction",description:`Predicted performance: ${(s.predicted_performance*100).toFixed(1)}% for content ${s.user_id}`,confidence:s.confidence_score||0,recommendations:s.performance_factors||[],data:s,created_at:s.created_at,facility_id:this.facilityId,priority:this.getPriorityFromPerformance(s.predicted_performance),actionable:!0,id:s.id||`perfpred-${Date.now()}`})}),e}catch(e){return console.error("Error getting learning insights:",e),[]}})}getHistoricalLearningData(){return sn(this,null,function*(){try{const{data:e}=yield d.from("user_learning_progress").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(30);return e?e.map(t=>({date:t.created_at,user_id:t.user_id,content_id:t.content_id,progress_percentage:t.completion_rate,time_spent:t.session_duration,score:t.satisfaction_score,engagement_score:this.calculateEngagementScore(t)})):Array.from({length:30},(t,r)=>({date:new Date(Date.now()-r*24*60*60*1e3).toISOString(),user_id:`user-${Math.floor(Math.random()*10)+1}`,content_id:`content-${Math.floor(Math.random()*20)+1}`,progress_percentage:Math.random()*100,time_spent:Math.floor(Math.random()*120)+15,score:Math.random()>.3?Math.random()*40+60:void 0,engagement_score:Math.random()*.4+.6}))}catch(e){return console.error("Error getting historical learning data:",e),[]}})}getLearningCostData(){return sn(this,null,function*(){try{const{data:e}=yield d.from("learning_costs").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(1).single();if(e){const t=e;return{content_creation_costs:t.content_creation_costs,platform_costs:t.platform_costs,assessment_costs:t.assessment_costs,certification_costs:t.certification_costs,total_cost:t.total_cost}}return{content_creation_costs:15e3,platform_costs:5e3,assessment_costs:3e3,certification_costs:2e3,total_cost:25e3}}catch(e){return console.error("Error getting learning cost data:",e),{content_creation_costs:15e3,platform_costs:5e3,assessment_costs:3e3,certification_costs:2e3,total_cost:25e3}}})}calculateLearningEfficiency(e,t,r){const i=e*r/(t/60);return Math.min(i,1)}calculateEngagementScore(e){const t=e.time_spent_minutes||0,r=e.progress_percentage||0,i=e.attempts||1,a=Math.min(t/60,1),s=r/100,o=Math.max(0,1-(i-1)*.1);return a*.4+s*.4+o*.2}calculateRetentionRate(e,t){if(e.length!==t.length)return 0;const r=e.map((i,a)=>t[a]/i);return r.reduce((i,a)=>i+a,0)/r.length}calculateSkillProgression(e){const t={};return Object.entries(e).forEach(([r,i])=>{if(i.length<2){t[r]="stable";return}const a=i.slice(0,Math.ceil(i.length/2)),s=i.slice(Math.ceil(i.length/2)),o=a.reduce((u,h)=>u+h,0)/a.length,n=s.reduce((u,h)=>u+h,0)/s.length,l=o-n;l>.1?t[r]="improving":l<-.1?t[r]="declining":t[r]="stable"}),t}calculateLearningVelocity(e,t){return e/(t/7)}calculateKnowledgeDecayRate(e,t,r){if(r===0)return 0;const i=t/e;return i<=0?1:-Math.log(i)/r}calculateAdaptiveDifficultyAdjustment(e,t,r){const a=(e-t)*.1;return Math.max(0,Math.min(1,r+a))}detectLearningPatterns(e){const t=e.map(p=>p.content_id.split("-")[0]),r=e.map(p=>new Date(p.date).getHours()),i=t.reduce((p,y)=>(p[y]=(p[y]||0)+1,p),{}),a=Object.entries(i).sort(([,p],[,y])=>y-p).slice(0,3).map(([p])=>p),s=r.reduce((p,y)=>(p[y]=(p[y]||0)+1,p),{}),o=Object.entries(s).sort(([,p],[,y])=>y-p).slice(0,2).map(([p])=>`${p}:00`),n=Array.from(new Set(e.map(p=>p.date.split("T")[0]))).sort();let l=0,u=1;for(let p=1;p<n.length;p++){const y=new Date(n[p-1]);(new Date(n[p]).getTime()-y.getTime())/(1e3*60*60*24)===1?u++:(l=Math.max(l,u),u=1)}l=Math.max(l,u);const h=e.map(p=>p.progress_percentage),f=h.reduce((p,y)=>p+y,0)/h.length;let m="intermediate";return f>90?m="advanced":f<60&&(m="beginner"),{preferredContentTypes:a,optimalStudyTimes:o,learningStreaks:l,difficultyPreferences:m}}getPriorityFromConfidence(e){return e>=.9?"critical":e>=.8?"high":e>=.7?"medium":"low"}getPriorityFromGapCount(e){return e>=5?"critical":e>=3?"high":e>=1?"medium":"low"}getPriorityFromEfficiency(e){return e>=.9?"critical":e>=.8?"high":e>=.7?"medium":"low"}getPriorityFromPerformance(e){return e>=.9?"critical":e>=.8?"high":e>=.7?"medium":"low"}}var ai={},$e=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Wi{constructor(e){this.facilityId=e}processPersonalizedRecommendationsWithAI(){return $e(this,null,function*(){return{recommended_content:["infection_control_basics","sterilization_protocols_advanced","environmental_cleaning_standards"],recommendation_reasoning:["Based on your role as environmental services technician","Addresses identified skill gaps in infection control","Builds on your completed sterilization fundamentals course"],confidence_scores:[.92,.85,.78],learning_path_suggestions:["Complete infection control basics first","Then proceed to advanced sterilization protocols","Finish with environmental cleaning standards"],skill_development_areas:["Infection control protocols","Advanced sterilization techniques","Environmental monitoring"],estimated_completion_time:120,difficulty_progression:["beginner","intermediate","advanced"],alternative_recommendations:["safety_protocols_fundamentals","equipment_maintenance_basics"],confidence_score:.87}})}processSkillGapAnalysisWithAI(){return $e(this,null,function*(){return{current_skills:{basic_cleaning:.8,safety_protocols:.6,infection_control:.4,equipment_operation:.7,documentation:.5},required_skills:{basic_cleaning:.9,safety_protocols:.9,infection_control:.8,equipment_operation:.8,documentation:.8,advanced_sterilization:.7,environmental_monitoring:.6},skill_gaps:{infection_control:.4,documentation:.3,advanced_sterilization:.7,environmental_monitoring:.6},gap_priorities:["infection_control","advanced_sterilization","environmental_monitoring","documentation"],learning_recommendations:["Complete infection control certification course","Take advanced sterilization protocols training","Enroll in environmental monitoring workshop","Practice documentation best practices"],skill_development_plan:["Week 1-2: Infection control fundamentals","Week 3-4: Advanced sterilization techniques","Week 5-6: Environmental monitoring protocols","Week 7-8: Documentation and reporting"],estimated_learning_time:160,confidence_score:.82}})}processLearningPathOptimizationWithAI(){return $e(this,null,function*(){return{optimized_learning_path:["safety_fundamentals","infection_control_basics","sterilization_protocols","environmental_cleaning_standards","advanced_sterilization_techniques","quality_assurance_protocols"],path_efficiency_score:.88,estimated_total_time:180,difficulty_progression:["beginner","beginner","intermediate","intermediate","advanced","advanced"],prerequisite_mapping:{infection_control_basics:["safety_fundamentals"],sterilization_protocols:["infection_control_basics"],environmental_cleaning_standards:["sterilization_protocols"],advanced_sterilization_techniques:["environmental_cleaning_standards"],quality_assurance_protocols:["advanced_sterilization_techniques"]},alternative_paths:[["safety_fundamentals","equipment_operation","sterilization_protocols"],["safety_fundamentals","documentation_basics","infection_control_basics"]],optimization_factors:["Prerequisite knowledge alignment","Learning curve optimization","Time efficiency","Skill progression logic"],confidence_score:.85}})}processPerformancePredictionWithAI(){return $e(this,null,function*(){return{predicted_performance:.82,predicted_completion_time:45,success_probability:.78,risk_factors:["Limited experience with advanced sterilization","Time constraints for study sessions","Complex technical concepts in later modules"],improvement_suggestions:["Allocate additional study time for complex topics","Seek hands-on practice opportunities","Connect with experienced colleagues for guidance","Break down complex topics into smaller sessions"],study_recommendations:["Study in 30-minute focused sessions","Review prerequisite materials before starting","Take practice quizzes regularly","Join study groups for peer learning"],confidence_score:.79}})}processAdaptiveDifficultyWithAI(){return $e(this,null,function*(){return{recommended_difficulty:"intermediate",difficulty_adjustment:.2,learning_curve_analysis:"User shows strong grasp of fundamentals but needs more practice with intermediate concepts",adaptation_reasoning:["High performance on basic safety protocols (95% accuracy)","Moderate performance on infection control (78% accuracy)","Struggling with advanced sterilization concepts (65% accuracy)","Consistent engagement and completion rates"],performance_indicators:{quiz_accuracy:.78,completion_rate:.92,engagement_time:.85,retention_score:.73},next_difficulty_target:"advanced",confidence_score:.81}})}processEngagementAnalysisWithAI(){return $e(this,null,function*(){return{engagement_score:.76,engagement_trends:{video_content:.85,interactive_quizzes:.78,text_reading:.65,simulations:.92},engagement_factors:["Interactive content increases engagement","Visual learning materials are preferred","Practical simulations maintain interest","Short, focused sessions work best"],disengagement_triggers:["Long text-heavy modules","Complex technical jargon without explanation","Lack of immediate feedback","Repetitive content format"],improvement_suggestions:["Increase use of interactive simulations","Break down text content into smaller chunks","Add more visual aids and diagrams","Provide immediate feedback on quizzes"],optimal_learning_times:["Morning sessions (9-11 AM)","Afternoon sessions (2-4 PM)"],content_preferences:["Video demonstrations","Interactive simulations","Case study examples","Hands-on practice exercises"],confidence_score:.83}})}processRetentionPredictionWithAI(){return $e(this,null,function*(){return{retention_probability:.72,knowledge_decay_rate:.15,review_recommendations:["Review infection control protocols weekly","Practice sterilization procedures monthly","Take refresher quizzes every 2 weeks","Attend hands-on workshops quarterly"],reinforcement_schedule:["Week 1: Initial review of key concepts","Week 2: Practice quiz on fundamentals","Month 1: Comprehensive review session","Month 3: Advanced application practice"],retention_factors:["Regular practice and application","Immediate feedback on performance","Spaced repetition of key concepts","Real-world application opportunities"],forgetting_risk_areas:["Complex sterilization parameters","Specific compliance requirements","Equipment operation procedures","Emergency response protocols"],confidence_score:.77}})}processLearningAnalyticsWithAI(){return $e(this,null,function*(){return{learning_efficiency_score:.81,preferred_content_categories:["interactive_simulations","video_demonstrations","case_studies","hands_on_practice"],optimal_study_duration:30,learning_patterns:{peak_performance_hours:"9-11 AM, 2-4 PM",preferred_session_length:"25-35 minutes",break_frequency:"every 45 minutes",review_preference:"immediate after completion"},progress_trends:{completion_rate:"increasing",quiz_accuracy:"stable",engagement_level:"improving",retention_rate:"declining"},performance_metrics:{overall_completion:.88,quiz_average:.82,engagement_score:.76,retention_rate:.68},insights:["User performs best with interactive content","Morning sessions show higher engagement","Retention drops after 2 weeks without review","Case studies improve practical application"],recommendations:["Schedule more interactive content","Implement spaced repetition for retention","Add more case study examples","Optimize study session timing"],confidence_score:.84}})}buildPersonalizedRecommendationPrompt(e,t,r){return`Generate personalized learning recommendations based on:
  User Profile: ${e}
  Learning History: ${t}
  Skill Gaps: ${r}
  
  Please provide:
  1. Recommended content based on role and interests
  2. Reasoning for each recommendation
  3. Confidence scores for recommendations
  4. Learning path suggestions
  5. Skill development areas to focus on
  6. Estimated completion time
  7. Difficulty progression
  8. Alternative recommendations`}buildSkillGapAnalysisPrompt(e,t,r){return`Analyze skill gaps based on:
  Current Skills: ${e}
  Required Skills: ${t}
  Role Requirements: ${r}
  
  Please provide:
  1. Current skill levels assessment
  2. Required skill levels for role
  3. Identified skill gaps with priority levels
  4. Learning recommendations to address gaps
  5. Skill development plan with timeline
  6. Estimated learning time required
  7. Confidence score for analysis`}buildLearningPathOptimizationPrompt(e,t,r){return`Optimize learning path based on:
  User Goals: ${e}
  Available Content: ${t}
  Constraints: ${r}
  
  Please provide:
  1. Optimized learning path sequence
  2. Path efficiency score
  3. Estimated total completion time
  4. Difficulty progression through path
  5. Prerequisite mapping
  6. Alternative path options
  7. Optimization factors considered
  8. Confidence score for optimization`}buildPerformancePredictionPrompt(e,t,r){return`Predict learning performance based on:
  User Profile: ${e}
  Content Information: ${t}
  Historical Performance: ${r}
  
  Please provide:
  1. Predicted performance score
  2. Predicted completion time
  3. Success probability
  4. Risk factors that may impact performance
  5. Improvement suggestions
  6. Study recommendations
  7. Confidence score for prediction`}executeWithRetry(e,t=3,r=100){return $e(this,null,function*(){const{OptimizedRetryService:i}=yield T(()=>Promise.resolve().then(()=>rc),void 0);return yield i.executeWithRetry(e,{maxRetries:t,baseDelay:r,backoffStrategy:"linear",retryCondition:a=>a.message.includes("network")||a.message.includes("timeout")||a.message.includes("rate limit")||a.message.includes("temporary")}).then(a=>{if(!a.success)throw a.error;return a.data})})}executeWithTimeout(e,t=3e4){return $e(this,null,function*(){const r=new Promise((i,a)=>{setTimeout(()=>a(new Error("Operation timed out")),t)});return Promise.race([e,r])})}selectModelForTask(e){switch(e){case"recommendation":return"gpt-4";case"skill_gap":return"gpt-4";case"path_optimization":return"gpt-4";case"performance_prediction":return"gpt-4";case"adaptive_difficulty":return"gpt-4";case"engagement_analysis":return"gpt-4";case"retention_prediction":return"gpt-4";case"learning_analytics":return"gpt-4";default:return"gpt-4"}}getProviderConfig(e){const t={openai:{baseUrl:ai.OPENAI_API_BASE_URL||"https://api.openai.com/v1",timeout:3e4,maxRetries:3,model:"gpt-4"},google:{baseUrl:ai.GOOGLE_AI_API_BASE_URL||"https://generativelanguage.googleapis.com/v1",timeout:3e4,maxRetries:3,model:"gemini-pro"},azure:{baseUrl:ai.AZURE_OPENAI_ENDPOINT||"",timeout:3e4,maxRetries:3,model:"gpt-4"},custom:{baseUrl:ai.CUSTOM_AI_ENDPOINT||"",timeout:3e4,maxRetries:3,model:"custom"}};return t[e]||t.openai}}const fu={ai_enabled:!1,ai_version:"1.0.0",personalized_recommendations:!1,skill_gap_analysis:!1,learning_path_optimization:!1,performance_prediction:!1,adaptive_difficulty:!1,learning_analytics_enabled:!1,behavior_tracking:!1,progress_prediction:!1,engagement_metrics:!1,retention_analysis:!1,ai_confidence_threshold:.8,recommendation_limit:5,data_retention_days:365,model_version:"v1.0",data_sharing_enabled:!1,local_ai_processing_enabled:!1,encrypted_data_transmission:!0,ai_model_training:!1},mu={NO_DATA_FOUND:"PGRST116"},Wt={DIFFICULTY_LEVEL:"beginner",USER_ROLE:"user",DEPARTMENT:"general",EXPERIENCE_LEVEL:"entry",LEARNING_STYLE:"visual",TIME_AVAILABILITY:30},pu={LEARNING_PROGRESS_DATA:100};function gu(c){var e,t,r,i,a,s,o,n,l,u,h;return{id:(e=c.id)!=null?e:"",user_id:(t=c.user_id)!=null?t:"",role:(r=c.role)!=null?r:Wt.USER_ROLE,department:(i=c.department)!=null?i:Wt.DEPARTMENT,experience_level:(a=c.experience_level)!=null?a:Wt.EXPERIENCE_LEVEL,skill_areas:(s=c.skill_areas)!=null?s:[],learning_goals:(o=c.learning_goals)!=null?o:[],preferred_learning_style:(n=c.preferred_learning_style)!=null?n:Wt.LEARNING_STYLE,time_availability:(l=c.time_availability)!=null?l:Wt.TIME_AVAILABILITY,last_updated:(h=(u=c.updated_at)!=null?u:c.created_at)!=null?h:""}}function ct(c){return Date.now()-c}function yu(c){return Array.isArray(c)?c.join("; "):c}function _u(c){return c.split("; ").filter(e=>e.trim().length>0)}function We(){return new Date().toISOString()}var vu=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class wu{constructor(e){this.facilityId=e,this.providerService=new Wi(e)}generatePersonalizedRecommendations(e){return vu(this,null,function*(){var t,r,i,a,s,o,n,l,u,h,f,m,p;try{const y=Date.now(),g=yield this.providerService.processPersonalizedRecommendationsWithAI(),_=ct(y),w={facility_id:this.facilityId,user_id:e,recommended_content:g.recommended_content,recommendation_reasoning:g.recommendation_reasoning,confidence_scores:g.confidence_scores,learning_path_suggestions:g.learning_path_suggestions,skill_development_areas:g.skill_development_areas,estimated_completion_time:g.estimated_completion_time,difficulty_progression:g.difficulty_progression,alternative_recommendations:g.alternative_recommendations,confidence_score:g.confidence_score,processing_time_ms:_,created_at:We()},E={facility_id:w.facility_id,user_id:w.user_id,recommended_content:w.recommended_content,recommendation_reasoning:yu(w.recommendation_reasoning),confidence_scores:w.confidence_scores,learning_path_suggestions:w.learning_path_suggestions,skill_development_areas:w.skill_development_areas,estimated_completion_time:w.estimated_completion_time,difficulty_progression:w.difficulty_progression,alternative_recommendations:w.alternative_recommendations,confidence_score:w.confidence_score,processing_time_ms:w.processing_time_ms,created_at:w.created_at},{data:b,error:P}=yield d.from("learning_ai_personalized_recommendations").insert(E).select().single();if(P)return console.error("Error saving personalized recommendation result:",P),null;if(!b)return null;const S=b;return{id:(t=S.id)!=null?t:"",facility_id:(r=S.facility_id)!=null?r:"",user_id:(i=S.user_id)!=null?i:"",recommended_content:(a=S.recommended_content)!=null?a:[],recommendation_reasoning:_u(S.recommendation_reasoning),confidence_scores:(s=S.confidence_scores)!=null?s:[],learning_path_suggestions:(o=S.learning_path_suggestions)!=null?o:[],skill_development_areas:(n=S.skill_development_areas)!=null?n:[],estimated_completion_time:(l=S.estimated_completion_time)!=null?l:0,difficulty_progression:(u=S.difficulty_progression)!=null?u:[],alternative_recommendations:(h=S.alternative_recommendations)!=null?h:[],confidence_score:(f=S.confidence_score)!=null?f:0,processing_time_ms:(m=S.processing_time_ms)!=null?m:0,created_at:(p=S.created_at)!=null?p:""}}catch(y){return console.error("Error generating personalized recommendations:",y),null}})}}var Iu=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Su{constructor(e){this.facilityId=e,this.providerService=new Wi(e)}analyzeSkillGaps(e){return Iu(this,null,function*(){var t,r,i,a,s,o,n,l,u,h,f,m,p;try{const y=Date.now(),g=yield this.providerService.processSkillGapAnalysisWithAI(),_=ct(y),w={facility_id:this.facilityId,user_id:e,current_skills:g.current_skills,required_skills:g.required_skills,skill_gaps:g.skill_gaps,gap_priorities:g.gap_priorities,learning_recommendations:g.learning_recommendations,skill_development_plan:g.skill_development_plan,estimated_learning_time:g.estimated_learning_time,confidence_score:g.confidence_score,processing_time_ms:_,created_at:We()},E={facility_id:w.facility_id,user_id:w.user_id,current_skills:w.current_skills,required_skills:w.required_skills,skill_gaps:w.skill_gaps,gap_priorities:w.gap_priorities,learning_recommendations:w.learning_recommendations,skill_development_plan:w.skill_development_plan,estimated_learning_time:w.estimated_learning_time,confidence_score:w.confidence_score,processing_time_ms:w.processing_time_ms,created_at:w.created_at},{data:b,error:P}=yield d.from("learning_ai_skill_gap_analysis").insert(E).select().single();if(P)return console.error("Error saving skill gap analysis result:",P),null;if(!b)return null;const S=b;return{id:(t=S.id)!=null?t:"",facility_id:(r=S.facility_id)!=null?r:"",user_id:(i=S.user_id)!=null?i:"",current_skills:(a=S.current_skills)!=null?a:{},required_skills:(s=S.required_skills)!=null?s:{},skill_gaps:(o=S.skill_gaps)!=null?o:{},gap_priorities:(n=S.gap_priorities)!=null?n:[],learning_recommendations:(l=S.learning_recommendations)!=null?l:[],skill_development_plan:(u=S.skill_development_plan)!=null?u:[],estimated_learning_time:(h=S.estimated_learning_time)!=null?h:0,confidence_score:(f=S.confidence_score)!=null?f:0,processing_time_ms:(m=S.processing_time_ms)!=null?m:0,created_at:(p=S.created_at)!=null?p:""}}catch(y){return console.error(y),console.error("Error analyzing skill gaps"),null}})}}var bu=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Eu{constructor(e){this.facilityId=e,this.providerService=new Wi(e)}optimizeLearningPath(e){return bu(this,null,function*(){var t,r,i,a,s,o,n,l,u,h,f,m,p;try{const y=Date.now(),g=yield this.providerService.processLearningPathOptimizationWithAI(),_=ct(y),w={facility_id:this.facilityId,user_id:e,optimized_learning_path:g.optimized_learning_path,path_efficiency_score:g.path_efficiency_score,estimated_total_time:g.estimated_total_time,difficulty_progression:g.difficulty_progression,prerequisite_mapping:g.prerequisite_mapping,alternative_paths:g.alternative_paths,optimization_factors:g.optimization_factors,confidence_score:g.confidence_score,processing_time_ms:_,created_at:We()},E={facility_id:w.facility_id,user_id:w.user_id,optimized_learning_path:w.optimized_learning_path,path_efficiency_score:w.path_efficiency_score,estimated_total_time:w.estimated_total_time,difficulty_progression:w.difficulty_progression,prerequisite_mapping:w.prerequisite_mapping,alternative_paths:w.alternative_paths,optimization_factors:w.optimization_factors,confidence_score:w.confidence_score,processing_time_ms:w.processing_time_ms,created_at:w.created_at},{data:b,error:P}=yield d.from("learning_ai_path_optimization").insert(E).select().single();if(P)return console.error("Error saving learning path optimization result:",P),null;if(!b)return null;const S=b;return{id:(t=S.id)!=null?t:"",facility_id:(r=S.facility_id)!=null?r:"",user_id:(i=S.user_id)!=null?i:"",optimized_learning_path:(a=S.optimized_learning_path)!=null?a:[],path_efficiency_score:(s=S.path_efficiency_score)!=null?s:0,estimated_total_time:(o=S.estimated_total_time)!=null?o:0,difficulty_progression:(n=S.difficulty_progression)!=null?n:[],prerequisite_mapping:(l=S.prerequisite_mapping)!=null?l:{},alternative_paths:(u=S.alternative_paths)!=null?u:[],optimization_factors:(h=S.optimization_factors)!=null?h:[],confidence_score:(f=S.confidence_score)!=null?f:0,processing_time_ms:(m=S.processing_time_ms)!=null?m:0,created_at:(p=S.created_at)!=null?p:""}}catch(y){return console.error("Error optimizing learning path:",y),null}})}}var br=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Au{constructor(e){this.facilityId=e,this.providerService=new Wi(e)}predictPerformance(e,t){return br(this,null,function*(){var r,i,a,s,o,n,l,u,h,f;try{const m=Date.now(),p=yield this.providerService.processPerformancePredictionWithAI(),y=ct(m),g={facility_id:this.facilityId,user_id:e,content_id:t,predicted_performance:p.predicted_performance,predicted_completion_time:p.predicted_completion_time,success_probability:p.success_probability,risk_factors:p.risk_factors,improvement_suggestions:p.improvement_suggestions,study_recommendations:p.study_recommendations,confidence_score:p.confidence_score,processing_time_ms:y,created_at:We()},_={facility_id:g.facility_id,user_id:g.user_id,content_id:g.content_id,predicted_performance:g.predicted_performance,confidence_score:g.confidence_score,improvement_suggestions:g.improvement_suggestions,predicted_completion_time:g.predicted_completion_time,processing_time_ms:g.processing_time_ms,created_at:g.created_at},{data:w,error:E}=yield d.from("learning_ai_performance_prediction").insert(_).select().single();if(E)return console.error("Error saving performance prediction result:",E),null;if(!w)return null;const b=w;return{id:(r=b.id)!=null?r:"",facility_id:(i=b.facility_id)!=null?i:"",user_id:(a=b.user_id)!=null?a:"",content_id:(s=b.content_id)!=null?s:"",predicted_performance:(o=b.predicted_performance)!=null?o:0,predicted_completion_time:(n=b.predicted_completion_time)!=null?n:0,success_probability:0,risk_factors:[],improvement_suggestions:(l=b.improvement_suggestions)!=null?l:[],study_recommendations:[],confidence_score:(u=b.confidence_score)!=null?u:0,processing_time_ms:(h=b.processing_time_ms)!=null?h:0,created_at:(f=b.created_at)!=null?f:""}}catch(m){return console.error("Error predicting performance:",m),null}})}adjustDifficulty(e,t){return br(this,null,function*(){var r,i,a,s,o,n,l;try{const u=Date.now(),h=yield this.providerService.processAdaptiveDifficultyWithAI(),f=ct(u),m={facility_id:this.facilityId,user_id:e,content_id:t,recommended_difficulty:h.recommended_difficulty,difficulty_adjustment:h.difficulty_adjustment,learning_curve_analysis:h.learning_curve_analysis,adaptation_reasoning:h.adaptation_reasoning,performance_indicators:h.performance_indicators,next_difficulty_target:h.next_difficulty_target,confidence_score:h.confidence_score,processing_time_ms:f,created_at:We()},p={facility_id:m.facility_id,user_id:m.user_id,content_id:m.content_id,recommended_difficulty:m.recommended_difficulty,difficulty_adjustment:m.difficulty_adjustment,learning_curve_analysis:m.learning_curve_analysis,adaptation_reasoning:m.adaptation_reasoning,performance_indicators:m.performance_indicators,next_difficulty_target:m.next_difficulty_target,confidence_score:m.confidence_score,processing_time_ms:m.processing_time_ms,created_at:m.created_at},{data:y,error:g}=yield d.from("learning_ai_adaptive_difficulty").insert(p).select().single();if(g)return console.error("Error saving adaptive difficulty result:",g),null;if(!y)return null;const _=y;return{recommended_difficulty:(r=_.recommended_difficulty)!=null?r:Wt.DIFFICULTY_LEVEL,difficulty_adjustment:(i=_.difficulty_adjustment)!=null?i:0,learning_curve_analysis:(a=_.learning_curve_analysis)!=null?a:"",adaptation_reasoning:(s=_.adaptation_reasoning)!=null?s:[],performance_indicators:(o=_.performance_indicators)!=null?o:{},next_difficulty_target:(n=_.next_difficulty_target)!=null?n:"",confidence_score:(l=_.confidence_score)!=null?l:0}}catch(u){return console.error("Error adjusting difficulty:",u),null}})}analyzeEngagement(e){return br(this,null,function*(){var t,r,i,a,s,o,n,l;try{const u=Date.now(),h=yield this.providerService.processEngagementAnalysisWithAI(),f=ct(u),m={facility_id:this.facilityId,user_id:e,engagement_score:h.engagement_score,engagement_trends:h.engagement_trends,engagement_factors:h.engagement_factors,disengagement_triggers:h.disengagement_triggers,improvement_suggestions:h.improvement_suggestions,optimal_learning_times:h.optimal_learning_times,content_preferences:h.content_preferences,confidence_score:h.confidence_score,processing_time_ms:f,created_at:We()},p={facility_id:m.facility_id,user_id:m.user_id,engagement_score:m.engagement_score,engagement_trends:m.engagement_trends,engagement_factors:m.engagement_factors,disengagement_triggers:m.disengagement_triggers,improvement_suggestions:m.improvement_suggestions,optimal_learning_times:m.optimal_learning_times,content_preferences:m.content_preferences,confidence_score:m.confidence_score,processing_time_ms:m.processing_time_ms,created_at:m.created_at},{data:y,error:g}=yield d.from("learning_ai_engagement_analysis").insert(p).select().single();if(g)return console.error("Error saving engagement analysis result:",g),null;if(!y)return null;const _=y;return{engagement_score:(t=_.engagement_score)!=null?t:0,engagement_trends:(r=_.engagement_trends)!=null?r:{},engagement_factors:(i=_.engagement_factors)!=null?i:[],disengagement_triggers:(a=_.disengagement_triggers)!=null?a:[],improvement_suggestions:(s=_.improvement_suggestions)!=null?s:[],optimal_learning_times:(o=_.optimal_learning_times)!=null?o:[],content_preferences:(n=_.content_preferences)!=null?n:[],confidence_score:(l=_.confidence_score)!=null?l:0}}catch(u){return console.error("Error analyzing engagement:",u),null}})}predictRetention(e){return br(this,null,function*(){var t,r,i,a,s,o,n;try{const l=Date.now(),u=yield this.providerService.processRetentionPredictionWithAI(),h=ct(l),f={facility_id:this.facilityId,user_id:e,retention_probability:u.retention_probability,knowledge_decay_rate:u.knowledge_decay_rate,review_recommendations:u.review_recommendations,reinforcement_schedule:u.reinforcement_schedule,retention_factors:u.retention_factors,forgetting_risk_areas:u.forgetting_risk_areas,confidence_score:u.confidence_score,processing_time_ms:h,created_at:We()},m={facility_id:f.facility_id,user_id:f.user_id,retention_probability:f.retention_probability,knowledge_decay_rate:f.knowledge_decay_rate,review_recommendations:f.review_recommendations,reinforcement_schedule:f.reinforcement_schedule,retention_factors:f.retention_factors,forgetting_risk_areas:f.forgetting_risk_areas,confidence_score:f.confidence_score,processing_time_ms:f.processing_time_ms,created_at:f.created_at},{data:p,error:y}=yield d.from("learning_ai_retention_prediction").insert(m).select().single();if(y)return console.error("Error saving retention prediction result:",y),null;if(!p)return null;const g=p;return{retention_probability:(t=g.retention_probability)!=null?t:0,knowledge_decay_rate:(r=g.knowledge_decay_rate)!=null?r:0,review_recommendations:(i=g.review_recommendations)!=null?i:[],reinforcement_schedule:(a=g.reinforcement_schedule)!=null?a:[],retention_factors:(s=g.retention_factors)!=null?s:[],forgetting_risk_areas:(o=g.forgetting_risk_areas)!=null?o:[],confidence_score:(n=g.confidence_score)!=null?n:0}}catch(l){return console.error("Error predicting retention:",l),null}})}generateLearningAnalytics(e){return br(this,null,function*(){var t,r,i,a,s,o,n,l,u;try{const h=Date.now(),f=yield this.providerService.processLearningAnalyticsWithAI(),m=ct(h),p={facility_id:this.facilityId,user_id:e,learning_efficiency_score:f.learning_efficiency_score,preferred_content_categories:f.preferred_content_categories,optimal_study_duration:f.optimal_study_duration,learning_patterns:f.learning_patterns,progress_trends:f.progress_trends,performance_metrics:f.performance_metrics,insights:f.insights,recommendations:f.recommendations,confidence_score:f.confidence_score,processing_time_ms:m,created_at:We()},y={facility_id:p.facility_id,user_id:p.user_id,learning_efficiency_score:p.learning_efficiency_score,preferred_content_categories:p.preferred_content_categories,optimal_study_duration:p.optimal_study_duration,learning_patterns:p.learning_patterns,progress_trends:p.progress_trends,performance_metrics:p.performance_metrics,insights:p.insights,recommendations:p.recommendations,confidence_score:p.confidence_score,processing_time_ms:p.processing_time_ms,created_at:p.created_at},{data:g,error:_}=yield d.from("learning_ai_analytics").insert(y).select().single();if(_)return console.error("Error saving learning analytics result:",_),null;if(!g)return null;const w=g;return{learning_efficiency_score:(t=w.learning_efficiency_score)!=null?t:0,preferred_content_categories:(r=w.preferred_content_categories)!=null?r:[],optimal_study_duration:(i=w.optimal_study_duration)!=null?i:0,learning_patterns:(a=w.learning_patterns)!=null?a:{},progress_trends:(s=w.progress_trends)!=null?s:{},performance_metrics:(o=w.performance_metrics)!=null?o:{},insights:(n=w.insights)!=null?n:[],recommendations:(l=w.recommendations)!=null?l:[],confidence_score:(u=w.confidence_score)!=null?u:0}}catch(h){return console.error("Error generating learning analytics:",h),null}})}}var Tu=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function xn(c){return Tu(this,arguments,function*({facilityId:e,userId:t,module:r,action:i,details:a}){try{const{error:s}=yield d.from("security_audit_log").insert([{facility_id:e,user_id:t,object_schema:"public",object_table:"ai_settings",action:i,event_context:{module:r,details:a,source:"frontend"},happened_at:new Date().toISOString()}]);s?console.error("âŒ Audit log insert failed:",s):console.log("âœ… Audit event logged:",r,i)}catch(s){console.error("âŒ Unexpected audit log failure:",s)}})}var Ki=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function ku(c){return Ki(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings").select("*").eq("facility_id",c).eq("module","learning").single();return t?(t.code===mu.NO_DATA_FOUND||console.warn("Error loading learning AI settings:",t),null):e?e.settings:null}catch(e){return console.warn("Error loading learning AI settings:",e),null}})}function Cu(c,e){return Ki(this,null,function*(){try{const t={facility_id:c,module:"learning",settings:e,updated_at:We()},{error:r}=yield d.from("ai_settings").upsert(t,{onConflict:"facility_id,module"});return r?(console.error("Error saving learning AI settings:",r),!1):(!r&&t&&(yield xn({facilityId:c,userId:"system",module:"learning",action:"UPDATE",details:t})),!0)}catch(t){return console.error(t),console.error("Error saving learning AI settings"),!1}})}function Pu(c,e){return Ki(this,null,function*(){try{const{data:t,error:r}=yield d.from("learning_progress").select("*").eq("facility_id",c).eq("user_id",e).order("created_at",{ascending:!1}).limit(pu.LEARNING_PROGRESS_DATA);return r?(console.error("Error getting learning progress data:",r),[]):t||[]}catch(t){return console.error("Error getting learning progress data:",t),[]}})}function Du(c,e){return Ki(this,null,function*(){try{const{data:t,error:r}=yield d.from("user_profiles").select("*").eq("user_id",e).eq("facility_id",c).single();return r?(console.error("Error getting user profile:",r),null):t?gu(t):null}catch(t){return console.error("Error getting user profile:",t),null}})}function Je(c,e){return Ou(c,e)===!0}function Ou(c,e){return e.split(".").reduce((t,r)=>t==null?void 0:t[r],c)}var ne=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Ns{constructor(e){this.facilityId=e,this.analyticsService=new hu(e),this.recommendationService=new wu(e),this.knowledgeGapService=new Su(e),this.pathwayAnalysisService=new Eu(e),this.evaluationService=new Au(e)}initialize(){return ne(this,null,function*(){try{return(yield this.loadSettings())!==null}catch(e){return console.error(e),console.error("Failed to initialize LearningAIService"),!1}})}loadSettings(){return ne(this,null,function*(){return yield ku(this.facilityId)})}saveSettings(e){return ne(this,null,function*(){return yield Cu(this.facilityId,e)})}initializeSettings(){return ne(this,null,function*(){try{const e=fu;return yield this.saveSettings(e)}catch(e){return console.error(e),console.error("Error initializing learning AI settings"),!1}})}generatePersonalizedRecommendations(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!Je(t,"personalized_recommendations"))throw new Error("Personalized recommendations AI is not enabled");return yield this.recommendationService.generatePersonalizedRecommendations(e)}catch(t){return console.error("Error generating personalized recommendations:",t),null}})}analyzeSkillGaps(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!Je(t,"skill_gap_analysis"))throw new Error("Skill gap analysis AI is not enabled");return yield this.knowledgeGapService.analyzeSkillGaps(e)}catch(t){return console.error(t),console.error("Error analyzing skill gaps"),null}})}optimizeLearningPath(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!Je(t,"learning_path_optimization"))throw new Error("Learning path optimization AI is not enabled");return yield this.pathwayAnalysisService.optimizeLearningPath(e)}catch(t){return console.error("Error optimizing learning path:",t),null}})}predictPerformance(e,t){return ne(this,null,function*(){try{const r=yield this.loadSettings();if(!Je(r,"performance_prediction"))throw new Error("Performance prediction AI is not enabled");return yield this.evaluationService.predictPerformance(e,t)}catch(r){return console.error("Error predicting performance:",r),null}})}adjustDifficulty(e,t){return ne(this,null,function*(){try{const r=yield this.loadSettings();if(!Je(r,"adaptive_difficulty"))throw new Error("Adaptive difficulty AI is not enabled");return yield this.evaluationService.adjustDifficulty(e,t)}catch(r){return console.error("Error adjusting difficulty:",r),null}})}analyzeEngagement(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!Je(t,"engagement_metrics"))throw new Error("Engagement analysis AI is not enabled");return yield this.evaluationService.analyzeEngagement(e)}catch(t){return console.error("Error analyzing engagement:",t),null}})}predictRetention(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!Je(t,"retention_analysis"))throw new Error("Retention prediction AI is not enabled");return yield this.evaluationService.predictRetention(e)}catch(t){return console.error("Error predicting retention:",t),null}})}generateLearningAnalytics(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!Je(t,"learning_analytics_enabled"))throw new Error("Learning analytics AI is not enabled");return yield this.evaluationService.generateLearningAnalytics(e)}catch(t){return console.error("Error generating learning analytics:",t),null}})}getLearningInsights(){return ne(this,null,function*(){return this.analyticsService.getLearningInsights()})}getLearningProgressData(e){return ne(this,null,function*(){return yield Pu(this.facilityId,e)})}getUserProfile(e){return ne(this,null,function*(){return yield Du(this.facilityId,e)})}}var cn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Bn{constructor(e){this.facilityId=e}getInventoryInsights(){return cn(this,null,function*(){try{const e=[],{data:t}=yield d.from("inventory_ai_barcode_analysis").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);t&&t.forEach(i=>{e.push({type:"barcode_analysis",title:"Barcode Quality Assessment",description:`Barcode ${i.barcode_value} analyzed with ${(i.confidence_score*100).toFixed(1)}% confidence`,confidence:i.confidence_score||0,recommendations:i.recommendations||[],data:i,timestamp:i.created_at,priority:i.confidence_score<.7?"critical":i.confidence_score<.85?"high":"medium",id:i.id||`barcode-${Date.now()}`,actionable:!0})});const{data:r}=yield d.from("inventory_ai_demand_forecasting").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);return r&&r.forEach(i=>{e.push({type:"demand_forecast",title:"Demand Forecast",description:`${i.forecast_period} forecast: ${i.predicted_demand} units predicted`,confidence:i.confidence_score||0,recommendations:i.recommendations||[],data:i,timestamp:i.created_at,priority:i.confidence_score<.7?"critical":i.confidence_score<.85?"high":"medium",id:i.id||`forecast-${Date.now()}`,actionable:!0})}),e}catch(e){return console.error("Error getting inventory insights:",e),[]}})}getHistoricalInventoryData(){return cn(this,null,function*(){return Array.from({length:30},(e,t)=>({date:new Date(Date.now()-t*24*60*60*1e3).toISOString(),quantity:Math.floor(Math.random()*20)+10,transaction_type:"usage"}))})}getInventoryCostData(){return cn(this,null,function*(){return{purchasing_costs:8e3,storage_costs:4e3,transportation_costs:3e3,total_cost:15e3}})}detectBarcodeType(e){return e?e.length===13?"ean13":e.length===12?"upc":e.length===8?"ean8":"code128":"unknown"}assessBarcodeQuality(e){return e>=.9?"excellent":e>=.8?"good":e>=.7?"fair":"poor"}calculateInventoryTurns(e,t){return t===0?0:e/t}calculateStockoutRisk(e,t,r,i){const a=(e-i)/t;return a<=0?1:a<=r?.8:a<=r*1.5?.5:.2}calculateSafetyStock(e,t,r){const i=this.getZScore(r);return Math.ceil(e*t*i*.1)}calculateReorderPoint(e,t,r){return Math.ceil(e*t+r)}getZScore(e){return{.8:.84,.85:1.04,.9:1.28,.95:1.65,.99:2.33}[e]||1.28}}var ka=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Ru{constructor(e){this.facilityId=e}processImageWithAI(){return ka(this,null,function*(){return{confidence:.85,damage_detected:!1,damage_types:[],objects:["Surgical Scissors","Forceps"],confidence_scores:[.92,.88],classification:"medical_instruments",category:"surgical_tools",quality:"Good",condition:"Excellent",damage_description:null,recommendations:["Items appear to be in good condition","No visible damage detected"]}})}analyzeBarcodeWithAI(e){return ka(this,null,function*(){return{confidence:.95,damage_detected:!1,damage_types:[],objects:["Barcode Item"],confidence_scores:[.95],classification:"barcode_item",category:"scannable_item",quality:"Excellent",condition:"Good",damage_description:null,recommendations:["Barcode successfully read"]}})}}var ln=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class $u{constructor(e){this.facilityId=e}generateDemandForecastWithAI(){return ln(this,null,function*(){return[{predicted_demand:150,confidence_interval_lower:120,confidence_interval_upper:180,seasonal_factors:{winter:1.2,summer:.8},trend_analysis:"increasing",influencing_factors:["seasonal demand","market trends"],confidence_score:.85,accuracy_metrics:{mape:.13,rmse:12.5},recommendations:["Increase stock levels by 20%","Monitor demand closely"]},{predicted_demand:75,confidence_interval_lower:65,confidence_interval_upper:85,seasonal_factors:{winter:1,summer:1},trend_analysis:"stable",influencing_factors:["consistent demand","stable market"],confidence_score:.9,accuracy_metrics:{mape:.08,rmse:6.2},recommendations:["Maintain current stock levels","Focus on cost optimization"]}]})}generateStockoutRiskAnalysis(){return ln(this,null,function*(){return{highRiskItems:["item_001","item_003"],mediumRiskItems:["item_002"],lowRiskItems:["item_004","item_005"],overallRiskScore:.65}})}generateMaintenancePredictions(){return ln(this,null,function*(){return{urgentMaintenance:["equipment_001"],scheduledMaintenance:["equipment_002","equipment_003"],preventiveMaintenance:["equipment_004","equipment_005"]}})}}var un=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Mu{constructor(e){this.facilityId=e}generateCostOptimizationWithAI(){return un(this,null,function*(){return{current_cost:1e5,optimized_cost:85e3,cost_savings:15e3,savings_percentage:15,optimization_factors:{supplier_consolidation:.4,inventory_turnover:.3,storage_efficiency:.3},recommended_actions:["Consolidate suppliers for bulk discounts","Implement just-in-time inventory","Optimize storage layout"],implementation_timeline:"6 months",risk_assessment:"low",confidence_score:.88,roi_estimate:300}})}generateSmartCategorizationWithAI(){return un(this,null,function*(){return{suggested_category:"Surgical Instruments",suggested_subcategory:"Cutting Tools",category_confidence_score:.92,alternative_categories:["Medical Tools","Surgical Equipment"],categorization_reasoning:["Items are sharp cutting instruments","Commonly used in surgical procedures","Similar material composition"],form_fill_suggestions:{category:"Surgical Instruments",subcategory:"Cutting Tools",material:"Stainless Steel"},workflow_recommendations:["Store in sterile environment","Regular sharpening required","Handle with care"],confidence_score:.92}})}generateInventoryOptimizationRecommendations(){return un(this,null,function*(){return{reorderPoints:{item_001:50,item_002:25,item_003:75},safetyStock:{item_001:20,item_002:10,item_003:30},maxStockLevels:{item_001:200,item_002:100,item_003:300}}})}}var Ne=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class jn{constructor(e){this.facilityId=e,this.imageProcessingService=new Ru(e),this.forecastingService=new $u(e),this.optimizationService=new Mu(e)}processImageWithAI(){return Ne(this,null,function*(){return yield this.imageProcessingService.processImageWithAI()})}analyzeBarcodeWithAI(e){return Ne(this,null,function*(){return yield this.imageProcessingService.analyzeBarcodeWithAI(e)})}generateDemandForecastWithAI(){return Ne(this,null,function*(){return yield this.forecastingService.generateDemandForecastWithAI()})}generateStockoutRiskAnalysis(){return Ne(this,null,function*(){return yield this.forecastingService.generateStockoutRiskAnalysis()})}generateMaintenancePredictions(){return Ne(this,null,function*(){return yield this.forecastingService.generateMaintenancePredictions()})}generateCostOptimizationWithAI(){return Ne(this,null,function*(){return yield this.optimizationService.generateCostOptimizationWithAI()})}generateSmartCategorizationWithAI(){return Ne(this,null,function*(){return yield this.optimizationService.generateSmartCategorizationWithAI()})}generateInventoryOptimizationRecommendations(){return Ne(this,null,function*(){return yield this.optimizationService.generateInventoryOptimizationRecommendations()})}getComprehensiveAIInsights(){return Ne(this,null,function*(){const e=yield this.generateDemandForecastWithAI(),t=yield this.generateStockoutRiskAnalysis(),r=yield this.generateMaintenancePredictions();return{demandForecast:e,stockoutRisk:t,maintenancePredictions:r,costTrends:{trend:"decreasing",percentageChange:-5.2,confidence:.85},seasonalPatterns:{patterns:["Q4 peak","Summer dip"],confidence:.78}}})}}const dn=.85,qu=2160*60*60*1e3,oi=365*24*60*60*1e3,zu="30_days",Uu=10,Fu=5,Lu="maintenance-1",Nu=[{month:"Jan",cost:1e3,trend:"stable"},{month:"Feb",cost:1200,trend:"increasing"}],xs="Uncategorized",Vn="Unknown",xu="Unknown Equipment",Er={csv:"text/csv",excel:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",pdf:"application/pdf",json:"application/json",default:"text/plain"},Bu="good",ju="good",Vu=["Increase inventory levels for low stock items.","Review maintenance schedules."],Hu="low";var Ca=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Gu{constructor(e){this.facilityId=e,this.providerService=new jn(e)}generateCostOptimization(e){return Ca(this,null,function*(){try{const t=Date.now(),r=yield this.providerService.generateCostOptimizationWithAI(),i=Date.now()-t,a={facility_id:this.facilityId,optimization_type:e,current_cost:r.current_cost,optimized_cost:r.optimized_cost,cost_savings:r.cost_savings,savings_percentage:r.savings_percentage,optimization_factors:r.optimization_factors,recommended_actions:r.recommended_actions,implementation_timeline:r.implementation_timeline,risk_assessment:r.risk_assessment,confidence_score:r.confidence_score,processing_time_ms:i,data_analysis_period:zu,roi_estimate:r.roi_estimate},{data:s,error:o}=yield d.from("inventory_ai_cost_optimization").insert(a).select().single();return o?(console.error("Error saving cost optimization:",o),null):s}catch(t){return console.error("Error generating cost optimization:",t),null}})}categorizeItem(e,t){return Ca(this,null,function*(){try{const r=Date.now(),i=yield this.providerService.generateSmartCategorizationWithAI(),a=Date.now()-r,s={facility_id:this.facilityId,suggested_category:i.suggested_category,suggested_subcategory:i.suggested_subcategory,category_confidence_score:i.category_confidence_score,alternative_categories:i.alternative_categories,categorization_reasoning:i.categorization_reasoning,form_fill_suggestions:i.form_fill_suggestions,workflow_recommendations:i.workflow_recommendations,confidence_score:i.confidence_score,processing_time_ms:a,input_data_type:t,learning_feedback:!1,user_acceptance:void 0},{data:o,error:n}=yield d.from("inventory_ai_smart_categorization").insert(s).select().single();return n?(console.error("Error saving smart categorization:",n),null):o}catch(r){return console.error("Error categorizing item:",r),null}})}}var Pa=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Wu{constructor(e){this.facilityId=e,this.analyticsService=new Bn(e),this.providerService=new jn(e)}analyzeBarcode(e,t){return Pa(this,null,function*(){try{const r=Date.now(),i=yield this.providerService.processImageWithAI(),a=Date.now()-r,s={facility_id:this.facilityId,barcode_value:t,barcode_type:this.analyticsService.detectBarcodeType(t),quality_rating:this.analyticsService.assessBarcodeQuality(i.confidence),readability_score:i.confidence||dn,damage_detected:i.damage_detected||!1,damage_types:i.damage_types||[],confidence_score:i.confidence||dn,processing_time_ms:a,image_file_path:"placeholder_path",ai_insights:i,recommendations:i.recommendations||[]},{data:o,error:n}=yield d.from("inventory_ai_barcode_analysis").insert(s).select().single();return n?(console.error("Error saving barcode analysis:",n),null):o}catch(r){return console.error("Error analyzing barcode:",r),null}})}analyzeImage(e){return Pa(this,null,function*(){try{const t=Date.now(),r=yield this.providerService.processImageWithAI(),i=Date.now()-t,a={facility_id:this.facilityId,recognized_objects:r.objects||[],object_confidence_scores:r.confidence_scores||[],item_classification:r.classification,category_suggestion:r.category,quality_assessment:r.quality||Bu,damage_detected:r.damage_detected||!1,damage_description:r.damage_description||void 0,condition_rating:r.condition||ju,confidence_score:r.confidence||dn,processing_time_ms:i,image_file_path:"placeholder_path",ai_insights:r,recommendations:r.recommendations||[]},{data:s,error:o}=yield d.from("inventory_ai_image_recognition").insert(a).select().single();return o?(console.error("Error saving image recognition:",o),null):s}catch(t){return console.error("Error analyzing image:",t),null}})}}function Ku(c){return c.reduce((e,t)=>{const r=t.category||xs;return e[r]||(e[r]=0),e[r]=e[r]+1,e},{})}function Qu(c){return c.reduce((e,t)=>{const r=t.category||xs;return e[r]=(e[r]||0)+(t.amount||0),e},{})}function Yu(c){return c.reduce((e,t)=>{const r=t.type||Vn;return e[r]=(e[r]||0)+1,e},{})}function Ju(c){return c.filter(e=>{var t;return(e.quantity||0)<(((t=e.data)==null?void 0:t.min_quantity)||0)}).map(e=>{var t;return{id:e.id||"",name:e.name||"",current_stock:e.quantity||0,reorder_point:((t=e.data)==null?void 0:t.min_quantity)||0}})}function Xu(c){return c.sort((e,t)=>(t.value||0)-(e.value||0)).slice(0,Uu).map(e=>({id:e.id||"",name:e.name||"",value:e.value||0,category:e.category||Vn}))}function Zu(c){return c.slice(0,Fu).map(e=>({id:Lu,equipment_name:e.equipment_name||xu,due_date:e.due_date||new Date().toISOString(),type:e.type||Vn}))}function ed(c){return c.reduce((e,t)=>e+(t.amount||0),0)}function td(){return Nu}function rd(c){return{totalValue:c.totalItems,riskLevel:Hu,recommendations:Vu}}function id(c){if(Array.isArray(c)){const e=Object.keys(c[0]||{}),t=[e.join(",")];for(const r of c){const i=e.map(a=>JSON.stringify(r[a]||""));t.push(i.join(","))}return t.join(`
`)}return JSON.stringify(c)}function nd(c){switch(c){case"csv":return Er.csv;case"excel":return Er.excel;case"pdf":return Er.pdf;case"json":return Er.json;default:return Er.default}}var gt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ad{constructor(e){this.facilityId=e}exportAnalyticsReport(e,t,r){return gt(this,null,function*(){try{const i=Date.now();let a={};switch(e){case"inventory":a=yield this.generateInventoryReport();break;case"predictive":a={};break;case"cost":a=yield this.generateCostReport();break;case"maintenance":a=yield this.generateMaintenanceReport();break;case"comprehensive":a=yield this.generateComprehensiveReport();break}const s=yield this.formatReportData(a,t),{error:o}=yield d.from("inventory_ai_exports").insert({facility_id:this.facilityId,report_type:e,export_format:t,date_range:r,processing_time_ms:Date.now()-i,exported_at:new Date().toISOString()});return o&&console.error("Error saving export record:",o),{success:!0,data:s,downloadUrl:yield this.generateDownloadUrl(s,t)}}catch(i){return console.error("Error exporting analytics report:",i),{success:!1,error:i instanceof Error?i.message:"Export failed"}}})}generateInventoryReport(){return gt(this,null,function*(){const{data:e,error:t}=yield d.from("inventory_items").select("*").eq("facility_id",this.facilityId),r=e.filter(i=>i.facility_id===this.facilityId);return{totalItems:(r==null?void 0:r.length)||0,categories:Ku(r||[]),lowStockItems:Ju(r||[]),highValueItems:Xu(r||[])}})}generateCostReport(){return gt(this,null,function*(){const{data:e,error:t}=yield d.from("inventory_costs").select("*").eq("facility_id",this.facilityId);return t?(console.error("Error getting inventory costs for cost report:",t),{totalCosts:0,costByCategory:{},costTrends:[]}):{totalCosts:ed(e||[]),costByCategory:Qu(e||[]),costTrends:td()}})}generateMaintenanceReport(){return gt(this,null,function*(){const{data:e,error:t}=yield d.from("equipment_maintenance").select("*").eq("facility_id",this.facilityId);return t?(console.error("Error getting equipment maintenance for maintenance report:",t),{totalMaintenance:0,maintenanceByType:{},upcomingMaintenance:[]}):{totalMaintenance:(e==null?void 0:e.length)||0,maintenanceByType:Yu(e||[]),upcomingMaintenance:Zu(e||[])}})}generateComprehensiveReport(){return gt(this,null,function*(){const[e,t,r]=yield Promise.all([this.generateInventoryReport(),this.generateCostReport(),this.generateMaintenanceReport()]);return{inventory:e,predictive:{},cost:t,maintenance:r,summary:rd(e)}})}formatReportData(e,t){return gt(this,null,function*(){switch(t){case"json":return JSON.stringify(e,null,2);case"csv":return id(e);case"excel":return e;case"pdf":return e;default:return e}})}generateDownloadUrl(e,t){return gt(this,null,function*(){const r=new Blob([JSON.stringify(e)],{type:nd(t)});return URL.createObjectURL(r)})}}var hn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class od{constructor(e){this.facilityId=e}generateDemandForecast(e,t,r){return hn(this,null,function*(){try{const i=Date.now(),a=r||(yield this.getHistoricalInventoryData()),s=yield this.generateForecastWithAI(a,t),o=Date.now()-i;return{inventory_item_id:e,forecast_period:t,forecast_date:new Date().toISOString(),predicted_demand:s.predicted_demand,confidence_interval_lower:s.confidence_interval_lower,confidence_interval_upper:s.confidence_interval_upper,seasonal_factors:s.seasonal_factors,trend_analysis:s.trend_analysis,influencing_factors:s.influencing_factors,confidence_score:this.calculateConfidence(a,s),model_id:"default",processing_time_ms:o,facility_id:this.facilityId}}catch(i){throw console.error("Error generating demand forecast:",i),new Error(`Failed to generate forecast: ${i instanceof Error?i.message:"Unknown error"}`)}})}getHistoricalInventoryData(){return hn(this,null,function*(){return[]})}generateForecastWithAI(e,t){return hn(this,null,function*(){return{predicted_demand:0,confidence_interval_lower:0,confidence_interval_upper:0,seasonal_factors:{},trend_analysis:"stable",influencing_factors:[],confidence_score:.8,accuracy_metrics:{},recommendations:[]}})}calculateConfidence(e,t){return Math.min(.95,Math.max(.1,t.confidence_score||.8))}}var Da=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class sd{constructor(e){this.facilityId=e}analyzeForecastAccuracy(e,t){return Da(this,null,function*(){try{const r=this.calculateOverallAccuracy(e,t),i=this.identifyTrends(e),a=this.generateRecommendations(e,t);return{accuracy:r,trends:i,recommendations:a}}catch(r){throw console.error("Error analyzing forecast accuracy:",r),new Error(`Failed to analyze accuracy: ${r instanceof Error?r.message:"Unknown error"}`)}})}generateForecastReport(e){return Da(this,null,function*(){try{const t=this.generateSummary(e),r=this.extractKeyInsights(e),i=this.identifyRiskFactors(e);return{summary:t,keyInsights:r,riskFactors:i}}catch(t){throw console.error("Error generating forecast report:",t),new Error(`Failed to generate report: ${t instanceof Error?t.message:"Unknown error"}`)}})}calculateOverallAccuracy(e,t){return .85}identifyTrends(e){return["Increasing demand","Seasonal patterns"]}generateRecommendations(e,t){return["Increase stock for high-demand items","Optimize ordering schedule"]}generateSummary(e){return"Generated forecasts with average confidence"}extractKeyInsights(e){return["High confidence in short-term forecasts","Seasonal patterns detected"]}identifyRiskFactors(e){return["Low historical data","High variability in demand"]}}var Ar=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class cd{constructor(e){this.facilityId=e,this.coreService=new od(e),this.analyticsService=new sd(e)}generateDemandForecast(e,t,r){return Ar(this,null,function*(){return yield this.coreService.generateDemandForecast(e,t,r)})}analyzeForecastAccuracy(e,t){return Ar(this,null,function*(){return yield this.analyticsService.analyzeForecastAccuracy(e,t)})}generateForecastReport(e){return Ar(this,null,function*(){return yield this.analyticsService.generateForecastReport(e)})}generateBatchForecasts(e,t){return Ar(this,null,function*(){const r=[];for(const i of e)try{const a=yield this.generateDemandForecast(i,t);r.push(a)}catch(a){console.error(`Error generating forecast for item ${i}:`,a)}return r})}getForecastingInsights(){return Ar(this,null,function*(){return{totalForecasts:0,averageAccuracy:.85,topTrends:["Seasonal patterns","Demand variability"]}})}}var Oa=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ld{constructor(e){this.facilityId=e,this.analyticsService=new Bn(e),this.forecastingService=new cd(e),this.providerService=new jn(e)}generateDemandForecast(e,t){return Oa(this,null,function*(){try{const r=yield this.analyticsService.getHistoricalInventoryData(),i=yield this.forecastingService.generateDemandForecast(e,t,r),{data:a,error:s}=yield d.from("inventory_ai_demand_forecasting").insert(i).select().single();return s?(console.error("Error saving demand forecast:",s),null):a}catch(r){return console.error("Error generating demand forecast:",r),null}})}getPredictiveAnalytics(){return Oa(this,null,function*(){try{const e=Date.now(),{data:t,error:r}=yield d.from("inventory_transactions").select("*").eq("facility_id",this.facilityId).gte("created_at",new Date(Date.now()-oi).toISOString());if(r)return console.error("Error getting inventory transactions:",r),{demandForecast:[],stockoutRisk:[],maintenancePredictions:[],costTrends:[],seasonalPatterns:[]};const i=new Date(Date.now()-qu);(t||[]).filter(g=>g.created_at&&new Date(g.created_at)>=i).sort((g,_)=>new Date(_.created_at||"").getTime()-new Date(g.created_at||"").getTime());const{data:s,error:o}=yield d.from("equipment_maintenance").select("*").eq("facility_id",this.facilityId).gte("created_at",new Date(Date.now()-oi).toISOString());if(o)return console.error("Error getting equipment maintenance:",o),{demandForecast:[],stockoutRisk:[],maintenancePredictions:[],costTrends:[],seasonalPatterns:[]};const n=new Date(Date.now()-oi);(s||[]).filter(g=>g.created_at&&new Date(g.created_at)>=n).sort((g,_)=>new Date(_.created_at||"").getTime()-new Date(g.created_at||"").getTime());const{data:u,error:h}=yield d.from("inventory_costs").select("*").eq("facility_id",this.facilityId).gte("created_at",new Date(Date.now()-oi).toISOString());if(h)return console.error("Error getting inventory costs:",h),{demandForecast:[],stockoutRisk:[],maintenancePredictions:[],costTrends:[],seasonalPatterns:[]};(u||[]).filter(g=>g.created_at&&new Date(g.created_at)>=n).sort((g,_)=>new Date(_.created_at||"").getTime()-new Date(g.created_at||"").getTime());const m=yield this.providerService.generateDemandForecastWithAI(),p=Date.now()-e,{error:y}=yield d.from("inventory_ai_predictive_analytics").insert({facility_id:this.facilityId,predictions_data:m,processing_time_ms:p,generated_at:new Date().toISOString()});return y&&console.error("Error saving predictive analytics:",y),{demandForecast:m.map(g=>({itemId:"unknown",itemName:"Unknown Item",predictedDemand:g.predicted_demand||0,confidence:g.confidence_score||.8,timeframe:"30 days",factors:g.influencing_factors||[]})),stockoutRisk:[],maintenancePredictions:[],costTrends:[],seasonalPatterns:[]}}catch(e){throw console.error("Error generating predictive analytics:",e),e}})}}var fn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const ud={low_stock_threshold:10,prediction_accuracy_threshold:.85,ai_model_version:"1.0.0"};class dd{constructor(e){this.facilityId=e}loadSettings(){return fn(this,null,function*(){try{const{data:e,error:t}=yield d.from("inventory_items").select("facility_id").eq("facility_id",this.facilityId).limit(1);return t?(console.error("Error loading AI settings:",t),null):{id:"default",facility_id:this.facilityId,ai_enabled:!0,ai_version:"1.0.0",computer_vision_enabled:!0,barcode_scanning_enabled:!0,image_recognition_enabled:!0,quality_assessment_enabled:!0,damage_detection_enabled:!0,inventory_counting_enabled:!0,predictive_analytics_enabled:!0,demand_forecasting_enabled:!0,maintenance_prediction_enabled:!0,cost_optimization_enabled:!0,seasonal_analysis_enabled:!0,cycle_optimization_enabled:!0,smart_categorization_enabled:!0,auto_classification_enabled:!0,smart_form_filling_enabled:!0,intelligent_workflow_enabled:!0,quality_assurance_enabled:!0,compliance_monitoring_enabled:!0,audit_trail_enhancement_enabled:!0,risk_assessment_enabled:!0,scanner_intelligence_enabled:!0,multi_format_barcode_support:!0,smart_validation_enabled:!0,error_prevention_enabled:!0,real_time_monitoring_enabled:!0,anomaly_detection_enabled:!0,ai_confidence_threshold:.85,ai_data_retention_days:30,ai_model_training:!1,predictive_maintenance_enabled:!0,smart_notifications_enabled:!0,real_time_processing_enabled:!0,data_sharing_enabled:!1,local_ai_processing_enabled:!0,encrypted_data_transmission:!0,auto_optimization_enabled:!0,performance_monitoring:!0,resource_optimization:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}catch(e){return console.error("Error loading AI settings:",e),null}})}saveSettings(e){return fn(this,null,function*(){try{return console.log("Saving AI settings:",e),!0}catch(t){return console.error("Error saving AI settings:",t),!1}})}initializeSettings(){return fn(this,null,function*(){try{const e=ud;return yield this.saveSettings(e)}catch(e){return console.error("Error initializing AI settings:",e),!1}})}}var Ce=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Bs{constructor(e){this.facilityId=e,this.analyticsService=new Bn(e),this.forecastingService=new ld(e),this.optimizationService=new Gu(e),this.riskAnalysisService=new Wu(e),this.costAnalyticsService=new ad(e),this.supabaseProvider=new dd(e)}getInventoryInsights(){return Ce(this,null,function*(){return this.analyticsService.getInventoryInsights()})}loadSettings(){return Ce(this,null,function*(){return yield this.supabaseProvider.loadSettings()})}saveSettings(e){return Ce(this,null,function*(){return yield this.supabaseProvider.saveSettings(e)})}initializeSettings(){return Ce(this,null,function*(){return yield this.supabaseProvider.initializeSettings()})}analyzeBarcode(e,t){return Ce(this,null,function*(){try{const r=yield this.loadSettings();if(!(r!=null&&r.barcode_scanning_enabled))throw new Error("Barcode scanning AI is not enabled");return yield this.riskAnalysisService.analyzeBarcode(e,t)}catch(r){return console.error("Error analyzing barcode:",r),null}})}analyzeImage(e){return Ce(this,null,function*(){try{const t=yield this.loadSettings();if(!(t!=null&&t.image_recognition_enabled))throw new Error("Image recognition AI is not enabled");return yield this.riskAnalysisService.analyzeImage(e)}catch(t){return console.error("Error analyzing image:",t),null}})}generateDemandForecast(e,t){return Ce(this,null,function*(){try{const r=yield this.loadSettings();if(!(r!=null&&r.demand_forecasting_enabled))throw new Error("Demand forecasting AI is not enabled");return yield this.forecastingService.generateDemandForecast(e,t)}catch(r){return console.error("Error generating demand forecast:",r),null}})}generateCostOptimization(e){return Ce(this,null,function*(){try{const t=yield this.loadSettings();if(!(t!=null&&t.cost_optimization_enabled))throw new Error("Cost optimization AI is not enabled");return yield this.optimizationService.generateCostOptimization(e)}catch(t){return console.error("Error generating cost optimization:",t),null}})}categorizeItem(e,t){return Ce(this,null,function*(){try{const r=yield this.loadSettings();if(!(r!=null&&r.smart_categorization_enabled))throw new Error("Smart categorization AI is not enabled");return yield this.optimizationService.categorizeItem(e,t)}catch(r){return console.error("Error categorizing item:",r),null}})}getPredictiveAnalytics(){return Ce(this,null,function*(){try{const e=yield this.loadSettings();if(!(e!=null&&e.predictive_analytics_enabled))throw new Error("Predictive analytics AI is not enabled");return yield this.forecastingService.getPredictiveAnalytics()}catch(e){throw console.error("Error generating predictive analytics:",e),e}})}exportAnalyticsReport(e,t,r){return Ce(this,null,function*(){try{const i=yield this.loadSettings();if(!(i!=null&&i.predictive_analytics_enabled))throw new Error("Analytics export is not enabled");return yield this.costAnalyticsService.exportAnalyticsReport(e,t,r)}catch(i){return console.error("Error exporting analytics report:",i),{success:!1,error:i instanceof Error?i.message:"Export failed"}}})}}var Ra=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class hd{constructor(e){this.settings=null,this.facilityId=e}loadSettings(){return Ra(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings").select("*").eq("facility_id",this.facilityId).eq("module","sterilization").single();return t?(console.error("Error loading AI settings:",t),null):(this.settings=e.settings,e.settings)}catch(e){return console.error("Error loading AI settings:",e),null}})}saveSettings(e){return Ra(this,null,function*(){try{const t={facility_id:this.facilityId,module:"sterilization",settings:e,updated_at:new Date().toISOString()},{error:r}=yield d.from("ai_settings").upsert(t,{onConflict:"facility_id,module"});return r?(console.error("Error saving AI settings:",r),!1):(!r&&t&&(yield xn({facilityId:this.facilityId,userId:"system",module:"sterilization",action:"UPDATE",details:t})),yield this.loadSettings(),!0)}catch(t){return console.error("Error saving AI settings:",t),!1}})}isFeatureEnabled(e){var t;return(t=this.settings)!=null&&t.ai_enabled?this.settings[e]===!0:!1}getCurrentSettings(){return this.settings}getOpenAIKey(){var e;return((e=this.settings)==null?void 0:e.openai_api_key_encrypted)||pe("VITE_OPENAI_API_KEY")}isComputerVisionEnabled(){return this.isFeatureEnabled("computer_vision_enabled")}isToolConditionAssessmentEnabled(){return this.isFeatureEnabled("tool_condition_assessment")}isBarcodeQualityDetectionEnabled(){return this.isFeatureEnabled("barcode_quality_detection")}isToolTypeRecognitionEnabled(){return this.isFeatureEnabled("tool_type_recognition")}isPredictiveAnalyticsEnabled(){return this.isFeatureEnabled("predictive_analytics_enabled")}isCycleOptimizationEnabled(){return this.isFeatureEnabled("cycle_optimization")}isIntelligentWorkflowSelectionEnabled(){return this.isFeatureEnabled("intelligent_workflow_selection")}isAutomatedProblemDetectionEnabled(){return this.isFeatureEnabled("automated_problem_detection")}isRealTimeMonitoringEnabled(){return this.isFeatureEnabled("real_time_monitoring_enabled")}isComplianceMonitoringEnabled(){return this.isFeatureEnabled("compliance_monitoring")}isBiologicalIndicatorAnalysisEnabled(){return this.isFeatureEnabled("biological_indicator_analysis")}getConfidenceThreshold(){var e;return((e=this.settings)==null?void 0:e.ai_confidence_threshold)||.8}getDataRetentionDays(){var e;return((e=this.settings)==null?void 0:e.ai_data_retention_days)||365}}function fd(){try{const c=localStorage.getItem("currentUser");if(c){const e=JSON.parse(c);return(e==null?void 0:e.id)||null}return null}catch(c){return console.warn("Failed to get user ID from storage:",c),null}}function Fe(c){const e=fd();return e||c||null}const $a={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};var md=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class At{constructor(){this.logLevel="info"}static getInstance(){return At.instance||(At.instance=new At),At.instance}error(e,t,r){this.log("error",e,t,r)}warn(e,t,r){this.log("warn",e,t,r)}info(e,t,r){this.log("info",e,t,r)}debug(e,t,r){this.log("debug",e,t,r)}log(e,t,r,i){if(!this.shouldLog(e))return;const a={level:e,message:this.sanitizeMessage(t),module:r.module,facilityId:r.facilityId,userId:r.userId,metadata:this.sanitizeMetadata(i),timestamp:new Date().toISOString()};this.storeLogEntry(a)}shouldLog(e){const t=["error","warn","info","debug"],r=t.indexOf(this.logLevel);return t.indexOf(e)<=r}sanitizeMessage(e){return e.replace(/sk-[a-zA-Z0-9]{20,}/g,"[REDACTED_API_KEY]").replace(/Bearer [a-zA-Z0-9._-]+/g,"[REDACTED_TOKEN]").replace(/password["\s]*[:=]["\s]*[^"\s,}]+/gi,"password: [REDACTED]").replace(/api[_-]?key["\s]*[:=]["\s]*[^"\s,}]+/gi,"api_key: [REDACTED]").substring(0,1e3)}sanitizeMetadata(e){if(!e)return;const t={};for(const[r,i]of Object.entries(e)){const a=r.toLowerCase();if(a.includes("password")||a.includes("secret")||a.includes("token")||a.includes("key")||a.includes("auth")){t[r]="[REDACTED]";continue}typeof i=="string"?t[r]=this.sanitizeMessage(i):typeof i=="object"&&i!==null?t[r]=this.sanitizeMetadata(i):t[r]=i}return t}storeLogEntry(e){return md(this,null,function*(){try{yield d.from("system_logs").insert({level:e.level,message:e.message,module:e.module,facility_id:e.facilityId,user_id:e.userId,metadata:e.metadata,created_at:e.timestamp})}catch(t){}})}static validateEnvironment(){const t=["VITE_SUPABASE_URL","VITE_SUPABASE_ANON_KEY"].filter(i=>!$a[i]);if(t.length>0)throw new Error(`Missing required environment variables: ${t.join(", ")}`);const r=["VITE_SUPABASE_ANON_KEY","VITE_SUPABASE_SERVICE_ROLE_KEY","VITE_GOOGLE_VISION_API_KEY","VITE_AZURE_VISION_API_KEY"];for(const i of r){const a=$a[i];a&&(a.includes("sk-")||a.includes("Bearer "))&&console.warn(`Potential secret leakage detected in environment variable: ${i}`)}}}const js=At.getInstance();At.validateEnvironment();var Ma=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class D{static callOpenAI(e,t){return Ma(this,null,function*(){if(!t)throw new Error("OpenAI API key not configured");try{const i=`You are a healthcare AI specialist for Cliniio, specializing in sterilization facility management, medical instrument analysis, and compliance workflows. Provide accurate, actionable insights based on the data provided.

${e}`;return yield Kr.askAI(i,{module:"sterilization-analysis",facilityId:"unknown"})}catch(r){throw js.error("OpenAI API call failed",{module:"sterilization-analysis",facilityId:"unknown"},{error:r instanceof Error?r.message:String(r),promptLength:e.length}),new Error("AI analysis failed")}})}static testConnection(e){return Ma(this,null,function*(){try{return{success:!0,response:yield this.callOpenAI("Hello! This is a test message from Cliniio sterilization AI service. Please respond with a brief confirmation that you are working.",e)}}catch(t){return{success:!1,response:"",error:t instanceof Error?t.message:"Unknown error"}}})}static parseConditionFromAI(e){return e.includes("excellent")||e.includes("perfect")?"excellent":e.includes("good")||e.includes("acceptable")?"good":e.includes("fair")||e.includes("adequate")?"fair":e.includes("poor")||e.includes("unacceptable")?"poor":e.includes("damaged")||e.includes("broken")?"damaged":"good"}static parseWearLevelFromAI(e){return e.includes("minimal")||e.includes("new")?"minimal":e.includes("moderate")||e.includes("normal")?"moderate":e.includes("significant")||e.includes("worn")?"significant":e.includes("critical")||e.includes("severe")?"critical":"moderate"}static parseCleaningQualityFromAI(e){return e.includes("excellent")||e.includes("clean")?"excellent":e.includes("good")||e.includes("acceptable")?"good":e.includes("fair")||e.includes("adequate")?"fair":e.includes("poor")||e.includes("dirty")?"poor":"good"}static parseDamageFromAI(e){return e.includes("damage")||e.includes("broken")||e.includes("cracked")}static parseDamageTypesFromAI(e){const t=[];return e.includes("crack")&&t.push("crack"),e.includes("scratch")&&t.push("scratch"),e.includes("rust")&&t.push("rust"),e.includes("bend")&&t.push("bent"),t}static parseBarcodeQualityFromAI(e){return e.includes("excellent")||e.includes("clear")?"excellent":e.includes("good")||e.includes("readable")?"good":e.includes("fair")||e.includes("acceptable")?"fair":e.includes("poor")||e.includes("unreadable")?"poor":"good"}static parseToolTypeFromAI(e){return e.includes("handpiece")?"Dental Handpiece":e.includes("scalpel")?"Surgical Scalpel":e.includes("forceps")?"Surgical Forceps":e.includes("scissors")?"Surgical Scissors":"Medical Instrument"}static parseToolCategoryFromAI(e){return e.includes("dental")?"Dental Instruments":e.includes("surgical")?"Surgical Instruments":e.includes("ophthalmic")?"Ophthalmic Instruments":"General Medical Instruments"}static parseRiskLevel(e){return e.includes("high")||e.includes("critical")?"high":e.includes("medium")||e.includes("moderate")?"medium":"low"}static parseComplianceScore(e){return e.includes("excellent")||e.includes("100%")?.95:e.includes("good")||e.includes("90%")?.9:e.includes("fair")||e.includes("80%")?.8:.75}static generateRecommendations(e){const t=[];return e.includes("clean")&&t.push("Ensure thorough cleaning before sterilization"),e.includes("inspect")&&t.push("Perform detailed visual inspection"),e.includes("maintenance")&&t.push("Schedule maintenance check"),t.length===0&&t.push("Tool appears in good condition"),t}static generateBarcodeRecommendations(e){const t=[];return e.includes("poor")&&t.push("Replace barcode label"),e.includes("fair")&&t.push("Clean barcode surface"),e.includes("good")&&t.push("Monitor for degradation"),t}static generateToolSuggestions(e){const t=[];return e.includes("high-speed")&&t.push("High-speed handpiece - requires special sterilization cycle"),e.includes("delicate")&&t.push("Delicate instrument - handle with care"),e.includes("sharp")&&t.push("Sharp instrument - use protective packaging"),t}static parseOptimizationSuggestions(e){const t=[];return e.includes("temperature")&&t.push("Optimize temperature settings"),e.includes("duration")&&t.push("Adjust cycle duration"),e.includes("grouping")&&t.push("Improve tool grouping"),t.length===0&&t.push("Review cycle parameters"),t}static parseRecommendedParameters(e){const t={};return e.includes("temperature")&&(t.temperature=134),e.includes("duration")&&(t.duration=20),e.includes("pressure")&&(t.pressure=30),t}static parseRecommendedWorkflow(e){return e.includes("clean")?"clean":e.includes("dirty")?"dirty":e.includes("problem")?"problem":e.includes("packaging")?"packaging":"dirty"}static parseWorkflowReasoning(){return["Tool condition assessment completed","Historical usage patterns analyzed","Sterilization requirements verified"]}static parseAlternativeWorkflows(){return[{workflow:"clean",confidence:.75,reasoning:"Alternative cleaning approach"}]}static parseIssues(e){const t=[];return e.includes("wear")&&t.push("Tool wear detected"),e.includes("damage")&&t.push("Potential damage"),e.includes("maintenance")&&t.push("Maintenance needed"),t}static parseRiskFactors(e){const t=[];return e.includes("temperature")&&t.push("Temperature variations"),e.includes("pressure")&&t.push("Pressure fluctuations"),e.includes("time")&&t.push("Timing issues"),t}static parseRequiredActions(e){const t=[];return e.includes("document")&&t.push("Document variations"),e.includes("investigate")&&t.push("Investigate causes"),e.includes("correct")&&t.push("Correct procedures"),t}static parseAuditRecommendations(e){const t=[];return e.includes("review")&&t.push("Review procedures"),e.includes("monitor")&&t.push("Monitor parameters"),e.includes("train")&&t.push("Staff training"),t}static parseBIValidation(e){return e.includes("pass")||e.includes("success")?!0:(e.includes("fail")||e.includes("failure"),!1)}}var pd=Object.defineProperty,gd=Object.defineProperties,yd=Object.getOwnPropertyDescriptors,qa=Object.getOwnPropertySymbols,_d=Object.prototype.hasOwnProperty,vd=Object.prototype.propertyIsEnumerable,za=(c,e,t)=>e in c?pd(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,wd=(c,e)=>{for(var t in e||(e={}))_d.call(e,t)&&za(c,t,e[t]);if(qa)for(var t of qa(e))vd.call(e,t)&&za(c,t,e[t]);return c},Id=(c,e)=>gd(c,yd(e)),yt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Sd{constructor(e){this.facilityId=e}recordMetric(e){return yt(this,null,function*(){try{const t=Id(wd({facility_id:this.facilityId},e),{created_at:new Date().toISOString()}),{data:r,error:i}=yield d.from("ai_performance_metrics").insert(t).select("id").single();return i?(console.error("Error recording performance metric:",i),null):r.id}catch(t){return console.error("Error recording performance metric:",t),null}})}getPerformanceSummary(e="day",t){return yt(this,null,function*(){try{const r=this.getStartDate(e);let i=d.from("ai_performance_metrics").select("*").eq("facility_id",this.facilityId).gte("created_at",r.toISOString());t&&(i=i.eq("service_name",t));const{data:a,error:s}=yield i;return s?(console.error("Error fetching performance metrics:",s),this.getDefaultPerformanceSummary()):this.calculatePerformanceSummary(a||[])}catch(r){return console.error("Error getting performance summary:",r),this.getDefaultPerformanceSummary()}})}getServicePerformance(e="day"){return yt(this,null,function*(){try{const t=this.getStartDate(e),{data:r,error:i}=yield d.from("ai_performance_metrics").select("*").eq("facility_id",this.facilityId).gte("created_at",t.toISOString());return i?(console.error("Error fetching service performance:",i),[]):this.calculateServicePerformance(r||[])}catch(t){return console.error("Error getting service performance:",t),[]}})}getDetailedMetrics(e){return yt(this,null,function*(){try{const t=this.getStartDate(e.timeRange||"day");let r=d.from("ai_performance_metrics").select("*").eq("facility_id",this.facilityId).gte("created_at",t.toISOString()).order("created_at",{ascending:!1});e.serviceName&&(r=r.eq("service_name",e.serviceName)),e.operationName&&(r=r.eq("operation_name",e.operationName)),e.success!==void 0&&(r=r.eq("success",e.success)),e.limit&&(r=r.limit(e.limit));const{data:i,error:a}=yield r;return a?(console.error("Error fetching detailed metrics:",a),[]):i}catch(t){return console.error("Error getting detailed metrics:",t),[]}})}getPerformanceTrends(e="month",t){return yt(this,null,function*(){try{const r=this.getStartDate(e),i=this.getInterval(e);let a=d.from("ai_performance_metrics").select("*").eq("facility_id",this.facilityId).gte("created_at",r.toISOString()).order("created_at",{ascending:!0});t&&(a=a.eq("service_name",t));const{data:s,error:o}=yield a;return o?(console.error("Error fetching performance trends:",o),{dates:[],processingTimes:[],successRates:[],operationCounts:[]}):this.calculateTrends(s||[],i)}catch(r){return console.error("Error getting performance trends:",r),{dates:[],processingTimes:[],successRates:[],operationCounts:[]}}})}getOptimizationRecommendations(){return yt(this,null,function*(){try{const e=yield this.getPerformanceSummary("week"),t=[];return e.averageProcessingTime>5e3&&t.push("Consider optimizing AI model selection or reducing input complexity"),e.p95ProcessingTime>1e4&&t.push("Investigate performance bottlenecks in AI service calls"),e.successRate<.9&&t.push("Review error patterns and improve error handling"),e.errorRate>.1&&t.push("Implement retry mechanisms and fallback strategies"),e.performanceTrend==="degrading"&&t.push("Monitor system resources and consider scaling AI services"),t.length===0&&t.push("Performance is within acceptable ranges - continue monitoring"),t}catch(e){return console.error("Error getting optimization recommendations:",e),["Unable to generate recommendations at this time"]}})}cleanupOldMetrics(e=90){return yt(this,null,function*(){try{const t=new Date(Date.now()-e*24*60*60*1e3),{data:r,error:i}=yield d.from("ai_performance_metrics").delete().lt("created_at",t.toISOString()).eq("facility_id",this.facilityId).select("id");return i?(console.error("Error cleaning up old metrics:",i),0):(r==null?void 0:r.length)||0}catch(t){return console.error("Error cleaning up old metrics:",t),0}})}getStartDate(e){const t=new Date;switch(e){case"hour":return new Date(t.getTime()-3600*1e3);case"day":return new Date(t.getTime()-1440*60*1e3);case"week":return new Date(t.getTime()-10080*60*1e3);case"month":return new Date(t.getTime()-720*60*60*1e3);case"quarter":return new Date(t.getTime()-2160*60*60*1e3);default:return new Date(t.getTime()-1440*60*1e3)}}getInterval(e){switch(e){case"week":return 1440*60*1e3;case"month":return 1440*60*1e3;case"quarter":return 10080*60*1e3;default:return 1440*60*1e3}}calculatePerformanceSummary(e){if(e.length===0)return this.getDefaultPerformanceSummary();const t=e.map(y=>y.processing_time_ms).filter(y=>y>0),r=e.filter(y=>y.success),i=e.filter(y=>!y.success),a=t.sort((y,g)=>y-g),s=e.length,o=r.length/s,n=t.reduce((y,g)=>y+g,0)/t.length,l=a[Math.floor(a.length/2)],u=a[Math.floor(a.length*.95)],h=a[Math.floor(a.length*.99)],f=e.slice(-10),m=f.reduce((y,g)=>y+g.processing_time_ms,0)/f.length,p=m<n*.9?"improving":m>n*1.1?"degrading":"stable";return{totalOperations:s,successRate:o,averageProcessingTime:n,medianProcessingTime:l,p95ProcessingTime:u,p99ProcessingTime:h,totalErrors:i.length,errorRate:i.length/s,performanceTrend:p,recommendations:this.generateRecommendations(e)}}calculateServicePerformance(e){const t=new Map;return e.forEach(r=>{t.has(r.service_name)||t.set(r.service_name,[]),t.get(r.service_name).push(r)}),Array.from(t.entries()).map(([r,i])=>{var a;const s=i.map(y=>y.processing_time_ms).filter(y=>y>0),o=i.filter(y=>y.success),n=((a=i[0])==null?void 0:a.created_at)||"",l=i.length,u=o.length/l,h=s.length>0?s.reduce((y,g)=>y+g,0)/s.length:0,f=Math.max(0,100-h/100),m=u*100,p=Math.round((f+m)/2);return{serviceName:r,operationCount:l,successRate:u,averageTime:h,totalErrors:i.filter(y=>!y.success).length,lastOperation:n,performanceScore:p}}).sort((r,i)=>i.performanceScore-r.performanceScore)}calculateTrends(e,t){const r=new Date,i=new Map;for(let s=0;s<10;s++){const n=new Date(r.getTime()-s*t).toISOString().split("T")[0];i.set(n,{times:[],success:0,total:0})}e.forEach(s=>{const o=new Date(s.created_at).toISOString().split("T")[0],n=i.get(o);n&&(n.times.push(s.processing_time_ms),n.total++,s.success&&n.success++)});const a=Array.from(i.entries()).sort(([s],[o])=>s.localeCompare(o));return{dates:a.map(([s])=>s),processingTimes:a.map(([,s])=>s.times.length>0?s.times.reduce((o,n)=>o+n,0)/s.times.length:0),successRates:a.map(([,s])=>s.total>0?s.success/s.total:0),operationCounts:a.map(([,s])=>s.total)}}generateRecommendations(e){const t=[];if(e.length===0)return["No performance data available for recommendations"];const r=e.reduce((a,s)=>a+s.processing_time_ms,0)/e.length,i=e.filter(a=>a.success).length/e.length;return r>5e3&&t.push("Consider optimizing AI model selection for faster processing"),i<.9&&t.push("Review error patterns and implement better error handling"),t.length===0&&t.push("Performance is within acceptable ranges"),t}getDefaultPerformanceSummary(){return{totalOperations:0,successRate:0,averageProcessingTime:0,medianProcessingTime:0,p95ProcessingTime:0,p99ProcessingTime:0,totalErrors:0,errorRate:0,performanceTrend:"stable",recommendations:["No performance data available"]}}}var Tr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class bd{constructor(e){this.analysisStartTime=0,this.facilityId=e,this.performanceMetrics=new Sd(e)}analyzeToolCondition(e,t,r){return Tr(this,null,function*(){this.analysisStartTime=Date.now();try{let i;t?i=`Analyze medical instrument data for tool ID: ${e}. Provide general condition assessment, wear level estimation, cleaning quality recommendations, and damage detection guidance based on best practices for medical instrument sterilization.`:i=`Analyze medical instrument data for tool ID: ${e}. Provide general condition assessment, wear level estimation, cleaning quality recommendations, and damage detection guidance based on best practices for medical instrument sterilization.`;const a=yield D.callOpenAI(i,r||""),s={success:!0,toolId:e,condition:D.parseConditionFromAI(a),wearLevel:D.parseWearLevelFromAI(a),cleaningQuality:D.parseCleaningQualityFromAI(a),damageDetected:D.parseDamageFromAI(a),damageTypes:D.parseDamageTypesFromAI(a),confidence:.8,recommendations:D.generateRecommendations(a)},o=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"analyzeToolCondition",processing_time_ms:o,success:!0,input_size_bytes:(t==null?void 0:t.size)||0,ai_model_used:"gpt-4",confidence_score:s.confidence,user_id:Fe()||void 0}),yield this.saveToolAssessment(s),s}catch(i){const a=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"analyzeToolCondition",processing_time_ms:a,success:!1,error_message:i instanceof Error?i.message:"Unknown error",user_id:Fe()||void 0}),console.error("Tool condition analysis failed:",i),{success:!1,condition:"good",wearLevel:"moderate",cleaningQuality:"good",damageDetected:!1,confidence:.5,recommendations:["Analysis failed - manual inspection recommended"],error:i instanceof Error?i.message:"Unknown error"}}})}detectBarcodeQuality(e,t){return Tr(this,null,function*(){this.analysisStartTime=Date.now();try{let r;e?r=yield D.callOpenAI("Provide general guidance on barcode quality assessment for medical instruments. Include best practices for barcode readability, common issues, and maintenance recommendations.",t||""):r=yield D.callOpenAI("Provide general guidance on barcode quality assessment for medical instruments. Include best practices for barcode readability, common issues, and maintenance recommendations.",t||"");const i=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"detectBarcodeQuality",processing_time_ms:i,success:!0,input_size_bytes:(e==null?void 0:e.size)||0,ai_model_used:"gpt-4",confidence_score:.9,user_id:Fe()||void 0}),{success:!0,quality:D.parseBarcodeQualityFromAI(r),confidence:.9,recommendations:D.generateBarcodeRecommendations(r)}}catch(r){const i=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"detectBarcodeQuality",processing_time_ms:i,success:!1,error_message:r instanceof Error?r.message:"Unknown error",user_id:Fe()||void 0}),console.error("Barcode quality detection failed:",r),{success:!1,quality:"fair",confidence:.5,recommendations:["Analysis failed - manual verification recommended"]}}})}identifyToolType(e,t){return Tr(this,null,function*(){this.analysisStartTime=Date.now();try{let r;return e?r=yield D.callOpenAI("Provide comprehensive guidance on medical instrument classification and sterilization requirements. Include common instrument types, categories, sterilization cycles, and best practices for healthcare facilities.",t||""):r=yield D.callOpenAI("Provide comprehensive guidance on medical instrument classification and sterilization requirements. Include common instrument types, categories, sterilization cycles, and best practices for healthcare facilities.",t||""),{success:!0,toolType:D.parseToolTypeFromAI(r),category:D.parseToolCategoryFromAI(r),confidence:.8,suggestions:D.generateToolSuggestions(r)}}catch(r){return console.error("Tool type identification failed:",r),{success:!1,confidence:.5,suggestions:["Identification failed - manual classification needed"]}}})}detectPotentialProblems(e,t,r){return Tr(this,null,function*(){this.analysisStartTime=Date.now();try{const i=yield D.callOpenAI(`Analyze tool data for potential problems: ${JSON.stringify(t)}. Identify risks and provide recommendations.`,r||""),a=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"detectPotentialProblems",processing_time_ms:a,success:!0,ai_model_used:"gpt-4",confidence_score:.8,user_id:Fe()||void 0}),{success:!0,problemsDetected:i.includes("problem")||i.includes("risk"),riskLevel:D.parseRiskLevel(i),issues:D.parseIssues(i),recommendations:D.generateRecommendations(i)}}catch(i){const a=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"detectPotentialProblems",processing_time_ms:a,success:!1,error_message:i instanceof Error?i.message:"Unknown error",user_id:Fe()||void 0}),console.error("Problem detection failed:",i),{success:!1,problemsDetected:!1,riskLevel:"low",issues:[],recommendations:["Analysis failed - manual inspection recommended"]}}})}saveToolAssessment(e){return Tr(this,null,function*(){try{const t={facility_id:this.facilityId,tool_id:e.toolId,cycle_id:null,condition_rating:e.condition,wear_level:e.wearLevel,cleaning_quality:e.cleaningQuality,damage_detected:e.damageDetected,damage_types:e.damageTypes||[],confidence_score:e.confidence,model_id:null,processing_time_ms:Date.now()-this.analysisStartTime,image_file_path:null,ai_insights:{recommendations:e.recommendations},created_by:Fe()},{data:r,error:i}=yield d.from("sterilization_ai_tool_assessments").insert(t).select("id").single();return i?(console.error("Error saving tool assessment:",i),null):r.id}catch(t){return console.error("Error saving tool assessment:",t),null}})}}var si=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Ed{constructor(e){this.facilityId=e}getCycleOptimization(e,t){return si(this,null,function*(){try{const{data:r}=yield d.from("sterilization_cycles").select("*").eq("facility_id",this.facilityId).eq("status","completed").order("created_at",{ascending:!1}).limit(100);if(!r||r.length===0)throw new Error("No historical cycle data available");const i=yield D.callOpenAI(`Analyze sterilization cycle data for optimization. Historical cycles: ${JSON.stringify(r)}. Provide efficiency improvements and parameter recommendations.`,t||""),a={cycleId:e,currentEfficiency:this.calculateCurrentEfficiency(r),predictedEfficiency:this.calculatePredictedEfficiency(r),optimizationSuggestions:D.parseOptimizationSuggestions(i),estimatedTimeSavings:this.calculateTimeSavings(),recommendedParameters:D.parseRecommendedParameters(i),confidence:.85};return yield this.saveCycleOptimization(a),a}catch(r){throw console.error("Cycle optimization failed:",r),new Error("Cycle optimization analysis failed")}})}getWorkflowSuggestion(e,t,r){return si(this,null,function*(){try{const{data:i}=yield d.from("tools").select("*").eq("id",e).eq("facility_id",this.facilityId).single();if(!i)throw new Error("Tool not found");const a=yield D.callOpenAI(`Recommend sterilization workflow for tool: ${JSON.stringify(i)}. History: ${JSON.stringify(t)}. Consider tool type, condition, and usage patterns.`,r||""),s={toolId:e,recommendedWorkflow:D.parseRecommendedWorkflow(a),confidence:this.calculateWorkflowConfidence(i,t),reasoning:D.parseWorkflowReasoning(),alternativeWorkflows:D.parseAlternativeWorkflows()};return yield this.saveWorkflowSuggestion(s),s}catch(i){throw console.error("Workflow suggestion failed:",i),new Error("Workflow suggestion failed")}})}calculateCurrentEfficiency(e){if(!e||e.length===0)return .75;const t=e.reduce((r,i)=>r+(i.duration_minutes||0),0)/e.length;return Math.max(.5,Math.min(1,1-(t-20)/100))}calculatePredictedEfficiency(e){const t=this.calculateCurrentEfficiency(e);return Math.min(1,t+.15)}calculateTimeSavings(){return Math.floor(Math.random()*15)+5}calculateWorkflowConfidence(e,t){let r=.5;return e.condition==="excellent"&&(r+=.2),t.usage_count<100&&(r+=.1),Math.min(r,.95)}saveCycleOptimization(e){return si(this,null,function*(){try{const t={facility_id:this.facilityId,cycle_id:e.cycleId,current_efficiency:e.currentEfficiency,predicted_efficiency:e.predictedEfficiency,estimated_time_savings:e.estimatedTimeSavings,recommended_parameters:e.recommendedParameters,confidence_score:e.confidence,model_id:null,processing_time_ms:0,optimization_factors:{},created_by:null};yield d.from("sterilization_ai_cycle_optimizations").insert(t)}catch(t){console.error("Error saving cycle optimization:",t)}})}saveWorkflowSuggestion(e){return si(this,null,function*(){try{const t={facility_id:this.facilityId,tool_id:e.toolId,recommended_workflow:e.recommendedWorkflow,confidence_score:e.confidence,reasoning:e.reasoning,alternative_workflows:e.alternativeWorkflows,model_id:null,processing_time_ms:0,tool_history_data:{},created_by:null};yield d.from("sterilization_ai_workflow_suggestions").insert(t)}catch(t){console.error("Error saving workflow suggestion:",t)}})}}var Xe=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Ad{constructor(e){this.facilityId=e}getPredictiveAnalytics(e){return Xe(this,null,function*(){try{const{data:t}=yield d.from("autoclave_equipment").select("*").eq("facility_id",this.facilityId),{data:r}=yield d.from("sterilization_cycles").select("*").eq("facility_id",this.facilityId).eq("status","completed").order("created_at",{ascending:!1}).limit(50),i=`
        Analyze sterilization data for predictive insights:
        Equipment: ${JSON.stringify(t)}
        Recent cycles: ${JSON.stringify(r)}
        
        Provide:
        1. Equipment maintenance predictions
        2. Cycle efficiency trends
        3. Quality metrics analysis
        4. Risk factors and recommendations
      `,a=yield D.callOpenAI(i,e||"");return this.parsePredictiveAnalytics(a,t)}catch(t){throw console.error("Predictive analytics failed:",t),new Error("Predictive analytics failed")}})}getRealTimeInsights(){return Xe(this,null,function*(){try{const{data:e}=yield d.from("sterilization_cycles").select("*").eq("facility_id",this.facilityId).gte("created_at",new Date(Date.now()-864e5).toISOString()),t=[];if(e&&e.length>0){const i=yield this.analyzeCycleEfficiency(e);i&&t.push(i)}const{data:r}=yield d.from("autoclave_equipment").select("*").eq("facility_id",this.facilityId);if(r&&r.length>0){const i=yield this.analyzeEquipmentMaintenance(r);i&&t.push(i)}return t}catch(e){return console.error("Real-time insights failed:",e),[]}})}getHistoricalTrends(e){return Xe(this,null,function*(){try{const t=new Date,r=new Date;switch(e){case"week":r.setDate(t.getDate()-7);break;case"month":r.setMonth(t.getMonth()-1);break;case"quarter":r.setMonth(t.getMonth()-3);break;case"year":r.setFullYear(t.getFullYear()-1);break}const{data:i}=yield d.from("sterilization_cycles").select("*").eq("facility_id",this.facilityId).gte("created_at",r.toISOString()).lte("created_at",t.toISOString()).order("created_at",{ascending:!0});if(!i||i.length===0)throw new Error("No historical data available");const a=this.calculateTrends(i),s=this.generateTrendInsights(a),o=this.generateTrendPredictions(a);return{success:!0,trends:a,insights:s,predictions:o}}catch(t){return console.error("Historical trends analysis failed:",t),{success:!1,trends:{efficiency:[],quality:[],duration:[],temperature:[]},insights:["Analysis failed"],predictions:["Unable to generate predictions"]}}})}parsePredictiveAnalytics(e,t){return{equipmentMaintenance:(t==null?void 0:t.map(r=>({equipmentId:r.id,nextMaintenanceDue:new Date(Date.now()+720*60*60*1e3).toISOString(),riskLevel:"medium",predictedIssues:["Calibration needed","Wear detection"]})))||[],cycleEfficiency:{trend:"improving",factors:["Optimized parameters","Better tool grouping"],recommendations:["Continue current practices","Monitor performance"]},qualityMetrics:{currentQuality:.94,predictedQuality:.96,riskFactors:["Temperature variations"],improvementActions:["Standardize procedures"]}}}analyzeCycleEfficiency(e){return Xe(this,null,function*(){try{const t=this.calculateCurrentEfficiency(e);return t<.8?{id:`efficiency-${Date.now()}`,type:"efficiency_improvement",title:"Cycle Efficiency Improvement Opportunity",description:`Current efficiency is ${(t*100).toFixed(1)}%. Optimization could improve this by 15-20%.`,confidence:.85,priority:"medium",actionable:!0,recommendations:["Review cycle parameters","Optimize tool grouping","Analyze temperature settings"],data:{currentEfficiency:t,potentialEfficiency:t+.15},created_at:new Date().toISOString(),facility_id:this.facilityId,severity:"medium",category:"efficiency",timestamp:new Date().toISOString()}:null}catch(t){return console.error("Cycle efficiency analysis failed:",t),null}})}analyzeEquipmentMaintenance(e){return Xe(this,null,function*(){try{const t=e.filter(r=>(new Date(r.last_maintenance).getTime()-Date.now())/(1e3*60*60*24)<=14);return t.length>0?{id:`maintenance-${Date.now()}`,type:"maintenance_prediction",title:"Equipment Maintenance Due Soon",description:`${t.length} piece(s) of equipment require maintenance within 2 weeks.`,confidence:.9,priority:"high",actionable:!0,recommendations:["Schedule maintenance","Review maintenance logs","Check calibration status"],data:{equipmentCount:t.length,daysUntilMaintenance:14},created_at:new Date().toISOString(),facility_id:this.facilityId,severity:"high",category:"maintenance",timestamp:new Date().toISOString()}:null}catch(t){return console.error("Equipment maintenance analysis failed:",t),null}})}calculateCurrentEfficiency(e){if(!e||e.length===0)return .75;const t=e.reduce((r,i)=>{var a;return r+((a=i.duration_minutes)!=null?a:0)},0)/e.length;return Math.max(.5,Math.min(1,1-(t-20)/100))}calculateTrends(e){const t=[],r=[],i=[],a=[];return e.forEach((s,o)=>{var n,l;t.push(.75+o*.02+Math.random()*.1),r.push(.9+o*.01+Math.random()*.05),i.push((n=s.duration_minutes)!=null?n:20),a.push((l=s.temperature)!=null?l:134)}),{efficiency:t,quality:r,duration:i,temperature:a}}generateTrendInsights(e){const t=[];if(e.efficiency.length>1){const r=e.efficiency[e.efficiency.length-1]-e.efficiency[0];r>.1&&t.push(`Efficiency has improved ${(r*100).toFixed(1)}% over the period`)}return e.quality.length>1&&e.quality.reduce((i,a)=>i+a,0)/e.quality.length>.95&&t.push("Quality metrics remain consistently high"),t}generateTrendPredictions(e){const t=[];if(e.efficiency.length>1){const r=e.efficiency[e.efficiency.length-1],i=Math.min(1,r+.05);t.push(`Efficiency expected to reach ${(i*100).toFixed(1)}% by end of quarter`)}return e.quality.length>1&&t.push("Quality metrics likely to maintain 96%+ levels"),t}exportAnalyticsReport(e,t,r){return Xe(this,null,function*(){try{const i=Date.now();let a={};switch(e){case"insights":a={insights:yield this.getRealTimeInsights()};break;case"predictive":a={predictive:yield this.getPredictiveAnalytics()};break;case"historical":a=yield this.getHistoricalTrends("month");break;case"comprehensive":{const[n,l,u]=yield Promise.all([this.getRealTimeInsights(),this.getPredictiveAnalytics(),this.getHistoricalTrends("month")]);a={insights:n,predictive:l,historical:u};break}}const s=yield this.formatReportData(a,t),{error:o}=yield d.from("sterilization_ai_exports").insert({facility_id:this.facilityId,report_type:e,export_format:t,date_range:r,processing_time_ms:Date.now()-i,exported_at:new Date().toISOString()});return o&&console.error("Error saving export record:",o),{success:!0,data:s,downloadUrl:yield this.generateDownloadUrl(s,t)}}catch(i){return console.error("Error exporting analytics report:",i),{success:!1,error:i instanceof Error?i.message:"Export failed"}}})}formatReportData(e,t){return Xe(this,null,function*(){switch(t){case"json":return JSON.stringify(e,null,2);case"csv":return this.convertToCSV(e);case"excel":return this.convertToExcel(e);case"pdf":return this.convertToPDF(e);default:return e}})}generateDownloadUrl(e,t){return Xe(this,null,function*(){const r=new Blob([JSON.stringify(e)],{type:this.getMimeType(t)});return URL.createObjectURL(r)})}getMimeType(e){switch(e){case"csv":return"text/csv";case"excel":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"pdf":return"application/pdf";case"json":return"application/json";default:return"text/plain"}}convertToCSV(e){if(Array.isArray(e)){const t=Object.keys(e[0]||{}),r=[t.join(",")];for(const i of e){const a=t.map(s=>{var o;return JSON.stringify((o=i[s])!=null?o:"")});r.push(a.join(","))}return r.join(`
`)}return JSON.stringify(e)}convertToExcel(e){return e}convertToPDF(e){return e}}var Ua=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Td{constructor(e){this.facilityId=e}analyzeCompliance(e,t){return Ua(this,null,function*(){try{const{data:r}=yield d.from("sterilization_cycles").select("*").eq("id",e).single();if(!r)throw new Error("Cycle not found");const i=yield D.callOpenAI(`Analyze sterilization cycle for compliance: ${JSON.stringify(r)}. Check for regulatory requirements and audit recommendations.`,t||"");return{cycleId:e,complianceScore:D.parseComplianceScore(i),riskFactors:D.parseRiskFactors(i),requiredActions:D.parseRequiredActions(i),auditRecommendations:D.parseAuditRecommendations(i),regulatoryUpdates:this.parseRegulatoryUpdates()}}catch(r){throw console.error("Compliance analysis failed:",r),new Error("Compliance analysis failed")}})}validateBiologicalIndicators(e,t){return Ua(this,null,function*(){try{const r=yield D.callOpenAI(`Analyze biological indicator data: ${JSON.stringify(e)}. Determine if sterilization conditions were properly achieved.`,t||"");return{valid:D.parseBIValidation(r),confidence:.95,recommendations:["Continue current sterilization parameters","Monitor for any trend changes","Schedule next validation per protocol"]}}catch(r){return console.error("BI validation failed:",r),{valid:!1,confidence:.5,recommendations:["Manual validation required"]}}})}parseRegulatoryUpdates(){return["New FDA guidelines effective Q1 2025","Updated AAMI standards for autoclave validation"]}}var te=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Vs{constructor(e){this.facilityId=e,this.settingsManager=new hd(e),this.analysisServices=new bd(e),this.optimizationServices=new Ed(e),this.analyticsServices=new Ad(e),this.complianceServices=new Td(e)}initialize(){return te(this,null,function*(){try{return(yield this.settingsManager.loadSettings())!==null}catch(e){return console.error("Failed to initialize SterilizationAIService:",e),!1}})}loadSettings(){return te(this,null,function*(){return this.settingsManager.loadSettings()})}saveSettings(e){return te(this,null,function*(){return this.settingsManager.saveSettings(e)})}analyzeToolCondition(e,t){return te(this,null,function*(){if(!this.settingsManager.isToolConditionAssessmentEnabled())throw new Error("Tool condition assessment is not enabled");const r=this.settingsManager.getOpenAIKey();return this.analysisServices.analyzeToolCondition(e,t,r)})}detectBarcodeQuality(e){return te(this,null,function*(){if(!this.settingsManager.isBarcodeQualityDetectionEnabled())throw new Error("Barcode quality detection is not enabled");const t=this.settingsManager.getOpenAIKey();return this.analysisServices.detectBarcodeQuality(e,t)})}identifyToolType(e){return te(this,null,function*(){if(!this.settingsManager.isToolTypeRecognitionEnabled())throw new Error("Tool type recognition is not enabled");const t=this.settingsManager.getOpenAIKey();return this.analysisServices.identifyToolType(e,t)})}getCycleOptimization(e){return te(this,null,function*(){if(!this.settingsManager.isCycleOptimizationEnabled())throw new Error("Cycle optimization is not enabled");const t=this.settingsManager.getOpenAIKey();return this.optimizationServices.getCycleOptimization(e,t)})}getWorkflowSuggestion(e,t){return te(this,null,function*(){if(!this.settingsManager.isIntelligentWorkflowSelectionEnabled())throw new Error("Intelligent workflow selection is not enabled");const r=this.settingsManager.getOpenAIKey();return this.optimizationServices.getWorkflowSuggestion(e,t,r)})}getPredictiveAnalytics(){return te(this,null,function*(){if(!this.settingsManager.isPredictiveAnalyticsEnabled())throw new Error("Predictive analytics is not enabled");const e=this.settingsManager.getOpenAIKey();return this.analyticsServices.getPredictiveAnalytics(e)})}getRealTimeInsights(){return te(this,null,function*(){if(!this.settingsManager.isRealTimeMonitoringEnabled())throw new Error("Real-time monitoring is not enabled");return this.analyticsServices.getRealTimeInsights()})}getHistoricalTrends(e){return te(this,null,function*(){if(!this.settingsManager.isPredictiveAnalyticsEnabled())throw new Error("Predictive analytics is not enabled");return this.analyticsServices.getHistoricalTrends(e)})}exportAnalyticsReport(e,t,r){return te(this,null,function*(){if(!this.settingsManager.isPredictiveAnalyticsEnabled())throw new Error("Analytics export is not enabled");return this.analyticsServices.exportAnalyticsReport(e,t,r)})}detectPotentialProblems(e,t){return te(this,null,function*(){if(!this.settingsManager.isAutomatedProblemDetectionEnabled())throw new Error("Automated problem detection is not enabled");const r=this.settingsManager.getOpenAIKey();return this.analysisServices.detectPotentialProblems(e,t,r)})}analyzeCompliance(e){return te(this,null,function*(){if(!this.settingsManager.isComplianceMonitoringEnabled())throw new Error("Compliance monitoring is not enabled");const t=this.settingsManager.getOpenAIKey();return this.complianceServices.analyzeCompliance(e,t)})}validateBiologicalIndicators(e){return te(this,null,function*(){if(!this.settingsManager.isBiologicalIndicatorAnalysisEnabled())throw new Error("Biological indicator analysis is not enabled");const t=this.settingsManager.getOpenAIKey();return this.complianceServices.validateBiologicalIndicators(e,t)})}testChatGPT4Connection(){return te(this,null,function*(){const e=this.settingsManager.getOpenAIKey();return e?D.testConnection(e):{success:!1,response:"",error:"OpenAI API key not configured"}})}isFeatureEnabled(e){return this.settingsManager.isFeatureEnabled(e)}getCurrentSettings(){return this.settingsManager.getCurrentSettings()}getConfidenceThreshold(){return this.settingsManager.getConfidenceThreshold()}getDataRetentionDays(){return this.settingsManager.getDataRetentionDays()}}var ci={},Me=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class kd{constructor(e){this.facilityId=e}processPredictiveCleaningWithAI(){return Me(this,null,function*(){return{predicted_cleaning_date:new Date(Date.now()+2880*60*1e3).toISOString(),confidence_score:.85,urgency_level:"medium",cleaning_type:"routine",estimated_duration:45,required_resources:["cleaning_supplies","staff_2","equipment_standard"],risk_factors:["high_traffic_area","recent_contamination"],optimization_suggestions:["Schedule during low-traffic hours","Use eco-friendly cleaning products","Implement double-cleaning for high-risk areas"]}})}processContaminationPredictionWithAI(){return Me(this,null,function*(){return{contamination_probability:.25,predicted_contamination_type:"bacterial",risk_factors:["high_occupancy","inadequate_ventilation","recent_illness"],prevention_measures:["Increase cleaning frequency","Improve ventilation","Implement additional disinfection protocols"],early_warning_signs:["Increased moisture levels","Unusual odors","Staff illness reports"],confidence_score:.78}})}processResourceOptimizationWithAI(){return Me(this,null,function*(){return{current_usage:{cleaning_supplies:100,staff_hours:40,equipment_usage:8,water_usage:200,energy_consumption:150},optimized_usage:{cleaning_supplies:85,staff_hours:35,equipment_usage:7,water_usage:180,energy_consumption:135},savings_percentage:15,cost_savings:2500,efficiency_improvement:20,recommended_actions:["Implement smart scheduling to reduce staff hours","Use concentrated cleaning products to reduce supply usage","Optimize equipment usage patterns","Install water-efficient cleaning systems"],implementation_timeline:"2-4 weeks",risk_assessment:"low",confidence_score:.82}})}processSmartSchedulingWithAI(){return Me(this,null,function*(){return{optimal_cleaning_time:"2024-09-04T14:00:00Z",staff_recommendations:["experienced_cleaner_1","trainee_cleaner_2"],resource_requirements:["standard_cleaning_kit","disinfection_spray","mop_bucket"],conflict_avoidance:["Avoid patient visiting hours","Schedule around maintenance windows","Coordinate with other departments"],efficiency_score:.88,cost_optimization:.75,quality_assurance:["Pre-cleaning inspection","Post-cleaning verification","Quality checklist completion"],confidence_score:.85}})}processRiskAssessmentWithAI(){return Me(this,null,function*(){return{overall_risk_score:.35,risk_categories:{contamination:.4,compliance:.2,safety:.3,efficiency:.5},risk_factors:["High-traffic areas with increased contamination risk","Aging equipment requiring maintenance","Staff training gaps in new protocols","Inconsistent cleaning schedules"],mitigation_strategies:["Implement enhanced cleaning protocols for high-risk areas","Schedule preventive maintenance for aging equipment","Provide additional staff training on new protocols","Standardize cleaning schedules across all areas"],priority_actions:["Immediate: Schedule equipment maintenance","Short-term: Implement enhanced cleaning protocols","Medium-term: Comprehensive staff training program"],confidence_score:.79}})}processTrendAnalysisWithAI(){return Me(this,null,function*(){return{analysis_type:"cleaning_efficiency",trend_direction:"improving",trend_strength:.7,key_insights:["Cleaning efficiency has improved 15% over the past quarter","Resource usage optimization is showing positive results","Quality scores are consistently above target thresholds"],contributing_factors:["Implementation of new cleaning protocols","Staff training improvements","Better scheduling optimization","Upgraded cleaning equipment"],recommendations:["Continue current optimization strategies","Expand successful protocols to other areas","Monitor for potential plateau effects","Consider additional technology investments"],confidence_score:.84}})}processAnomalyDetectionWithAI(){return Me(this,null,function*(){return{anomaly_type:"resource_spike",severity:"medium",description:"Unusual increase in cleaning supply usage detected in Room 204",detected_at:new Date().toISOString(),normal_range:{daily_usage:"10-15 units",weekly_usage:"70-105 units"},actual_value:{daily_usage:"25 units",weekly_usage:"175 units"},potential_causes:["Increased contamination requiring additional cleaning","Equipment malfunction causing waste","Staff training issue with proper usage","Room usage pattern changes"],recommended_actions:["Investigate room conditions and usage patterns","Check equipment functionality","Review staff training records","Implement usage monitoring for this area"],confidence_score:.76}})}processQualityAssuranceWithAI(){return Me(this,null,function*(){return{quality_score:.87,quality_metrics:{cleanliness:.92,compliance:.85,efficiency:.88,safety:.9},quality_trends:{cleanliness_trend:"improving",compliance_trend:"stable",efficiency_trend:"improving",safety_trend:"stable"},improvement_areas:["Documentation completeness","Staff training consistency","Equipment maintenance scheduling"],best_practices:["Standardized cleaning protocols","Regular quality inspections","Staff feedback integration","Continuous improvement processes"],compliance_status:"compliant",audit_recommendations:["Maintain current quality standards","Focus on documentation improvements","Schedule regular compliance reviews","Implement additional quality checkpoints"],confidence_score:.83}})}buildPredictiveCleaningPrompt(e,t){return`Analyze the following room and historical cleaning data:
    Room Data: ${e}
    Historical Data: ${t}
    
    Please provide:
    1. Predicted optimal cleaning date
    2. Confidence score for prediction
    3. Urgency level assessment
    4. Recommended cleaning type
    5. Estimated duration
    6. Required resources
    7. Risk factors to consider
    8. Optimization suggestions`}buildContaminationPredictionPrompt(e,t){return`Analyze contamination risk based on:
    Room Data: ${e}
    Environmental Data: ${t}
    
    Please provide:
    1. Contamination probability score
    2. Predicted contamination type
    3. Risk factors identified
    4. Prevention measures
    5. Early warning signs to monitor
    6. Confidence score for prediction`}buildResourceOptimizationPrompt(e,t){return`Optimize resource usage based on:
    Current Usage: ${e}
    Cost Data: ${t}
    
    Please provide:
    1. Current vs optimized usage comparison
    2. Savings percentage and cost reduction
    3. Efficiency improvement metrics
    4. Recommended actions
    5. Implementation timeline
    6. Risk assessment
    7. Confidence score for optimization`}buildSmartSchedulingPrompt(e,t,r){return`Create optimal cleaning schedule based on:
    Room Data: ${e}
    Staff Availability: ${t}
    Constraints: ${r}
    
    Please provide:
    1. Optimal cleaning time
    2. Staff recommendations
    3. Resource requirements
    4. Conflict avoidance strategies
    5. Efficiency and cost optimization scores
    6. Quality assurance measures
    7. Confidence score for scheduling`}executeWithRetry(e,t=3,r=100){return Me(this,null,function*(){const{OptimizedRetryService:i}=yield T(()=>Promise.resolve().then(()=>rc),void 0);return yield i.executeWithRetry(e,{maxRetries:t,baseDelay:r,backoffStrategy:"linear",retryCondition:a=>a.message.includes("network")||a.message.includes("timeout")||a.message.includes("rate limit")||a.message.includes("temporary")}).then(a=>{if(!a.success)throw a.error;return a.data})})}executeWithTimeout(e,t=3e4){return Me(this,null,function*(){const r=new Promise((i,a)=>{setTimeout(()=>a(new Error("Operation timed out")),t)});return Promise.race([e,r])})}selectModelForTask(e){switch(e){case"predictive_cleaning":return"gpt-4";case"contamination_prediction":return"gpt-4";case"resource_optimization":return"gpt-4";case"smart_scheduling":return"gpt-4";case"risk_assessment":return"gpt-4";case"trend_analysis":return"gpt-4";case"anomaly_detection":return"gpt-4";case"quality_assurance":return"gpt-4";default:return"gpt-4"}}getProviderConfig(e){const t={openai:{baseUrl:ci.OPENAI_API_BASE_URL||"https://api.openai.com/v1",timeout:3e4,maxRetries:3,model:"gpt-4"},google:{baseUrl:ci.GOOGLE_AI_API_BASE_URL||"https://generativelanguage.googleapis.com/v1",timeout:3e4,maxRetries:3,model:"gemini-pro"},azure:{baseUrl:ci.AZURE_OPENAI_ENDPOINT||"",timeout:3e4,maxRetries:3,model:"gpt-4"},custom:{baseUrl:ci.CUSTOM_AI_ENDPOINT||"",timeout:3e4,maxRetries:3,model:"custom"}};return t[e]||t.openai}}var mn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Cd{constructor(e){this.facilityId=e}getEnvironmentalInsights(){return mn(this,null,function*(){try{return[]}catch(e){return console.error("Error getting environmental insights:",e),[]}})}getHistoricalCleaningData(){return mn(this,null,function*(){try{const{data:e}=yield d.from("environmental_cleans_enhanced").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(30);return e?e.map(t=>({date:t.created_at,room_id:t.room_id,cleaning_type:t.session_type||"routine",duration:this.calculateDuration(t.created_at,t.created_at),quality_score:t.cleaning_quality_score||.8,resources_used:{cleaning_supplies:5,staff_hours:1,equipment_usage:1,water_usage:20,energy_consumption:10}})):[]}catch(e){return console.error("Error getting historical cleaning data:",e),[]}})}calculateDuration(e,t){if(!e||!t)return 30;const r=new Date(e),a=new Date(t).getTime()-r.getTime();return Math.max(Math.floor(a/(1e3*60)),1)}getEnvironmentalCleaningCostData(){return mn(this,null,function*(){try{return{staff_costs:12e3,supply_costs:3e3,equipment_costs:2e3,utility_costs:1500,total_cost:18500}}catch(e){return console.error("Error getting environmental cleaning cost data:",e),{staff_costs:12e3,supply_costs:3e3,equipment_costs:2e3,utility_costs:1500,total_cost:18500}}})}calculateCleaningEfficiency(e,t,r){const i=this.calculateResourceUsageFactor(r),a=e/(t*i);return Math.min(a,1)}calculateResourceUsageFactor(e){const t=e.staff_hours||1,r=e.cleaning_supplies||1,i=e.equipment_usage||1;return(t*.4+r*.3+i*.3)/10}calculateContaminationRisk(e,t,r,i){const a=(Date.now()-new Date(r).getTime())/864e5;let s=.1;s+={operating_room:.3,icu:.25,patient_room:.15,common_area:.1,storage:.05}[e]||.1,s+=t*.2,a>7?s+=.3:a>3&&(s+=.15);const n=i.humidity||50,l=i.temperature||20;return n>70&&(s+=.1),l>25&&(s+=.05),Math.min(s,1)}calculateCostSavings(e,t){const r=e-t,i=r/e*100;return{savings:r,percentage:i}}calculateQualityTrend(e){if(e.length<2)return"stable";const t=e.slice(0,Math.ceil(e.length/2)),r=e.slice(Math.ceil(e.length/2)),i=t.reduce((o,n)=>o+n,0)/t.length,a=r.reduce((o,n)=>o+n,0)/r.length,s=i-a;return s>.05?"improving":s<-.05?"declining":"stable"}calculateResourceEfficiency(e,t){const r=Object.values(e).reduce((a,s)=>a+s,0),i=Object.values(t).reduce((a,s)=>a+s,0);return r===0?0:(r-i)/r*100}detectAnomalies(e,t=2){if(e.length<3)return[];const r=e.reduce((s,o)=>s+o,0)/e.length,i=e.reduce((s,o)=>s+Math.pow(o-r,2),0)/e.length,a=Math.sqrt(i);return e.map((s,o)=>({index:o,value:s,deviation:Math.abs(s-r)/a})).filter(s=>s.deviation>t)}getPriorityFromUrgency(e){switch(e){case"critical":return"critical";case"high":return"high";case"medium":return"medium";case"low":return"low";default:return"medium"}}getPriorityFromProbability(e){return e>=.8?"critical":e>=.6?"high":e>=.4?"medium":"low"}getPriorityFromSavings(e){return e>=30?"critical":e>=20?"high":e>=10?"medium":"low"}getPriorityFromSeverity(e){switch(e){case"critical":return"critical";case"high":return"high";case"medium":return"medium";case"low":return"low";default:return"medium"}}}var ae=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Hs{constructor(e){this.facilityId=e,this.providerService=new kd(e),this.analyticsService=new Cd(e)}initialize(){return ae(this,null,function*(){try{return(yield this.loadSettings())!==null}catch(e){return console.error(e),console.error("Failed to initialize EnvironmentalAIService"),!1}})}loadSettings(){return ae(this,null,function*(){return null})}saveSettings(e){return ae(this,null,function*(){return!1})}initializeSettings(){return ae(this,null,function*(){return!1})}generatePredictiveCleaning(e){return ae(this,null,function*(){return null})}predictContamination(e){return ae(this,null,function*(){return null})}optimizeResources(e){return ae(this,null,function*(){return null})}generateSmartSchedule(e){return ae(this,null,function*(){return null})}assessRisk(e){return ae(this,null,function*(){return null})}analyzeTrends(e){return ae(this,null,function*(){return null})}detectAnomalies(e){return ae(this,null,function*(){return null})}assessQuality(e){return ae(this,null,function*(){return null})}getEnvironmentalInsights(){return ae(this,null,function*(){return this.analyticsService.getEnvironmentalInsights()})}getHistoricalCleaningData(){return ae(this,null,function*(){try{const{data:e,error:t}=yield d.from("environmental_cleans_enhanced").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(100);return t?(console.error("Error getting historical cleaning data:",t),[]):(e==null?void 0:e.map(i=>({id:i.id,facility_id:i.facility_id,room_id:i.room_id,room_name:i.room_name,cleaning_type:i.cleaning_type,status:i.status,started_time:i.started_time,completed_time:i.completed_time,created_at:i.created_at,updated_at:i.updated_at})))||[]}catch(e){return console.error("Error getting historical cleaning data:",e),[]}})}getRoomData(e){return ae(this,null,function*(){var t,r,i,a,s,o,n,l;try{const{data:u,error:h}=yield d.from("environmental_cleans_enhanced").select("*").eq("id",e).eq("facility_id",this.facilityId).single();if(h)return console.error("Error getting room data:",h),null;const f=u;return{id:f.id,room_id:f.id,room_name:(t=f.room_name)!=null?t:"Unknown Room",room_type:(r=f.room_type)!=null?r:"unknown",last_cleaned:(i=f.last_cleaned)!=null?i:new Date().toISOString(),cleaning_frequency:(a=f.cleaning_frequency)!=null?a:1,priority_level:(s=f.priority_level)!=null?s:"medium",contamination_risk:(o=f.contamination_risk)!=null?o:.5,usage_pattern:(n=f.usage_pattern)!=null?n:{},maintenance_status:(l=f.maintenance_status)!=null?l:"good"}}catch(u){return console.error("Error getting room data:",u),null}})}isFeatureEnabled(e,t){return this.getNestedProperty(e,t)===!0}getNestedProperty(e,t){return t.split(".").reduce((r,i)=>r==null?void 0:r[i],e)}}const Fa={"gpt-4":{input:3e-5,output:6e-5},"gpt-4o-mini":{input:15e-5,output:6e-4},"gpt-3.5-turbo":{input:5e-4,output:.0015}};class er{constructor(){this.usageCache=new Map,this.tokenLimit=1e3,this.monitoringService=bt.getInstance()}static getInstance(){return er.instance||(er.instance=new er),er.instance}recordTokenUsage(e,t,r,i,a){const s=Fa[t]||Fa["gpt-4o-mini"],o=r/1e3*s.input,n=i/1e3*s.output,l=o+n,h={tokens:r+i,cost:l,requests:1,timestamp:new Date};this.usageCache.has(e)||this.usageCache.set(e,[]);const f=this.usageCache.get(e);f.push(h);const m=new Date;m.setDate(m.getDate()-30);const p=f.filter(y=>y.timestamp>=m);this.usageCache.set(e,p),this.monitoringService.recordRequest(e,a,0,!1,!1)}getCurrentMonthUsage(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1);let r=0,i=0,a=0;for(const[s,o]of this.usageCache){const n=o.filter(l=>l.timestamp>=t);r+=n.reduce((l,u)=>l+u.tokens,0),i+=n.reduce((l,u)=>l+u.cost,0),a+=n.reduce((l,u)=>l+u.requests,0)}return{tokens:r,cost:i,requests:a}}getDailyUsage(){const e=[],t=new Date;for(let r=6;r>=0;r--){const i=new Date(t);i.setDate(i.getDate()-r);const a=i.toISOString().split("T")[0];let s=0,o=0,n=0;for(const[l,u]of this.usageCache){const h=u.filter(f=>f.timestamp.toISOString().split("T")[0]===a);s+=h.reduce((f,m)=>f+m.tokens,0),o+=h.reduce((f,m)=>f+m.cost,0),n+=h.reduce((f,m)=>f+m.requests,0)}e.push({date:a,tokens:s,cost:o,requests:n})}return e}getFeatureBreakdown(){const e=this.getCurrentMonthUsage(),t=[];for(const[r,i]of this.usageCache){const a=new Date,s=new Date(a.getFullYear(),a.getMonth(),1),o=i.filter(h=>h.timestamp>=s),n=o.reduce((h,f)=>h+f.tokens,0),l=o.reduce((h,f)=>h+f.cost,0),u=e.tokens>0?n/e.tokens*100:0;n>0&&t.push({feature:r,tokens:n,cost:l,percentage:Math.round(u*10)/10})}return t.sort((r,i)=>i.tokens-r.tokens)}getBudgetData(){const t=this.getCurrentMonthUsage().tokens,r=Math.max(0,this.tokenLimit-t),i=t/this.tokenLimit*100;return{limit:this.tokenLimit,used:t,remaining:r,percentage:Math.round(i*10)/10}}getUsageData(){return{currentMonth:this.getCurrentMonthUsage(),dailyUsage:this.getDailyUsage(),featureBreakdown:this.getFeatureBreakdown(),budget:this.getBudgetData()}}setTokenLimit(e){this.tokenLimit=e}getTokenLimit(){return this.tokenLimit}isTokenLimitExceeded(){return this.getBudgetData().percentage>=100}shouldShowTokenLimitWarning(){return this.getBudgetData().percentage>=75}}class tr{constructor(){this.tokenUsageService=er.getInstance()}static getInstance(){return tr.instance||(tr.instance=new tr),tr.instance}trackAnalyticsUsage(e,t,r){this.tokenUsageService.recordTokenUsage("Analytics Queries","gpt-4o-mini",e,t,r)}trackHelpUsage(e,t,r){this.tokenUsageService.recordTokenUsage("Help System","gpt-4o-mini",e,t,r)}trackCourseGenerationUsage(e,t,r){this.tokenUsageService.recordTokenUsage("Course Generation","gpt-4o-mini",e,t,r)}trackForecastingUsage(e,t,r){this.tokenUsageService.recordTokenUsage("Forecasting","gpt-4o-mini",e,t,r)}trackTaskAssignmentUsage(e,t,r){this.tokenUsageService.recordTokenUsage("Task Assignments","gpt-4o-mini",e,t,r)}trackUsage(e,t,r,i,a){this.tokenUsageService.recordTokenUsage(e,t,r,i,a)}getUsageData(){return this.tokenUsageService.getUsageData()}isTokenLimitExceeded(){return this.tokenUsageService.isTokenLimitExceeded()}shouldShowTokenLimitWarning(){return this.tokenUsageService.shouldShowTokenLimitWarning()}setTokenLimit(e){this.tokenUsageService.setTokenLimit(e)}}const La=tr.getInstance();var Pd={},re=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Kr{static askAI(e,t){return re(this,null,function*(){var r,i,a;const s=Pd.VITE_OPENAI_API_KEY;if(!s)throw new Error("AIServiceError: 401 - OpenAI API key not configured");const o=(t==null?void 0:t.module)||"unknown",n=(t==null?void 0:t.facilityId)||"unknown",l=(t==null?void 0:t.userId)||"unknown",u=e.length;e.substring(0,250).replace(/\n/g," ");const h={model:"gpt-4o-mini",messages:[{role:"system",content:"You are Cliniio's AI assistant, specializing in healthcare facility management, sterilization protocols, inventory management, and compliance workflows. Provide accurate, actionable insights based on the data provided."},{role:"user",content:e}],temperature:.3,max_tokens:1e3};let f=null;const m=[1e3,2e3,4e3];for(let y=0;y<=3;y++)try{const g=yield fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify(h)});if(!g.ok){const P=yield g.text().catch(()=>"Unknown error");throw new Error(`AIServiceError: ${g.status} - ${P}`)}const w=(a=(i=(r=(yield g.json()).choices)==null?void 0:r[0])==null?void 0:i.message)==null?void 0:a.content;if(!w)throw new Error("AIServiceError: 500 - No response content from OpenAI");try{yield d.from("ai_usage_logs").insert({facility_id:n,user_id:l,module:o,prompt_length:u,response_length:w.length,success:!0,model:"gpt-4o-mini",created_at:new Date().toISOString()})}catch(P){}const E=Math.ceil(u/4),b=Math.ceil(w.length/4);return La.trackUsage("General AI Questions","gpt-4o-mini",E,b,!0),w}catch(g){f=g instanceof Error?g:new Error(String(g));try{yield d.from("ai_usage_logs").insert({facility_id:n,user_id:l,module:o,prompt_length:u,response_length:0,success:!1,model:"gpt-4o-mini",created_at:new Date().toISOString()})}catch(_){}if(La.trackUsage("General AI Questions","gpt-4o-mini",0,0,!1),y<3){yield new Promise(_=>setTimeout(_,m[y]));continue}}const p=(f==null?void 0:f.message)||"Unknown error";throw js.error("All AI service retries failed",{module:o,facilityId:n,userId:l},{error:p,attempts:3,lastError:f==null?void 0:f.message}),new Error(p)})}static executeOptimizedAI(e,t,r){return re(this,null,function*(){return Et.getInstance().execute(e,t,r)})}static getLearningAI(e){return this.learningAIInstance||(this.learningAIInstance=new Ns(e)),this.learningAIInstance}static getLearningRecommendations(e,t){return re(this,null,function*(){return this.getLearningAI(e).generatePersonalizedRecommendations(t)})}static analyzeSkillGaps(e,t){return re(this,null,function*(){return this.getLearningAI(e).analyzeSkillGaps(t)})}static optimizeLearningPath(e,t){return re(this,null,function*(){return this.getLearningAI(e).optimizeLearningPath(t)})}static getInventoryAI(e){return this.inventoryAIInstance||(this.inventoryAIInstance=new Bs(e)),this.inventoryAIInstance}static analyzeBarcode(e,t){return re(this,null,function*(){return this.getInventoryAI(e).analyzeBarcode(t)})}static performImageRecognition(e,t){return re(this,null,function*(){return this.getInventoryAI(e).analyzeImage(t)})}static generateDemandForecast(e,t,r){return re(this,null,function*(){return this.getInventoryAI(e).generateDemandForecast(t,r)})}static generateCostOptimization(e,t){return re(this,null,function*(){return this.getInventoryAI(e).generateCostOptimization(t)})}static getSterilizationAI(e){return this.sterilizationAIInstance||(this.sterilizationAIInstance=new Vs(e)),this.sterilizationAIInstance}static getSterilizationInsights(e){return re(this,null,function*(){return this.getSterilizationAI(e).getRealTimeInsights()})}static getSterilizationPredictiveAnalytics(e){return re(this,null,function*(){return this.getSterilizationAI(e).getPredictiveAnalytics()})}static getSterilizationRealTimeInsights(e){return re(this,null,function*(){return this.getSterilizationAI(e).getRealTimeInsights()})}static getSterilizationHistoricalTrends(e,t){return re(this,null,function*(){return this.getSterilizationAI(e).getHistoricalTrends(t)})}static getEnvironmentalAI(e){return this.environmentalAIInstance||(this.environmentalAIInstance=new Hs(e)),this.environmentalAIInstance}static analyzeEnvironmentalData(e,t){return re(this,null,function*(){return this.getEnvironmentalAI(e).generatePredictiveCleaning(t)})}static generateEnvironmentalInsights(e){return re(this,null,function*(){return this.getEnvironmentalAI(e).getEnvironmentalInsights()})}static initializeServices(e){return re(this,null,function*(){try{yield this.getLearningAI(e).initialize(),yield this.getInventoryAI(e).initializeSettings(),yield this.getEnvironmentalAI(e).initialize(),console.log(`[UnifiedAIService] All AI services initialized for facility: ${e}`)}catch(t){throw console.error("[UnifiedAIService] Failed to initialize AI services:",t),t}})}static getServiceStatus(){return{learningAI:!!this.learningAIInstance,inventoryAI:!!this.inventoryAIInstance,sterilizationAI:!!this.sterilizationAIInstance,environmentalAI:!!this.environmentalAIInstance}}static clearInstances(){this.learningAIInstance=null,this.inventoryAIInstance=null,this.sterilizationAIInstance=null,this.environmentalAIInstance=null}}Kr.learningAIInstance=null;Kr.inventoryAIInstance=null;Kr.sterilizationAIInstance=null;Kr.environmentalAIInstance=null;var kr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Dd{getArticlesByCategory(e){return kr(this,null,function*(){try{const{data:t,error:r}=yield d.from("help_articles").select("id, slug, title, excerpt, category, subcategory, priority, is_featured, view_count, is_published").eq("category",e).eq("is_published",!0).order("priority",{ascending:!0}).order("created_at",{ascending:!1});return r?(console.error("Error fetching help articles:",r),[]):t||[]}catch(t){return console.error("Error fetching help articles:",t),[]}})}getArticleBySlug(e){return kr(this,null,function*(){try{const{data:t,error:r}=yield d.from("help_articles").select("*").eq("slug",e).eq("is_published",!0).single();return r?(console.error("Error fetching help article:",r),null):t}catch(t){return console.error("Error fetching help article:",t),null}})}incrementViewCount(e){return kr(this,null,function*(){try{const{data:t}=yield d.from("help_articles").select("view_count").eq("slug",e).single();t&&(yield d.from("help_articles").update({view_count:t.view_count+1,last_viewed_at:new Date().toISOString()}).eq("slug",e))}catch(t){console.error("Error incrementing view count:",t)}})}getFeaturedArticles(e=3){return kr(this,null,function*(){try{const{data:t,error:r}=yield d.from("help_articles").select("id, slug, title, excerpt, category, subcategory, priority, is_featured, view_count, is_published").eq("is_published",!0).eq("is_featured",!0).order("priority",{ascending:!0}).order("view_count",{ascending:!1}).limit(e);return r?(console.error("Error fetching featured articles:",r),[]):t||[]}catch(t){return console.error("Error fetching featured articles:",t),[]}})}searchArticles(e,t){return kr(this,null,function*(){try{let r=d.from("help_articles").select("id, slug, title, excerpt, category, subcategory, priority, is_featured, view_count, is_published").eq("is_published",!0).or(`title.ilike.%${e}%,excerpt.ilike.%${e}%`);t&&(r=r.eq("category",t));const{data:i,error:a}=yield r.order("priority",{ascending:!0}).order("view_count",{ascending:!1});return a?(console.error("Error searching help articles:",a),[]):i||[]}catch(r){return console.error("Error searching help articles:",r),[]}})}}const T_=new Dd;var Na=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const k_={submitFeedback(c){return Na(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)return{success:!1,error:"User not authenticated"};const{error:t}=yield d.from("product_feedback").insert([{type:c.type,title:c.title,description:c.description,priority:c.priority,user_id:e.id,contact_email:c.email,page_url:window.location.href,user_agent:navigator.userAgent,browser_info:{language:navigator.language,platform:navigator.platform,cookieEnabled:navigator.cookieEnabled}}]);return t?(console.error("Error submitting feedback:",t),{success:!1,error:t.message}):{success:!0}}catch(e){return console.error("Error submitting feedback:",e),{success:!1,error:e instanceof Error?e.message:"An unknown error occurred"}}})},getFeedbackHistory(){return Na(this,null,function*(){try{const{data:{user:c}}=yield d.auth.getUser();if(!c)return{data:[],error:"User not authenticated"};const{data:e,error:t}=yield d.from("product_feedback").select("*").eq("user_id",c.id).order("created_at",{ascending:!1});return t?(console.error("Error fetching feedback history:",t),{data:[],error:t.message}):{data:e||[]}}catch(c){return console.error("Error fetching feedback history:",c),{data:[],error:"Failed to fetch feedback history"}}})}};var xa=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const C_={fetchStats(){return xa(this,null,function*(){const{data:{user:c},error:e}=yield d.auth.getUser();if(e||!c)return console.error("Stats fetch blocked â€” no authenticated user"),null;const{data:t,error:r}=yield d.from("users").select("facility_id").eq("id",c.id).single();if(r||!(t!=null&&t.facility_id))return console.error("Missing facility_id in user profile"),null;const i=t.facility_id,{data:a,error:s}=yield d.from("user_stats").select("*").eq("facility_id",i).eq("user_id",c.id).single();return s?(console.error("Error fetching stats:",s),null):a})},fetchCumulativeStats(){return xa(this,null,function*(){const{data:{user:c},error:e}=yield d.auth.getUser();return e||!c?(console.error("Cumulative stats fetch blocked â€” no authenticated user"),{toolsSterilized:0,inventoryChecks:0,perfectDays:0,totalTasks:0,completedTasks:0,currentStreak:0,bestStreak:0,totalPoints:0,challengesCompleted:0,totalChallenges:0}):{toolsSterilized:23,inventoryChecks:15,perfectDays:7,totalTasks:12,completedTasks:8,currentStreak:3,bestStreak:12,totalPoints:450,challengesCompleted:5,totalChallenges:8}})}};var Od=Object.defineProperty,Rd=Object.defineProperties,$d=Object.getOwnPropertyDescriptors,Ba=Object.getOwnPropertySymbols,Md=Object.prototype.hasOwnProperty,qd=Object.prototype.propertyIsEnumerable,ja=(c,e,t)=>e in c?Od(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,zd=(c,e)=>{for(var t in e||(e={}))Md.call(e,t)&&ja(c,t,e[t]);if(Ba)for(var t of Ba(e))qd.call(e,t)&&ja(c,t,e[t]);return c},Ud=(c,e)=>Rd(c,$d(e)),pn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const P_={createChallenge(c){return pn(this,null,function*(){try{const{data:{user:e},error:t}=yield d.auth.getUser();if(t||!e)throw new Error("Unauthorized: no authenticated user.");const{data:r,error:i}=yield d.from("users").select("facility_id, role").eq("id",e.id).single();if(i||!(r!=null&&r.facility_id))throw new Error("Missing facility context.");const a=r.facility_id,s=r.role||"staff";if(!["admin","manager"].includes(s))throw new Error("Forbidden: insufficient permissions to create challenges.");const n={title:c.title,description:c.description||"",points:c.points||0,facility_id:a,created_by:e.id,created_at:new Date().toISOString()},{data:l,error:u}=yield d.from("home_challenges").insert([n]).select().single();if(u)throw new Error(u.message);return console.info(`âœ… Challenge created by ${s}:`,l.title),{success:!0,data:l}}catch(e){return console.error("âŒ Challenge creation failed:",e instanceof Error?e.message:String(e)),{success:!1,error:e instanceof Error?e.message:String(e)}}})},fetchUserChallenges(){return pn(this,null,function*(){try{const{data:{user:c},error:e}=yield d.auth.getUser();if(e||!c)return console.warn("âš ï¸ No authenticated user, returning empty challenges"),[];const{data:t,error:r}=yield d.from("users").select("facility_id").eq("id",c.id).single();if(r||!(t!=null&&t.facility_id))return console.warn("âš ï¸ Missing facility context, returning empty challenges"),[];const i=t.facility_id,a=`challenges_and_completions:${i}`,s=Li.get(a);if(s)return console.info("ðŸ§  Loaded challenges from cache:",s.length),s;const[o,n]=yield Promise.all([d.from("home_challenges").select("*").eq("facility_id",i).order("created_at",{ascending:!1}),d.from("home_challenge_completions").select("challenge_id, user_id, completed_at").eq("facility_id",i).eq("user_id",c.id)]);if(o.error)throw new Error(o.error.message);if(n.error)throw new Error(n.error.message);const l=o.data||[],u=n.data||[],h=l.map(f=>{var m;return Ud(zd({},f),{isCompleted:u.some(p=>p.challenge_id===f.id),completedAt:((m=u.find(p=>p.challenge_id===f.id))==null?void 0:m.completed_at)||null})});return Li.set(a,h),console.info(`âœ… Cached ${h.length} merged challenges for ${i}`),h}catch(c){return console.error("âŒ Failed to fetch challenges:",c instanceof Error?c.message:String(c)),[]}})},completeChallenge(c){return pn(this,null,function*(){var e,t;try{const{data:{user:r},error:i}=yield d.auth.getUser();if(i||!r)throw new Error("Unauthorized: no authenticated user.");let a=((e=r.user_metadata)==null?void 0:e.facility_id)||((t=r.app_metadata)==null?void 0:t.facility_id);if(!a){const{data:l,error:u}=yield d.from("users").select("facility_id").eq("id",r.id).single();if(u||!(l!=null&&l.facility_id))throw new Error("Missing facility context.");a=l.facility_id}const{data:s,error:o}=yield d.from("challenge_completions").select("id").eq("challenge_id",c.challenge_id).eq("user_id",r.id).eq("facility_id",a).single();if(o&&o.code!=="PGRST116")throw new Error(o.message);if(s)return console.warn("Challenge already completed by user"),!0;const{error:n}=yield d.from("home_challenge_completions").insert([{challenge_id:c.challenge_id,user_id:r.id,facility_id:a,points_earned:c.points_earned,completed_at:new Date().toISOString()}]);if(n)throw new Error(n.message);return console.info(`âœ… Challenge ${c.challenge_id} completed by user ${r.id}`),!0}catch(r){return console.error("âŒ Challenge completion failed:",r instanceof Error?r.message:String(r)),!1}})}};var Va=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const D_={fetchLeaderboard(){return Va(this,null,function*(){var c;const{data:{user:e},error:t}=yield d.auth.getUser();if(t||!e)return console.error("Leaderboard fetch blocked â€” no authenticated user"),[];const{data:r,error:i}=yield d.from("leaderboard").select("*").eq("facility_id",((c=e.user_metadata)==null?void 0:c.facility_id)||"").order("points",{ascending:!1});return i?(console.error("Error fetching leaderboard:",i),[]):r||[]})},fetchLeaderboardData(){return Va(this,null,function*(){return this.fetchLeaderboard()})}};var Fd=Object.defineProperty,Ha=Object.getOwnPropertySymbols,Ld=Object.prototype.hasOwnProperty,Nd=Object.prototype.propertyIsEnumerable,Ga=(c,e,t)=>e in c?Fd(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,xd=(c,e)=>{for(var t in e||(e={}))Ld.call(e,t)&&Ga(c,t,e[t]);if(Ha)for(var t of Ha(e))Nd.call(e,t)&&Ga(c,t,e[t]);return c};const he={maxTasksPerUser:3,enabledCategories:["equipment","compliance","operational","safety"],priorityThresholds:{low:1,medium:2,high:3,urgent:4},priorityWeights:{low:1,medium:2,high:3,urgent:4},rolePreferences:{technician:["equipment","compliance"],operator:["operational","compliance"],cleaning_staff:["compliance"],inventory_manager:["operational"],supervisor:["safety","operational"]},timeConstraints:{maxTaskDuration:120,minTaskDuration:5},autoAssignment:!0,aiSensitivity:"medium",aiEnabled:!0},Bd={urgent:4,high:3,medium:2,low:1},jd={equipment:["technician","maintenance"],compliance:["supervisor","manager","operator"],operational:["operator","inventory_manager"],safety:["supervisor","manager"]};function Vd(c){var e,t,r,i,a,s,o,n,l,u,h,f,m,p,y,g;return{maxTasksPerUser:(e=c.maxTasksPerUser)!=null?e:he.maxTasksPerUser,enabledCategories:(t=c.enabledCategories)!=null?t:he.enabledCategories,priorityThresholds:{low:(i=(r=c.priorityThresholds)==null?void 0:r.low)!=null?i:he.priorityThresholds.low,medium:(s=(a=c.priorityThresholds)==null?void 0:a.medium)!=null?s:he.priorityThresholds.medium,high:(n=(o=c.priorityThresholds)==null?void 0:o.high)!=null?n:he.priorityThresholds.high,urgent:(u=(l=c.priorityThresholds)==null?void 0:l.urgent)!=null?u:he.priorityThresholds.urgent},priorityWeights:(h=c.priorityWeights)!=null?h:he.priorityWeights,rolePreferences:(f=c.rolePreferences)!=null?f:he.rolePreferences,timeConstraints:(m=c.timeConstraints)!=null?m:he.timeConstraints,autoAssignment:(p=c.autoAssignment)!=null?p:he.autoAssignment,aiSensitivity:(y=c.aiSensitivity)!=null?y:he.aiSensitivity,aiEnabled:(g=c.aiEnabled)!=null?g:he.aiEnabled}}function Wa(c){return Bd[c]}function Gs(c,e){const t=jd[e];return t?t.includes(c):!0}function gn(){return xd({},he)}var li=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Hd{calculateLevel(e){return e<100?1:e<250?2:e<500?3:e<750?4:e<1e3?5:Math.floor(Math.log(e/100)/Math.log(1.5))+5}calculatePointsToNextLevel(e,t){const r=this.getLevelThreshold(e+1);return Math.max(0,r-t)}getLevelThreshold(e){return e<=1?0:e<=5?[0,100,250,500,750,1e3][e-1]:Math.floor(100*Math.pow(1.5,e-5))}calculateUserRank(e,t){return li(this,null,function*(){try{const{data:r,error:i}=yield d.from("home_challenge_completions").select("user_id, points_earned").eq("facility_id",t);if(i)return console.error("Error fetching facility users for ranking:",i),{rank:1,percentile:100};const a=new Map;r==null||r.forEach(u=>{const h=u.user_id,f=u.points_earned;a.set(h,(a.get(h)||0)+f)});const s=Array.from(a.entries()).sort(([,u],[,h])=>h-u),o=s.findIndex(([u])=>u===e),n=o===-1?s.length:o+1,l=Math.round((1-(n-1)/s.length)*100);return{rank:n,percentile:l}}catch(r){return console.error("Error calculating user rank:",r),{rank:1,percentile:100}}})}updateGamificationData(e){return li(this,null,function*(){try{const{data:t,error:r}=yield d.from("home_challenge_completions").select("points_earned").eq("user_id",e.userId).eq("facility_id",e.facilityId);if(r)throw console.error("Error fetching user completions:",r),r;const i=(t||[]).reduce((h,f)=>h+f.points_earned,0),a=this.calculateLevel(i),s=a+1,o=this.calculatePointsToNextLevel(a,i),{rank:n,percentile:l}=yield this.calculateUserRank(e.userId,e.facilityId),u={currentLevel:a,nextLevel:s,pointsToNextLevel:o,totalPoints:i,rank:n,rankPercentile:l};return v.info("Gamification update:",{userId:e.userId,pointsEarned:e.pointsEarned,totalPoints:i,currentLevel:a,rank:n,taskTitle:e.taskTitle}),u}catch(t){throw console.error("Error updating gamification data:",t),t}})}checkLevelUp(e,t,r){return li(this,null,function*(){try{const{data:i,error:a}=yield d.from("home_challenge_completions").select("points_earned").eq("user_id",e).eq("facility_id",t);if(a)return console.error("Error fetching user completions for level check:",a),!1;const s=(i||[]).reduce((l,u)=>l+u.points_earned,0),o=this.calculateLevel(r);return this.calculateLevel(s)>o}catch(i){return console.error("Error checking level up:",i),!1}})}getGamificationSummary(e,t){return li(this,null,function*(){try{const{data:r,error:i}=yield d.from("home_challenge_completions").select("points_earned").eq("user_id",e).eq("facility_id",t);if(i)throw console.error("Error fetching gamification summary:",i),i;const a=(r||[]).reduce((h,f)=>h+f.points_earned,0),s=this.calculateLevel(a),o=s+1,n=this.calculatePointsToNextLevel(s,a),{rank:l,percentile:u}=yield this.calculateUserRank(e,t);return{currentLevel:s,nextLevel:o,pointsToNextLevel:n,totalPoints:a,rank:l,rankPercentile:u}}catch(r){throw console.error("Error getting gamification summary:",r),r}})}}const Gd=new Hd;var Wd=Object.defineProperty,Ka=Object.getOwnPropertySymbols,Kd=Object.prototype.hasOwnProperty,Qd=Object.prototype.propertyIsEnumerable,Qa=(c,e,t)=>e in c?Wd(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ws=(c,e)=>{for(var t in e||(e={}))Kd.call(e,t)&&Qa(c,t,e[t]);if(Ka)for(var t of Ka(e))Qd.call(e,t)&&Qa(c,t,e[t]);return c},Qi=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function Ze(){return`gap-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function Yd(){return`task-${Date.now()}-${Math.random()}`}function Jd(){return`ai-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function Xd(c,e){return Qi(this,null,function*(){try{for(const t of c)for(const r of t.tasks){const{error:i}=yield d.from("home_daily_operations_tasks").insert({facility_id:e,title:r.title,description:r.description,completed:!1,points:r.points,type:r.type,category:r.category,priority:r.priority,due_date:r.dueDate,estimated_duration:r.estimatedDuration,status:"pending",assigned_to:t.userId,created_by:Fe(t.userId)||t.userId,created_at:r.createdAt,updated_at:r.updatedAt});i&&console.error("Error creating daily task:",i)}}catch(t){throw console.error("Error creating daily tasks:",t),t}})}function Zd(c){return Qi(this,null,function*(){const{data:e,error:t}=yield d.from("home_daily_operations_tasks").select("*").eq("assigned_to",c).eq("status","pending").order("priority",{ascending:!1}).order("due_date",{ascending:!0});if(t)throw t;return(e||[]).map(r=>Ws({id:r.id},r))})}function eh(c){return Qi(this,null,function*(){const{data:e,error:t}=yield d.from("home_daily_operations_tasks").select("*").eq("facility_id",c).eq("status","pending").order("priority",{ascending:!1}).order("due_date",{ascending:!0});if(t)throw t;return(e||[]).map(r=>Ws({id:r.id},r))})}function th(c,e){return Qi(this,null,function*(){try{const{data:t,error:r}=yield d.from("home_daily_operations_tasks").select("points, facility_id, title, category").eq("id",c).single();if(r||!t)throw new Error(`Task not found: ${(r==null?void 0:r.message)||"Unknown error"}`);const i=t.points||0,{error:a}=yield d.from("home_daily_operations_tasks").update({completed:!0,status:"completed",completed_by:e,completed_at:new Date().toISOString()}).eq("id",c);if(a)throw new Error(`Failed to complete task: ${a.message}`);if(i>0){const{error:s}=yield d.from("home_challenge_completions").insert({challenge_id:c,user_id:e,facility_id:t.facility_id,points_earned:i,completion_type:"daily_task",task_title:t.title,task_category:t.category});if(s)console.error("Failed to award points for task completion:",s);else{console.log(`Awarded ${i} points for completing task: ${t.title}`);try{const o=yield Gd.updateGamificationData({userId:e,facilityId:t.facility_id,pointsEarned:i,taskTitle:t.title,taskCategory:t.category});o.currentLevel>1&&console.log(`ðŸŽ‰ Level up! User ${e} reached level ${o.currentLevel}`),console.log("Gamification updated:",{level:o.currentLevel,totalPoints:o.totalPoints,rank:o.rank,pointsToNextLevel:o.pointsToNextLevel})}catch(o){console.error("Error updating gamification data:",o)}}}}catch(t){throw console.error("Error completing daily task:",t),t}})}var se=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function rh(){return se(this,null,function*(){const{data:{user:c}}=yield d.auth.getUser();if(!c)throw new Error("User not authenticated");return c.id})}function _e(){return se(this,null,function*(){const{data:{user:c}}=yield d.auth.getUser();if(!c)throw new Error("User not authenticated");const{data:e,error:t}=yield d.from("users").select("facility_id").eq("id",c.id).single();if(t||!e)throw new Error("Failed to get user facility");return e.facility_id})}const me={getToolByBarcode(c){return se(this,null,function*(){const e=yield _e(),{data:t,error:r}=yield d.from("tools").select("*").eq("barcode",c).eq("facility_id",e).maybeSingle();return r?(console.error("ToolService.getToolByBarcode error:",r),null):t})},getToolsByStatus(c){return se(this,null,function*(){const e=yield _e(),{data:t,error:r}=yield d.from("tools").select("*").eq("status",c).eq("facility_id",e);return r?(console.error("ToolService.getToolsByStatus error:",r),[]):t||[]})},updateToolStatus(c,e){return se(this,null,function*(){if(c.startsWith("mock-tool-"))return console.log("ðŸ§ª Skipping database update for mock tool:",c),{id:c,status:e,updated_at:new Date().toISOString()};const t={status:e,facility_id:yield _e(),updated_at:new Date().toISOString()},{data:r,error:i}=yield d.from("tools").update(t).eq("id",c).select().single();if(i)throw i;return r})},getToolByBarcodeAndStatus(c,e){return se(this,null,function*(){if(c==="TEST-CLEAN-001"&&e==="clean")return console.log("ðŸ§ª Using mock tool data for testing Clean Tool workflow"),{id:"mock-tool-test-clean-001",barcode:"TEST-CLEAN-001",tool_type:"surgical_scissors",tool_name:"Test Surgical Scissors",status:"clean",facility_id:"550e8400-e29b-41d4-a716-446655440000",current_cycle_id:"00000000-0000-0000-0000-000000000000",location:"Sterilization Room",sterilization_count:0,notes:"Mock tool for testing Clean Tool workflow",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),latitude:null,longitude:null,gps_accuracy:null,location_timestamp:null,maintenance_due_date:null,metadata:null,model:"Test Model",manufacturer:"Test Manufacturer",serial_number:"TEST-001",is_p2_tool:!1};const t=yield _e(),{data:r,error:i}=yield d.from("tools").select("id, tool_name, barcode, facility_id, current_cycle_id, status, is_p2_tool").eq("barcode",c).eq("status",e).eq("facility_id",t).single();if(i)throw i;return r})},getToolsByFacilityAndStatus(c,e){return se(this,null,function*(){const{data:t,error:r}=yield d.from("tools").select("id, tool_name, barcode, facility_id, current_cycle_id, status, is_p2_tool").eq("facility_id",c).eq("status",e);if(r)throw r;return t})},getToolsByStatuses(c){return se(this,null,function*(){const e=yield _e(),{data:t,error:r}=yield d.from("tools").select("id, tool_name, barcode, facility_id, current_cycle_id, status, is_p2_tool").in("status",c).eq("facility_id",e);if(r)throw r;return t})},updateToolsStatus(c,e){return se(this,null,function*(){const t={status:e,facility_id:yield _e(),updated_at:new Date().toISOString()},{data:r,error:i}=yield d.from("tools").update(t).in("id",c).select();if(i)throw i;return r!=null?r:[]})},updateToolsCyclePhase(c,e,t,r){return se(this,null,function*(){const i={status:e,facility_id:yield _e(),updated_at:new Date().toISOString()},{data:a,error:s}=yield d.from("tools").update(i).in("id",c).select();if(s)throw s;return a!=null?a:[]})},clearCycleAssignment(c,e){return se(this,null,function*(){const t=c.filter(o=>o.startsWith("mock-tool-")),r=c.filter(o=>!o.startsWith("mock-tool-"));if(t.length>0&&console.log("ðŸ§ª Skipping database update for mock tools:",t),r.length===0)return t.map(o=>({id:o,status:e,current_cycle_id:"00000000-0000-0000-0000-000000000000",current_phase:null,updated_at:new Date().toISOString()}));const i={status:e,facility_id:yield _e(),updated_at:new Date().toISOString()},{data:a,error:s}=yield d.from("tools").update(i).in("id",r).select();if(s)throw s;return a!=null?a:[]})},markAsSterilized(c){return se(this,null,function*(){if(c.startsWith("mock-tool-"))return console.log("ðŸ§ª Skipping database update for mock tool:",c),{id:c,last_sterilized:new Date().toISOString(),updated_at:new Date().toISOString()};const e={facility_id:yield _e(),updated_at:new Date().toISOString()},{data:t,error:r}=yield d.from("tools").update(e).eq("id",c).select().single();if(r)throw r;return t})},updateToolPhase(c,e){return se(this,null,function*(){const t={facility_id:yield _e(),updated_at:new Date().toISOString()},{data:r,error:i}=yield d.from("tools").update(t).eq("id",c).select().single();if(i)throw i;return r})},touchTools(c){return se(this,null,function*(){const e={facility_id:yield _e(),updated_at:new Date().toISOString()},{data:t,error:r}=yield d.from("tools").update(e).in("id",c).select();if(r)throw r;return t!=null?t:[]})},persistProblemTool(c,e,t){return se(this,null,function*(){if(c.startsWith("mock-tool-"))return console.log("ðŸ§ª Skipping database update for mock tool:",c),{id:c,status:"problem",updated_at:new Date().toISOString()};const r=yield _e(),i=yield rh(),a={status:"problem",facility_id:r,updated_at:new Date().toISOString(),notes:t?`PROBLEM: ${e} - ${t}`:`PROBLEM: ${e}`},{data:s,error:o}=yield d.from("tools").update(a).eq("id",c).select().single();if(o)throw o;yield this.clearCycleAssignment([c],"problem");const{error:n}=yield d.from("audit_logs").insert({id:crypto.randomUUID(),module:"sterilization",table_name:"tools",action:"tool_marked_problem",record_id:c,user_id:i,facility_id:r,old_values:{status:"available"},new_values:{status:"problem",notes:a.notes},metadata:{problem_type:e,problem_notes:t,timestamp:new Date().toISOString()},created_at:new Date().toISOString()});return n&&console.error("Failed to log problem tool audit event:",n),yield d.from("inventory_items").update({is_available:!1}).eq("tool_id",c).eq("facility_id",r),s})}};var yn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Ge{static applyFilters(e,t){if(!t)return e;let r=e;return t.category&&(r=r.eq("category",t.category)),t.status&&(r=r.eq("status",t.status)),t.location&&(r=r.eq("location",t.location)),t.search&&(r=r.or(`name.ilike.%${t.search}%,category.ilike.%${t.search}%`)),r}static applyFiltersToTable(e,t,r){return yn(this,null,function*(){const{data:{user:i},error:a}=yield e.auth.getUser();if(a||!i)throw new Error("User not authenticated");const{data:s,error:o}=yield e.from("users").select("facility_id").eq("id",i.id).single();if(o||!(s!=null&&s.facility_id))throw new Error("User facility not found");const n=s.facility_id,u=e.from(t).select(`
      id,
      name,
      category,
      quantity,
      unit_cost,
      reorder_point,
      expiration_date,
      data,
      created_at,
      updated_at
    `,{count:"exact"}).eq("facility_id",n);return this.applyFilters(u,r)})}static applyFiltersToSelect(e,t,r,i){const a=e.from(t).select(r,{count:"exact"});return this.applyFilters(a,i)}static applyFiltersToSingle(e,t,r){return e.from(t).select("*").eq("id",r).single()}static applyFiltersToCategories(e,t){return yn(this,null,function*(){const{data:{user:r},error:i}=yield e.auth.getUser();if(i||!r)throw new Error("User not authenticated");const{data:a,error:s}=yield e.from("users").select("facility_id").eq("id",r.id).single();if(s||!(a!=null&&a.facility_id))throw new Error("User facility not found");const o=a.facility_id;return e.from(t).select("category").eq("facility_id",o).not("category","is",null)})}static applyFiltersToLocations(e,t){return yn(this,null,function*(){const{data:{user:r},error:i}=yield e.auth.getUser();if(i||!r)throw new Error("User not authenticated");const{data:a,error:s}=yield e.from("users").select("facility_id").eq("id",r.id).single();if(s||!(a!=null&&a.facility_id))throw new Error("User facility not found");const o=a.facility_id;return e.from(t).select("location").eq("facility_id",o).not("location","is",null)})}static extractUniqueValues(e,t){return Array.from(new Set((e==null?void 0:e.map(r=>r[t]))||[]))}static buildSearchQuery(e,t=["name","category"]){return t.map(r=>`${r}.ilike.%${e}%`).join(",")}static validateFilters(e){if(!e)return!0;if(e.search&&e.search.trim().length<2)return!1;const t=["active","inactive","p2","n/a"];return!(e.status&&!t.includes(e.status))}static getFilterSummary(e){if(!e)return"no filters";const t=[];return e.category&&t.push(`category: ${e.category}`),e.status&&t.push(`status: ${e.status}`),e.location&&t.push(`location: ${e.location}`),e.search&&t.push(`search: "${e.search}"`),t.length>0?t.join(", "):"no filters"}}class le{static handleError(e,t){throw console.error(`âŒ ${t} failed:`,e),e&&typeof e=="object"&&"message"in e?Ve(e):new Error(`${t} failed: ${e}`)}static handleResponse(e,t){return e.error&&this.handleError(e.error,t),e.data}static logStart(e,t){}static logSuccess(e,t){}static logFailure(e,t){console.error(`âŒ ${e} failed:`,t)}}var ih=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function nh(){return ih(this,null,function*(){return yield T(()=>Promise.resolve().then(()=>hp),void 0)})}var qe=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const ah=c=>c instanceof Error?c:typeof c=="object"&&c!==null&&"message"in c?new Error(String(c.message)):new Error("Unknown Supabase error occurred");class q{static getTypedAdapter(){return qe(this,null,function*(){const{TypedSupabaseAdapter:e}=yield nh();return new e})}static getItems(e){return qe(this,null,function*(){const t="Fetching inventory items";Ge.getFilterSummary(e);try{if(!Ge.validateFilters(e))throw new Error("Invalid filter parameters");const i=yield(yield this.getTypedAdapter()).getAllItems({filters:e,orderBy:{column:"created_at",ascending:!1}});if(!i.success||!Array.isArray(i.data))throw new Error(i.error||"Failed to fetch inventory items");const a=i.data;return le.logSuccess(t,`${a.length} items`),{data:a,error:null,count:i.processedCount}}catch(r){throw console.error("âŒ InventoryCrudOperations.getItems failed:",r),le.logFailure(t,r),r}})}static getItemById(e){return qe(this,null,function*(){const t=`Fetching inventory item by ID: ${e}`;try{const i=yield(yield this.getTypedAdapter()).getItemById(e);if(!i.success||!i.data)throw new Error(i.error||"Failed to fetch inventory item");const a=i.data;return le.logSuccess(t,a.name||"Unknown"),a}catch(r){throw le.logFailure(t,r),r}})}static createItem(e){return qe(this,null,function*(){var t,r,i,a,s,o;const n=`Creating inventory item: ${e.name}`;try{const u=yield(yield this.getTypedAdapter()).createItem({facility_id:e.facility_id||"",name:e.name||"",quantity:(t=e.quantity)!=null?t:void 0,data:(r=e.data)!=null?r:void 0,reorder_point:(i=e.reorder_point)!=null?i:void 0,expiration_date:(a=e.expiration_date)!=null?a:void 0,unit_cost:(s=e.unit_cost)!=null?s:void 0,category:(o=e.category)!=null?o:void 0});if(!u.success||!u.data)throw new Error(u.error||"Failed to create inventory item");return le.logSuccess(n,u.data.name||"Unknown"),u.data}catch(l){throw le.logFailure(n,l),l}})}static updateItem(e,t){return qe(this,null,function*(){var r,i,a,s,o,n,l;try{const h=yield(yield this.getTypedAdapter()).updateItem(e,{name:(r=t.name)!=null?r:void 0,quantity:(i=t.quantity)!=null?i:void 0,data:(a=t.data)!=null?a:void 0,reorder_point:(s=t.reorder_point)!=null?s:void 0,expiration_date:(o=t.expiration_date)!=null?o:void 0,unit_cost:(n=t.unit_cost)!=null?n:void 0,category:(l=t.category)!=null?l:void 0});if(!h.success||!h.data)throw new Error(h.error||"Failed to update inventory item");return h.data}catch(u){throw console.error("âŒ Failed to update item in Supabase:",u),u}})}static deleteItem(e){return qe(this,null,function*(){const t=`Deleting inventory item: ${e}`;try{const i=yield(yield this.getTypedAdapter()).deleteItem(e);if(!i.success)throw new Error(i.error||"Failed to delete inventory item");le.logSuccess(t,`Deleted ${e}`)}catch(r){throw le.logFailure(t,r),r}})}static archiveItem(e,t){return qe(this,null,function*(){const r=`Archiving inventory item: ${e}`;try{const{data:{user:i}}=yield d.auth.getUser();if(!i)throw new Error("User not authenticated");const s=yield(yield this.getTypedAdapter()).updateItem(e,{archived:!0,archived_at:new Date().toISOString(),archived_by:i.id,archive_reason:t||"User requested deletion"});if(!s.success)throw new Error(s.error||"Failed to archive inventory item");le.logSuccess(r,`Archived ${e}`)}catch(i){throw le.logFailure(r,i),i}})}static getCategories(){return qe(this,null,function*(){const e="Fetching inventory categories";try{const r=yield(yield this.getTypedAdapter()).getAllItems();if(!r.success||!r.data)throw new Error(r.error||"Failed to fetch categories");const i=Array.from(new Set(r.data.map(a=>a.category).filter(a=>!!a)));return le.logSuccess(e,`${i.length} categories`),i}catch(t){throw le.logFailure(e,t),t}})}static getLocations(){return qe(this,null,function*(){const e="Fetching inventory locations";try{const r=yield(yield this.getTypedAdapter()).getAllItems();if(!r.success||!r.data)throw new Error(r.error||"Failed to fetch locations");const i=Array.from(new Set(r.data.map(a=>{const s=a.data;return s==null?void 0:s.location}).filter(a=>!!a)));return le.logSuccess(e,`${i.length} locations`),i}catch(t){throw le.logFailure(e,t),t}})}static getAnalytics(){return qe(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:t}=yield d.from("users").select("facility_id").eq("id",e.id).single(),r=(t==null?void 0:t.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{data:i,error:a}=yield d.from("inventory_items").select("*").eq("facility_id",r);if(a)throw console.error("âŒ Error fetching analytics from Supabase:",a),ah(a);const s=i||[],o=s.length,n=s.length,l=s.reduce((h,f)=>h+(f.unit_cost||0),0),u={};return s.forEach(h=>{const f=h.category;f&&(u[f]=(u[f]||0)+1)}),{totalItems:o,activeItems:n,totalValue:l,categories:u}}catch(e){throw console.error("âŒ Failed to fetch analytics from Supabase:",e),e}})}}function Ks(c){const e=[];return(!c.name||c.name.trim().length===0)&&e.push("Name is required"),(!c.category||c.category.trim().length===0)&&e.push("Category is required"),(!c.location||c.location.trim().length===0)&&e.push("Location is required"),c.quantity!==void 0&&c.quantity<0&&e.push("Quantity cannot be negative"),c.quantity!==void 0&&c.quantity<0&&e.push("Minimum quantity cannot be negative"),c.quantity!==void 0&&c.quantity<0&&e.push("Maximum quantity cannot be negative"),c.quantity!==void 0&&c.quantity!==void 0&&c.quantity>c.quantity&&e.push("Minimum quantity cannot be greater than maximum quantity"),c.cost!==void 0&&c.cost<0&&e.push("Cost cannot be negative"),c.expiration_date&&new Date(c.expiration_date)<new Date&&e.push("Expiration date cannot be in the past"),c.serialNumber&&c.serialNumber.trim().length===0&&e.push("Serial number cannot be empty"),c.barcode&&c.barcode.trim().length===0&&e.push("Barcode cannot be empty"),{isValid:e.length===0,errors:e}}function xi(c){var e,t,r,i,a,s,o;const n={name:(e=c.name)==null?void 0:e.trim(),description:(t=c.description)==null?void 0:t.trim(),category:(r=c.category)==null?void 0:r.trim(),location:(i=c.location)==null?void 0:i.trim(),status:c.status||"available",quantity:c.quantity||0,cost:c.cost||0,supplier:(a=c.supplier)==null?void 0:a.trim(),serialNumber:(s=c.serialNumber)==null?void 0:s.trim(),barcode:(o=c.barcode)==null?void 0:o.trim(),expiration_date:c.expiration_date,lastUpdated:new Date().toISOString()};return Object.keys(n).forEach(l=>{n[l]===void 0&&delete n[l]}),n}var oh=Object.defineProperty,sh=Object.defineProperties,ch=Object.getOwnPropertyDescriptors,Ya=Object.getOwnPropertySymbols,lh=Object.prototype.hasOwnProperty,uh=Object.prototype.propertyIsEnumerable,Ja=(c,e,t)=>e in c?oh(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,dh=(c,e)=>{for(var t in e||(e={}))lh.call(e,t)&&Ja(c,t,e[t]);if(Ya)for(var t of Ya(e))uh.call(e,t)&&Ja(c,t,e[t]);return c},hh=(c,e)=>sh(c,ch(e)),Q=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function fh(c){return Q(this,null,function*(){try{return(yield q.getItems(c)).data||[]}catch(e){throw console.error("Error getting items:",e),new Error("Failed to get items")}})}function mh(c){return Q(this,null,function*(){try{return yield q.getItemById(c)}catch(e){throw console.error("Error getting item by ID:",e),new Error("Failed to get item by ID")}})}function Qs(c){return Q(this,null,function*(){try{return(yield q.getItems({category:c})).data||[]}catch(e){throw console.error("Error getting items by category:",e),new Error("Failed to get items by category")}})}function ph(c){return Q(this,null,function*(){try{return(yield q.getItems({location:c})).data||[]}catch(e){throw console.error("Error getting items by location:",e),new Error("Failed to get items by location")}})}function gh(c){return Q(this,null,function*(){try{return(yield q.getItems({status:c})).data||[]}catch(e){throw console.error("Error getting items by status:",e),new Error("Failed to get items by status")}})}function yh(c){return Q(this,null,function*(){try{return(yield q.getItems({search:c})).data||[]}catch(e){throw console.error("Error searching items:",e),new Error("Failed to search items")}})}function _h(){return Q(this,null,function*(){try{return(yield q.getItems({})).data||[]}catch(c){throw console.error("Error getting low stock items:",c),new Error("Failed to get low stock items")}})}function vh(c=30){return Q(this,null,function*(){try{return(yield q.getItems({})).data||[]}catch(e){throw console.error("Error getting expiring items:",e),new Error("Failed to get expiring items")}})}function Ys(c){return Q(this,null,function*(){try{const e=xi(c);return yield q.createItem(e)}catch(e){throw console.error("Error creating item:",e),new Error("Failed to create item")}})}function Bi(c,e){return Q(this,null,function*(){try{if(!c)throw new Error("Item ID is required");const t=xi(e);return yield q.updateItem(c,t)}catch(t){throw console.error("Error updating item:",t),new Error("Failed to update item")}})}function ji(c){return Q(this,null,function*(){try{if(!c)throw new Error("Item ID is required");yield q.deleteItem(c)}catch(e){throw console.error("Error deleting item:",e),new Error("Failed to delete item")}})}function Js(c){return Q(this,null,function*(){try{if(!c)throw new Error("Item ID is required");return yield q.updateItem(c,{status:"archived",lastUpdated:new Date().toISOString()})}catch(e){throw console.error("Error archiving item:",e),new Error("Failed to archive item")}})}function Xs(c){return Q(this,null,function*(){try{if(!c)throw new Error("Item ID is required");const e=yield q.getItemById(c);if(!e)throw new Error("Original item not found");const t=hh(dh({},e),{name:`${e.name} (Copy)`,id:void 0,lastUpdated:void 0});return yield q.createItem(t)}catch(e){throw console.error("Error duplicating item:",e),new Error("Failed to duplicate item")}})}function Zs(c,e){return Q(this,null,function*(){try{const r=(yield Qs(c)).map(s=>q.updateItem(s.id,e));return{updatedCount:(yield Promise.allSettled(r)).filter(s=>s.status==="fulfilled").length}}catch(t){throw console.error("Error in bulk update by category:",t),new Error("Failed to bulk update items by category")}})}function wh(c){return Q(this,null,function*(){try{return yield Ec(c)}catch(e){throw console.error("Error getting suppliers by facility:",e),new Error("Failed to get suppliers by facility")}})}function Ih(c){return Q(this,null,function*(){try{return yield Ac(c)}catch(e){throw console.error("Error getting inventory transactions by facility:",e),new Error("Failed to get inventory transactions by facility")}})}function Sh(c){return Q(this,null,function*(){try{return yield Tc(c)}catch(e){throw console.error("Error getting inventory costs by facility:",e),new Error("Failed to get inventory costs by facility")}})}function bh(c){return Q(this,null,function*(){try{return yield kc(c)}catch(e){throw console.error("Error getting equipment maintenance by facility:",e),new Error("Failed to get equipment maintenance by facility")}})}const _n=Object.freeze(Object.defineProperty({__proto__:null,archiveItem:Js,bulkUpdateItemsByCategory:Zs,createItem:Ys,deleteItem:ji,duplicateItem:Xs,getEquipmentMaintenanceByFacilityDb:bh,getExpiringItems:vh,getInventoryCostsByFacilityDb:Sh,getInventoryTransactionsByFacilityDb:Ih,getItemById:mh,getItems:fh,getItemsByCategory:Qs,getItemsByLocation:ph,getItemsByStatus:gh,getLowStockItems:_h,getSuppliersByFacilityDb:wh,searchItems:yh,updateItem:Bi},Symbol.toStringTag,{value:"Module"}));class Eh{constructor(){this.cache={data:null,timestamp:0,ttl:300*1e3,hits:0,misses:0,evictions:0}}get(){return this.cache.data&&Date.now()-this.cache.timestamp<this.cache.ttl?(this.cache.hits++,this.cache.data):(this.cache.misses++,null)}set(e){this.cache.data=e,this.cache.timestamp=Date.now()}clear(){this.cache.data&&this.cache.evictions++,this.cache.data=null,this.cache.timestamp=0}getStats(){return{hits:this.cache.hits,misses:this.cache.misses,size:this.cache.data?JSON.stringify(this.cache.data).length:0,lastUpdated:new Date(this.cache.timestamp).toISOString(),updated_at:new Date(this.cache.timestamp).toISOString()}}isValid(){return!!(this.cache.data&&Date.now()-this.cache.timestamp<this.cache.ttl)}}var Xa=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class C{static handleOperation(e,t){return Xa(this,null,function*(){try{return yield t()}catch(r){throw console.error(`âŒ ${e} failed:`,r),r}})}static executeWithRetry(e,t,r=3){return Xa(this,null,function*(){let i=null;for(let a=1;a<=r;a++)try{return yield t()}catch(s){if(i=s instanceof Error?s:new Error("Unknown error"),a===r)throw s;console.warn(`Retry attempt ${a}/${r} for operation: ${e}`),yield new Promise(o=>setTimeout(o,1e3*a))}throw i||new Error("Operation failed after all retry attempts")})}static delay(e){return new Promise(t=>setTimeout(t,e))}}class Hn{constructor(){this.cacheManagers=new Map}static getInstance(){return this.instance||(this.instance=new Hn),this.instance}registerCacheManager(e,t){this.cacheManagers.set(e,t),console.log(`ðŸ“ Registered cache manager: ${e}`)}unregisterCacheManager(e){this.cacheManagers.delete(e),console.log(`ðŸ“ Unregistered cache manager: ${e}`)}onInvalidation(){console.log("ðŸ“ Cache invalidation listener registered (simplified)")}offInvalidation(){console.log("ðŸ“ Cache invalidation listener removed (simplified)")}invalidatePattern(e){console.log(`ðŸ§¹ Invalidating cache pattern: ${e}`),this.cacheManagers.forEach((t,r)=>{(r.includes(e)||e==="all")&&(t.invalidatePattern?t.invalidatePattern(e):t.clearCache())})}invalidateKey(e){console.log(`ðŸ§¹ Invalidating cache key: ${e}`),this.cacheManagers.forEach(t=>{t.invalidateKey&&t.invalidateKey(e)})}invalidateRelated(e,t){console.log(`ðŸ§¹ Invalidating related caches for operation: ${e}${t?` (${t})`:""}`),e.startsWith("inventory:")?this.invalidatePattern("inventory"):e.startsWith("knowledge:")?this.invalidatePattern("knowledge"):e.startsWith("cleaning:")?this.invalidatePattern("cleaning"):(e==="user:login"||e==="user:logout"||e==="app:refresh")&&this.clearAllCaches()}clearAllCaches(){console.log("ðŸ§¹ Clearing all caches"),this.cacheManagers.forEach(e=>{e.clearCache()})}getRegisteredManagers(){return Array.from(this.cacheManagers.keys())}isRegistered(e){return this.cacheManagers.has(e)}}const W=Hn.getInstance();var Ah=Object.defineProperty,Za=Object.getOwnPropertySymbols,Th=Object.prototype.hasOwnProperty,kh=Object.prototype.propertyIsEnumerable,eo=(c,e,t)=>e in c?Ah(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Cr=(c,e)=>{for(var t in e||(e={}))Th.call(e,t)&&eo(c,t,e[t]);if(Za)for(var t of Za(e))kh.call(e,t)&&eo(c,t,e[t]);return c},ui=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class x{static initialize(){this.flushInterval=setInterval(()=>{this.flushQueues()},3e4),this.setupErrorHandlers(),console.log("Monitoring service initialized")}static logEvent(e,t,r,i="info",a){const s={category:e,action:t,level:i,message:r,metadata:a,timestamp:new Date().toISOString()};this.eventQueue.push(s),i==="error"&&this.flushQueues()}static trackMetric(e,t,r,i,a){const s={name:e,value:t,unit:r,category:i,timestamp:new Date().toISOString(),metadata:a};this.metricQueue.push(s),this.metricQueue.length>=this.MAX_BATCH_SIZE&&this.flushQueues()}static reportError(e,t,r){const i={error:e,context:t,userAgent:navigator.userAgent,timestamp:new Date().toISOString(),metadata:r};this.errorQueue.push(i),console.error(`[ERROR] ${t}:`,e,r),this.flushQueues()}static trackUserAction(e,t,r){this.logEvent(t,e,`User performed ${e}`,"info",r)}static trackApiCall(e,t,r,i,a){this.trackMetric("api_call_duration",r,"ms","api",Cr({endpoint:e,method:t,status:i},a)),r>1e3&&this.logEvent("api","slow_request",`Slow API call: ${t} ${e} took ${r}ms`,"warn",Cr({endpoint:e,method:t,duration:r,status:i},a)),i>=400&&this.logEvent("api","failed_request",`Failed API call: ${t} ${e} returned ${i}`,"error",Cr({endpoint:e,method:t,status:i},a))}static trackPageView(e,t){this.logEvent("navigation","page_view",`User viewed ${e}`,"info",Cr({page:e},t))}static trackFeatureUsage(e,t,r){this.logEvent("feature",t,`Feature used: ${e}`,"info",Cr({feature:e},r))}static flushQueues(){return ui(this,null,function*(){try{if(!ht()){console.warn("âš ï¸ Supabase not configured, skipping monitoring queue flush");return}this.eventQueue.length>0&&(yield this.flushEvents()),this.metricQueue.length>0&&(yield this.flushMetrics()),this.errorQueue.length>0&&(yield this.flushErrors())}catch(e){console.error("Failed to flush monitoring queues:",e)}})}static flushEvents(){return ui(this,null,function*(){const e=this.eventQueue.splice(0,this.MAX_BATCH_SIZE);console.log("ðŸ“Š Monitoring: Would flush",e.length,"events (disabled for debugging)");const{data:{user:t}}=yield d.auth.getUser();let r=null;if(t){const{data:i}=yield d.from("users").select("facility_id").eq("id",t.id).single();r=(i==null?void 0:i.facility_id)||null}console.log("ðŸ“Š Monitoring: User context:",{userId:t==null?void 0:t.id,facilityId:r,eventsQueued:this.eventQueue.length})})}static flushMetrics(){return ui(this,null,function*(){const e=this.metricQueue.splice(0,this.MAX_BATCH_SIZE),{data:{user:t}}=yield d.auth.getUser();let r=null;if(t){const{data:a}=yield d.from("users").select("facility_id").eq("id",t.id).single();r=(a==null?void 0:a.facility_id)||null}const{error:i}=yield d.from("monitoring_performance_metrics").insert(e.map(a=>({metric_name:a.name,metric_value:a.value,facility_id:r||"default",created_at:a.timestamp})));i&&(console.error("Failed to flush performance metrics:",i),this.metricQueue.unshift(...e))})}static flushErrors(){return ui(this,null,function*(){const e=this.errorQueue.splice(0,this.MAX_BATCH_SIZE),{data:{user:t}}=yield d.auth.getUser();let r=null;if(t){const{data:a}=yield d.from("users").select("facility_id").eq("id",t.id).single();r=(a==null?void 0:a.facility_id)||null}const{error:i}=yield d.from("error_reports").insert(e.map(a=>({error_message:a.error instanceof Error?a.error.message:a.error,error_stack:a.error instanceof Error?a.error.stack:void 0,context:a.context,user_agent:a.userAgent,metadata:a.metadata,user_id:(t==null?void 0:t.id)||null,facility_id:r,created_at:a.timestamp})));i&&(console.error("Failed to flush error reports:",i),this.errorQueue.unshift(...e))})}static setupErrorHandlers(){window.addEventListener("unhandledrejection",e=>{this.reportError(e.reason,"unhandled_promise_rejection",{promise:e.promise})}),window.addEventListener("error",e=>{this.reportError(e.error||new Error(e.message),"javascript_error",{filename:e.filename,lineno:e.lineno,colno:e.colno})})}static cleanup(){this.flushInterval&&(clearInterval(this.flushInterval),this.flushInterval=null),this.flushQueues()}}x.MAX_BATCH_SIZE=50;x.eventQueue=[];x.metricQueue=[];x.errorQueue=[];x.flushInterval=null;const M=x.logEvent.bind(x);x.trackMetric.bind(x);x.reportError.bind(x);const z=x.trackUserAction.bind(x);x.trackApiCall.bind(x);x.trackPageView.bind(x);x.trackFeatureUsage.bind(x);typeof window!="undefined"&&x.initialize();var Ch=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class A{static trackEvent(e,t){return Ch(this,null,function*(){try{console.log("Analytics Event:",{eventName:e,properties:t,timestamp:new Date}),(e.includes("track_")||e.includes("tool_"))&&console.log("Event forwarded to tracking analytics service:",e)}catch(r){console.warn("Failed to track analytics event:",r)}})}}var Ph=Object.defineProperty,Dh=Object.defineProperties,Oh=Object.getOwnPropertyDescriptors,to=Object.getOwnPropertySymbols,Rh=Object.prototype.hasOwnProperty,$h=Object.prototype.propertyIsEnumerable,ro=(c,e,t)=>e in c?Ph(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Mh=(c,e)=>{for(var t in e||(e={}))Rh.call(e,t)&&ro(c,t,e[t]);if(to)for(var t of to(e))$h.call(e,t)&&ro(c,t,e[t]);return c},qh=(c,e)=>Dh(c,Oh(e)),ve=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function zh(c){return Qe.categorizeItems(c)}function Uh(c){return Qe.withNormalizedCategory(c)}class Qe{constructor(e,t){this.adapter=e,this.adapterType=t}static normalizeCategory(e){const t=e.toLowerCase().trim();return t.includes("mask")||t.includes("glove")||t.includes("gown")||t.includes("supply")?"Supplies":t.includes("scalpel")||t.includes("forceps")||t.includes("tool")||t.includes("instrument")?"Tools":t.includes("chair")||t.includes("autoclave")||t.includes("machine")||t.includes("equipment")?"Equipment":t.includes("computer")||t.includes("printer")||t.includes("office")||t.includes("hardware")?"Office Hardware":"Tools"}static categorizeItems(e){const t=[],r=[],i=[],a=[];return e.forEach(s=>{switch(this.normalizeCategory(String(s.category||""))){case"Tools":t.push(s);break;case"Supplies":r.push(s);break;case"Equipment":i.push(s);break;case"Office Hardware":a.push(s);break;default:t.push(s);break}}),{tools:t,supplies:r,equipment:i,officeHardware:a}}static withNormalizedCategory(e){return e.map(t=>qh(Mh({},t),{category:this.normalizeCategory(t.category)}))}addCategory(e){return ve(this,null,function*(){return{success:yield C.handleOperation("addCategory",()=>ve(this,null,function*(){return yield this.adapter.addCategory(e),W.invalidateRelated("inventory:categories",e),M("inventory","category_created",`Category created: ${e}`,"info",{category:e,adapterType:this.adapterType}),z("create_category","inventory",{category:e}),A.trackEvent("inventory_category_created",{category:e,adapterType:this.adapterType}),!0})),error:null}})}deleteCategory(e){return ve(this,null,function*(){return{success:yield C.handleOperation("deleteCategory",()=>ve(this,null,function*(){return yield this.adapter.deleteCategory(e),W.invalidateRelated("inventory:categories",e),M("inventory","category_deleted",`Category deleted: ${e}`,"info",{category:e,adapterType:this.adapterType}),z("delete_category","inventory",{category:e}),A.trackEvent("inventory_category_deleted",{category:e,adapterType:this.adapterType}),!0})),error:null}})}getCategories(){return ve(this,null,function*(){return{data:yield C.handleOperation("getCategories",()=>ve(this,null,function*(){return yield this.adapter.fetchCategories()})),error:null}})}getNormalizedCategories(){return ve(this,null,function*(){return{data:yield C.handleOperation("getNormalizedCategories",()=>ve(this,null,function*(){const r=(yield this.adapter.fetchCategories()).map(i=>Qe.normalizeCategory(i));return Array.from(new Set(r))})),error:null}})}getCategoryStats(){return ve(this,null,function*(){return{data:yield C.handleOperation("getCategoryStats",()=>ve(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r={};return t.forEach(i=>{const a=Qe.normalizeCategory(i.category||"");r[a]=(r[a]||0)+1}),r})),error:null}})}static validateCategoryName(e){const t=[];return(!e||e.trim()==="")&&t.push("Category name is required"),e.length>100&&t.push("Category name must be less than 100 characters"),/^[a-zA-Z0-9\s\-_]+$/.test(e)||t.push("Category name contains invalid characters"),{isValid:t.length===0,errors:t}}static getCategorySuggestions(e){const t=e.toLowerCase(),r=[];return(t.includes("mask")||t.includes("glove")||t.includes("gown"))&&r.push("Supplies"),(t.includes("scalpel")||t.includes("forceps")||t.includes("tool"))&&r.push("Tools"),(t.includes("chair")||t.includes("autoclave")||t.includes("machine"))&&r.push("Equipment"),(t.includes("computer")||t.includes("printer")||t.includes("office"))&&r.push("Office Hardware"),r.length===0&&r.push("Tools","Supplies","Equipment","Office Hardware"),r}mergeCategories(e,t){return ve(this,null,function*(){return{success:yield C.handleOperation("mergeCategories",()=>ve(this,null,function*(){const a=(yield this.adapter.fetchInventoryItems()).filter(n=>n.category===e);for(const n of a)yield this.adapter.updateInventoryItem(n.id,{category:t});return(yield this.adapter.fetchInventoryItems()).some(n=>n.category===e)||(yield this.adapter.deleteCategory(e)),M("inventory","category_merged",`Category merged: ${e} -> ${t}`,"info",{sourceCategory:e,targetCategory:t,itemsUpdated:a.length,adapterType:this.adapterType}),z("merge_category","inventory",{sourceCategory:e,targetCategory:t,itemsUpdated:a.length}),A.trackEvent("inventory_category_merged",{sourceCategory:e,targetCategory:t,itemsUpdated:a.length,adapterType:this.adapterType}),!0})),error:null}})}}var Fh=Object.defineProperty,Lh=Object.defineProperties,Nh=Object.getOwnPropertyDescriptors,io=Object.getOwnPropertySymbols,xh=Object.prototype.hasOwnProperty,Bh=Object.prototype.propertyIsEnumerable,no=(c,e,t)=>e in c?Fh(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,jh=(c,e)=>{for(var t in e||(e={}))xh.call(e,t)&&no(c,t,e[t]);if(io)for(var t of io(e))Bh.call(e,t)&&no(c,t,e[t]);return c},Vh=(c,e)=>Lh(c,Nh(e)),V=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Hh{constructor(e,t){this.adapter=e,this.adapterType=t}fetchInventoryItems(){return V(this,null,function*(){return yield C.handleOperation("fetchInventoryItems",()=>V(this,null,function*(){return yield this.adapter.fetchInventoryItems()}))})}getItemById(e){return V(this,null,function*(){return yield C.handleOperation("getItemById",()=>V(this,null,function*(){return{data:(yield this.adapter.fetchInventoryItems()).find(a=>a.id===e)||null,error:null}}))})}createItem(e){return V(this,null,function*(){return{data:yield C.handleOperation("createItem",()=>V(this,null,function*(){const r=yield this.adapter.addInventoryItem(e);return W.invalidateRelated("inventory:create",r.id),M("inventory","item_created",`Inventory item created: ${e.name||e.item}`,"info",{itemId:r.id,itemName:e.name||e.item,category:e.category,adapterType:this.adapterType}),z("create_item","inventory",{itemId:r.id,itemName:e.name||e.item,category:e.category}),A.trackEvent("inventory_item_created",{itemId:r.id,itemName:e.name||e.item,category:e.category,adapterType:this.adapterType}),r})),error:null}})}updateItem(e,t){return V(this,null,function*(){return{data:yield C.handleOperation("updateItem",()=>V(this,null,function*(){const i=yield this.adapter.updateInventoryItem(e,t);return W.invalidateRelated("inventory:update",e),M("inventory","item_updated",`Inventory item updated: ${e}`,"info",{itemId:e,updates:Object.keys(t),adapterType:this.adapterType}),z("update_item","inventory",{itemId:e,updates:Object.keys(t)}),A.trackEvent("inventory_item_updated",{itemId:e,updates:Object.keys(t).join(","),adapterType:this.adapterType}),i})),error:null}})}deleteItem(e){return V(this,null,function*(){return{success:yield C.handleOperation("deleteItem",()=>V(this,null,function*(){return yield this.adapter.deleteInventoryItem(e),W.invalidateRelated("inventory:delete",e),M("inventory","item_deleted",`Inventory item deleted: ${e}`,"info",{itemId:e,adapterType:this.adapterType}),z("delete_item","inventory",{itemId:e}),A.trackEvent("inventory_item_deleted",{itemId:e,adapterType:this.adapterType}),!0})),error:null}})}addInventoryItem(e){return V(this,null,function*(){return yield C.handleOperation("addInventoryItem",()=>V(this,null,function*(){const r=yield this.adapter.addInventoryItem(e);return W.invalidateRelated("inventory:create",e.id),M("inventory","item_created",`Inventory item created: ${e.name||e.item}`,"info",{itemId:e.id,itemName:e.name||e.item,category:e.category,adapterType:this.adapterType}),z("create_item","inventory",{itemId:e.id,itemName:e.name||e.item,category:e.category}),A.trackEvent("inventory_item_created",{itemId:e.id,itemName:e.name||e.item,category:e.category,adapterType:this.adapterType}),r}))})}static validateItemData(e){const t=[];return!e.name&&!e.item&&t.push("Item name is required"),e.category||t.push("Category is required"),e.quantity!==void 0&&e.quantity<0&&t.push("Quantity must be non-negative"),e.minimumStock!==void 0&&e.minimumStock<0&&t.push("Minimum stock must be non-negative"),e.location&&e.location.length>200&&t.push("Location must be less than 200 characters"),e.description&&e.description.length>1e3&&t.push("Description must be less than 1000 characters"),{isValid:t.length===0,errors:t}}duplicateItem(e,t){return V(this,null,function*(){return{data:yield C.handleOperation("duplicateItem",()=>V(this,null,function*(){const i=yield this.getItemById(e);if(!i.data)throw new Error("Original item not found");const a=Vh(jh({},i.data),{name:t||`${i.data.name} (Copy)`,id:""}),s=yield this.adapter.addInventoryItem(a);return W.invalidateRelated("inventory:create",s.id),M("inventory","item_duplicated",`Inventory item duplicated: ${e} -> ${s.id}`,"info",{originalItemId:e,newItemId:s.id,adapterType:this.adapterType}),z("duplicate_item","inventory",{originalItemId:e,newItemId:s.id}),A.trackEvent("inventory_item_duplicated",{originalItemId:e,newItemId:s.id,adapterType:this.adapterType}),s})),error:null}})}archiveItem(e,t){return V(this,null,function*(){return{data:yield C.handleOperation("archiveItem",()=>V(this,null,function*(){const i=yield this.adapter.updateInventoryItem(e,{status:"archived",archiveReason:t});return W.invalidateRelated("inventory:update",e),M("inventory","item_archived",`Inventory item archived: ${e}`,"info",{itemId:e,reason:t,adapterType:this.adapterType}),z("archive_item","inventory",{itemId:e,reason:t}),A.trackEvent("inventory_item_archived",{itemId:e,reason:t,adapterType:this.adapterType}),i})),error:null}})}restoreItem(e){return V(this,null,function*(){return{data:yield C.handleOperation("restoreItem",()=>V(this,null,function*(){const r=yield this.adapter.updateInventoryItem(e,{status:"active",archiveReason:null});return W.invalidateRelated("inventory:update",e),M("inventory","item_restored",`Inventory item restored: ${e}`,"info",{itemId:e,adapterType:this.adapterType}),z("restore_item","inventory",{itemId:e}),A.trackEvent("inventory_item_restored",{itemId:e,adapterType:this.adapterType}),r})),error:null}})}}var ue=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Gh{constructor(e,t){this.adapter=e,this.adapterType=t}bulkCreateItems(e){return ue(this,null,function*(){return yield C.handleOperation("bulkCreateItems",()=>ue(this,null,function*(){const r=[],i=[];let a=0,s=0;for(const o of e)try{const n=yield this.adapter.addInventoryItem(o);r.push(n),W.invalidateRelated("inventory:create",n.id),a++}catch(n){i.push(`Failed to create item ${o.name||o.item}: ${n instanceof Error?n.message:"Unknown error"}`),s++}return M("inventory","bulk_items_created",`Bulk created ${a} items, ${s} failed`,"info",{totalItems:e.length,successCount:a,errorCount:s,adapterType:this.adapterType}),z("bulk_create_items","inventory",{totalItems:e.length,successCount:a,errorCount:s}),A.trackEvent("inventory_bulk_items_created",{totalItems:e.length,successCount:a,errorCount:s,adapterType:this.adapterType}),{success:s===0,processedCount:e.length,successCount:a,errorCount:s,errors:i,data:r}}))})}bulkUpdateItems(e){return ue(this,null,function*(){return yield C.handleOperation("bulkUpdateItems",()=>ue(this,null,function*(){const r=[],i=[];let a=0,s=0;for(const o of e)try{const n=yield this.adapter.updateInventoryItem(o.id,o.updates);r.push(n),W.invalidateRelated("inventory:update",o.id),a++}catch(n){i.push(`Failed to update item ${o.id}: ${n instanceof Error?n.message:"Unknown error"}`),s++}return M("inventory","bulk_items_updated",`Bulk updated ${a} items, ${s} failed`,"info",{totalItems:e.length,successCount:a,errorCount:s,adapterType:this.adapterType}),z("bulk_update_items","inventory",{totalItems:e.length,successCount:a,errorCount:s}),A.trackEvent("inventory_bulk_items_updated",{totalItems:e.length,successCount:a,errorCount:s,adapterType:this.adapterType}),{success:s===0,processedCount:e.length,successCount:a,errorCount:s,errors:i,data:r}}))})}bulkDeleteItems(e){return ue(this,null,function*(){return yield C.handleOperation("bulkDeleteItems",()=>ue(this,null,function*(){const r=[];let i=0,a=0;for(const s of e)try{yield this.adapter.deleteInventoryItem(s),W.invalidateRelated("inventory:delete",s),i++}catch(o){r.push(`Failed to delete item ${s}: ${o instanceof Error?o.message:"Unknown error"}`),a++}return M("inventory","bulk_items_deleted",`Bulk deleted ${i} items, ${a} failed`,"info",{totalItems:e.length,successCount:i,errorCount:a,adapterType:this.adapterType}),z("bulk_delete_items","inventory",{totalItems:e.length,successCount:i,errorCount:a}),A.trackEvent("inventory_bulk_items_deleted",{totalItems:e.length,successCount:i,errorCount:a,adapterType:this.adapterType}),{success:a===0,processedCount:e.length,successCount:i,errorCount:a,errors:r,data:[]}}))})}bulkArchiveItems(e,t){return ue(this,null,function*(){return yield C.handleOperation("bulkArchiveItems",()=>ue(this,null,function*(){const i=[],a=[];let s=0,o=0;for(const n of e)try{const l=yield this.adapter.updateInventoryItem(n,{status:"archived",archiveReason:t});i.push(l),W.invalidateRelated("inventory:update",n),s++}catch(l){a.push(`Failed to archive item ${n}: ${l instanceof Error?l.message:"Unknown error"}`),o++}return M("inventory","bulk_items_archived",`Bulk archived ${s} items, ${o} failed`,"info",{totalItems:e.length,successCount:s,errorCount:o,reason:t,adapterType:this.adapterType}),z("bulk_archive_items","inventory",{totalItems:e.length,successCount:s,errorCount:o,reason:t}),A.trackEvent("inventory_bulk_items_archived",{totalItems:e.length,successCount:s,errorCount:o,reason:t,adapterType:this.adapterType}),{success:o===0,processedCount:e.length,successCount:s,errorCount:o,errors:a,data:i}}))})}bulkRestoreItems(e){return ue(this,null,function*(){return yield C.handleOperation("bulkRestoreItems",()=>ue(this,null,function*(){const r=[],i=[];let a=0,s=0;for(const o of e)try{const n=yield this.adapter.updateInventoryItem(o,{status:"active",archiveReason:null});r.push(n),W.invalidateRelated("inventory:update",o),a++}catch(n){i.push(`Failed to restore item ${o}: ${n instanceof Error?n.message:"Unknown error"}`),s++}return M("inventory","bulk_items_restored",`Bulk restored ${a} items, ${s} failed`,"info",{totalItems:e.length,successCount:a,errorCount:s,adapterType:this.adapterType}),z("bulk_restore_items","inventory",{totalItems:e.length,successCount:a,errorCount:s}),A.trackEvent("inventory_bulk_items_restored",{totalItems:e.length,successCount:a,errorCount:s,adapterType:this.adapterType}),{success:s===0,processedCount:e.length,successCount:a,errorCount:s,errors:i,data:r}}))})}bulkChangeCategory(e,t){return ue(this,null,function*(){return yield C.handleOperation("bulkChangeCategory",()=>ue(this,null,function*(){const i=[],a=[];let s=0,o=0;for(const n of e)try{const l=yield this.adapter.updateInventoryItem(n,{category:t});i.push(l),W.invalidateRelated("inventory:update",n),s++}catch(l){a.push(`Failed to change category for item ${n}: ${l instanceof Error?l.message:"Unknown error"}`),o++}return M("inventory","bulk_category_changed",`Bulk changed category for ${s} items, ${o} failed`,"info",{totalItems:e.length,successCount:s,errorCount:o,newCategory:t,adapterType:this.adapterType}),z("bulk_change_category","inventory",{totalItems:e.length,successCount:s,errorCount:o,newCategory:t}),A.trackEvent("inventory_bulk_category_changed",{totalItems:e.length,successCount:s,errorCount:o,newCategory:t,adapterType:this.adapterType}),{success:o===0,processedCount:e.length,successCount:s,errorCount:o,errors:a,data:i}}))})}bulkChangeLocation(e,t){return ue(this,null,function*(){return yield C.handleOperation("bulkChangeLocation",()=>ue(this,null,function*(){const i=[],a=[];let s=0,o=0;for(const n of e)try{const l=yield this.adapter.updateInventoryItem(n,{});i.push(l),W.invalidateRelated("inventory:update",n),s++}catch(l){a.push(`Failed to change location for item ${n}: ${l instanceof Error?l.message:"Unknown error"}`),o++}return M("inventory","bulk_location_changed",`Bulk changed location for ${s} items, ${o} failed`,"info",{totalItems:e.length,successCount:s,errorCount:o,newLocation:t,adapterType:this.adapterType}),z("bulk_change_location","inventory",{totalItems:e.length,successCount:s,errorCount:o,newLocation:t}),A.trackEvent("inventory_bulk_location_changed",{totalItems:e.length,successCount:s,errorCount:o,newLocation:t,adapterType:this.adapterType}),{success:o===0,processedCount:e.length,successCount:s,errorCount:o,errors:a,data:i}}))})}static validateBulkOperationData(e,t){const r=[];switch((!t||t.length===0)&&r.push("No data provided for bulk operation"),t.length>1e3&&r.push("Bulk operation limited to 1000 items maximum"),e){case"create":t.forEach((i,a)=>{if(!i||typeof i!="object"){r.push(`Item ${a+1}: Invalid item data`);return}const s=i;!s.name&&!s.item&&r.push(`Item ${a+1}: Name is required`),s.category||r.push(`Item ${a+1}: Category is required`)});break;case"update":t.forEach((i,a)=>{if(!i||typeof i!="object"){r.push(`Update ${a+1}: Invalid update data`);return}const s=i;s.id||r.push(`Update ${a+1}: ID is required`),s.updates||r.push(`Update ${a+1}: Updates object is required`)});break;case"delete":case"archive":case"restore":t.forEach((i,a)=>{(typeof i!="string"||!i.trim())&&r.push(`ID ${a+1}: Valid ID is required`)});break}return{isValid:r.length===0,errors:r}}}var we=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Wh{constructor(e){this.adapter=e}searchItems(e){return we(this,null,function*(){return yield C.handleOperation("searchItems",()=>we(this,null,function*(){return{data:(yield this.adapter.fetchInventoryItems()).filter(a=>{var s,o,n,l;return((s=a.name)==null?void 0:s.toLowerCase().includes(e.toLowerCase()))||((n=(o=a.data)==null?void 0:o.description)==null?void 0:n.toString().toLowerCase().includes(e.toLowerCase()))||((l=a.category)==null?void 0:l.toLowerCase().includes(e.toLowerCase()))}),error:null}}))})}getFilteredItems(e){return we(this,null,function*(){return yield C.handleOperation("getFilteredItems",()=>we(this,null,function*(){let i=yield this.adapter.fetchInventoryItems();if(e.category&&(i=i.filter(a=>a.category===e.category)),e.status&&(i=i.filter(a=>a.status===e.status)),e.location&&(i=i.filter(a=>a.location===e.location)),e.searchQuery){const a=e.searchQuery.toLowerCase();i=i.filter(s=>{var o,n,l;return((o=s.name)==null?void 0:o.toLowerCase().includes(a))||((l=(n=s.data)==null?void 0:n.description)==null?void 0:l.toString().toLowerCase().includes(a))})}return e.minQuantity!==void 0&&(i=i.filter(a=>(a.quantity||0)>=e.minQuantity)),e.maxQuantity!==void 0&&(i=i.filter(a=>(a.quantity||0)<=e.maxQuantity)),e.dateRange&&(i=i.filter(a=>{const s=new Date(a.lastUpdated||a.created_at);return s>=e.dateRange.start&&s<=e.dateRange.end})),e.tags&&e.tags.length>0&&(i=i.filter(a=>{var s;const o=((s=a.data)==null?void 0:s.tags)||[];return e.tags.some(n=>o.includes(n))})),{data:i,error:null}}))})}advancedSearch(e){return we(this,arguments,function*(t,r={}){return yield C.handleOperation("advancedSearch",()=>we(this,null,function*(){let s=yield this.adapter.fetchInventoryItems();if(t.category&&(s=s.filter(n=>n.category===t.category)),t.status&&(s=s.filter(n=>n.status===t.status)),t.location&&(s=s.filter(n=>n.location===t.location)),t.searchQuery){const n=t.searchQuery.toLowerCase();s=s.filter(l=>{var u,h,f,m;return((u=l.name)==null?void 0:u.toLowerCase().includes(n))||((f=(h=l.data)==null?void 0:h.description)==null?void 0:f.toString().toLowerCase().includes(n))||((m=l.category)==null?void 0:m.toLowerCase().includes(n))})}t.minQuantity!==void 0&&(s=s.filter(n=>(n.quantity||0)>=t.minQuantity)),t.maxQuantity!==void 0&&(s=s.filter(n=>(n.quantity||0)<=t.maxQuantity)),t.dateRange&&(s=s.filter(n=>{const l=new Date(n.lastUpdated||n.created_at);return l>=t.dateRange.start&&l<=t.dateRange.end})),t.tags&&t.tags.length>0&&(s=s.filter(n=>{var l;const u=((l=n.data)==null?void 0:l.tags)||[];return t.tags.some(h=>u.includes(h))})),r.includeArchived||(s=s.filter(n=>n.status!=="archived")),r.sortBy&&(s=this.sortItems(s,r.sortBy,r.sortOrder||"asc"));const o=s.length;if(r.limit||r.offset){const n=r.offset||0,l=r.limit?n+r.limit:s.length;s=s.slice(n,l)}return{data:s,total:o,filters:t,options:r,error:null}}))})}searchByNormalizedCategory(e){return we(this,arguments,function*(t,r={}){return yield C.handleOperation("searchByNormalizedCategory",()=>we(this,null,function*(){let o=(yield this.adapter.fetchInventoryItems()).filter(l=>Qe.normalizeCategory(l.category||"")===t);r.includeArchived||(o=o.filter(l=>l.status!=="archived")),r.sortBy&&(o=this.sortItems(o,r.sortBy,r.sortOrder||"asc"));const n=o.length;if(r.limit||r.offset){const l=r.offset||0,u=r.limit?l+r.limit:o.length;o=o.slice(l,u)}return{data:o,total:n,filters:{category:t},options:r,error:null}}))})}getSearchSuggestions(e,t=10){return we(this,null,function*(){return(yield C.handleOperation("getSearchSuggestions",()=>we(this,null,function*(){const i=yield this.adapter.fetchInventoryItems(),a=new Set;if(!e||e.trim()==="")return[];const s=e.toLowerCase();return i.forEach(o=>{var n;o.name&&o.name.toLowerCase().includes(s)&&a.add(o.name),o.category&&o.category.toLowerCase().includes(s)&&a.add(o.category),o.location&&o.location.toLowerCase().includes(s)&&a.add(o.location);const l=(n=o.data)==null?void 0:n.description;l&&l.toLowerCase().includes(s)&&l.split(/\s+/).filter(h=>h.toLowerCase().includes(s)&&h.length>2).forEach(h=>a.add(h))}),Array.from(a).slice(0,t)})))||[]})}getLocations(){return we(this,null,function*(){return{data:yield C.handleOperation("getLocations",()=>we(this,null,function*(){const t=yield this.adapter.fetchInventoryItems();return Array.from(new Set(t.map(i=>i.location).filter(Boolean)))})),error:null}})}sortItems(e,t,r){return e.sort((i,a)=>{let s,o;switch(t){case"name":s=i.name||"",o=a.name||"";break;case"category":s=i.category||"",o=a.category||"";break;case"location":s=i.location||"",o=a.location||"";break;case"quantity":s=i.quantity||0,o=a.quantity||0;break;case"lastUpdated":s=new Date(i.lastUpdated||i.created_at),o=new Date(a.lastUpdated||a.created_at);break;default:s=i.name||"",o=a.name||""}return s<o?r==="asc"?-1:1:s>o?r==="asc"?1:-1:0})}static validateSearchFilters(e){const t=[];return e.minQuantity!==void 0&&e.maxQuantity!==void 0&&e.minQuantity>e.maxQuantity&&t.push("Minimum quantity cannot be greater than maximum quantity"),e.dateRange&&e.dateRange.start>e.dateRange.end&&t.push("Start date cannot be after end date"),e.searchQuery&&e.searchQuery.length>100&&t.push("Search query must be less than 100 characters"),{isValid:t.length===0,errors:t}}static validateSearchOptions(e){const t=[];e.limit!==void 0&&e.limit<1&&t.push("Limit must be greater than 0"),e.limit!==void 0&&e.limit>1e3&&t.push("Limit cannot exceed 1000"),e.offset!==void 0&&e.offset<0&&t.push("Offset must be non-negative");const r=["name","category","location","quantity","lastUpdated"];e.sortBy&&!r.includes(e.sortBy)&&t.push(`Invalid sort field. Must be one of: ${r.join(", ")}`);const i=["asc","desc"];return e.sortOrder&&!i.includes(e.sortOrder)&&t.push(`Invalid sort order. Must be one of: ${i.join(", ")}`),{isValid:t.length===0,errors:t}}}var Kh=Object.defineProperty,Qh=Object.defineProperties,Yh=Object.getOwnPropertyDescriptors,ao=Object.getOwnPropertySymbols,Jh=Object.prototype.hasOwnProperty,Xh=Object.prototype.propertyIsEnumerable,oo=(c,e,t)=>e in c?Kh(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Pr=(c,e)=>{for(var t in e||(e={}))Jh.call(e,t)&&oo(c,t,e[t]);if(ao)for(var t of ao(e))Xh.call(e,t)&&oo(c,t,e[t]);return c},Zh=(c,e)=>Qh(c,Yh(e));class ef{constructor(e){this.adapterType=e}trackItemCreated(e,t,r){const i={properties:{itemId:e,itemName:t,category:r,adapterType:this.adapterType}};this.logEvent("inventory","item_created",`Inventory item created: ${t}`,"info",i.properties),this.trackUserAction("create_item","inventory",{itemId:e,itemName:t,category:r}),this.trackAnalyticsEvent("inventory_item_created",i.properties)}trackItemUpdated(e,t){const r={properties:{itemId:e,updates:t,adapterType:this.adapterType}};this.logEvent("inventory","item_updated",`Inventory item updated: ${e}`,"info",r.properties),this.trackUserAction("update_item","inventory",{itemId:e,updates:t}),this.trackAnalyticsEvent("inventory_item_updated",r.properties)}trackItemDeleted(e){const t={properties:{itemId:e,adapterType:this.adapterType}};this.logEvent("inventory","item_deleted",`Inventory item deleted: ${e}`,"info",t.properties),this.trackUserAction("delete_item","inventory",{itemId:e}),this.trackAnalyticsEvent("inventory_item_deleted",t.properties)}trackCategoryCreated(e){const t={properties:{category:e,adapterType:this.adapterType}};this.logEvent("inventory","category_created",`Category created: ${e}`,"info",t.properties),this.trackUserAction("create_category","inventory",{category:e}),this.trackAnalyticsEvent("inventory_category_created",t.properties)}trackCategoryDeleted(e){const t={properties:{category:e,adapterType:this.adapterType}};this.logEvent("inventory","category_deleted",`Category deleted: ${e}`,"info",t.properties),this.trackUserAction("delete_category","inventory",{category:e}),this.trackAnalyticsEvent("inventory_category_deleted",t.properties)}trackBulkOperation(e,t,r,i,a){const s={properties:Pr({totalItems:t,successCount:r,errorCount:i,adapterType:this.adapterType},a)};this.logEvent("inventory",`bulk_${e}`,`Bulk ${e}: ${r} successful, ${i} failed`,"info",s.properties),this.trackUserAction(`bulk_${e}`,"inventory",Pr({totalItems:t,successCount:r,errorCount:i},a)),this.trackAnalyticsEvent(`inventory_bulk_${e}`,s.properties)}trackSearch(e,t,r){const i={properties:{query:e,resultCount:t,filters:r,adapterType:this.adapterType}};this.logEvent("inventory","search_performed",`Search: "${e}" returned ${t} results`,"info",i.properties),this.trackUserAction("search_items","inventory",{query:e,resultCount:t,filters:r}),this.trackAnalyticsEvent("inventory_search",i.properties)}trackFilter(e,t){const r={properties:{filters:e,resultCount:t,adapterType:this.adapterType}};this.logEvent("inventory","filter_applied",`Filter applied, returned ${t} results`,"info",r.properties),this.trackUserAction("filter_items","inventory",{filters:e,resultCount:t}),this.trackAnalyticsEvent("inventory_filter",r.properties)}trackItemDuplicated(e,t){const r={properties:{originalItemId:e,newItemId:t,adapterType:this.adapterType}};this.logEvent("inventory","item_duplicated",`Item duplicated: ${e} -> ${t}`,"info",r.properties),this.trackUserAction("duplicate_item","inventory",{originalItemId:e,newItemId:t}),this.trackAnalyticsEvent("inventory_item_duplicated",r.properties)}trackItemArchived(e,t){const r={properties:{itemId:e,reason:t,adapterType:this.adapterType}};this.logEvent("inventory","item_archived",`Item archived: ${e}`,"info",r.properties),this.trackUserAction("archive_item","inventory",{itemId:e,reason:t}),this.trackAnalyticsEvent("inventory_item_archived",r.properties)}trackItemRestored(e){const t={properties:{itemId:e,adapterType:this.adapterType}};this.logEvent("inventory","item_restored",`Item restored: ${e}`,"info",t.properties),this.trackUserAction("restore_item","inventory",{itemId:e}),this.trackAnalyticsEvent("inventory_item_restored",t.properties)}trackCategoryMerged(e,t,r){const i={properties:{sourceCategory:e,targetCategory:t,itemsUpdated:r,adapterType:this.adapterType}};this.logEvent("inventory","category_merged",`Category merged: ${e} -> ${t}`,"info",i.properties),this.trackUserAction("merge_category","inventory",{sourceCategory:e,targetCategory:t,itemsUpdated:r}),this.trackAnalyticsEvent("inventory_category_merged",i.properties)}trackAdapterInitialized(e){const t={properties:{adapterType:e}};this.logEvent("inventory","adapter_initialized",`Adapter initialized: ${e}`,"info",t.properties),this.trackUserAction("initialize_adapter","inventory",{adapterType:e}),this.trackAnalyticsEvent("inventory_adapter_initialized",t.properties)}trackError(e,t,r){const i={properties:Pr({operation:e,errorMessage:t.message,errorStack:t.stack,adapterType:this.adapterType},r)};this.logEvent("inventory","error_occurred",`Error in ${e}: ${t.message}`,"error",i.properties),this.trackUserAction("error_occurred","inventory",Pr({operation:e,errorMessage:t.message},r)),this.trackAnalyticsEvent("inventory_error",i.properties)}trackPerformance(e,t,r){const i={properties:{operation:e,duration:t,itemCount:r,adapterType:this.adapterType}};this.logEvent("inventory","performance_metric",`${e} took ${t}ms`,"info",i.properties),this.trackUserAction("performance_metric","inventory",{operation:e,duration:t,itemCount:r}),this.trackAnalyticsEvent("inventory_performance",i.properties)}logEvent(e,t,r,i,a){M(e,t,r,i,a)}trackUserAction(e,t,r){z(e,t,r)}trackAnalyticsEvent(e,t){A.trackEvent(e,t)}createCustomEvent(e,t,r,i,a,s){return{eventType:e,category:t,action:r,label:i,value:a,properties:Zh(Pr({},s),{adapterType:this.adapterType})}}trackCustomEvent(e){this.logEvent(e.category,e.action,e.label||e.action,"info",e.properties),this.trackUserAction(e.action,e.category,e.properties),this.trackAnalyticsEvent(e.eventType,e.properties)}}var tf=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function rf(){return tf(this,null,function*(){return yield T(()=>Promise.resolve().then(()=>bp),void 0)})}var nf=Object.defineProperty,af=Object.defineProperties,of=Object.getOwnPropertyDescriptors,so=Object.getOwnPropertySymbols,sf=Object.prototype.hasOwnProperty,cf=Object.prototype.propertyIsEnumerable,co=(c,e,t)=>e in c?nf(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,lo=(c,e)=>{for(var t in e||(e={}))sf.call(e,t)&&co(c,t,e[t]);if(so)for(var t of so(e))cf.call(e,t)&&co(c,t,e[t]);return c},lf=(c,e)=>af(c,of(e)),Dr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ec{constructor(e,t){this.isInitialized=!1,this.lastError=null,this.lastSyncTime=null,this.pendingChanges=!1,this.config=e,this.metadata=lf(lo({},t),{config:e})}getMetadata(){return lo({},this.metadata)}batchAddItems(e){return Dr(this,null,function*(){const t=[];for(const r of e)try{const i=yield this.addInventoryItem(r);t.push(i)}catch(i){throw this.setError(i),i}return t})}batchUpdateItems(e){return Dr(this,null,function*(){const t=[];for(const r of e)try{const i=yield this.updateInventoryItem(r.id,r.item);t.push(i)}catch(i){throw this.setError(i),i}return t})}batchDeleteItems(e){return Dr(this,null,function*(){for(const t of e)try{yield this.deleteInventoryItem(t)}catch(r){throw this.setError(r),r}})}sync(){return Dr(this,null,function*(){try{this.lastSyncTime=new Date,this.pendingChanges=!1}catch(e){throw this.setError(e),e}})}getLastSyncTime(){return this.lastSyncTime}hasPendingChanges(){return this.pendingChanges}getLastError(){return this.lastError}clearError(){this.lastError=null}disconnect(){return Dr(this,null,function*(){this.isInitialized=!1,this.lastError=null})}setError(e){this.lastError=e,console.error(`[${this.metadata.name}] Error:`,e)}setPendingChanges(){this.pendingChanges=!0}validateInitialization(){if(!this.isInitialized)throw new Error(`Adapter ${this.metadata.name} is not initialized. Call initialize() first.`)}}var uf=Object.defineProperty,df=Object.defineProperties,hf=Object.getOwnPropertyDescriptors,uo=Object.getOwnPropertySymbols,ff=Object.prototype.hasOwnProperty,mf=Object.prototype.propertyIsEnumerable,ho=(c,e,t)=>e in c?uf(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,di=(c,e)=>{for(var t in e||(e={}))ff.call(e,t)&&ho(c,t,e[t]);if(uo)for(var t of uo(e))mf.call(e,t)&&ho(c,t,e[t]);return c},fo=(c,e)=>df(c,hf(e)),ze=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const de={INVENTORY_DATA:"inventory_data",CATEGORIES:"inventory_categories",LAST_SYNC:"inventory_last_sync",PENDING_CHANGES:"inventory_pending_changes"};class pf extends ec{constructor(e={type:"localStorage"}){const t={supportsRead:!0,supportsWrite:!0,supportsDelete:!0,supportsRealTime:!1,supportsOffline:!0,supportsBatch:!0};super(e,{name:"LocalStorageAdapter",version:"1.0.0",description:"Adapter for localStorage-based inventory data",capabilities:t}),this.storage=window.localStorage}initialize(){return ze(this,null,function*(){try{if(!this.storage)throw new Error("localStorage is not available");this.storage.getItem(de.INVENTORY_DATA)||(yield this.initializeDefaultData()),this.isInitialized=!0,this.lastSyncTime=this.getLastSyncTimeFromStorage(),this.pendingChanges=this.getPendingChangesFromStorage()}catch(e){throw this.setError(e),e}})}isConnected(){return this.isInitialized&&!!this.storage}fetchAllInventoryData(){return ze(this,null,function*(){this.validateInitialization();const e=this.getInventoryDataFromStorage(),t=[];return t.push(...e.tools),t.push(...e.supplies),t.push(...e.equipment),t.push(...e.officeHardware),{data:t,error:null,count:t.length}})}fetchInventoryItems(){return ze(this,null,function*(){this.validateInitialization();const e=this.getInventoryDataFromStorage(),t=[];return t.push(...e.tools),t.push(...e.supplies),t.push(...e.equipment),t.push(...e.officeHardware),t})}fetchCategories(){return ze(this,null,function*(){this.validateInitialization();const e=this.storage.getItem(de.CATEGORIES);return e?JSON.parse(e):this.getDefaultCategories()})}addInventoryItem(e){return ze(this,null,function*(){this.validateInitialization();const t=this.getInventoryDataFromStorage(),r=fo(di({},e),{id:this.generateId(),createdAt:new Date().toISOString()}),i=(r.category||"").toLowerCase();return i.includes("tool")||i.includes("instrument")?t.tools.push(r):i.includes("supply")||i.includes("consumable")?t.supplies.push(r):i.includes("equipment")||i.includes("device")?t.equipment.push(r):t.officeHardware.push(r),this.saveInventoryDataToStorage(t),this.setPendingChanges(),this.updateLastSyncTime(),r})}updateInventoryItem(e,t){return ze(this,null,function*(){this.validateInitialization();const r=this.getInventoryDataFromStorage(),i=fo(di({},t),{id:e,lastUpdated:new Date().toISOString()}),a=[r.tools,r.supplies,r.equipment,r.officeHardware];let s=!1;for(const o of a){const n=o.findIndex(l=>this.getItemId(l)===e);if(n!==-1){o[n]=di(di({},o[n]),i),s=!0;break}}if(!s)throw new Error(`Item with id ${e} not found`);return this.saveInventoryDataToStorage(r),this.setPendingChanges(),this.updateLastSyncTime(),i})}deleteInventoryItem(e){return ze(this,null,function*(){this.validateInitialization();const t=this.getInventoryDataFromStorage(),r=[t.tools,t.supplies,t.equipment,t.officeHardware];let i=!1;for(const a of r){const s=a.findIndex(o=>this.getItemId(o)===e);if(s!==-1){a.splice(s,1),i=!0;break}}if(!i)throw new Error(`Item with id ${e} not found`);this.saveInventoryDataToStorage(t),this.setPendingChanges(),this.updateLastSyncTime()})}addCategory(e){return ze(this,null,function*(){this.validateInitialization();const t=yield this.fetchCategories();return t.includes(e)||(t.push(e),this.storage.setItem(de.CATEGORIES,JSON.stringify(t)),this.setPendingChanges(),this.updateLastSyncTime()),e})}deleteCategory(e){return ze(this,null,function*(){this.validateInitialization();const t=yield this.fetchCategories(),r=t.indexOf(e);r!==-1&&(t.splice(r,1),this.storage.setItem(de.CATEGORIES,JSON.stringify(t)),this.setPendingChanges(),this.updateLastSyncTime())})}getInventoryDataFromStorage(){const e=this.storage.getItem(de.INVENTORY_DATA);return e?JSON.parse(e):{tools:[],supplies:[],equipment:[],officeHardware:[],categories:this.getDefaultCategories(),isLoading:!1,error:null}}saveInventoryDataToStorage(e){this.storage.setItem(de.INVENTORY_DATA,JSON.stringify(e))}getLastSyncTimeFromStorage(){const e=this.storage.getItem(de.LAST_SYNC);return e?new Date(e):null}getPendingChangesFromStorage(){const e=this.storage.getItem(de.PENDING_CHANGES);return e?JSON.parse(e):!1}updateLastSyncTime(){this.lastSyncTime=new Date,this.storage.setItem(de.LAST_SYNC,this.lastSyncTime.toISOString())}setPendingChanges(){this.pendingChanges=!0,this.storage.setItem(de.PENDING_CHANGES,JSON.stringify(!0))}initializeDefaultData(){return ze(this,null,function*(){const e={tools:[],supplies:[],equipment:[],officeHardware:[],categories:this.getDefaultCategories(),isLoading:!1,error:null};this.saveInventoryDataToStorage(e),this.storage.setItem(de.CATEGORIES,JSON.stringify(this.getDefaultCategories())),this.storage.setItem(de.LAST_SYNC,new Date().toISOString()),this.storage.setItem(de.PENDING_CHANGES,JSON.stringify(!1))})}generateId(){return`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getItemId(e){if(e.data&&typeof e.data=="object"&&e.data!==null){const t=e.data;if(t.toolId&&typeof t.toolId=="string")return t.toolId;if(t.supplyId&&typeof t.supplyId=="string")return t.supplyId;if(t.equipmentId&&typeof t.equipmentId=="string")return t.equipmentId;if(t.hardwareId&&typeof t.hardwareId=="string")return t.hardwareId}return e.id||this.generateId()}getDefaultCategories(){return["Surgical Instruments","Medical Supplies","Equipment","Office Hardware","Consumables","Disposables","Tools","Devices"]}}var gf=Object.defineProperty,mo=Object.getOwnPropertySymbols,yf=Object.prototype.hasOwnProperty,_f=Object.prototype.propertyIsEnumerable,po=(c,e,t)=>e in c?gf(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,hi=(c,e)=>{for(var t in e||(e={}))yf.call(e,t)&&po(c,t,e[t]);if(mo)for(var t of mo(e))_f.call(e,t)&&po(c,t,e[t]);return c},Or=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class vf{constructor(e){this.registry={},this.defaultAdapter=null,this.config={defaultAdapter:e.defaultAdapter||"localStorage",adapters:hi({},e.adapters),fallbackAdapter:e.fallbackAdapter||"supabase"}}createAdapter(e,t){return Or(this,null,function*(){if(this.registry[e])return this.registry[e];let r;switch(e){case"static":{const{StaticDataAdapter:i}=yield T(()=>Promise.resolve().then(()=>Op),void 0);r=new i(t||{type:"static"});break}case"localStorage":{r=new pf(t||this.config.adapters.localStorage);break}case"api":{const{ApiAdapter:i,isApiAdapterConfig:a}=yield T(()=>Promise.resolve().then(()=>Fp),void 0),s=t||this.config.adapters.api;if(!s)throw new Error("API adapter configuration is required");if(!a(s))throw new Error("API adapter requires baseUrl configuration");r=new i(s);break}case"supabase":{const{SupabaseAdapter:i}=yield rf(),a=t||this.config.adapters.supabase;if(!a)throw new Error("Supabase adapter configuration is required");r=new i(a);break}default:throw new Error(`Unknown adapter type: ${e}`)}return yield r.initialize(),this.registerAdapter(e,r),r})}getAdapter(e){return this.registry[e]||null}registerAdapter(e,t){this.registry[e]=t,e===this.config.defaultAdapter&&(this.defaultAdapter=t)}unregisterAdapter(e){const t=this.registry[e];t&&(t.disconnect().catch(console.error),delete this.registry[e],this.defaultAdapter===t&&(this.defaultAdapter=null))}initializeDefaultAdapter(){return Or(this,null,function*(){if(this.defaultAdapter)return this.defaultAdapter;try{const e=yield this.createAdapter(this.config.defaultAdapter);return this.defaultAdapter=e,e}catch(e){if(console.error(e),console.error(`Failed to initialize default adapter (${this.config.defaultAdapter}):`),this.config.fallbackAdapter&&this.config.fallbackAdapter!==this.config.defaultAdapter)try{const t=yield this.createAdapter(this.config.fallbackAdapter);return this.defaultAdapter=t,t}catch(t){throw console.error(`Failed to initialize fallback adapter (${this.config.fallbackAdapter}):`,t),new Error("No available adapters could be initialized")}throw new Error("No available adapters could be initialized")}})}getAvailableAdapters(){return Object.keys(this.registry)}getAdapterMetadata(e){const t=this.registry[e];return t?t.getMetadata():null}updateConfig(e){this.config=hi(hi({},this.config),e)}getConfig(){return hi({},this.config)}switchDefaultAdapter(e){return Or(this,null,function*(){if(!["localStorage","api","supabase"].includes(e))throw new Error(`Invalid adapter type: ${e}`);return this.config.defaultAdapter=e,this.defaultAdapter=null,this.initializeDefaultAdapter()})}getBestAvailableAdapter(){return Or(this,null,function*(){try{return yield this.initializeDefaultAdapter()}catch(e){console.error(e);const t=["supabase","localStorage"];for(const r of t)try{return yield this.createAdapter(r)}catch(i){console.warn(`Failed to create adapter ${r}:`,i);continue}throw new Error("No adapters are available")}})}cleanup(){return Or(this,null,function*(){const e=Object.values(this.registry).map(t=>t.disconnect().catch(console.error));yield Promise.all(e),this.registry={},this.defaultAdapter=null})}}const rr=new vf({defaultAdapter:"supabase",adapters:{supabase:{type:"supabase"},localStorage:{type:"localStorage"}},fallbackAdapter:"localStorage"});var H=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class wf{constructor(e,t){this.adapter=e,this.adapterType=t}getInventoryStats(){return H(this,null,function*(){return{data:yield C.handleOperation("getInventoryStats",()=>H(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r={totalItems:t.length,categories:Array.from(new Set(t.map(a=>a.category))).length,locations:Array.from(new Set(t.map(a=>a.location))).length,activeItems:t.filter(a=>a.status==="active").length,maintenanceItems:t.filter(a=>a.status==="maintenance").length,inactiveItems:t.filter(a=>a.status==="inactive").length,retiredItems:t.filter(a=>a.status==="retired").length,archivedItems:t.filter(a=>a.status==="archived").length,lowStockItems:t.filter(a=>{const s=a.quantity||0,o=a.minimumStock||0;return s>0&&s<=o}).length,outOfStockItems:t.filter(a=>(a.quantity||0)===0).length,normalizedCategories:{tools:0,supplies:0,equipment:0,officeHardware:0},statusDistribution:{},categoryDistribution:{},locationDistribution:{},averageQuantity:0};t.forEach(a=>{const s=Qe.normalizeCategory(a.category||"");r.normalizedCategories[s.toLowerCase().replace(" ","")]++}),t.forEach(a=>{const s=a.status||"unknown";r.statusDistribution[s]=(r.statusDistribution[s]||0)+1}),t.forEach(a=>{const s=a.category||"unknown";r.categoryDistribution[s]=(r.categoryDistribution[s]||0)+1}),t.forEach(a=>{const s=a.location||"unknown";r.locationDistribution[s]=(r.locationDistribution[s]||0)+1});const i=t.reduce((a,s)=>a+(s.quantity||0),0);return r.averageQuantity=t.length>0?i/t.length:0,r})),error:null}})}getCategoryStats(){return H(this,null,function*(){return{data:yield C.handleOperation("getCategoryStats",()=>H(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r={};return t.forEach(i=>{const a=Qe.normalizeCategory(i.category||"");r[a]=(r[a]||0)+1}),r})),error:null}})}getStatusStats(){return H(this,null,function*(){return{data:yield C.handleOperation("getStatusStats",()=>H(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r={};return t.forEach(i=>{const a=i.status||"unknown";r[a]=(r[a]||0)+1}),r})),error:null}})}getLocationStats(){return H(this,null,function*(){return{data:yield C.handleOperation("getLocationStats",()=>H(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r={};return t.forEach(i=>{const a=i.location||"unknown";r[a]=(r[a]||0)+1}),r})),error:null}})}getStockLevelStats(){return H(this,null,function*(){return{data:yield C.handleOperation("getStockLevelStats",()=>H(this,null,function*(){const t=yield this.adapter.fetchInventoryItems();let r=0,i=0,a=0,s=0;return t.forEach(o=>{const n=o.quantity||0,l=o.minimumStock||0,u=o.maximumStock||1/0;n===0?a++:n<=l?i++:n>=u?s++:r++}),{inStock:r,lowStock:i,outOfStock:a,overStock:s}})),error:null}})}getTrendingItems(e=10){return H(this,null,function*(){return{data:yield C.handleOperation("getTrendingItems",()=>H(this,null,function*(){const r=yield this.adapter.fetchInventoryItems(),i={};return r.forEach(s=>{i[s.id]=(i[s.id]||0)+1}),r.sort((s,o)=>new Date(o.lastUpdated||o.created_at).getTime()-new Date(s.lastUpdated||s.created_at).getTime()).slice(0,e).map(s=>({id:s.id,name:s.name||s.item||"Unknown",category:s.category||"Unknown",lastUpdated:s.lastUpdated||s.created_at,updateCount:i[s.id]||1}))})),error:null}})}getCurrentAdapterType(){return this.adapterType}getAdapterMetadata(){return rr.getAdapterMetadata(this.adapterType)||null}getAvailableAdapters(){return rr.getAvailableAdapters()}getAdapterCapabilities(){const e=this.getAdapterMetadata();return(e==null?void 0:e.capabilities)||[]}supportsOperation(e){const t=this.getAdapterMetadata();return(t==null?void 0:t.supportedOperations.includes(e))||!1}getPerformanceMetrics(){return H(this,null,function*(){return{data:yield C.handleOperation("getPerformanceMetrics",()=>H(null,null,function*(){return{averageResponseTime:150,totalOperations:1e3,errorRate:.02,cacheHitRate:.85}})),error:null}})}getDataQualityMetrics(){return H(this,null,function*(){return{data:yield C.handleOperation("getDataQualityMetrics",()=>H(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r=[];let i=0,a=0;t.forEach(l=>{["name","category","status"].forEach(h=>{a++,l[h]?i++:r.push(`Missing ${h} for item ${l.id}`)}),l.quantity!==void 0&&l.minimumStock!==void 0&&(l.quantity<0&&r.push(`Negative quantity for item ${l.id}`),l.minimumStock<0&&r.push(`Negative minimum stock for item ${l.id}`))});const s=a>0?i/a:0,o=1-r.length/t.length,n=1-r.filter(l=>l.includes("consistency")).length/t.length;return{completeness:s,accuracy:Math.max(0,o),consistency:Math.max(0,n),issues:r}})),error:null}})}generateInventoryReport(){return H(this,null,function*(){return{data:yield C.handleOperation("generateInventoryReport",()=>H(this,null,function*(){const[t,r,i,a,s]=yield Promise.all([this.getInventoryStats(),this.getCategoryStats(),this.getStatusStats(),this.getLocationStats(),this.getStockLevelStats()]),o=[];return t.data&&(t.data.lowStockItems>0&&o.push(`Consider restocking ${t.data.lowStockItems} low stock items`),t.data.outOfStockItems>0&&o.push(`Urgent: ${t.data.outOfStockItems} items are out of stock`),t.data.archivedItems>t.data.totalItems*.1&&o.push("Consider cleaning up archived items")),{summary:t.data,categoryBreakdown:r.data||{},statusBreakdown:i.data||{},locationBreakdown:a.data||{},stockLevels:s.data||{inStock:0,lowStock:0,outOfStock:0,overStock:0},recommendations:o,generatedAt:new Date().toISOString()}})),error:null}})}}var L=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class If{constructor(){this.currentAdapter=null,this.adapterType="static",this.initialized=!1,this.categoryProvider=null,this.itemCrudProvider=null,this.bulkOperationsProvider=null,this.searchFilterProvider=null,this.analyticsProvider=null,this.statsProvider=null}get isInitialized(){return this.initialized}initialize(e,t){return L(this,null,function*(){this.initialized||(this.currentAdapter=e,this.adapterType=t,typeof this.currentAdapter.initialize=="function"&&(yield this.currentAdapter.initialize()),this.categoryProvider=new Qe(e,t),this.itemCrudProvider=new Hh(e,t),this.bulkOperationsProvider=new Gh(e,t),this.searchFilterProvider=new Wh(e),this.analyticsProvider=new ef(t),this.statsProvider=new wf(e,t),this.initialized=!0,console.info("[InventoryRepository] Initialized successfully."))})}getAdapter(){if(!this.initialized||!this.currentAdapter)throw new Error("Inventory repository not initialized. Must call initialize() first.");return this.currentAdapter}fetchInventoryItems(){return L(this,null,function*(){return this.itemCrudProvider.fetchInventoryItems()})}getAllItems(){return L(this,null,function*(){return this.itemCrudProvider.fetchInventoryItems()})}fetchAllInventoryData(){return L(this,null,function*(){const e=yield C.handleOperation("fetchAllInventoryData",()=>L(this,null,function*(){const r=yield this.getAdapter().fetchAllInventoryData(),i=r.data||[],a=Uh(i),s=zh(a),o=new Set,n=new Set;[s.tools,s.supplies,s.equipment,s.officeHardware].forEach(u=>{u.forEach(h=>{o.has(h.id)&&n.add(h.id),o.add(h.id)})}),n.size>0&&console.warn(`Found ${n.size} duplicate item IDs:`,Array.from(n));const l=Array.from(new Set(a.map(u=>u.category).filter(Boolean)));return{tools:s.tools,supplies:s.supplies,equipment:s.equipment,officeHardware:s.officeHardware,categories:l,isLoading:!1,error:r.error}}));return{tools:e.tools||[],supplies:e.supplies||[],equipment:e.equipment||[],officeHardware:e.officeHardware||[],categories:e.categories,isLoading:e.isLoading,error:e.error}})}getItemById(e){return L(this,null,function*(){return this.itemCrudProvider.getItemById(e)})}createItem(e){return L(this,null,function*(){return this.itemCrudProvider.createItem(e)})}updateItem(e,t){return L(this,null,function*(){return this.itemCrudProvider.updateItem(e,t)})}deleteItem(e){return L(this,null,function*(){return this.itemCrudProvider.deleteItem(e)})}addInventoryItem(e){return L(this,null,function*(){return this.itemCrudProvider.addInventoryItem(e)})}addCategory(e){return L(this,null,function*(){return this.categoryProvider.addCategory(e)})}deleteCategory(e){return L(this,null,function*(){return this.categoryProvider.deleteCategory(e)})}bulkCreateItems(e){return L(this,null,function*(){return this.bulkOperationsProvider.bulkCreateItems(e)})}bulkUpdateItems(e){return L(this,null,function*(){return this.bulkOperationsProvider.bulkUpdateItems(e)})}bulkDeleteItems(e){return L(this,null,function*(){return this.bulkOperationsProvider.bulkDeleteItems(e)})}searchItems(e){return L(this,null,function*(){return this.searchFilterProvider.searchItems(e)})}getFilteredItems(e){return L(this,null,function*(){return this.searchFilterProvider.getFilteredItems(e)})}getCategories(){return L(this,null,function*(){return this.categoryProvider.getCategories()})}getLocations(){return L(this,null,function*(){return this.searchFilterProvider.getLocations()})}getInventoryStats(){return L(this,null,function*(){const e=yield this.statsProvider.getInventoryStats();return{data:e.data,error:e.error}})}getCurrentAdapterType(){return this.statsProvider.getCurrentAdapterType()}getAdapterMetadata(){return this.statsProvider.getAdapterMetadata()}getAvailableAdapters(){return this.statsProvider.getAvailableAdapters()}}var Sf=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class bf{constructor(){this.currentAdapter=null,this.adapterType="static",this.initialized=!1}initialize(){return Sf(this,null,function*(){this.initialized||(this.currentAdapter=yield rr.initializeDefaultAdapter(),this.adapterType=rr.getConfig().defaultAdapter,this.initialized=!0)})}getAdapter(){if(!this.currentAdapter)throw new Error("Inventory service facade not initialized. Call initialize() first.");return this.currentAdapter}getCurrentAdapterType(){return this.adapterType}getAdapterMetadata(){return rr.getAdapterMetadata(this.adapterType)}getAvailableAdapters(){return rr.getAvailableAdapters()}}const Ef={realtime:{get enabled(){return ht()}}};var Af=Object.defineProperty,Tf=Object.defineProperties,kf=Object.getOwnPropertyDescriptors,go=Object.getOwnPropertySymbols,Cf=Object.prototype.hasOwnProperty,Pf=Object.prototype.propertyIsEnumerable,yo=(c,e,t)=>e in c?Af(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,_o=(c,e)=>{for(var t in e||(e={}))Cf.call(e,t)&&yo(c,t,e[t]);if(go)for(var t of go(e))Pf.call(e,t)&&yo(c,t,e[t]);return c},vo=(c,e)=>Tf(c,kf(e)),Ue=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ir{constructor(){this.isConnected=!1,this.connectionTestPromise=null}static getInstance(){return ir.instance||(ir.instance=new ir),ir.instance}testConnection(){return Ue(this,null,function*(){return this.connectionTestPromise?this.connectionTestPromise:(this.connectionTestPromise=this.performConnectionTest(),this.connectionTestPromise)})}performConnectionTest(){return Ue(this,null,function*(){if(!ht())return console.warn("Supabase not configured, connection test skipped"),!1;try{const{error:e}=yield d.from("inventory_items").select("count").limit(1);return e?(console.error("âŒ Supabase connection test failed:",e),this.isConnected=!1,!1):(this.isConnected=!0,!0)}catch(e){return console.error("âŒ Supabase connection test error:",e),this.isConnected=!1,!1}})}getAnalytics(){return Ue(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");return q.getAnalytics()})}getCategories(){return Ue(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const{data:t,error:r}=yield d.from("inventory_items").select("category").not("category","is",null);if(r)throw new Error(`Failed to fetch categories: ${r.message}`);return Array.from(new Set((t==null?void 0:t.map(a=>a.category).filter(Boolean))||[]))}catch(t){throw console.error("âŒ Error fetching categories:",t),t}})}getLocations(){return Ue(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const{error:t}=yield d.from("inventory_items").select("location").not("location","is",null);if(t)throw new Error(`Failed to fetch locations: ${t.message}`);return[]}catch(t){throw console.error("âŒ Error fetching locations:",t),t}})}getItems(e){return Ue(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{let r=d.from("inventory_items").select("*",{count:"exact"});e!=null&&e.category&&(r=r.eq("category",e.category)),e!=null&&e.limit&&(r=r.limit(e.limit)),e!=null&&e.offset&&(r=r.range(e.offset,e.offset+(e.limit||10)-1));const{data:i,error:a,count:s}=yield r;if(a)throw new Error(`Failed to fetch items: ${a.message}`);return{data:i||[],count:s||0,error:null}}catch(r){return console.error("âŒ Error fetching items:",r),{data:[],count:0,error:r instanceof Error?r.message:"Unknown error"}}})}subscribeToChanges(e){if(!Ef.realtime.enabled)return()=>{};try{return Fi.subscribe("inventory_items",e,{event:"*"})}catch(t){return console.error("âŒ Failed to set up real-time subscription:",t),()=>{}}}resetConnectionTest(){this.connectionTestPromise=null,this.isConnected=!1}getConnectionStatus(){return{isConnected:this.isConnected,isConfigured:ht()}}getItemById(e){return Ue(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const{data:r,error:i}=yield d.from("inventory_items").select("*").eq("id",e).single();if(i){if(i.code==="PGRST116")return null;throw new Error(`Failed to fetch item: ${i.message}`)}return r}catch(r){throw console.error("âŒ Error fetching item by ID:",r),r}})}createItem(e){return Ue(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const r=vo(_o({},e),{data:e.data}),{data:i,error:a}=yield d.from("inventory_items").insert(r).select().single();if(a)throw new Error(`Failed to create item: ${a.message}`);return i}catch(r){throw console.error("âŒ Error creating item:",r),r}})}updateItem(e,t){return Ue(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const i=vo(_o({},t),{data:t.data}),{data:a,error:s}=yield d.from("inventory_items").update(i).eq("id",e).select().single();if(s)throw new Error(`Failed to update item: ${s.message}`);return a}catch(i){throw console.error("âŒ Error updating item:",i),i}})}deleteItem(e){return Ue(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const{error:r}=yield d.from("inventory_items").delete().eq("id",e);if(r)throw new Error(`Failed to delete item: ${r.message}`)}catch(r){throw console.error("âŒ Error deleting item:",r),r}})}}const Df=ir.getInstance();var Mt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Of{constructor(e,t){this.repository=e,this.adapterManager=t}getItemById(e){return Mt(this,null,function*(){return yield this.repository.getItemById(e)})}createItem(e){return Mt(this,null,function*(){var t,r;const i=performance.now();try{const a=yield this.repository.createItem(e);yield A.trackEvent("inventory_item_created",{itemId:(t=a.data)==null?void 0:t.id,category:e.category,adapterType:this.adapterManager.getCurrentAdapterType()});const s=performance.now()-i;return F.recordResponseTime("inventory_item_create",s,{itemId:(r=a.data)==null?void 0:r.id}),a}catch(a){throw yield A.trackEvent("inventory_item_create_error",{error:a instanceof Error?a.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),a}})}updateItem(e,t){return Mt(this,null,function*(){const r=performance.now();try{const i=yield this.repository.updateItem(e,t);yield A.trackEvent("inventory_item_updated",{itemId:e,updatedFields:Object.keys(t).join(","),adapterType:this.adapterManager.getCurrentAdapterType()});const a=performance.now()-r;return F.recordResponseTime("inventory_item_update",a,{itemId:e}),i}catch(i){throw yield A.trackEvent("inventory_item_update_error",{itemId:e,error:i instanceof Error?i.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),i}})}deleteItem(e){return Mt(this,null,function*(){const t=performance.now();try{const r=yield this.repository.deleteItem(e);yield A.trackEvent("inventory_item_deleted",{itemId:e,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return F.recordResponseTime("inventory_item_delete",i,{itemId:e}),r}catch(r){throw yield A.trackEvent("inventory_item_delete_error",{itemId:e,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}addInventoryItem(e){return Mt(this,null,function*(){return yield this.repository.addInventoryItem(e)})}validateItem(e){return Mt(this,null,function*(){const t=[];return(!e.name||e.name.trim()==="")&&t.push("Item name is required"),(!e.category||e.category.trim()==="")&&t.push("Category is required"),(!e.location||e.location.trim()==="")&&t.push("Location is required"),e.quantity!==void 0&&e.quantity<0&&t.push("Quantity must be non-negative"),{isValid:t.length===0,errors:t}})}}var Rr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Rf{constructor(e,t){this.repository=e,this.adapterManager=t}searchItems(e,t){return Rr(this,null,function*(){var r,i;const a=performance.now();try{const s=yield this.repository.searchItems(e);yield A.trackEvent("inventory_search",{query:e,resultCount:((r=s.data)==null?void 0:r.length)||0,adapterType:this.adapterManager.getCurrentAdapterType()});const o=performance.now()-a;return F.recordResponseTime("inventory_search",o,{query:e,resultCount:String(((i=s.data)==null?void 0:i.length)||0)}),s}catch(s){throw yield A.trackEvent("inventory_search_error",{query:e,error:s instanceof Error?s.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),s}})}getFilteredItems(e,t,r){return Rr(this,null,function*(){var i;const a=performance.now();try{const s=yield this.repository.getFilteredItems(e,t,r);yield A.trackEvent("inventory_filter",{filterCount:Object.keys(e).length,resultCount:((i=s.data)==null?void 0:i.length)||0,adapterType:this.adapterManager.getCurrentAdapterType()});const o=performance.now()-a;return F.recordResponseTime("inventory_filter",o,{filterCount:Object.keys(e).length.toString()}),s}catch(s){throw yield A.trackEvent("inventory_filter_error",{filters:e,error:s instanceof Error?s.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),s}})}fetchInventoryItems(){return Rr(this,null,function*(){return yield this.repository.fetchInventoryItems()})}getAllItems(){return Rr(this,null,function*(){return yield this.repository.getAllItems()})}refreshData(){return Rr(this,null,function*(){const e=performance.now();try{const t=yield this.repository.refreshData();yield A.trackEvent("inventory_refresh",{adapterType:this.adapterManager.getCurrentAdapterType()});const r=performance.now()-e;return F.recordResponseTime("inventory_refresh",r,{}),t}catch(t){throw yield A.trackEvent("inventory_refresh_error",{error:t instanceof Error?t.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),t}})}}var vn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class $f{constructor(e,t){this.repository=e,this.adapterManager=t}bulkCreateItems(e){return vn(this,null,function*(){const t=performance.now();try{const r=yield this.repository.bulkCreateItems(e);yield A.trackEvent("inventory_bulk_create",{itemCount:e.length,successCount:r.successCount,errorCount:r.errorCount,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return F.recordResponseTime("inventory_bulk_create",i,{itemCount:e.length.toString()}),r}catch(r){throw yield A.trackEvent("inventory_bulk_create_error",{itemCount:e.length,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}bulkUpdateItems(e){return vn(this,null,function*(){const t=performance.now();try{const r=yield this.repository.bulkUpdateItems(e);yield A.trackEvent("inventory_bulk_update",{updateCount:e.length,successCount:r.successCount,errorCount:r.errorCount,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return F.recordResponseTime("inventory_bulk_update",i,{updateCount:e.length.toString()}),r}catch(r){throw yield A.trackEvent("inventory_bulk_update_error",{updateCount:e.length,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}bulkDeleteItems(e){return vn(this,null,function*(){const t=performance.now();try{const r=yield this.repository.bulkDeleteItems(e);yield A.trackEvent("inventory_bulk_delete",{itemCount:e.length,successCount:r.successCount,errorCount:r.errorCount,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return F.recordResponseTime("inventory_bulk_delete",i,{itemCount:e.length.toString()}),r}catch(r){throw yield A.trackEvent("inventory_bulk_delete_error",{itemCount:e.length,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}}var fi=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Mf{constructor(e,t){this.repository=e,this.adapterManager=t}addCategory(e){return fi(this,null,function*(){const t=performance.now();try{const r=yield this.repository.addCategory(e);yield A.trackEvent("inventory_category_added",{category:e,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return F.recordResponseTime("inventory_category_add",i,{category:e}),r}catch(r){throw yield A.trackEvent("inventory_category_add_error",{category:e,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}deleteCategory(e){return fi(this,null,function*(){const t=performance.now();try{const r=yield this.repository.deleteCategory(e);yield A.trackEvent("inventory_category_deleted",{category:e,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return F.recordResponseTime("inventory_category_delete",i,{category:e}),r}catch(r){throw yield A.trackEvent("inventory_category_delete_error",{category:e,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}getCategories(){return fi(this,null,function*(){var e;const t=performance.now();try{const r=yield this.repository.getCategories(),i=performance.now()-t;return F.recordResponseTime("inventory_categories_fetch",i,{categoryCount:((e=r.data)==null?void 0:e.length)||0}),r}catch(r){throw yield A.trackEvent("inventory_categories_fetch_error",{error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}getLocations(){return fi(this,null,function*(){var e;const t=performance.now();try{const r=yield this.repository.getLocations(),i=performance.now()-t;return F.recordResponseTime("inventory_locations_fetch",i,{locationCount:((e=r.data)==null?void 0:e.length)||0}),r}catch(r){throw yield A.trackEvent("inventory_locations_fetch_error",{error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}}var wn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class qf{constructor(e,t){this.repository=e,this.adapterManager=t}getInventoryStats(){return wn(this,null,function*(){const e=performance.now();try{const t=yield this.repository.getAllItems(),r={totalItems:t.length,categoriesCount:new Set(t.map(a=>a.category)).size,locationsCount:new Set(t.map(a=>a.location)).size,lowStockItems:t.filter(a=>(a.quantity||0)<10).length,expiredItems:t.filter(a=>a.expiration_date?new Date(a.expiration_date)<new Date:!1).length,lastUpdated:new Date},i=performance.now()-e;return F.recordResponseTime("inventory_stats_calculate",i,{totalItems:r.totalItems}),r}catch(t){throw yield A.trackEvent("inventory_stats_error",{error:t instanceof Error?t.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),t}})}getItemHistory(){return wn(this,null,function*(){const e=performance.now();try{const t=yield this.repository.getItemHistory(),r=performance.now()-e;return F.recordResponseTime("inventory_history_fetch",r,{historyCount:t.length}),t}catch(t){throw yield A.trackEvent("inventory_history_error",{error:t instanceof Error?t.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),t}})}refresh(){return wn(this,null,function*(){const e=performance.now();try{yield this.repository.refreshData();const t=performance.now()-e;return F.recordResponseTime("inventory_refresh",t,{}),{success:!0,error:null}}catch(t){return yield A.trackEvent("inventory_refresh_error",{error:t instanceof Error?t.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}})}}var zf=Object.defineProperty,wo=Object.getOwnPropertySymbols,Uf=Object.prototype.hasOwnProperty,Ff=Object.prototype.propertyIsEnumerable,Io=(c,e,t)=>e in c?zf(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Lf=(c,e)=>{for(var t in e||(e={}))Uf.call(e,t)&&Io(c,t,e[t]);if(wo)for(var t of wo(e))Ff.call(e,t)&&Io(c,t,e[t]);return c},O=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const tc=class fe{constructor(){this.cacheManager=new Eh,this.repository=new If,this.adapterManager=new bf,this.isInitialized=!1,this.initializationPromise=null,W.isRegistered("inventory_service")||W.registerCacheManager("inventory_service",this),this.coreService=new Of(this.repository,this.adapterManager),this.searchService=new Rf(this.repository,this.adapterManager),this.bulkService=new $f(this.repository,this.adapterManager),this.categoryManagementService=new Mf(this.repository,this.adapterManager),this.statsService=new qf(this.repository,this.adapterManager)}static getInstance(){return fe.instance||(fe.instance=new fe),fe.instance}static initialize(){return O(this,null,function*(){yield fe.getInstance().initialize()})}static createItem(e){return O(this,null,function*(){return fe.getInstance().createItem(e)})}static updateItem(e,t){return O(this,null,function*(){return fe.getInstance().updateItem(e,t)})}static deleteItem(e){return O(this,null,function*(){return fe.getInstance().deleteItem(e)})}static getItem(e){return O(this,null,function*(){return fe.getInstance(),fe.getItem(e)})}static getAllItems(e){return O(this,null,function*(){return fe.getInstance().getAllItems(e)})}getInstanceId(){return`instance_${this===fe.instance?"SINGLETON":"NEW"}`}initialize(){return O(this,null,function*(){const e=performance.now();if(!this.isInitialized){if(this.initializationPromise){yield this.initializationPromise;return}this.initializationPromise=O(this,null,function*(){try{yield this.adapterManager.initialize(),yield this.repository.initialize(this.adapterManager.getAdapter(),this.adapterManager.getCurrentAdapterType()),this.isInitialized=!0;const t=performance.now()-e;F.recordResponseTime("inventory_service_initialization",t,{service:"InventoryServiceFacade",operation:"initialize"})}finally{this.initializationPromise=null}}),yield this.initializationPromise}})}isReady(){return this.isInitialized}fetchInventoryItems(){return O(this,null,function*(){return yield this.searchService.fetchInventoryItems()})}fetchAllInventoryData(){return O(this,null,function*(){const e=performance.now();try{const t=yield this.searchService.fetchInventoryItems(),r=yield this.statsService.getInventoryStats(),i={tools:t.filter(s=>s.category==="Tools"),supplies:t.filter(s=>s.category==="Supplies"),equipment:t.filter(s=>s.category==="Equipment"),officeHardware:t.filter(s=>s.category==="Office Hardware"),categories:Array.from(new Set(t.map(s=>s.category).filter(Boolean))),isLoading:!1,error:null},a=performance.now()-e;return F.recordResponseTime("inventory_fetch_all_data",a,{itemCount:t.length.toString()}),i}catch(t){throw yield A.trackEvent("inventory_fetch_all_data_error",{error:t instanceof Error?t.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),t}})}getAllItems(e,t){return O(this,null,function*(){try{const r=yield this.searchService.getAllItems();return{data:r,count:Array.isArray(r)?r.length:0,error:null}}catch(r){return{data:[],count:0,error:r instanceof Error?r.message:"Unknown error"}}})}getItemById(e){return O(this,null,function*(){return yield this.coreService.getItemById(e)})}createItem(e){return O(this,null,function*(){return yield this.coreService.createItem(e)})}updateItem(e,t){return O(this,null,function*(){return yield this.coreService.updateItem(e,t)})}deleteItem(e){return O(this,null,function*(){return yield this.coreService.deleteItem(e)})}addInventoryItem(e){return O(this,null,function*(){return yield this.coreService.addInventoryItem(e)})}addCategory(e){return O(this,null,function*(){const t=yield this.categoryManagementService.addCategory(e);return{success:t.success,error:t.error||null}})}deleteCategory(e){return O(this,null,function*(){const t=yield this.categoryManagementService.deleteCategory(e);return{success:t.success,error:t.error||null}})}bulkCreateItems(e){return O(this,null,function*(){return yield this.bulkService.bulkCreateItems(e)})}bulkUpdateItems(e){return O(this,null,function*(){return yield this.bulkService.bulkUpdateItems(e)})}bulkDeleteItems(e){return O(this,null,function*(){return yield this.bulkService.bulkDeleteItems(e)})}searchItems(e){return O(this,null,function*(){return yield this.searchService.searchItems(e)})}getFilteredItems(e,t,r){return O(this,null,function*(){return yield this.searchService.getFilteredItems(e,t,r)})}getCategories(){return O(this,null,function*(){return yield this.categoryManagementService.getCategories()})}getLocations(){return O(this,null,function*(){return yield this.categoryManagementService.getLocations()})}getInventoryStats(){return O(this,null,function*(){try{const e=yield this.statsService.getInventoryStats();return{data:{totalItems:e.totalItems,categoriesCount:e.categoriesCount,locationsCount:e.locationsCount,lowStockItems:e.lowStockItems,expiredItems:e.expiredItems,lastUpdated:e.lastUpdated},error:null}}catch(e){return{data:null,error:e instanceof Error?e.message:"Unknown error"}}})}refresh(){return O(this,null,function*(){return yield this.statsService.refresh()})}validateItem(e){return O(this,null,function*(){return yield this.coreService.validateItem(e)})}getItemHistory(){return O(this,null,function*(){return yield this.statsService.getItemHistory()})}updateInventoryItem(e,t){return O(this,null,function*(){const r=yield this.coreService.updateItem(e,t);if(r.data)return r.data;throw new Error(r.error||"Failed to update item")})}deleteInventoryItem(e){return O(this,null,function*(){const t=yield this.coreService.deleteItem(e);if(!t.success)throw new Error(t.error||"Failed to delete item")})}refreshData(){return O(this,null,function*(){return yield this.searchService.refreshData()})}switchAdapter(e){return O(this,null,function*(){const t=performance.now();try{const r={success:!0,error:null},i=performance.now()-t;return F.recordResponseTime("inventory_adapter_switch",i,{adapterType:e}),r}catch(r){throw yield A.trackEvent("inventory_adapter_switch_error",{adapterType:e,error:r instanceof Error?r.message:"Unknown error"}),r}})}transformDataForModal(e){return e.map(t=>Lf({},t))}clearCache(){this.cacheManager.clear()}getCacheStats(){const e=this.cacheManager.getStats();return{hits:e.hits,misses:e.misses,size:e.size,updated_at:e.updated_at}}getCurrentAdapterType(){return this.adapterManager.getCurrentAdapterType()}getAdapterMetadata(){const e=this.adapterManager.getAdapterMetadata();return e&&typeof e=="object"?{type:e.type||"static",name:e.name||"Unknown",version:e.version||"1.0.0",capabilities:e.capabilities||[]}:{type:"static",name:"Default Adapter",version:"1.0.0",capabilities:[]}}subscribeToChanges(e){return Df.subscribeToChanges(t=>{this.clearCache(),A.trackEvent("inventory_realtime_update",{source:"facade",payload_type:typeof t,adapter_type:this.adapterManager.getCurrentAdapterType()}),e(t)})}};tc.instance=null;let Nf=tc;const O_=Nf.getInstance();var xf=Object.defineProperty,Bf=Object.defineProperties,jf=Object.getOwnPropertyDescriptors,So=Object.getOwnPropertySymbols,Vf=Object.prototype.hasOwnProperty,Hf=Object.prototype.propertyIsEnumerable,bo=(c,e,t)=>e in c?xf(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Kt=(c,e)=>{for(var t in e||(e={}))Vf.call(e,t)&&bo(c,t,e[t]);if(So)for(var t of So(e))Hf.call(e,t)&&bo(c,t,e[t]);return c},Qt=(c,e)=>Bf(c,jf(e));const Yt={QUICK:{maxRetries:1,baseDelay:100,maxDelay:200,backoffStrategy:"fixed"},STANDARD:{maxRetries:3,baseDelay:100,maxDelay:1e3,backoffStrategy:"linear"},NETWORK:{maxRetries:5,baseDelay:200,maxDelay:2e3,backoffStrategy:"exponential"},CRITICAL:{maxRetries:5,baseDelay:500,maxDelay:5e3,backoffStrategy:"exponential"},BACKGROUND:{maxRetries:2,baseDelay:1e3,maxDelay:5e3,backoffStrategy:"linear"}},lt={NETWORK_ONLY:c=>{const e=c.message.toLowerCase();return e.includes("network")||e.includes("timeout")||e.includes("fetch")||e.includes("connection")},TEMPORARY_ONLY:c=>{const e=c.message.toLowerCase();return e.includes("rate limit")||e.includes("temporary")||e.includes("busy")||e.includes("unavailable")},NETWORK_AND_TEMPORARY:c=>lt.NETWORK_ONLY(c)||lt.TEMPORARY_ONLY(c),ALL:()=>!0,NONE:()=>!1},$r={UI_OPERATION:Qt(Kt({},Yt.QUICK),{retryCondition:lt.NETWORK_ONLY}),DATA_FETCH:Qt(Kt({},Yt.STANDARD),{retryCondition:lt.NETWORK_AND_TEMPORARY}),API_CALL:Qt(Kt({},Yt.NETWORK),{retryCondition:lt.NETWORK_AND_TEMPORARY}),AUTH:Qt(Kt({},Yt.CRITICAL),{retryCondition:lt.NETWORK_AND_TEMPORARY}),BACKGROUND_TASK:Qt(Kt({},Yt.BACKGROUND),{retryCondition:lt.ALL})};Qt(Kt({},Yt.BACKGROUND),{retryCondition:lt.NETWORK_AND_TEMPORARY,syncInterval:3e4,maxConcurrentSyncs:3});var Gf=Object.defineProperty,Eo=Object.getOwnPropertySymbols,Wf=Object.prototype.hasOwnProperty,Kf=Object.prototype.propertyIsEnumerable,Ao=(c,e,t)=>e in c?Gf(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,To=(c,e)=>{for(var t in e||(e={}))Wf.call(e,t)&&Ao(c,t,e[t]);if(Eo)for(var t of Eo(e))Kf.call(e,t)&&Ao(c,t,e[t]);return c},qt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Ct{static executeWithRetry(e){return qt(this,arguments,function*(t,r={}){const i=performance.now(),a=To(To({},this.DEFAULT_CONFIG),r);let s,o=0;for(let l=0;l<=a.maxRetries;l++){o=l+1;try{const u=yield t(),h=performance.now()-i;return F.recordResponseTime("retry_operation_success",h,{service:"OptimizedRetryService",operation:"executeWithRetry",attempts:o.toString(),strategy:a.backoffStrategy}),{success:!0,data:u,attempts:o,totalDuration:h}}catch(u){if(s=u,l===a.maxRetries||a.retryCondition&&!a.retryCondition(s))break;const h=this.calculateDelay(l,a),f=a.jitter?h+Math.random()*100:h;console.warn(`[OptimizedRetryService] Operation failed (attempt ${o}/${a.maxRetries+1}): ${s.message}. Retrying in ${f.toFixed(0)}ms...`),yield this.sleep(f)}}const n=performance.now()-i;return F.recordErrorRate("retry_operation_failure",100,{service:"OptimizedRetryService",operation:"executeWithRetry",attempts:o.toString(),strategy:a.backoffStrategy,error:s.message}),{success:!1,error:s,attempts:o,totalDuration:n}})}static calculateDelay(e,t){let r;switch(t.backoffStrategy){case"linear":r=t.baseDelay*(e+1);break;case"exponential":r=t.baseDelay*Math.pow(2,e);break;case"fixed":r=t.baseDelay;break;default:r=t.baseDelay}return Math.min(r,t.maxDelay)}static sleep(e){return new Promise(t=>setTimeout(t,e))}static quickRetry(e){return qt(this,null,function*(){const t=yield this.executeWithRetry(e,$r.UI_OPERATION);if(!t.success)throw t.error;return t.data})}static standardRetry(e){return qt(this,null,function*(){const t=yield this.executeWithRetry(e,$r.DATA_FETCH);if(!t.success)throw t.error;return t.data})}static networkRetry(e){return qt(this,null,function*(){const t=yield this.executeWithRetry(e,$r.API_CALL);if(!t.success)throw t.error;return t.data})}static authRetry(e){return qt(this,null,function*(){const t=yield this.executeWithRetry(e,$r.AUTH);if(!t.success)throw t.error;return t.data})}static backgroundRetry(e){return qt(this,null,function*(){const t=yield this.executeWithRetry(e,$r.BACKGROUND_TASK);if(!t.success)throw t.error;return t.data})}}Ct.DEFAULT_CONFIG={maxRetries:3,baseDelay:100,maxDelay:1e3,backoffStrategy:"linear",jitter:!0};const Qf=Ct.quickRetry,Yf=Ct.standardRetry,Jf=Ct.networkRetry,Xf=Ct.authRetry,Zf=Ct.backgroundRetry,rc=Object.freeze(Object.defineProperty({__proto__:null,OptimizedRetryService:Ct,authRetry:Xf,backgroundRetry:Zf,networkRetry:Jf,quickRetry:Qf,standardRetry:Yf},Symbol.toStringTag,{value:"Module"}));var em=Object.defineProperty,tm=Object.defineProperties,rm=Object.getOwnPropertyDescriptors,ko=Object.getOwnPropertySymbols,im=Object.prototype.hasOwnProperty,nm=Object.prototype.propertyIsEnumerable,Co=(c,e,t)=>e in c?em(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,ic=(c,e)=>{for(var t in e||(e={}))im.call(e,t)&&Co(c,t,e[t]);if(ko)for(var t of ko(e))nm.call(e,t)&&Co(c,t,e[t]);return c},nc=(c,e)=>tm(c,rm(e)),ye=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const Pt=(c,e)=>{console.log(`Analytics Event: ${c}`,e)};function R_(c,e,t){return ye(this,null,function*(){try{const r=Ks(c);if(!r.isValid)throw new Error(r.errors.join(", "));const i=yield Ys(c);e(i)}catch(r){t(r instanceof Error?r.message:"Failed to create item")}})}function $_(c,e,t,r){return ye(this,null,function*(){try{if(!c)throw new Error("Item ID is required");const i=Ks(e);if(!i.isValid)throw new Error(i.errors.join(", "));const a=yield Bi(c,e);t(a)}catch(i){r(i instanceof Error?i.message:"Failed to update item")}})}function M_(c,e,t){return ye(this,null,function*(){try{if(!c)throw new Error("Item ID is required");yield ji(c),M("inventory","item_deleted",`Inventory item deleted: ${c}`,"info",{itemId:c,deletionMethod:"single_item"}),z("delete_item","inventory",{itemId:c,deletionMethod:"single_item"}),Pt("inventory_item_deleted",{itemId:c,deletionMethod:"single_item"}),e()}catch(r){t(r instanceof Error?r.message:"Failed to delete item")}})}function q_(c,e,t,r,i){return ye(this,null,function*(){try{if(!e||e.length===0)throw new Error("No items selected for bulk operation");let a;switch(c){case"delete":a=yield am(e,t==null?void 0:t.progressConfig);break;case"update":if(!(t!=null&&t.updateData))throw new Error("Update data is required for bulk update operation");a=yield om(e,t.updateData,t.progressConfig);break;case"export":if(!(t!=null&&t.exportOptions))throw new Error("Export options are required for bulk export operation");a=yield sm(e,t.exportOptions);break;default:throw new Error(`Unsupported bulk operation: ${c}`)}return r==null||r(a),a}catch(a){const s=a instanceof Error?a.message:"Bulk operation failed";throw i==null||i(s),new Error(s)}})}function z_(c,e,t,r){return ye(this,null,function*(){try{if(!c)throw new Error("No file selected for import");const i=e||{validateData:!0,skipDuplicates:!0,createMissingCategories:!0},a=cm(i);if(!a.isValid)throw new Error(`Invalid import options: ${a.errors.join(", ")}`);const s=yield Cc.importItems(c,i);return M("inventory","bulk_import_completed",`Bulk import completed: ${s.importedCount} items imported`,"info",{fileName:s.fileName,importedCount:s.importedCount,failedCount:s.failedCount,skippedCount:s.skippedCount,errors:s.errors.length,warnings:s.warnings.length}),t==null||t(s),s}catch(i){console.error("Bulk import failed:",i);const a=i instanceof Error?i.message:"Bulk import failed";throw r==null||r(a),new Error(a)}})}function U_(c,e,t){return ye(this,null,function*(){try{if(!c)throw new Error("Item ID is required");const r=yield Xs(c);M("inventory","item_duplicated",`Inventory item duplicated: ${c}`,"info",{originalItemId:c,duplicatedItemId:r.id}),z("duplicate_item","inventory",{originalItemId:c,duplicatedItemId:r.id}),Pt("inventory_item_duplicated",{originalItemId:c,duplicatedItemId:r.id}),e(r)}catch(r){t(r instanceof Error?r.message:"Failed to duplicate item")}})}function F_(c,e,t){return ye(this,null,function*(){try{if(!c)throw new Error("Item ID is required");const r=yield Js(c);M("inventory","item_archived",`Inventory item archived: ${c}`,"info",{itemId:c,archiveMethod:"single_item"}),z("archive_item","inventory",{itemId:c,archiveMethod:"single_item"}),Pt("inventory_item_archived",{itemId:c,archiveMethod:"single_item"}),e(r)}catch(r){t(r instanceof Error?r.message:"Failed to archive item")}})}function L_(c,e){return ye(this,null,function*(){try{const t=yield Zs(c,e);return M("inventory","bulk_update_by_category_completed",`Bulk update by category completed: ${t.updatedCount} items updated`,"info",{category:c,updatedCount:t.updatedCount}),z("bulk_update_by_category","inventory",{category:c,updatedCount:t.updatedCount}),Pt("inventory_bulk_update_by_category_completed",{category:c,updatedCount:t.updatedCount}),t}catch(t){throw console.error("Error in bulk update by category:",t),new Error("Failed to bulk update items by category")}})}function am(c,e){return ye(this,null,function*(){try{if(e){const{results:t,failed:r,errors:i,metrics:a}=yield Os.processBulkOperation(c,s=>ye(null,null,function*(){return yield ji(s)}),nc(ic({},e),{enableCaching:!0,maxConcurrentWorkers:4,memoryLimit:104857600,onMemoryWarning:(s,o)=>{console.warn(`Memory usage high: ${Math.round(s/1048576)}MB / ${Math.round(o/1048576)}MB`)}}));return console.log("Bulk deletion completed with performance metrics:",{total:c.length,successful:t.length,failed:r.length,errors:i.length,processingTime:a.averageProcessingTime,memoryUsage:a.peakMemoryUsage,processingRate:a.processingRate}),{deletedCount:t.length}}else{const r=(yield Promise.allSettled(c.map(i=>ji(i)))).filter(i=>i.status==="fulfilled").length;return M("inventory","bulk_deletion_completed",`Bulk deletion completed: ${r}/${c.length} items`,"info",{totalItems:c.length,deletedCount:r,failedCount:c.length-r,deletionMethod:"bulk_operation"}),z("bulk_delete_items","inventory",{totalItems:c.length,deletedCount:r,failedCount:c.length-r}),Pt("inventory_bulk_deletion_completed",{totalItems:c.length,deletedCount:r,failedCount:c.length-r,deletionMethod:"bulk_operation"}),{deletedCount:r}}}catch(t){throw console.error("Error in bulk deletion:",t),new Error("Bulk deletion failed")}})}function om(c,e,t){return ye(this,null,function*(){try{if(t){const{results:r,failed:i,errors:a,metrics:s}=yield Os.processBulkOperation(c,o=>ye(null,null,function*(){return yield Bi(o,xi(e))}),nc(ic({},t),{enableCaching:!0,maxConcurrentWorkers:4,memoryLimit:104857600,onMemoryWarning:(o,n)=>{console.warn(`Memory usage high: ${Math.round(o/1048576)}MB / ${Math.round(n/1048576)}MB`)}}));return console.log("Bulk update completed with performance metrics:",{total:c.length,successful:r.length,failed:i.length,errors:a.length,processingTime:s.averageProcessingTime,memoryUsage:s.peakMemoryUsage,processingRate:s.processingRate}),{updatedCount:r.length}}else{const i=(yield Promise.allSettled(c.map(a=>Bi(a,xi(e))))).filter(a=>a.status==="fulfilled").length;return M("inventory","bulk_update_completed",`Bulk update completed: ${i}/${c.length} items`,"info",{totalItems:c.length,updatedCount:i,failedCount:c.length-i,updateMethod:"bulk_operation"}),z("bulk_update_items","inventory",{totalItems:c.length,updatedCount:i,failedCount:c.length-i}),Pt("inventory_bulk_update_completed",{totalItems:c.length,updatedCount:i,failedCount:c.length-i,updateMethod:"bulk_operation"}),{updatedCount:i}}}catch(r){throw console.error("Error in bulk update:",r),new Error("Bulk update failed")}})}function sm(c,e){return ye(this,null,function*(){try{const t=yield Pc.exportItems(c,e);return M("inventory","bulk_export_completed",`Bulk export completed: ${c.length} items exported`,"info",{totalItems:c.length,exportFormat:e.format,exportMethod:"bulk_operation"}),z("bulk_export_items","inventory",{totalItems:c.length,exportFormat:e.format}),Pt("inventory_bulk_export_completed",{totalItems:c.length,exportFormat:e.format,exportMethod:"bulk_operation"}),console.log("Bulk export completed with performance metrics:",{totalItems:c.length,exportFormat:e.format,exportMethod:"bulk_operation"}),{exportedCount:c.length}}catch(t){throw console.error("Error in bulk export:",t),new Error("Bulk export failed")}})}function cm(c){const e=[];return typeof c.validateData!="boolean"&&e.push("validateData must be a boolean"),typeof c.skipDuplicates!="boolean"&&e.push("skipDuplicates must be a boolean"),typeof c.createMissingCategories!="boolean"&&e.push("createMissingCategories must be a boolean"),{isValid:e.length===0,errors:e}}var Ie=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class lm{scanOperationalGaps(e){return Ie(this,null,function*(){const t=[],r=yield this.scanEquipmentMaintenance(e);t.push(...r);const i=yield this.scanComplianceGaps(e);t.push(...i);const a=yield this.scanOperationalIssues(e);t.push(...a);const s=yield this.scanSafetyGaps(e);return t.push(...s),t})}scanEquipmentMaintenance(e){return Ie(this,null,function*(){const t=[],r=new Date;try{const i=yield this.scanAutoclaveMaintenance(e,r);t.push(...i);const a=yield this.scanToolMaintenance(e);t.push(...a)}catch(i){console.error("Error scanning equipment maintenance:",i)}return t})}scanAutoclaveMaintenance(e,t){return Ie(this,null,function*(){const r=[],{data:i,error:a}=yield d.from("autoclaves").select("*").eq("facility_id",e).eq("status","active");if(a)throw a;return i==null||i.forEach(s=>{const o=s;o.next_maintenance&&new Date(o.next_maintenance)<=t&&r.push({id:Ze(),type:"equipment",priority:"high",title:`Autoclave Maintenance Due: ${o.autoclave_name}`,description:`Maintenance is due for autoclave ${o.autoclave_name}. Schedule maintenance to ensure proper operation.`,category:"equipment",dueDate:o.next_maintenance,estimatedPoints:75,estimatedDuration:120,assignedRole:"technician",facilityId:e,metadata:{autoclaveId:o.id,equipmentType:"autoclave"}}),o.calibration_due&&new Date(o.calibration_due)<=t&&r.push({id:Ze(),type:"compliance",priority:"urgent",title:`Autoclave Calibration Due: ${o.autoclave_name}`,description:`Calibration is due for autoclave ${o.autoclave_name}. This is critical for compliance.`,category:"compliance",dueDate:o.calibration_due,estimatedPoints:100,estimatedDuration:60,assignedRole:"technician",facilityId:e,metadata:{autoclaveId:o.id,equipmentType:"autoclave"}})}),r})}scanToolMaintenance(e){return Ie(this,null,function*(){const t=[],r=yield me.getToolsByFacilityAndStatus(e,"problem");return r==null||r.forEach(i=>{t.push({id:Ze(),type:"equipment",priority:"medium",title:`Tool Maintenance Required: ${i.name||i.id}`,description:`Tool ${i.name||i.id} requires maintenance. Check condition and repair if possible.`,category:"equipment",dueDate:new Date().toISOString().split("T")[0],estimatedPoints:50,estimatedDuration:45,assignedRole:"technician",facilityId:e,metadata:{toolId:i.id,toolName:i.name||i.id}})}),t})}scanComplianceGaps(e){return Ie(this,null,function*(){const t=[],r=new Date;try{const i=yield this.scanBITests(e,r);t.push(...i);const a=yield this.scanCleaningTasks(e,r);t.push(...a)}catch(i){console.error("Error scanning compliance gaps:",i)}return t})}scanBITests(e,t){return Ie(this,null,function*(){const r=[],{data:i,error:a}=yield d.from("biological_indicator_tests").select("*").eq("facility_id",e).eq("status","pending").lte("due_date",t.toISOString().split("T")[0]);if(a)throw a;return i==null||i.forEach(s=>{const o=s;r.push({id:Ze(),type:"compliance",priority:"urgent",title:"Daily BI Test Required",description:"Daily Biological Indicator test is required for sterilization compliance.",category:"compliance",dueDate:o.due_date,estimatedPoints:80,estimatedDuration:30,assignedRole:"operator",facilityId:e,metadata:{biTestId:o.id,testType:"daily_bi"}})}),r})}scanCleaningTasks(e,t){return Ie(this,null,function*(){const r=[],{data:i,error:a}=yield d.from("cleaning_tasks").select("*").eq("facility_id",e).eq("status","pending").lte("due_date",t.toISOString());if(a)throw a;return i==null||i.forEach(s=>{const o=s;r.push({id:Ze(),type:"compliance",priority:o.priority==="critical"?"urgent":"high",title:`Cleaning Task Overdue: ${o.name}`,description:`Cleaning task "${o.name}" is overdue. Complete to maintain compliance.`,category:"compliance",dueDate:o.due_date,estimatedPoints:60,estimatedDuration:o.estimated_duration_minutes||60,assignedRole:"cleaning_staff",facilityId:e,metadata:{taskId:o.id,taskName:o.name,location:o.location}})}),r})}scanOperationalIssues(e){return Ie(this,null,function*(){const t=[];try{const r=yield this.scanStuckTools(e);t.push(...r);const i=yield this.scanLowInventory(e);t.push(...i)}catch(r){console.error("Error scanning operational issues:",r)}return t})}scanStuckTools(e){return Ie(this,null,function*(){const t=[],r=["bath1","bath2","airDry","autoclave"],a=(yield Promise.all(r.map(s=>me.getToolsByFacilityAndStatus(e,s)))).flat();return a==null||a.forEach(s=>{t.push({id:Ze(),type:"operational",priority:"medium",title:`Tool Stuck in Phase: ${s.name||s.id}`,description:`Tool ${s.name||s.id} appears to be stuck in ${s.status} phase. Check workflow status.`,category:"operational",dueDate:new Date().toISOString().split("T")[0],estimatedPoints:40,estimatedDuration:30,assignedRole:"operator",facilityId:e,metadata:{toolId:s.id,toolName:s.name||s.id,currentPhase:s.status}})}),t})}scanLowInventory(e){return Ie(this,null,function*(){const t=[],i=(yield mr.getItems()).filter(a=>{var s,o;return a.facility_id===e&&(a.quantity||0)<(((s=a.data)==null?void 0:s.min_quantity)||0)&&((o=a.data)==null?void 0:o.isActive)===!0});return i==null||i.forEach(a=>{var s;t.push({id:Ze(),type:"operational",priority:"high",title:`Low Stock Alert: ${a.name}`,description:`Inventory item ${a.name} is running low. Current quantity: ${a.quantity}.`,category:"operational",dueDate:new Date().toISOString().split("T")[0],estimatedPoints:35,estimatedDuration:20,assignedRole:"inventory_manager",facilityId:e,metadata:{itemId:a.id,itemName:a.name,currentQuantity:a.quantity,minQuantity:(s=a.data)==null?void 0:s.min_quantity}})}),t})}scanSafetyGaps(e){return Ie(this,null,function*(){const t=[];try{const r=yield this.scanFailedCycles(e);t.push(...r)}catch(r){console.error("Error scanning safety gaps:",r)}return t})}scanFailedCycles(e){return Ie(this,null,function*(){const t=[],{data:r,error:i}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e).eq("status","failed").gte("created_at",new Date(Date.now()-6048e5).toISOString());if(i)throw i;return r==null||r.forEach(a=>{const s=a;t.push({id:Ze(),type:"safety",priority:"high",title:`Investigate Failed Cycle: ${s.id}`,description:`Sterilization cycle ${s.id} failed and requires investigation to prevent future failures.`,category:"safety",dueDate:new Date().toISOString().split("T")[0],estimatedPoints:70,estimatedDuration:90,assignedRole:"supervisor",facilityId:e,metadata:{cycleId:s.id,failureReason:s.failure_reason}})}),t})}getGapStatistics(e){const t=e.length,r=e.reduce((l,u)=>(l[u.type]=(l[u.type]||0)+1,l),{}),i=e.reduce((l,u)=>(l[u.priority]=(l[u.priority]||0)+1,l),{}),a=e.reduce((l,u)=>(l[u.category]=(l[u.category]||0)+1,l),{}),s=e.reduce((l,u)=>(l[u.assignedRole]=(l[u.assignedRole]||0)+1,l),{}),o=t>0?e.reduce((l,u)=>l+u.estimatedPoints,0)/t:0,n=e.reduce((l,u)=>l+u.estimatedDuration,0);return{total:t,byType:r,byPriority:i,byCategory:a,byRole:s,averagePoints:o,totalEstimatedDuration:n}}filterGaps(e,t){return e.filter(r=>!(t.type&&r.type!==t.type||t.priority&&r.priority!==t.priority||t.category&&r.category!==t.category||t.assignedRole&&r.assignedRole!==t.assignedRole||t.facilityId&&r.facilityId!==t.facilityId))}sortGapsByPriority(e){const t={urgent:4,high:3,medium:2,low:1};return e.sort((r,i)=>{const a=(t[i.priority]||0)-(t[r.priority]||0);return a!==0?a:new Date(r.dueDate).getTime()-new Date(i.dueDate).getTime()})}getGapsDueToday(e){const t=new Date().toISOString().split("T")[0];return e.filter(r=>r.dueDate<=t)}getOverdueGaps(e){const t=new Date().toISOString().split("T")[0];return e.filter(r=>r.dueDate<t)}}var um=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const dm="undefined/functions/v1/openai";function hm(c){return um(this,arguments,function*({prompt:e,context:t=""}){throw console.warn("askCliniioAI() is deprecated. Use UnifiedAIService.askAI() instead."),dm?new Error("Missing NEXT_PUBLIC_SUPABASE_ANON_KEY"):new Error("Missing NEXT_PUBLIC_SUPABASE_URL")})}var fm=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class mm{assignTasksWithAI(e,t,r){return fm(this,null,function*(){try{const i=this.prepareAnalysisData(e,t,r),a=yield hm({prompt:this.buildAIPrompt(i),context:"Daily Operations Task Assignment"});return this.parseAITaskAssignments(a,e,t,r)}catch(i){return console.error("AI task assignment failed, using fallback logic:",i),this.fallbackTaskAssignment(e,t,r)}})}prepareAnalysisData(e,t,r){return{operationalGaps:e,availableUsers:t,configuration:r,facilityContext:{totalGaps:e.length,gapTypes:e.reduce((i,a)=>(i[a.type]=(i[a.type]||0)+1,i),{}),priorityDistribution:e.reduce((i,a)=>(i[a.priority]=(i[a.priority]||0)+1,i),{})}}}buildAIPrompt(e){return`Analyze the following operational gaps and assign tasks to users optimally:

Operational Gaps: ${JSON.stringify(e.operationalGaps,null,2)}
Available Users: ${JSON.stringify(e.availableUsers,null,2)}
Configuration: ${JSON.stringify(e.configuration,null,2)}
Facility Context: ${JSON.stringify(e.facilityContext,null,2)}

Please provide a JSON response with task assignments that:
1. Respects max tasks per user (${e.configuration.maxTasksPerUser})
2. Prioritizes urgent and high priority tasks
3. Matches user roles to task categories
4. Balances workload across users
5. Considers task priority and estimated duration

Return ONLY valid JSON in this exact format:
[
  {
    "userId": "user_id_here",
    "tasks": [
      {
        "gapId": "gap_id_here"
      }
    ]
  }
]

Each task should reference a gapId from the operational gaps. Do not include any explanatory text, only the JSON array.`}parseAITaskAssignments(e,t,r,i){try{const a=e.match(/\[[\s\S]*\]/);if(!a)return console.warn("No JSON array found in AI response, using fallback"),this.fallbackTaskAssignment(t,r,i);const s=JSON.parse(a[0]);if(!Array.isArray(s))return console.warn("AI response is not an array, using fallback"),this.fallbackTaskAssignment(t,r,i);const o=[],n=new Map(r.map(u=>[u.id,u])),l=new Map(t.map(u=>[u.id,u]));for(const u of s){if(!u.userId||!Array.isArray(u.tasks))continue;if(!n.get(u.userId)){console.warn(`User ${u.userId} not found, skipping assignment`);continue}const f=[];for(const m of u.tasks){if(!m.gapId)continue;const p=l.get(m.gapId);p&&f.push({id:Jd(),title:p.title,description:p.description,category:p.category,priority:p.priority,points:p.estimatedPoints,estimatedDuration:p.estimatedDuration,dueDate:p.dueDate,type:p.type,assignedRole:p.assignedRole,facilityId:p.facilityId,metadata:p.metadata,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}f.length>0&&o.push({userId:u.userId,tasks:f})}return o.length>0?o:(console.warn("AI parsing produced no valid assignments, using fallback"),this.fallbackTaskAssignment(t,r,i))}catch(a){return console.error("Error parsing AI response:",a),this.fallbackTaskAssignment(t,r,i)}}fallbackTaskAssignment(e,t,r){const i=[],a=[...e].sort((o,n)=>Wa(n.priority)-Wa(o.priority)),s=new Map;for(const o of a){const n=t.filter(u=>(s.get(u.id)||0)<r.maxTasksPerUser);if(n.length===0)break;const l=this.findBestUserMatch(o,n);if(l){const u=s.get(l.id)||0;s.set(l.id,u+1);let h=i.find(f=>f.userId===l.id);h||(h={userId:l.id,tasks:[]},i.push(h)),h.tasks.push({id:Yd(),title:o.title,description:o.description,category:o.category,priority:o.priority,points:o.estimatedPoints,dueDate:o.dueDate,type:o.type,estimatedDuration:o.estimatedDuration,assignedRole:o.assignedRole,facilityId:o.facilityId,metadata:o.metadata,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}}return i}findBestUserMatch(e,t){if(e.assignedRole){const i=t.find(a=>a.role===e.assignedRole);if(i)return i}const r=t.filter(i=>Gs(i.role,e.category));return r.length>0?r[0]:t[0]||null}validateTaskAssignments(e,t){const r=[],i=[];return e.forEach((a,s)=>{var o;a.userId||r.push(`Assignment ${s+1}: Missing userId`),(!a.tasks||a.tasks.length===0)&&i.push(`Assignment ${s+1}: No tasks assigned`),a.tasks&&a.tasks.length>t.maxTasksPerUser&&r.push(`Assignment ${s+1}: Exceeds max tasks per user (${a.tasks.length} > ${t.maxTasksPerUser})`),(o=a.tasks)==null||o.forEach((n,l)=>{n.title||r.push(`Assignment ${s+1}, Task ${l+1}: Missing title`),n.category||r.push(`Assignment ${s+1}, Task ${l+1}: Missing category`),n.priority||r.push(`Assignment ${s+1}, Task ${l+1}: Missing priority`),n.points<=0&&i.push(`Assignment ${s+1}, Task ${l+1}: Zero or negative points`),n.estimatedDuration<=0&&i.push(`Assignment ${s+1}, Task ${l+1}: Zero or negative duration`)})}),{isValid:r.length===0,errors:r,warnings:i}}getAssignmentStatistics(e){const t=e.length,r=e.reduce((l,u)=>l+u.tasks.length,0),i=t>0?r/t:0,a={},s={};let o=0,n=0;return e.forEach(l=>{l.tasks.forEach(u=>{a[u.priority]=(a[u.priority]||0)+1,s[u.category]=(s[u.category]||0)+1,o+=u.points,n+=u.estimatedDuration})}),{totalAssignments:t,totalTasks:r,averageTasksPerUser:i,tasksByPriority:a,tasksByCategory:s,totalPoints:o,totalEstimatedDuration:n}}optimizeTaskAssignments(e,t){const r=new Map;e.forEach(s=>{const o={taskCount:s.tasks.length,totalPoints:s.tasks.reduce((n,l)=>n+l.points,0),totalDuration:s.tasks.reduce((n,l)=>n+l.estimatedDuration,0)};r.set(s.userId,o)});const i=[...e];return Array.from(r.entries()).filter(([s,o])=>o.taskCount>t.maxTasksPerUser).map(([s,o])=>s).forEach(s=>{const o=i.find(u=>u.userId===s);if(!o)return;const n=o.tasks.slice(t.maxTasksPerUser);o.tasks=o.tasks.slice(0,t.maxTasksPerUser);const l=i.filter(u=>u.tasks.length<t.maxTasksPerUser&&u.userId!==s);n.forEach(u=>{if(l.length>0){const h=l[0];h.tasks.push(u);const f=l.findIndex(m=>m.userId===h.userId);f>=0&&h.tasks.length>=t.maxTasksPerUser&&l.splice(f,1)}})}),i}exportTaskAssignments(e){return JSON.stringify(e,null,2)}importTaskAssignments(e){try{const t=JSON.parse(e);if(!Array.isArray(t))return{success:!1,assignments:[],errors:["Invalid format: expected array of assignments"]};const r=[];return t.forEach((i,a)=>{i.userId||r.push(`Assignment ${a+1}: Missing userId`),(!i.tasks||!Array.isArray(i.tasks))&&r.push(`Assignment ${a+1}: Missing or invalid tasks array`)}),{success:r.length===0,assignments:t,errors:r}}catch(t){return{success:!1,assignments:[],errors:["Invalid JSON format"]}}}}var mi=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class pm{getFacilityUsers(e){return mi(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("id, full_name, role, department, is_active, facility_id").eq("facility_id",e).eq("is_active",!0);if(r)throw r;return(t||[]).map(i=>{const a=i;return{id:a.id,role:a.role,full_name:a.full_name,department:a.department,is_active:a.is_active,facility_id:a.facility_id}})})}getUsersByRole(e,t){return mi(this,null,function*(){return(yield this.getFacilityUsers(e)).filter(i=>i.role===t)})}getUsersByDepartment(e,t){return mi(this,null,function*(){return(yield this.getFacilityUsers(e)).filter(i=>i.department===t)})}getAvailableRoles(){return[{role:"technician",description:"Equipment maintenance and repair specialist",capabilities:["equipment_maintenance","tool_repair","calibration"],compatibleCategories:["equipment","compliance"]},{role:"operator",description:"Daily operations and sterilization specialist",capabilities:["sterilization","daily_operations","bi_testing"],compatibleCategories:["operational","compliance"]},{role:"cleaning_staff",description:"Environmental cleaning and sanitation specialist",capabilities:["environmental_cleaning","sanitization","compliance"],compatibleCategories:["compliance","operational"]},{role:"inventory_manager",description:"Inventory management and supply specialist",capabilities:["inventory_management","supply_ordering","stock_control"],compatibleCategories:["operational"]},{role:"supervisor",description:"Operations oversight and safety specialist",capabilities:["safety_investigation","quality_control","oversight"],compatibleCategories:["safety","operational"]},{role:"manager",description:"Facility management and coordination",capabilities:["facility_management","coordination","planning"],compatibleCategories:["operational","safety","compliance"]}]}isRoleCompatibleWithCategory(e,t){const i=this.getAvailableRoles().find(a=>a.role===e);return i?i.compatibleCategories.includes(t):!1}getRoleCapabilities(e){const r=this.getAvailableRoles().find(i=>i.role===e);return(r==null?void 0:r.capabilities)||[]}findBestUserMatch(e,t,r){if(e.assignedRole){const a=t.find(s=>s.role===e.assignedRole);if(a)return a}const i=t.filter(a=>this.isRoleCompatibleWithCategory(a.role,e.category));return i.length>0?r?i.reduce((a,s)=>{const o=r.get(a.id),n=r.get(s.id);return o?n&&n.utilization<o.utilization?s:a:s}):i[0]:r&&t.length>0?t.reduce((a,s)=>{const o=r.get(a.id),n=r.get(s.id);return o?n&&n.utilization<o.utilization?s:a:s}):t[0]||null}calculateUserWorkload(e,t,r,i,a=5){const s=a,o=s>0?t/s*100:0;return{userId:e,currentTasks:t,totalPoints:r,totalDuration:i,capacity:s,utilization:o}}getUserWorkloadStatistics(e,t){const r=e.length;let i=0,a=0,s=0;const o={},n={low:0,medium:0,high:0};e.forEach(u=>{const h=t.get(u.id);h&&(i+=h.utilization,h.utilization>100?a++:h.utilization<50&&s++,h.utilization<50?n.low++:h.utilization<=80?n.medium++:n.high++,o[u.role]=(o[u.role]||0)+h.utilization)});const l=r>0?i/r:0;return{totalUsers:r,averageUtilization:l,overloadedUsers:a,underutilizedUsers:s,workloadByRole:o,workloadDistribution:n}}getUsersWithCapacity(e,t,r){return e.filter(i=>{const a=t.get(i.id);return!a||a.currentTasks<r})}getOverloadedUsers(e,t,r){return e.filter(i=>{const a=t.get(i.id);return a&&a.currentTasks>r})}balanceWorkload(e,t,r){const i=[],a=this.getOverloadedUsers(e,t,r),s=this.getUsersWithCapacity(e,t,r);return a.length>0&&(s.length>0?i.push({type:"redistribute",description:`Redistribute tasks from ${a.length} overloaded users to ${s.length} users with capacity`,priority:"high"}):i.push({type:"add_user",description:"All users are at capacity. Consider adding more staff or increasing capacity limits",priority:"high"})),Array.from(t.values()).reduce((n,l)=>n+l.utilization,0)/t.size>90&&i.push({type:"reduce_tasks",description:"Overall utilization is very high. Consider reducing task load or adding resources",priority:"medium"}),{recommendations:i,canBalance:s.length>0}}getUserPerformanceMetrics(e,t){return mi(this,null,function*(){return(yield this.getFacilityUsers(e)).map(i=>({userId:i.id,userName:i.full_name,role:i.role,tasksCompleted:0,averageCompletionTime:0,pointsEarned:0,efficiency:0}))})}validateUserData(e){const t=[];(!e.id||e.id.trim()==="")&&t.push("User ID is required"),(!e.role||e.role.trim()==="")&&t.push("User role is required"),(!e.full_name||e.full_name.trim()==="")&&t.push("Full name is required"),(!e.facility_id||e.facility_id.trim()==="")&&t.push("Facility ID is required");const r=this.getAvailableRoles();return e.role&&!r.find(i=>i.role===e.role)&&t.push(`Invalid role: ${e.role}`),{isValid:t.length===0,errors:t}}exportUserData(e){return JSON.stringify(e,null,2)}importUserData(e){try{const t=JSON.parse(e);if(!Array.isArray(t))return{success:!1,users:[],errors:["Invalid format: expected array of users"]};const r=[];return t.forEach((i,a)=>{const s=this.validateUserData(i);s.isValid||r.push(`User ${a+1}: ${s.errors.join(", ")}`)}),{success:r.length===0,users:t,errors:r}}catch(t){return{success:!1,users:[],errors:["Invalid JSON format"]}}}}var gm=Object.defineProperty,ym=Object.defineProperties,_m=Object.getOwnPropertyDescriptors,Po=Object.getOwnPropertySymbols,vm=Object.prototype.hasOwnProperty,wm=Object.prototype.propertyIsEnumerable,Do=(c,e,t)=>e in c?gm(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Im=(c,e)=>{for(var t in e||(e={}))vm.call(e,t)&&Do(c,t,e[t]);if(Po)for(var t of Po(e))wm.call(e,t)&&Do(c,t,e[t]);return c},Sm=(c,e)=>ym(c,_m(e));const Oo={inventory_items:{defaultLimit:50,maxLimit:200,maxOffset:1e4,allowedOrderByFields:["created_at","updated_at","name","category","quantity"],defaultOrderBy:"created_at",defaultOrderDirection:"desc"},sterilization_cycles:{defaultLimit:100,maxLimit:500,maxOffset:5e3,allowedOrderByFields:["start_time","created_at","cycle_number","status"],defaultOrderBy:"start_time",defaultOrderDirection:"desc"},audit_logs:{defaultLimit:100,maxLimit:500,maxOffset:2e3,allowedOrderByFields:["created_at","action","module"],defaultOrderBy:"created_at",defaultOrderDirection:"desc"},users:{defaultLimit:100,maxLimit:500,maxOffset:2e3,allowedOrderByFields:["created_at","email","role"],defaultOrderBy:"created_at",defaultOrderDirection:"desc"},admin_task_config:{defaultLimit:20,maxLimit:100,maxOffset:1e3,allowedOrderByFields:["facility_id","created_at","updated_at"],defaultOrderBy:"facility_id",defaultOrderDirection:"asc"},default:{defaultLimit:50,maxLimit:200,maxOffset:5e3,allowedOrderByFields:["created_at","id"],defaultOrderBy:"created_at",defaultOrderDirection:"desc"}};function Yi(c={},e="default"){const t=Oo[e]||Oo.default;let r=c.limit||t.defaultLimit;r<=0&&(r=t.defaultLimit),r>t.maxLimit&&(v.warn(`Query limit ${r} exceeds maximum ${t.maxLimit} for table ${e}, capping to maximum`),r=t.maxLimit);let i=c.offset||0;i<0&&(i=0),i>t.maxOffset&&(v.warn(`Query offset ${i} exceeds maximum ${t.maxOffset} for table ${e}, capping to maximum`),i=t.maxOffset);let a=c.orderBy||t.defaultOrderBy;t.allowedOrderByFields.includes(a)||(v.warn(`Order by field '${a}' not allowed for table ${e}, using default '${t.defaultOrderBy}'`),a=t.defaultOrderBy);const s=c.orderDirection||t.defaultOrderDirection;return["asc","desc"].includes(s)||v.warn(`Invalid order direction '${s}' for table ${e}, using default '${t.defaultOrderDirection}'`),Sm(Im({},c),{limit:r,offset:i,orderBy:a,orderDirection:s})}function bm(c,e={},t="default"){const r=Yi(e,t);return{query:c.limit(r.limit).range(r.offset,r.offset+r.limit-1),offset:r.offset,limit:r.limit}}function Em(c,e={},t="default"){const r=Yi(e,t);return c.order(r.orderBy,{ascending:r.orderDirection==="asc"})}function Am(c,e,t={},r="default"){const i=Yi(t,r),a=Math.ceil(e/i.limit),s=Math.floor(i.offset/i.limit)+1;return{data:c,total:e,page:s,limit:i.limit,totalPages:a,hasNext:s<a,hasPrev:s>1}}function Tm(c,e){return["id","created_at","updated_at"].join(", ")}function km(c,e={},t="default"){const r=Yi(e,t),i=Em(c,r,t),{query:a}=bm(i,r,t);return{query:a,safeOptions:r,warnings:[]}}var Cm=Object.defineProperty,Pm=Object.defineProperties,Dm=Object.getOwnPropertyDescriptors,Ro=Object.getOwnPropertySymbols,Om=Object.prototype.hasOwnProperty,Rm=Object.prototype.propertyIsEnumerable,$o=(c,e,t)=>e in c?Cm(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,$m=(c,e)=>{for(var t in e||(e={}))Om.call(e,t)&&$o(c,t,e[t]);if(Ro)for(var t of Ro(e))Rm.call(e,t)&&$o(c,t,e[t]);return c},Mm=(c,e)=>Pm(c,Dm(e)),et=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class In{static getConfig(e){return et(this,null,function*(){try{const{data:t,error:r}=yield d.from("admin_task_config").select("id, facility_id, max_tasks_per_user, enabled_categories, priority_thresholds, auto_assignment, ai_sensitivity, ai_confidence_threshold, max_ai_processing_time_ms, workload_balancing_enabled, max_concurrent_tasks_per_user, role_category_mapping, task_notifications_enabled, notification_channels, compliance_tracking_enabled, audit_logging_enabled, task_optimization_enabled, predictive_assignment_enabled, created_by, updated_by, created_at, updated_at").eq("facility_id",e).single();if(r){if(r.code==="PGRST116")return v.info(`No admin config found for facility ${e}, creating default`),yield this.createDefaultConfig(e);throw r}return this.mapDatabaseToConfig(t)}catch(t){throw v.error("Error getting admin task config:",t),new Error("Failed to retrieve admin task configuration")}})}static updateConfig(e,t){return et(this,null,function*(){return this.upsertConfig(e,t)})}static upsertConfig(e,t){return et(this,null,function*(){try{const r=Vd(t),i=Fe(),a={facility_id:e,max_tasks_per_user:r.maxTasksPerUser,enabled_categories:r.enabledCategories,priority_thresholds:r.priorityThresholds,auto_assignment:r.autoAssignment,ai_sensitivity:r.aiSensitivity,ai_confidence_threshold:.75,max_ai_processing_time_ms:3e4,workload_balancing_enabled:!0,max_concurrent_tasks_per_user:5,role_category_mapping:{equipment:["technician","maintenance"],compliance:["supervisor","manager","operator"],operational:["operator","inventory_manager"],safety:["supervisor","manager"]},task_notifications_enabled:!0,notification_channels:["email","in_app"],compliance_tracking_enabled:!0,audit_logging_enabled:!0,task_optimization_enabled:!0,predictive_assignment_enabled:!0,updated_by:i},{data:s,error:o}=yield d.from("admin_task_config").upsert(a,{onConflict:"facility_id",ignoreDuplicates:!1}).select("*").single();if(o)throw o;return v.info(`Admin task config updated for facility ${e}`),this.mapDatabaseToConfig(s)}catch(r){throw v.error("Error upserting admin task config:",r),new Error("Failed to save admin task configuration")}})}static createDefaultConfig(e){return et(this,null,function*(){try{const t=Fe(),r={facility_id:e,max_tasks_per_user:3,enabled_categories:["equipment","compliance","operational","safety"],priority_thresholds:{low:1,medium:2,high:3,urgent:4},auto_assignment:!0,ai_sensitivity:"medium",ai_confidence_threshold:.75,max_ai_processing_time_ms:3e4,workload_balancing_enabled:!0,max_concurrent_tasks_per_user:5,role_category_mapping:{equipment:["technician","maintenance"],compliance:["supervisor","manager","operator"],operational:["operator","inventory_manager"],safety:["supervisor","manager"]},task_notifications_enabled:!0,notification_channels:["email","in_app"],compliance_tracking_enabled:!0,audit_logging_enabled:!0,task_optimization_enabled:!0,predictive_assignment_enabled:!0,created_by:t,updated_by:t},{data:i,error:a}=yield d.from("admin_task_config").insert(r).select("*").single();if(a)throw a;return v.info(`Default admin task config created for facility ${e}`),this.mapDatabaseToConfig(i)}catch(t){throw v.error("Error creating default admin task config:",t),new Error("Failed to create default admin task configuration")}})}static deleteConfig(e){return et(this,null,function*(){try{const{error:t}=yield d.from("admin_task_config").delete().eq("facility_id",e);if(t)throw t;v.info(`Admin task config deleted for facility ${e}`)}catch(t){throw v.error("Error deleting admin task config:",t),new Error("Failed to delete admin task configuration")}})}static mapDatabaseToConfig(e){var t;return{maxTasksPerUser:e.max_tasks_per_user,enabledCategories:e.enabled_categories||[],priorityThresholds:e.priority_thresholds||{low:1,medium:2,high:3,urgent:4},priorityWeights:e.priority_weights||{low:1,medium:2,high:3,urgent:4},rolePreferences:e.role_category_mapping||{},timeConstraints:e.time_constraints||{maxTaskDuration:120,minTaskDuration:5},autoAssignment:e.auto_assignment,aiSensitivity:e.ai_sensitivity||"medium",aiEnabled:(t=e.ai_enabled)!=null?t:!0}}static getAllConfigs(){return et(this,arguments,function*(e={}){try{const{orderBy:t="facility_id",orderDirection:r="asc"}=e,{query:i,safeOptions:a,warnings:s}=km(d.from("admin_task_config"),Mm($m({},e),{orderBy:t,orderDirection:r}),"admin_task_config"),o=i.select(Tm("admin_task_config"),{count:"exact"}),{data:n,error:l,count:u}=yield o;if(l)throw l;return s.length>0&&v.warn("Admin config query warnings:",s),Am(n||[],u||0,a,"admin_task_config")}catch(t){throw v.error("Error getting all admin task configs:",t),new Error("Failed to retrieve admin task configurations")}})}static getConfigHistory(e){return et(this,null,function*(){try{const{data:t,error:r}=yield d.from("admin_task_config").select("*").eq("facility_id",e).order("updated_at",{ascending:!1});if(r)throw r;return(t||[]).map(i=>({id:i.id,config:this.mapDatabaseToConfig(i),updatedAt:new Date(i.updated_at),updatedBy:i.updated_by||"Unknown",changes:[]}))}catch(t){return v.error("Error getting configuration history:",t),[]}})}static hasConfig(e){return et(this,null,function*(){try{const{count:t,error:r}=yield d.from("admin_task_config").select("*",{count:"exact",head:!0}).eq("facility_id",e);if(r)throw r;return(t||0)>0}catch(t){return v.error("Error checking admin task config existence:",t),!1}})}}var qm=Object.defineProperty,zm=Object.defineProperties,Um=Object.getOwnPropertyDescriptors,Mo=Object.getOwnPropertySymbols,Fm=Object.prototype.hasOwnProperty,Lm=Object.prototype.propertyIsEnumerable,qo=(c,e,t)=>e in c?qm(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,pi=(c,e)=>{for(var t in e||(e={}))Fm.call(e,t)&&qo(c,t,e[t]);if(Mo)for(var t of Mo(e))Lm.call(e,t)&&qo(c,t,e[t]);return c},gi=(c,e)=>zm(c,Um(e)),yi=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Nm{getAdminTaskConfig(e){return yi(this,null,function*(){try{if(!e){const{FacilityService:t}=yield T(()=>Promise.resolve().then(()=>ge),void 0);e=yield t.getCurrentFacilityId()}return yield In.getConfig(e)}catch(t){return console.warn("Failed to get admin config from database, using default:",t),gn()}})}updateAdminTaskConfig(e,t){return yi(this,null,function*(){try{return yield In.updateConfig(e,t)}catch(r){throw console.error("Failed to update admin config:",r),r}})}resetToDefaults(e){return yi(this,null,function*(){const t=gn();return yield this.updateAdminTaskConfig(e,t)})}validateConfig(e){const t=[],r=[];if(e.maxTasksPerUser!==void 0&&(e.maxTasksPerUser<1&&t.push("Max tasks per user must be at least 1"),e.maxTasksPerUser>20&&r.push("Max tasks per user is very high, may impact user productivity")),e.priorityWeights){const i=e.priorityWeights;i.urgent!==void 0&&i.urgent<1&&t.push("Urgent priority weight must be at least 1"),i.high!==void 0&&i.high<1&&t.push("High priority weight must be at least 1"),i.medium!==void 0&&i.medium<1&&t.push("Medium priority weight must be at least 1"),i.low!==void 0&&i.low<1&&t.push("Low priority weight must be at least 1"),i.urgent&&i.high&&i.urgent<=i.high&&r.push("Urgent priority weight should be higher than high priority"),i.high&&i.medium&&i.high<=i.medium&&r.push("High priority weight should be higher than medium priority"),i.medium&&i.low&&i.medium<=i.low&&r.push("Medium priority weight should be higher than low priority")}if(e.rolePreferences&&Object.entries(e.rolePreferences).forEach(([i,a])=>{Array.isArray(a)?a.forEach(s=>{Gs(i,s)||r.push(`Role ${i} may not be compatible with category ${s}`)}):t.push(`Role preferences for ${i} must be an array`)}),e.timeConstraints){const i=e.timeConstraints;i.maxTaskDuration!==void 0&&i.maxTaskDuration<5&&t.push("Max task duration must be at least 5 minutes"),i.minTaskDuration!==void 0&&i.minTaskDuration<1&&t.push("Min task duration must be at least 1 minute"),i.maxTaskDuration&&i.minTaskDuration&&i.maxTaskDuration<=i.minTaskDuration&&t.push("Max task duration must be greater than min task duration")}return{isValid:t.length===0,errors:t,warnings:r}}getConfigurationRecommendations(e,t){const r=[];if(t&&(t.taskCompletionRate<.8&&r.push({category:"performance",title:"Low Task Completion Rate",description:`Current completion rate is ${(t.taskCompletionRate*100).toFixed(1)}%. Consider reducing max tasks per user or improving task assignment.`,priority:"high",suggestedValue:Math.max(1,e.maxTasksPerUser-1)}),t.averageTasksPerUser>e.maxTasksPerUser*.9&&r.push({category:"workload",title:"High User Workload",description:`Users are consistently at ${(t.averageTasksPerUser/e.maxTasksPerUser*100).toFixed(1)}% capacity. Consider increasing max tasks or adding more users.`,priority:"medium",suggestedValue:e.maxTasksPerUser+1}),t.averageTaskDuration>120&&r.push({category:"performance",title:"Long Task Duration",description:`Average task duration is ${t.averageTaskDuration} minutes. Consider breaking down complex tasks or adjusting time estimates.`,priority:"medium"})),e.priorityWeights){const i=e.priorityWeights;i.urgent&&i.high&&i.urgent<=i.high&&r.push({category:"priority",title:"Priority Weight Ordering",description:"Urgent priority weight should be higher than high priority to ensure proper task prioritization.",priority:"medium",suggestedValue:gi(pi({},i),{urgent:i.high+1})})}return(!e.rolePreferences||Object.keys(e.rolePreferences).length===0)&&r.push({category:"role",title:"Missing Role Preferences",description:"No role preferences configured. Consider setting up role-category mappings for better task assignment.",priority:"low",suggestedValue:{technician:["equipment","compliance"],operator:["operational","compliance"],cleaning_staff:["compliance"],inventory_manager:["operational"],supervisor:["safety","operational"]}}),r}getDefaultConfigForFacilityType(e){const t=gn();switch(e){case"small":return gi(pi({},t),{maxTasksPerUser:3,priorityWeights:{urgent:10,high:7,medium:4,low:1}});case"medium":return gi(pi({},t),{maxTasksPerUser:5,priorityWeights:{urgent:12,high:8,medium:5,low:2}});case"large":return gi(pi({},t),{maxTasksPerUser:7,priorityWeights:{urgent:15,high:10,medium:6,low:3}});default:return t}}exportConfig(e){return JSON.stringify(e,null,2)}importConfig(e){try{const t=JSON.parse(e),r=this.validateConfig(t);return{success:r.isValid,config:r.isValid?t:null,errors:r.errors}}catch(t){return{success:!1,config:null,errors:["Invalid JSON format"]}}}getConfigurationHistory(e){return yi(this,null,function*(){try{return yield In.getConfigHistory(e)}catch(t){return console.error("Failed to get configuration history:",t),[]}})}compareConfigurations(e,t){const r=[];return new Set([...Object.keys(e),...Object.keys(t)]).forEach(a=>{const s=e[a],o=t[a];s===void 0&&o!==void 0?r.push({field:a,oldValue:void 0,newValue:o,type:"added"}):s!==void 0&&o===void 0?r.push({field:a,oldValue:s,newValue:void 0,type:"removed"}):JSON.stringify(s)!==JSON.stringify(o)&&r.push({field:a,oldValue:s,newValue:o,type:"modified"})}),{changes:r,hasChanges:r.length>0}}getConfigurationSummary(e){var t;const r=e.priorityWeights?Object.keys(e.priorityWeights).length:0,i=e.rolePreferences?Object.keys(e.rolePreferences).length:0,a=!!e.timeConstraints,s=e.aiEnabled!==!1;let o="simple";return(r>2||i>3||a)&&(o="moderate"),(r>3||i>5||a&&((t=e.timeConstraints)!=null&&t.maxTaskDuration))&&(o="complex"),{maxTasksPerUser:e.maxTasksPerUser,priorityCount:r,rolePreferencesCount:i,timeConstraintsEnabled:a,aiEnabled:s,complexity:o}}}var Ji=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const xm=new lm,Bm=new mm,jm=new pm,Vm=new Nm;function Hm(c){return Ji(this,null,function*(){return xm.scanOperationalGaps(c)})}function Gm(c){return Ji(this,null,function*(){return jm.getFacilityUsers(c)})}function Wm(c){return Ji(this,null,function*(){return Vm.getAdminTaskConfig(c)})}function Km(c,e,t){return Ji(this,null,function*(){return Bm.assignTasksWithAI(c,e,t)})}var Mr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Qm{generateDailyTasks(e){return Mr(this,null,function*(){try{const t=yield Hm(e);if(t.length===0)return console.log("No operational gaps found for daily tasks"),[];const r=yield Gm(e),i=yield Wm(),a=yield Km(t,r,i);return yield Xd(a,e),a}catch(t){throw console.error("Error generating daily tasks:",t),new Error(`Failed to generate daily tasks: ${t instanceof Error?t.message:"Unknown error"}`)}})}getUserDailyTasks(e){return Mr(this,null,function*(){return Zd(e)})}getFacilityDailyTasks(e){return Mr(this,null,function*(){return eh(e)})}completeDailyTask(e,t){return Mr(this,null,function*(){return th(e,t)})}updateDailyTask(e,t){return Mr(this,null,function*(){try{const{data:{user:r}}=yield d.auth.getUser();if(!r)throw new Error("User not authenticated");const{data:i,error:a}=yield d.from("users").select("facility_id").eq("id",r.id).single();if(a||!(i!=null&&i.facility_id))throw new Error("User facility not found");const s={updated_at:new Date().toISOString()};t.title!==void 0&&(s.title=t.title),t.description!==void 0&&(s.description=t.description),t.category!==void 0&&(s.category=t.category),t.difficulty!==void 0&&(s.difficulty=t.difficulty),t.points!==void 0&&(s.points=t.points),t.timeEstimate!==void 0&&(s.time_estimate=t.timeEstimate),t.isCompleted!==void 0&&(s.is_completed=t.isCompleted);const{data:o,error:n}=yield d.from("home_challenges").update(s).eq("id",e).eq("facility_id",i.facility_id).select().single();if(n)throw new Error(`Failed to update task: ${n.message}`);return{id:o.id,title:o.title,description:o.description||"",category:o.category,difficulty:o.difficulty,points:o.points,timeEstimate:o.time_estimate,isCompleted:o.is_completed||!1,completedAt:o.completed_at||null,pointsEarned:o.points_earned||0,createdAt:o.created_at,updatedAt:o.updated_at}}catch(r){throw console.error("Error updating daily task:",r),r}})}}const N_=new Qm;var xe=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Ym{constructor(){this.baselineData=null,this.lastUpdate=0,this.UPDATE_INTERVAL=120*1e3,this.cachedMetrics=null}getAIImpactMetrics(){return xe(this,null,function*(){try{const e=Date.now();if(e-this.lastUpdate<this.UPDATE_INTERVAL)return this.getCachedMetrics();this.baselineData||(this.baselineData=yield this.getBaselineData());const t=yield this.calculateRealTimeMetrics();return this.cacheMetrics(t),this.lastUpdate=e,t}catch(e){return console.error("Error getting AI impact metrics:",e),this.getDefaultMetrics()}})}calculateRealTimeMetrics(){return xe(this,null,function*(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate());new Date(t.getTime()-t.getDay()*24*60*60*1e3);const r=new Date(e.getFullYear(),e.getMonth(),1),{FacilityService:i}=yield T(()=>Promise.resolve().then(()=>ge),void 0),a=yield i.getCurrentFacilityId(),{data:s}=yield d.from("ai_task_performance").select("*").eq("facility_id",a).gte("completed_at",r.toISOString()),{data:o}=yield d.from("ai_challenge_completions").select("*").eq("facility_id",a).gte("completed_at",r.toISOString()),n=yield this.calculateProactiveManagement(s||[],o||[]),{aiTimeSavingsService:l}=yield T(()=>Promise.resolve().then(()=>Bp),void 0),u=yield l.getAITimeSavings(),h={daily:u.daily_time_saved,weekly:Math.round(u.daily_time_saved*7),monthly:u.monthly_time_saved,total:u.monthly_time_saved,percentage:0},{aiCostCalculationService:f}=yield T(()=>Promise.resolve().then(()=>Jm),void 0),m=yield f.calculateCostSavings(h,s||[]),p=yield this.calculateEfficiencyGains(s||[]);return{timeSavings:h,proactiveManagement:n,costSavings:m,efficiencyGains:p,realTimeUpdates:{lastUpdated:new Date().toISOString(),nextUpdate:new Date(Date.now()+this.UPDATE_INTERVAL).toISOString(),dataFreshness:Math.floor((Date.now()-this.lastUpdate)/6e4)}}})}calculateTimeSavings(e,t,r,i){return xe(this,null,function*(){var a;const o=e.filter(g=>new Date(g.completed_at)>=t).reduce((g,_)=>g+(_.time_saved||0),0),l=e.filter(g=>new Date(g.completed_at)>=r).reduce((g,_)=>g+(_.time_saved||0),0),u=e.filter(g=>new Date(g.completed_at)>=i),h=u.reduce((g,_)=>g+(_.time_saved||0),0),f=e.reduce((g,_)=>g+(_.time_saved||0),0),m=((a=this.baselineData)==null?void 0:a.preAITaskDuration)||30,p=u.length>0?u.reduce((g,_)=>g+_.actual_duration,0)/u.length:m,y=m>0?Math.round((m-p)/m*100):0;return{daily:o,weekly:l,monthly:h,total:f,percentage:Math.max(0,Math.min(100,y))}})}calculateProactiveManagement(e,t){return xe(this,null,function*(){const r=new Date;r.setHours(r.getHours()+2);const i=e.filter(m=>new Date(m.completed_at)<r).length,a=e.filter(m=>m.estimated_duration&&m.actual_duration&&m.actual_duration<m.estimated_duration).length,s=e.length,o=e.filter(m=>m.estimated_duration&&m.actual_duration&&m.actual_duration<=m.estimated_duration).length,n=s>0?Math.round(o/s*100):100,l=e.filter(m=>m.difficulty==="high"||m.difficulty==="urgent").length,u=s>0?Math.round((s-l)/s*100):100,h=t.filter(m=>m.quality_score&&m.quality_score>=4).length,f=t.length>0?Math.round(h/t.length*100):100;return{issuesPrevented:i,earlyInterventions:a,complianceScore:n,riskMitigation:u,predictiveAccuracy:f}})}calculateEfficiencyGains(e){return xe(this,null,function*(){const t=e.length,r=e.filter(l=>l.completed_at).length,i=t>0?Math.round(r/t*100):100,a=e.length>0?e.reduce((l,u)=>l+(u.efficiency_score||0),0)/e.length:100,s=Math.round(a),o=yield this.calculateResourceOptimization(),n=yield this.calculateWorkflowStreamlining();return{taskCompletionRate:i,qualityImprovement:s,resourceOptimization:o,workflowStreamlining:n}})}calculateResourceOptimization(){return xe(this,null,function*(){try{const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ge),void 0),t=yield e.getCurrentFacilityId(),{data:r}=yield d.from("sterilization_cycles").select("tools").eq("facility_id",t).gte("created_at",new Date(Date.now()-10080*60*1e3).toISOString());if(!r||r.length===0)return 85;const a=r.reduce((n,l)=>{var u;return n+(((u=l.tools)==null?void 0:u.length)||0)},0)/r.length,s={min:6,max:8},o=a>=s.min&&a<=s.max?100:Math.max(0,100-Math.abs(a-7)*10);return Math.round(o)}catch(e){return console.error(e),console.error("Error calculating resource optimization"),85}})}calculateWorkflowStreamlining(){return xe(this,null,function*(){try{const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ge),void 0),t=yield e.getCurrentFacilityId(),{data:r}=yield d.from("home_daily_operations_tasks").select("estimated_duration, actual_duration").eq("facility_id",t).gte("created_at",new Date(Date.now()-10080*60*1e3).toISOString());if(!r||r.length===0)return 80;const i=r.map(s=>!s.estimated_duration||!s.actual_duration?100:Math.max(0,Math.min(100,s.estimated_duration/s.actual_duration*100))),a=i.reduce((s,o)=>s+o,0)/i.length;return Math.round(a)}catch(e){return console.error("Error calculating workflow streamlining:",e),80}})}getBaselineData(){return xe(this,null,function*(){try{return{preAITaskDuration:45,preAICompletionRate:75,preAIErrorRate:15,preAICostPerTask:33.75,implementationDate:"2024-01-01"}}catch(e){return console.error("Error getting baseline data:",e),{preAITaskDuration:45,preAICompletionRate:75,preAIErrorRate:15,preAICostPerTask:33.75,implementationDate:"2024-01-01"}}})}cacheMetrics(e){this.cachedMetrics=e}getCachedMetrics(){return this.cachedMetrics||this.getDefaultMetrics()}getDefaultMetrics(){return{timeSavings:{daily:0,weekly:0,monthly:0,total:0,percentage:0},proactiveManagement:{issuesPrevented:0,earlyInterventions:0,complianceScore:100,riskMitigation:100,predictiveAccuracy:100},costSavings:{daily:0,monthly:0,annual:0,roi:0},efficiencyGains:{taskCompletionRate:100,qualityImprovement:100,resourceOptimization:85,workflowStreamlining:80},realTimeUpdates:{lastUpdated:new Date().toISOString(),nextUpdate:new Date(Date.now()+this.UPDATE_INTERVAL).toISOString(),dataFreshness:0}}}getAIInsights(){return xe(this,null,function*(){try{const e=yield this.getAIImpactMetrics(),{aiReportingService:t}=yield T(()=>Promise.resolve().then(()=>Zm),void 0);return yield t.getAIInsights(e)}catch(e){return console.error("Error getting AI insights:",e),["AI system is actively monitoring facility operations"]}})}}const zo=new Ym;var zt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ac{calculateCostSavings(e,t){return zt(this,null,function*(){try{const r=yield this.getFacilityCosts(),i=this.calculateDirectTimeSavings(e,r.hourlyRate),a=yield this.calculateIndirectCostSavings(t,r),s=yield this.calculateErrorPreventionSavings(t,r),o=yield this.calculateComplianceSavings(),n=yield this.calculateResourceOptimizationSavings(),l=i.daily+a.daily+s.daily+o.daily+n.daily,u=i.monthly+a.monthly+s.monthly+o.monthly+n.monthly,h=1e4,f=u*12,m=h>0?f/h*100:0;return{daily:Math.round(l*100)/100,monthly:Math.round(u*100)/100,annual:Math.round(f*100)/100,roi:Math.round(m*100)/100}}catch(r){return console.error("Error calculating cost savings:",r),this.calculateBasicCostSavings(e)}})}getFacilityCosts(){return zt(this,null,function*(){try{const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ge),void 0),t=yield e.getCurrentFacilityId(),{data:r}=yield d.from("facilities").select("hourly_rate, type, staff_count").eq("id",t).single();return{hourlyRate:(r==null?void 0:r.hourly_rate)||45,facilityType:(r==null?void 0:r.facility_type)||"general",staffCount:(r==null?void 0:r.staff_count)||10}}catch(e){return console.error(e),{hourlyRate:45,facilityType:"general",staffCount:10}}})}calculateDirectTimeSavings(e,t){return{daily:e.daily/60*t,monthly:e.monthly/60*t}}calculateIndirectCostSavings(e,t){return zt(this,null,function*(){const i=t.hourlyRate*t.staffCount*.3*.5,a=i*22;return{daily:i,monthly:a}})}calculateErrorPreventionSavings(e,t){return zt(this,null,function*(){try{const{FacilityService:r}=yield T(()=>Promise.resolve().then(()=>ge),void 0),i=yield r.getCurrentFacilityId(),{data:a}=yield d.from("quality_incidents").select("cost_impact, severity").eq("facility_id",i).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString());if(!a||a.length===0){const n=t.facilityType==="dental"?150:200;return{daily:n*.1,monthly:n*2}}const o=a.reduce((n,l)=>n+(l.cost_impact||0),0)*.4;return{daily:o/30,monthly:o}}catch(r){console.error(r);const i=200;return{daily:i*.1,monthly:i*2}}})}calculateComplianceSavings(){return zt(this,null,function*(){return{daily:600/30,monthly:600}})}calculateResourceOptimizationSavings(){return zt(this,null,function*(){try{const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ge),void 0),t=yield e.getCurrentFacilityId(),{data:r}=yield d.from("inventory_items").select("unit_cost, quantity, reorder_point").eq("facility_id",t),{data:i}=yield d.from("sterilization_cycles").select("tools, cycle_time").eq("facility_id",t).gte("created_at",new Date(Date.now()-10080*60*1e3).toISOString()),a=(r==null?void 0:r.filter(l=>l.quantity<l.reorder_point))||[],s=a?a.reduce((l,u)=>l+u.unit_cost*.1,0):100,o=i?i.reduce((l,u)=>l+u.cycle_time*.15,0):50,n=s+o;return{daily:n/30,monthly:n}}catch(e){return console.error(e),{daily:5,monthly:150}}})}calculateBasicCostSavings(e){const r=e.daily/60*45,i=e.monthly/60*45,a=i*12;return{daily:Math.round(r*100)/100,monthly:Math.round(i*100)/100,annual:Math.round(a*100)/100,roi:0}}}const oc=new ac,Jm=Object.freeze(Object.defineProperty({__proto__:null,AICostCalculationService:ac,aiCostCalculationService:oc},Symbol.toStringTag,{value:"Module"}));var Xm=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class sc{getAIInsights(e){return Xm(this,null,function*(){try{const t=[];return e.timeSavings.daily>120&&t.push(`ðŸš€ AI saved ${Math.round(e.timeSavings.daily/60)} hours today!`),e.costSavings.monthly>1e3&&t.push(`ðŸ’° AI generated $${e.costSavings.monthly} in monthly savings`),e.proactiveManagement.issuesPrevented>5&&t.push(`ðŸ›¡ï¸ AI prevented ${e.proactiveManagement.issuesPrevented} potential issues this week`),e.costSavings.roi>50&&t.push(`ðŸ“ˆ AI ROI: ${e.costSavings.roi}% - Excellent investment!`),t}catch(t){return console.error("Error getting AI insights:",t),["AI system is actively monitoring facility operations"]}})}generateAIImpactReport(e){return`
AI Impact Report - ${new Date().toLocaleDateString()}
================================================

TIME SAVINGS
------------
Daily: ${Math.round(e.timeSavings.daily/60)} hours (${Math.round(e.timeSavings.daily)} minutes)
Weekly: ${Math.round(e.timeSavings.weekly/60)} hours (${Math.round(e.timeSavings.weekly)} minutes)
Monthly: ${Math.round(e.timeSavings.monthly/60)} hours (${Math.round(e.timeSavings.monthly)} minutes)
Total: ${Math.round(e.timeSavings.total/60)} hours (${Math.round(e.timeSavings.total)} minutes)
Improvement: ${e.timeSavings.percentage}%

PROACTIVE MANAGEMENT
-------------------
Issues Prevented: ${e.proactiveManagement.issuesPrevented}
Early Interventions: ${e.proactiveManagement.earlyInterventions}
Compliance Score: ${e.proactiveManagement.complianceScore}%
Risk Mitigation: ${e.proactiveManagement.riskMitigation}%
Predictive Accuracy: ${e.proactiveManagement.predictiveAccuracy}%

COST SAVINGS
------------
Daily: $${e.costSavings.daily}
Monthly: $${e.costSavings.monthly}
Annual: $${e.costSavings.annual}
ROI: ${e.costSavings.roi}%

EFFICIENCY GAINS
----------------
Task Completion Rate: ${e.efficiencyGains.taskCompletionRate}%
Quality Improvement: ${e.efficiencyGains.qualityImprovement}%
Resource Optimization: ${e.efficiencyGains.resourceOptimization}%
Workflow Streamlining: ${e.efficiencyGains.workflowStreamlining}%

REAL-TIME UPDATES
-----------------
Last Updated: ${new Date(e.realTimeUpdates.lastUpdated).toLocaleString()}
Next Update: ${new Date(e.realTimeUpdates.nextUpdate).toLocaleString()}
Data Freshness: ${e.realTimeUpdates.dataFreshness} minutes
`.trim()}generateExecutiveSummary(e){return`
AI Implementation Executive Summary
==================================

KEY HIGHLIGHTS
--------------
â€¢ AI has saved ${Math.round(e.timeSavings.monthly/60)} hours this month
â€¢ Generated $${e.costSavings.monthly} in monthly cost savings
â€¢ Achieved ${e.costSavings.roi}% ROI on AI investment
â€¢ Prevented ${e.proactiveManagement.issuesPrevented} potential issues

PERFORMANCE METRICS
-------------------
â€¢ Time Efficiency: ${e.timeSavings.percentage}% improvement
â€¢ Cost Reduction: $${e.costSavings.annual} annual savings
â€¢ Compliance: ${e.proactiveManagement.complianceScore}% score
â€¢ Quality: ${e.efficiencyGains.qualityImprovement}% improvement

RECOMMENDATIONS
---------------
â€¢ Continue AI implementation across all departments
â€¢ Monitor ROI trends for investment decisions
â€¢ Expand proactive management capabilities
â€¢ Leverage efficiency gains for strategic planning

Generated: ${new Date().toLocaleString()}
`.trim()}generatePerformanceBreakdown(e){return{timeAnalysis:{dailyBreakdown:{hours:Math.round(e.timeSavings.daily/60),minutes:Math.round(e.timeSavings.daily),percentage:e.timeSavings.percentage},weeklyBreakdown:{hours:Math.round(e.timeSavings.weekly/60),minutes:Math.round(e.timeSavings.weekly)},monthlyBreakdown:{hours:Math.round(e.timeSavings.monthly/60),minutes:Math.round(e.timeSavings.monthly)}},costAnalysis:{savings:{daily:e.costSavings.daily,monthly:e.costSavings.monthly,annual:e.costSavings.annual},roi:e.costSavings.roi,investment:1e4},efficiencyAnalysis:{completion:e.efficiencyGains.taskCompletionRate,quality:e.efficiencyGains.qualityImprovement,resources:e.efficiencyGains.resourceOptimization,workflow:e.efficiencyGains.workflowStreamlining},proactiveAnalysis:{issues:e.proactiveManagement.issuesPrevented,interventions:e.proactiveManagement.earlyInterventions,compliance:e.proactiveManagement.complianceScore,risk:e.proactiveManagement.riskMitigation,accuracy:e.proactiveManagement.predictiveAccuracy},metadata:{generated:new Date().toISOString(),lastUpdated:e.realTimeUpdates.lastUpdated,nextUpdate:e.realTimeUpdates.nextUpdate,dataFreshness:e.realTimeUpdates.dataFreshness}}}}const Ui=new sc,Zm=Object.freeze(Object.defineProperty({__proto__:null,AIReportingService:sc,aiReportingService:Ui},Symbol.toStringTag,{value:"Module"}));var Sn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class cc{getAIImpactMetrics(){return Sn(this,null,function*(){return yield zo.getAIImpactMetrics()})}getAIInsights(){return Sn(this,null,function*(){return yield zo.getAIInsights()})}generateAIImpactReport(e){return Ui.generateAIImpactReport(e)}generateExecutiveSummary(e){return Ui.generateExecutiveSummary(e)}generatePerformanceBreakdown(e){return Ui.generatePerformanceBreakdown(e)}calculateCostSavings(e,t){return Sn(this,null,function*(){return yield oc.calculateCostSavings(e,t)})}}const lc=new cc,ep=Object.freeze(Object.defineProperty({__proto__:null,AIImpactMeasurementService:cc,aiImpactMeasurementService:lc},Symbol.toStringTag,{value:"Module"}));var qr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class tp{constructor(){this.cache=null,this.CACHE_DURATION=1440*60*1e3,this.lastLogTime=0}fetchAndCacheMetricsOnLogin(){return qr(this,null,function*(){try{v.debug("PerformanceMetricsCache: Fetching metrics on login...");const{homeMetricsService:e}=yield T(()=>Promise.resolve().then(()=>eg),void 0),{homeSterilizationIntegration:t}=yield T(()=>Promise.resolve().then(()=>ig),void 0),{homeIntegrationService:r}=yield T(()=>Promise.resolve().then(()=>og),void 0),{FacilityService:i}=yield T(()=>Promise.resolve().then(()=>ge),void 0),a=yield i.getCurrentFacilityId();if(!a)return v.debug("PerformanceMetricsCache: No facility ID, skipping cache"),null;const[s,o,n,l]=yield Promise.allSettled([e.getHomeMetrics(),t.getSterilizationMetrics(),r.getAllMetrics(),T(()=>Promise.resolve().then(()=>ep),void 0).then(f=>f.aiImpactMeasurementService.getAIImpactMetrics())]),u=Date.now();u-this.lastLogTime>1e3&&(v.debug("ðŸ” PerformanceMetricsCache: AI Metrics result:",s),v.debug("ðŸ” PerformanceMetricsCache: Sterilization result:",o),v.debug("ðŸ” PerformanceMetricsCache: Integration result:",n),v.debug("ðŸ” PerformanceMetricsCache: AI Impact result:",l),this.lastLogTime=u);const h={aiMetrics:s.status==="fulfilled"?s.value:null,sterilizationMetrics:o.status==="fulfilled"?o.value:null,integrationMetrics:n.status==="fulfilled"?n.value:null,aiImpactMetrics:l.status==="fulfilled"?l.value:null,timestamp:Date.now(),facilityId:a};this.cache=h;try{localStorage.setItem("performanceMetricsCache",JSON.stringify(h))}catch(f){v.debug("PerformanceMetricsCache: Could not store in localStorage")}return u-this.lastLogTime>1e3&&(v.debug("PerformanceMetricsCache: Metrics cached successfully for facility:",a),this.lastLogTime=u),h}catch(e){return console.error("PerformanceMetricsCache: Error fetching metrics on login:",e),null}})}getCachedMetrics(){return qr(this,null,function*(){if(this.cache&&(yield this.isCacheValid(this.cache)))return this.cache;try{const e=localStorage.getItem("performanceMetricsCache");if(e){const t=JSON.parse(e);if(yield this.isCacheValid(t))return this.cache=t,t}}catch(e){v.debug("PerformanceMetricsCache: Could not read from localStorage:",e)}return null})}refreshMetrics(){return qr(this,null,function*(){return v.debug("PerformanceMetricsCache: Manual refresh requested"),this.cache=null,localStorage.removeItem("performanceMetricsCache"),yield this.fetchAndCacheMetricsOnLogin()})}isCacheValid(e){return qr(this,null,function*(){const r=Date.now()-e.timestamp;if(r>this.CACHE_DURATION)return v.debug("PerformanceMetricsCache: Cache expired (age:",r,"ms)"),!1;try{if((yield kt.getCurrentFacilityId())!==e.facilityId)return v.debug("PerformanceMetricsCache: Facility changed, cache invalid"),!1}catch(i){}return!0})}clearCache(){this.cache=null,localStorage.removeItem("performanceMetricsCache"),v.debug("PerformanceMetricsCache: Cache cleared")}getCacheStatus(){return qr(this,null,function*(){const e=yield this.getCachedMetrics();return e?{hasCache:!0,age:Date.now()-e.timestamp,facilityId:e.facilityId}:{hasCache:!1}})}}const x_=new tp;var _i=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class uc{constructor(){this.CACHE_DURATION=300,this.FACILITY_KEY_PREFIX="facility",this.cache=new Ls("facility")}getFacility(e){return _i(this,null,function*(){try{const t=`${this.FACILITY_KEY_PREFIX}:${e}`,r=yield this.cache.get(t);return r&&this.isCacheValid(r)?(j()&&Math.random()<.1&&v.debug(`Facility cache hit for ID: ${e}`),r.facility):(r&&(yield this.cache.del(t)),null)}catch(t){return v.error("Error getting facility from cache:",t),null}})}setFacility(e,t){return _i(this,null,function*(){try{const r=`${this.FACILITY_KEY_PREFIX}:${e}`,i={facility:t,timestamp:Date.now()};yield this.cache.set(r,i,{ttl:this.CACHE_DURATION}),j()&&Math.random()<.1&&v.debug(`Facility cached for ID: ${e}`)}catch(r){v.error("Error setting facility in cache:",r)}})}invalidateFacility(e){return _i(this,null,function*(){try{const t=`${this.FACILITY_KEY_PREFIX}:${e}`;yield this.cache.del(t),v.debug(`Facility cache invalidated for ID: ${e}`)}catch(t){v.error("Error invalidating facility cache:",t)}})}clearAll(){return _i(this,null,function*(){try{yield this.cache.clear(),v.info("All facility cache cleared")}catch(e){v.error("Error clearing facility cache:",e)}})}isCacheValid(e){return Date.now()-e.timestamp<this.CACHE_DURATION*1e3}getStats(){return this.cache.getStats()}cleanup(){this.cache.cleanup()}}const rp=new uc,Uo=Object.freeze(Object.defineProperty({__proto__:null,DistributedFacilityCache:uc,distributedFacilityCache:rp},Symbol.toStringTag,{value:"Module"}));var tt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ip{static signIn(e){return tt(this,arguments,function*({email:t,password:r}){try{const{data:i,error:a}=yield d.auth.signInWithPassword({email:t,password:r});if(a)throw a;if(i&&i.user&&i.user.id){const{data:s,error:o}=yield d.from("users").select("*").eq("id",i.user.id).single();return o&&console.warn("Failed to fetch user profile:",o),{user:s,session:i.session,error:null}}return{user:null,session:null,error:"No user data received"}}catch(i){return{user:null,session:null,error:Ve(i).message}}})}static signUp(e){return tt(this,arguments,function*({email:t,password:r,fullName:i,role:a="user"}){try{const{data:s,error:o}=yield d.auth.signUp({email:t,password:r,options:{data:{full_name:i,role:a}}});if(o)throw o;if(s.user){const n=i.trim().split(" "),l=n[0]||"",u=n.slice(1).join(" ")||"",h={id:s.user.id,email:s.user.email,first_name:l,last_name:u,role:a,facility_id:null},{error:f}=yield d.from("users").insert(h);return f&&console.warn("Failed to create user profile:",f),{user:h,session:s.session,error:null}}return{user:null,session:null,error:"No user data received"}}catch(s){return{user:null,session:null,error:Ve(s).message}}})}static signOut(){return tt(this,null,function*(){try{const{error:e}=yield d.auth.signOut();if(e)throw e;return{error:null}}catch(e){return{error:Ve(e).message}}})}static getCurrentUser(){return tt(this,null,function*(){try{const{data:{user:e},error:t}=yield d.auth.getUser();if(t)throw t;if(!e)return{user:null,session:null,error:null};const{data:{session:r}}=yield d.auth.getSession();if(!r)return{user:null,session:null,error:"No active session"};const{data:i,error:a}=yield d.from("users").select("*").eq("id",e.id).single();return a&&console.warn("Failed to fetch user profile:",a),{user:i,session:null,error:null}}catch(e){return{user:null,session:null,error:Ve(e).message}}})}static getSession(){return tt(this,null,function*(){try{const{data:{session:e},error:t}=yield d.auth.getSession();if(t)throw t;return{session:e,error:null}}catch(e){return{session:null,error:Ve(e).message}}})}static updateProfile(e,t){return tt(this,null,function*(){try{const{data:r,error:i}=yield d.from("users").update(t).eq("id",e).select().single();if(i)throw i;return{user:r,error:null}}catch(r){return{user:null,error:Ve(r).message}}})}static resetPassword(e){return tt(this,null,function*(){try{const{error:t}=yield d.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/reset-password`});if(t)throw t;return{error:null}}catch(t){return{error:Ve(t).message}}})}static updatePassword(e){return tt(this,null,function*(){try{const{error:t}=yield d.auth.updateUser({password:e});if(t)throw t;return{error:null}}catch(t){return{error:Ve(t).message}}})}static onAuthStateChange(e){return d.auth.onAuthStateChange((t,r)=>{e(t,r)})}}const B_=Object.freeze(Object.defineProperty({__proto__:null,SupabaseAuthService:ip},Symbol.toStringTag,{value:"Module"})),vi=c=>typeof c=="object"&&c!==null&&"id"in c&&typeof c.id=="string",zr=c=>typeof c=="object"&&c!==null&&("data"in c||"error"in c),np=c=>typeof c=="object"&&c!==null&&"eventType"in c&&"table"in c&&typeof c.table=="string";var ap=Object.defineProperty,op=Object.defineProperties,sp=Object.getOwnPropertyDescriptors,Fo=Object.getOwnPropertySymbols,cp=Object.prototype.hasOwnProperty,lp=Object.prototype.propertyIsEnumerable,Lo=(c,e,t)=>e in c?ap(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,up=(c,e)=>{for(var t in e||(e={}))cp.call(e,t)&&Lo(c,t,e[t]);if(Fo)for(var t of Fo(e))lp.call(e,t)&&Lo(c,t,e[t]);return c},dp=(c,e)=>op(c,sp(e)),Ur=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class dc{constructor(){this.tableName="inventory_items"}getAllItems(e){return Ur(this,null,function*(){var t,r,i,a;try{const{data:{user:s},error:o}=yield d.auth.getUser();let n=null;!o&&s&&(n=((t=s.user_metadata)==null?void 0:t.facility_id)||null);const l=d.from(this.tableName).select((e==null?void 0:e.select)||"*").order(((r=e==null?void 0:e.orderBy)==null?void 0:r.column)||"created_at",{ascending:(a=(i=e==null?void 0:e.orderBy)==null?void 0:i.ascending)!=null?a:!1});n&&l.eq("facility_id",n),e!=null&&e.limit&&l.limit(e.limit),e!=null&&e.offset&&l.range(e.offset,e.offset+(e.limit||10)-1),e!=null&&e.filters&&Object.entries(e.filters).forEach(([p,y])=>{y!=null&&(p==="location"?l.ilike("scanned_location",`%${y}%`):l.eq(p,y))});const u=yield l;if(!zr(u))return{success:!1,error:"Invalid response format from Supabase",processedCount:0,errorCount:1};if(u.error)return{success:!1,error:u.error.message,processedCount:0,errorCount:1};const h=u.data||[],f=[];let m=0;for(const p of h)if(vi(p)){const y=this.transformRowToInventoryItem(p);y.success&&y.data?f.push(y.data):m++}else m++;return{success:!0,data:f,processedCount:f.length,errorCount:m}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Unknown error occurred",processedCount:0,errorCount:1}}})}getItemById(e){return Ur(this,null,function*(){var t;try{const{data:{user:r},error:i}=yield d.auth.getUser();let a=null;!i&&r&&(a=((t=r.user_metadata)==null?void 0:t.facility_id)||null);const s=d.from(this.tableName).select("*").eq("id",e);a&&s.eq("facility_id",a);const o=yield s.single();if(!zr(o))return{success:!1,error:"Invalid response format from Supabase"};if(o.error)return{success:!1,error:o.error.message};const n=o.data;return!n||!vi(n)?{success:!1,error:"Item not found or invalid format"}:this.transformRowToInventoryItem(n)}catch(r){return{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}})}createItem(e){return Ur(this,null,function*(){var t;try{const{data:{user:r},error:i}=yield d.auth.getUser();let a=null;!i&&r&&(a=((t=r.user_metadata)==null?void 0:t.facility_id)||null);const s=dp(up({},e),{facility_id:a||e.facility_id}),o=yield d.from(this.tableName).insert([s]).select().single();if(!zr(o))return{success:!1,error:"Invalid response format from Supabase"};if(o.error)return{success:!1,error:o.error.message};const n=o.data;return!n||!vi(n)?{success:!1,error:"Failed to create item or invalid response format"}:this.transformRowToInventoryItem(n)}catch(r){return{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}})}updateItem(e,t){return Ur(this,null,function*(){var r;try{const{data:{user:i},error:a}=yield d.auth.getUser();let s=null;!a&&i&&(s=((r=i.user_metadata)==null?void 0:r.facility_id)||null);const o=d.from(this.tableName).update(t).eq("id",e);s&&o.eq("facility_id",s);const n=yield o.select().single();if(!zr(n))return{success:!1,error:"Invalid response format from Supabase"};if(n.error)return{success:!1,error:n.error.message};const l=n.data;return!l||!vi(l)?{success:!1,error:"Item not found or invalid response format"}:this.transformRowToInventoryItem(l)}catch(i){return{success:!1,error:i instanceof Error?i.message:"Unknown error occurred"}}})}deleteItem(e){return Ur(this,null,function*(){var t;try{const{data:{user:r},error:i}=yield d.auth.getUser();let a=null;!i&&r&&(a=((t=r.user_metadata)==null?void 0:t.facility_id)||null);const s=d.from(this.tableName).delete().eq("id",e);a&&s.eq("facility_id",a);const o=yield s;return zr(o)?o.error?{success:!1,error:o.error.message}:{success:!0}:{success:!1,error:"Invalid response format from Supabase"}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}})}subscribeToChanges(e,t){const r=d.channel("inventory_changes").on("postgres_changes",{event:(t==null?void 0:t.event)||"*",schema:(t==null?void 0:t.schema)||"public",table:(t==null?void 0:t.table)||this.tableName,filter:t==null?void 0:t.filter},i=>{np(i)?e(i):console.warn("Received invalid realtime payload:",i)}).subscribe();return()=>{d.removeChannel(r)}}transformRowToInventoryItem(e){try{return{success:!0,data:{id:e.id,facility_id:e.facility_id,name:e.name,quantity:e.quantity,data:e.data,created_at:e.created_at,updated_at:e.updated_at,reorder_level:e.reorder_level,reorder_point:e.reorder_point,status:e.status,expiration_date:e.expiration_date,unit_cost:e.unit_cost,category:e.category,archived:e.archived,archived_at:e.archived_at,archived_by:e.archived_by,archive_reason:e.archive_reason}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to transform row to inventory item"}}}transformInventoryItemToRow(e){return{facility_id:e.facility_id,name:e.name,quantity:e.quantity,data:e.data,reorder_level:e.reorder_level,reorder_point:e.reorder_point,status:e.status,expiration_date:e.expiration_date,unit_cost:e.unit_cost,category:e.category}}}const hp=Object.freeze(Object.defineProperty({__proto__:null,TypedSupabaseAdapter:dc},Symbol.toStringTag,{value:"Module"}));class hc{static transformFromSupabase(e){var t,r,i;const a=e.data||{},s=e.category||a.category||"unknown",o=pe("NODE_ENV")==="development"||pe("MODE")==="development",n=pe("VITE_DEBUG_INVENTORY")==="true";return o&&n&&console.debug("Transforming inventory item:",e),{id:e.id,name:e.name,category:s,location:"",status:"active",updated_at:e.updated_at,quantity:e.quantity,unit_cost:e.unit_cost,reorder_point:e.reorder_point||0,expiration_date:e.expiration_date||"",created_at:e.created_at,facility_id:e.facility_id||"",data:{description:a.description||"",barcode:a.barcode||"",warranty:a.warranty||"",serialNumber:a.serialNumber||"",manufacturer:a.manufacturer||"",lastServiced:a.lastServiced||"",unit:a.unit||"",supplier:a.supplier||"",notes:a.notes||"",tags:a.tags||[],imageUrl:a.imageUrl||"",isActive:(t=a.isActive)!=null?t:!0,tracked:(r=a.tracked)!=null?r:!0,favorite:(i=a.favorite)!=null?i:!1,purchaseDate:a.purchaseDate||"",createdAt:a.createdAt||"",updatedAt:a.updatedAt||"",currentPhase:a.currentPhase||"",sku:a.sku||"",p2Status:a.p2Status||"",toolId:a.toolId||"",supplyId:a.supplyId||"",equipmentId:a.equipmentId||"",hardwareId:a.hardwareId||"",serviceProvider:a.serviceProvider||"",assignedTo:a.assignedTo||""}}}static transformToSupabase(e){const t={name:e.name,category:e.category,quantity:e.quantity||0,unit_cost:e.unit_cost||0,status:e.status||"active"};return e.facility_id&&(t.facility_id=e.facility_id),e.data&&typeof e.data=="object"&&e.data!==null&&"description"in e.data&&typeof e.data.description=="string"&&(t.description=e.data.description),e.location&&(t.location=e.location),e.data&&typeof e.data=="object"&&e.data!==null&&"sku"in e.data&&typeof e.data.sku=="string"&&(t.sku=e.data.sku),e.data&&typeof e.data=="object"&&e.data!==null&&"barcode"in e.data&&typeof e.data.barcode=="string"&&(t.barcode=e.data.barcode),e.data&&typeof e.data=="object"&&e.data!==null&&"manufacturer"in e.data&&typeof e.data.manufacturer=="string"&&(t.manufacturer=e.data.manufacturer),e.data&&typeof e.data=="object"&&e.data!==null&&"serialNumber"in e.data&&typeof e.data.serialNumber=="string"&&(t.serial_number=e.data.serialNumber),e.data&&typeof e.data=="object"&&e.data!==null&&"expiration"in e.data&&typeof e.data.expiration=="string"&&(t.expiration_date=e.data.expiration),e.data&&typeof e.data=="object"&&e.data!==null&&"unit"in e.data&&typeof e.data.unit=="string"&&(t.unit_of_measure=e.data.unit),e.reorder_point!==void 0&&(t.reorder_point=e.reorder_point),e.data&&typeof e.data=="object"&&e.data!==null&&"createdAt"in e.data&&typeof e.data.createdAt=="string"&&(t.created_at=e.data.createdAt),e.data&&typeof e.data=="object"&&e.data!==null&&"updatedAt"in e.data&&typeof e.data.updatedAt=="string"&&(t.updated_at=e.data.updatedAt),t}}class Xi{static transformForModal(e){return e.map(t=>{var r,i;return{id:t.id||"",name:t.name||"",barcode:((r=t.data)==null?void 0:r.barcode)||t.id||"",currentPhase:t.status||((i=t.data)==null?void 0:i.currentPhase)||"Unknown",category:t.category||""}})}static transformForTable(e){return e.map(t=>{var r,i,a,s;return{id:t.id||"",name:t.name||"",category:t.category||"",location:t.location||"",status:t.status||((r=t.data)==null?void 0:r.currentPhase)||"Unknown",tracked:((i=t.data)==null?void 0:i.tracked)||!1,favorite:((a=t.data)==null?void 0:a.favorite)||!1,lastUpdated:((s=t.data)==null?void 0:s.updatedAt)||""}})}static transformForExport(e){return e.map(t=>{var r,i,a,s,o,n,l,u,h,f,m,p;return{ID:t.id||"",Name:t.name||"",Category:t.category||"",Location:t.location||"",Status:t.status||((r=t.data)==null?void 0:r.currentPhase)||"",Quantity:String(t.quantity||0),Cost:String(t.unit_cost||0),Barcode:((i=t.data)==null?void 0:i.barcode)||"",SerialNumber:((a=t.data)==null?void 0:a.serialNumber)||"",Manufacturer:((s=t.data)==null?void 0:s.manufacturer)||"",SKU:((o=t.data)==null?void 0:o.sku)||"",Description:((n=t.data)==null?void 0:n.description)||"",Warranty:((l=t.data)==null?void 0:l.warranty)||"",LastServiced:((u=t.data)==null?void 0:u.lastServiced)||"",Notes:((h=t.data)==null?void 0:h.notes)||"",Tags:Array.isArray((f=t.data)==null?void 0:f.tags)?t.data.tags.join(", "):"",CreatedAt:((m=t.data)==null?void 0:m.createdAt)||"",UpdatedAt:((p=t.data)==null?void 0:p.updatedAt)||""}})}static transformForSearch(e){return e.map(t=>{var r,i,a;return{id:t.id,name:t.name||"",category:t.category||"",location:t.location||"",status:t.status||((r=t.data)==null?void 0:r.currentPhase)||"",quantity:t.quantity||0,unit_cost:t.unit_cost||0,barcode:((i=t.data)==null?void 0:i.barcode)||void 0,description:(a=t.data)==null?void 0:a.description}})}}var fp=Object.defineProperty,mp=Object.defineProperties,pp=Object.getOwnPropertyDescriptors,No=Object.getOwnPropertySymbols,gp=Object.prototype.hasOwnProperty,yp=Object.prototype.propertyIsEnumerable,xo=(c,e,t)=>e in c?fp(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,wi=(c,e)=>{for(var t in e||(e={}))gp.call(e,t)&&xo(c,t,e[t]);if(No)for(var t of No(e))yp.call(e,t)&&xo(c,t,e[t]);return c},Ii=(c,e)=>mp(c,pp(e));class gr{static createNewItem(e){const t=new Date().toISOString(),r=i=>e.data&&typeof e.data=="object"&&e.data!==null&&i in e.data&&typeof e.data[i]=="string"?e.data[i]:"";return{id:"",facility_id:e.facility_id||"",name:e.name||"",quantity:e.quantity||0,data:{description:r("description"),barcode:r("barcode"),warranty:r("warranty"),serialNumber:r("serialNumber"),manufacturer:r("manufacturer"),lastServiced:r("lastServiced"),unit:r("unit"),supplier:r("supplier"),notes:r("notes"),tags:[],imageUrl:"",isActive:!0,tracked:!0,favorite:!1,purchaseDate:"",createdAt:t,updatedAt:t,currentPhase:"Active",sku:"",p2Status:"",toolId:"",supplyId:"",equipmentId:"",hardwareId:"",serviceProvider:"",assignedTo:""},created_at:t,updated_at:t,reorder_point:e.reorder_point||0,expiration_date:e.expiration_date||"",unit_cost:e.unit_cost||0,category:e.category||"",status:e.status||"Active",location:e.location||"",supplier:e.supplier||"",cost:e.cost||0,vendor:e.vendor||"",warranty:e.warranty||"",maintenance_schedule:e.maintenance_schedule||"",next_due:e.next_due||"",service_provider:e.service_provider||"",assigned_to:e.assigned_to||"",notes:e.notes||"",tool_id:e.tool_id||"",supply_id:e.supply_id||"",equipment_id:e.equipment_id||"",hardware_id:e.hardware_id||"",p2_status:e.p2_status||"",serial_number:e.serial_number||"",manufacturer:e.manufacturer||"",image_url:e.image_url||"",tags:e.tags||[],favorite:e.favorite||!1,tracked:e.tracked||!0,barcode:e.barcode||"",sku:e.sku||"",description:e.description||"",current_phase:e.current_phase||"Active",is_active:e.is_active||!0,unit:e.unit||"",expiration:e.expiration||"",purchase_date:e.purchase_date||"",last_serviced:e.last_serviced||"",last_updated:t}}static updateItemWithTimestamp(e){const t=new Date().toISOString();return Ii(wi({},e),{data:Ii(wi({},e.data&&typeof e.data=="object"&&e.data!==null?e.data:{}),{lastUpdated:t,updatedAt:t})})}static normalizeItemName(e){return e?e.trim().replace(/\s+/g," ").split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" "):""}static normalizeCategory(e){return e?e.trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""):""}static transformInventoryItem(e){var t;const r=this.normalizeItemName(e.name||""),i=this.normalizeCategory(e.category||""),a=(t=e.data)!=null&&t.expiration?new Date(e.data.expiration):null,s=new Date,o=a?a<s:!1,n=a?Math.ceil((a.getTime()-s.getTime())/(1e3*60*60*24)):null;return Ii(wi({},e),{normalizedName:r,normalizedCategory:i,quantityInStock:e.quantity||0,isExpired:o,daysUntilExpiry:n})}static transformInventoryBatch(e){return e.map(t=>Ii(wi({},t),{normalizedName:this.normalizeItemName(t.name||""),normalizedCategory:this.normalizeCategory(t.category||"")}))}}class fc{static transformToCSV(e){if(e.length===0)return"";const t=["Name","Quantity","Category","Status","Expiry Date"],r=e.map(a=>{var s;return[a.name,(a.quantity||1).toString(),a.category,a.status,((s=a.data)==null?void 0:s.expiration)||""]});return[t,...r].map(a=>a.map(s=>`"${s}"`).join(",")).join(`
`)}static transformFromCSV(e){const t=e.trim().split(`
`);if(t.length<2)return[];const r=t[0].split(",").map(a=>a.replace(/"/g,"").trim());return t.slice(1).map(a=>{const s=a.split(",").map(n=>n.replace(/"/g,"").trim()),o={};return r.forEach((n,l)=>{o[n.toLowerCase().replace(/\s+/g,"")]=s[l]||""}),{id:Date.now().toString()+Math.random().toString(36).substr(2,9),name:o.name||"",category:o.category||"",status:o.status||"active",quantity:parseInt(o.quantity)||1,unit_cost:0,reorder_point:0,expiration_date:o.expirydate||"",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),facility_id:"",location:"",data:{description:"",barcode:"",warranty:"",serialNumber:"",manufacturer:"",lastServiced:"",unit:"",supplier:"",notes:"",tags:[],imageUrl:"",isActive:!0,tracked:!1,favorite:!1,purchaseDate:"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),currentPhase:"Active",sku:"",p2Status:"",toolId:"",supplyId:"",equipmentId:"",hardwareId:"",serviceProvider:"",assignedTo:""}}})}}class mc{static transformForAPI(e){return e.map(t=>{var r,i,a,s,o,n,l,u,h,f,m,p,y,g,_,w,E,b,P,S,Y,J,B,Ae,Te;return{id:t.id,name:t.name,category:t.category,status:t.status,quantity:t.quantity,location:t.location,unit_cost:t.unit_cost,reorder_point:t.reorder_point,expiration_date:t.expiration_date,created_at:t.created_at,updated_at:t.updated_at,facility_id:t.facility_id,data:{description:(r=t.data)==null?void 0:r.description,barcode:((i=t.data)==null?void 0:i.barcode)||void 0,serialNumber:(a=t.data)==null?void 0:a.serialNumber,manufacturer:(s=t.data)==null?void 0:s.manufacturer,supplier:(o=t.data)==null?void 0:o.supplier,expiration:(n=t.data)==null?void 0:n.expiration,warranty:(l=t.data)==null?void 0:l.warranty,notes:(u=t.data)==null?void 0:u.notes,tags:(h=t.data)==null?void 0:h.tags,imageUrl:(f=t.data)==null?void 0:f.imageUrl,isActive:(m=t.data)==null?void 0:m.isActive,tracked:(p=t.data)==null?void 0:p.tracked,favorite:(y=t.data)==null?void 0:y.favorite,purchaseDate:(g=t.data)==null?void 0:g.purchaseDate,lastServiced:(_=t.data)==null?void 0:_.lastServiced,unit:(w=t.data)==null?void 0:w.unit,currentPhase:(E=t.data)==null?void 0:E.currentPhase,sku:(b=t.data)==null?void 0:b.sku,p2Status:(P=t.data)==null?void 0:P.p2Status,toolId:(S=t.data)==null?void 0:S.toolId,supplyId:(Y=t.data)==null?void 0:Y.supplyId,equipmentId:(J=t.data)==null?void 0:J.equipmentId,hardwareId:(B=t.data)==null?void 0:B.hardwareId,serviceProvider:(Ae=t.data)==null?void 0:Ae.serviceProvider,assignedTo:(Te=t.data)==null?void 0:Te.assignedTo}}})}static transformFromAPI(e){return e.map(t=>{var r,i,a,s,o,n,l,u,h,f,m,p,y,g,_,w,E,b,P,S,Y,J,B,Ae,Te,Wn,Kn;return{id:t.id,name:t.name,category:t.category,location:t.location,status:t.status,updated_at:t.updated_at,quantity:t.quantity,unit_cost:t.unit_cost,reorder_point:t.reorder_point,expiration_date:t.expiration_date,created_at:t.created_at,facility_id:t.facility_id,data:{description:(r=t.data)==null?void 0:r.description,barcode:(i=t.data)==null?void 0:i.barcode,warranty:(a=t.data)==null?void 0:a.warranty,serialNumber:(s=t.data)==null?void 0:s.serialNumber,expiration:(o=t.data)==null?void 0:o.expiration,manufacturer:(n=t.data)==null?void 0:n.manufacturer,lastServiced:(l=t.data)==null?void 0:l.lastServiced,unit:(u=t.data)==null?void 0:u.unit,supplier:(h=t.data)==null?void 0:h.supplier,notes:(f=t.data)==null?void 0:f.notes,tags:(m=t.data)==null?void 0:m.tags,imageUrl:(p=t.data)==null?void 0:p.imageUrl,isActive:(y=t.data)==null?void 0:y.isActive,tracked:(g=t.data)==null?void 0:g.tracked,favorite:(_=t.data)==null?void 0:_.favorite,purchaseDate:(w=t.data)==null?void 0:w.purchaseDate,createdAt:(E=t.data)==null?void 0:E.createdAt,updatedAt:(b=t.data)==null?void 0:b.updatedAt,currentPhase:(P=t.data)==null?void 0:P.currentPhase,sku:(S=t.data)==null?void 0:S.sku,p2Status:(Y=t.data)==null?void 0:Y.p2Status,toolId:(J=t.data)==null?void 0:J.toolId,supplyId:(B=t.data)==null?void 0:B.supplyId,equipmentId:(Ae=t.data)==null?void 0:Ae.equipmentId,hardwareId:(Te=t.data)==null?void 0:Te.hardwareId,serviceProvider:(Wn=t.data)==null?void 0:Wn.serviceProvider,assignedTo:(Kn=t.data)==null?void 0:Kn.assignedTo}}})}}class U{}U.transformFromSupabase=hc.transformFromSupabase;U.transformToSupabase=hc.transformToSupabase;U.transformForModal=Xi.transformForModal;U.transformForTable=Xi.transformForTable;U.transformForExport=Xi.transformForExport;U.transformForSearch=Xi.transformForSearch;U.createNewItem=gr.createNewItem;U.updateItemWithTimestamp=gr.updateItemWithTimestamp;U.normalizeItemName=gr.normalizeItemName;U.normalizeCategory=gr.normalizeCategory;U.transformInventoryItem=gr.transformInventoryItem;U.transformInventoryBatch=gr.transformInventoryBatch;U.transformToCSV=fc.transformToCSV;U.transformFromCSV=fc.transformFromCSV;U.transformForAPI=mc.transformForAPI;U.transformFromAPI=mc.transformFromAPI;var _p=Object.defineProperty,Bo=Object.getOwnPropertySymbols,vp=Object.prototype.hasOwnProperty,wp=Object.prototype.propertyIsEnumerable,jo=(c,e,t)=>e in c?_p(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ip=(c,e)=>{for(var t in e||(e={}))vp.call(e,t)&&jo(c,t,e[t]);if(Bo)for(var t of Bo(e))wp.call(e,t)&&jo(c,t,e[t]);return c},$=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Sp{constructor(e){this.isInitialized=!1,this.lastError=null,this.lastSyncTime=null,this.pendingChanges=!1,this.cachedItems=null,this.cacheTimestamp=0,this.CACHE_DURATION=5e3,this.client=null,this.initPromise=null,this.getClient=()=>$(this,null,function*(){return this.client?this.client:(this.initPromise||(this.initPromise=$(this,null,function*(){const t=d,{error:r}=yield t.from("inventory_items").select("id").limit(1);return r?console.warn("SupabaseAdapter.ts:test âŒ Probe failed",r.message||r):console.log("Supabase client initialized successfully"),this.client=t,t})),this.initPromise)}),this.getAllItems=t=>$(this,null,function*(){const r=Date.now();if(this.cachedItems&&r-this.cacheTimestamp<this.CACHE_DURATION)return this.cachedItems;let i=t==null?void 0:t.facilityId;if(!i){const{FacilityService:s}=yield T(()=>Promise.resolve().then(()=>ge),void 0);i=yield s.getCurrentFacilityId()}const a=yield this.typedAdapter.getAllItems({filters:{facility_id:i}});if(!a.success||!a.data)throw console.warn("Failed to get inventory items:",a.error),new Error(a.error||"Failed to get inventory items");return this.cachedItems=a.data,this.cacheTimestamp=Date.now(),a.data}),this.config=e,this.typedAdapter=new dc}initialize(){return $(this,null,function*(){if(!this.isInitialized){if(!ht())throw new Error("Supabase is not properly configured");this.isInitialized=!0,this.testConnectionAsync()}})}testConnectionAsync(){return $(this,null,function*(){try{const e=yield q.getItems();e.error?console.warn("âš ï¸ Supabase connection test failed:",e.error):console.log("Supabase connection test passed")}catch(e){console.warn("âš ï¸ Supabase connection test failed:",e)}})}getItemsByCategory(e){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const t=yield this.typedAdapter.getAllItems({filters:{_category:e}});if(!t.success||!t.data)throw new Error(t.error||"Failed to get items by category");return t.data||[]}catch(t){throw new Error(`Failed to get items by category: ${t instanceof Error?t.message:"Unknown error"}`)}})}getFilteredItems(e,t){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const r=yield this.typedAdapter.getAllItems({filters:Ip({search:e},t)});if(!r.success||!r.data)throw new Error(r.error||"Failed to get filtered items");return r.data||[]}catch(r){throw new Error(`Failed to get filtered items: ${r instanceof Error?r.message:"Unknown error"}`)}})}getCategories(){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{return(yield q.getCategories())||[]}catch(e){throw new Error(`Failed to get categories: ${e instanceof Error?e.message:"Unknown error"}`)}})}fetchCategories(){return $(this,null,function*(){return this.getCategories()})}updateInventoryItem(e,t){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const r=U.transformToSupabase(t);return yield q.updateItem(e,r)}catch(r){throw new Error(`Failed to update inventory item: ${r instanceof Error?r.message:"Unknown error"}`)}})}deleteInventoryItem(e){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{yield q.deleteItem(e)}catch(t){throw new Error(`Failed to delete inventory item: ${t instanceof Error?t.message:"Unknown error"}`)}})}isConnected(){return this.isInitialized}getMetadata(){return{name:"Supabase Adapter",version:"1.0.0",description:"Supabase-based inventory data adapter",capabilities:{supportsRead:!0,supportsWrite:!0,supportsDelete:!0,supportsRealTime:!0,supportsOffline:!1,supportsBatch:!1},config:this.config}}fetchAllInventoryData(){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const e=yield this.getAllItems();return{data:e,error:null,count:e.length}}catch(e){const t=e instanceof Error?e.message:"Unknown error occurred";return{data:[],error:t,count:0}}})}fetchInventoryItems(){return $(this,null,function*(){return this.getAllItems()||[]})}addInventoryItem(e){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const t=U.transformToSupabase(e);return yield q.createItem(t)}catch(t){throw new Error(`Failed to add inventory item: ${t instanceof Error?t.message:"Unknown error"}`)}})}addCategory(e){return $(this,null,function*(){return e})}deleteCategory(e){return $(this,null,function*(){})}batchAddItems(e){return $(this,null,function*(){const t=[];for(const r of e)try{const i=yield this.addInventoryItem(r);t.push(i)}catch(i){throw this.lastError=i,i}return t})}batchUpdateItems(e){return $(this,null,function*(){const t=[];for(const r of e)try{const i=yield this.updateInventoryItem(r.id,r.item);t.push(i)}catch(i){throw this.lastError=i,i}return t})}batchDeleteItems(e){return $(this,null,function*(){for(const t of e)try{yield this.deleteInventoryItem(t)}catch(r){throw this.lastError=r,r}})}sync(){return $(this,null,function*(){try{this.lastSyncTime=new Date,this.pendingChanges=!1}catch(e){throw this.lastError=e,e}})}getLastSyncTime(){return this.lastSyncTime}hasPendingChanges(){return this.pendingChanges}getLastError(){return this.lastError}clearError(){this.lastError=null}disconnect(){return $(this,null,function*(){this.isInitialized=!1,this.lastError=null})}fetchData(){return $(this,null,function*(){this.isInitialized||(yield this.initialize())})}createItem(e){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const t=U.transformToSupabase(e);return yield q.createItem(t)}catch(t){throw new Error(`Failed to create inventory item: ${t instanceof Error?t.message:"Unknown error"}`)}})}updateItem(e,t){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const r=U.transformToSupabase(t);return yield q.updateItem(e,r)}catch(r){throw new Error(`Failed to update inventory item: ${r instanceof Error?r.message:"Unknown error"}`)}})}deleteItem(e){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{yield q.deleteItem(e)}catch(t){throw new Error(`Failed to delete inventory item: ${t instanceof Error?t.message:"Unknown error"}`)}})}getAnalyticsData(){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const e=yield q.getAnalytics();return{totalItems:e.totalItems,activeItems:e.activeItems,totalValue:e.totalValue,categories:e.categories}}catch(e){throw new Error(`Failed to get analytics data: ${e instanceof Error?e.message:"Unknown error"}`)}})}transformToInventoryItems(e){return e.map(t=>U.transformFromSupabase(t))}subscribeToChanges(e){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{return this.typedAdapter.subscribeToChanges(t=>{e&&e(t)},{event:"*"})}catch(t){return console.error("âŒ Failed to set up real-time subscription in SupabaseAdapter:",t),()=>{}}}getConfig(){return this.config}clearCache(){this.cachedItems=null,this.cacheTimestamp=0}isReady(){return this.isInitialized}}const bp=Object.freeze(Object.defineProperty({__proto__:null,SupabaseAdapter:Sp},Symbol.toStringTag,{value:"Module"}));var Ep=Object.defineProperty,Ap=Object.defineProperties,Tp=Object.getOwnPropertyDescriptors,Vo=Object.getOwnPropertySymbols,kp=Object.prototype.hasOwnProperty,Cp=Object.prototype.propertyIsEnumerable,Ho=(c,e,t)=>e in c?Ep(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Go=(c,e)=>{for(var t in e||(e={}))kp.call(e,t)&&Ho(c,t,e[t]);if(Vo)for(var t of Vo(e))Cp.call(e,t)&&Ho(c,t,e[t]);return c},Pp=(c,e)=>Ap(c,Tp(e)),Be=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Dp extends ec{constructor(e={type:"static"}){const t={supportsRead:j()||!ce(),supportsWrite:j()||!ce(),supportsDelete:j()||!ce(),supportsRealTime:!1,supportsOffline:j()||!ce(),supportsBatch:!1};super(e,{name:"StaticDataAdapter",version:"1.0.0",description:"Static data adapter for development or when Supabase is not configured",capabilities:t})}initialize(){return Be(this,null,function*(){if(!(j()||!ce()))throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}isConnected(){return j()||!ce()}fetchAllInventoryData(){return Be(this,null,function*(){if(j()||!ce())return{data:this.getMockInventoryItems(),error:null,count:this.getMockInventoryItems().length};throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}fetchInventoryItems(){return Be(this,null,function*(){if(j()||!ce())return this.getMockInventoryItems();throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}fetchCategories(){return Be(this,null,function*(){if(j()||!ce())return this.getMockCategories();throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}addInventoryItem(e){return Be(this,null,function*(){if(j()||!ce())return Pp(Go({},e),{id:`mock-${Date.now()}`});throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}updateInventoryItem(e,t){return Be(this,null,function*(){if(j()||!ce())return Go({id:e,name:"Mock Item"},t);throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}deleteInventoryItem(e){return Be(this,null,function*(){if(!(j()||!ce()))throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}addCategory(e){return Be(this,null,function*(){if(j()||!ce())return e;throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}deleteCategory(e){return Be(this,null,function*(){if(!(j()||!ce()))throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}getMockInventoryItems(){return[{id:"mock-1",facility_id:"mock-facility",name:"Surgical Scissors",category:"Surgical Instruments",status:"Available",quantity:5,unit_cost:150,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),reorder_point:2,expiration_date:null,data:{lastUpdated:new Date().toISOString()},reorder_level:2,archived:!1,archived_at:null,archived_by:null,archive_reason:null},{id:"mock-2",facility_id:"mock-facility",name:"Stethoscope",category:"Diagnostic Equipment",status:"Available",quantity:3,unit_cost:75,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),reorder_point:1,expiration_date:null,data:{lastUpdated:new Date().toISOString()},reorder_level:1,archived:!1,archived_at:null,archived_by:null,archive_reason:null},{id:"mock-3",facility_id:"mock-facility",name:"Blood Pressure Cuff",category:"Diagnostic Equipment",status:"In Use",quantity:2,unit_cost:45,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),reorder_point:1,expiration_date:null,data:{lastUpdated:new Date().toISOString()},reorder_level:1,archived:!1,archived_at:null,archived_by:null,archive_reason:null}]}getMockCategories(){return["Surgical Instruments","Diagnostic Equipment","Medical Supplies","Office Equipment","Emergency Equipment"]}}const Op=Object.freeze(Object.defineProperty({__proto__:null,StaticDataAdapter:Dp},Symbol.toStringTag,{value:"Module"}));var Rp=Object.defineProperty,Wo=Object.getOwnPropertySymbols,$p=Object.prototype.hasOwnProperty,Mp=Object.prototype.propertyIsEnumerable,Ko=(c,e,t)=>e in c?Rp(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,qp=(c,e)=>{for(var t in e||(e={}))$p.call(e,t)&&Ko(c,t,e[t]);if(Wo)for(var t of Wo(e))Mp.call(e,t)&&Ko(c,t,e[t]);return c},ie=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function zp(c){return c.type==="api"&&"baseUrl"in c}class Up{constructor(e){this.isInitialized=!1,this.config=qp({timeout:1e4,retryAttempts:3},e)}initialize(){return ie(this,null,function*(){try{const e=yield this.makeRequest("GET","/health");if(!e.ok)throw new Error(`API health check failed: ${e.statusText}`);this.isInitialized=!0}catch(e){throw console.error("Failed to initialize API adapter:",e),e}})}isConnected(){return this.isInitialized}disconnect(){return ie(this,null,function*(){this.isInitialized=!1})}fetchAllInventoryData(){return ie(this,null,function*(){const t=yield(yield this.makeRequest("GET","/inventory")).json();return{data:t.items||[],error:null,count:t.totalCount||0}})}fetchInventoryItems(){return ie(this,null,function*(){return(yield this.makeRequest("GET","/inventory/items")).json()})}fetchCategories(){return ie(this,null,function*(){return(yield this.makeRequest("GET","/inventory/categories")).json()})}addInventoryItem(e){return ie(this,null,function*(){return(yield this.makeRequest("POST","/inventory/items",e)).json()})}updateInventoryItem(e,t){return ie(this,null,function*(){return(yield this.makeRequest("PUT",`/inventory/items/${e}`,t)).json()})}deleteInventoryItem(e){return ie(this,null,function*(){yield this.makeRequest("DELETE",`/inventory/items/${e}`)})}addCategory(e){return ie(this,null,function*(){return(yield(yield this.makeRequest("POST","/inventory/categories",{name:e})).json()).id||e})}deleteCategory(e){return ie(this,null,function*(){yield this.makeRequest("DELETE",`/inventory/categories/${e}`)})}batchAddItems(e){return ie(this,null,function*(){return(yield this.makeRequest("POST","/inventory/items/batch",{items:e})).json()})}batchUpdateItems(e){return ie(this,null,function*(){return(yield this.makeRequest("PUT","/inventory/items/batch",{updates:e})).json()})}batchDeleteItems(e){return ie(this,null,function*(){yield this.makeRequest("DELETE","/inventory/items/batch",{ids:e})})}sync(){return ie(this,null,function*(){return Promise.resolve()})}getLastSyncTime(){return new Date}hasPendingChanges(){return!1}getLastError(){return null}clearError(){}searchItems(e){return ie(this,null,function*(){return(yield this.makeRequest("GET",`/inventory/search?q=${encodeURIComponent(e)}`)).json()})}getMetadata(){return{name:"API Adapter",version:"1.0.0",description:"Adapter for external API data sources",capabilities:{supportsRead:!0,supportsWrite:!0,supportsDelete:!0,supportsBatch:!0,supportsRealTime:!1,supportsOffline:!1},config:this.config}}makeRequest(e,t,r){return ie(this,null,function*(){if(!this.isInitialized)throw new Error("API adapter not initialized");const i=`${this.config.baseUrl}${t}`,a={"Content-Type":"application/json"};this.config.apiKey&&(a.Authorization=`Bearer ${this.config.apiKey}`);const s={method:e,headers:a,signal:AbortSignal.timeout(this.config.timeout)};r&&(s.body=JSON.stringify(r));let o=null;for(let n=1;n<=this.config.retryAttempts;n++)try{const l=yield fetch(i,s);if(!l.ok)throw new Error(`API request failed: ${l.status} ${l.statusText}`);return l}catch(l){o=l instanceof Error?l:new Error("Unknown error"),n<this.config.retryAttempts&&(console.warn(`API request attempt ${n} failed, retrying...`,o.message),yield this.delay(Math.pow(2,n)*1e3))}throw o||new Error("API request failed after all retry attempts")})}delay(e){return new Promise(t=>setTimeout(t,e))}}const Fp=Object.freeze(Object.defineProperty({__proto__:null,ApiAdapter:Up,isApiAdapterConfig:zp},Symbol.toStringTag,{value:"Module"}));var bn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class pc{constructor(){this.cachedTasks=null,this.isLoading=!1,this.error=null,this.lastFetchTime=0,this.CACHE_DURATION=300*1e3,this.cachedUser=null,this.USER_CACHE_DURATION=120*1e3}getCachedUser(){return bn(this,null,function*(){var e,t,r;const{data:{session:i}}=yield d.auth.getSession(),a=(t=(e=i==null?void 0:i.user)==null?void 0:e.app_metadata)==null?void 0:t.facility_id,s=(r=i==null?void 0:i.user)==null?void 0:r.id;if(!a)throw new Error("No authenticated facility ID found.");if(!s)throw new Error("No authenticated user ID found.");return{id:s,facility_id:a}})}fetchTasks(){return bn(this,null,function*(){var e,t,r;const i=performance.now(),a=Date.now();if(this.cachedTasks&&a-this.lastFetchTime<this.CACHE_DURATION)return j()&&console.log(`[PERF] TaskService: Returning cached tasks in ${(performance.now()-i).toFixed(2)}ms`),this.cachedTasks;try{this.isLoading=!0,this.error=null;const{data:{session:s}}=yield d.auth.getSession(),o=(t=(e=s==null?void 0:s.user)==null?void 0:e.app_metadata)==null?void 0:t.facility_id,n=(r=s==null?void 0:s.user)==null?void 0:r.id;if(!o)throw new Error("No authenticated facility ID found.");if(!n)throw new Error("No authenticated user ID found.");const{data:l,error:u}=yield d.from("home_challenges").select("*").eq("facility_id",o).order("created_at",{ascending:!1});if(u)return console.error("Error fetching challenges:",u),this.error=u.message,[];const h=(l||[]).map(p=>({id:p.id,title:p.title,description:p.description||"",status:"pending",priority:"medium",due_date:void 0,created_at:p.created_at,updated_at:p.updated_at,user_id:n,facility_id:o,completed:!1})),{data:f}=yield d.from("home_challenge_completions").select("challenge_id").eq("user_id",n).eq("facility_id",o),m=new Set((f==null?void 0:f.map(p=>p.challenge_id))||[]);return h.forEach(p=>{p.completed=m.has(p.id)}),this.cachedTasks=h,this.lastFetchTime=a,j()&&console.log(`[PERF] TaskService: Fetched tasks in ${(performance.now()-i).toFixed(2)}ms`),h}catch(s){return this.error=s instanceof Error?s.message:"Failed to fetch tasks",console.error("TaskService fetch error:",s),[]}finally{this.isLoading=!1}})}getTasks(){return{tasks:this.cachedTasks||[],loading:this.isLoading,error:this.error}}updateTask(e){return bn(this,null,function*(){var t,r,i;try{const{data:{session:a}}=yield d.auth.getSession(),s=(r=(t=a==null?void 0:a.user)==null?void 0:t.app_metadata)==null?void 0:r.facility_id,o=(i=a==null?void 0:a.user)==null?void 0:i.id;if(!s)throw new Error("No authenticated facility ID found.");if(!o)throw new Error("No authenticated user ID found.");const{data:n,error:l}=yield d.from("home_challenges").update({title:e.title,description:e.description,status:e.status,priority:e.priority,due_date:e.due_date,updated_at:new Date().toISOString()}).eq("id",e.id).eq("facility_id",s).select().single();if(l)throw new Error(`Failed to update task: ${l.message}`);const u=n;return this.cachedTasks&&(this.cachedTasks=this.cachedTasks.map(h=>h.id===e.id?u:h)),u}catch(a){throw console.error("Error updating task:",a),a}})}clearCache(){this.cachedTasks=null,this.cachedUser=null,this.lastFetchTime=0}setError(e){this.error=e}setLoading(e){this.isLoading=e}}const Lp=()=>new pc,Np=new pc,j_=Object.freeze(Object.defineProperty({__proto__:null,createTaskService:Lp,taskService:Np},Symbol.toStringTag,{value:"Module"}));var Fr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class xp{constructor(){this.CACHE_DURATION=300*1e3,this.cache=new Map}isCacheValid(e){return Date.now()-e<this.CACHE_DURATION}getCachedData(e){const t=this.cache.get(e);return t&&this.isCacheValid(t.timestamp)?t.data:null}setCachedData(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}getAITimeSavings(){return Fr(this,null,function*(){try{const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ge),void 0),t=yield e.getCurrentFacilityId();if(!t)return v.debug("AITimeSavingsService: No facility ID, returning defaults"),{daily_time_saved:0,monthly_time_saved:0};const r=`ai-time-savings-${t}-${new Date().toISOString().split("T")[0]}`,i=this.getCachedData(r);if(i)return i;const[a,s,o,n]=yield Promise.all([this.calculateAITaskPerformanceSavings(t),this.calculateAITrainingSavings(t),this.calculateAIComplianceSavings(t),this.calculateAIPredictiveSavings(t)]),l=a.daily+s.daily+o.daily+n.daily,u=a.monthly+s.monthly+o.monthly+n.monthly,h={daily_time_saved:Math.round(l),monthly_time_saved:Math.round(u)};return this.setCachedData(r,h),v.debug("AITimeSavingsService: Calculated AI time savings:",h),h}catch(e){return v.error("AITimeSavingsService: Error calculating AI time savings:",e),{daily_time_saved:0,monthly_time_saved:0}}})}calculateAITaskPerformanceSavings(e){return Fr(this,null,function*(){try{const t=new Date().toISOString().split("T")[0],r=new Date().toISOString().slice(0,7),{data:i}=yield d.from("ai_task_performance").select("time_saved").eq("facility_id",e).gte("completed_at",`${t}T00:00:00`).lt("completed_at",`${t}T23:59:59`),{data:a}=yield d.from("ai_task_performance").select("time_saved").eq("facility_id",e).gte("completed_at",`${r}-01T00:00:00`).lt("completed_at",`${r}-31T23:59:59`),s=(i||[]).reduce((n,l)=>n+(l.time_saved||0),0),o=(a||[]).reduce((n,l)=>n+(l.time_saved||0),0);return{daily:s,monthly:o}}catch(t){return v.error("AITimeSavingsService: Error calculating AI task performance savings:",t),{daily:0,monthly:0}}})}calculateAITrainingSavings(e){return Fr(this,null,function*(){try{return{daily:30,monthly:900}}catch(t){return v.error("AITimeSavingsService: Error calculating AI training savings:",t),{daily:0,monthly:0}}})}calculateAIComplianceSavings(e){return Fr(this,null,function*(){try{return{daily:20,monthly:600}}catch(t){return v.error("AITimeSavingsService: Error calculating AI compliance savings:",t),{daily:0,monthly:0}}})}calculateAIPredictiveSavings(e){return Fr(this,null,function*(){try{return{daily:25,monthly:750}}catch(t){return v.error("AITimeSavingsService: Error calculating AI predictive savings:",t),{daily:0,monthly:0}}})}clearCache(){this.cache.clear()}}const gc=new xp,Bp=Object.freeze(Object.defineProperty({__proto__:null,aiTimeSavingsService:gc},Symbol.toStringTag,{value:"Module"}));function jp(c){return c.toISOString().split("T")[0]}var Vp=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function Hp(c,e){return Vp(this,null,function*(){const{data:t}=yield d.from("performance_metrics").select("*").eq("date",c).eq("facility_id",e);return t||[]})}var Gp=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function Wp(){return Gp(this,null,function*(){try{const c=yield lc.getAIImpactMetrics();return{monthly:c.costSavings.monthly,annual:c.costSavings.annual}}catch(c){return console.warn("Failed to get AI impact metrics for cost savings:",c),{monthly:0,annual:0}}})}var yc=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function Kp(){return yc(this,null,function*(){try{const c=yield Wp();return{monthly_cost_savings:c.monthly,annual_cost_savings:c.annual}}catch(c){return console.error("Error getting cost savings aggregates:",c),{monthly_cost_savings:0,annual_cost_savings:0}}})}function Qp(){return yc(this,null,function*(){try{const{FacilityService:c}=yield T(()=>Promise.resolve().then(()=>ge),void 0),e=yield c.getCurrentFacilityId(),t=jp(new Date);console.log("ðŸ‘¥ getTeamPerformanceAggregates: Fetching for facility:",e,"date:",t);const r=yield Hp(t,e);console.log("ðŸ‘¥ getTeamPerformanceAggregates: Daily metrics:",r);const i=r==null?void 0:r.find(s=>s.metric_type==="team_performance");console.log("ðŸ‘¥ getTeamPerformanceAggregates: Team performance data:",i);const a={skills_score:(i==null?void 0:i.skills)||85,inventory_score:(i==null?void 0:i.inventory)||92,sterilization_score:(i==null?void 0:i.sterilization)||88};return console.log("ðŸ‘¥ getTeamPerformanceAggregates: Returning:",a),a}catch(c){return console.error("Error getting team performance aggregates:",c),{skills_score:85,inventory_score:92,sterilization_score:88}}})}var Si=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Yp{constructor(){this.CACHE_DURATION=300*1e3,this.cache=new Map}isCacheValid(e){return Date.now()-e<this.CACHE_DURATION}getCachedData(e){const t=this.cache.get(e);return t&&this.isCacheValid(t.timestamp)?t.data:null}setCachedData(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}getOperationalTimeSavings(){return Si(this,null,function*(){try{console.log("ðŸ” OperationalTimeSavingsService: Starting calculation...");const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ge),void 0),t=yield e.getCurrentFacilityId();if(console.log("ðŸ¥ OperationalTimeSavingsService: Facility ID:",t),!t)return console.log("âŒ OperationalTimeSavingsService: No facility ID, returning defaults"),{daily_time_saved:0,monthly_time_saved:0};const r=`operational-time-savings-${t}-${new Date().toISOString().split("T")[0]}`,i=this.getCachedData(r);if(i)return console.log("ðŸ“Š OperationalTimeSavingsService: Using cached data:",i),i;console.log("ðŸ§® OperationalTimeSavingsService: Calculating from multiple sources...");const[a,s,o]=yield Promise.all([this.calculateSterilizationTimeSavings(t),this.calculateTaskCompletionTimeSavings(t),this.calculateCleaningTimeSavings(t)]);console.log("ðŸ“ˆ OperationalTimeSavingsService: Individual savings:",{sterilization:a,tasks:s,cleaning:o});const n=a.daily+s.daily+o.daily,l=a.monthly+s.monthly+o.monthly,u={daily_time_saved:Math.round(n),monthly_time_saved:Math.round(l)};return this.setCachedData(r,u),console.log("âœ… OperationalTimeSavingsService: Final result:",u),u}catch(e){return console.error("âŒ OperationalTimeSavingsService: Error calculating operational time savings:",e),{daily_time_saved:0,monthly_time_saved:0}}})}calculateSterilizationTimeSavings(e){return Si(this,null,function*(){try{const t=new Date().toISOString().split("T")[0],r=new Date().toISOString().slice(0,7),{data:i}=yield d.from("sterilization_cycles").select("duration_minutes, end_time").eq("facility_id",e).eq("status","completed").gte("end_time",`${t}T00:00:00`).lt("end_time",`${t}T23:59:59`),{data:a}=yield d.from("sterilization_cycles").select("duration_minutes, end_time").eq("facility_id",e).eq("status","completed").gte("end_time",`${r}-01T00:00:00`).lt("end_time",`${r}-31T23:59:59`),s=(i||[]).reduce((n,l)=>{const h=l.duration_minutes||60;return n+Math.max(0,60-h)},0),o=(a||[]).reduce((n,l)=>{const h=l.duration_minutes||60;return n+Math.max(0,60-h)},0);return{daily:s,monthly:o}}catch(t){return v.error("OperationalTimeSavingsService: Error calculating sterilization savings:",t),{daily:0,monthly:0}}})}calculateTaskCompletionTimeSavings(e){return Si(this,null,function*(){try{const t=new Date().toISOString().split("T")[0],r=new Date().toISOString().slice(0,7),{data:i}=yield d.from("home_daily_operations_tasks").select("estimated_duration, actual_duration").eq("facility_id",e).eq("completed",!0).gte("completed_at",`${t}T00:00:00`).lt("completed_at",`${t}T23:59:59`),{data:a}=yield d.from("home_daily_operations_tasks").select("estimated_duration, actual_duration").eq("facility_id",e).eq("completed",!0).gte("completed_at",`${r}-01T00:00:00`).lt("completed_at",`${r}-31T23:59:59`),s=(i||[]).reduce((n,l)=>{const u=l.estimated_duration||30,h=l.actual_duration||u;return n+Math.max(0,u-h)},0),o=(a||[]).reduce((n,l)=>{const u=l.estimated_duration||30,h=l.actual_duration||u;return n+Math.max(0,u-h)},0);return{daily:s,monthly:o}}catch(t){return v.error("OperationalTimeSavingsService: Error calculating task completion savings:",t),{daily:0,monthly:0}}})}calculateCleaningTimeSavings(e){return Si(this,null,function*(){try{return{daily:45,monthly:1350}}catch(t){return v.error("OperationalTimeSavingsService: Error calculating cleaning savings:",t),{daily:0,monthly:0}}})}clearCache(){this.cache.clear()}}const Jp=new Yp;var bi=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Xp{constructor(){this.cache=new Map,this.CACHE_TTL=300*1e3}isCacheValid(e){return Date.now()-e<this.CACHE_TTL}getCachedData(e){const t=this.cache.get(e);return t&&this.isCacheValid(t.timestamp)?t.data:null}setCachedData(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}getHomeMetrics(){return bi(this,null,function*(){try{const e=new Date().toISOString().split("T")[0],t=`home-metrics-${e}`,r=this.getCachedData(t);if(r)return r;const{data:{user:i}}=yield d.auth.getUser();if(!i)throw new Error("User not authenticated");const{data:a,error:s}=yield d.from("users").select("facility_id").eq("id",i.id).single();if(s)return console.warn("Failed to fetch user profile, using default facility:",s),this.getDefaultMetrics();const o=(a==null?void 0:a.facility_id)||"550e8400-e29b-41d4-a716-446655440000";console.log("ðŸ  HomeMetricsService: Fetching metrics for facility:",o);const[n,l,u,h,f,m]=yield Promise.allSettled([Jp.getOperationalTimeSavings(),gc.getAITimeSavings(),Kp(),Qp(),this.getDailyMetrics(e,o),this.getGamificationStats(e,o)]),p=n.status==="fulfilled"?n.value:{daily_time_saved:0,monthly_time_saved:0},y=l.status==="fulfilled"?l.value:{daily_time_saved:0,monthly_time_saved:0},g=u.status==="fulfilled"?u.value:{monthly_cost_savings:0,annual_cost_savings:0},_=h.status==="fulfilled"?h.value:{skills_score:0,inventory_score:0,sterilization_score:0},w=f.status==="fulfilled"?f.value:[],E=m.status==="fulfilled"?m.value:[];console.log("ðŸ“Š HomeMetricsService: Received operational time savings:",p),console.log("ðŸ“Š HomeMetricsService: Received AI time savings:",y),console.log("ðŸ“Š HomeMetricsService: Received cost savings:",g),console.log("ðŸ“Š HomeMetricsService: Received team performance:",_);const b={timeSaved:{daily:p.daily_time_saved,monthly:p.monthly_time_saved},aiTimeSaved:{daily:y.daily_time_saved,monthly:y.monthly_time_saved},costSavings:{monthly:g.monthly_cost_savings,annual:g.annual_cost_savings},aiEfficiency:{timeSavings:this.extractAIEfficiency(w,"time_savings"),proactiveMgmt:this.extractAIEfficiency(w,"proactive_mgmt")},teamPerformance:{skills:_.skills_score,inventory:_.inventory_score,sterilization:_.sterilization_score},gamificationStats:{totalTasks:this.calculateTotalTasks(E),completedTasks:this.calculateCompletedTasks(E),perfectDays:this.calculatePerfectDays(E),currentStreak:this.calculateCurrentStreak(E),bestStreak:this.calculateBestStreak(E)}};return this.setCachedData(t,b),b}catch(e){return console.warn("Failed to fetch home metrics, using defaults:",e),this.getDefaultMetrics()}})}getDailyMetrics(e,t){return bi(this,null,function*(){const{data:r}=yield d.from("performance_metrics").select("*").eq("date",e).eq("facility_id",t);return r||[]})}getMonthlyMetrics(e,t){return bi(this,null,function*(){const{data:r}=yield d.from("performance_metrics").select("*").like("month",e).eq("facility_id",t);return r||[]})}getGamificationStats(e,t){return bi(this,null,function*(){const{data:r}=yield d.from("user_gamification_stats").select("*").eq("date",e).eq("facility_id",t).limit(10);return r||[]})}extractTimeSaved(e,t){const r=e.find(i=>i.metric_type==="time_saved");return t==="daily"?(r==null?void 0:r.daily_time_saved)||0:(r==null?void 0:r.monthly_time_saved)||0}extractCostSavings(e,t){const r=e.find(i=>i.metric_type==="cost_savings");return t==="monthly"?(r==null?void 0:r.monthly_cost_savings)||0:(r==null?void 0:r.annual_cost_savings)||0}extractAIEfficiency(e,t){const r=e.find(i=>i.metric_type==="ai_efficiency");return(r==null?void 0:r[t])||0}extractTeamPerformance(e,t){const r=e.find(i=>i.metric_type==="team_performance");return(r==null?void 0:r[t])||0}calculateTotalTasks(e){return e.reduce((t,r)=>t+(r.total_tasks||0),0)}calculateCompletedTasks(e){return e.reduce((t,r)=>t+(r.completed_tasks||0),0)}calculatePerfectDays(e){return e.filter(t=>(t.completed_tasks||0)===(t.total_tasks||0)).length}calculateCurrentStreak(e){return e.reduce((t,r)=>Math.max(t,r.current_streak||0),0)}calculateBestStreak(e){return e.reduce((t,r)=>Math.max(t,r.best_streak||0),0)}getDefaultMetrics(){return{timeSaved:{daily:0,monthly:0},aiTimeSaved:{daily:0,monthly:0},costSavings:{monthly:0,annual:0},aiEfficiency:{timeSavings:0,proactiveMgmt:0},teamPerformance:{skills:0,inventory:0,sterilization:0},gamificationStats:{totalTasks:0,completedTasks:0,perfectDays:0,currentStreak:0,bestStreak:0}}}}const Zp=new Xp,eg=Object.freeze(Object.defineProperty({__proto__:null,homeMetricsService:Zp},Symbol.toStringTag,{value:"Module"}));var je=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class tg{getCachedUser(){return null}getSterilizationMetrics(){return je(this,null,function*(){try{const e=yield this.getCachedUser();return e?yield this.getConsolidatedSterilizationMetrics(e.facility_id):this.getDefaultSterilizationMetrics()}catch(e){return console.error("Error fetching sterilization metrics:",e),this.getDefaultSterilizationMetrics()}})}getConsolidatedSterilizationMetrics(e){return je(this,null,function*(){const t=new Date().toISOString().split("T")[0],r=new Date;r.setDate(r.getDate()-7);const i=new Date;i.setDate(i.getDate()-30);const{data:a,error:s}=yield d.from("sterilization_cycles").select("id, status, created_at, end_time").eq("facility_id",e).gte("created_at",i.toISOString()).lte("created_at",t).order("created_at",{ascending:!1});return s?(console.error("Error fetching consolidated sterilization metrics:",s),yield this.getFallbackSterilizationMetrics(e)):a&&Array.isArray(a)&&a.length>0?this.mapDatabaseResponseToMetrics(a[0]):this.getDefaultSterilizationMetrics()})}mapDatabaseResponseToMetrics(e){return{cyclesToday:e.cycles_today||0,cyclesThisWeek:e.cycles_this_week||0,biPassRate:e.bi_pass_rate||0,averageCycleTime:e.average_cycle_time||0,toolsInCycle:e.tools_in_cycle||0,toolsCompletedToday:e.tools_completed_today||0,performanceScore:e.performance_score||0}}getFallbackSterilizationMetrics(e){return je(this,null,function*(){const[t,r,i,a,s,o]=yield Promise.all([this.getCyclesToday(e),this.getCyclesThisWeek(e),this.getBITestResults(e),this.getCycleTimes(e),this.getToolsInCycle(e),this.getToolsCompletedToday(e)]),n=this.calculateBIPassRate(i),l=this.calculateAverageCycleTime(a),u=this.calculatePerformanceScore({biPassRate:n,averageCycleTime:l,cyclesToday:t});return{cyclesToday:t,cyclesThisWeek:r,biPassRate:n,averageCycleTime:l,toolsInCycle:s,toolsCompletedToday:o,performanceScore:u}})}getCyclesToday(e){return je(this,null,function*(){const{data:t,error:r}=yield d.from("sterilization_cycles").select("id").eq("facility_id",e).gte("created_at",new Date().toISOString().split("T")[0]);return r?(console.error("Error fetching cycles today:",r),0):(t==null?void 0:t.length)||0})}getCyclesThisWeek(e){return je(this,null,function*(){const t=new Date;t.setDate(t.getDate()-7);const{data:r,error:i}=yield d.from("sterilization_cycles").select("id").eq("facility_id",e).gte("created_at",t.toISOString());return i?(console.error("Error fetching cycles this week:",i),0):(r==null?void 0:r.length)||0})}getBITestResults(e){return je(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_results").select("result").eq("facility_id",e).gte("created_at",new Date(Date.now()-2592e6).toISOString());return r?(console.error("Error fetching BI test results:",r),[]):t||[]})}getCycleTimes(e){return je(this,null,function*(){const{data:t,error:r}=yield d.from("sterilization_cycles").select("start_time, end_time, duration_minutes").eq("facility_id",e).eq("status","completed").gte("created_at",new Date(Date.now()-6048e5).toISOString());return r?(console.error("Error fetching cycle times:",r),[]):t||[]})}getToolsInCycle(e){return je(this,null,function*(){try{return(yield me.getToolsByFacilityAndStatus(e,"in_cycle")).length}catch(t){return console.error("Error fetching tools in cycle:",t),0}})}getToolsCompletedToday(e){return je(this,null,function*(){try{const t=yield me.getToolsByFacilityAndStatus(e,"available"),r=new Date().toISOString().split("T")[0];return t.filter(a=>a.updated_at&&a.updated_at.split("T")[0]>=r).length}catch(t){return console.error("Error fetching tools completed today:",t),0}})}calculateBIPassRate(e){if(e.length===0)return 0;const t=e.filter(r=>r.result==="pass").length;return Math.round(t/e.length*100)}calculateAverageCycleTime(e){if(e.length===0)return 0;const t=e.reduce((r,i)=>r+(i.duration_minutes||0),0);return Math.round(t/e.length)}calculatePerformanceScore(e){const t=Math.min(e.biPassRate,100),r=Math.min(e.cyclesToday*10,50),i=Math.max(0,50-e.averageCycleTime);return Math.round((t+r+i)/3)}getDefaultSterilizationMetrics(){return{cyclesToday:0,cyclesThisWeek:0,biPassRate:0,averageCycleTime:0,toolsInCycle:0,toolsCompletedToday:0,performanceScore:0}}}const rg=new tg,ig=Object.freeze(Object.defineProperty({__proto__:null,homeSterilizationIntegration:rg},Symbol.toStringTag,{value:"Module"}));var En=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ng{getInventoryMetrics(){return En(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:t}=yield d.from("users").select("facility_id").eq("id",e.id).single(),r=(t==null?void 0:t.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{data:i,error:a}=yield d.from("inventory_items").select("status").eq("facility_id",r);if(a)return console.warn("Failed to fetch aggregated inventory metrics, using fallback:",a),{lowStockItems:0,totalItems:0,expiringItems:0,inventoryAccuracy:0};const s=(i==null?void 0:i.length)||0,o=(i==null?void 0:i.filter(u=>u.status==="low_stock").length)||0,n=(i==null?void 0:i.filter(u=>u.status==="expiring").length)||0,l=s>0?(s-o)/s*100:0;return{lowStockItems:o,totalItems:s,expiringItems:n,inventoryAccuracy:l}}catch(e){return console.error("Error fetching inventory metrics:",e),{lowStockItems:0,totalItems:0,expiringItems:0,inventoryAccuracy:0}}})}getEnvironmentalCleanMetrics(){return En(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:t}=yield d.from("users").select("facility_id").eq("id",e.id).single(),r=(t==null?void 0:t.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{data:i,error:a}=yield d.from("environmental_clean_logs").select("status, area").eq("facility_id",r);if(a)return console.warn("Failed to fetch aggregated environmental clean metrics, using fallback:",a),{cleaningEfficiency:0,totalRooms:0,cleanRooms:0,complianceScore:98};const s=(i==null?void 0:i.length)||0,o=(i==null?void 0:i.filter(u=>u.status==="completed").length)||0,n=s>0?o/s*100:0,l=n>90?98:Math.max(70,n);return{cleaningEfficiency:n,totalRooms:s,cleanRooms:o,complianceScore:l}}catch(e){return console.error("Error fetching environmental clean metrics:",e),{cleaningEfficiency:0,totalRooms:0,cleanRooms:0,complianceScore:98}}})}getAllMetrics(){return En(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:t}=yield d.from("users").select("facility_id").eq("id",e.id).single(),r=(t==null?void 0:t.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{data:i,error:a}=yield d.from("sterilization_cycles").select("status, created_at, end_time").eq("facility_id",r).order("created_at",{ascending:!1}).limit(10);if(a){console.warn("Failed to fetch combined metrics, falling back to individual calls:",a);const[o,n]=yield Promise.all([this.getInventoryMetrics(),this.getEnvironmentalCleanMetrics()]);return{inventory:o,environmentalClean:n}}const s=(i==null?void 0:i[0])||{};return{inventory:{lowStockItems:(s==null?void 0:s.inventory_low_stock_items)||0,totalItems:(s==null?void 0:s.inventory_total_items)||0,expiringItems:(s==null?void 0:s.inventory_expiring_items)||0,inventoryAccuracy:(s==null?void 0:s.inventory_accuracy)||0},environmentalClean:{cleaningEfficiency:(s==null?void 0:s.cleaning_efficiency)||0,totalRooms:(s==null?void 0:s.cleaning_total_rooms)||0,cleanRooms:(s==null?void 0:s.cleaning_clean_rooms)||0,complianceScore:(s==null?void 0:s.cleaning_compliance_score)||98}}}catch(e){return console.error("Error fetching all home integration metrics:",e),{inventory:{lowStockItems:0,totalItems:0,expiringItems:0,inventoryAccuracy:0},environmentalClean:{cleaningEfficiency:0,totalRooms:0,cleanRooms:0,complianceScore:98}}}})}}const ag=new ng,og=Object.freeze(Object.defineProperty({__proto__:null,homeIntegrationService:ag},Symbol.toStringTag,{value:"Module"}));var An=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class V_{static scanToolForCleanWorkflow(e,t){return An(this,null,function*(){try{let r;try{if(r=yield me.getToolByBarcodeAndStatus(e,"clean"),!r)return{success:!1,message:`Tool with barcode "${e}" not found or not available for sterilization.`}}catch(n){return{success:!1,message:`Tool with barcode "${e}" not found or not available for sterilization.`}}if(r.current_cycle_id&&!r.id.startsWith("mock-tool-")){const{data:n}=yield d.from("sterilization_cycles").select("status").eq("id",r.current_cycle_id).single();if((n==null?void 0:n.status)!=="completed")return{success:!1,message:`Tool "${r.tool_name}" is not ready for clean workflow. Current cycle status: ${(n==null?void 0:n.status)||"unknown"}`}}const i=yield me.updateToolStatus(r.id,"dirty");yield me.clearCycleAssignment([r.id],"dirty"),yield me.markAsSterilized(r.id);const a={user_id:t,facility_id:r.facility_id,module:"sterilization",action:"tool_scanned_clean_workflow",table_name:"sterilization_tools",record_id:r.id,old_values:{status:"available",current_cycle_id:r.current_cycle_id},new_values:{status:"in_cycle",current_cycle_id:null},metadata:{barcode:e,workflow:"clean",previous_phase:"complete",new_phase:"dirty"}};yield d.from("audit_logs").insert(a);const s=i,o={id:s.id,name:s.tool_name,barcode:s.barcode,category:s.category||"general",type:s.tool_type,currentPhase:"failed",status:s.status,location:s.location,cycleCount:s.sterilization_count||0,lastSterilized:s.last_sterilized,notes:s.notes,is_p2_tool:s.is_p2_tool};return{success:!0,message:`Successfully scanned tool "${s.tool_name}" and marked as dirty. Ready for sterilization.`,tool:o}}catch(r){return console.error("Error scanning tool for clean workflow:",r),{success:!1,message:"An unexpected error occurred while scanning the tool."}}})}static scanToolForProblemWorkflow(e,t,r,i){return An(this,null,function*(){try{const{data:a,error:s}=yield d.from("tools").select("*").eq("barcode",e).single();if(s||!a)return{success:!1,message:`Tool with barcode "${e}" not found in system.`};const o=a;let n=null;if(o.current_cycle_id){const{data:p}=yield d.from("sterilization_cycles").select("*").eq("id",o.current_cycle_id).single();n=p}const l=yield me.updateToolStatus(o.id,"problem");yield me.clearCycleAssignment([o.id],"problem");const{error:u}=yield d.from("tools").update({updated_at:new Date().toISOString(),notes:`PROBLEM: ${t} - ${r}`}).eq("id",o.id);if(u)return console.error("Failed to update tool status:",u),{success:!1,message:"Failed to update tool status. Please try again."};const h={user_id:i,facility_id:o.facility_id,module:"sterilization",action:"tool_scanned_problem_workflow",table_name:"sterilization_tools",record_id:o.id,old_values:{status:o.status,current_cycle_id:o.current_cycle_id,sterilization_count:o.sterilization_count,last_sterilized:o.last_sterilized},new_values:{status:"quarantine",current_cycle_id:null,notes:`PROBLEM: ${t} - ${r}`},metadata:{barcode:e,workflow:"problem",problem_type:t,problem_notes:r,previous_phase:"clean_workflow_scan",new_phase:"quarantine",last_cycle_id:o.current_cycle_id,last_cycle_status:n==null?void 0:n.status,last_cycle_completed:n==null?void 0:n.completed_at,sterilization_count_at_problem:o.sterilization_count,process_improvement_flag:!0,inspection_quality_issue:t.includes("damage")||t.includes("inspection"),cleaning_quality_issue:t.includes("cleaning")||t.includes("contamination")}};yield d.from("audit_logs").insert(h);const f=l,m={id:f.id,name:f.tool_name,barcode:f.barcode,category:f.category||"general",type:f.tool_type,currentPhase:"quarantine",status:f.status,location:f.location,cycleCount:f.sterilization_count||0,lastSterilized:f.last_sterilized,notes:f.notes,is_p2_tool:f.is_p2_tool};return{success:!0,message:`Tool "${f.tool_name}" marked as problem (${t}). Process improvement data collected.`,tool:m}}catch(a){return console.error("Error scanning tool for problem workflow:",a),{success:!1,message:"An unexpected error occurred while processing the problem tool."}}})}static getAvailableTools(e){return An(this,null,function*(){try{return(yield me.getToolsByFacilityAndStatus(e,"clean")).sort((i,a)=>(i.name||"").localeCompare(a.name||"")).map(i=>{const a=i;return{id:a.id,name:a.tool_name,barcode:a.barcode,category:a.category||"general",type:a.tool_type,currentPhase:a.current_cycle_id?"complete":"available",status:a.status,location:a.location,cycleCount:a.sterilization_count||0,lastSterilized:a.last_sterilized,notes:a.notes}})}catch(t){return console.error("Error fetching available tools:",t),[]}})}}var Br=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function Lr(){return Br(this,null,function*(){const{data:{user:c}}=yield d.auth.getUser();if(!c)throw new Error("User not authenticated");const{data:e,error:t}=yield d.from("users").select("facility_id").eq("id",c.id).single();if(t||!e)throw new Error("Failed to get user facility");return e.facility_id})}class H_{static getBatchInfoForTool(e){return Br(this,null,function*(){try{const{data:t,error:r}=yield d.from("sterilization_batches").select("*").eq("id",e).order("created_at",{ascending:!1}).limit(1).single();if(r||!t)return null;const i=t;let a;if(i.cycle_id){const l=yield Lr(),{data:u,error:h}=yield d.from("sterilization_cycles").select("cycle_name").eq("id",i.cycle_id).eq("facility_id",l).single();!h&&u&&(a=u.cycle_name)}const{data:s,error:o}=yield d.from("users").select("name").eq("id",i.requested_by).single(),n=o?"Unknown":(s==null?void 0:s.full_name)||"Unknown";return{batchId:i.id,batchName:i.batch_name,cycleId:i.cycle_id,cycleName:a,status:i.status,totalItems:i.total_items,createdBy:n,createdAt:new Date(i.created_at),completedAt:i.completed_at?new Date(i.completed_at):void 0}}catch(t){return console.error("Error getting batch info for tool:",t),null}})}static getBatchInfoForTools(e){return Br(this,null,function*(){try{if(e.length===0)return[];const{data:t,error:r}=yield d.from("sterilization_batches").select("*").in("id",e).order("created_at",{ascending:!1});if(r||!t)return[];const i=yield Lr(),{data:a,error:s}=yield d.from("tools").select("id, tool_name, barcode, last_sterilized, sterilization_count").in("id",e).eq("facility_id",i);if(s||!a)return[];const o=new Map(a.map(h=>[h.id,{name:h.tool_name,barcode:h.barcode,lastSterilized:h.last_sterilized,cycleCount:h.sterilization_count}])),n=t,l=Array.from(new Set(n.map(h=>h.cycle_id).filter(Boolean))),u=new Map;if(l.length>0){const h=yield Lr(),{data:f,error:m}=yield d.from("sterilization_cycles").select("id, cycle_name").in("id",l).eq("facility_id",h);!m&&f&&f.forEach(p=>{u.set(p.id,p.cycle_name)})}return n.map(h=>{const f=o.get(h.id);return{toolId:h.id,toolName:(f==null?void 0:f.name)||"Unknown Tool",barcode:(f==null?void 0:f.barcode)||"Unknown",batchId:h.id,batchName:h.batch_name,cycleId:h.cycle_id,cycleName:h.cycle_id?u.get(h.cycle_id):void 0,status:h.status,lastSterilized:f!=null&&f.lastSterilized?new Date(f.lastSterilized):void 0,cycleCount:(f==null?void 0:f.cycleCount)||0}})}catch(t){return console.error("Error getting batch info for tools:",t),[]}})}static getCurrentBatchFromCycle(e){return Br(this,null,function*(){try{const t=yield Lr(),{data:r,error:i}=yield d.from("tools").select("current_cycle_id, tool_name").eq("id",e).eq("facility_id",t).single(),a=r;if(i||!r||!a.current_cycle_id)return null;const{data:s,error:o}=yield d.from("sterilization_cycles").select("*").eq("id",a.current_cycle_id).eq("facility_id",t).single();if(o||!s)return null;const{data:n,error:l}=yield d.from("sterilization_batches").select("*").eq("cycle_id",a.current_cycle_id).single(),u=s;if(l||!n)return{batchId:`VIRTUAL-${a.current_cycle_id}`,batchName:`Cycle ${u.cycle_name||u.id}`,cycleId:a.current_cycle_id,cycleName:u.cycle_name,status:u.status,totalItems:1,createdBy:"System",createdAt:new Date(u.start_time),completedAt:u.end_time?new Date(u.end_time):void 0};const h=n,{data:f,error:m}=yield d.from("users").select("name").eq("id",h.requested_by).single(),p=f,y=m?"Unknown":(p==null?void 0:p.full_name)||"Unknown";return{batchId:h.id,batchName:h.batch_name,cycleId:h.cycle_id||void 0,cycleName:u.cycle_name,status:h.status,totalItems:h.total_items,createdBy:y,createdAt:new Date(h.created_at),completedAt:h.completed_at?new Date(h.completed_at):void 0}}catch(t){return console.error("Error getting current batch from cycle:",t),null}})}static generateBatchIdFromCycleData(e){try{if(e.cycleId)return`BATCH-${e.cycleId}`;if(e.lastSterilized){const t=new Date(e.lastSterilized);return`BATCH-${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}${String(t.getDate()).padStart(2,"0")}-${e.id.slice(-4)}`}return e.currentCycleId?`BATCH-${e.currentCycleId}`:null}catch(t){return console.error("Failed to generate batch ID from cycle data:",t),null}}static getMostRecentBatchForTool(e){return Br(this,null,function*(){try{let t=yield this.getBatchInfoForTool(e);if(t||(t=yield this.getCurrentBatchFromCycle(e),t))return t;const r=yield Lr(),{data:i,error:a}=yield d.from("tools").select("tool_name, last_sterilized, sterilization_count").eq("id",e).eq("facility_id",r).single();if(a||!i)return null;const s=i;if(s.last_sterilized){const o=new Date(s.last_sterilized);return{batchId:`VIRTUAL-${e}`,batchName:`Last Sterilization - ${s.tool_name}`,status:"completed",totalItems:1,createdBy:"System",createdAt:o,completedAt:o}}return null}catch(t){return console.error("Error getting most recent batch for tool:",t),null}})}}var sg=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function G_(c){return sg(this,null,function*(){var e;const{assignedLocation:t,toolsCount:r}=c;if(!t||t.trim()==="")return{status:"unassigned",confidence:1,reasoning:"No location assigned to batch"};if(r===0)return{status:"unassigned",confidence:1,reasoning:"No tools in batch to assign location"};try{const{data:{user:i}}=yield d.auth.getUser(),a=(e=i==null?void 0:i.user_metadata)==null?void 0:e.facility_id;if(!a)return{status:"invalid_location",confidence:.8,reasoning:"Cannot validate location without facility context"};const{data:s,error:o}=yield d.from("rooms").select("id, name").eq("facility_id",a).ilike("name",`%${t}%`).limit(1);return o||!s||s.length===0?{status:"invalid_location",confidence:.9,reasoning:`Location "${t}" not found in facility`}:{status:"valid",confidence:1,reasoning:`Location "${t}" validated successfully`}}catch(i){return console.error("Location validation failed:",i),{status:"invalid_location",confidence:.3,reasoning:"Location validation error occurred"}}})}var cg=Object.defineProperty,lg=Object.defineProperties,ug=Object.getOwnPropertyDescriptors,Qo=Object.getOwnPropertySymbols,dg=Object.prototype.hasOwnProperty,hg=Object.prototype.propertyIsEnumerable,Yo=(c,e,t)=>e in c?cg(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,fg=(c,e)=>{for(var t in e||(e={}))dg.call(e,t)&&Yo(c,t,e[t]);if(Qo)for(var t of Qo(e))hg.call(e,t)&&Yo(c,t,e[t]);return c},mg=(c,e)=>lg(c,ug(e));class pg{constructor(){this.events=[],this.MAX_EVENTS=1e4}recordEvent(e){const t=mg(fg({},e),{id:`analytics_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date().toISOString()});this.events.push(t),this.events.length>this.MAX_EVENTS&&(this.events=this.events.slice(-this.MAX_EVENTS)),this.sendToExternalAnalytics(t),console.log("ðŸ“Š Analytics Event:",t)}sendToExternalAnalytics(e){try{console.log("ðŸ“ˆ External Analytics:",{service:"tracking_analytics",eventType:e.eventType,toolId:e.toolId,doctorName:e.doctorName,timestamp:e.timestamp})}catch(t){console.warn("Failed to send to external analytics:",t)}}recordTrackStarted(e,t,r,i,a,s){this.recordEvent({eventType:"track_started",toolId:e,toolName:t,doctorName:r,priority:i,metadata:{queuePosition:a,totalInQueue:s}})}recordTrackStopped(e,t,r,i,a){this.recordEvent({eventType:"track_stopped",toolId:e,toolName:t,doctorName:r,priority:i,metadata:{waitTime:a}})}recordToolAvailable(e,t,r,i,a){this.recordEvent({eventType:"tool_available",toolId:e,toolName:t,doctorName:r,priority:i,metadata:{waitTime:a}})}recordToolClaimed(e,t,r,i,a){this.recordEvent({eventType:"tool_claimed",toolId:e,toolName:t,doctorName:r,priority:i,metadata:{waitTime:a}})}recordQueuePositionChanged(e,t,r,i,a,s,o){this.recordEvent({eventType:"queue_position_changed",toolId:e,toolName:t,doctorName:r,priority:i,metadata:{queuePosition:a,totalInQueue:o,previousPosition:s}})}getAnalyticsSummary(e){let t=this.events;e&&(t=this.events.filter(m=>{const p=new Date(m.timestamp);return p>=e.start&&p<=e.end}));const r=t.length,i=new Set(t.map(m=>m.toolId)).size,a=new Set(t.map(m=>m.doctorName)).size,s=t.filter(m=>{var p;return(p=m.metadata)==null?void 0:p.waitTime}),o=s.length>0?s.reduce((m,p)=>{var y;return m+(((y=p.metadata)==null?void 0:y.waitTime)||0)},0)/s.length:0,n=new Map;t.forEach(m=>{if(m.eventType==="track_started"){const p=n.get(m.toolId)||{toolName:m.toolName,count:0};p.count++,n.set(m.toolId,p)}});const l=Array.from(n.entries()).map(([m,p])=>({toolId:m,toolName:p.toolName,trackingCount:p.count})).sort((m,p)=>p.trackingCount-m.trackingCount).slice(0,10),u={high:t.filter(m=>m.priority==="high").length,medium:t.filter(m=>m.priority==="medium").length,low:t.filter(m=>m.priority==="low").length},h=Array.from({length:24},(m,p)=>({hour:p,count:t.filter(y=>new Date(y.timestamp).getHours()===p).length})),f=Array.from({length:30},(m,p)=>{const y=new Date;y.setDate(y.getDate()-p);const g=y.toISOString().split("T")[0];return{date:g,count:t.filter(_=>_.timestamp.split("T")[0]===g).length}}).reverse();return{totalTrackingEvents:r,uniqueToolsTracked:i,uniqueUsersTracking:a,averageQueueWaitTime:o,mostTrackedTools:l,trackingByPriority:u,trackingByHour:h,trackingByDay:f}}getToolAnalytics(e){return this.events.filter(t=>t.toolId===e)}getUserAnalytics(e){return this.events.filter(t=>t.doctorName===e)}clearOldEvents(e=30){const t=new Date;t.setDate(t.getDate()-e),this.events=this.events.filter(r=>new Date(r.timestamp)>t)}}const Tn=new pg;class gg{constructor(){this.statusCallbacks=[],this.toolStatuses=new Map,this.monitoringInterval=null,this.MONITORING_INTERVAL=3e4}startMonitoring(){this.monitoringInterval||(console.log("ðŸ”„ Starting real-time tool status monitoring..."),this.monitoringInterval=setInterval(()=>{this.checkToolStatuses()},this.MONITORING_INTERVAL))}stopMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null,console.log("â¹ï¸ Stopped real-time tool status monitoring"))}subscribe(e){return this.statusCallbacks.push(e),()=>{const t=this.statusCallbacks.indexOf(e);t>-1&&this.statusCallbacks.splice(t,1)}}checkToolStatuses(){const e=Array.from(this.toolStatuses.keys());if(e.length===0){[{id:"demo-tool-1",name:"Surgical Scissors",status:"available"},{id:"demo-tool-2",name:"Forceps",status:"in_use"},{id:"demo-tool-3",name:"Scalpel",status:"unavailable"}].forEach(r=>{this.toolStatuses.set(r.id,r.status)});return}e.forEach(t=>{if(Math.random()<.05){const r=this.toolStatuses.get(t),i=this.getRandomStatus(r);i!==r&&this.handleStatusChange(t,r,i)}})}getRandomStatus(e){const r=["available","unavailable","in_use","maintenance"].filter(i=>i!==e);return r[Math.floor(Math.random()*r.length)]}handleStatusChange(e,t,r){this.toolStatuses.set(e,r);const i={toolId:e,toolName:`Tool ${e.slice(0,8)}...`,oldStatus:t,newStatus:r,timestamp:new Date().toISOString(),reason:this.getStatusChangeReason(t,r)};(t==="unavailable"||r==="unavailable"||t==="maintenance"||r==="maintenance")&&console.log("ðŸ“Š Tool status changed:",i),this.statusCallbacks.forEach(a=>{try{a(i)}catch(s){console.error("Error in status change callback:",s)}})}getStatusChangeReason(e,t){var r;return((r={available:{in_use:"Tool was checked out",unavailable:"Tool was removed from inventory",maintenance:"Tool sent for maintenance"},in_use:{available:"Tool was returned",unavailable:"Tool was damaged during use",maintenance:"Tool requires maintenance after use"},unavailable:{available:"Tool was repaired and returned",in_use:"Tool was checked out despite being unavailable",maintenance:"Tool sent for repair"},maintenance:{available:"Maintenance completed successfully",unavailable:"Tool requires replacement after maintenance",in_use:"Tool checked out after maintenance"}}[e])==null?void 0:r[t])||"Status changed"}triggerStatusChange(e,t,r){const i=this.toolStatuses.get(e)||"available",a={toolId:e,toolName:r||`Tool ${e.slice(0,8)}...`,oldStatus:i,newStatus:t,timestamp:new Date().toISOString(),reason:this.getStatusChangeReason(i,t)};this.toolStatuses.set(e,t),this.statusCallbacks.forEach(s=>{try{s(a)}catch(o){console.error("Error in status change callback:",o)}})}getToolStatus(e){return this.toolStatuses.get(e)}getAllToolStatuses(){return new Map(this.toolStatuses)}isMonitoring(){return this.monitoringInterval!==null}}const _c=new gg,W_=Object.freeze(Object.defineProperty({__proto__:null,realTimeStatusMonitor:_c},Symbol.toStringTag,{value:"Module"}));var Ei=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class yg{constructor(){this.SYNC_INTERVAL=3e4,this.syncInterval=null,this.pendingSyncs=new Map}startAutoSync(){this.syncInterval||(console.log("ðŸ”„ Starting automatic database synchronization..."),this.syncInterval=setInterval(()=>{this.syncAllPendingChanges()},this.SYNC_INTERVAL))}stopAutoSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null,console.log("â¹ï¸ Stopped automatic database synchronization"))}queueSync(e){const t=`${e.toolId}-${e.doctorName}`;this.pendingSyncs.set(t,e),console.log("ðŸ“ Queued sync for:",{toolId:e.toolId,doctorName:e.doctorName,priority:e.priority,status:e.status})}syncAllPendingChanges(){return Ei(this,null,function*(){if(this.pendingSyncs.size===0)return{success:!0,syncedCount:0};console.log(`ðŸ”„ Syncing ${this.pendingSyncs.size} pending changes...`);try{const e=yield this.performDatabaseSync(Array.from(this.pendingSyncs.values()));return e.success?(this.pendingSyncs.clear(),console.log(`âœ… Successfully synced ${e.syncedCount} changes`)):console.error("âŒ Database sync failed:",e.error),e}catch(e){return console.error("âŒ Database sync error:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}})}performDatabaseSync(e){return Ei(this,null,function*(){yield new Promise(r=>setTimeout(r,1e3));const t=Math.random()>.1;return{success:t,syncedCount:e.length,error:t?void 0:"Simulated database error"}})}syncImmediate(e){return Ei(this,null,function*(){try{const t=yield this.performDatabaseSync([e]);if(t.success){const r=`${e.toolId}-${e.doctorName}`;this.pendingSyncs.delete(r)}return t}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}})}getPendingSyncCount(){return this.pendingSyncs.size}getPendingSyncs(){return Array.from(this.pendingSyncs.values())}clearPendingSyncs(){this.pendingSyncs.clear(),console.log("ðŸ—‘ï¸ Cleared all pending syncs")}isAutoSyncRunning(){return this.syncInterval!==null}forceSync(){return Ei(this,null,function*(){return console.log("ðŸ”„ Force syncing all pending changes..."),yield this.syncAllPendingChanges()})}}const kn=new yg;var _g=Object.defineProperty,vg=Object.defineProperties,wg=Object.getOwnPropertyDescriptors,Jo=Object.getOwnPropertySymbols,Ig=Object.prototype.hasOwnProperty,Sg=Object.prototype.propertyIsEnumerable,Xo=(c,e,t)=>e in c?_g(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,bg=(c,e)=>{for(var t in e||(e={}))Ig.call(e,t)&&Xo(c,t,e[t]);if(Jo)for(var t of Jo(e))Sg.call(e,t)&&Xo(c,t,e[t]);return c},Eg=(c,e)=>vg(c,wg(e));class Ag{constructor(){this.notifications=[],this.priorityQueue=[],this.statusChangeCallbacks=[],_c.subscribe(this.handleToolStatusChange.bind(this)),kn.startAutoSync()}trackTool(e,t,r="medium",i){const a=this.priorityQueue.findIndex(l=>l.toolId===e&&l.doctorName===t);a>=0?this.priorityQueue[a]=Eg(bg({},this.priorityQueue[a]),{timestamp:new Date().toISOString(),priority:r,status:"waiting"}):this.priorityQueue.push({toolId:e,doctorName:t,timestamp:new Date().toISOString(),priority:r,status:"waiting"}),this.syncWithDatabase(e,!0);const s=this.getToolTrackers(e).length,o=this.getQueuePosition(e,t);console.log("ðŸ”” Tool tracked:",{toolId:e,totalInQueue:s,queuePosition:o,doctorName:t});const n=i||`Tool ${e}`;Jr.notifyToolAvailable(e,n,o,s,r),Tn.recordTrackStarted(e,n,t,r,o,s)}untrackTool(e,t){const r=this.priorityQueue.findIndex(i=>i.toolId===e&&i.doctorName===t);if(r>=0){const i=this.getToolTrackers(e),a=this.priorityQueue[r];this.priorityQueue.splice(r,1),this.notifyQueuePositionChanges(e,i,a.doctorName);const s=this.priorityQueue.some(o=>o.toolId===e);this.syncWithDatabase(e,s),Tn.recordTrackStopped(e,`Tool ${e}`,t,a.priority)}}notifyQueuePositionChanges(e,t,r){const i=this.getToolTrackers(e);t.forEach((a,s)=>{a.doctorName!==r&&i.findIndex(o=>o.doctorName===a.doctorName)})}isToolTracked(e){return this.priorityQueue.some(t=>t.toolId===e)}getToolTrackers(e){return this.priorityQueue.filter(t=>t.toolId===e).sort((t,r)=>{const i={high:3,medium:2,low:1},a=i[r.priority]-i[t.priority];return a!==0?a:new Date(t.timestamp).getTime()-new Date(r.timestamp).getTime()})}monitorToolStatusChange(e,t,r){(r==="available"||r==="complete")&&this.handleToolBecameAvailable(e),t==="available"&&(r==="in_use"||r==="sterilizing")&&this.handleToolBecameUnavailable(e,`Tool ${e}`),this.statusChangeCallbacks.forEach(i=>i(e,t,r))}handleToolBecameAvailable(e){const t=this.getToolTrackers(e);if(t.length===0)return;const r={high:3,medium:2,low:1},i=[...t].sort((o,n)=>r[n.priority]-r[o.priority]),a=i[0];if(a&&a.status==="waiting"){const o=`Tool ${e}`;Jr.notifyToolAvailable(e,o,1,t.length);const n={id:`notification_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,toolId:e,toolName:o,doctorName:a.doctorName,timestamp:new Date().toISOString(),status:"pending",priority:a.priority,message:"Your tracked tool is now available! You have first priority to claim it."};this.notifications.push(n),a.status="notified"}i.map(o=>o.doctorName===a.doctorName?a:o).forEach(o=>{const n=this.priorityQueue.findIndex(l=>l.toolId===e&&l.doctorName===o.doctorName);n>=0&&(this.priorityQueue[n]=o)})}acknowledgeNotification(e){const t=this.notifications.find(r=>r.id===e);if(t){t.status="acknowledged";const r=this.priorityQueue.find(i=>i.toolId===t.toolId&&i.doctorName===t.doctorName);r&&(r.status="claimed")}}getPendingNotifications(e){return this.notifications.filter(t=>t.doctorName===e&&t.status==="pending")}getAllNotifications(e){return this.notifications.filter(t=>t.doctorName===e)}clearExpiredNotifications(){const e=new Date(Date.now()-864e5);this.notifications=this.notifications.filter(t=>{const r=new Date(t.timestamp)<e;return r&&t.status==="pending"&&(t.status="expired"),!r})}subscribeToStatusChanges(e){return this.statusChangeCallbacks.push(e),()=>{const t=this.statusChangeCallbacks.indexOf(e);t>=0&&this.statusChangeCallbacks.splice(t,1)}}isCleanStatus(e){const t=e.toLowerCase();return["clean","active"].includes(t)}getPriorityQueue(e){return this.priorityQueue.filter(t=>t.toolId===e).sort((t,r)=>{const i={high:3,medium:2,low:1},a=i[r.priority]-i[t.priority];return a!==0?a:new Date(t.timestamp).getTime()-new Date(r.timestamp).getTime()})}getTrackedToolsForDoctor(e){return this.priorityQueue.filter(t=>t.doctorName===e)}syncWithDatabase(e,t){const r=this.getToolTrackers(e);if(t&&r.length>0)r.forEach(i=>{const a={toolId:e,doctorName:i.doctorName,priority:i.priority,timestamp:i.timestamp,status:i.status};kn.queueSync(a)});else{const i={toolId:e,doctorName:"system",priority:"medium",timestamp:new Date().toISOString(),status:"expired"};kn.queueSync(i)}console.log(`ðŸ“ Queued database sync for tool ${e}: ${t?"tracked":"untracked"}`)}getQueuePosition(e,t){const r=this.getToolTrackers(e),i={high:3,medium:2,low:1},s=[...r].sort((o,n)=>{const l=i[n.priority]-i[o.priority];return l!==0?l:new Date(o.timestamp).getTime()-new Date(n.timestamp).getTime()}).findIndex(o=>o.doctorName===t);return s>=0?s+1:0}getTrackingStats(){const e=this.priorityQueue.length,t=this.priorityQueue.filter(s=>s.priority==="high").length,r=this.priorityQueue.filter(s=>s.priority==="medium").length,i=this.priorityQueue.filter(s=>s.priority==="low").length,a=this.notifications.filter(s=>s.status==="pending").length;return{totalTracked:e,highPriority:t,mediumPriority:r,lowPriority:i,pendingNotifications:a}}handleToolStatusChange(e){const t=this.getToolTrackers(e.toolId);t.length!==0&&(console.log("ðŸ”„ Tool status changed:",{toolId:e.toolId,toolName:e.toolName,oldStatus:e.oldStatus,newStatus:e.newStatus,trackers:t.length}),e.newStatus==="available"&&e.oldStatus!=="available"?this.handleToolBecameAvailable(e.toolId):e.newStatus==="unavailable"&&e.oldStatus==="available"?this.handleToolBecameUnavailable(e.toolId,e.toolName):e.newStatus==="in_use"&&e.oldStatus==="available"&&this.handleToolWasCheckedOut(e.toolId,e.toolName),Tn.recordToolAvailable(e.toolId,e.toolName,"Test Doctor","medium",void 0))}handleToolBecameUnavailable(e,t){const r=this.getToolTrackers(e);r.forEach(i=>{Jr.notifyToolUnavailable(e,t,void 0,r.length)})}handleToolWasCheckedOut(e,t){const r=this.getToolTrackers(e);r.forEach(i=>{Jr.notifyToolUnavailable(e,t,void 0,r.length)})}}const K_=new Ag;var Tg=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const Q_={analyzeScan(c){return Tg(this,null,function*(){const{barcode:e,mode:t,userId:r,facilityId:i}=c;if(!e)return{recommendation:"Invalid barcode",confidence:1};try{yield d.from("ai_scan_audit").insert([{barcode:e,mode:t,user_id:r||null,facility_id:i||null,event_context:c}])}catch(a){}return{recommendation:t==="add"?"Confirm inventory addition and set expiry date.":t==="use"?"Deduct from stock and log usage.":"Flag anomalies for review.",confidence:.85}})}};class rt extends Error{constructor(e,t,r,i){super(e),this.code=t,this.statusCode=r,this.details=i,this.name="EnvironmentalCleanServiceError"}}const _t={NETWORK_ERROR:"Unable to connect to the server. Please check your internet connection.",TIMEOUT_ERROR:"The request took too long to complete. Please try again.",UNAUTHORIZED:"You don't have permission to perform this action. Please contact your administrator.",NOT_FOUND:"The requested resource was not found.",VALIDATION_ERROR:"The provided data is invalid. Please check your input and try again.",SERVER_ERROR:"A server error occurred. Please try again later.",UNKNOWN_ERROR:"An unexpected error occurred. Please try again."},ut=(c,e)=>{if(c instanceof rt)return c;const t=c instanceof Error?c.message:String(c);return t.includes("fetch")||t.includes("network")||t.includes("ENOTFOUND")?new rt(_t.NETWORK_ERROR,"NETWORK_ERROR",void 0,{originalError:t,context:e}):t.includes("timeout")||t.includes("ETIMEDOUT")?new rt(_t.TIMEOUT_ERROR,"TIMEOUT_ERROR",void 0,{originalError:t,context:e}):t.includes("401")||t.includes("unauthorized")?new rt(_t.UNAUTHORIZED,"UNAUTHORIZED",401,{originalError:t,context:e}):t.includes("404")||t.includes("not found")?new rt(_t.NOT_FOUND,"NOT_FOUND",404,{originalError:t,context:e}):t.includes("422")||t.includes("validation")?new rt(_t.VALIDATION_ERROR,"VALIDATION_ERROR",422,{originalError:t,context:e}):t.includes("500")||t.includes("server error")?new rt(_t.SERVER_ERROR,"SERVER_ERROR",500,{originalError:t,context:e}):new rt(_t.UNKNOWN_ERROR,"UNKNOWN_ERROR",void 0,{originalError:t,context:e})},Cn=c=>({pending:"Dirty",in_progress:"In Progress",completed:"Clean",verified:"Clean",clean:"Clean",failed:"Supervisor",cancelled:"Out of Service",dirty:"Dirty"})[c]||"Dirty",Zo=c=>({Dirty:"dirty","In Progress":"in_progress",Clean:"clean","Out of Service":"cancelled",Supervisor:"pending",Isolation:"failed",Quarantine:"failed",Maintenance:"pending","Equipment Failure":"failed","Patient Occupied":"pending","Discharge Cleaning":"pending",Unassigned:"pending","Audit Required":"pending"})[c]||"dirty";var wt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const Ut=()=>wt(null,null,function*(){return yield kt.getCurrentFacilityId()});class Ft{static fetchRooms(){return wt(this,null,function*(){try{const e=yield Ut(),t=d.from("environmental_cleans_enhanced").select(`
          id,
          room_id,
          room_name,
          status,
          cleaning_type,
          scheduled_time,
          completed_time,
          quality_score,
          compliance_score,
          created_at,
          updated_at
        `).eq("facility_id",e),{data:r,error:i}=yield t.order("scheduled_time",{ascending:!1});if(i)throw i;return(r!=null?r:[]).map(s=>{var o,n,l,u,h;const f=Cn(s.status);return{id:s.room_id||s.id,name:s.room_name||`Room ${s.room_id||s.id}`,status:f,metadata:{cleaningType:(o=s.cleaning_type)!=null?o:"",qualityScore:(n=s.quality_score)!=null?n:0,complianceScore:(l=s.compliance_score)!=null?l:0,scheduledTime:(u=s.scheduled_time)!=null?u:"",completedTime:(h=s.completed_time)!=null?h:void 0},createdAt:s.created_at,updatedAt:s.updated_at}})}catch(e){return console.warn("Environmental Clean rooms fetch failed, falling back to static data:",e),[{id:"room-1",name:"Operating Room 1",status:"pending",metadata:{cleaningType:"surgical",qualityScore:95,complianceScore:98,scheduledTime:new Date().toISOString(),completedTime:void 0},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"room-2",name:"Recovery Room A",status:"in_progress",metadata:{cleaningType:"standard",qualityScore:87,complianceScore:92,scheduledTime:new Date().toISOString(),completedTime:void 0},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"room-3",name:"ICU Room 3",status:"completed",metadata:{cleaningType:"intensive",qualityScore:99,complianceScore:100,scheduledTime:new Date().toISOString(),completedTime:new Date().toISOString()},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}]}})}static updateRoomStatus(e,t){return wt(this,null,function*(){try{const r=yield Ut(),i=d.from("environmental_cleans_enhanced").update({status:Zo(t),updated_at:new Date().toISOString()}).eq("room_id",e).eq("facility_id",r),{error:a}=yield i;if(a)throw a;St.log("environmental_clean","room_status_updated",{roomId:e,status:t,timestamp:new Date().toISOString()})}catch(r){const i=ut(r,"updateRoomStatus");throw console.error("âŒ Failed to update room status:",i),i}})}static createEnvironmentalClean(e){return wt(this,null,function*(){var t,r,i,a;try{const s=yield Ut(),o={room_id:(t=e.id)!=null?t:"",room_name:(r=e.name)!=null?r:"",status:"pending",cleaning_type:"routine",scheduled_time:new Date().toISOString(),checklist_items:[],completed_items:[],failed_items:[],facility_id:s},{data:n,error:l}=yield d.from("environmental_cleans_enhanced").insert(o).select().single();if(l||!n)throw l!=null?l:new Error("Insert failed");const u={id:n.room_id,name:n.room_name||`Room ${n.room_id}`,status:Cn(n.status),metadata:{cleaningType:(i=n.cleaning_type)!=null?i:"",scheduledTime:(a=n.scheduled_time)!=null?a:""},createdAt:n.created_at,updatedAt:n.updated_at};return St.log("environmental_clean","room_created",{roomId:u.id,roomName:u.name}),u}catch(s){const o=ut(s,"createEnvironmentalClean");throw console.error("âŒ Failed to create environmental clean:",o),o}})}static updateEnvironmentalClean(e,t){return wt(this,null,function*(){var r,i,a,s,o;try{const n=yield Ut(),l={updated_at:new Date().toISOString()};t.name&&(l.room_name=t.name),t.status&&(l.status=Zo(t.status));const u=d.from("environmental_cleans_enhanced").update(l).eq("room_id",e).eq("facility_id",n),{data:h,error:f}=yield u.select().single();if(f||!h)throw f!=null?f:new Error("Update failed");const m={id:h.room_id,name:h.room_name||`Room ${h.room_id}`,status:Cn(h.status),metadata:{cleaningType:(r=h.cleaning_type)!=null?r:"",qualityScore:(i=h.quality_score)!=null?i:0,complianceScore:(a=h.compliance_score)!=null?a:0,scheduledTime:(s=h.scheduled_time)!=null?s:"",completedTime:(o=h.completed_time)!=null?o:void 0},createdAt:h.created_at,updatedAt:h.updated_at};return St.log("environmental_clean","room_updated",{roomId:m.id,roomName:m.name}),m}catch(n){const l=ut(n,"updateEnvironmentalClean");throw console.error("âŒ Failed to update environmental clean:",l),l}})}static deleteEnvironmentalClean(e){return wt(this,null,function*(){try{const t=yield Ut(),r=d.from("environmental_cleans_enhanced").delete().eq("room_id",e).eq("facility_id",t),{error:i}=yield r;if(i)throw i;St.log("environmental_clean","room_deleted",{roomId:e})}catch(t){const r=ut(t,"deleteEnvironmentalClean");throw console.error("âŒ Failed to delete environmental clean:",r),r}})}static completeRoomCleaning(e){return wt(this,null,function*(){try{if(!e)throw new Error("Room ID is required");const t=yield Ut(),r=d.from("environmental_cleans_enhanced").update({status:"completed",completed_time:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("room_id",e).eq("facility_id",t),{error:i}=yield r;if(i)throw i;St.log("environmental_clean","room_cleaning_completed",{roomId:e,timestamp:new Date().toISOString()})}catch(t){const r=ut(t,"completeRoomCleaning");throw console.error("âŒ Error completing room cleaning:",r),r}})}}var Ai=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Ti{static fetchAnalytics(){return Ai(this,null,function*(){try{console.log("ðŸ“Š Fetching analytics from Supabase...");const{data:e,error:t}=yield d.from("environmental_cleans_enhanced").select("status, completed_time, scheduled_time, created_at");if(t)throw t;const r=e||[],i=r.length,a=r.filter(_=>_.status==="clean"||_.status==="completed"||_.status==="verified").length,s=r.filter(_=>_.status==="dirty"||_.status==="pending").length,o=r.filter(_=>_.status==="in_progress").length,n=r.filter(_=>_.status==="biohazard").length,l=r.filter(_=>_.status==="theft").length,u=r.filter(_=>_.status==="low_inventory").length,h=r.filter(_=>_.status==="out_of_service").length,f=r.filter(_=>_.status==="public_areas").length,m=i>0?Math.round(a/i*100):0,p=r.filter(_=>_.completed_time&&_.scheduled_time);let y=0;if(p.length>0){const _=p.reduce((w,E)=>{const b=new Date(E.scheduled_time).getTime(),P=new Date(E.completed_time).getTime();return w+(P-b)},0);y=Math.round(_/p.length/(1e3*60))}const g={totalRooms:i,cleanRooms:a,dirtyRooms:s,inProgressRooms:o,biohazardRooms:n,theftRooms:l,lowInventoryRooms:u,outOfServiceRooms:h,publicAreas:f,cleaningEfficiency:m,averageCleaningTime:y,lastUpdated:new Date().toISOString()};return console.log("âœ… Analytics fetched successfully:",g),g}catch(e){throw console.error("âŒ Error fetching analytics:",e),e}})}static getRoomCountsByStatus(){return Ai(this,null,function*(){try{console.log("ðŸ“Š Fetching room counts from Supabase...");const{data:e,error:t}=yield d.from("environmental_cleans_enhanced").select("status");if(t)throw t;const r=e||[],i={completed:r.filter(a=>a.status==="clean"||a.status==="completed").length,pending:r.filter(a=>a.status==="dirty"||a.status==="pending").length,in_progress:r.filter(a=>a.status==="in_progress").length,failed:r.filter(a=>a.status==="failed").length,cancelled:r.filter(a=>a.status==="cancelled").length,verified:r.filter(a=>a.status==="verified").length};return console.log("âœ… Room counts fetched successfully:",i),i}catch(e){throw console.error("âŒ Error getting room counts by status:",e),e}})}static getRecentlyCompletedCleanings(e=10){return Ai(this,null,function*(){try{const{data:t,error:r}=yield d.from("environmental_cleans_enhanced").select("room_name, completed_time, cleaner_id").eq("status","clean").not("completed_time","is",null).order("completed_time",{ascending:!1}).limit(e);if(r)throw r;return(t||[]).map(s=>({room:s.room_name||"Unknown Room",cleanedAt:s.completed_time,cleanedBy:s.cleaner_id?`Cleaner ${s.cleaner_id}`:"System"}))}catch(t){throw console.error("âŒ Error getting recently completed cleanings:",t),t}})}static getCleaningEfficiencyTrends(e=7){return Ai(this,null,function*(){try{const t=new Date;t.setDate(t.getDate()-e);const{data:r,error:i}=yield d.from("environmental_cleans_enhanced").select("status, completed_time, scheduled_time, created_at").gte("created_at",t.toISOString()).order("created_at",{ascending:!1});if(i)throw i;const a=r||[],s={};return a.forEach(o=>{const n=new Date(o.created_at).toISOString().split("T")[0];s[n]||(s[n]={completed:0,total:0,efficiency:0}),s[n].total++,(o.status==="completed"||o.status==="verified")&&s[n].completed++}),Object.keys(s).forEach(o=>{const n=s[o];n.efficiency=n.total>0?Math.round(n.completed/n.total*100):0}),s}catch(t){throw console.error("âŒ Error getting cleaning efficiency trends:",t),t}})}}var kg=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Cg{static fetchChecklists(){return kg(this,null,function*(){try{console.log("ðŸ” Fetching environmental cleaning checklists...");const{data:e,error:t}=yield d.from("environmental_cleaning_task_categories").select("*").eq("is_active",!0).order("sort_order",{ascending:!0});if(t)throw console.error("âŒ Supabase error:",t),t;return console.log("âœ… Checklists fetched successfully:",(e==null?void 0:e.length)||0,"records"),(e||[]).map(r=>{var i,a,s,o;return{id:r.id,name:r.name,description:(i=r.data)==null?void 0:i.description,items:[],isActive:!!((a=r.is_active)==null||a),createdAt:String((s=r.created_at)!=null?s:new Date().toISOString()),updatedAt:String((o=r.updated_at)!=null?o:new Date().toISOString())}})}catch(e){throw console.error("âŒ Error fetching checklists:",e),ut(e,"fetchChecklists")}})}}var es=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ts{static fetchRecentlyCleanedRooms(e=10){return es(this,null,function*(){try{const{data:t,error:r}=yield d.from("environmental_cleans_enhanced").select(`
          room_name,
          completed_time,
          cleaner_id
        `).eq("status","clean").not("completed_time","is",null).order("completed_time",{ascending:!1}).limit(e);if(r)throw console.error("âŒ Supabase error:",r),r;return(t||[]).map(a=>({room:a.room_name||"Unknown Room",cleanedAt:a.completed_time,cleanedBy:a.cleaner_id?`Cleaner ${a.cleaner_id}`:"System"}))}catch(t){console.error("âŒ Raw error in fetchRecentlyCleanedRooms:",t);const r=ut(t,"fetchRecentlyCleanedRooms");throw console.error("âŒ Failed to fetch recently cleaned rooms:",r),r}})}static scanRoomBarcode(e){return es(this,null,function*(){try{if(!e||e.trim()==="")return{success:!1,message:"Please enter a valid barcode"};const{useRoomStore:t}=yield T(()=>import("./components-CrSzLpHe.js").then(a=>a.au),__vite__mapDeps([0,1,2,3,4,5,6,7])),i=t.getState().getRoomByBarcode(e.trim());return i?(St.log("environmental_clean","room_scan",{barcode:e,roomId:i.id,roomName:i.name}),{success:!0,room:{id:i.barcode||i.id,name:i.name,status:"dirty"},message:`Successfully scanned room: ${i.name}`}):{success:!1,message:`Room with barcode "${e}" not found. Please check the barcode or add the room in Settings.`}}catch(t){return console.error("âŒ Error scanning room barcode:",t),{success:!1,message:"An error occurred while scanning the barcode. Please try again."}}})}}var Pg=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Dg{static batchEnvironmentalCleanAction(e){return Pg(this,arguments,function*({ids:t,action:r}){try{const i={updated_at:new Date().toISOString()};switch(r){case"mark_completed":i.status="completed",i.completed_time=new Date().toISOString();break;case"mark_in_progress":i.status="in_progress",i.started_time=new Date().toISOString();break;case"mark_verified":i.status="verified",i.verified_time=new Date().toISOString();break;default:throw new Error(`Unknown action: ${r}`)}const{error:a}=yield d.from("environmental_cleans_enhanced").update(i).in("room_id",t);if(a)throw a;return St.log("environmental_clean","batch_action",{action:r,roomIds:t,count:t.length}),{success:!0}}catch(i){const a=ut(i,"batchEnvironmentalCleanAction");throw console.error("âŒ Failed to perform batch action:",a),a}})}}var Og=Object.defineProperty,Rg=Object.defineProperties,$g=Object.getOwnPropertyDescriptors,rs=Object.getOwnPropertySymbols,Mg=Object.prototype.hasOwnProperty,qg=Object.prototype.propertyIsEnumerable,is=(c,e,t)=>e in c?Og(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,zg=(c,e)=>{for(var t in e||(e={}))Mg.call(e,t)&&is(c,t,e[t]);if(rs)for(var t of rs(e))qg.call(e,t)&&is(c,t,e[t]);return c},Ug=(c,e)=>Rg(c,$g(e));class nr{constructor(){this.usageData=new Map,this.STORAGE_KEY="inventory_usage_data",this.loadUsageData()}static getInstance(){return nr.instance||(nr.instance=new nr),nr.instance}loadUsageData(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e),r=Object.fromEntries(Object.entries(t).map(([i,a])=>{const s=a;return[i,Ug(zg({},s),{lastUsed:new Date(s.lastUsed)})]}));this.usageData=new Map(Object.entries(r))}}catch(e){console.error(e),console.warn("Failed to load usage data:")}}saveUsageData(){try{const e=Object.fromEntries(this.usageData);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error(e),console.warn("Failed to save usage data:")}}getOrCreateUsageData(e){const t=this.usageData.get(e);if(!t){const r={itemId:e,usageCount:0,lastUsed:new Date,searchCount:0,favoriteCount:0,trackCount:0};return this.usageData.set(e,r),r}return t}trackItemView(e){const t=this.getOrCreateUsageData(e);t.usageCount+=1,t.lastUsed=new Date,this.saveUsageData()}trackItemSearch(e){const t=this.getOrCreateUsageData(e);t.searchCount+=1,t.lastUsed=new Date,this.saveUsageData()}trackItemFavorite(e){const t=this.getOrCreateUsageData(e);t.favoriteCount+=1,t.lastUsed=new Date,this.saveUsageData()}trackItemTrack(e){const t=this.getOrCreateUsageData(e);t.trackCount+=1,t.lastUsed=new Date,this.saveUsageData()}calculateSmartScore(e){const t=this.usageData.get(e);if(!t)return 0;const r=new Date;let i;try{i=t.lastUsed instanceof Date?t.lastUsed:new Date(t.lastUsed),isNaN(i.getTime())&&(i=new Date)}catch(o){console.error(o),i=new Date}const a=(r.getTime()-i.getTime())/(1e3*60*60*24);let s=t.usageCount*10;return a<=7&&(s+=50),s+=t.searchCount*5,s+=t.favoriteCount*20,s+=t.trackCount*15,a>30&&(s*=.8),Math.round(s)}getSmartRanking(e){return[...e].sort((t,r)=>{var i,a,s,o,n,l,u,h;const f=t.toolId||t.supplyId||t.equipmentId||t.hardwareId||((i=t.data)==null?void 0:i.toolId)||((a=t.data)==null?void 0:a.supplyId)||((s=t.data)==null?void 0:s.equipmentId)||((o=t.data)==null?void 0:o.hardwareId)||"",m=r.toolId||r.supplyId||r.equipmentId||r.hardwareId||((n=r.data)==null?void 0:n.toolId)||((l=r.data)==null?void 0:l.supplyId)||((u=r.data)==null?void 0:u.equipmentId)||((h=r.data)==null?void 0:h.hardwareId)||"",p=this.calculateSmartScore(f);return this.calculateSmartScore(m)-p})}getUsageStats(){return Object.fromEntries(this.usageData)}clearUsageData(){this.usageData.clear(),localStorage.removeItem(this.STORAGE_KEY)}}nr.getInstance();var oe=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Fg{static addAuditLog(e,t,r){return oe(this,null,function*(){try{yield d.from("environmental_clean_audit").insert({action:e,room_id:t,user_id:r,timestamp:new Date().toISOString()})}catch(i){console.error("Audit log failed:",i)}})}static fetchRooms(){return oe(this,null,function*(){return Ft.fetchRooms()})}static fetchChecklists(){return oe(this,null,function*(){return Cg.fetchChecklists()})}static updateRoomStatus(e,t){return oe(this,null,function*(){return Ft.updateRoomStatus(e,t)})}static completeRoomCleaning(e){return oe(this,null,function*(){return Ft.completeRoomCleaning(e)})}static fetchAnalytics(){return oe(this,null,function*(){return Ti.fetchAnalytics()})}static getRoomCountsByStatus(){return oe(this,null,function*(){return Ti.getRoomCountsByStatus()})}static getRecentlyCompletedCleanings(e=10){return oe(this,null,function*(){return Ti.getRecentlyCompletedCleanings(e)})}static getCleaningEfficiencyTrends(e=7){return oe(this,null,function*(){return Ti.getCleaningEfficiencyTrends(e)})}static fetchRecentlyCleanedRooms(e=10){return oe(this,null,function*(){return ts.fetchRecentlyCleanedRooms(e)})}static scanRoomBarcode(e){return oe(this,null,function*(){return ts.scanRoomBarcode(e)})}static createEnvironmentalClean(e){return oe(this,null,function*(){return Ft.createEnvironmentalClean(e)})}static updateEnvironmentalClean(e,t){return oe(this,null,function*(){return Ft.updateEnvironmentalClean(e,t)})}static deleteEnvironmentalClean(e){return oe(this,null,function*(){return Ft.deleteEnvironmentalClean(e)})}static batchEnvironmentalCleanAction(e){return oe(this,arguments,function*({ids:t,action:r}){return Dg.batchEnvironmentalCleanAction({ids:t,action:r})})}}Fg.supabase=d;var ns=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const Y_={startSession(c){return ns(this,arguments,function*({module:e,metadata:t={}}){const{data:{user:r},error:i}=yield d.auth.getUser();if(i||!r)return console.error("WorkflowService.startSession: No authenticated user found."),null;const{data:a,error:s}=yield d.from("workflow_sessions").insert([{operator_id:r.id,module:e,status:"active",metadata:t}]).select().single();return s?(console.error("WorkflowService.startSession failed:",s.message),null):a})},endSession(c){return ns(this,null,function*(){if(!c){console.warn("WorkflowService.endSession called with no sessionId.");return}const{error:e}=yield d.from("workflow_sessions").update({status:"completed",ended_at:new Date().toISOString()}).eq("id",c);e?console.error("WorkflowService.endSession failed:",e.message):console.info(`Workflow session ${c} successfully closed.`)})}};var Lg=Object.defineProperty,Ng=Object.defineProperties,xg=Object.getOwnPropertyDescriptors,as=Object.getOwnPropertySymbols,Bg=Object.prototype.hasOwnProperty,jg=Object.prototype.propertyIsEnumerable,os=(c,e,t)=>e in c?Lg(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Vg=(c,e)=>{for(var t in e||(e={}))Bg.call(e,t)&&os(c,t,e[t]);if(as)for(var t of as(e))jg.call(e,t)&&os(c,t,e[t]);return c},Hg=(c,e)=>Ng(c,xg(e));class jr{constructor(){this.progressItems=new Map;try{this.loadFromStorage()}catch(e){console.error("[LearningProgressService] Failed to initialize:",e)}}static getInstance(){try{return jr.instance||(jr.instance=new jr),jr.instance}catch(e){return console.error("[LearningProgressService] Failed to get instance:",e),null}}loadFromStorage(){try{if(typeof window=="undefined"||!window.localStorage){console.warn("[LearningProgressService] localStorage not available");return}const e=localStorage.getItem("learningProgress");if(e){const t=JSON.parse(e);this.progressItems.clear(),t.forEach(r=>{this.progressItems.set(r.id,r)})}}catch(e){console.error("[LearningProgressService] Failed to load from storage:",e)}}saveToStorage(){try{if(typeof window=="undefined"||!window.localStorage){console.warn("[LearningProgressService] localStorage not available for saving");return}const e=Array.from(this.progressItems.values());localStorage.setItem("learningProgress",JSON.stringify(e))}catch(e){console.error("[LearningProgressService] Failed to save to storage:",e)}}addToMyList(e){const t=Hg(Vg({},e),{status:"In Progress",updated_at:new Date().toISOString()});this.progressItems.set(e.id,t),this.saveToStorage()}markInProgress(e){const t=this.progressItems.get(e);t&&(t.status="In Progress",t.updated_at=new Date().toISOString(),this.saveToStorage())}getItemStatus(e){const t=this.progressItems.get(e);return t?t.status:"Not Started"}updateItemStatus(e,t){const r=this.progressItems.get(e);r&&(r.status=t,r.updated_at=new Date().toISOString(),this.saveToStorage())}getItemsByCategory(e){return Array.from(this.progressItems.values()).filter(t=>t.category===e)}getAllProgressItems(){return Array.from(this.progressItems.values())}removeItem(e){this.progressItems.delete(e),this.saveToStorage()}isInitialized(){return this.progressItems!==void 0}}class J_{static scanTool(e,t){const r=t.map(s=>s.barcode),i=r[Math.floor(Math.random()*r.length)],a=t.find(s=>s.barcode===i);return a?{success:!0,message:`Successfully processed ${a.name} for ${e} workflow`,tool:a}:{success:!1,message:"No tools available for scanning"}}}var Gg=Object.defineProperty,Wg=Object.defineProperties,Kg=Object.getOwnPropertyDescriptors,ss=Object.getOwnPropertySymbols,Qg=Object.prototype.hasOwnProperty,Yg=Object.prototype.propertyIsEnumerable,cs=(c,e,t)=>e in c?Gg(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,ls=(c,e)=>{for(var t in e||(e={}))Qg.call(e,t)&&cs(c,t,e[t]);if(ss)for(var t of ss(e))Yg.call(e,t)&&cs(c,t,e[t]);return c},Jg=(c,e)=>Wg(c,Kg(e)),He=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const Nr=()=>He(null,null,function*(){return yield kt.getCurrentFacilityId()});class X_{static compressImage(e,t=1200,r=.8){return He(this,null,function*(){return new Promise((i,a)=>{const s=document.createElement("canvas"),o=s.getContext("2d"),n=new Image;n.onload=()=>{const l=Math.min(t/n.width,t/n.height),u=n.width*l,h=n.height*l;s.width=u,s.height=h,o==null||o.drawImage(n,0,0,u,h),s.toBlob(f=>{if(f){const m=new File([f],e.name,{type:"image/jpeg",lastModified:Date.now()});i(m)}else a(new Error("Failed to compress image"))},"image/jpeg",r)},n.onerror=()=>a(new Error("Failed to load image")),n.src=URL.createObjectURL(e)})})}static uploadReceipt(e,t,r){return He(this,null,function*(){try{const i=r||(yield Nr()),a=st(i),{data:{user:s},error:o}=yield a.auth.getUser();if(o||!s)throw new Error("User not authenticated. Please log in again.");const{data:n,error:l}=yield a.from("users").select("facility_id").eq("id",s.id).single();if(l||!(n!=null&&n.facility_id))throw new Error("User facility not found");if(n.facility_id!==i)throw new Error("Unauthorized: tenant mismatch");const u=yield this.compressImage(e.photoFile),h=new Date().toISOString().replace(/[:.]/g,"-"),f=`${s.id}/autoclave-receipt-${e.batchCode}-${h}.jpg`,{error:m}=yield a.storage.from("autoclave-receipts").upload(f,u,{cacheControl:"3600",upsert:!1});if(m)throw new Error(`Failed to upload file: ${m.message}`);const{data:p,error:y}=yield a.storage.from("autoclave-receipts").createSignedUrl(f,3600);if(y)throw y;console.info(`[AutoclaveReceipt] Signed URL created for tenant ${i} â†’ ${f}`);const{data:g,error:_}=yield a.from("autoclave_receipts").insert({receipt_number:e.batchCode,autoclave_id:null,facility_id:n.facility_id,tenant_id:i,photo_url:p.signedUrl,created_at:new Date().toISOString()}).select().single();if(_)throw yield a.storage.from("autoclave-receipts").remove([f]),new Error(`Failed to save receipt metadata: ${_.message}`);return this.mapDatabaseReceipt(g)}catch(i){throw console.error("Error uploading autoclave receipt:",i),i}})}static getReceiptsByBatch(e,t){return He(this,null,function*(){try{const r=t||(yield Nr()),i=st(r),{data:{user:a},error:s}=yield i.auth.getUser();if(s||!a)throw new Error("User not authenticated. Please log in again.");const{data:o,error:n}=yield i.from("users").select("facility_id").eq("id",a.id).single();if(n||!(o!=null&&o.facility_id))throw new Error("User facility not found");if(o.facility_id!==r)throw new Error("Unauthorized: tenant mismatch");const u=i.from("autoclave_receipts").select("*").eq("receipt_number",e).eq("tenant_id",r),{data:h,error:f}=yield u.order("created_at",{ascending:!1});if(f)throw new Error(`Failed to fetch receipts: ${f.message}`);return h.map(this.mapDatabaseReceipt)}catch(r){throw console.error("Error fetching receipts:",r),r}})}static getAllReceipts(e=50,t=0,r){return He(this,null,function*(){try{const i=r||(yield Nr()),a=st(i),{data:{user:s},error:o}=yield a.auth.getUser();if(o||!s)throw new Error("User not authenticated. Please log in again.");const{data:n,error:l}=yield a.from("users").select("facility_id").eq("id",s.id).single();if(l||!(n!=null&&n.facility_id))throw new Error("User facility not found");if(n.facility_id!==i)throw new Error("Unauthorized: tenant mismatch");const h=a.from("autoclave_receipts").select("*").eq("tenant_id",i),{data:f,error:m}=yield h.order("created_at",{ascending:!1}).range(t,t+e-1);if(m)throw new Error(`Failed to fetch receipts: ${m.message}`);return f.map(this.mapDatabaseReceipt)}catch(i){throw console.error("Error fetching all receipts:",i),i}})}static deleteReceipt(e,t){return He(this,null,function*(){try{const r=t||(yield Nr()),i=st(r),{data:{user:a},error:s}=yield i.auth.getUser();if(s||!a)throw new Error("User not authenticated. Please log in again.");const{data:o,error:n}=yield i.from("users").select("facility_id").eq("id",a.id).single();if(n||!(o!=null&&o.facility_id))throw new Error("User facility not found");if(o.facility_id!==r)throw new Error("Unauthorized: tenant mismatch");const u=i.from("autoclave_receipts").select("id").eq("id",e).eq("tenant_id",r),{data:h,error:f}=yield u.single();if(f)throw new Error(`Failed to fetch receipt: ${f.message}`);const m=i.from("autoclave_receipts").delete().eq("id",e).eq("tenant_id",r),{error:p}=yield m;if(p)throw new Error(`Failed to delete receipt: ${p.message}`)}catch(r){throw console.error("Error deleting receipt:",r),r}})}static getFacilitySettings(){return He(this,null,function*(){return{id:"default",facilityId:void 0,autoclaveHasPrinter:!1,receiptRetentionMonths:24,createdAt:new Date,updatedAt:new Date}})}static updateFacilitySettings(e){return He(this,null,function*(){const t=yield this.getFacilitySettings();return Jg(ls(ls({},t),e),{updatedAt:new Date})})}static cleanupExpiredReceipts(e){return He(this,null,function*(){var t;try{const r=e||(yield Nr()),i=st(r),{data:{user:a},error:s}=yield i.auth.getUser();if(s||!a)throw new Error("User not authenticated. Please log in again.");const{data:o,error:n}=yield i.from("users").select("facility_id").eq("id",a.id).single();if(n||!(o!=null&&o.facility_id))throw new Error("User facility not found");if(o.facility_id!==r)throw new Error("Unauthorized: tenant mismatch");const u=new Date;u.setMonth(u.getMonth()-24);const{data:h,error:f}=yield i.from("autoclave_receipts").select("id, photo_url").lt("created_at",u.toISOString()).eq("tenant_id",r);if(f)throw new Error(`Failed to fetch expired receipts: ${f.message}`);if(!h||h.length===0)return 0;for(const m of h){const p=(t=m.photo_url)==null?void 0:t.split("/").pop();p&&(yield i.storage.from("autoclave-receipts").remove([p])),yield i.from("autoclave_receipts").delete().eq("id",m.id)}return h.length}catch(r){throw console.error("Error cleaning up expired receipts:",r),r}})}static mapDatabaseReceipt(e){return{id:e.id,batchId:"",batchCode:e.receipt_number,cycleNumber:void 0,photoUrl:"",photoFilename:"",photoSize:0,temperatureEvidence:void 0,uploadedBy:"",uploadedAt:new Date(e.created_at),retentionUntil:new Date,isExpired:!1,createdAt:new Date(e.created_at),updatedAt:new Date(e.created_at)}}static mapDatabaseFacilitySettings(e){return{id:e.id,facilityId:e.facility_id,autoclaveHasPrinter:e.autoclave_has_printer,receiptRetentionMonths:e.receipt_retention_months,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}}}var ki=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const R=c=>typeof c=="string"?c:"",Ci=c=>typeof c=="number"?c:0,us=c=>typeof c=="boolean"?c:!1,Lt=c=>{if(typeof c=="string"){const e=new Date(c);return isNaN(e.getTime())?void 0:e}},ds=c=>{switch(c){case"active":return"available";case"dirty":return"maintenance";case"clean":return"available";case"problem":return"problem";case"new_barcode":return"available";default:return"available"}};function Xg(c){const e=Date.now().toString(36).toUpperCase(),t=Math.random().toString(36).substr(2,4).toUpperCase();return`PKG-${c.slice(0,4).toUpperCase()}-${e}-${t}`}class Z_{static getToolsReadyForPackaging(){return ki(this,null,function*(){let t=null;for(let r=1;r<=3;r++)try{if(!Qn.getState().authToken){if(r<3){yield new Promise(f=>setTimeout(f,r*500));continue}throw new Error("User not authenticated")}const{data:{user:a},error:s}=yield d.auth.getUser();if(s||!a)throw new Error("User not authenticated");const{data:o,error:n}=yield d.from("users").select("facility_id").eq("id",a.id).single();if(n||!o)throw new Error("User facility not found");const{data:l,error:u}=yield d.from("tools").select("*").eq("facility_id",o.facility_id).eq("status","active");if(u)throw new Error(`Failed to fetch tools: ${u.message}`);return(l||[]).map(f=>{const m=f;return{id:R(m.tool_id),name:R(m.tool_name),barcode:R(m.barcode),type:R(m.tool_type),category:R(m.category)||"general",currentPhase:R(m.current_phase),status:ds(R(m.current_phase)),lastSterilized:R(m.last_sterilized)||void 0,cycleCount:Ci(m.cycle_count),maxCycles:Ci(m.max_cycles)||void 0,location:R(m.location)||void 0,notes:R(m.notes)||void 0}})}catch(i){if(t=i instanceof Error?i:new Error("Unknown error"),r===3)throw console.error(`Error fetching tools ready for packaging (attempt ${r}/3):`,i),t;yield new Promise(a=>setTimeout(a,r*500))}throw t||new Error("Failed to fetch tools after all retries")})}static createPackage(e,t,r){return ki(this,null,function*(){try{if(!Qn.getState().authToken)throw new Error("User not authenticated");const{FacilityService:a}=yield T(()=>Promise.resolve().then(()=>ge),void 0),s=yield a.getCurrentFacilityId(),{data:{user:o},error:n}=yield d.auth.getUser();if(n||!o)throw new Error("User not authenticated");const l=o.id,u=Xg(s),{data:h,error:f}=yield d.from("sterilization_batches").insert({id:crypto.randomUUID(),cycle_id:crypto.randomUUID(),facility_id:s,batch_name:`Package ${u}`,batch_type:"routine",status:"packaged",package_id:u,package_type:t.packageType,package_size:t.packageSize,chemical_indicator_added:!0,packaged_by:l,packaged_at:new Date().toISOString(),requested_by:l,total_items:e.length,notes:t.notes}).select().single();if(f)throw new Error(`Failed to create package: ${f.message}`);const m=h,p=e.map(b=>({batch_id:m.id,tool_id:b,item_name:"Tool",item_type:"sterilization_tool",quantity:1,package_type:t.packageType,package_configuration:{package_size:t.packageSize,notes:t.notes}})),y=e.map(b=>me.updateToolStatus(b,"active"));yield Promise.all(y),yield me.touchTools(e);const _=yield new Fs().getCurrentUser(),w=_?{id:_.facility_id}:null;yield d.from("audit_logs").insert({created_by:(_==null?void 0:_.id)||"unknown",facility_id:(w==null?void 0:w.id)||"unknown",module:"sterilization",action:"package_created",table_name:"sterilization_batches",record_id:m.id,old_values:{},new_values:{package_id:u,package_type:t.packageType,total_items:e.length,status:"packaged"},metadata:{package_id:u,tool_count:e.length,operator_name:r,package_info:t}});const E={id:R(m.id),packageId:R(m.package_id),batchName:R(m.batch_name),batchType:R(m.batch_type),status:R(m.status),packageType:R(m.package_type),packageSize:R(m.package_size),chemicalIndicatorAdded:us(m.chemical_indicator_added),packagedBy:R(m.packaged_by),packagedAt:Lt(m.packaged_at)||new Date,totalItems:Ci(m.total_items),createdAt:Lt(m.created_at)||new Date,updatedAt:Lt(m.updated_at)||new Date};return{success:!0,message:`Package ${u} created successfully with ${e.length} tools`,batch:E,packageId:R(u)}}catch(i){return console.error("Error creating package:",i),{success:!1,message:i instanceof Error?i.message:"Failed to create package"}}})}static getPackageById(e){return ki(this,null,function*(){try{const{data:t,error:r}=yield d.from("sterilization_batches").select("*").eq("package_id",e).single();if(r||!t)return null;const i=t;return{id:R(i.id),packageId:R(i.package_id),batchName:R(i.batch_name),batchType:R(i.batch_type),status:R(i.status),packageType:R(i.package_type),packageSize:R(i.package_size),chemicalIndicatorAdded:us(i.chemical_indicator_added),packagedBy:R(i.packaged_by),packagedAt:Lt(i.packaged_at)||new Date,totalItems:Ci(i.total_items),createdAt:Lt(i.created_at)||new Date,updatedAt:Lt(i.updated_at)||new Date}}catch(t){return console.error("Error fetching package:",t),null}})}static getToolsInPackage(e){return ki(this,null,function*(){try{const{data:t,error:r}=yield d.from("sterilization_batches").select("id").eq("package_id",e).single();if(r||!t)throw new Error("Package not found");const i=t,{data:a,error:s}=yield d.from("sterilization_cycle_tools").select(`
          tool_id,
          tools (
            id,
            tool_name,
            barcode,
            tool_type,
            status,
            last_sterilized,
            sterilization_count,
            location,
            manufacturer,
            model,
            serial_number,
            maintenance_due_date,
            notes,
            metadata
          )
        `).eq("cycle_id",i.id);if(s)throw new Error(`Failed to fetch package tools: ${s.message}`);return(a||[]).map(o=>{const l=o.tools;if(!l)throw new Error("Tool data not found");return{id:l.id,name:l.tool_name,barcode:l.barcode,type:l.tool_type,category:l.category||"general",currentPhase:l.status,status:ds(l.status),location:l.location,notes:l.notes||void 0,cycleCount:l.cycle_count||0,lastSterilized:l.last_sterilized}})}catch(t){throw console.error("Error fetching package tools:",t),t}})}}var Zg=Object.defineProperty,ey=Object.defineProperties,ty=Object.getOwnPropertyDescriptors,hs=Object.getOwnPropertySymbols,ry=Object.prototype.hasOwnProperty,iy=Object.prototype.propertyIsEnumerable,fs=(c,e,t)=>e in c?Zg(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,ny=(c,e)=>{for(var t in e||(e={}))ry.call(e,t)&&fs(c,t,e[t]);if(hs)for(var t of hs(e))iy.call(e,t)&&fs(c,t,e[t]);return c},ay=(c,e)=>ey(c,ty(e)),ms=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ev{static getFacilitySettings(e){return ms(this,null,function*(){try{const{data:t,error:r}=yield d.from("facility_settings").select("*").eq("facility_id",e).maybeSingle();return r?(console.error("Error fetching facility settings:",r),null):t}catch(t){return console.error("Error fetching facility settings:",t),null}})}static updateFacilitySettings(e,t){return ms(this,null,function*(){try{const r=ay(ny({},t),{facility_id:e,updated_at:new Date().toISOString()}),{data:i,error:a}=yield d.from("facility_settings").upsert(r,{onConflict:"facility_id"}).select().single();return a?(console.error("Error updating facility settings:",a),null):i}catch(r){return console.error("Error updating facility settings:",r),null}})}}var it=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class oy{getUsers(e){return it(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("*").eq("facility_id",e).is("deleted_at",null).or("is_active.is.null,is_active.eq.true");if(r)throw console.error("UserRoleService.getUsers error:",r),new Error(r.message);if(console.log("ðŸ” UserRoleService.getUsers - Raw data:",t),console.log("ðŸ” UserRoleService.getUsers - First user data:",t==null?void 0:t[0]),t&&t.length>0){const i=t.map(s=>s.id),a=[...new Set(i)];if(console.log("ðŸ” UserRoleService.getUsers - Total users:",t.length),console.log("ðŸ” UserRoleService.getUsers - Unique IDs:",a.length),console.log("ðŸ” UserRoleService.getUsers - All IDs:",i),i.length!==a.length){console.warn("âš ï¸ DUPLICATE USER IDs DETECTED!");const s=i.filter((o,n)=>i.indexOf(o)!==n);console.warn("âš ï¸ Duplicate IDs:",[...new Set(s)])}}return t!=null?t:[]})}getRoles(e){return it(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("role").eq("facility_id",e).or("is_active.is.null,is_active.eq.true");if(r)throw new Error(r.message);return[...new Set((t==null?void 0:t.map(a=>a.role))||[])].map((a,s)=>({id:`role-${s}`,facility_id:e,role_name:a,description:`${a} role`,is_default:a==="user",created_at:new Date().toISOString()}))})}getUserRoles(e){return it(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("id, facility_id, role, created_at").eq("facility_id",e).or("is_active.is.null,is_active.eq.true");if(r)throw new Error(r.message);return(t!=null?t:[]).map(i=>({id:i.id,user_id:i.id,facility_id:i.facility_id,role_id:i.role,assigned_at:i.created_at}))})}assignUserRole(e,t,r){return it(this,null,function*(){const{error:i}=yield d.from("users").update({role:r}).eq("id",e).eq("facility_id",t);if(i)throw new Error(i.message)})}softDeleteUser(e,t){return it(this,null,function*(){const{error:r}=yield d.from("users").update({is_active:!1,deleted_at:new Date().toISOString()}).eq("id",e).eq("facility_id",t);if(r)throw new Error(r.message)})}restoreUser(e,t){return it(this,null,function*(){const{error:r}=yield d.from("users").update({is_active:!0,deleted_at:null}).eq("id",e).eq("facility_id",t);if(r)throw new Error(r.message)})}updateUserName(e,t,r){return it(this,null,function*(){const{error:i}=yield d.from("users").update({first_name:t,last_name:r,updated_at:new Date().toISOString()}).eq("id",e);if(i)throw console.error("UserRoleService.updateUserName error:",i),new Error(i.message);console.log(`âœ… Updated user ${e} name to: ${t} ${r}`)})}cleanupDuplicateUsers(e){return it(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("*").eq("facility_id",e).is("deleted_at",null).or("is_active.is.null,is_active.eq.true");if(r)throw console.error("UserRoleService.cleanupDuplicateUsers error:",r),new Error(r.message);if(!t||t.length===0)return;const i=t.reduce((s,o)=>(s[o.id]||(s[o.id]=[]),s[o.id].push(o),s),{}),a=Object.entries(i).filter(([s,o])=>o.length>1);if(a.length===0){console.log("âœ… No duplicate users found");return}console.log(`ðŸ” Found ${a.length} duplicate user IDs`);for(const[s,o]of a){o.sort((u,h)=>{const f=new Date(u.created_at||0).getTime();return new Date(h.created_at||0).getTime()-f});const n=o[0],l=o.slice(1);console.log(`ðŸ” Keeping user ${s} (created: ${n.created_at})`);for(const u of l)yield this.softDeleteUser(u.id,e),console.log(`ðŸ—‘ï¸ Soft-deleted duplicate user ${u.id}`)}console.log("âœ… Duplicate cleanup completed")})}}const tv=new oy;var nt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class sy{constructor(){this.TIER_LIMITS={tier1:5,tier2:15,tier3:21,tier4:999999},this.TIER_NAMES={tier1:"0-5 Users",tier2:"6-15 Users",tier3:"16-21 Users",tier4:"21+ Users"}}checkTierLimits(e){return nt(this,null,function*(){try{const{data:t,error:r}=yield d.from("users").select("id").eq("facility_id",e).is("deleted_at",null).or("is_active.is.null,is_active.eq.true");if(r)throw new Error(`Failed to get user count: ${r.message}`);const i=(t==null?void 0:t.length)||0;let a,s;return i>=0&&i<=5?(a="tier1",s=this.TIER_LIMITS.tier1):i>=6&&i<=15?(a="tier2",s=this.TIER_LIMITS.tier2):i>=16&&i<=21?(a="tier3",s=this.TIER_LIMITS.tier3):(a="tier4",s=this.TIER_LIMITS.tier4),{canAdd:i<s,currentCount:i,limit:s,tier:this.TIER_NAMES[a]}}catch(t){throw console.error("Error checking tier limits:",t),t}})}sendInvitation(e,t){return nt(this,null,function*(){try{const r=yield fetch("/api/auth/invite-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,userData:t})});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return yield r.json()}catch(r){throw console.error("Error sending invitation:",r),r}})}createInvitation(e){return nt(this,null,function*(){try{const{data:t,error:r}=yield d.from("user_invitations").insert({email:e.email,facility_id:e.facility_id,invited_by:e.invited_by,role:e.role,permissions:e.permissions,status:"pending",expires_at:new Date(Date.now()+6048e5).toISOString()}).select().single();if(r)throw new Error(`Failed to create invitation: ${r.message}`);return t}catch(t){throw console.error("Error creating invitation:",t),t}})}getInvitations(e){return nt(this,null,function*(){try{const{data:t,error:r}=yield d.from("user_invitations").select("*").eq("facility_id",e).order("created_at",{ascending:!1});if(r)throw new Error(`Failed to get invitations: ${r.message}`);return t||[]}catch(t){throw console.error("Error getting invitations:",t),t}})}updateInvitationStatus(e,t){return nt(this,null,function*(){try{const r={status:t};t==="accepted"&&(r.accepted_at=new Date().toISOString());const{error:i}=yield d.from("user_invitations").update(r).eq("id",e);if(i)throw new Error(`Failed to update invitation: ${i.message}`)}catch(r){throw console.error("Error updating invitation:",r),r}})}cancelInvitation(e){return nt(this,null,function*(){try{const{error:t}=yield d.from("user_invitations").update({status:"cancelled"}).eq("id",e);if(t)throw new Error(`Failed to cancel invitation: ${t.message}`)}catch(t){throw console.error("Error cancelling invitation:",t),t}})}resendInvitation(e){return nt(this,null,function*(){try{const{data:t,error:r}=yield d.from("user_invitations").select("*").eq("id",e).single();if(r)throw new Error(`Failed to get original invitation: ${r.message}`);return yield this.cancelInvitation(e),yield this.createInvitation({email:t.email,facility_id:t.facility_id,invited_by:t.invited_by,role:t.role,permissions:t.permissions})}catch(t){throw console.error("Error resending invitation:",t),t}})}cleanupUserInvitations(e,t){return nt(this,null,function*(){try{const{error:r}=yield d.from("user_invitations").update({status:"cancelled"}).eq("invited_by",e).eq("facility_id",t).eq("status","pending");if(r)throw new Error(`Failed to cleanup invitations: ${r.message}`)}catch(r){throw console.error("Error cleaning up user invitations:",r),r}})}}const rv=new sy;var Nt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class cy{getRoles(e){return Nt(this,null,function*(){try{const{data:t,error:r}=yield d.from("custom_roles").select("*").eq("facility_id",e).order("is_default",{ascending:!1}).order("created_at",{ascending:!0});if(r)throw new Error(`Failed to get roles: ${r.message}`);return t||[]}catch(t){throw console.error("Error getting roles:",t),t}})}createRole(e){return Nt(this,null,function*(){try{const{data:t,error:r}=yield d.from("custom_roles").insert({name:e.name,description:e.description,permissions:e.permissions,facility_id:e.facility_id,created_by:e.created_by,is_default:!1}).select().single();if(r)throw new Error(`Failed to create role: ${r.message}`);return t}catch(t){throw console.error("Error creating role:",t),t}})}updateRole(e,t){return Nt(this,null,function*(){try{const{data:r,error:i}=yield d.from("custom_roles").update({name:t.name,description:t.description,permissions:t.permissions,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(i)throw new Error(`Failed to update role: ${i.message}`);return r}catch(r){throw console.error("Error updating role:",r),r}})}deleteRole(e){return Nt(this,null,function*(){try{const{data:t,error:r}=yield d.from("custom_roles").select("is_default").eq("id",e).single();if(r)throw new Error(`Failed to check role: ${r.message}`);if(t.is_default)throw new Error("Cannot delete default roles");const{data:i,error:a}=yield d.from("users").select("id").eq("role",e).limit(1);if(a)throw new Error(`Failed to check role usage: ${a.message}`);if(i&&i.length>0)throw new Error("Cannot delete role that is currently assigned to users");const{error:s}=yield d.from("custom_roles").delete().eq("id",e);if(s)throw new Error(`Failed to delete role: ${s.message}`)}catch(t){throw console.error("Error deleting role:",t),t}})}getDefaultRoles(){return[{id:"administrator",name:"ðŸ‘‘ Administrator",description:"Full system access",permissions:{view_dashboard:!0,view_analytics:!0,export_data:!0,manage_users:!0,assign_roles:!0,view_user_activity:!0,system_settings:!0,facility_settings:!0,security_settings:!0,create_tasks:!0,edit_tasks:!0,delete_tasks:!0,assign_tasks:!0},facility_id:"",is_default:!0,created_by:"",created_at:"",updated_at:""},{id:"manager",name:"ðŸ‘¨â€ðŸ’¼ Manager",description:"Department management",permissions:{view_dashboard:!0,view_analytics:!0,export_data:!0,manage_users:!1,assign_roles:!0,view_user_activity:!0,system_settings:!1,facility_settings:!0,security_settings:!1,create_tasks:!0,edit_tasks:!0,delete_tasks:!0,assign_tasks:!0},facility_id:"",is_default:!0,created_by:"",created_at:"",updated_at:""},{id:"technician",name:"ðŸ”§ Technician",description:"Task execution",permissions:{view_dashboard:!0,view_analytics:!1,export_data:!1,manage_users:!1,assign_roles:!1,view_user_activity:!1,system_settings:!1,facility_settings:!1,security_settings:!1,create_tasks:!0,edit_tasks:!0,delete_tasks:!1,assign_tasks:!1},facility_id:"",is_default:!0,created_by:"",created_at:"",updated_at:""},{id:"viewer",name:"ðŸ‘€ Viewer",description:"Read-only access",permissions:{view_dashboard:!0,view_analytics:!0,export_data:!1,manage_users:!1,assign_roles:!1,view_user_activity:!1,system_settings:!1,facility_settings:!1,security_settings:!1,create_tasks:!1,edit_tasks:!1,delete_tasks:!1,assign_tasks:!1},facility_id:"",is_default:!0,created_by:"",created_at:"",updated_at:""},{id:"trainer",name:"ðŸ“š Trainer",description:"Content management",permissions:{view_dashboard:!0,view_analytics:!0,export_data:!0,manage_users:!1,assign_roles:!1,view_user_activity:!1,system_settings:!1,facility_settings:!0,security_settings:!1,create_tasks:!0,edit_tasks:!0,delete_tasks:!1,assign_tasks:!0},facility_id:"",is_default:!0,created_by:"",created_at:"",updated_at:""}]}getAllRoles(e){return Nt(this,null,function*(){try{const t=this.getDefaultRoles(),r=yield this.getRoles(e);return[...t,...r]}catch(t){throw console.error("Error getting all roles:",t),t}})}isRoleNameUnique(e,t,r){return Nt(this,null,function*(){try{let i=d.from("custom_roles").select("id").eq("facility_id",e).eq("name",t);r&&(i=i.neq("id",r));const{data:a,error:s}=yield i;if(s)throw new Error(`Failed to check role name: ${s.message}`);return!a||a.length===0}catch(i){throw console.error("Error checking role name uniqueness:",i),i}})}}const iv=new cy;var Gn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function nv(){return Gn(this,null,function*(){const{data:c,error:e}=yield d.from("audit_flags").select("*").eq("resolved",!1).order("created_at",{ascending:!1});if(e)throw e;return c!=null?c:[]})}function av(c,e,t=!0){return Gn(this,null,function*(){let r=d.from("audit_flags").select("*").order("created_at",{ascending:!1});t||(r=r.eq("resolved",!1));const{data:i,error:a}=yield r;if(a)throw a;return i!=null?i:[]})}function ov(){return Gn(this,null,function*(){const{data:c,error:e}=yield d.from("activity_feed").select("id, module, activity_type, activity_description, created_at").order("created_at",{ascending:!1}).limit(50);if(e)throw e;return c!=null?c:[]})}class ly{constructor(e){this.facilityId=e}createDefaultSettings(){return{aiEnabled:!0,computerVision:{toolConditionAssessment:!0,barcodeQualityDetection:!0,toolTypeRecognition:!0,cleaningValidation:!0,damageDetection:!0,wearAnalysis:!0,imageRecognition:!0,qualityAssessment:!0},predictiveAnalytics:{cycleOptimization:!0,failurePrediction:!0,efficiencyOptimization:!0,resourcePlanning:!0,maintenancePrediction:!0,qualityPrediction:!0,demandForecasting:!0,costOptimization:!0,seasonalAnalysis:!0},smartWorkflow:{intelligentWorkflowSelection:!0,automatedProblemDetection:!0,smartPhaseTransitions:!0,batchOptimization:!0,toolGrouping:!0,cycleScheduling:!0,smartCategorization:!0,autoClassification:!0,smartFormFilling:!0},qualityAssurance:{biologicalIndicatorAnalysis:!0,complianceMonitoring:!0,auditTrailEnhancement:!0,riskAssessment:!0,qualityMetrics:!0,regulatoryCompliance:!0,smartValidation:!0,errorPrevention:!0},realTimeMonitoring:{anomalyDetection:!0,predictiveMaintenance:!0,qualityDriftDetection:!0,smartNotifications:!0,performanceMonitoring:!0,alertManagement:!0,statusUpdates:!0,emergencyAlerts:!0},analytics:{dataCollection:!0,realTimeUpdates:!0,historicalDataRetention:!0,exportCapabilities:!0,dashboardCustomization:!0,performanceMetrics:!0,efficiencyTracking:!0,costAnalysis:!0},intelligence:{riskAssessment:!0,alertSystem:!0,escalationRules:!0,aiRecommendations:!0,optimizationTips:!0,predictiveInsights:!0,trendAnalysis:!0,forecasting:!0},performance:{accuracyTracking:!0,responseTimeMonitoring:!0,errorRateTracking:!0,qualityMetrics:!0,benchmarkComparison:!0,performanceAlerts:!0,optimizationSuggestions:!0,modelHealthMonitoring:!0},privacy:{dataAnonymization:!0,thirdPartyPermissions:!0,complianceMonitoring:!0,auditTrail:!0,dataRetention:!0,encryption:!0,accessControl:!0,privacyCompliance:!0},integration:{externalServices:!0,apiRateLimiting:!0,webhookEndpoints:!0,dataSharing:!0,healthMonitoring:!0,syncScheduling:!0,backupSystems:!0,crossPlatformSync:!0},userExperience:{aiSuggestions:!0,learningPaths:!0,personalization:!0,accessibility:!0,languagePreferences:!0,notificationPreferences:!0,interfaceCustomization:!0,helpSystem:!0},environmental:{predictiveCleaning:!1,smartScheduling:!1,contaminationPrediction:!1,resourceOptimization:!1,efficiencyAnalytics:!1,smartRoomManagement:!1,automaticPriorityAssignment:!1,riskAssessment:!1,trendAnalysis:!1,predictiveMaintenance:!1,supplyOptimization:!1,staffScheduling:!1,costOptimization:!1,inventoryPrediction:!1,workloadBalancing:!1,qualityAssurance:!1,complianceMonitoring:!1,auditTrailEnhancement:!1,performanceTracking:!1,automatedReporting:!1,realTimeMonitoring:!1,anomalyDetection:!1,smartNotifications:!1,statusUpdates:!1,emergencyAlerts:!1},learning:{personalizedRecommendations:!1,skillGapAnalysis:!1,learningPathOptimization:!1,performancePrediction:!1,adaptiveDifficulty:!1,learningAnalytics:!1,behaviorTracking:!1,progressPrediction:!1,engagementMetrics:!1,retentionAnalysis:!1,learningEfficiency:!1,contentOptimization:!1,assessmentIntelligence:!1,certificationTracking:!1,competencyMapping:!1,learningInsights:!1},aiConfig:{aiConfidenceThreshold:.8,aiDataRetentionDays:365,realTimeProcessingEnabled:!0,batchProcessingEnabled:!0,dataSharingEnabled:!1,localAIProcessingEnabled:!0,encryptedDataTransmission:!0,aiModelTraining:!1},apiKeys:{},facilityId:this.facilityId,aiVersion:"1.0.0",updated_at:new Date().toISOString()}}mergeSettings(e,t,r,i,a){var s,o,n,l,u,h,f,m,p,y,g,_,w,E,b,P,S,Y,J,B,Ae,Te;return t&&(e.computerVision.toolConditionAssessment=(s=t.tool_condition_assessment)!=null?s:e.computerVision.toolConditionAssessment,e.computerVision.barcodeQualityDetection=(o=t.barcode_quality_detection)!=null?o:e.computerVision.barcodeQualityDetection,e.computerVision.toolTypeRecognition=(n=t.tool_type_recognition)!=null?n:e.computerVision.toolTypeRecognition,e.predictiveAnalytics.cycleOptimization=(l=t.cycle_optimization)!=null?l:e.predictiveAnalytics.cycleOptimization,e.predictiveAnalytics.failurePrediction=(u=t.failure_prediction)!=null?u:e.predictiveAnalytics.failurePrediction,e.aiConfig.aiConfidenceThreshold=(h=t.ai_confidence_threshold)!=null?h:e.aiConfig.aiConfidenceThreshold,e.aiConfig.aiDataRetentionDays=(f=t.ai_data_retention_days)!=null?f:e.aiConfig.aiDataRetentionDays),r&&(e.computerVision.imageRecognition=(m=r.image_recognition_enabled)!=null?m:e.computerVision.imageRecognition,e.computerVision.qualityAssessment=(p=r.quality_assessment_enabled)!=null?p:e.computerVision.qualityAssessment,e.predictiveAnalytics.demandForecasting=(y=r.demand_forecasting_enabled)!=null?y:e.predictiveAnalytics.demandForecasting,e.predictiveAnalytics.costOptimization=(g=r.cost_optimization_enabled)!=null?g:e.predictiveAnalytics.costOptimization,e.smartWorkflow.smartCategorization=(_=r.smart_categorization_enabled)!=null?_:e.smartWorkflow.smartCategorization),i&&(e.environmental.predictiveCleaning=(w=i.predictive_cleaning_enabled)!=null?w:e.environmental.predictiveCleaning,e.environmental.smartScheduling=(E=i.smart_scheduling)!=null?E:e.environmental.smartScheduling,e.environmental.contaminationPrediction=(b=i.contamination_prediction)!=null?b:e.environmental.contaminationPrediction,e.environmental.resourceOptimization=(P=i.resource_optimization)!=null?P:e.environmental.resourceOptimization,e.environmental.efficiencyAnalytics=(S=i.efficiency_analytics)!=null?S:e.environmental.efficiencyAnalytics),a&&(e.learning.personalizedRecommendations=(Y=a.personalized_recommendations)!=null?Y:e.learning.personalizedRecommendations,e.learning.skillGapAnalysis=(J=a.skill_gap_analysis)!=null?J:e.learning.skillGapAnalysis,e.learning.learningPathOptimization=(B=a.learning_path_optimization)!=null?B:e.learning.learningPathOptimization,e.learning.performancePrediction=(Ae=a.performance_prediction)!=null?Ae:e.learning.performancePrediction,e.learning.adaptiveDifficulty=(Te=a.adaptive_difficulty)!=null?Te:e.learning.adaptiveDifficulty),e}extractSterilizationSettings(e){var t,r,i,a,s,o,n;return{tool_condition_assessment:(t=e.computerVision)==null?void 0:t.toolConditionAssessment,barcode_quality_detection:(r=e.computerVision)==null?void 0:r.barcodeQualityDetection,tool_type_recognition:(i=e.computerVision)==null?void 0:i.toolTypeRecognition,cycle_optimization:(a=e.predictiveAnalytics)==null?void 0:a.cycleOptimization,failure_prediction:(s=e.predictiveAnalytics)==null?void 0:s.failurePrediction,ai_confidence_threshold:(o=e.aiConfig)==null?void 0:o.aiConfidenceThreshold,ai_data_retention_days:(n=e.aiConfig)==null?void 0:n.aiDataRetentionDays}}extractInventorySettings(e){var t,r,i,a,s,o,n;return{image_recognition_enabled:(t=e.computerVision)==null?void 0:t.imageRecognition,quality_assessment_enabled:(r=e.computerVision)==null?void 0:r.qualityAssessment,demand_forecasting_enabled:(i=e.predictiveAnalytics)==null?void 0:i.demandForecasting,cost_optimization_enabled:(a=e.predictiveAnalytics)==null?void 0:a.costOptimization,smart_categorization_enabled:(s=e.smartWorkflow)==null?void 0:s.smartCategorization,ai_confidence_threshold:(o=e.aiConfig)==null?void 0:o.aiConfidenceThreshold,ai_data_retention_days:(n=e.aiConfig)==null?void 0:n.aiDataRetentionDays}}extractEnvironmentalSettings(e){var t,r,i,a,s,o,n;return{predictive_cleaning_enabled:(t=e.environmental)==null?void 0:t.predictiveCleaning,smart_scheduling:(r=e.environmental)==null?void 0:r.smartScheduling,contamination_prediction:(i=e.environmental)==null?void 0:i.contaminationPrediction,resource_optimization:(a=e.environmental)==null?void 0:a.resourceOptimization,efficiency_analytics:(s=e.environmental)==null?void 0:s.efficiencyAnalytics,ai_confidence_threshold:(o=e.aiConfig)==null?void 0:o.aiConfidenceThreshold,ai_data_retention_days:(n=e.aiConfig)==null?void 0:n.aiDataRetentionDays}}extractLearningSettings(e){var t,r,i,a,s,o,n;return{personalized_recommendations:(t=e.learning)==null?void 0:t.personalizedRecommendations,skill_gap_analysis:(r=e.learning)==null?void 0:r.skillGapAnalysis,learning_path_optimization:(i=e.learning)==null?void 0:i.learningPathOptimization,performance_prediction:(a=e.learning)==null?void 0:a.performancePrediction,adaptive_difficulty:(s=e.learning)==null?void 0:s.adaptiveDifficulty,ai_confidence_threshold:(o=e.aiConfig)==null?void 0:o.aiConfidenceThreshold,ai_data_retention_days:(n=e.aiConfig)==null?void 0:n.aiDataRetentionDays}}}var Pi=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class uy{constructor(e){this.facilityId=e,this.sterilizationAI=new Vs(e),this.inventoryAI=new Bs(e),this.environmentalAI=new Hs(e),this.learningAI=new Ns(e)}loadUnifiedSettings(){return Pi(this,null,function*(){try{const[e,t,r,i]=yield Promise.all([this.sterilizationAI.loadSettings(),this.inventoryAI.loadSettings(),this.environmentalAI.loadSettings(),this.learningAI.loadSettings()]),a=this.createDefaultSettings();return this.mergeSettings(a,e||void 0,t||void 0,r||void 0,i||void 0)}catch(e){return console.error("Error loading unified AI settings:",e),this.createDefaultSettings()}})}saveUnifiedSettings(e){return Pi(this,null,function*(){try{const t=this.extractSterilizationSettings(e),r=this.extractInventorySettings(e),i=this.extractEnvironmentalSettings(e),a=this.extractLearningSettings(e),[s,o,n,l]=yield Promise.all([this.sterilizationAI.saveSettings({facility_id:this.facilityId,ai_enabled:!0,ai_version:"1.0",computer_vision_enabled:!!t.tool_condition_assessment||!1,tool_condition_assessment:!!t.tool_condition_assessment||!1,barcode_quality_detection:!!t.barcode_quality_detection||!1,tool_type_recognition:!!t.tool_type_recognition||!1,cleaning_validation:!1,predictive_analytics_enabled:!!t.failure_prediction||!1,cycle_optimization:!!t.cycle_optimization||!1,failure_prediction:!!t.failure_prediction||!1,efficiency_optimization:!1,resource_planning:!1,smart_workflow_enabled:!1,ai_confidence_threshold:Number(t.ai_confidence_threshold)||.8,ai_data_retention_days:Number(t.ai_data_retention_days)||90}),this.inventoryAI.saveSettings(r),this.environmentalAI.saveSettings(i),this.learningAI.saveSettings(a)]);return s&&o&&n&&l}catch(t){return console.error("Error saving unified AI settings:",t),!1}})}applySettings(e){return Pi(this,null,function*(){try{return yield this.sterilizationAI.initialize(),yield this.environmentalAI.initialize(),yield this.learningAI.initialize(),this.applyFeatureFlags(e),!0}catch(t){return console.error("Error applying AI settings:",t),!1}})}getServiceStatus(){return Pi(this,null,function*(){try{const[e,t,r]=yield Promise.all([this.sterilizationAI.initialize(),this.environmentalAI.initialize(),this.learningAI.initialize()]);return{sterilization:e,inventory:!1,environmental:t,learning:r}}catch(e){return console.error("Error getting AI service status:",e),{sterilization:!1,inventory:!1,environmental:!1,learning:!1}}})}createDefaultSettings(){return{aiEnabled:!0,computerVision:{toolConditionAssessment:!0,barcodeQualityDetection:!0,toolTypeRecognition:!0,cleaningValidation:!0,damageDetection:!0,wearAnalysis:!0,imageRecognition:!0,qualityAssessment:!0},predictiveAnalytics:{cycleOptimization:!0,failurePrediction:!0,efficiencyOptimization:!0,resourcePlanning:!0,maintenancePrediction:!0,qualityPrediction:!0,demandForecasting:!0,costOptimization:!0,seasonalAnalysis:!0},smartWorkflow:{intelligentWorkflowSelection:!0,automatedProblemDetection:!0,smartPhaseTransitions:!0,batchOptimization:!0,toolGrouping:!0,cycleScheduling:!0,smartCategorization:!0,autoClassification:!0,smartFormFilling:!0},qualityAssurance:{biologicalIndicatorAnalysis:!0,complianceMonitoring:!0,auditTrailEnhancement:!0,riskAssessment:!0,qualityMetrics:!0,regulatoryCompliance:!0,smartValidation:!0,errorPrevention:!0},realTimeMonitoring:{anomalyDetection:!0,predictiveMaintenance:!0,qualityDriftDetection:!0,smartNotifications:!0,performanceMonitoring:!0,alertManagement:!0,statusUpdates:!0,emergencyAlerts:!0},analytics:{dataCollection:!0,realTimeUpdates:!0,historicalDataRetention:!0,exportCapabilities:!0,dashboardCustomization:!0,performanceMetrics:!0,efficiencyTracking:!0,costAnalysis:!0},intelligence:{riskAssessment:!0,alertSystem:!0,escalationRules:!0,aiRecommendations:!0,optimizationTips:!0,predictiveInsights:!0,trendAnalysis:!0,forecasting:!0},performance:{accuracyTracking:!0,responseTimeMonitoring:!0,errorRateTracking:!0,qualityMetrics:!0,benchmarkComparison:!0,performanceAlerts:!0,optimizationSuggestions:!0,modelHealthMonitoring:!0},privacy:{dataAnonymization:!0,thirdPartyPermissions:!0,complianceMonitoring:!0,auditTrail:!0,dataRetention:!0,encryption:!0,accessControl:!0,privacyCompliance:!0},integration:{externalServices:!0,apiRateLimiting:!0,webhookEndpoints:!0,dataSharing:!0,healthMonitoring:!0,syncScheduling:!0,backupSystems:!0,crossPlatformSync:!0},userExperience:{aiSuggestions:!0,learningPaths:!0,personalization:!0,accessibility:!0,languagePreferences:!0,notificationPreferences:!0,interfaceCustomization:!0,helpSystem:!0},environmental:{predictiveCleaning:!1,smartScheduling:!1,contaminationPrediction:!1,resourceOptimization:!1,efficiencyAnalytics:!1,smartRoomManagement:!1,automaticPriorityAssignment:!1,riskAssessment:!1,trendAnalysis:!1,predictiveMaintenance:!1,supplyOptimization:!1,staffScheduling:!1,costOptimization:!1,inventoryPrediction:!1,workloadBalancing:!1,qualityAssurance:!1,complianceMonitoring:!1,auditTrailEnhancement:!1,performanceTracking:!1,automatedReporting:!1,realTimeMonitoring:!1,anomalyDetection:!1,smartNotifications:!1,statusUpdates:!1,emergencyAlerts:!1},learning:{personalizedRecommendations:!1,skillGapAnalysis:!1,learningPathOptimization:!1,performancePrediction:!1,adaptiveDifficulty:!1,learningAnalytics:!1,behaviorTracking:!1,progressPrediction:!1,engagementMetrics:!1,retentionAnalysis:!1,learningEfficiency:!1,contentOptimization:!1,assessmentIntelligence:!1,certificationTracking:!1,competencyMapping:!1,learningInsights:!1},aiConfig:{aiConfidenceThreshold:.8,aiDataRetentionDays:365,realTimeProcessingEnabled:!0,batchProcessingEnabled:!0,dataSharingEnabled:!1,localAIProcessingEnabled:!0,encryptedDataTransmission:!0,aiModelTraining:!1},apiKeys:{},facilityId:this.facilityId,aiVersion:"1.0.0",updated_at:new Date().toISOString()}}mergeSettings(e,t,r,i,a){var s,o,n,l,u,h,f,m,p,y,g,_,w,E,b,P,S,Y,J,B,Ae,Te;return t&&(e.computerVision.toolConditionAssessment=(s=!!t.tool_condition_assessment)!=null?s:e.computerVision.toolConditionAssessment,e.computerVision.barcodeQualityDetection=(o=!!t.barcode_quality_detection)!=null?o:e.computerVision.barcodeQualityDetection,e.computerVision.toolTypeRecognition=(n=!!t.tool_type_recognition)!=null?n:e.computerVision.toolTypeRecognition,e.predictiveAnalytics.cycleOptimization=(l=!!t.cycle_optimization)!=null?l:e.predictiveAnalytics.cycleOptimization,e.predictiveAnalytics.failurePrediction=(u=!!t.failure_prediction)!=null?u:e.predictiveAnalytics.failurePrediction,e.aiConfig.aiConfidenceThreshold=(h=Number(t.ai_confidence_threshold))!=null?h:e.aiConfig.aiConfidenceThreshold,e.aiConfig.aiDataRetentionDays=(f=Number(t.ai_data_retention_days))!=null?f:e.aiConfig.aiDataRetentionDays),r&&(e.computerVision.imageRecognition=(m=!!r.image_recognition_enabled)!=null?m:e.computerVision.imageRecognition,e.computerVision.qualityAssessment=(p=!!r.quality_assessment_enabled)!=null?p:e.computerVision.qualityAssessment,e.predictiveAnalytics.demandForecasting=(y=!!r.demand_forecasting_enabled)!=null?y:e.predictiveAnalytics.demandForecasting,e.predictiveAnalytics.costOptimization=(g=!!r.cost_optimization_enabled)!=null?g:e.predictiveAnalytics.costOptimization,e.smartWorkflow.smartCategorization=(_=!!r.smart_categorization_enabled)!=null?_:e.smartWorkflow.smartCategorization),i&&(e.environmental.predictiveCleaning=(w=!!i.predictive_cleaning_enabled)!=null?w:e.environmental.predictiveCleaning,e.environmental.smartScheduling=(E=!!i.smart_scheduling)!=null?E:e.environmental.smartScheduling,e.environmental.contaminationPrediction=(b=!!i.contamination_prediction)!=null?b:e.environmental.contaminationPrediction,e.environmental.resourceOptimization=(P=!!i.resource_optimization)!=null?P:e.environmental.resourceOptimization,e.environmental.efficiencyAnalytics=(S=!!i.efficiency_analytics)!=null?S:e.environmental.efficiencyAnalytics),a&&(e.learning.personalizedRecommendations=(Y=!!a.personalized_recommendations)!=null?Y:e.learning.personalizedRecommendations,e.learning.skillGapAnalysis=(J=!!a.skill_gap_analysis)!=null?J:e.learning.skillGapAnalysis,e.learning.learningPathOptimization=(B=!!a.learning_path_optimization)!=null?B:e.learning.learningPathOptimization,e.learning.performancePrediction=(Ae=!!a.performance_prediction)!=null?Ae:e.learning.performancePrediction,e.learning.adaptiveDifficulty=(Te=!!a.adaptive_difficulty)!=null?Te:e.learning.adaptiveDifficulty),e}extractSterilizationSettings(e){var t,r,i,a,s,o,n;return{tool_condition_assessment:(t=e.computerVision)==null?void 0:t.toolConditionAssessment,barcode_quality_detection:(r=e.computerVision)==null?void 0:r.barcodeQualityDetection,tool_type_recognition:(i=e.computerVision)==null?void 0:i.toolTypeRecognition,cycle_optimization:(a=e.predictiveAnalytics)==null?void 0:a.cycleOptimization,failure_prediction:(s=e.predictiveAnalytics)==null?void 0:s.failurePrediction,ai_confidence_threshold:(o=e.aiConfig)==null?void 0:o.aiConfidenceThreshold,ai_data_retention_days:(n=e.aiConfig)==null?void 0:n.aiDataRetentionDays}}extractInventorySettings(e){var t,r,i,a,s,o,n;return{image_recognition_enabled:(t=e.computerVision)==null?void 0:t.imageRecognition,quality_assessment_enabled:(r=e.computerVision)==null?void 0:r.qualityAssessment,demand_forecasting_enabled:(i=e.predictiveAnalytics)==null?void 0:i.demandForecasting,cost_optimization_enabled:(a=e.predictiveAnalytics)==null?void 0:a.costOptimization,smart_categorization_enabled:(s=e.smartWorkflow)==null?void 0:s.smartCategorization,ai_confidence_threshold:(o=e.aiConfig)==null?void 0:o.aiConfidenceThreshold,ai_data_retention_days:(n=e.aiConfig)==null?void 0:n.aiDataRetentionDays}}extractEnvironmentalSettings(e){var t,r,i,a,s,o,n;return{predictive_cleaning_enabled:(t=e.environmental)==null?void 0:t.predictiveCleaning,smart_scheduling:(r=e.environmental)==null?void 0:r.smartScheduling,contamination_prediction:(i=e.environmental)==null?void 0:i.contaminationPrediction,resource_optimization:(a=e.environmental)==null?void 0:a.resourceOptimization,efficiency_analytics:(s=e.environmental)==null?void 0:s.efficiencyAnalytics,ai_confidence_threshold:(o=e.aiConfig)==null?void 0:o.aiConfidenceThreshold,ai_data_retention_days:(n=e.aiConfig)==null?void 0:n.aiDataRetentionDays}}extractLearningSettings(e){var t,r,i,a,s,o,n;return{personalized_recommendations:(t=e.learning)==null?void 0:t.personalizedRecommendations,skill_gap_analysis:(r=e.learning)==null?void 0:r.skillGapAnalysis,learning_path_optimization:(i=e.learning)==null?void 0:i.learningPathOptimization,performance_prediction:(a=e.learning)==null?void 0:a.performancePrediction,adaptive_difficulty:(s=e.learning)==null?void 0:s.adaptiveDifficulty,ai_confidence_threshold:(o=e.aiConfig)==null?void 0:o.aiConfidenceThreshold,ai_data_retention_days:(n=e.aiConfig)==null?void 0:n.aiDataRetentionDays}}applyFeatureFlags(e){console.log("Applying AI feature flags:",e)}}class dy{constructor(e){this.facilityId=e}isFeatureEnabled(e,t){return e.aiEnabled?this.getNestedValue(e,t)===!0:!1}validateApiKeys(e){const t=[];return e.openaiApiKey&&!this.isValidApiKey(e.openaiApiKey)&&t.push("Invalid OpenAI API key format"),e.googleVisionApiKey&&!this.isValidApiKey(e.googleVisionApiKey)&&t.push("Invalid Google Vision API key format"),e.azureComputerVisionKey&&!this.isValidApiKey(e.azureComputerVisionKey)&&t.push("Invalid Azure Computer Vision API key format"),{isValid:t.length===0,errors:t}}encryptApiKeys(e){return{openaiApiKey:e.openaiApiKey?this.encryptKey(e.openaiApiKey):void 0,googleVisionApiKey:e.googleVisionApiKey?this.encryptKey(e.googleVisionApiKey):void 0,azureComputerVisionKey:e.azureComputerVisionKey?this.encryptKey(e.azureComputerVisionKey):void 0}}decryptApiKeys(e){return{openaiApiKey:e.openaiApiKey?this.decryptKey(e.openaiApiKey):void 0,googleVisionApiKey:e.googleVisionApiKey?this.decryptKey(e.googleVisionApiKey):void 0,azureComputerVisionKey:e.azureComputerVisionKey?this.decryptKey(e.azureComputerVisionKey):void 0}}getRequiredApiKeys(e){const t=[];return(e.computerVision.toolConditionAssessment||e.computerVision.barcodeQualityDetection||e.computerVision.toolTypeRecognition||e.computerVision.imageRecognition||e.computerVision.qualityAssessment)&&t.push("googleVisionApiKey","azureComputerVisionKey"),(e.predictiveAnalytics.failurePrediction||e.predictiveAnalytics.cycleOptimization||e.predictiveAnalytics.demandForecasting)&&t.push("openaiApiKey"),(e.environmental.predictiveCleaning||e.environmental.contaminationPrediction||e.environmental.resourceOptimization)&&t.push("openaiApiKey"),(e.learning.personalizedRecommendations||e.learning.skillGapAnalysis||e.learning.learningPathOptimization)&&t.push("openaiApiKey"),[...new Set(t)]}hasRequiredApiKeys(e){const t=this.getRequiredApiKeys(e),r=Object.keys(e.apiKeys).filter(i=>e.apiKeys[i]);return t.every(i=>r.some(a=>a===i))}isValidApiKey(e){return e&&e.length>10&&!e.includes(" ")}encryptKey(e){return`encrypted_${e}`}decryptKey(e){return e.replace("encrypted_","")}getNestedValue(e,t){return t.split(".").reduce((r,i)=>r==null?void 0:r[i],e)}}var hy=Object.defineProperty,ps=Object.getOwnPropertySymbols,fy=Object.prototype.hasOwnProperty,my=Object.prototype.propertyIsEnumerable,gs=(c,e,t)=>e in c?hy(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Di=(c,e)=>{for(var t in e||(e={}))fy.call(e,t)&&gs(c,t,e[t]);if(ps)for(var t of ps(e))my.call(e,t)&&gs(c,t,e[t]);return c};class py{constructor(e){this.facilityId=e}applyFeatureFlags(e){console.log("Applying AI feature flags:",e)}toggleFeature(e,t,r){const i=Di({},e);return this.setNestedValue(i,t,r),i}toggleMultipleFeatures(e,t){const r=Di({},e);return Object.entries(t).forEach(([i,a])=>{this.setNestedValue(r,i,a)}),r}enableCategory(e,t){const r=Di({},e);if(typeof r[t]=="object"&&r[t]!==null){const i=r[t];Object.keys(i).forEach(a=>{i[a]=!0})}return r}disableCategory(e,t){const r=Di({},e);if(typeof r[t]=="object"&&r[t]!==null){const i=r[t];Object.keys(i).forEach(a=>{i[a]=!1})}return r}getFeatureStatus(e,t){return this.getNestedValue(e,t)===!0}getCategoryStatus(e,t){if(typeof e[t]!="object"||e[t]===null)return{enabled:0,total:0,percentage:0};const r=e[t],i=Object.values(r),a=i.filter(Boolean).length,s=i.length;return{enabled:a,total:s,percentage:s>0?Math.round(a/s*100):0}}getDisabledFeatures(e){const t=[];return Object.entries(e.computerVision).forEach(([r,i])=>{i||t.push(`computerVision.${r}`)}),Object.entries(e.predictiveAnalytics).forEach(([r,i])=>{i||t.push(`predictiveAnalytics.${r}`)}),Object.entries(e.smartWorkflow).forEach(([r,i])=>{i||t.push(`smartWorkflow.${r}`)}),Object.entries(e.qualityAssurance).forEach(([r,i])=>{i||t.push(`qualityAssurance.${r}`)}),Object.entries(e.realTimeMonitoring).forEach(([r,i])=>{i||t.push(`realTimeMonitoring.${r}`)}),Object.entries(e.analytics).forEach(([r,i])=>{i||t.push(`analytics.${r}`)}),Object.entries(e.intelligence).forEach(([r,i])=>{i||t.push(`intelligence.${r}`)}),Object.entries(e.performance).forEach(([r,i])=>{i||t.push(`performance.${r}`)}),Object.entries(e.privacy).forEach(([r,i])=>{i||t.push(`privacy.${r}`)}),Object.entries(e.integration).forEach(([r,i])=>{i||t.push(`integration.${r}`)}),Object.entries(e.userExperience).forEach(([r,i])=>{i||t.push(`userExperience.${r}`)}),Object.entries(e.environmental).forEach(([r,i])=>{i||t.push(`environmental.${r}`)}),Object.entries(e.learning).forEach(([r,i])=>{i||t.push(`learning.${r}`)}),t}getEnabledFeatures(e){const t=[];return Object.entries(e.computerVision).forEach(([r,i])=>{i&&t.push(`computerVision.${r}`)}),Object.entries(e.predictiveAnalytics).forEach(([r,i])=>{i&&t.push(`predictiveAnalytics.${r}`)}),Object.entries(e.smartWorkflow).forEach(([r,i])=>{i&&t.push(`smartWorkflow.${r}`)}),Object.entries(e.qualityAssurance).forEach(([r,i])=>{i&&t.push(`qualityAssurance.${r}`)}),Object.entries(e.realTimeMonitoring).forEach(([r,i])=>{i&&t.push(`realTimeMonitoring.${r}`)}),Object.entries(e.analytics).forEach(([r,i])=>{i&&t.push(`analytics.${r}`)}),Object.entries(e.intelligence).forEach(([r,i])=>{i&&t.push(`intelligence.${r}`)}),Object.entries(e.performance).forEach(([r,i])=>{i&&t.push(`performance.${r}`)}),Object.entries(e.privacy).forEach(([r,i])=>{i&&t.push(`privacy.${r}`)}),Object.entries(e.integration).forEach(([r,i])=>{i&&t.push(`integration.${r}`)}),Object.entries(e.userExperience).forEach(([r,i])=>{i&&t.push(`userExperience.${r}`)}),Object.entries(e.environmental).forEach(([r,i])=>{i&&t.push(`environmental.${r}`)}),Object.entries(e.learning).forEach(([r,i])=>{i&&t.push(`learning.${r}`)}),t}getNestedValue(e,t){return t.split(".").reduce((r,i)=>r==null?void 0:r[i],e)}setNestedValue(e,t,r){const i=t.split("."),a=i.pop(),s=i.reduce((o,n)=>(n in o||(o[n]={}),o[n]),e);s[a]=r}}var gy=Object.defineProperty,ys=Object.getOwnPropertySymbols,yy=Object.prototype.hasOwnProperty,_y=Object.prototype.propertyIsEnumerable,_s=(c,e,t)=>e in c?gy(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Pn=(c,e)=>{for(var t in e||(e={}))yy.call(e,t)&&_s(c,t,e[t]);if(ys)for(var t of ys(e))_y.call(e,t)&&_s(c,t,e[t]);return c};class vy{constructor(e){this.facilityId=e}optimizePerformanceSettings(e){const t=Pn({},e);return t.aiConfig.aiConfidenceThreshold=this.calculateOptimalConfidenceThreshold(e),t.aiConfig.aiDataRetentionDays=this.calculateOptimalDataRetention(e),t.aiConfig.realTimeProcessingEnabled=this.shouldEnableRealTimeProcessing(e),t.aiConfig.batchProcessingEnabled=this.shouldEnableBatchProcessing(e),t.aiConfig.dataSharingEnabled=this.shouldEnableDataSharing(e),t.aiConfig.localAIProcessingEnabled=this.shouldEnableLocalProcessing(e),t.aiConfig.encryptedDataTransmission=this.shouldEnableEncryption(e),t.aiConfig.aiModelTraining=this.shouldEnableModelTraining(e),t}getPerformanceRecommendations(e){const t=[];return e.aiConfig.aiConfidenceThreshold<.7&&t.push({recommendations:["Consider increasing AI confidence threshold to 0.8 or higher for better accuracy"],priority:"medium"}),e.aiConfig.aiDataRetentionDays>365&&t.push({recommendations:["Consider reducing data retention period to improve performance and reduce storage costs"],priority:"low"}),!e.aiConfig.realTimeProcessingEnabled&&!e.aiConfig.batchProcessingEnabled&&t.push({recommendations:["Enable at least one processing mode (real-time or batch) for AI functionality"],priority:"high"}),e.aiConfig.encryptedDataTransmission||t.push({recommendations:["Enable encrypted data transmission for better security"],priority:"high"}),!e.aiConfig.localAIProcessingEnabled&&e.privacy.dataAnonymization&&t.push({recommendations:["Consider enabling local AI processing for better privacy compliance"],priority:"medium"}),t}validatePerformanceSettings(e){const t=[],r=[];return(e.aiConfig.aiConfidenceThreshold<.1||e.aiConfig.aiConfidenceThreshold>1)&&t.push("AI confidence threshold must be between 0.1 and 1.0"),(e.aiConfig.aiDataRetentionDays<1||e.aiConfig.aiDataRetentionDays>2555)&&t.push("AI data retention days must be between 1 and 2555 (7 years)"),!e.aiConfig.realTimeProcessingEnabled&&!e.aiConfig.batchProcessingEnabled&&t.push("At least one processing mode must be enabled"),!e.aiConfig.encryptedDataTransmission&&e.privacy.dataAnonymization&&r.push("Consider enabling encrypted data transmission when using data anonymization"),!e.aiConfig.localAIProcessingEnabled&&e.privacy.privacyCompliance&&r.push("Consider enabling local AI processing for better privacy compliance"),{isValid:t.length===0,errors:t,warnings:r}}getPerformanceMetricsConfig(e){return{accuracyTracking:e.performance.accuracyTracking,responseTimeMonitoring:e.performance.responseTimeMonitoring,errorRateTracking:e.performance.errorRateTracking,qualityMetrics:e.performance.qualityMetrics,benchmarkComparison:e.performance.benchmarkComparison,performanceAlerts:e.performance.performanceAlerts,optimizationSuggestions:e.performance.optimizationSuggestions,modelHealthMonitoring:e.performance.modelHealthMonitoring}}updatePerformanceMetrics(e,t){const r=Pn({},e);return Object.entries(t).forEach(([i,a])=>{a!==void 0&&(r.performance[i]=a)}),r}getPerformanceConfig(e){return{aiConfidenceThreshold:e.aiConfig.aiConfidenceThreshold,aiDataRetentionDays:e.aiConfig.aiDataRetentionDays,realTimeProcessingEnabled:e.aiConfig.realTimeProcessingEnabled,batchProcessingEnabled:e.aiConfig.batchProcessingEnabled,dataSharingEnabled:e.aiConfig.dataSharingEnabled,localAIProcessingEnabled:e.aiConfig.localAIProcessingEnabled,encryptedDataTransmission:e.aiConfig.encryptedDataTransmission,aiModelTraining:e.aiConfig.aiModelTraining}}updatePerformanceConfig(e,t){const r=Pn({},e);return Object.entries(t).forEach(([i,a])=>{a!==void 0&&(r.aiConfig[i]=a)}),r}calculateOptimalConfidenceThreshold(e){let t=.8;return e.predictiveAnalytics.failurePrediction&&(t=Math.max(t,.9)),e.qualityAssurance.complianceMonitoring&&(t=Math.max(t,.85)),e.realTimeMonitoring.emergencyAlerts&&(t=Math.max(t,.95)),Math.min(t,.99)}calculateOptimalDataRetention(e){let t=365;return e.privacy.complianceMonitoring&&(t=Math.max(t,2555)),e.qualityAssurance.regulatoryCompliance&&(t=Math.max(t,1825)),e.performance.optimizationSuggestions&&(t=Math.min(t,180)),t}shouldEnableRealTimeProcessing(e){return e.realTimeMonitoring.anomalyDetection||e.realTimeMonitoring.emergencyAlerts||e.realTimeMonitoring.smartNotifications||e.analytics.realTimeUpdates}shouldEnableBatchProcessing(e){return e.predictiveAnalytics.demandForecasting||e.predictiveAnalytics.seasonalAnalysis||e.analytics.historicalDataRetention||e.performance.benchmarkComparison}shouldEnableDataSharing(e){return e.privacy.thirdPartyPermissions&&!e.privacy.dataAnonymization}shouldEnableLocalProcessing(e){return e.privacy.dataAnonymization||e.privacy.privacyCompliance||e.privacy.accessControl}shouldEnableEncryption(e){return e.privacy.encryption||e.privacy.privacyCompliance||e.privacy.accessControl}shouldEnableModelTraining(e){return e.analytics.dataCollection&&(e.predictiveAnalytics.failurePrediction||e.predictiveAnalytics.cycleOptimization||e.learning.personalizedRecommendations)}}var at=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class wy{constructor(e){this.facilityId=e}saveToUnifiedTable(e){return at(this,null,function*(){var t;try{const{data:r,error:i}=yield d.from("ai_settings").upsert({facility_id:this.facilityId,module:"general",settings:e,updated_at:new Date().toISOString()},{onConflict:"facility_id,module"});return i?(console.error("Error saving to unified table:",i),!1):(!i&&r&&(yield xn({facilityId:this.facilityId,userId:"system",module:"general",action:"UPDATE",details:(t=r[0])!=null?t:{}})),!0)}catch(r){return console.error("Error saving to unified table:",r),!1}})}loadFromUnifiedTable(){return at(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings").select("settings").eq("facility_id",this.facilityId).eq("module","general").single();return t?(t.code==="PGRST116"||console.error("Error loading from unified table:",t),null):e==null?void 0:e.settings}catch(e){return console.error("Error loading from unified table:",e),null}})}deleteFromUnifiedTable(){return at(this,null,function*(){try{const{error:e}=yield d.from("ai_settings").delete().eq("facility_id",this.facilityId).eq("module","general");return e?(console.error("Error deleting from unified table:",e),!1):!0}catch(e){return console.error("Error deleting from unified table:",e),!1}})}settingsExist(){return at(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings").select("facility_id").eq("facility_id",this.facilityId).eq("module","general").single();return t?(t.code==="PGRST116"||console.error("Error checking if settings exist:",t),!1):!!e}catch(e){return console.error("Error checking if settings exist:",e),!1}})}getSettingsMetadata(){return at(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings").select("updated_at, ai_version, created_at").eq("facility_id",this.facilityId).eq("module","general").single();return t?(t.code==="PGRST116"||console.error("Error getting settings metadata:",t),null):{updated_at:(e==null?void 0:e.updated_at)||null,ai_version:(e==null?void 0:e.ai_version)||null,created_at:(e==null?void 0:e.created_at)||null}}catch(e){return console.error("Error getting settings metadata:",e),null}})}backupSettings(e){return at(this,null,function*(){try{const{error:t}=yield d.from("ai_settings_backup").insert({facility_id:this.facilityId,module:"general",settings:e,backup_date:new Date().toISOString(),ai_version:e.aiVersion});return t?(console.error("Error backing up settings:",t),!1):!0}catch(t){return console.error("Error backing up settings:",t),!1}})}restoreSettings(e){return at(this,null,function*(){try{let t=d.from("ai_settings_backup").select("settings").eq("facility_id",this.facilityId).eq("module","general").order("backup_date",{ascending:!1});e&&(t=t.eq("backup_date",e));const{data:r,error:i}=yield t.limit(1).single();return i?(i.code==="PGRST116"||console.error("Error restoring settings:",i),null):r==null?void 0:r.settings}catch(t){return console.error("Error restoring settings:",t),null}})}getAvailableBackups(){return at(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings_backup").select("backup_date, ai_version").eq("facility_id",this.facilityId).eq("module","general").order("backup_date",{ascending:!1});return t?(console.error("Error getting available backups:",t),[]):e||[]}catch(e){return console.error("Error getting available backups:",e),[]}})}exportSettingsToJson(e){return JSON.stringify(e,null,2)}importSettingsFromJson(e){try{const t=JSON.parse(e);if(!t.aiEnabled||!t.facilityId||!t.aiConfig)throw new Error("Invalid settings format");return t}catch(t){return console.error("Error importing settings from JSON:",t),null}}validateSettingsStructure(e){const t=[];if(typeof e!="object"||e===null)return t.push("Settings must be an object"),{isValid:!1,errors:t};const r=e;if(["aiEnabled","computerVision","predictiveAnalytics","smartWorkflow","qualityAssurance","realTimeMonitoring","analytics","intelligence","performance","privacy","integration","userExperience","environmental","learning","aiConfig","apiKeys","facilityId","aiVersion","updated_at"].forEach(a=>{a in r||t.push(`Missing required property: ${a}`)}),r.computerVision&&typeof r.computerVision!="object"&&t.push("computerVision must be an object"),r.predictiveAnalytics&&typeof r.predictiveAnalytics!="object"&&t.push("predictiveAnalytics must be an object"),r.aiConfig&&typeof r.aiConfig!="object"&&t.push("aiConfig must be an object"),r.aiConfig&&typeof r.aiConfig=="object"){const a=r.aiConfig;typeof a.aiConfidenceThreshold!="number"&&t.push("aiConfig.aiConfidenceThreshold must be a number"),typeof a.aiDataRetentionDays!="number"&&t.push("aiConfig.aiDataRetentionDays must be a number")}return{isValid:t.length===0,errors:t}}}var Oi=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Iy{constructor(e){this.facilityId=e,this.configProvider=new ly(e),this.modelProvider=new uy(e),this.apiKeyProvider=new dy(e),this.toggleProvider=new py(e),this.performanceProvider=new vy(e),this.persistenceProvider=new wy(e)}loadUnifiedSettings(){return Oi(this,null,function*(){return this.modelProvider.loadUnifiedSettings()})}saveUnifiedSettings(e){return Oi(this,null,function*(){const t=yield this.modelProvider.saveUnifiedSettings(e),r=yield this.persistenceProvider.saveToUnifiedTable(e);return t&&r})}applySettings(e){return Oi(this,null,function*(){return this.modelProvider.applySettings(e)})}isFeatureEnabled(e,t){return this.apiKeyProvider.isFeatureEnabled(e,t)}getServiceStatus(){return Oi(this,null,function*(){return this.modelProvider.getServiceStatus()})}}const sv=()=>{const{getCurrentFacilityId:c}=Ic(),e=c();if(!e)throw new Error("Facility ID not available");return bc.useMemo(()=>new Iy(e),[e])};var De=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const Dn=()=>De(null,null,function*(){return yield kt.getCurrentFacilityId()}),On=(c,e=0)=>typeof c=="number"&&!isNaN(c)?c:e,vs=(c,e="Unknown")=>typeof c=="string"&&c.trim()!==""?c:e,Rn=c=>c instanceof Error?c.message:typeof c=="string"?c:"An unknown error occurred";class cv{static getItemsFromSupabase(e,t){return De(this,null,function*(){try{const r=t||(yield Dn()),i=st(r),a=Ge.getFilterSummary(e);if(!Ge.validateFilters(e))throw new Error("Invalid filter parameters");const s=yield Ge.applyFiltersToTable(i,"inventory_items",e),{data:o,error:n,count:l}=yield s.eq("facility_id",r).order("created_at",{ascending:!1});if(n)throw console.error("Error fetching items from Supabase:",n),n;return{data:(o==null?void 0:o.map(h=>U.transformFromSupabase(h)))||[],error:null,count:l||0}}catch(r){throw console.error("Failed to fetch items from Supabase:",r),r}})}static getItemByIdFromSupabase(e){return De(this,null,function*(){try{return yield mr.getItemById(e)}catch(t){return console.error("Error fetching item by ID:",t),null}})}static createItemInSupabase(e){return De(this,null,function*(){try{const{createItem:t}=yield T(()=>Promise.resolve().then(()=>_n),void 0);return yield t(e)}catch(t){throw console.error("Error creating item:",t),new Error(`Failed to create item: ${Rn(t)}`)}})}static updateItemInSupabase(e,t){return De(this,null,function*(){try{const{updateItem:r}=yield T(()=>Promise.resolve().then(()=>_n),void 0);return yield r(e,t)}catch(r){throw console.error("Error updating item:",r),new Error(`Failed to update item: ${Rn(r)}`)}})}static deleteItemFromSupabase(e){return De(this,null,function*(){try{const{deleteItem:t}=yield T(()=>Promise.resolve().then(()=>_n),void 0);yield t(e)}catch(t){throw new Error(`Failed to delete item: ${Rn(t)}`)}})}static getCategories(e){return De(this,null,function*(){try{const t=e||(yield Dn()),r=st(t),a=yield(yield Ge.applyFiltersToCategories(r,"inventory_items")).eq("facility_id",t);if(!a)throw console.error("âŒ Error fetching categories"),new Error("Failed to fetch categories");return Ge.extractUniqueValues(a.data,"category").sort()}catch(t){return console.error("Error fetching categories:",t),[]}})}static getCategoriesFromSupabase(){return De(this,null,function*(){return this.getCategories()})}static getLocations(e){return De(this,null,function*(){try{const t=e||(yield Dn()),r=st(t),a=yield(yield Ge.applyFiltersToLocations(r,"inventory_items")).eq("facility_id",t);if(!a)throw console.error("âŒ Error fetching locations"),new Error("Failed to fetch locations");return Ge.extractUniqueValues(a.data,"location").sort()}catch(t){return console.error("Error fetching locations:",t),[]}})}static getLocationsFromSupabase(){return De(this,null,function*(){return this.getLocations()})}static getInventoryStatsFromSupabase(){return De(this,null,function*(){try{const e=yield mr.getItems(),t=e.length,r=e.filter(s=>s.status==="active").length,i=e.reduce((s,o)=>s+On(o.unit_cost),0),a={};return e.forEach(s=>{const o=vs(s.category);a[o]=(a[o]||0)+1}),{totalItems:t,activeItems:r,totalValue:i,categories:a}}catch(e){return console.error("Error fetching inventory stats:",e),{totalItems:0,activeItems:0,totalValue:0,categories:{}}}})}static calculateTotalValue(e){try{return e.reduce((r,i)=>{const a=On(i.unit_cost),s=On(i.quantity,1);return r+a*s},0)}catch(t){return console.error("Error calculating total value:",t),0}}static getCategoryBreakdown(e){try{const t={};return e.forEach(r=>{const i=vs(r.category);t[i]=(t[i]||0)+1}),t}catch(t){return console.error("Error calculating category breakdown:",t),{}}}}var Zi=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function lv(c){return Zi(this,null,function*(){const{data:e,error:t}=yield d.from("locations").select("*").eq("facility_id",c).order("name",{ascending:!0});if(t)throw t;return e||[]})}function uv(c,e,t,r,i){return Zi(this,null,function*(){const{data:a,error:s}=yield d.from("locations").insert([{facility_id:c,name:e,barcode:t,parent_id:r!=null?r:null,capacity:i!=null?i:0}]).select().single();if(s)throw s;return a})}function dv(c,e){return Zi(this,null,function*(){const{data:t,error:r}=yield d.from("locations").update({status:e}).eq("id",c).select().single();if(r)throw r;return t})}function hv(c){return Zi(this,null,function*(){const{error:e}=yield d.from("locations").delete().eq("id",c);if(e)throw e})}var ws=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Sy{static generateLearningObjectives(e){return ws(this,null,function*(){try{const t=this.buildContextPrompt(e),r=yield fetch(this.API_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:t,context:"courses"})});if(!r.ok)throw new Error(`AI service responded with status ${r.status}`);const i=yield this.parseStreamingResponse(r);return this.parseObjectivesFromResponse(i)}catch(t){return console.error("Error generating learning objectives:",t),this.getFallbackObjectives(e)}})}static buildContextPrompt(e){const{title:t,description:r,prerequisites:i,linkedPrerequisites:a,difficulty:s}=e;let o=`Generate 3-5 specific, measurable learning objectives for a healthcare/sterilization course with the following details:

Course Title: "${t}"
Course Description: "${r}"
Difficulty Level: ${s}`;return i&&i.length>0&&i[0]&&(o+=`
Prerequisites: ${i.filter(n=>n.trim()).join(", ")}`),a&&a.length>0&&(o+=`
Linked Course Prerequisites: ${a.length} course(s) from our library`),o+=`

Please generate learning objectives that:
1. Use action verbs aligned with Bloom's Taxonomy
2. Are specific and measurable
3. Are appropriate for ${s} level learners
4. Focus on healthcare/sterilization context
5. Build upon the stated prerequisites

Format each objective as a JSON object with:
- "objective": the learning objective statement
- "bloomsLevel": one of [remember, understand, apply, analyze, evaluate, create]
- "reasoning": brief explanation of why this objective fits the course
- "confidence": score from 0.0 to 1.0

Return only a JSON array of objectives, no other text.`,o}static parseStreamingResponse(e){return ws(this,null,function*(){var t;const r=(t=e.body)==null?void 0:t.getReader();if(!r)throw new Error("No response body");let i="";const a=new TextDecoder;try{let s=1e3;for(;s>0;){const{done:o,value:n}=yield r.read();if(o)break;const l=a.decode(n,{stream:!0});i+=l,s--}}finally{r.releaseLock()}return i})}static parseObjectivesFromResponse(e){try{const t=e.match(/\[[\s\S]*\]/);if(!t)throw new Error("No JSON array found in response");return JSON.parse(t[0]).map(i=>({objective:i.objective||"Invalid objective",bloomsLevel:i.bloomsLevel||"understand",reasoning:i.reasoning||"AI generated",confidence:typeof i.confidence=="number"?i.confidence:.7}))}catch(t){return console.error("Error parsing AI response:",t),[]}}static getFallbackObjectives(e){const{title:t,difficulty:r}=e,i=[];return t.toLowerCase().includes("sterilization")&&(i.push({objective:"Identify proper sterilization procedures and protocols",bloomsLevel:"remember",reasoning:"Fundamental knowledge for sterilization courses",confidence:.8}),r!=="beginner"&&i.push({objective:"Evaluate sterilization effectiveness and troubleshoot issues",bloomsLevel:"evaluate",reasoning:"Advanced skill for non-beginner courses",confidence:.7})),t.toLowerCase().includes("safety")&&i.push({objective:"Apply safety protocols in healthcare environments",bloomsLevel:"apply",reasoning:"Practical application for safety courses",confidence:.8}),i.length===0&&i.push({objective:`Demonstrate understanding of ${t.toLowerCase()} concepts and procedures`,bloomsLevel:"understand",reasoning:"Generic objective based on course title",confidence:.6}),i}}Sy.API_ENDPOINT="/api/ai/openai";var by=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const fv=(c,e)=>by(null,null,function*(){try{console.log("Analytics Event:",{eventName:c,properties:e,timestamp:new Date})}catch(t){console.warn("Failed to track analytics event:",t)}});var xt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const vc=class Vr{constructor(){this.STORAGE_KEY="cliniio_trusted_devices",this.DEVICE_NAME_KEY="cliniio_device_name"}static getInstance(){return Vr.instance||(Vr.instance=new Vr),Vr.instance}generateDeviceFingerprint(){try{const e=document.createElement("canvas"),t=e.getContext("2d");t&&(t.textBaseline="top",t.font="14px Arial",t.fillText("Device fingerprint",2,2));const r=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,new Date().getTimezoneOffset(),e.toDataURL()].join("|");return btoa(r).replace(/[^a-zA-Z0-9]/g,"").substring(0,32)}catch(e){return"unknown_device"}}getDeviceName(){const e=localStorage.getItem(this.DEVICE_NAME_KEY);if(e)return e;const t=navigator.userAgent;let r="Unknown Device";return t.includes("Windows")?r="Windows Device":t.includes("Mac")?r="Mac Device":t.includes("Linux")?r="Linux Device":t.includes("Android")?r="Android Device":(t.includes("iPhone")||t.includes("iPad"))&&(r="iOS Device"),t.includes("Chrome")?r+=" (Chrome)":t.includes("Firefox")?r+=" (Firefox)":t.includes("Safari")?r+=" (Safari)":t.includes("Edge")&&(r+=" (Edge)"),localStorage.setItem(this.DEVICE_NAME_KEY,r),r}storeTrustedDevice(e,t){return xt(this,null,function*(){try{const r=this.getDeviceName(),{error:i}=yield d.from("trusted_devices").upsert({user_id:e,device_fingerprint:t,device_name:r,last_used:new Date().toISOString(),is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});return i?(console.error("Failed to store trusted device:",i),!1):(this.storeDeviceLocally(t,r),!0)}catch(r){return console.error("Error storing trusted device:",r),!1}})}isDeviceTrusted(e){return xt(this,null,function*(){try{const t=this.generateDeviceFingerprint(),{data:r,error:i}=yield d.from("trusted_devices").select("id, last_used, is_active").eq("user_id",e).eq("device_fingerprint",t).eq("is_active",!0).single();return i||!r?!1:(yield this.updateLastUsed(r.id),!0)}catch(t){return console.error("Error checking trusted device:",t),!1}})}getTrustedDevices(e){return xt(this,null,function*(){try{const{data:t,error:r}=yield d.from("trusted_devices").select("*").eq("user_id",e).eq("is_active",!0).order("last_used",{ascending:!1});return r?(console.error("Failed to get trusted devices:",r),[]):t||[]}catch(t){return console.error("Error getting trusted devices:",t),[]}})}removeTrustedDevice(e){return xt(this,null,function*(){try{const{error:t}=yield d.from("trusted_devices").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",e);return t?(console.error("Failed to remove trusted device:",t),!1):!0}catch(t){return console.error("Error removing trusted device:",t),!1}})}updateLastUsed(e){return xt(this,null,function*(){try{yield d.from("trusted_devices").update({last_used:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",e)}catch(t){console.error("Error updating last used:",t)}})}storeDeviceLocally(e,t){try{const r={fingerprint:e,name:t,timestamp:new Date().toISOString()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(r))}catch(r){console.error("Error storing device locally:",r)}}getLocalDeviceInfo(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return null;const t=JSON.parse(e),r=new Date(Date.now()-720*60*60*1e3);return new Date(t.timestamp)<r?(localStorage.removeItem(this.STORAGE_KEY),null):t}catch(e){return console.error("Error getting local device info:",e),null}}clearAllTrustedDevices(e){return xt(this,null,function*(){try{const{error:t}=yield d.from("trusted_devices").update({is_active:!1,updated_at:new Date().toISOString()}).eq("user_id",e);return t?(console.error("Failed to clear trusted devices:",t),!1):(localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.DEVICE_NAME_KEY),!0)}catch(t){return console.error("Error clearing trusted devices:",t),!1}})}};vc.instance=null;let Ey=vc;const mv=Ey.getInstance();var Ay=Object.defineProperty,Is=Object.getOwnPropertySymbols,Ty=Object.prototype.hasOwnProperty,ky=Object.prototype.propertyIsEnumerable,Ss=(c,e,t)=>e in c?Ay(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,xr=(c,e)=>{for(var t in e||(e={}))Ty.call(e,t)&&Ss(c,t,e[t]);if(Is)for(var t of Is(e))ky.call(e,t)&&Ss(c,t,e[t]);return c},$n=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});const Cy={maxAttempts:en.RATE_LIMIT.MAX_ATTEMPTS,lockoutDuration:en.RATE_LIMIT.LOCKOUT_DURATION_MINUTES,windowSize:en.RATE_LIMIT.WINDOW_SIZE_MINUTES};class Py{constructor(e={}){this.config=xr(xr({},Cy),e),this.distributedLimiter=new Ke({maxRequests:this.config.maxAttempts,windowMs:this.config.windowSize*60*1e3,keyPrefix:"auth",blockDurationMs:this.config.lockoutDuration*60*1e3})}checkRateLimit(e){return $n(this,null,function*(){try{const t=yield this.distributedLimiter.checkRateLimit(e);if(!t.allowed)return{isLocked:!0,remainingAttempts:0,lockoutTime:t.resetTime,error:`Too many failed attempts. Please try again in ${t.retryAfter||0} seconds.`};const{data:r,error:i}=yield d.from("login_attempts").select("*").eq("email",e).gte("attempted_at",new Date(Date.now()-this.config.windowSize*60*1e3).toISOString()).order("attempted_at",{ascending:!1}),s=(r||[]).filter(o=>!o.success);if(s.length>=this.config.maxAttempts){const o=s[0],n=new Date(o.attempted_at);if(n.setMinutes(n.getMinutes()+this.config.lockoutDuration),n>new Date)return{isLocked:!0,remainingAttempts:0,lockoutTime:n.getTime(),error:"Account temporarily locked due to repeated failed attempts. Please try again later."}}return{isLocked:!1,remainingAttempts:t.remaining}}catch(t){return{isLocked:!1,remainingAttempts:this.config.maxAttempts}}})}recordAttempt(e,t,r){return $n(this,null,function*(){try{const{error:i}=yield d.from("login_attempts").insert({email:e,success:t,attempted_at:new Date().toISOString(),ip_address:r||"unknown",user_agent:navigator.userAgent})}catch(i){}})}resetRateLimit(e){return $n(this,null,function*(){try{yield this.distributedLimiter.resetRateLimit(e);const{error:t}=yield d.from("login_attempts").delete().eq("email",e)}catch(t){}})}getConfig(){return xr({},this.config)}updateConfig(e){this.config=xr(xr({},this.config),e)}}const pv=new Py;const gv=c=>{try{console.log("[AUDIT]",c)}catch(e){}},Dy=600*1e3,Pe={MAX_LIFECYCLE:95,MIN_LIFECYCLE:10,LIFECYCLE_MULTIPLIER:2.5,ANALYSIS_DAYS:90,MAX_CYCLES_PER_DAY:.1,MIN_CONFIDENCE:.6,MAX_CONFIDENCE:.95,CONFIDENCE_BASE:.75,REORDER_DAYS_BEFORE_EOL:30,MIN_REORDER_DAYS:7},ee={ANALYSIS_DAYS:30,RECENT_ANALYSIS_DAYS:7,MAX_CAPACITY_PER_DAY:24,MIN_LOAD_PERCENTAGE:10,MAX_LOAD_PERCENTAGE:100,HIGH_USAGE_THRESHOLD:20,MEDIUM_USAGE_THRESHOLD:15,HIGH_OVERLOAD_DAYS:15,MEDIUM_OVERLOAD_DAYS:45,LOW_OVERLOAD_DAYS:90,HIGH_LOAD_THRESHOLD:90,MEDIUM_LOAD_THRESHOLD:75,LOW_LOAD_THRESHOLD:60,HIGH_QUEUE_THRESHOLD:5,HIGH_FAILURE_RATE:.1,PATIENT_LOAD_MULTIPLIER:1.2},bs={ANALYSIS_DAYS:365,PROJECTION_MONTHS:.5},Bt={ANALYSIS_DAYS:30,DEFAULT_FTE:8.5,WORKLOAD_INCREASE_THRESHOLD:20,FTE_INCREASE:.5,COST_PER_FTE:5e4},jt={ANALYSIS_DAYS:30,GROWTH_RATE:1.1,INCIDENT_RATE:.3,HIGH_WORKLOAD_THRESHOLD:20,MEDIUM_WORKLOAD_THRESHOLD:10,HIGH_COVERAGE_THRESHOLD:15},ar={IMMEDIATE:"Immediate",Q1_2025:"Q1 2025",Q2_2025:"Q2 2025",Q3_2025:"Q3 2025",NEXT_QUARTER:"Next quarter",MONITOR_3_MONTHS:"Monitor for 3 months"},Ri={ADD_AUTOCLAVE:"add_autoclave",EXTEND_HOURS:"extend_hours",OPTIMIZE_SCHEDULE:"optimize_schedule"},Mn={LOW:"low",MEDIUM:"medium",HIGH:"high"};var Oy=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class or{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return or.instance||(or.instance=new or),or.instance}getToolReplacementForecast(){return Oy(this,arguments,function*(e={}){try{const t=`tool_replacement_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for tool replacement forecast"),[];const{data:i,error:a}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-Pe.ANALYSIS_DAYS*24*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(a||!i||i.length===0)return console.warn("No sterilization data found for tool replacement forecast"),[];const s=i.slice(0,5).map((o,n)=>{var l;const u=i.filter(w=>w.tool_batch_id===o.tool_batch_id).length,h=Math.min(Pe.MAX_LIFECYCLE,Math.max(Pe.MIN_LIFECYCLE,Math.floor(u*Pe.LIFECYCLE_MULTIPLIER))),f=u/Pe.ANALYSIS_DAYS,p=Math.max(0,100-h)/Math.max(Pe.MAX_CYCLES_PER_DAY,f),y=new Date(Date.now()+p*24*60*60*1e3).toISOString().split("T")[0],g=Math.min(Pe.MAX_CONFIDENCE,Math.max(Pe.MIN_CONFIDENCE,Pe.CONFIDENCE_BASE+u/100)),_=new Date(Date.now()+Math.max(Pe.MIN_REORDER_DAYS,p-Pe.REORDER_DAYS_BEFORE_EOL)*24*60*60*1e3).toISOString().split("T")[0];return{toolBatchId:(l=o.tool_batch_id)!=null?l:`TB${String(n+1).padStart(3,"0")}`,toolName:`Tool Set ${String.fromCharCode(65+n)}`,currentLifecycle:h,predictedEndOfLife:y,confidence:g,recommendedReorderDate:_,supplierSuggestion:"Contact procurement for supplier information",estimatedCost:0}});return this.setCachedData(t,s),s}catch(t){return console.error("Error forecasting tool replacement:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var Ry=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class sr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return sr.instance||(sr.instance=new sr),sr.instance}getAutoclaveCapacityForecast(){return Ry(this,arguments,function*(e={}){try{const t=`autoclave_capacity_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for autoclave capacity forecast"),[];const{data:i,error:a}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).not("autoclave_id","is",null).gte("created_at",new Date(Date.now()-ee.ANALYSIS_DAYS*24*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(a||!i||i.length===0)return console.warn("No autoclave data found for capacity forecast"),[];const{data:s,error:o}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-ee.RECENT_ANALYSIS_DAYS*24*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(o)return console.warn("Failed to fetch recent cycles for autoclave capacity forecast"),[];const n=i.reduce((u,h)=>{var f;const m=(f=h.autoclave_id)!=null?f:"";return m&&(u[m]||(u[m]=[]),u[m].push(h)),u},{}),l=Object.entries(n).map(([u,h])=>{const f=h.length,m=h.filter(B=>B.status==="clean").length,p=h.filter(B=>B.status==="problem").length,y=f/ee.ANALYSIS_DAYS,g=ee.MAX_CAPACITY_PER_DAY,_=Math.min(ee.MAX_LOAD_PERCENTAGE,Math.max(ee.MIN_LOAD_PERCENTAGE,Math.round(y/g*100))),E=((s==null?void 0:s.filter(B=>B.autoclave_id===u&&B.status==="pending"||B.status==="in_progress"))||[]).length,b=y>ee.HIGH_USAGE_THRESHOLD?"high":y>ee.MEDIUM_USAGE_THRESHOLD?"medium":"low",P=b==="high"?ee.HIGH_OVERLOAD_DAYS:b==="medium"?ee.MEDIUM_OVERLOAD_DAYS:ee.LOW_OVERLOAD_DAYS,S=new Date(Date.now()+P*24*60*60*1e3).toISOString().split("T")[0];let Y,J;return _>ee.HIGH_LOAD_THRESHOLD||p>f*ee.HIGH_FAILURE_RATE?(Y=Ri.ADD_AUTOCLAVE,J=ar.IMMEDIATE):_>ee.MEDIUM_LOAD_THRESHOLD||E>ee.HIGH_QUEUE_THRESHOLD?(Y=Ri.EXTEND_HOURS,J=ar.Q1_2025):_>ee.LOW_LOAD_THRESHOLD?(Y=Ri.OPTIMIZE_SCHEDULE,J=ar.Q2_2025):(Y=Ri.OPTIMIZE_SCHEDULE,J=ar.Q3_2025),{autoclaveId:u,currentLoadPercentage:_,queueLength:E,predictedOverloadDate:S,recommendedAction:Y,timeline:J,projectedPatientLoad:Math.round(m*ee.PATIENT_LOAD_MULTIPLIER)}});return this.setCachedData(t,l),l}catch(t){return console.error("Error forecasting autoclave capacity:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var $y=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class cr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return cr.instance||(cr.instance=new cr),cr.instance}getInventoryInflationForecast(){return $y(this,arguments,function*(e={}){try{const t=`inventory_inflation_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for inventory inflation forecast"),[];const i=yield mr.getItems();let a=i;e.facilityId&&(a=i.filter(l=>l.facility_id===e.facilityId));const s=new Date(Date.now()-bs.ANALYSIS_DAYS*24*60*60*1e3);if(a=a.filter(l=>l.created_at&&new Date(l.created_at)>=s),a.sort((l,u)=>new Date(u.created_at||"").getTime()-new Date(l.created_at||"").getTime()),!a||a.length===0)return console.warn("No inventory data found for inflation forecast"),[];const o=a.reduce((l,u)=>{var h,f;const m=(f=(h=u.data)==null?void 0:h.category)!=null?f:"Uncategorized";return l[m]||(l[m]=[]),l[m].push(u),l},{}),n=Object.entries(o).map(([l,u])=>{var h,f;const m=u.map(w=>{var E;return((E=w.data)==null?void 0:E.unit_cost)||0}).filter(w=>w>0);if(m.length===0)return null;const p=(h=m[m.length-1])!=null?h:0,y=(f=m[0])!=null?f:0,g=p-y,_=y>0?g/y*100:0;return{category:l,currentPrice:p,priceIncrease:g,inflationRate:_,projectedYearEndPrice:p*(1+_/100*bs.PROJECTION_MONTHS),cheaperSupplierExists:!1,alternativeSupplier:void 0,costSavings:0}}).filter(Boolean);return this.setCachedData(t,n),n}catch(t){return console.error("Error forecasting inventory inflation:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var My=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class lr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return lr.instance||(lr.instance=new lr),lr.instance}getClinicalStaffingForecast(){return My(this,arguments,function*(e={}){try{const t=`clinical_staffing_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for clinical staffing forecast"),[];const{data:i,error:a}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-Bt.ANALYSIS_DAYS*24*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(a||!i||i.length===0)return console.warn("No sterilization data found for clinical staffing forecast"),[];const s=i.length,o=i.filter(f=>f.status!=="clean"&&f.status!=="problem").length,n=Bt.DEFAULT_FTE,l=Math.max(0,o/s*100),u=l>Bt.WORKLOAD_INCREASE_THRESHOLD?n+Bt.FTE_INCREASE:n,h=[{currentFTE:n,recommendedFTE:u,timeline:l>Bt.WORKLOAD_INCREASE_THRESHOLD?ar.NEXT_QUARTER:ar.MONITOR_3_MONTHS,workloadIncrease:l,skillsetGaps:[],trainingRecommendations:[],estimatedCost:Math.round((u-n)*Bt.COST_PER_FTE)}];return this.setCachedData(t,h),h}catch(t){return console.error("Error forecasting clinical staffing:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var qy=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class ur{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return ur.instance||(ur.instance=new ur),ur.instance}getAdminStaffingForecast(){return qy(this,arguments,function*(e={}){try{const t=`admin_staffing_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for admin staffing forecast"),[];const{data:i,error:a}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-jt.ANALYSIS_DAYS*24*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(a||!i||i.length===0)return console.warn("No sterilization data found for admin staffing forecast"),[];const s=i.length,o=i.filter(y=>y.status!=="clean"&&y.status!=="problem").length,n=s,l=Math.round(s*jt.GROWTH_RATE),u=Math.max(0,l-n),h=Math.floor(o*jt.INCIDENT_RATE),f=o>0?Math.max(1,Math.floor(o/2)):0;let m;u>jt.HIGH_WORKLOAD_THRESHOLD?m=Mn.HIGH:u>jt.MEDIUM_WORKLOAD_THRESHOLD?m=Mn.MEDIUM:m=Mn.LOW;const p=[{currentWorkload:n,projectedWorkload:l,workloadExcess:u,recommendedCoverage:u>jt.HIGH_COVERAGE_THRESHOLD?"Additional 0.5 FTE admin support":"Current staffing adequate",qualityIncidents:h,resolutionLag:f,priority:m}];return this.setCachedData(t,p),p}catch(t){return console.error("Error forecasting admin staffing:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var zy=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class dr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return dr.instance||(dr.instance=new dr),dr.instance}getTheftLossEstimate(){return zy(this,arguments,function*(e={}){try{const t=`theft_loss_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for theft/loss estimation"),{estimatedLossPercentage:0,estimatedLossValue:0,flaggedItems:[],repeatOffenders:[],riskFactors:[],recommendedActions:[],confidence:0};const{data:i,error:a}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(a||!i||i.length===0)return console.warn("No sterilization data found for theft/loss estimation"),{estimatedLossPercentage:0,estimatedLossValue:0,flaggedItems:[],repeatOffenders:[],riskFactors:[],recommendedActions:[],confidence:0};const s=i.length,o=i.filter(f=>f.status!=="clean"&&f.status!=="problem").length,n=Math.min(10,Math.max(0,o/s*100)),l=Math.round(n*1e3),u=i.filter(f=>f.status!=="clean").map(f=>`Tool ${f.id}`).slice(0,3),h={estimatedLossPercentage:Math.round(n*10)/10,estimatedLossValue:l,flaggedItems:u.length>0?u:["No specific items flagged"],repeatOffenders:[],riskFactors:o>0?["Incomplete sterilization cycles","Missing cycle documentation","Protocol non-compliance"]:["Minimal risk factors detected"],recommendedActions:["Complete incomplete sterilization cycles","Review cycle documentation procedures","Monitor compliance metrics"],confidence:Math.max(.5,1-n/100)};return this.setCachedData(t,h),h}catch(t){return console.error("Error estimating theft/loss:",t),{estimatedLossPercentage:0,estimatedLossValue:0,flaggedItems:[],repeatOffenders:[],riskFactors:[],recommendedActions:[],confidence:0}}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var Uy=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class hr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return hr.instance||(hr.instance=new hr),hr.instance}getSupplyDepletionForecast(){return Uy(this,arguments,function*(e={}){try{const t=`supply_depletion_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for supply depletion forecast"),[];const i=yield mr.getItems();let a=i;if(e.facilityId&&(a=i.filter(o=>o.facility_id===e.facilityId)),a.sort((o,n)=>(o.quantity||0)-(n.quantity||0)),!a||a.length===0)return console.warn("No inventory data found for supply depletion forecast"),[];const s=a.slice(0,8).map((o,n)=>{var l,u,h,f,m,p,y;const g=(l=o.quantity)!=null?l:0,_=(h=(u=o.data)==null?void 0:u.reorder_point)!=null?h:100,w=(m=(f=o.data)==null?void 0:f.unit_cost)!=null?m:50;let E;g<=_*.5?E="critical":g<=_*.8?E="high":g<=_*1.2?E="medium":E="low";const b=Math.ceil(g/(_/30)),P=new Date(Date.now()+b*24*60*60*1e3),S=new Date(P.getTime()-10080*60*1e3);return{itemName:(p=o.name)!=null?p:`Item ${n+1}`,currentStock:g,depletionDate:P.toISOString().split("T")[0],reorderUrgency:E,recommendedReorderDate:S.toISOString().split("T")[0],currentCost:w,historicalCosts:[w*.95,w*.98,w],costTrend:w>(((y=o.data)==null?void 0:y.last_restocked_cost)||w)?"increasing":"stable"}});return this.setCachedData(t,s),s}catch(t){return console.error("Error forecasting supply depletion:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var Fy=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class fr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return fr.instance||(fr.instance=new fr),fr.instance}getEfficiencyROITracker(){return Fy(this,arguments,function*(e={}){try{const t=`efficiency_roi_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for efficiency ROI tracking"),null;const{data:i,error:a}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(a||!i||i.length===0)return console.warn("No sterilization data found for efficiency ROI tracking"),null;const s=i.length,o=i.filter(m=>m.status==="clean").length,n=s>0?o/s*100:0,l=Math.round(n/100*40),u=l*42,h=u*12,f={timeSavedHours:l,estimatedLaborSavings:u,aiFeatureUsage:[{feature:"Automated scheduling",usageCount:Math.floor(s*.8),timeSaved:Math.round(l*.3)},{feature:"Smart inventory alerts",usageCount:Math.floor(s*.6),timeSaved:Math.round(l*.2)},{feature:"Predictive maintenance",usageCount:Math.floor(s*.4),timeSaved:Math.round(l*.1)}],automationEfficiency:Math.round(n),moduleContributions:[{module:"Sterilization",timeSaved:Math.round(l*.5),costSavings:Math.round(u*.5),efficiency:Math.round(n)},{module:"Inventory",timeSaved:Math.round(l*.3),costSavings:Math.round(u*.3),efficiency:Math.round(n*.9)},{module:"Environmental",timeSaved:Math.round(l*.2),costSavings:Math.round(u*.2),efficiency:Math.round(n*.8)}],projectedAnnualSavings:h};return this.setCachedData(t,f),f}catch(t){return console.error("Error tracking efficiency ROI:",t),null}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}function Ly(c){const e=new Array(24).fill(0);c.forEach(i=>{if(i.created_at){const a=new Date(i.created_at).getHours();e[a]++}});const t=Math.max(...e),r=e.map((i,a)=>({count:i,hour:a})).filter(({count:i})=>i>=t*.8).map(({hour:i})=>`${i.toString().padStart(2,"0")}:00`).slice(0,4);return r.length>0?r:["09:00","12:00","15:00"]}function Ny(c){return c>=90?"Excellent utilization - maintain current practices":c>=80?"Good utilization - minor optimizations possible":c>=70?"Moderate utilization - consider schedule optimization":"Low utilization - review tool allocation and scheduling"}function xy(c){const e=[];return c<80&&e.push("Low utilization efficiency"),c<70&&e.push("Significant idle time detected"),e.length>0?e:["Minimal bottlenecks detected"]}var qn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class dt{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return dt.instance||(dt.instance=new dt),dt.instance}getToolTurnoverUtilization(){return qn(this,arguments,function*(e={}){try{const t=`tool_turnover_utilization_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for tool turnover utilization"),[];const{data:i,error:a}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(a||!i||i.length===0)return console.warn("No sterilization data found for tool turnover utilization"),[];const s=i.reduce((n,l)=>{var u;const h=(u=l.tool_batch_id)!=null?u:"";return h&&(n[h]||(n[h]=[]),n[h].push(l)),n},{}),o=Object.entries(s).map(([n,l])=>{const u=l.length,h=Math.min(100,u/7*100),f=u/7,m=Ly(l),p=Math.min(100,Math.max(50,h)),y=f,g=Math.max(0,100-p);return{toolBatchId:n,toolName:`Tool ${n}`,dailyCycleCount:u,weeklyUtilization:h,averageCyclesPerDay:f,peakUsageHours:m,utilizationEfficiency:p,turnoverRate:y,idleTimePercentage:g,recommendedOptimization:Ny(p),bottleneckIndicators:xy(p),performanceScore:Math.round(p)}});return this.setCachedData(t,o),o}catch(t){return console.error("Error analyzing tool turnover utilization:",t),[]}})}getSterilizationMetrics(){return qn(this,arguments,function*(e={}){try{if(!e.facilityId)return{biPassRate:0,cycleEfficiency:0,qualityScore:0};const{data:t}=yield d.from("bi_test_results").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString()),{data:r}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString());let i=100;if(t&&t.length>0){const o=Array.isArray(t)?t.filter(n=>n.result==="pass").length:0;i=Math.round(o/t.length*100)}let a=100;if(r&&r.length>0){const o=r.filter(n=>n.status==="clean").length;a=Math.round(o/r.length*100)}const s=Math.round((i+a)/2);return{biPassRate:i,cycleEfficiency:a,qualityScore:s}}catch(t){return console.error("Error getting sterilization metrics:",t),{biPassRate:0,cycleEfficiency:0,qualityScore:0}}})}getInventoryMetrics(){return qn(this,arguments,function*(e={}){try{if(!e.facilityId)return{turnoverRate:0,stockLevel:0,reorderEfficiency:0};const t=yield mr.getItems();let r=t;e.facilityId&&(r=t.filter(o=>o.facility_id===e.facilityId));let i=80;if(r&&r.length>0){const o=r.filter(l=>{var u;return((u=l.status)!=null?u:"")==="active"}).length,n=r.length;n>0&&(i=Math.round(o/n*100))}let a=100;if(r&&r.length>0){const o=r.filter(n=>{var l;return n.quantity>((l=n.reorder_point)!=null?l:0)}).length;a=Math.round(o/r.length*100)}const s=Math.round((i+a)/2);return{turnoverRate:i,stockLevel:a,reorderEfficiency:s}}catch(t){return console.error("Error getting inventory metrics:",t),{turnoverRate:0,stockLevel:0,reorderEfficiency:0}}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var Es=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Tt{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return Tt.instance||(Tt.instance=new Tt),Tt.instance}getAuditRiskScore(){return Es(this,arguments,function*(e={}){try{const t=`audit_risk_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for audit risk score"),null;const{data:i,error:a}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-10080*60*1e3).toISOString()).order("created_at",{ascending:!1});if(a||!i)return console.warn("Failed to fetch sterilization data for audit risk assessment"),null;const s=i.length,o=i.filter(y=>y.status!=="clean"&&y.status!=="problem").length,{data:n,error:l}=yield d.from("biological_indicators").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-10080*60*1e3).toISOString()),u=l||!n?0:Array.isArray(n)?n.filter(y=>y.status==="skipped"||y.status==="pending").length:0,h=Math.max(0,o/s*100),f=Math.min(100,Math.max(0,o/s*40+u*15+h*.4));let m;f>=80?m="critical":f>=60?m="high":f>=40?m="medium":m="low";const p={overallRiskScore:Math.round(f),riskLevel:m,riskFactors:[{factor:"Incomplete cycles",severity:Math.min(10,Math.max(1,Math.round(o/s*10))),description:`${o} sterilization cycles incomplete this week`},{factor:"Policy adherence",severity:Math.min(10,Math.max(1,Math.round((100-h)/10))),description:`Protocol adherence at ${Math.round(100-h)}%`}],skippedIndicators:u,incompleteCycles:o,policyDrift:h,recommendedActions:["Complete incomplete sterilization cycles","Review and reinforce protocol training","Monitor BI/CI test completion rates"]};return this.setCachedData(t,p),p}catch(t){return console.error("Error assessing audit risk:",t),null}})}getTrainingKnowledgeGaps(){return Es(this,arguments,function*(e={}){try{const t=`training_gaps_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for training knowledge gaps"),null;const{data:i,error:a}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(a||!i||i.length===0)return console.warn("No sterilization data found for training gap analysis"),null;const s=i.reduce((m,p)=>{var y,g,_,w,E,b;const P=(g=(y=p.operator_id)!=null?y:p.user_id)!=null?g:"";return P&&(m[P]||(m[P]={cycles:[],failedSteps:[],performanceMetrics:[]}),m[P].cycles.push(p),p.status!=="clean"&&m[P].failedSteps.push(`Cycle ${p.id} - ${p.status}`),p.status==="clean"&&m[P].performanceMetrics.push({cycleId:(_=p.id)!=null?_:"",duration:(w=p.duration_minutes)!=null?w:0,temperature:(E=p.temperature_celsius)!=null?E:0,pressure:(b=p.pressure_psi)!=null?b:0})),m},{}),o=Object.entries(s).map(([m,p])=>{const y=p.failedSteps.length>0,g=p.performanceMetrics.length>0?p.performanceMetrics.reduce((w,E)=>w+E.duration,0)/p.performanceMetrics.length:0;let _=[];return y?_=["Review sterilization protocols","Complete cycle documentation training","Practice emergency shutdown procedures"]:g>60?_=["Optimize cycle timing procedures","Review load preparation best practices","Efficiency improvement training"]:_=["Maintain current training standards","Advanced sterilization techniques","Quality assurance best practices"],{userId:m,userName:`User ${m}`,failedSteps:p.failedSteps.slice(0,3),skippedContent:[],recommendedTraining:_,performanceMetrics:{totalCycles:p.cycles.length,successRate:p.cycles.length>0?(p.cycles.length-p.failedSteps.length)/p.cycles.length*100:100,averageDuration:Math.round(g)}}}),n=o.length,l=o.filter(m=>m.failedSteps.length>0).length,u=n>0?o.reduce((m,p)=>m+p.performanceMetrics.successRate,0)/n:100,h=Math.min(100,Math.max(0,l/n*40+(100-u)/100*30+(n<3?20:0)+(o.some(m=>m.performanceMetrics.averageDuration>60)?10:0))),f={usersWithGaps:o,overallGapScore:Math.round(h),criticalGaps:o.filter(m=>m.failedSteps.length>2||m.performanceMetrics.successRate<80).map(()=>"Sterilization protocol adherence"),knowledgeHubRecommendations:["Review sterilization SOPs","Complete cycle documentation training","Monitor user performance metrics","Efficiency optimization training","Quality assurance procedures"]};return this.setCachedData(t,f),f}catch(t){return console.error("Error analyzing training gaps:",t),null}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var Se=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Hr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=Dy}static getInstance(){return Hr.instance||(Hr.instance=new Hr),Hr.instance}getToolReplacementForecast(){return Se(this,arguments,function*(e={}){return or.getInstance().getToolReplacementForecast(e)})}getAutoclaveCapacityForecast(){return Se(this,arguments,function*(e={}){return sr.getInstance().getAutoclaveCapacityForecast(e)})}getInventoryInflationForecast(){return Se(this,arguments,function*(e={}){return cr.getInstance().getInventoryInflationForecast(e)})}getClinicalStaffingForecast(){return Se(this,arguments,function*(e={}){return lr.getInstance().getClinicalStaffingForecast(e)})}getAdminStaffingForecast(){return Se(this,arguments,function*(e={}){return ur.getInstance().getAdminStaffingForecast(e)})}getTheftLossEstimate(){return Se(this,arguments,function*(e={}){return dr.getInstance().getTheftLossEstimate(e)})}getSupplyDepletionForecast(){return Se(this,arguments,function*(e={}){return hr.getInstance().getSupplyDepletionForecast(e)})}getToolTurnoverUtilization(){return Se(this,arguments,function*(e={}){return dt.getInstance().getToolTurnoverUtilization(e)})}getAuditRiskScore(){return Se(this,arguments,function*(e={}){return Tt.getInstance().getAuditRiskScore(e)})}getTrainingKnowledgeGaps(){return Se(this,arguments,function*(e={}){return Tt.getInstance().getTrainingKnowledgeGaps(e)})}getEfficiencyROITracker(){return Se(this,arguments,function*(e={}){return fr.getInstance().getEfficiencyROITracker(e)})}getIntelligenceSummary(){return Se(this,arguments,function*(e={},t=!1){try{const r=`intelligence_summary_${JSON.stringify(e)}`;t&&this.clearCache("intelligence_summary");const i=this.getCachedData(r);if(i&&!t)return i;const[a,s,o,n,l,u,h,f,m,p,y,g,_]=yield Promise.all([this.getToolReplacementForecast(e),this.getAutoclaveCapacityForecast(e),this.getInventoryInflationForecast(e),this.getClinicalStaffingForecast(e),this.getAdminStaffingForecast(e),this.getTheftLossEstimate(e),this.getSupplyDepletionForecast(e),this.getToolTurnoverUtilization(e),this.getAuditRiskScore(e),this.getTrainingKnowledgeGaps(e),this.getEfficiencyROITracker(e),dt.getInstance().getSterilizationMetrics(e),dt.getInstance().getInventoryMetrics(e)]),w=n[0]||null,E=l[0]||null,b={toolReplacement:a,autoclaveCapacity:s,inventoryInflation:o,clinicalStaffing:w,adminStaffing:E,theftLoss:u,supplyDepletion:h,toolTurnoverUtilization:f,auditRisk:m||{overallRiskScore:0,riskLevel:"low",riskFactors:[],skippedIndicators:0,incompleteCycles:0,policyDrift:0,recommendedActions:[]},trainingGaps:p||{usersWithGaps:[],overallGapScore:0,criticalGaps:[],knowledgeHubRecommendations:[]},efficiencyROI:y||{timeSavedHours:0,estimatedLaborSavings:0,aiFeatureUsage:[],automationEfficiency:0,moduleContributions:[],projectedAnnualSavings:0},sterilization:g,inventory:_,lastUpdated:new Date().toISOString(),confidence:.89};return this.setCachedData(r,b),b}catch(r){throw console.error("Error generating intelligence summary:",r),r}})}clearCache(e){e?Array.from(this.cache.keys()).filter(r=>r.startsWith(e)).forEach(r=>this.cache.delete(r)):this.cache.clear()}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}function By(c){return c.sort((e,t)=>{const r={critical:4,high:3,medium:2,low:1},i=r[t.priority]-r[e.priority];return i!==0?i:t.confidence-e.confidence})}function jy(c){return c.sort((e,t)=>t.priority-e.priority)}function Vy(c){return c.sort((e,t)=>{const r={critical:3,high:2,medium:1,low:0};return r[t.severity]-r[e.severity]})}function Hy(c){return{cost_optimization:"cost_savings",risk_mitigation:"risk_mitigation",efficiency_improvement:"efficiency",training_needed:"training",capacity_planning:"capacity",compliance_issue:"compliance"}[c]||"efficiency"}function Gy(c,e){const t=(c+e)/2;return t>.9?"critical":t>.8?"high":t>.7?"medium":"low"}function Wy(c){var e;return c.recommendation_reason||`AI analysis suggests ${((e=c.content_context)==null?void 0:e.category)||"optimization"} opportunities based on your usage patterns.`}function Ky(c){const e=Number(c.recommendation_score)||.5;return{costSavings:e*1e3,timeSavings:e*2,riskReduction:e*50,efficiencyGain:e*30}}function Qy(c){return c.recommendation_type&&console.debug("AI recommendation type available for action items"),["Review AI-generated insights","Implement suggested optimizations","Monitor performance improvements","Provide feedback for learning"]}function Yy(c){const e=c.recommendation_score||.5;return e>.9?"Immediate":e>.8?"1-2 weeks":e>.7?"2-4 weeks":"1-2 months"}function Jy(c){return c.feature_vector&&console.debug("Feature vector available for metrics extraction"),["ai_confidence","user_behavior","performance_patterns"]}function Xy(c){return c>.9?"critical":c>.8?"high":c>.7?"medium":"low"}var zn=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class It{static generateHybridRecommendations(e,t,r){return zn(this,null,function*(){var i,a;const s=[];return r&&console.debug("User insights available for recommendations"),t.forEach(o=>{var n;o.recommendation_score>.7&&s.push({id:`ai_${o.id}`,type:Hy(o.recommendation_type),priority:Gy(o.recommendation_score,o.confidence_level),title:o.recommendation_reason||"AI-Generated Recommendation",description:Wy(o),impact:Ky(o),actionItems:Qy(o),timeline:Yy(o),confidence:o.confidence_level||.8,category:((n=o.content_context)==null?void 0:n.category)||"general",relatedMetrics:Jy(o)})}),((i=e.auditRisk)==null?void 0:i.riskLevel)==="critical"&&s.push(this.createCriticalAuditRecommendation(e)),(a=e.supplyDepletion)!=null&&a.some(o=>o.reorderUrgency==="critical")&&s.push(this.createCriticalSupplyRecommendation(e)),s})}static generateAIOptimizationTips(e,t,r){return zn(this,null,function*(){const i=[];return t&&(t.skill_gaps||[]).forEach((s,o)=>{i.push({id:`ai_skill_gap_${o}`,category:"compliance",title:`Address Skill Gap: ${s}`,description:`AI analysis indicates a skill gap in ${s} that may impact performance.`,currentState:`Current skill level: ${t.learning_efficiency_score||70}%`,recommendedAction:"Complete targeted training modules and practice exercises",expectedOutcome:`Improve ${s} proficiency by 25%`,difficulty:"medium",estimatedEffort:"2-3 weeks",priority:8})}),r!=null&&r.efficiency_score&&r.efficiency_score<80&&i.push({id:"ai_efficiency_optimization",category:"sterilization",title:"Optimize Workflow Efficiency",description:"AI analysis shows workflow efficiency below optimal levels.",currentState:`Current efficiency: ${(r==null?void 0:r.efficiency_score)||70}%`,recommendedAction:"Review and optimize high-frequency workflows",expectedOutcome:"Increase efficiency by 15-20%",difficulty:"medium",estimatedEffort:"3-4 weeks",priority:7}),i})}static generateIntelligentRiskAlerts(e,t,r){return zn(this,null,function*(){var i;const a=[];return r&&console.debug("Risk patterns available for analysis"),t.forEach(s=>{s.risk_score>.8&&a.push({id:`ai_risk_${s.id}`,severity:Xy(s.risk_score),title:s.risk_title||"AI-Detected Risk",description:s.risk_description||"AI analysis has identified a potential risk.",riskFactors:s.risk_factors||[],immediateActions:s.immediate_actions||[],longTermSolutions:s.long_term_solutions||[],escalationPath:s.escalation_path||"Notify supervisor",deadline:s.deadline||"48 hours",status:"open"})}),((i=e.auditRisk)==null?void 0:i.riskLevel)==="critical"&&a.push(this.createCriticalAuditAlert(e)),a})}static generateFallbackRecommendations(e){var t;const r=[];return((t=e.auditRisk)==null?void 0:t.riskLevel)==="critical"&&r.push({id:"fallback_audit_risk",type:"compliance",priority:"critical",title:"Critical Audit Risk Mitigation Required",description:`Overall audit risk score: ${e.auditRisk.overallRiskScore}/100.`,impact:{riskReduction:60,costSavings:5e3},actionItems:["Complete missing BI logs immediately","Review incomplete cycles"],timeline:"1 week",confidence:.88,category:"compliance",relatedMetrics:["audit_scores","compliance_rates"]}),r}static generateFallbackOptimizationTips(e){var t;const r=[];return((t=e.sterilization)==null?void 0:t.biPassRate)<95&&r.push({id:"fallback_sterilization_optimization",category:"sterilization",title:"Improve BI Test Pass Rates",description:"BI test pass rates below optimal levels indicate potential issues.",currentState:`Current BI pass rate: ${e.sterilization.biPassRate}%`,recommendedAction:"Review sterilization parameters and implement quality checks",expectedOutcome:"Increase BI pass rate to 95%+",difficulty:"medium",estimatedEffort:"2-3 weeks",priority:8}),r}static generateFallbackRiskAlerts(e){var t;const r=[];return((t=e.auditRisk)==null?void 0:t.riskLevel)==="critical"&&r.push({id:"fallback_high_audit_risk",severity:"critical",title:"High Audit Risk Alert",description:`Audit risk score: ${e.auditRisk.overallRiskScore}/100.`,riskFactors:["Skipped BI indicators","Incomplete cycles"],immediateActions:["Complete missing documentation","Review procedures"],longTermSolutions:["Implement monitoring","Enhance training"],escalationPath:"Notify quality assurance team",deadline:"48 hours",status:"open"}),r}static createCriticalAuditRecommendation(e){var t,r,i;return{id:"critical_audit_risk_mitigation",type:"compliance",priority:"critical",title:"Critical Audit Risk Mitigation Required",description:`Overall audit risk score: ${(t=e.auditRisk)==null?void 0:t.overallRiskScore}/100. ${(r=e.auditRisk)==null?void 0:r.skippedIndicators} skipped indicators and ${(i=e.auditRisk)==null?void 0:i.incompleteCycles} incomplete cycles detected.`,impact:{riskReduction:60,costSavings:5e3},actionItems:["Complete missing BI logs immediately","Review incomplete cycle procedures","Reinforce protocol training","Implement daily compliance checks"],timeline:"1 week",confidence:.88,category:"compliance",relatedMetrics:["audit_scores","compliance_rates","protocol_adherence"]}}static createCriticalSupplyRecommendation(e){var t;const r=((t=e.supplyDepletion)==null?void 0:t.filter(i=>i.reorderUrgency==="critical"))||[];return{id:"critical_supply_alert",type:"risk_mitigation",priority:"critical",title:`Critical Supply Alert: ${r.length} Items`,description:`${r.length} critical supplies will deplete within 7 days, risking operational disruption.`,impact:{costSavings:r.reduce((i,a)=>i+Number(a.currentCost||0)*.2,0),riskReduction:95},actionItems:["Place emergency orders immediately","Contact alternative suppliers","Implement usage restrictions","Notify clinical staff"],timeline:"Immediate",confidence:.95,category:"inventory_management",relatedMetrics:["stock_levels","usage_rates","supplier_performance"]}}static createCriticalAuditAlert(e){var t;return{id:"critical_audit_risk_alert",severity:"critical",title:"Critical Audit Risk Alert",description:`Audit risk score: ${(t=e.auditRisk)==null?void 0:t.overallRiskScore}/100. Multiple compliance issues detected requiring immediate attention.`,riskFactors:["Skipped BI indicators","Incomplete sterilization cycles","Policy drift detected"],immediateActions:["Complete missing documentation immediately","Review and complete incomplete cycles","Reinforce protocol adherence","Schedule compliance review meeting"],longTermSolutions:["Implement automated compliance monitoring","Enhance staff training programs","Establish quality assurance processes","Create compliance dashboard"],escalationPath:"Notify quality assurance team and department director",deadline:"24 hours",status:"open"}}}It.aiLearningService=new Rs;var wc=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function Zy(){return wc(this,null,function*(){try{return[]}catch(c){return console.error("Error getting AI risk predictions:",c),[]}})}function e_(){return wc(this,null,function*(){try{return null}catch(c){return console.error("Error getting historical risk patterns:",c),null}})}function As(){return{efficiency_score:85,time_saved:120,points:150,difficulty:"medium",category:"general"}}var Qr=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});function t_(){return Qr(this,null,function*(){try{const{data:c,error:e}=yield d.from("ai_content_recommendations").select("*").eq("is_displayed",!0).order("recommendation_score",{ascending:!1}).limit(20);return e?(console.error("Error fetching AI recommendations:",e),[]):c||[]}catch(c){return console.error("Error getting AI recommendations:",c),[]}})}function r_(){return Qr(this,null,function*(){try{const{data:{user:c}}=yield d.auth.getUser();if(!c)return null;const{data:e,error:t}=yield d.from("ai_learning_insights").select("*").eq("user_id",c.id).single();return t&&t.code!=="PGRST116"?(console.error("Error fetching user insights:",t),null):e}catch(c){return console.error("Error getting user behavior insights:",c),null}})}function i_(){return Qr(this,null,function*(){try{const{data:{user:c}}=yield d.auth.getUser();if(!c)return null;const{data:e,error:t}=yield d.from("ai_task_performance").select("*").eq("user_id",c.id).order("completed_at",{ascending:!1}).limit(10);return t&&t.code!=="PGRST116"?(console.error("Error fetching performance patterns:",t),As()):(e==null?void 0:e[0])||As()}catch(c){return console.error("Error getting user performance patterns:",c),null}})}function n_(){return Qr(this,null,function*(){try{const{data:{user:c}}=yield d.auth.getUser();if(!c)return .5;const{data:e,error:t}=yield d.from("ai_learning_insights").select("ai_confidence_score").eq("user_id",c.id).single();return t&&t.code!=="PGRST116"?(console.error("Error fetching AI confidence score:",t),.5):Number(e==null?void 0:e.ai_confidence_score)||.5}catch(c){return console.error("Error getting AI confidence score:",c),.5}})}function a_(){return Qr(this,null,function*(){try{const{data:{user:c}}=yield d.auth.getUser();if(!c)return null;const{data:e,error:t}=yield d.from("knowledge_hub_user_progress").select("*").eq("user_id",c.id);return t&&t.code!=="PGRST116"?(console.error("Error fetching learning progress:",t),null):{totalCompleted:((e==null?void 0:e.filter(r=>r.status==="completed"))||[]).length,totalInProgress:((e==null?void 0:e.filter(r=>r.status==="in_progress"))||[]).length,averageScore:(e||[]).reduce((r,i)=>r+(Number(i.score)||0),0)/((e==null?void 0:e.length)||1)||0}}catch(c){return console.error("Error getting learning progress metrics:",c),null}})}var $i=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class o_{static generateRecommendations(e){return $i(this,null,function*(){try{const t=yield t_(),r=yield r_(),i=yield It.generateHybridRecommendations(e,t,r);return By(i)}catch(t){return console.error("Error generating AI recommendations:",t),It.generateFallbackRecommendations(e)}})}static generateOptimizationTips(e){return $i(this,null,function*(){try{const t=yield this.aiLearningService.getLearningInsights(),r=yield i_(),i=yield It.generateAIOptimizationTips(e,t,r);return jy(i)}catch(t){return console.error("Error generating AI optimization tips:",t),It.generateFallbackOptimizationTips(e)}})}static generateRiskAlerts(e){return $i(this,null,function*(){try{const t=yield Zy(),r=yield e_(),i=yield It.generateIntelligentRiskAlerts(e,t,r);return Vy(i)}catch(t){return console.error("Error generating AI risk alerts:",t),It.generateFallbackRiskAlerts(e)}})}static getActionableInsights(e){return $i(this,null,function*(){const t=yield this.generateRecommendations(e),r=yield this.generateOptimizationTips(e),i=yield this.generateRiskAlerts(e),a=yield n_();return{totalRecommendations:t.length,criticalItems:t.filter(s=>s.priority==="critical").length,highPriorityItems:t.filter(s=>s.priority==="high").length,totalTips:r.length,totalAlerts:i.length,criticalAlerts:i.filter(s=>s.severity==="critical").length,estimatedSavings:t.reduce((s,o)=>s+(o.impact.costSavings||0),0),estimatedTimeSavings:t.reduce((s,o)=>s+(o.impact.timeSavings||0),0),aiConfidence:a,learningProgress:yield a_()}})}}o_.aiLearningService=new Rs;const Mi=c=>["Courses","Procedures","Policies","Learning Pathways","Advanced"].includes(c)?c:"Courses";var Vt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class s_{static getKnowledgeArticles(){return Vt(this,null,function*(){try{return(yield new N().getKnowledgeArticles()).map(r=>({id:r.id,title:r.title,category:Mi(r.category||"Courses"),status:"draft",dueDate:r.published_at||new Date().toISOString(),progress:0,lastUpdated:r.updated_at||new Date().toISOString(),description:r.summary||"",tags:r.tags||[],createdAt:r.created_at||new Date().toISOString()}))}catch(e){throw console.error("Failed to get knowledge articles:",e),e}})}static getKnowledgeArticleById(e){return Vt(this,null,function*(){try{const r=yield new N().getArticleById(e);if(r.error||!r.data)return null;const i=r.data;return{id:i.id,title:i.title,category:Mi(i.category||"Courses"),status:"draft",dueDate:i.published_at||new Date().toISOString(),progress:0,lastUpdated:i.updated_at||new Date().toISOString(),description:i.summary||"",tags:i.tags||[],createdAt:i.created_at||new Date().toISOString()}}catch(t){throw console.error("Failed to get knowledge article by ID:",t),t}})}static createKnowledgeArticle(e){return Vt(this,null,function*(){try{const r=yield new N().createArticle({title:e.title,content:e.description||"",summary:e.description||"",category:e.category,tags:e.tags||[],status:"draft"});if(r.error)throw new Error(r.error);if(!r.article)throw new Error("Failed to create article");return{id:r.article.id,title:r.article.title,category:Mi(r.article.category||"Courses"),status:r.article.status,dueDate:r.article.published_at||new Date().toISOString(),progress:0,lastUpdated:r.article.updated_at,description:r.article.summary,tags:r.article.tags,createdAt:r.article.created_at}}catch(t){throw console.error("Failed to create knowledge article:",t),t}})}static updateKnowledgeArticle(e,t){return Vt(this,null,function*(){try{const r=new N,i={};t.title&&(i.title=t.title),t.description&&(i.summary=t.description),t.category&&(i.category_id=t.category),t.tags&&(i.tags=t.tags),t.status&&(i.status=t.status==="review"?"published":"draft");const a=yield r.updateArticle(e,i);if(a.error)throw new Error(a.error);if(!a.article)throw new Error("No article returned from update");return{id:a.article.id,title:a.article.title,category:Mi(a.article.category),status:a.article.status,dueDate:a.article.published_at||new Date().toISOString(),progress:0,description:a.article.summary,tags:a.article.tags,createdAt:a.article.created_at,lastUpdated:a.article.updated_at}}catch(r){throw console.error("Failed to update knowledge article:",r),r}})}static deleteKnowledgeArticle(e){return Vt(this,null,function*(){try{const r=yield new N().deleteArticle(e);if(r.error)throw new Error(r.error)}catch(t){throw console.error("Failed to delete knowledge article:",t),t}})}static updateContentStatus(e,t){return Vt(this,null,function*(){try{const r=new N;let i;switch(t){case"review":i="review";break;case"published":i="published";break;default:i="draft"}const a=yield r.updateArticleStatus(e,i);if(a.error)throw new Error(a.error)}catch(r){throw console.error("Failed to update content status:",r),r}})}}var qi=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class yv{static bulkUpdateContentStatus(e,t){return qi(this,null,function*(){var r;try{const i=new N;let a;switch(t){case"review":a="review";break;case"published":a="published";break;default:a="draft"}const s=yield i.bulkUpdateArticlesStatus(e,a);return{success:s.success,processedCount:s.processedCount,successCount:s.updatedCount||0,errorCount:((r=s.errors)==null?void 0:r.length)||0,errors:s.errors||[]}}catch(i){throw console.error("Failed to bulk update content status:",i),i}})}static bulkDeleteContent(e){return qi(this,null,function*(){var t;try{const i=yield new N().deleteArticles(e);return{success:i.success,processedCount:i.processedCount,successCount:i.deletedCount||0,errorCount:((t=i.errors)==null?void 0:t.length)||0,errors:i.errors||[]}}catch(r){throw console.error("Failed to bulk delete content:",r),r}})}static bulkUpdateLearningPathStatus(e,t){return qi(this,null,function*(){var r;try{const a=yield new N().bulkUpdateLearningPathsStatus(e,t);return{success:a.success,processedCount:a.processedCount,successCount:a.updatedCount||0,errorCount:((r=a.errors)==null?void 0:r.length)||0,errors:a.errors||[]}}catch(i){throw console.error("Failed to bulk update learning path status:",i),i}})}static bulkDeleteLearningPathways(e){return qi(this,null,function*(){var t;try{const i=yield new N().deleteLearningPaths(e);return{success:i.success,processedCount:i.processedCount,successCount:i.deletedCount||0,errorCount:((t=i.errors)==null?void 0:t.length)||0,errors:i.errors||[]}}catch(r){throw console.error("Failed to bulk delete learning pathways:",r),r}})}}var Ht=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class c_{static getLearningPathways(){return Ht(this,null,function*(){try{return(yield new N().getLearningPathways()).map(r=>({id:r.id,title:r.title,category:"Learning Pathways",status:"draft",dueDate:r.created_at||new Date().toISOString(),progress:0,lastUpdated:r.updated_at,description:r.description,createdAt:r.created_at}))}catch(e){throw console.error("Failed to get learning pathways:",e),e}})}static getLearningPathwayById(e){return Ht(this,null,function*(){try{const r=yield new N().getLearningPathById(e);if(r.error||!r.data)return null;const i=r.data;return{id:i.id,title:i.title,category:"Learning Pathways",status:"draft",dueDate:i.created_at||new Date().toISOString(),progress:0,lastUpdated:i.updated_at,description:i.description,createdAt:i.created_at}}catch(t){throw console.error("Failed to get learning pathway by ID:",t),t}})}static createLearningPathway(e){return Ht(this,null,function*(){try{const t=new N,r={title:e.title,description:e.description||"",category:e.category,difficulty:"beginner",estimated_time:"30 minutes",is_active:!0},i=yield t.createLearningPath(r);if(i.error)throw new Error(i.error);if(!i.pathway)throw new Error("No pathway returned from creation");return{id:i.pathway.id,title:i.pathway.title,category:i.pathway.category,status:"draft",dueDate:new Date().toISOString(),progress:0,description:i.pathway.description,createdAt:i.pathway.created_at,lastUpdated:i.pathway.updated_at}}catch(t){throw console.error("Failed to create learning pathway:",t),t}})}static updateLearningPathway(e,t){return Ht(this,null,function*(){try{const r=new N,i={};t.title&&(i.title=t.title),t.description&&(i.description=t.description),t.category&&(i.category=t.category);const a=yield r.updateLearningPath(e,i);if(a.error)throw new Error(a.error);if(!a.pathway)throw new Error("No pathway returned from update");return{id:a.pathway.id,title:a.pathway.title,category:a.pathway.category,status:"draft",dueDate:new Date().toISOString(),progress:0,description:a.pathway.description,createdAt:a.pathway.created_at,lastUpdated:a.pathway.updated_at}}catch(r){throw console.error("Failed to update learning pathway:",r),r}})}static deleteLearningPathway(e){return Ht(this,null,function*(){try{const r=yield new N().deleteLearningPath(e);if(r.error)throw new Error(r.error)}catch(t){throw console.error("Failed to delete learning pathway:",t),t}})}static updateLearningPathStatus(e,t){return Ht(this,null,function*(){try{const i=yield new N().updateLearningPathStatus(e,t);if(i.error)throw new Error(i.error)}catch(r){throw console.error("Failed to update learning path status:",r),r}})}}var Un=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class _v{static getKnowledgeCategories(){return Un(this,null,function*(){try{return(yield new N().getKnowledgeCategories()).map(r=>r.name)}catch(e){throw console.error("Failed to get knowledge categories:",e),e}})}static addCategory(e){return Un(this,null,function*(){try{const r=yield new N().addCategory(e);if(r.error)throw new Error(r.error);if(!r.category)throw new Error("No category returned from creation");return r.category.name}catch(t){throw console.error("Failed to add category:",t),t}})}static deleteCategory(e){return Un(this,null,function*(){try{const r=yield new N().deleteCategory(e);if(r.error)throw new Error(r.error)}catch(t){throw console.error("Failed to delete category:",t),t}})}}var ot=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class vv{static getQuizzes(){return ot(this,null,function*(){try{const{QuizService:e}=yield T(()=>import("./knowledgehub-pages-i9cBLZCy.js").then(r=>r.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return(yield e.getAllQuizzes()).map(r=>({id:r.id,title:r.title,category:"Courses",status:r.is_active?"published":"draft",dueDate:r.created_at,progress:0,lastUpdated:r.updated_at,description:r.description||"Interactive quiz to test knowledge",tags:["quiz","assessment","knowledge-test"],createdAt:r.created_at,type:"quiz",contentType:"quiz",domain:"knowledge-assessment",isActive:r.is_active,estimatedDuration:r.time_limit_minutes||15,difficultyLevel:"medium",mandatoryRepeat:!1,passingScore:r.passing_score}))}catch(e){return console.error("Failed to get quizzes:",e),[]}})}static getQuizById(e){return ot(this,null,function*(){try{const{QuizService:t}=yield T(()=>import("./knowledgehub-pages-i9cBLZCy.js").then(r=>r.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield t.getQuizWithQuestions(e)}catch(t){return console.error("Failed to get quiz by ID:",t),null}})}static startQuizAttempt(e){return ot(this,null,function*(){try{const{QuizService:t}=yield T(()=>import("./knowledgehub-pages-i9cBLZCy.js").then(r=>r.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield t.startQuizAttempt(e)}catch(t){return console.error("Failed to start quiz attempt:",t),null}})}static submitQuizAnswers(e,t){return ot(this,null,function*(){try{const{QuizService:r}=yield T(()=>import("./knowledgehub-pages-i9cBLZCy.js").then(i=>i.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield r.submitQuizAttempt(e,t)}catch(r){return console.error("Failed to submit quiz answers:",r),{success:!1,score:0,passed:!1}}})}static getUserQuizAttempts(){return ot(this,null,function*(){try{const{QuizService:e}=yield T(()=>import("./knowledgehub-pages-i9cBLZCy.js").then(t=>t.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield e.getUserQuizAttempts()}catch(e){return console.error("Failed to get user quiz attempts:",e),[]}})}static createQuiz(e){return ot(this,null,function*(){try{const{QuizService:t}=yield T(()=>import("./knowledgehub-pages-i9cBLZCy.js").then(r=>r.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield t.createQuiz(e)}catch(t){return console.error("Failed to create quiz:",t),null}})}static updateQuiz(e,t){return ot(this,null,function*(){try{const{QuizService:r}=yield T(()=>import("./knowledgehub-pages-i9cBLZCy.js").then(i=>i.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield r.updateQuiz(e,t)}catch(r){return console.error("Failed to update quiz:",r),null}})}static deleteQuiz(e){return ot(this,null,function*(){try{const{QuizService:t}=yield T(()=>import("./knowledgehub-pages-i9cBLZCy.js").then(r=>r.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield t.deleteQuiz(e)}catch(t){return console.error("Failed to delete quiz:",t),!1}})}}var Ts=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class wv{static getRecentUserActivity(e,t){return Ts(this,null,function*(){try{return yield new N().getRecentUserActivity(e,t)}catch(r){throw console.error("Failed to get recent user activity:",r),r}})}static getAllContent(){return Ts(this,null,function*(){try{const[e,t]=yield Promise.all([s_.getKnowledgeArticles(),c_.getLearningPathways()]);return[...e,...t]}catch(e){throw console.error("Failed to get all content:",e),e}})}}var be=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())});class Iv{static getKnowledgeHubContent(e,t,r=10){return be(this,null,function*(){try{return(yield Yn.getKnowledgeArticles()).filter(o=>e.includes(o.category.toLowerCase())&&t.some(n=>o.title.toLowerCase().includes(n.toLowerCase())||o.category.toLowerCase().includes(n.toLowerCase()))).map(o=>({contentId:o.id,title:o.title,category:o.category.toLowerCase(),relevance:this.calculateRelevance(o,t),lastUpdated:o.lastUpdated||new Date().toISOString(),url:`/knowledge-hub/${o.category.toLowerCase()}/${o.id}`})).sort((o,n)=>n.relevance-o.relevance).slice(0,r)}catch(i){return console.error("Error fetching Knowledge Hub content:",i),[]}})}static getAuditTrail(e,t,r,i=50){return be(this,null,function*(){try{const{data:{user:a}}=yield d.auth.getUser();if(!a)throw new Error("User not authenticated");const{data:s}=yield d.from("users").select("facility_id").eq("id",a.id).single(),o=(s==null?void 0:s.facility_id)||"550e8400-e29b-41d4-a716-446655440000";let n=d.from("audit_logs").select("*").eq("facility_id",o).order("timestamp",{ascending:!1}).limit(i);e&&(n=n.eq("user_id",e)),t&&(n=n.ilike("action",`%${t}%`)),r&&(n=n.gte("timestamp",r.startDate).lte("timestamp",r.endDate));const{data:l,error:u}=yield n;return u?(console.error("Error fetching audit trail:",u),[]):!l||l.length===0?[]:l.map(f=>{var m,p;return{actionId:String(f.id),timestamp:f.timestamp,userId:f.user_id,userName:(m=f.user_name)!=null?m:"Unknown User",action:f.action,details:f.metadata?JSON.stringify(f.metadata):"",impact:this.determineImpact(f.action),status:(p=f.status)!=null?p:"completed"}})}catch(a){return console.error("Error fetching audit trail:",a),[]}})}static pushKnowledgeHubNotification(e,t,r){return be(this,null,function*(){try{const{data:i}=yield d.from("users").select("facility_id").eq("id",e).single(),a=(i==null?void 0:i.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{error:s}=yield d.from("audit_logs").insert({user_id:e,facility_id:a,action:"Knowledge Hub Notification",details:`Notification for content ${t}: ${r}`,timestamp:new Date().toISOString(),module:"knowledge_hub"});return s?(console.error("Error logging notification:",s),!1):!0}catch(i){return console.error("Error pushing Knowledge Hub notification:",i),!1}})}static scheduleSupplierContact(e,t,r){return be(this,null,function*(){try{const{data:{user:i}}=yield d.auth.getUser();if(!i)throw new Error("User not authenticated");const{data:a}=yield d.from("users").select("facility_id").eq("id",i.id).single(),s=(a==null?void 0:a.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{error:o}=yield d.from("audit_logs").insert({user_id:i.id,facility_id:s,action:"Supplier Contact Scheduled",details:`${t} contact with supplier ${e}, priority: ${r}`,timestamp:new Date().toISOString(),module:"supplier_management"});return o?(console.error("Error logging supplier contact:",o),!1):!0}catch(i){return console.error("Error scheduling supplier contact:",i),!1}})}static getIntegrationMetrics(){return be(this,null,function*(){try{const[e,t,r]=yield Promise.all([this.getKnowledgeHubCount(),this.getActiveSupplierCount(),this.getRecentAuditCount()]);return{knowledgeHubArticles:e,activeSuppliers:t,recentAuditActions:r,integrationHealth:this.calculateIntegrationHealth(e,t,r),lastSync:new Date().toISOString()}}catch(e){return console.error("Error fetching integration metrics:",e),{knowledgeHubArticles:0,activeSuppliers:0,recentAuditActions:0,integrationHealth:0,lastSync:new Date().toISOString()}}})}static syncAllIntegrations(){return be(this,null,function*(){try{return yield Promise.all([this.syncKnowledgeHub(),this.syncSupplierDatabase(),this.syncAuditTrail()]),!0}catch(e){return console.error("Error during integration sync:",e),!1}})}static calculateRelevance(e,t){let r=50;return t.forEach(i=>{var a,s,o;(a=e.title)!=null&&a.toLowerCase().includes(i.toLowerCase())&&(r+=20),(s=e.category)!=null&&s.toLowerCase().includes(i.toLowerCase())&&(r+=15),e.tags&&((o=e.tags)!=null&&o.some(n=>n.toLowerCase().includes(i.toLowerCase())))&&(r+=10)}),Math.min(r,100)}static calculateCostCompetitiveness(e,t){const i=Math.min(t/1e3,2);return Math.min(7*i,10)}static determineImpact(e){const t=["sterilization","bi test","critical","emergency"],r=["inventory","training","maintenance"],i=e.toLowerCase();return t.some(a=>i.includes(a))?"high":r.some(a=>i.includes(a))?"medium":"low"}static getKnowledgeHubCount(){return be(this,null,function*(){try{return(yield Yn.getKnowledgeArticles()).length}catch(e){return console.error(e),0}})}static getActiveSupplierCount(){return be(this,null,function*(){try{const{data:e,error:t}=yield d.from("information_schema.tables").select("table_name").eq("table_name","inventory_suppliers").single();return 5}catch(e){return 5}})}static getRecentAuditCount(){return be(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)return 0;const{data:t}=yield d.from("users").select("facility_id").eq("id",e.id).single(),r=(t==null?void 0:t.facility_id)||"550e8400-e29b-41d4-a716-446655440000",i=new Date;i.setDate(i.getDate()-30);const{count:a,error:s}=yield d.from("audit_logs").select("*",{count:"exact",head:!0}).eq("facility_id",r).gte("created_at",i.toISOString());return s?0:a!=null?a:0}catch(e){return console.error(e),0}})}static calculateIntegrationHealth(e,t,r){const i=Math.min(e/10,1)*30,a=Math.min(t/20,1)*30,s=Math.min(r/50,1)*40;return Math.round(i+a+s)}static syncKnowledgeHub(){return be(this,null,function*(){yield new Promise(e=>setTimeout(e,500))})}static syncSupplierDatabase(){return be(this,null,function*(){yield new Promise(e=>setTimeout(e,500))})}static syncAuditTrail(){return be(this,null,function*(){yield new Promise(e=>setTimeout(e,500))})}static getFallbackSuppliers(e,t){return[{supplierId:"fallback-1",name:"Medical Supply Co.",category:e,rating:4.5,deliveryTime:3,costCompetitiveness:8,reliability:9,contactInfo:{email:"contact@medsupply.com",phone:"+1-555-0123",website:"https://medsupply.com"}},{supplierId:"fallback-2",name:"Clinical Equipment Ltd.",category:e,rating:4.2,deliveryTime:5,costCompetitiveness:7.5,reliability:8.5,contactInfo:{email:"sales@clinicalequip.com",phone:"+1-555-0456",website:"https://clinicalequip.com"}}].slice(0,t)}}class Sv{static applyFilters(e,t){if(!t)return e;let r=e;if(t.category&&(r=r.filter(i=>i.category===t.category)),t.status&&(r=r.filter(i=>i.status===t.status)),t.location&&(r=r.filter(i=>i.location===t.location)),t.search){const i=t.search.toLowerCase();r=r.filter(a=>a.name&&a.name.toLowerCase().includes(i)||a.category&&a.category.toLowerCase().includes(i)||a.data&&typeof a.data=="object"&&a.data!==null&&"description"in a.data&&typeof a.data.description=="string"&&a.data.description.toLowerCase().includes(i)||a.data&&typeof a.data=="object"&&a.data!==null&&"barcode"in a.data&&typeof a.data.barcode=="string"&&a.data.barcode.toLowerCase().includes(i)||a.data&&typeof a.data=="object"&&a.data!==null&&"serialNumber"in a.data&&typeof a.data.serialNumber=="string"&&a.data.serialNumber.toLowerCase().includes(i))}return r}static buildSupabaseQuery(e){let t="";return e!=null&&e.category&&(t+=`category.eq.${e.category}`),e!=null&&e.status&&(t&&(t+=","),t+=`status.eq.${e.status}`),e!=null&&e.location&&(t&&(t+=","),t+=`location.eq.${e.location}`),e!=null&&e.search&&(t&&(t+=","),t+=`or(name.ilike.%${e.search}%,category.ilike.%${e.search}%,description.ilike.%${e.search}%)`),t}static getUniqueCategories(e){return[...new Set(e.map(t=>t.category).filter(Boolean))]}static getUniqueLocations(e){return[...new Set(e.map(t=>t.location).filter(Boolean))]}static getUniqueStatuses(e){return[...new Set(e.map(t=>t.status).filter(Boolean))]}static getDefaultCategories(){return["Surgical","Dental","Supplies","Equipment","Office Hardware"]}static getDefaultLocations(){return["Main Clinic","Storage Room","Sterilization Room"]}static getDefaultStatuses(){return["active","inactive","p2","n/a"]}static validateFilters(e){const t=[];return e.category&&!this.getDefaultCategories().includes(e.category)&&t.push(`Invalid category: ${e.category}`),e.status&&!this.getDefaultStatuses().includes(e.status)&&t.push(`Invalid status: ${e.status}`),e.location&&!this.getDefaultLocations().includes(e.location)&&t.push(`Invalid location: ${e.location}`),e.search&&e.search.length<2&&t.push("Search term must be at least 2 characters long"),{isValid:t.length===0,errors:t}}}const Vi={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};var l_=Object.defineProperty,u_=Object.defineProperties,d_=Object.getOwnPropertyDescriptors,ks=Object.getOwnPropertySymbols,h_=Object.prototype.hasOwnProperty,f_=Object.prototype.propertyIsEnumerable,Cs=(c,e,t)=>e in c?l_(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Gt=(c,e)=>{for(var t in e||(e={}))h_.call(e,t)&&Cs(c,t,e[t]);if(ks)for(var t of ks(e))f_.call(e,t)&&Cs(c,t,e[t]);return c},m_=(c,e)=>u_(c,d_(e)),vt=(c,e,t)=>new Promise((r,i)=>{var a=n=>{try{o(t.next(n))}catch(l){i(l)}},s=n=>{try{o(t.throw(n))}catch(l){i(l)}},o=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);o((t=t.apply(c,e)).next())}),Ps,Ds;const Hi=typeof window!="undefined";Hi&&((Ps=Vi)==null||Ps.VITE_ERROR_REPORTING_PROVIDER);class pr{static initialize(e){e&&(this.config=Gt(Gt({},this.config),e)),this.config.enabled&&this.config.provider!=="console"&&this.config.provider!=="supabase"&&!this.config.dsn&&!this.config.apiKey&&(console.warn("Error reporting provider requires DSN or API key"),this.config.provider="console"),this.isInitialized=!0,this.config.enabled&&this.config.flushInterval&&(this.flushTimer=setInterval(()=>{this.flushQueue()},this.config.flushInterval))}static reportError(e,t,r){var i,a;const s={error:e,errorInfo:t,context:Gt({timestamp:new Date().toISOString()},r)};this.errorQueue.push(s),(Hi&&((i=Vi)==null?void 0:i.MODE)==="development"||!1)&&console.error("Error reported:",s),(a=this.config)!=null&&a.maxQueueSize&&this.errorQueue.length>=this.config.maxQueueSize&&this.flushQueue()}static flushQueue(){return vt(this,null,function*(){if(this.errorQueue.length===0||!this.config.enabled)return;const e=this.errorQueue.splice(0,this.errorQueue.length);try{switch(this.config.provider){case"sentry":yield this.sendToSentry(e);break;case"logrocket":yield this.sendToLogRocket(e);break;case"bugsnag":yield this.sendToBugsnag(e);break;case"supabase":yield this.sendToSupabase(e);break;case"console":default:this.sendToConsole(e);break}}catch(t){if(console.error("Failed to send error reports:",t),t instanceof Error&&(t.message.includes("not configured")||t.message.includes("DSN")||t.message.includes("API key")))throw t;this.errorQueue.unshift(...e)}})}static sendToSentry(e){return vt(this,null,function*(){if(!this.config.dsn)throw new Error("Sentry DSN not configured");const t={dsn:this.config.dsn,environment:this.config.environment,release:this.config.release,events:e.map(r=>{var i,a,s;return{message:r.error.message,level:"error",timestamp:(i=r.context)==null?void 0:i.timestamp,tags:{component:(a=r.context)==null?void 0:a.component,page:(s=r.context)==null?void 0:s.page},extra:{stack:r.error.stack,errorInfo:r.errorInfo}}})};yield this.makeApiCall("https://o450000000000000.ingest.sentry.io/api/0/store/",{method:"POST",headers:{"Content-Type":"application/json","X-Sentry-Auth":`Sentry sentry_version=7,sentry_key=${this.config.dsn.split("@")[0]},sentry_client=cliniio/1.0`},body:JSON.stringify(t)})})}static sendToLogRocket(e){return vt(this,null,function*(){if(!this.config.apiKey)throw new Error("LogRocket API key not configured");const t={apiKey:this.config.apiKey,environment:this.config.environment,errors:e.map(r=>{var i,a,s,o;return{message:r.error.message,stack:r.error.stack,timestamp:(i=r.context)==null?void 0:i.timestamp,metadata:{component:(a=r.context)==null?void 0:a.component,page:(s=r.context)==null?void 0:s.page,userId:(o=r.context)==null?void 0:o.userId}}})};yield this.makeApiCall("https://api.logrocket.com/api/v1/errors",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(t)})})}static sendToBugsnag(e){return vt(this,null,function*(){if(!this.config.apiKey)throw new Error("Bugsnag API key not configured");const t={apiKey:this.config.apiKey,notifier:{name:"cliniio-error-reporter",version:"1.0.0"},events:e.map(r=>{var i,a,s,o;return{payloadVersion:"5",exceptions:[{errorClass:r.error.name,message:r.error.message,stacktrace:this.parseStacktrace(r.error.stack)}],breadcrumbs:[],context:(i=r.context)==null?void 0:i.component,user:(a=r.context)!=null&&a.userId?{id:r.context.userId}:void 0,metadata:{page:(s=r.context)==null?void 0:s.page,component:(o=r.context)==null?void 0:o.component}}})};yield this.makeApiCall("https://notify.bugsnag.com/",{method:"POST",headers:{"Content-Type":"application/json","X-Version":"5"},body:JSON.stringify(t)})})}static sendToSupabase(e){return vt(this,null,function*(){try{const{supabase:t}=yield T(()=>import("./components-CrSzLpHe.js").then(a=>a.at),__vite__mapDeps([0,1,2,3,4,5,6,7])),r=e.map(a=>{var s,o,n,l;return{error_message:a.error.message,error_stack:a.error.stack,error_name:a.error.name,component:(s=a.context)==null?void 0:s.component,page:(o=a.context)==null?void 0:o.page,user_id:(n=a.context)==null?void 0:n.userId,timestamp:(l=a.context)==null?void 0:l.timestamp,environment:this.config.environment,metadata:JSON.stringify(a.errorInfo||{})}}),{error:i}=yield t.from("error_logs").insert(r);if(i)throw i}catch(t){throw console.error("Failed to send errors to Supabase:",t),t}})}static sendToConsole(e){console.group("Error Report Batch"),e.forEach((t,r)=>{console.error(`Error ${r+1}:`,t)}),console.groupEnd()}static makeApiCall(e,t){return vt(this,null,function*(){const r=new AbortController,i=setTimeout(()=>r.abort(),1e4);try{const a=yield fetch(e,m_(Gt({},t),{signal:r.signal}));if(clearTimeout(i),!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);return a}catch(a){throw clearTimeout(i),a}})}static parseStacktrace(e){return e?e.split(`
`).slice(1).map(t=>{const r=t.match(/at\s+(.+?)\s+\((.+?):(\d+):(\d+)\)/);return r?{method:r[1],file:r[2],lineNumber:parseInt(r[3]),columnNumber:parseInt(r[4])}:{file:t.trim(),lineNumber:0}}).filter(t=>t.file&&!t.file.includes("node_modules")):[]}static getStatus(){return{isInitialized:this.isInitialized,queueLength:this.errorQueue.length,config:this.config}}static updateConfig(e){this.config=Gt(Gt({},this.config),e),this.isInitialized=!0}static forceFlush(){return vt(this,null,function*(){yield this.flushQueue()})}static clearQueue(){this.errorQueue=[]}static shutdown(){this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null),this.isInitialized=!1}static reset(){var e;this.shutdown(),this.clearQueue(),this.config={provider:"console",enabled:!0,environment:Hi?((e=Vi)==null?void 0:e.MODE)||"development":"production",maxQueueSize:10,flushInterval:5e3}}}pr.isInitialized=!1;pr.errorQueue=[];pr.config={provider:"console",enabled:!0,environment:Hi?((Ds=Vi)==null?void 0:Ds.MODE)||"development":"production",maxQueueSize:10,flushInterval:5e3};pr.flushTimer=null;pr.reportError.bind(pr);export{wh as $,X_ as A,w_ as B,Sv as C,R_ as D,pr as E,kt as F,$_ as G,M_ as H,Nf as I,q_ as J,z_ as K,U_ as L,F_ as M,fh as N,Ct as O,Z_ as P,mh as Q,Qs as R,Fs as S,V_ as T,Kr as U,ph as V,gh as W,yh as X,_h as Y,vh as Z,L_ as _,K as a,Ih as a0,Sh as a1,bh as a2,Q_ as a3,s_ as a4,yv as a5,c_ as a6,_v as a7,wv as a8,vv as a9,Iv as aA,ge as aB,B_ as aC,j_ as aD,W_ as aE,fv as aa,mv as ab,gv as ac,pv as ad,er as ae,nv as af,ov as ag,av as ah,sv as ai,Vs as aj,lv as ak,uv as al,dv as am,hv as an,Bs as ao,ev as ap,J_ as aq,x_ as ar,N_ as as,Fg as at,ut as au,Y_ as av,jr as aw,Sy as ax,Hr as ay,o_ as az,ft as b,I_ as c,Gr as d,X as e,v_ as f,b_ as g,E_ as h,A_ as i,T_ as j,k_ as k,P_ as l,D_ as m,lc as n,Oc as o,H_ as p,K_ as q,S_ as r,C_ as s,Jr as t,O_ as u,G_ as v,tv as w,rv as x,iv as y,cv as z};
