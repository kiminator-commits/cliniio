import{j as p}from"./utils-DSBVV_PW.js";import{u as D,a as C}from"./vendor-DoALFvsH.js";import{M as F,s as v,a5 as R}from"./login-C1ujRpW7.js";import"./data-73RVSc-N.js";import"./ui-DETUEJ2B.js";var U=(t,c,r)=>new Promise((x,i)=>{var m=s=>{try{o(r.next(s))}catch(a){i(a)}},d=s=>{try{o(r.throw(s))}catch(a){i(a)}},o=s=>s.done?x(s.value):Promise.resolve(s.value).then(m,d);o((r=r.apply(t,c)).next())});const J=()=>{const t=D(),{setAuthToken:c,setSessionExpiry:r}=F();return C.useEffect(()=>{U(null,null,function*(){var i,m,d,o,s,a,y,I,w,b,N,k;try{const E=new URLSearchParams(window.location.search).get("state"),P=sessionStorage.getItem("oauth_state");if(E&&P&&E!==P){console.error("OAuth state mismatch - possible CSRF attack"),t("/login?error=invalid_state");return}const{data:e,error:j}=yield v.auth.getSession();if(j){console.error("Auth callback error:",j),t("/login?error=auth_failed");return}if(e.session){if(console.log("OAuth authentication successful, setting up user session"),c(e.session.access_token,e.session.expires_at?new Date(e.session.expires_at*1e3).toISOString():"",!0),r(e.session.expires_at?new Date(e.session.expires_at*1e3).toISOString():""),localStorage.setItem("authToken",e.session.access_token),localStorage.setItem("sessionExpiry",e.session.expires_at?new Date(e.session.expires_at*1e3).toISOString():""),localStorage.setItem("currentUser",JSON.stringify(e.session.user)),(i=e.session)!=null&&i.user)try{const _=((m=e.session.user.app_metadata)==null?void 0:m.provider)||"unknown";console.log("OAuth provider detected:",_);const{data:f,error:g}=yield v.from("users").select("*").eq("id",e.session.user.id).single();if(g&&g.code!=="PGRST116"&&console.warn("Error checking user profile:",g),f){const n=(((I=e.session.user.user_metadata)==null?void 0:I.full_name)||((w=e.session.user.user_metadata)==null?void 0:w.name)||((b=e.session.user.user_metadata)==null?void 0:b.display_name)||`${f.first_name||""} ${f.last_name||""}`.trim()).trim().split(" "),h=n[0]||"",S=n.slice(1).join(" ")||"",l={email:e.session.user.email,first_name:h,last_name:S,avatar_url:((N=e.session.user.user_metadata)==null?void 0:N.avatar_url)||((k=e.session.user.user_metadata)==null?void 0:k.picture)||f.avatar_url,provider:_,updated_at:new Date().toISOString()},{error:u}=yield v.from("users").update(l).eq("id",e.session.user.id);u?console.warn("Failed to update user profile:",u):console.log("Updated existing user profile:",l)}else{const n=(((d=e.session.user.user_metadata)==null?void 0:d.full_name)||((o=e.session.user.user_metadata)==null?void 0:o.name)||((s=e.session.user.user_metadata)==null?void 0:s.display_name)||"").trim().split(" "),h=n[0]||"",S=n.slice(1).join(" ")||"",l={id:e.session.user.id,email:e.session.user.email,first_name:h,last_name:S,role:"user",facility_id:R.getDefaultFacilityId(),avatar_url:((a=e.session.user.user_metadata)==null?void 0:a.avatar_url)||((y=e.session.user.user_metadata)==null?void 0:y.picture)||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:u}=yield v.from("users").insert(l);u?console.warn("Failed to create user profile:",u):console.log("Created new user profile for OAuth user:",l)}}catch(_){console.warn("Error handling user profile:",_)}sessionStorage.removeItem("oauth_state"),sessionStorage.removeItem("oauth_code_verifier"),sessionStorage.removeItem("oauth_provider"),console.log("OAuth user session established, redirecting to home"),t("/home")}else console.log("No session found, redirecting to login"),sessionStorage.removeItem("oauth_state"),sessionStorage.removeItem("oauth_code_verifier"),sessionStorage.removeItem("oauth_provider"),t("/login")}catch(O){console.error("Unexpected error in auth callback:",O),sessionStorage.removeItem("oauth_state"),sessionStorage.removeItem("oauth_code_verifier"),sessionStorage.removeItem("oauth_provider"),t("/login?error=unexpected")}})},[t,c,r]),p.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-teal-50",children:p.jsxs("div",{className:"text-center",children:[p.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),p.jsx("p",{className:"text-gray-600",children:"Completing authentication..."})]})})};export{J as default};
