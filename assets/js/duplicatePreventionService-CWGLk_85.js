import{s as u}from"./login-C1ujRpW7.js";import"./utils-DSBVV_PW.js";import"./vendor-DoALFvsH.js";import"./data-73RVSc-N.js";import"./ui-DETUEJ2B.js";var c=(h,t,i)=>new Promise((r,e)=>{var a=n=>{try{l(i.next(n))}catch(o){e(o)}},s=n=>{try{l(i.throw(n))}catch(o){e(o)}},l=n=>n.done?r(n.value):Promise.resolve(n.value).then(a,s);l((i=i.apply(h,t)).next())});class d{constructor(){this.tableName="knowledge_articles",this.similarityThreshold=.7}checkForDuplicates(t){return c(this,null,function*(){var i;try{const{data:r,error:e}=yield u.from(this.tableName).select("*").or(`title.ilike.%${t.title}%,description.ilike.%${(i=t.data)==null?void 0:i.description}%`);if(e)throw e;const a=[];return r==null||r.forEach(s=>{const l=this.calculateSimilarity(t,this.transformRowToContentItem(s));l>this.similarityThreshold&&a.push({isDuplicate:!0,existingContent:this.transformRowToContentItem(s),similarity:l,reason:this.getDuplicateReason(t,this.transformRowToContentItem(s))})}),a}catch(r){return console.error("Error checking for duplicates:",r),[]}})}calculateSimilarity(t,i){let r=0,e=0;if(t.title&&i.title&&(r+=this.calculateTextSimilarity(t.title,i.title),e++),t.category&&i.category&&t.category===i.category&&(r+=1,e++),t.description&&i.description&&(r+=this.calculateTextSimilarity(t.description,i.description),e++),t.tags&&i.tags&&t.tags.length>0&&i.tags.length>0){const a=t.tags.filter(s=>{var l;return(l=i.tags)==null?void 0:l.includes(s)});r+=a.length/Math.max(t.tags.length,i.tags.length),e++}return e>0?r/e:0}calculateTextSimilarity(t,i){const r=t.toLowerCase().trim(),e=i.toLowerCase().trim();if(r===e)return 1;const a=this.levenshteinDistance(r,e),s=Math.max(r.length,e.length);return s>0?1-a/s:0}calculateTagSimilarity(t,i){const r=new Set(t.map(l=>l.toLowerCase())),e=new Set(i.map(l=>l.toLowerCase())),a=new Set([...r].filter(l=>e.has(l))),s=new Set([...r,...e]);return s.size>0?a.size/s.size:0}levenshteinDistance(t,i){const r=Array(i.length+1).fill(null).map(()=>Array(t.length+1).fill(null));for(let e=0;e<=t.length;e++)r[0][e]=e;for(let e=0;e<=i.length;e++)r[e][0]=e;for(let e=1;e<=i.length;e++)for(let a=1;a<=t.length;a++){const s=t[a-1]===i[e-1]?0:1;r[e][a]=Math.min(r[e][a-1]+1,r[e-1][a]+1,r[e-1][a-1]+s)}return r[i.length][t.length]}getDuplicateReason(t,i){var r,e;const a=[];if(t.title&&i.title&&t.title.toLowerCase()===i.title.toLowerCase()&&a.push("exact title match"),t.title&&i.title&&this.calculateTextSimilarity(t.title,i.title)>.8&&a.push("similar title"),t.category&&i.category&&t.category===i.category&&a.push("same category"),(r=t.data)!=null&&r.description&&i.description&&this.calculateTextSimilarity(t.data.description,i.description)>.7&&a.push("similar description"),(e=t.data)!=null&&e.tags&&i.tags&&t.data.tags.length>0&&i.tags.length>0){const s=t.data.tags.filter(l=>{var n;return(n=i.tags)==null?void 0:n.includes(l)});s.length>0&&a.push(`shared tags: ${s.join(", ")}`)}return a.length>0?a.join(", "):"general similarity"}transformRowToContentItem(t){return{id:t.id,title:t.title,description:t.description||"",category:t.content_type||"Courses",status:t.status||"Not Started",progress:t.progress||0,dueDate:t.published_at||t.created_at||new Date().toISOString(),lastUpdated:t.updated_at||t.last_modified_at||new Date().toISOString(),tags:t.tags||[],domain:t.domain||"",contentType:t.content_type||"article",department:t.department||""}}preventDuplicate(t){return c(this,null,function*(){const i=yield this.checkForDuplicates(t);return{allowed:i.filter(e=>e.similarity>.8).length===0,duplicates:i}})}findDuplicateSuggestions(){return c(this,null,function*(){try{const{data:t,error:i}=yield u.from(this.tableName).select("*");if(i)throw i;const r=[],e=new Set;return t==null||t.forEach(a=>{if(e.has(a.id))return;const s=[];t.forEach(l=>{if(a.id===l.id||e.has(l.id))return;this.calculateSimilarity(this.transformRowToContentItem(a),this.transformRowToContentItem(l))>this.similarityThreshold&&(s.push(this.transformRowToContentItem(l)),e.add(l.id))}),s.length>0&&(r.push({item:this.transformRowToContentItem(a),duplicates:s}),e.add(a.id))}),r}catch(t){return console.error("Error finding duplicate suggestions:",t),[]}})}findDuplicateGroups(t){const i=[],r=new Set;for(let e=0;e<t.length;e++){const a=t[e];if(r.has(a.id))continue;const s=[a];r.add(a.id);for(let l=e+1;l<t.length;l++){const n=t[l];if(a.id===n.id||r.has(n.id))continue;this.calculateSimilarity(a,n)>=this.similarityThreshold&&(s.push(n),r.add(n.id))}s.length>1&&i.push({items:s,similarity:this.calculateGroupSimilarity(s),reason:this.getGroupDuplicateReason(s)})}return i}calculateGroupSimilarity(t){if(t.length<2)return 0;let i=0,r=0;for(let e=0;e<t.length;e++)for(let a=e+1;a<t.length;a++)i+=this.calculateSimilarity(t[e],t[a]),r++;return r>0?i/r:0}getGroupDuplicateReason(t){if(t.length<2)return"";const i=[],r=t.map(a=>a.category).filter(Boolean);r.length>1&&new Set(r).size===1&&i.push(`same category: ${r[0]}`);const e=t.flatMap(a=>{var s;return((s=a.data)==null?void 0:s.tags)||[]});if(e.length>0){const a=e.reduce((l,n)=>(l[n]=(l[n]||0)+1,l),{}),s=Object.entries(a).filter(([,l])=>l>1).map(([l])=>l);s.length>0&&i.push(`shared tags: ${s.join(", ")}`)}return i.length>0?i.join(", "):"general similarity"}}const S=new d;export{d as DuplicatePreventionService,S as duplicatePreventionService};
