const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/components-BtXJbSH9.js","assets/js/react-vendor-DBfrHuQ-.js","assets/js/data-vendor-4okv28M8.js","assets/js/vendor-BY7xYAL4.js","assets/js/ui-vendor-BmV1twT8.js","assets/css/ui-vendor-DJSy8M6b.css","assets/js/utils-vendor-BtegoRPv.js","assets/css/components-B4OH_j2L.css","assets/js/redisClient.server-CVInn9Id.js","assets/js/inventory-pages-yK5D55FD.js","assets/js/knowledgehub-pages-DX_b2YG9.js"])))=>i.map(i=>d[i]);
import{o as ge,_ as T,s as d,p as gt,q as v,k as ee,r as We,t as ce,v as Tt,w as dt,h as oa,x as jc,l as ln}from"./components-BtXJbSH9.js";import{c as Vc,r as Hc,P as sa}from"./react-vendor-DBfrHuQ-.js";import{g as Gc,a as Wc,b as Kc,c as Qc,I as Yc,d as ec,e as Jc,f as _r}from"./inventory-pages-yK5D55FD.js";import{A as tc,U as L,K as ca}from"./knowledgehub-pages-DX_b2YG9.js";const vv={info:(...c)=>console.info("[Cliniio]",...c),error:(...c)=>console.error("[Cliniio]",...c),warn:(...c)=>console.warn("[Cliniio]",...c),debug:(...c)=>console.debug("[Cliniio]",...c)};class tr{constructor(){}static getInstance(){return tr.instance||(tr.instance=new tr),tr.instance}getDefaultFacilityId(){const e=ge("VITE_DEFAULT_FACILITY_ID","");if(e)return e;throw new Error("VITE_DEFAULT_FACILITY_ID environment variable must be set in production")}isValidFacilityId(e){return!e||e.trim()===""?!1:/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)}getOAuthFacilityConfig(){return{facility_id:this.getDefaultFacilityId()}}}const wv=tr.getInstance();var Mt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Ot{static getCurrentFacilityId(){return Mt(this,null,function*(){try{const{distributedFacilityCache:e}=yield T(()=>Promise.resolve().then(()=>rs),void 0),{supabase:t}=yield T(()=>import("./components-BtXJbSH9.js").then(a=>a.aw),__vite__mapDeps([0,1,2,3,4,5,6,7])),{data:{user:r},error:i}=yield t.auth.getUser();if(i||!r)return console.error("Failed to get current user:",i),"550e8400-e29b-41d4-a716-446655440000";const n=yield e.getFacility(`facility:${r.id}`);if(n)return n.id;const{data:o,error:s}=yield t.from("users").select("facility_id").eq("id",r.id).single();if(s||!(o!=null&&o.facility_id)){console.error("Failed to get current facility ID:",s);const a={id:"550e8400-e29b-41d4-a716-446655440000",name:"Development Facility",type:"hospital",isActive:!0,createdAt:"2024-01-01T00:00:00.000Z",updatedAt:"2024-01-01T00:00:00.000Z"};return yield e.setFacility(`facility:${r.id}`,a),"550e8400-e29b-41d4-a716-446655440000"}try{const a=yield Ot.getFacilityById(o.facility_id);return yield e.setFacility(`facility:${r.id}`,a),o.facility_id}catch(a){console.error("Facility not found:",a);const l={id:"550e8400-e29b-41d4-a716-446655440000",name:"Development Facility",type:"hospital",isActive:!0,createdAt:"2024-01-01T00:00:00.000Z",updatedAt:"2024-01-01T00:00:00.000Z"};return yield e.setFacility(`facility:${r.id}`,l),"550e8400-e29b-41d4-a716-446655440000"}}catch(e){return console.error("Failed to get current facility ID:",e),"550e8400-e29b-41d4-a716-446655440000"}})}static getFacility(e){return Mt(this,null,function*(){return{id:e,name:"Test Facility",type:"hospital",isActive:!0,createdAt:"2024-01-01T00:00:00.000Z",updatedAt:"2024-01-01T00:00:00.000Z"}})}static getFacilityById(e){return Mt(this,null,function*(){return{id:e,name:"Test Facility",type:"hospital",isActive:!0,createdAt:"2024-01-01T00:00:00.000Z",updatedAt:"2024-01-01T00:00:00.000Z"}})}static getAllFacilities(e){return Mt(this,null,function*(){try{const{supabase:t}=yield T(()=>import("./components-BtXJbSH9.js").then(f=>f.aw),__vite__mapDeps([0,1,2,3,4,5,6,7])),r=(e==null?void 0:e.page)||1,i=(e==null?void 0:e.limit)||50,n=(r-1)*i,o=n+i-1,{data:s,error:a,count:l}=yield t.from("facilities").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range(n,o);if(a)throw a;const u=Math.ceil((l||0)/i);return{data:(s||[]).map(f=>({id:f.id,name:f.name,type:f.type,isActive:f.is_active,createdAt:f.created_at,updatedAt:f.updated_at})),total:l||0,page:r,limit:i,totalPages:u,hasNext:r<u,hasPrev:r>1}}catch(t){throw console.error("Failed to get all facilities:",t),t}})}static getCurrentUserId(){return Mt(this,null,function*(){return"user-123"})}static validateFacilityId(e){return!!(e&&e.length>0&&e!=="default-facility-id")}static clearCache(){return Mt(this,null,function*(){try{const{distributedFacilityCache:e}=yield T(()=>Promise.resolve().then(()=>rs),void 0);yield e.clearAll()}catch(e){console.error("Failed to clear facility cache:",e)}})}}const ye=Object.freeze(Object.defineProperty({__proto__:null,FacilityService:Ot},Symbol.toStringTag,{value:"Module"}));var rr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Xc(){return rr(this,null,function*(){var c,e,t,r;try{const{data:{user:i},error:n}=yield d.auth.getUser();return{userId:(c=i==null?void 0:i.id)!=null?c:null,facilityId:(t=(e=i==null?void 0:i.user_metadata)==null?void 0:e.facility_id)!=null?t:null,authError:(r=n==null?void 0:n.message)!=null?r:null}}catch(i){return{userId:null,facilityId:null,authError:"context_fetch_failed"}}})}function ti(c,e,t,r){return rr(this,null,function*(){try{const i=yield Xc(),n={type:c,severity:e,message:t,user_id:i.userId,facility_id:i.facilityId,context:r!=null?r:null,created_at:new Date().toISOString()},{error:o}=yield d.from("app_events").insert([n]);return o?((ge("NODE_ENV")==="development"||ge("MODE")==="development")&&console.warn("🟡 observabilityService: insert failed (likely missing table)",o.message),{success:!1,error:o.message}):{success:!0}}catch(i){return(ge("NODE_ENV")==="development"||ge("MODE")==="development")&&console.warn("🟡 observabilityService: unexpected error",i instanceof Error?i.message:String(i)),{success:!1,error:String(i)}}})}const Zc={logSecurityEvent(c,e,t){return rr(this,null,function*(){return ti(c,"warning",e,t)})},logCritical(c,e){return rr(this,null,function*(){return ti("app.error","critical",c,e)})},logError(c,e){return rr(this,null,function*(){return ti("app.error","error",c,e)})},logInfo(c,e,t){return rr(this,null,function*(){return ti(c,"info",e,t)})}};var $e=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Iv{static getAvailableKits(e){return $e(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_kits").select("*").eq("facility_id",e).eq("status","active").gt("quantity",0).gt("expiry_date",new Date().toISOString().split("T")[0]).order("expiry_date",{ascending:!0});if(r)throw new Error(`Failed to get available BI test kits: ${r.message}`);return(t||[]).map(i=>({id:i.id,facility_id:i.facility_id,name:i.name,manufacturer:i.manufacturer,lot_number:i.lot_number,serial_number:i.serial_number||void 0,barcode:i.barcode||void 0,expiry_date:i.expiry_date,incubation_time_minutes:i.incubation_time_minutes,incubation_temperature_celsius:i.incubation_temperature_celsius,quantity:i.quantity,min_quantity:i.min_quantity,max_quantity:i.max_quantity,location:i.location||void 0,status:i.status,supplier:i.supplier||void 0,cost:i.cost||void 0,notes:i.notes||void 0,created_at:i.created_at,updated_at:i.updated_at,created_by:i.created_by||void 0,updated_by:i.updated_by||void 0}))})}static getKitById(e){return $e(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_kits").select("*").eq("id",e).single();if(r)throw new Error(`Failed to get BI test kit: ${r.message}`);if(!t)throw new Error("BI test kit not found");const i=t;return{id:i.id,facility_id:i.facility_id,name:i.name,manufacturer:i.manufacturer,lot_number:i.lot_number,serial_number:i.serial_number||void 0,barcode:i.barcode||void 0,expiry_date:i.expiry_date,incubation_time_minutes:i.incubation_time_minutes,incubation_temperature_celsius:i.incubation_temperature_celsius,quantity:i.quantity,min_quantity:i.min_quantity,max_quantity:i.max_quantity,location:i.location||void 0,status:i.status,supplier:i.supplier||void 0,cost:i.cost||void 0,notes:i.notes||void 0,created_at:i.created_at,updated_at:i.updated_at,created_by:i.created_by||void 0,updated_by:i.updated_by||void 0}})}static createKit(e){return $e(this,null,function*(){const t={facility_id:e.facility_id,name:e.name,manufacturer:e.manufacturer,lot_number:e.lot_number,serial_number:e.serial_number,barcode:e.barcode,expiry_date:e.expiry_date,incubation_time_minutes:e.incubation_time_minutes,incubation_temperature_celsius:e.incubation_temperature_celsius,quantity:e.quantity,min_quantity:e.min_quantity,max_quantity:e.max_quantity,location:e.location,status:e.status,supplier:e.supplier,cost:e.cost,notes:e.notes,created_by:e.created_by,updated_by:e.updated_by},{data:r,error:i}=yield d.from("bi_test_kits").insert(t).select().single();if(i)throw new Error(`Failed to create BI test kit: ${i.message}`);if(!r)throw new Error("No data returned from BI test kit creation");const n=r;return{id:n.id,facility_id:n.facility_id,name:n.name,manufacturer:n.manufacturer,lot_number:n.lot_number,serial_number:n.serial_number||void 0,barcode:n.barcode||void 0,expiry_date:n.expiry_date,incubation_time_minutes:n.incubation_time_minutes,incubation_temperature_celsius:n.incubation_temperature_celsius,quantity:n.quantity,min_quantity:n.min_quantity,max_quantity:n.max_quantity,location:n.location||void 0,status:n.status,supplier:n.supplier||void 0,cost:n.cost||void 0,notes:n.notes||void 0,created_at:n.created_at,updated_at:n.updated_at,created_by:n.created_by||void 0,updated_by:n.updated_by||void 0}})}static useKit(e){return $e(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_kits").select("quantity").eq("id",e).single();if(r||!t)throw new Error(`Failed to fetch BI test kit: ${(r==null?void 0:r.message)||"Kit not found"}`);const i=t;if(i.quantity<=0)throw new Error("BI test kit quantity is already 0");const{error:n}=yield d.from("bi_test_kits").update({quantity:i.quantity-1,updated_at:new Date().toISOString()}).eq("id",e);if(n)throw new Error(`Failed to update BI test kit quantity: ${n.message}`)})}static decrementKitQuantity(e){return $e(this,null,function*(){return this.useKit(e)})}static getCurrentTestConditions(){return $e(this,null,function*(){const{data:{user:e},error:t}=yield d.auth.getUser();if(t||!e)throw new Error("User not authenticated");const{data:r,error:i}=yield d.from("users").select("facility_id").eq("id",e.id).single();if(i||!r)throw new Error("User facility not found");const n=r;return{room_temperature_celsius:22,humidity_percent:45,equipment_used:"Standard Incubator",operator_id:e.id,facility_id:n.facility_id,test_date:new Date().toISOString(),environmental_notes:"Standard laboratory conditions"}})}static getFailureReason(){return $e(this,null,function*(){const e="Positive growth detected during incubation period";try{const t=yield this.getCurrentTestConditions();return`${e}. Test conducted at ${t.room_temperature_celsius}°C for standard incubation period.`}catch(t){return console.error(t),e}})}static getSkipReason(){return $e(this,null,function*(){return"Test skipped by operator - reason documented in compliance notes"})}static getComplianceNotes(){return $e(this,null,function*(){const e="BI test passed successfully - sterilization process validated";try{const t=yield this.getCurrentTestConditions();return`${e}. Test conditions: ${t.room_temperature_celsius}°C, standard incubation period.`}catch(t){return console.error(t),e}})}static checkKitInventory(e){return $e(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_kits").select("quantity, expiry_date, status").eq("facility_id",e);if(r)throw new Error(`Failed to check kit inventory: ${r.message}`);const i=t||[],n=i.filter(l=>l.status==="active"&&l.quantity>0&&new Date(l.expiry_date)>new Date).reduce((l,u)=>l+u.quantity,0),o=i.filter(l=>new Date(l.expiry_date)<=new Date).length,s=n<5,a=[];return s&&a.push("Order additional BI test kits to maintain adequate inventory"),o>0&&a.push(`Dispose of ${o} expired BI test kit(s)`),{available:n,low_stock:s,expired_count:o,recommendations:a}})}}var el=Object.defineProperty,tl=Object.defineProperties,rl=Object.getOwnPropertyDescriptors,la=Object.getOwnPropertySymbols,il=Object.prototype.hasOwnProperty,nl=Object.prototype.propertyIsEnumerable,ua=(c,e,t)=>e in c?el(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,al=(c,e)=>{for(var t in e||(e={}))il.call(e,t)&&ua(c,t,e[t]);if(la)for(var t of la(e))nl.call(e,t)&&ua(c,t,e[t]);return c},ol=(c,e)=>tl(c,rl(e)),qt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Yr{static createBITestResult(e){return qt(this,null,function*(){try{const r=new Date().toISOString().split("T")[0].replace(/-/g,""),i=Date.now().toString().slice(-6),n=`BI-${r}-${i}`,o={facility_id:e.facility_id,operator_id:e.operator_id,cycle_id:e.cycle_id||"00000000-0000-0000-0000-000000000000",test_number:n,test_date:e.test_date||new Date().toISOString(),result:e.result,bi_lot_number:e.bi_lot_number,bi_expiry_date:e.bi_expiry_date,incubation_time_minutes:e.incubation_time_minutes,incubation_temperature_celsius:e.incubation_temperature_celsius,test_conditions:e.test_conditions,failure_reason:e.failure_reason,skip_reason:e.skip_reason,compliance_notes:e.compliance_notes};console.log("🔍 Inserting BI test data:",JSON.stringify(o,null,2));const{data:s,error:a}=yield d.from("bi_test_results").insert(o).select().single();if(a)throw console.error("❌ Database error details:",a),a;if(!s||typeof s!="object")throw new Error("Invalid test result data");const l=s;return{id:l.id,facility_id:l.facility_id,operator_id:l.operator_id||void 0,cycle_id:l.cycle_id||void 0,test_number:l.test_number,test_date:l.test_date,result:l.result,status:l.status,bi_lot_number:l.bi_lot_number||void 0,bi_expiry_date:l.bi_expiry_date||void 0,incubation_time_minutes:l.incubation_time_minutes||void 0,incubation_temperature_celsius:l.incubation_temperature_celsius||void 0,test_conditions:l.test_conditions||{},failure_reason:l.failure_reason||void 0,skip_reason:l.skip_reason||void 0,compliance_notes:l.compliance_notes||void 0,audit_signature:l.audit_signature||void 0,created_at:l.created_at,updated_at:l.updated_at}}catch(t){throw console.error("Failed to create BI test result:",t),t}})}static updateBITestResult(e,t){return qt(this,null,function*(){const{data:r,error:i}=yield d.from("bi_test_results").update(ol(al({},t),{updated_at:new Date().toISOString()})).eq("id",e).select().single();if(i)throw new Error(`Failed to update BI test result: ${i.message}`);if(!r)throw new Error("No data returned from BI test result update");const n=r;return{id:n.id,facility_id:n.facility_id,operator_id:n.operator_id||void 0,cycle_id:n.cycle_id||void 0,test_number:n.test_number,test_date:n.test_date,result:n.result,status:n.status,bi_lot_number:n.bi_lot_number||void 0,bi_expiry_date:n.bi_expiry_date||void 0,incubation_time_minutes:n.incubation_time_minutes||void 0,incubation_temperature_celsius:n.incubation_temperature_celsius||void 0,test_conditions:n.test_conditions||{},failure_reason:n.failure_reason||void 0,skip_reason:n.skip_reason||void 0,compliance_notes:n.compliance_notes||void 0,audit_signature:n.audit_signature||void 0,created_at:n.created_at,updated_at:n.updated_at}})}static getBITestResults(){return qt(this,arguments,function*(e={}){let t=d.from("bi_test_results").select(`
        *,
        facilities(name, facility_code),
        operators(name, role),
        sterilization_cycles(cycle_number, cycle_type)
      `).order("test_date",{ascending:!1});e.facility_id&&(t=t.eq("facility_id",e.facility_id)),e.operator_id&&(t=t.eq("operator_id",e.operator_id)),e.cycle_id&&(t=t.eq("cycle_id",e.cycle_id)),e.result&&(t=t.eq("result",e.result)),e.status&&(t=t.eq("status",e.status)),e.start_date&&(t=t.gte("test_date",e.start_date)),e.end_date&&(t=t.lte("test_date",e.end_date)),e.limit&&(t=t.limit(e.limit)),e.offset&&(t=t.range(e.offset,e.offset+(e.limit||10)-1));const{data:r,error:i}=yield t;if(i)throw new Error(`Failed to fetch BI test results: ${i.message}`);return(r||[]).map(n=>({id:n.id,facility_id:n.facility_id,operator_id:n.operator_id||void 0,cycle_id:n.cycle_id||void 0,test_number:n.test_number,test_date:n.test_date,result:n.result,status:n.status,bi_lot_number:n.bi_lot_number||void 0,bi_expiry_date:n.bi_expiry_date||void 0,incubation_time_minutes:n.incubation_time_minutes||void 0,incubation_temperature_celsius:n.incubation_temperature_celsius||void 0,test_conditions:n.test_conditions||{},failure_reason:n.failure_reason||void 0,skip_reason:n.skip_reason||void 0,compliance_notes:n.compliance_notes||void 0,audit_signature:n.audit_signature||void 0,created_at:n.created_at,updated_at:n.updated_at}))})}static getBITestResult(e){return qt(this,null,function*(){try{const{data:t,error:r}=yield d.from("bi_test_results").select("*").eq("id",e).single();if(r){if(r.code==="PGRST116")return null;throw r}if(!t||typeof t!="object")return null;const i=t;return{id:i.id,facility_id:i.facility_id,operator_id:i.operator_id||void 0,cycle_id:i.cycle_id||void 0,test_number:i.test_number,test_date:i.test_date,result:i.result,status:i.status,bi_lot_number:i.bi_lot_number||void 0,bi_expiry_date:i.bi_expiry_date||void 0,incubation_time_minutes:i.incubation_time_minutes||void 0,incubation_temperature_celsius:i.incubation_temperature_celsius||void 0,test_conditions:i.test_conditions||{},failure_reason:i.failure_reason||void 0,skip_reason:i.skip_reason||void 0,compliance_notes:i.compliance_notes||void 0,audit_signature:i.audit_signature||void 0,created_at:i.created_at,updated_at:i.updated_at}}catch(t){throw console.error("Failed to get BI test result:",t),t}})}static deleteBITestResult(e){return qt(this,null,function*(){const{error:t}=yield d.from("bi_test_results").delete().eq("id",e);if(t)throw new Error(`Failed to delete BI test result: ${t.message}`)})}static generateTestNumber(e){return qt(this,null,function*(){const t=new Date,r=t.toISOString().split("T")[0].replace(/-/g,""),{count:i,error:n}=yield d.from("bi_test_results").select("*",{count:"exact",head:!0}).eq("facility_id",e).gte("test_date",t.toISOString().split("T")[0]).lt("test_date",new Date(t.getTime()+1440*60*1e3).toISOString().split("T")[0]);if(n)throw new Error(`Failed to generate test number: ${n.message}`);return`BI-${r}-${String((i!=null?i:0)+1).padStart(3,"0")}`})}}var zt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Jr={getBIPassRate(c){return zt(this,null,function*(){const{data:e,error:t}=yield d.from("bi_test_results").select("id").eq("facility_id",c).eq("result","pass");return t?{data:null,error:t}:{data:e.length,error:null}})},getBIPassRateAnalytics(c){return zt(this,null,function*(){const{data:e,error:t}=yield d.from("bi_test_results").select("*").eq("facility_id",c);if(t)return{data:null,error:t};const r=e.length,i=e.filter(o=>o.result==="pass").length,n=r>0?i/r*100:0;return{data:{totalTests:r,passedTests:i,passRate:n,facilityId:c},error:null}})},getOperatorPerformance(c,e){return zt(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_results").select("*").eq("facility_id",c).eq("operator_id",e);return r?{data:null,error:r}:{data:t,error:null}})},getBITestAnalytics(c){return zt(this,null,function*(){const{data:e,error:t}=yield d.from("bi_test_results").select("*").eq("facility_id",c);return t?{data:null,error:t}:{data:{totalTests:e.length,passedTests:e.filter(i=>i.result==="pass").length,failedTests:e.filter(i=>i.result==="fail").length,facilityId:c},error:null}})},getAITrainingData(c){return zt(this,null,function*(){const{data:e,error:t}=yield d.from("bi_test_results").select("*").eq("facility_id",c);return t?{data:null,error:t}:{data:e.map(i=>({id:i.id,facilityId:i.facility_id,operatorId:i.operator_id,result:i.result,timestamp:i.created_at,features:{incubationTemperature:i.incubation_temperature_celsius,incubationTime:i.incubation_time_minutes,testConditions:i.test_conditions,status:i.status}})),error:null}})},getPredictiveAnalyticsData(c){return zt(this,null,function*(){const{data:e,error:t}=yield d.from("bi_test_results").select("*").eq("facility_id",c).order("created_at",{ascending:!1}).limit(100);if(t)return{data:null,error:t};const r=e.length,i=e.slice(0,30),n=i.length>0?i.filter(s=>s.result==="pass").length/i.length*100:0;return{data:{facilityId:c,totalTests:r,recentPassRate:n,trendAnalysis:{isImproving:n>80,riskLevel:n<70?"high":n<85?"medium":"low"},recommendations:n<70?["Review sterilization procedures","Check equipment calibration","Retrain operators"]:n<85?["Monitor trends closely","Consider preventive maintenance"]:["Maintain current procedures"]},error:null}})}};var _t=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class yt{static getFacilities(){return _t(this,null,function*(){return[{id:"default-facility",name:"Default Facility",facility_code:"DF001",address:void 0,contact_email:void 0,contact_phone:void 0,compliance_requirements:{},settings:{},is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]})}static getOperators(e){return _t(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("*").eq("facility_id",e).eq("is_active",!0).order("first_name");if(r)throw new Error(`Failed to fetch operators: ${r.message}`);return(t||[]).map(i=>{var n,o,s,a,l;return{id:i.id||"",facility_id:i.facility_id,user_id:i.id||void 0,name:i.full_name||`${i.first_name||""} ${i.last_name||""}`.trim(),email:i.email||void 0,role:((n=i.preferences)==null?void 0:n.role)||"operator",certification_number:((o=i.preferences)==null?void 0:o.certification_number)||void 0,certification_expiry:((s=i.preferences)==null?void 0:s.certification_expiry)||void 0,permissions:((a=i.preferences)==null?void 0:a.permissions)||{},performance_metrics:((l=i.preferences)==null?void 0:l.performance_metrics)||{},is_active:i.is_active||!1,created_at:i.created_at||"",updated_at:i.updated_at||""}})})}static getSterilizationCycles(e,t=50){return _t(this,null,function*(){const r=`${e}-${t}`,i=this.cache.get(r);if(i&&Date.now()-i.timestamp<this.CACHE_DURATION)return i.data;const{data:n,error:o}=yield d.from("sterilization_cycles").select("id, cycle_number, start_time, end_time, status, parameters, tools").eq("facility_id",e).order("start_time",{ascending:!1}).limit(t);if(o)throw new Error(`Failed to fetch sterilization cycles: ${o.message}`);const s=(n||[]).map(a=>({id:a.id,facility_id:a.facility_id||"",operator_id:a.operator_id||void 0,cycle_number:a.cycle_number||"",cycle_type:a.cycle_type||"standard",status:a.status||"pending",start_time:a.start_time||"",end_time:a.end_time||void 0,phases:a.parameters||[],tools:a.tools||[],cycle_parameters:a.parameters||{},environmental_factors:a.results||{},notes:a.notes||void 0,created_at:a.created_at||"",updated_at:a.updated_at||""}));return this.cache.set(r,{data:s,timestamp:Date.now()}),s})}static createSterilizationCycle(e){return _t(this,null,function*(){const t=yield this.generateCycleNumber(e.facility_id),r={id:crypto.randomUUID(),facility_id:e.facility_id,operator_id:e.operator_id||"",cycle_type:e.cycle_type||"standard",cycle_number:t,start_time:new Date().toISOString(),status:e.status||"pending",parameters:e.cycle_parameters||{},results:e.environmental_factors||{},tools:e.tools||[],notes:e.notes,autoclave_id:"default-autoclave",tool_batch_id:"default-batch"},{data:i,error:n}=yield d.from("sterilization_cycles").insert(r).select().single();if(n)throw new Error(`Failed to create sterilization cycle: ${n.message}`);if(!i)throw new Error("No data returned from sterilization cycle creation");const o=i;return{id:o.id,facility_id:o.facility_id||"",operator_id:o.operator_id||void 0,cycle_number:o.cycle_number||"",cycle_type:o.cycle_type||"standard",status:o.status||"pending",start_time:o.start_time||"",end_time:o.end_time||void 0,phases:o.tools||[],tools:o.tools||[],cycle_parameters:o.parameters||{},environmental_factors:o.results||{},notes:o.notes||void 0,created_at:o.created_at||"",updated_at:o.updated_at||""}})}static getEquipment(e){return _t(this,null,function*(){return[]})}static getComplianceAudits(e){return _t(this,null,function*(){const{data:t,error:r}=yield d.from("audit_logs").select("*").eq("facility_id",e).order("created_at",{ascending:!1});if(r)throw new Error(`Failed to fetch compliance audits: ${r.message}`);return(t||[]).map(i=>{var n,o,s,a,l,u,h,f,m;return{id:i.id||"",facility_id:i.facility_id||"",audit_type:((n=i.metadata)==null?void 0:n.audit_type)||"daily",audit_date:i.created_at,auditor_id:(o=i.user_id)!=null?o:"unknown-user",audit_scope:((s=i.metadata)==null?void 0:s.audit_scope)||{},findings:((a=i.metadata)==null?void 0:a.findings)||[],compliance_score:((l=i.metadata)==null?void 0:l.compliance_score)||void 0,recommendations:((u=i.metadata)==null?void 0:u.recommendations)||void 0,corrective_actions:((h=i.metadata)==null?void 0:h.corrective_actions)||[],follow_up_date:((f=i.metadata)==null?void 0:f.follow_up_date)||void 0,status:((m=i.metadata)==null?void 0:m.status)||"pending",created_at:i.created_at,updated_at:i.updated_at||""}})})}static generateCycleNumber(e){return _t(this,null,function*(){const t=new Date,r=t.toISOString().split("T")[0].replace(/-/g,""),{count:i,error:n}=yield d.from("sterilization_cycles").select("*",{count:"exact",head:!0}).eq("facility_id",e).gte("start_time",t.toISOString().split("T")[0]).lt("start_time",new Date(t.getTime()+1440*60*1e3).toISOString().split("T")[0]);if(n)throw new Error(`Failed to generate cycle number: ${n.message}`);return`CYCLE-${r}-${String((i!=null?i:0)+1).padStart(3,"0")}`})}}yt.cache=new Map;yt.CACHE_DURATION=300*1e3;class Gi{static subscribe(e,t,r){r!=null&&r.event;const i=d.channel(e).on("postgres_changes",{event:"*",schema:"public"},t).subscribe();return this.subscriptions.push(i),()=>{this.unsubscribe(i)}}static unsubscribe(e){e&&typeof e=="object"&&"unsubscribe"in e&&e.unsubscribe(),this.subscriptions=this.subscriptions.filter(t=>t!==e)}static forceCleanup(){this.subscriptions.forEach(e=>{e&&typeof e=="object"&&"unsubscribe"in e&&e.unsubscribe()}),this.subscriptions=[]}static getStats(){return{activeChannels:this.subscriptions.length,totalChannels:this.subscriptions.length,totalSubscribers:this.subscriptions.length,tableSubscribers:{},subscriptions:this.subscriptions,performance:{isHealthy:this.subscriptions.length<50,warnings:this.subscriptions.length>30?["High subscription count"]:[],recommendations:this.subscriptions.length>20?["Consider cleanup"]:[]}}}static cleanup(){this.forceCleanup()}static globalCleanup(){this.forceCleanup()}static nuclearCleanup(){console.warn("☢️ NUCLEAR CLEANUP: Force-disconnecting all realtime connections"),this.forceCleanup()}}Gi.subscriptions=[];class rc{static subscribeToBITestChanges(e){if(!gt()){console.warn("⚠️ Supabase not configured, skipping BI test subscription");return}try{return Gi.subscribe("bi_test_results",e,{event:"*"})}catch(t){return console.error("❌ Failed to subscribe to BI test changes:",t),null}}static subscribeToCycleChanges(e){if(!gt()){console.warn("⚠️ Supabase not configured, skipping cycle subscription");return}try{return Gi.subscribe("sterilization_cycles",e,{event:"*"})}catch(t){return console.error("❌ Failed to subscribe to cycle changes:",t),null}}}class W{}W.createBITestResult=Yr.createBITestResult;W.updateBITestResult=Yr.updateBITestResult;W.getBITestResults=Yr.getBITestResults;W.getBITestResult=Yr.getBITestResult;W.deleteBITestResult=Yr.deleteBITestResult;W.getBIPassRateAnalytics=Jr.getBIPassRateAnalytics;W.getOperatorPerformance=Jr.getOperatorPerformance;W.getBITestAnalytics=Jr.getBITestAnalytics;W.getAITrainingData=Jr.getAITrainingData;W.getPredictiveAnalyticsData=Jr.getPredictiveAnalyticsData;W.getFacilities=yt.getFacilities;W.getOperators=yt.getOperators;W.getSterilizationCycles=yt.getSterilizationCycles;W.createSterilizationCycle=yt.createSterilizationCycle;W.getEquipment=yt.getEquipment;W.getComplianceAudits=yt.getComplianceAudits;W.subscribeToBITestChanges=rc.subscribeToBITestChanges;W.subscribeToCycleChanges=rc.subscribeToCycleChanges;class J extends Error{constructor(e,t,r="medium",i=!1,n){super(e),this.code=t,this.severity=r,this.retryable=i,this.details=n,this.name="BIFailureError"}}const k={MISSING_FACILITY_ID:"MISSING_FACILITY_ID",INVALID_TOOLS_COUNT:"INVALID_TOOLS_COUNT",MISSING_BATCH_IDS:"MISSING_BATCH_IDS",VALIDATION_ERROR:"VALIDATION_ERROR"};var sl=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class I{static handleDatabaseError(e,t,r){this.logError("DATABASE_ERROR",e,t,r);const i=e;throw(i==null?void 0:i.code)==="PGRST116"?new J(`Database connection error during ${t}: ${i.message||"Unknown error"}`,"DATABASE_CONNECTION_ERROR","critical",!0):(i==null?void 0:i.code)==="23505"?new J(`Duplicate record error during ${t}: ${i.message||"Unknown error"}`,"DUPLICATE_RECORD_ERROR","high",!1):(i==null?void 0:i.code)==="23503"?new J(`Foreign key constraint error during ${t}: ${i.message||"Unknown error"}`,"FOREIGN_KEY_ERROR","high",!1):new J(`Database error during ${t}: ${(i==null?void 0:i.message)||"Unknown error"}`,"DATABASE_ERROR","critical",!0)}static handleNetworkError(e,t,r){var i;this.logError("NETWORK_ERROR",e,t,r);const n=e;throw(n==null?void 0:n.code)==="NETWORK_ERROR"||(i=n==null?void 0:n.message)!=null&&i.includes("network")?new J(`Network connection failed during ${t}: ${n.message||"Unknown error"}`,"NETWORK_ERROR","high",!0):(n==null?void 0:n.code)==="PGRST116"?new J(`Database connection timeout during ${t}: ${n.message||"Unknown error"}`,"DATABASE_TIMEOUT_ERROR","critical",!0):new J(`Network error during ${t}: ${(n==null?void 0:n.message)||"Unknown error"}`,"NETWORK_ERROR","high",!0)}static handleValidationError(e,t,r="medium"){throw this.logError("VALIDATION_ERROR",{message:e,code:t},"validation"),new J(e,t,r,!1)}static handleAuthorizationError(e,t,r){this.logError("AUTHORIZATION_ERROR",e,t,r);const i=e;throw new J(`Authorization error during ${t}: ${(i==null?void 0:i.message)||"Access denied"}`,"AUTHORIZATION_ERROR","high",!1)}static handleCriticalError(e,t,r){var i,n,o;this.logError("CRITICAL_ERROR",e,t,r);const s=e;throw(s==null?void 0:s.code)==="CRITICAL_ERROR"||(i=s==null?void 0:s.message)!=null&&i.includes("critical")?new J(`Critical error during ${t}: ${s.message||"System failure"}`,"CRITICAL_ERROR","critical",!1):(s==null?void 0:s.code)==="HIGH_PRIORITY"||(n=s==null?void 0:s.message)!=null&&n.includes("high")?new J(`High priority error during ${t}: ${s.message||"High priority issue"}`,"HIGH_PRIORITY_ERROR","high",!1):(s==null?void 0:s.code)==="MEDIUM_PRIORITY"||(o=s==null?void 0:s.message)!=null&&o.includes("medium")?new J(`Medium priority error during ${t}: ${s.message||"Medium priority issue"}`,"MEDIUM_PRIORITY_ERROR","medium",!1):new J(`Critical error during ${t}: ${(s==null?void 0:s.message)||"Unknown critical error"}`,"CRITICAL_ERROR","critical",!1)}static createStandardizedError(e,t,r="UNKNOWN_ERROR"){const i=e;return new J((i==null?void 0:i.message)||`Unknown error during ${t}`,r,"medium",!0,{name:(i==null?void 0:i.name)||"UnknownError",message:(i==null?void 0:i.message)||"No message",code:(i==null?void 0:i.code)||"NO_CODE",operation:t,stack:i==null?void 0:i.stack})}static logError(e,t,r,i){if(this.errorCount++,this.errorCount>this.MAX_ERRORS){console.warn("Maximum error count reached, stopping error logging");return}const n={type:e,operation:r,timestamp:new Date().toISOString(),context:i,error:t instanceof Error?{name:t.name,message:t.message,stack:t.stack}:t};console.error("BIFailureErrorHandler:",n),t instanceof Error&&(this.lastError=t)}static getLastError(){return this.lastError}static reset(){this.lastError=null,this.errorCount=0}static isRetryableError(e){var t,r,i;if(e instanceof J)return e.retryable;const n=e;return!!((n==null?void 0:n.code)==="NETWORK_ERROR"||(t=n==null?void 0:n.message)!=null&&t.includes("network")||(r=n==null?void 0:n.message)!=null&&r.includes("timeout")||(n==null?void 0:n.code)==="PGRST116"||(i=n==null?void 0:n.message)!=null&&i.includes("connection"))}static handleUnexpectedError(e,t){this.logError("UNEXPECTED_ERROR",e,t);const r=e;throw new J(`Unexpected error during ${t}: ${(r==null?void 0:r.message)||"Unknown error"}`,"UNEXPECTED_ERROR","critical",!1)}static withRetry(e,t,r=3,i=1e3){return sl(this,null,function*(){let n=null;for(let o=1;o<=r;o++)try{return yield e()}catch(s){if(n=this.createStandardizedError(s,t),!this.isRetryableError(s)||o===r)throw n;yield new Promise(a=>setTimeout(a,i*o))}throw n||new J(`Operation failed after ${r} attempts: ${t}`,"MAX_RETRIES_EXCEEDED","critical",!1)})}}I.lastError=null;I.errorCount=0;I.MAX_ERRORS=100;class xe{static validateCreateIncidentParams(e){e.facility_id||I.handleValidationError("Facility ID is required",k.MISSING_FACILITY_ID,"critical"),e.affected_tools_count<0&&I.handleValidationError("Affected tools count cannot be negative",k.INVALID_TOOLS_COUNT,"high"),(!Array.isArray(e.affected_batch_ids)||e.affected_batch_ids.length===0)&&I.handleValidationError("At least one affected batch ID is required",k.MISSING_BATCH_IDS,"critical");for(const t of e.affected_batch_ids)(!t||typeof t!="string"||t.trim().length===0)&&I.handleValidationError("Invalid batch ID format",k.VALIDATION_ERROR,"high");e.severity_level&&!["low","medium","high","critical"].includes(e.severity_level)&&I.handleValidationError("Invalid severity level. Must be one of: low, medium, high, critical",k.VALIDATION_ERROR,"medium"),this.isValidUUID(e.facility_id)||I.handleValidationError("Invalid facility ID format",k.VALIDATION_ERROR,"high"),e.detected_by_operator_id&&!this.isValidUUID(e.detected_by_operator_id)&&I.handleValidationError("Invalid operator ID format",k.VALIDATION_ERROR,"medium")}static validateResolveIncidentParams(e){e.incidentId||I.handleValidationError("Incident ID is required",k.VALIDATION_ERROR,"critical"),e.resolvedByOperatorId||I.handleValidationError("Resolving operator ID is required",k.VALIDATION_ERROR,"critical"),this.isValidUUID(e.incidentId)||I.handleValidationError("Invalid incident ID format",k.VALIDATION_ERROR,"high"),this.isValidUUID(e.resolvedByOperatorId)||I.handleValidationError("Invalid operator ID format",k.VALIDATION_ERROR,"high"),e.resolutionNotes&&e.resolutionNotes.length>1e4&&I.handleValidationError("Resolution notes cannot exceed 10,000 characters",k.VALIDATION_ERROR,"medium")}static validateQuarantineToolsParams(e){e.incidentId||I.handleValidationError("Incident ID is required",k.VALIDATION_ERROR,"critical"),e.quarantinedByOperatorId||I.handleValidationError("Quarantining operator ID is required",k.VALIDATION_ERROR,"critical"),(!Array.isArray(e.tools)||e.tools.length===0)&&I.handleValidationError("At least one tool must be specified for quarantine",k.VALIDATION_ERROR,"high");for(const t of e.tools)t.tool_id||I.handleValidationError("Tool ID is required for each tool",k.VALIDATION_ERROR,"high"),this.isValidUUID(t.tool_id)||I.handleValidationError("Invalid tool ID format",k.VALIDATION_ERROR,"high");this.isValidUUID(e.incidentId)||I.handleValidationError("Invalid incident ID format",k.VALIDATION_ERROR,"high"),this.isValidUUID(e.quarantinedByOperatorId)||I.handleValidationError("Invalid operator ID format",k.VALIDATION_ERROR,"high")}static validateRecordToolUsageParams(e){e.facilityId||I.handleValidationError("Facility ID is required",k.MISSING_FACILITY_ID,"critical"),e.toolId||I.handleValidationError("Tool ID is required",k.VALIDATION_ERROR,"critical"),e.patientId||I.handleValidationError("Patient ID is required",k.VALIDATION_ERROR,"critical"),this.isValidUUID(e.facilityId)||I.handleValidationError("Invalid facility ID format",k.VALIDATION_ERROR,"high"),this.isValidUUID(e.toolId)||I.handleValidationError("Invalid tool ID format",k.VALIDATION_ERROR,"high"),this.isValidUUID(e.patientId)||I.handleValidationError("Invalid patient ID format",k.VALIDATION_ERROR,"high"),e.operatorId&&!this.isValidUUID(e.operatorId)&&I.handleValidationError("Invalid operator ID format",k.VALIDATION_ERROR,"medium"),e.procedureNotes&&e.procedureNotes.length>5e3&&I.handleValidationError("Procedure notes cannot exceed 5,000 characters",k.VALIDATION_ERROR,"medium")}static validateFacilityId(e){e||I.handleValidationError("Facility ID is required",k.MISSING_FACILITY_ID,"high"),this.isValidUUID(e)||I.handleValidationError("Invalid facility ID format",k.VALIDATION_ERROR,"high")}static validateIncidentId(e){e||I.handleValidationError("Incident ID is required",k.VALIDATION_ERROR,"critical"),this.isValidUUID(e)||I.handleValidationError("Invalid incident ID format",k.VALIDATION_ERROR,"high")}static validateDateRange(e,t){const r=new Date(e),i=new Date(t);isNaN(r.getTime())&&I.handleValidationError("Invalid start date format",k.VALIDATION_ERROR,"medium"),isNaN(i.getTime())&&I.handleValidationError("Invalid end date format",k.VALIDATION_ERROR,"medium"),r>i&&I.handleValidationError("Start date cannot be after end date",k.VALIDATION_ERROR,"medium");const n=new Date;n.setFullYear(n.getFullYear()-5),r<n&&I.handleValidationError("Start date cannot be more than 5 years ago",k.VALIDATION_ERROR,"medium")}static isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}static validateBusinessRules(e){e.affected_tools_count>1e4&&I.handleValidationError("Affected tools count seems unreasonably high. Please verify the data.",k.VALIDATION_ERROR,"medium"),new Set(e.affected_batch_ids).size!==e.affected_batch_ids.length&&I.handleValidationError("Duplicate batch IDs are not allowed",k.VALIDATION_ERROR,"medium"),e.failure_reason&&e.failure_reason.length>2e3&&I.handleValidationError("Failure reason cannot exceed 2,000 characters",k.VALIDATION_ERROR,"medium")}}var cl=Object.defineProperty,da=Object.getOwnPropertySymbols,ll=Object.prototype.hasOwnProperty,ul=Object.prototype.propertyIsEnumerable,ha=(c,e,t)=>e in c?cl(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,fa=(c,e)=>{for(var t in e||(e={}))ll.call(e,t)&&ha(c,t,e[t]);if(da)for(var t of da(e))ul.call(e,t)&&ha(c,t,e[t]);return c},X=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Sv{static createIncident(e){return X(this,null,function*(){try{xe.validateCreateIncidentParams(e),xe.validateBusinessRules(e);const t=yield I.withRetry(()=>X(null,null,function*(){const{data:r,error:i}=yield d.from("bi_failure_incidents").insert({facility_id:e.facility_id,cycle_id:e.bi_test_result_id,user_id:e.detected_by_operator_id,incident_type:e.incident_type||"bi_failure",severity:e.severity||"medium",description:e.description||"BI test failure incident",failure_reason:e.failure_reason,status:"open",detected_at:new Date().toISOString(),metadata:{affected_tools_count:e.affected_tools_count,affected_batch_ids:e.affected_batch_ids,notes:e.notes}}).select().single();if(i)throw i;if(!r)throw new Error("No data returned from incident creation");return r}),"create BI failure incident");if(t&&e.lastSuccessfulBIDate)try{yield this.identifyExposureWindowTools(t.id,e.lastSuccessfulBIDate),console.log("Exposure window tools identified for incident:",t.incident_number)}catch(r){global.__TESTING__||console.error("Error identifying exposure window tools:",r)}return{id:t.id,facility_id:t.facility_id,bi_test_result_id:t.bi_test_result_id||"",incident_number:t.incident_number,failure_date:t.failure_date||new Date().toISOString(),detected_by_operator_id:t.detected_by_operator_id||"",affected_tools_count:e.affected_tools_count,affected_batch_ids:e.affected_batch_ids,failure_reason:e.failure_reason||"",severity_level:e.severity_level||"medium",status:"active",regulatory_notification_required:!1,regulatory_notification_sent:!1,created_at:t.created_at,updated_at:t.updated_at}}catch(t){if(t instanceof Error&&t.name==="BIFailureError")throw t;I.handleUnexpectedError(t,"create BI failure incident")}})}static getActiveIncidents(e){return X(this,null,function*(){xe.validateFacilityId(e);try{const{data:t}=yield I.withRetry(()=>X(null,null,function*(){const r=yield d.from("bi_failure_incidents").select("*").eq("facility_id",e).in("status",["active","in_resolution"]).order("failure_date",{ascending:!1});if(r.error)throw r.error;return r}),"get active BI failure incidents");return(t!=null?t:[]).map(r=>({id:r.id,facility_id:r.facility_id,bi_test_result_id:r.bi_test_result_id||"",incident_number:r.incident_number,failure_date:r.failure_date||new Date().toISOString(),detected_by_operator_id:r.detected_by_operator_id||"",affected_tools_count:r.affected_tools_count||0,affected_batch_ids:r.affected_batch_ids||[],failure_reason:r.failure_reason||"",severity_level:r.severity_level||"medium",status:r.status||"active",regulatory_notification_required:r.regulatory_notification_required||!1,regulatory_notification_sent:r.regulatory_notification_sent||!1,created_at:r.created_at,updated_at:r.updated_at}))}catch(t){if(t instanceof Error&&t.name==="BIFailureError")throw t;I.handleUnexpectedError(t,"get active BI failure incidents")}})}static getIncidentById(e,t){return X(this,null,function*(){xe.validateIncidentId(e);try{const{data:r}=yield I.withRetry(()=>X(null,null,function*(){const i=yield d.from("bi_failure_incidents").select("*").eq("id",e).eq("facility_id",t).single();if(i.error){if(i.error.code==="PGRST116")return{data:null,error:null};throw i.error}return i}),"get BI failure incident by ID");return r?{id:r.id,facility_id:r.facility_id,bi_test_result_id:r.bi_test_result_id||"",incident_number:r.incident_number,failure_date:r.failure_date||new Date().toISOString(),detected_by_operator_id:r.detected_by_operator_id||"",affected_tools_count:r.affected_tools_count||0,affected_batch_ids:r.affected_batch_ids||[],failure_reason:r.failure_reason||"",severity_level:r.severity_level||"medium",status:r.status||"active",regulatory_notification_required:r.regulatory_notification_required||!1,regulatory_notification_sent:r.regulatory_notification_sent||!1,created_at:r.created_at,updated_at:r.updated_at}:null}catch(r){if(r instanceof Error&&r.name==="BIFailureError")throw r;I.handleUnexpectedError(r,"get BI failure incident by ID")}})}static resolveIncident(e){return X(this,null,function*(){xe.validateResolveIncidentParams(e);try{return!!(yield I.withRetry(()=>X(null,null,function*(){const{data:r,error:i}=yield d.from("bi_failure_incidents").update({status:"resolved",resolved_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",e.incidentId).select("id").single();return i&&I.handleDatabaseError(i,"resolve BI failure incident"),r}),"resolve BI failure incident"))}catch(t){if(t instanceof Error&&t.name==="BIFailureError")throw t;I.handleUnexpectedError(t,"resolve BI failure incident")}})}static updateIncidentStatus(e,t,r,i){return X(this,null,function*(){xe.validateIncidentId(e);try{const{data:n}=yield I.withRetry(()=>X(null,null,function*(){const o=yield d.from("bi_failure_incidents").update(fa({status:r,updated_at:new Date().toISOString()},i&&{updated_by_operator_id:i})).eq("id",e).eq("facility_id",t).select("id").single();if(o.error)throw o.error;return o}),"update incident status");return!!n}catch(n){if(n instanceof Error&&n.name==="BIFailureError")throw n;I.handleUnexpectedError(n,"update incident status")}})}static deleteIncident(e,t,r){return X(this,null,function*(){xe.validateIncidentId(e);try{const{data:i}=yield I.withRetry(()=>X(null,null,function*(){const n=yield d.from("bi_failure_incidents").update(fa({status:"closed",updated_at:new Date().toISOString()},r&&{deleted_by_operator_id:r})).eq("id",e).eq("facility_id",t).select("id").single();if(n.error)throw n.error;return n}),"delete BI failure incident");return!!i}catch(i){if(i instanceof Error&&i.name==="BIFailureError")throw i;I.handleUnexpectedError(i,"delete BI failure incident")}})}static getIncidentHistory(e,t,r,i=100){return X(this,null,function*(){xe.validateFacilityId(e),t&&r&&xe.validateDateRange(t,r);try{let n=d.from("bi_failure_incidents").select("*").eq("facility_id",e).order("failure_date",{ascending:!1}).limit(i);t&&(n=n.gte("failure_date",t)),r&&(n=n.lte("failure_date",r));const{data:o}=yield I.withRetry(()=>X(null,null,function*(){const s=yield n;if(s.error)throw s.error;return s}),"get incident history");return(o!=null?o:[]).map(s=>({id:s.id,facility_id:s.facility_id,bi_test_result_id:s.bi_test_result_id||"",incident_number:s.incident_number,failure_date:s.failure_date||new Date().toISOString(),detected_by_operator_id:s.detected_by_operator_id||"",affected_tools_count:s.affected_tools_count||0,affected_batch_ids:s.affected_batch_ids||[],failure_reason:s.failure_reason||"",severity_level:s.severity_level||"medium",status:s.status||"active",regulatory_notification_required:s.regulatory_notification_required||!1,regulatory_notification_sent:s.regulatory_notification_sent||!1,created_at:s.created_at,updated_at:s.updated_at}))}catch(n){if(n instanceof Error&&n.name==="BIFailureError")throw n;I.handleUnexpectedError(n,"get incident history")}})}static identifyExposureWindowTools(e,t){return X(this,null,function*(){var r;try{const{data:i,error:n}=yield I.withRetry(()=>X(null,null,function*(){return yield d.rpc("identify_exposure_window_tools",{p_incident_id:e,p_last_successful_bi_date:t.toISOString()})}),"identify exposure window tools");return n&&I.handleDatabaseError(n,"identify exposure window tools"),(r=parseInt(i))!=null?r:0}catch(i){if(i instanceof Error&&i.name==="BIFailureError")throw i;I.handleUnexpectedError(i,"identify exposure window tools")}})}static getCurrentFacilityId(){return X(this,null,function*(){var e,t;try{const{data:{session:r}}=yield d.auth.getSession(),i=(t=(e=r==null?void 0:r.user)==null?void 0:e.app_metadata)==null?void 0:t.facility_id;if(!i)throw new Error("No authenticated facility ID found.");return i}catch(r){throw console.error("Failed to get current facility ID:",r),new Error("No authenticated facility ID found.")}})}}var ma=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const ic={getLastSuccessfulBIDate(c){return ma(this,null,function*(){try{const{data:e,error:t}=yield d.from("bi_incidents").select("completed_at").eq("facility_id",c).eq("status","passed").order("completed_at",{ascending:!1}).limit(1).single();return t?(console.warn("No previous successful BI found or query failed:",t.message),null):(e==null?void 0:e.completed_at)||null}catch(e){return console.error("Error fetching lastSuccessfulBIDate:",e),null}})},getToolsInExposureWindow(c,e){return ma(this,null,function*(){var t;try{const{data:{user:r},error:i}=yield d.auth.getUser();if(i||!r)return console.error("Unauthorized: cannot fetch exposure tools."),[];const n=(t=r.user_metadata)==null?void 0:t.facility_id;if(!n)return console.error("Missing facility_id — cannot scope exposure query."),[];let o=c;o||(o=(yield ic.getLastSuccessfulBIDate(n))||new Date(Date.now()-10080*60*1e3).toISOString());const s=e||new Date().toISOString(),{data:a,error:l}=yield d.from("sterilization_tools").select("id, name, last_used_at, status").eq("facility_id",n).gte("last_used_at",o).lte("last_used_at",s);if(l)throw new Error(l.message);return console.info(`✅ Exposure window computed: ${o} → ${s} (${(a==null?void 0:a.length)||0} tools)`),a||[]}catch(r){return console.error("Error computing exposure window:",r),[]}})}};class dl{constructor(){this.cache=new Map,this.ttlMs=300*1e3}get(e){const t=this.cache.get(e);return t?Date.now()>t.expiresAt?(this.cache.delete(e),null):t.data:null}set(e,t,r){const i=r!=null?r:this.ttlMs;this.cache.set(e,{data:t,expiresAt:Date.now()+i})}clear(e){e?this.cache.delete(e):this.cache.clear()}get size(){return this.cache.size}}const Wi=new dl;var hl=Object.defineProperty,fl=Object.defineProperties,ml=Object.getOwnPropertyDescriptors,pa=Object.getOwnPropertySymbols,pl=Object.prototype.hasOwnProperty,gl=Object.prototype.propertyIsEnumerable,ga=(c,e,t)=>e in c?hl(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,yl=(c,e)=>{for(var t in e||(e={}))pl.call(e,t)&&ga(c,t,e[t]);if(pa)for(var t of pa(e))gl.call(e,t)&&ga(c,t,e[t]);return c},_l=(c,e)=>fl(c,ml(e)),Ae=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const un=Vc((c,e)=>({incidents:[],initError:null,setIncidents:t=>c({incidents:t}),setInitError:t=>c({initError:t}),subscribe:()=>{console.info("📡 Subscribing to realtime BI updates…");const t=d.channel("bi_incident_updates").on("postgres_changes",{event:"*",schema:"public",table:"bi_incidents"},()=>Ae(null,null,function*(){const{data:r,error:i}=yield d.from("bi_incidents").select("*").order("created_at",{ascending:!1});if(i){console.error("Error refreshing BI data:",i);return}e().setIncidents(r)})).subscribe();window.__bi_channel__=t},unsubscribe:()=>{const t=window.__bi_channel__;t&&(console.info("🛑 Unsubscribing from realtime BI updates"),d.removeChannel(t),window.__bi_channel__=null)}}));function bv(){return Ae(this,null,function*(){var c;const e=un.getState().setInitError;try{const{data:{user:t},error:r}=yield d.auth.getUser();if(r||!t)throw new Error("Unauthorized: no authenticated user for BI init");const i=((c=t.user_metadata)==null?void 0:c.facility_id)||"",n=`bi_incidents:${i}`,o=Wi.get(n);if(o){console.info("🧠 Loaded BI incidents from cache:",o.length),un.getState().setIncidents(o),e(null);return}const{data:s,error:a}=yield d.from("bi_incidents").select("*").eq("facility_id",i).order("created_at",{ascending:!1});if(a)throw new Error(a.message);un.getState().setIncidents(s||[]),Wi.set(n,s||[]),e(null),console.info(`✅ Cached ${(s==null?void 0:s.length)||0} BI incidents for ${i}`)}catch(t){const r={message:t instanceof Error?t.message:String(t),at:new Date().toISOString()};e(r),yield Zc.logSecurityEvent("security.bi_init_failed",r.message,{timestamp:r.at});try{const i=new CustomEvent("bi:init:error",{detail:r});window.dispatchEvent(i)}catch(i){}window.__BI_INIT_ERROR__=r,console.error("❌ BI initialization failed:",r.message)}})}const Ev={createIncident(c){return Ae(this,null,function*(){var e;if(!c.affected_batch_ids||!Array.isArray(c.affected_batch_ids)||c.affected_batch_ids.length===0)throw new Error("At least one affected batch ID is required");const{data:{user:t}}=yield d.auth.getUser();if(!t)return{error:"Unauthorized"};const{data:r,error:i}=yield d.from("bi_incidents").insert([_l(yl({},c),{created_by:t.id,facility_id:((e=t.user_metadata)==null?void 0:e.facility_id)||null})]).select().single();return i?{error:i.message}:{data:r}})},resolveIncident(c,e){return Ae(this,null,function*(){const{data:{user:t}}=yield d.auth.getUser();if(!t)return{error:"Unauthorized"};const{data:r,error:i}=yield d.from("bi_incidents").update({status:"resolved",resolution:e,resolved_by:t.id,resolved_at:new Date().toISOString()}).eq("id",c).select().single();return i?{error:i.message}:{data:r}})},fetchActivityLogs(c=50){return Ae(this,null,function*(){var e;try{const{data:{user:t},error:r}=yield d.auth.getUser();if(r||!t)return console.error("Unauthorized: cannot fetch BI activity logs without a valid user."),[];const i=(e=t.user_metadata)==null?void 0:e.facility_id;if(!i)return console.error("Missing facility_id for BI activity logs."),[];const{data:n,error:o}=yield d.from("bi_activity_logs").select("*").eq("facility_id",i).order("created_at",{ascending:!1}).limit(c);return o?(console.error("Error fetching BI activity logs:",o.message),[]):(console.info(`✅ Loaded ${n.length} BI activity log entries`),n||[])}catch(t){return console.error("Unexpected BI log fetch error:",t),[]}})},identifyExposureWindowTools(c,e){return Ae(this,null,function*(){try{const t=yield ic.getToolsInExposureWindow(c,e);return console.info(`✅ Identified ${t.length} tools in exposure window.`),t}catch(t){return console.error("Error identifying exposure window tools:",t instanceof Error?t.message:String(t)),[]}})},getActiveIncidents(c){return Ae(this,null,function*(){try{const{data:e,error:t}=yield d.from("bi_failure_incidents").select("*").eq("facility_id",c).eq("status","active");if(t)throw t;return e||[]}catch(e){return console.error("Error fetching active incidents:",e),[]}})},getAnalyticsSummary(c,e){return Ae(this,null,function*(){try{return{totalIncidents:0,resolvedIncidents:0,averageResolutionTime:0,facilityId:c,timeRange:e}}catch(t){return console.error("Error fetching analytics summary:",t),null}})},sendRegulatoryNotification(c,e){return Ae(this,null,function*(){try{return console.log(`Sending ${e} notification for incident ${c}`),{success:!0,message:"Notification sent"}}catch(t){return console.error("Error sending regulatory notification:",t),{success:!1,message:"Failed to send notification"}}})},generatePatientExposureReport(c){return Ae(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser(),t=(e==null?void 0:e.id)||"unknown-user";return{incidentNumber:`BI-FAIL-${c}`,exposureSummary:{totalPatientsExposed:15,highRiskPatients:3,mediumRiskPatients:7,lowRiskPatients:5},riskBreakdown:{high:3,medium:7,low:5},exposureDetails:[{patientId:"P001",riskLevel:"high",exposureDate:"2024-01-15",procedures:["Surgery A","Surgery B"]},{patientId:"P002",riskLevel:"medium",exposureDate:"2024-01-15",procedures:["Surgery C"]}],recommendations:["Immediate patient notification required","Enhanced monitoring for high-risk patients","Review sterilization protocols"],generatedAt:new Date().toISOString(),generatedBy:t}}catch(e){throw console.error("Error generating patient exposure report:",e),new Error("Failed to generate patient exposure report")}})},generateIncidentNumber(c){return Ae(this,null,function*(){try{const{data:e,error:t}=yield d.from("bi_failure_incidents").select("incident_number").eq("facility_id",c).order("created_at",{ascending:!1}).limit(1);if(t)throw t;const r=e==null?void 0:e[0],n=(r!=null&&r.incident_number?parseInt(r.incident_number.split("-").pop()||"0"):0)+1;return`BI-FAIL-${c}-${n.toString().padStart(3,"0")}`}catch(e){throw console.error("Error generating incident number:",e),e}})},subscribeToBIFailureUpdates(c){return Ae(this,null,function*(){try{return console.log(`Subscribing to BI failure updates for facility: ${c}`),Promise.resolve()}catch(e){throw console.error("Error subscribing to BI failure updates:",e),e}})}};var vl=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Av={exportExposureReport(c="csv"){return vl(this,null,function*(){var e;try{const{data:{user:t},error:r}=yield d.auth.getUser();if(r||!t)throw new Error("Unauthorized: no authenticated user.");const i=(e=t.user_metadata)==null?void 0:e.facility_id;if(!i)throw new Error("Missing facility_id.");const{data:n,error:o}=yield d.from("patient_exposure_reports").select("*").eq("facility_id",i).order("created_at",{ascending:!1});if(o)throw new Error(o.message);if(!n||n.length===0)throw new Error("No exposure data available.");if(c==="csv"){const s=Object.keys(n[0]),a=[s.join(","),...n.map(h=>s.map(f=>{var m;return JSON.stringify((m=h[f])!=null?m:"")}).join(","))],l=new Blob([a.join(`
`)],{type:"text/csv"}),u=document.createElement("a");u.href=URL.createObjectURL(l),u.download=`exposure_report_${i}.csv`,u.click(),console.info("✅ Exposure report exported to CSV")}else if(c==="pdf"){const s=window.open("","_blank");if(s){const a=`
            <html>
              <head><title>Exposure Report</title></head>
              <body>
                <h2>Patient Exposure Report</h2>
                <table border="1" cellspacing="0" cellpadding="5">
                  <thead><tr>${Object.keys(n[0]).map(l=>`<th>${l}</th>`).join("")}</tr></thead>
                  <tbody>
                    ${n.map(l=>`<tr>${Object.values(l).map(u=>`<td>${u!=null?u:""}</td>`).join("")}</tr>`).join("")}
                  </tbody>
                </table>
                <script>window.print()<\/script>
              </body>
            </html>`;s.document.write(a),s.document.close()}console.info("🖨️ Exposure report opened in print view")}}catch(t){console.error("❌ Export failed:",t instanceof Error?t.message:String(t)),alert(`Export failed: ${t instanceof Error?t.message:String(t)}`)}})}};var wl=Object.defineProperty,Il=Object.defineProperties,Sl=Object.getOwnPropertyDescriptors,ya=Object.getOwnPropertySymbols,bl=Object.prototype.hasOwnProperty,El=Object.prototype.propertyIsEnumerable,_a=(c,e,t)=>e in c?wl(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,va=(c,e)=>{for(var t in e||(e={}))bl.call(e,t)&&_a(c,t,e[t]);if(ya)for(var t of ya(e))El.call(e,t)&&_a(c,t,e[t]);return c},wa=(c,e)=>Il(c,Sl(e));class Al{constructor(){this.notifications=[],this.notificationHistory=[],this.listeners=[]}addNotification(e){const t=wa(va({},e),{id:`notification_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date});this.notifications.unshift(t),this.notifyListeners(),setTimeout(()=>{this.removeNotification(t.id)},5e3)}removeNotification(e){const t=this.notifications.find(r=>r.id===e);t&&(this.notificationHistory.push(wa(va({},t),{timestamp:new Date})),this.notificationHistory.length>100&&(this.notificationHistory=this.notificationHistory.slice(-100))),this.notifications=this.notifications.filter(r=>r.id!==e),this.notifyListeners()}clearAll(){this.notifications=[],this.notifyListeners()}getNotifications(){return[...this.notifications]}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e([...this.notifications]))}notifyToolAvailable(e,t,r,i,n){let o="Tool Tracking Started",s=`You're now tracking ${t}`;r&&i&&(s=`You're tracking ${t}. Position: ${r} of ${i}`,n==="high"?(o="🔥 High Priority Tracking Started",s=`HIGH PRIORITY: ${s}`):n==="medium"?o="⚡ Medium Priority Tracking Started":n==="low"&&(o="📋 Low Priority Tracking Started")),this.addNotification({type:"tool_available",title:o,message:s,toolId:e,toolName:t,action:{label:"View Queue",onClick:()=>{console.log(`View queue for tool ${e}`)}}})}notifyPositionChanged(e,t,r,i){this.addNotification({type:"position_changed",title:"Queue Update",message:`You moved up! You're now #${r} of ${i} tracking ${t}.`,toolId:e,toolName:t,action:{label:"View Queue",onClick:()=>{console.log(`View queue for tool ${e}`)}}})}notifyToolUnavailable(e,t,r,i){const n=r&&i?`${t} is no longer available. You were #${r} of ${i} in queue.`:`${t} is no longer available.`;this.addNotification({type:"tool_unavailable",title:"Tool Unavailable",message:n,toolId:e,toolName:t,action:{label:"Stop Tracking",onClick:()=>{console.log(`Stop tracking tool ${e}`)}}})}notifyQueueUpdate(e,t,r,i){this.addNotification({type:"queue_update",title:"Queue Update",message:`Queue updated: You're #${r} of ${i} tracking ${t}.`,toolId:e,toolName:t})}testNotification(){this.notifyToolAvailable("test-tool-123","Test Surgical Scissors",2,5)}getNotificationHistory(){return[...this.notificationHistory].reverse()}clearNotificationHistory(){this.notificationHistory=[]}getNotificationsByType(e){return this.notificationHistory.filter(t=>t.type===e)}getNotificationsForTool(e){return this.notificationHistory.filter(t=>t.toolId===e)}}const ri=new Al;function Tl(c,e=3e5){const t=new Date(Date.now()-e),r=c.filter(o=>o.timestamp>t);if(r.length===0)return{avg:0,min:0,max:0,count:0,p95:0,p99:0};const i=r.map(o=>o.value).sort((o,s)=>o-s);return{avg:i.reduce((o,s)=>o+s,0)/i.length,min:i[0],max:i[i.length-1],count:i.length,p95:i[Math.floor(i.length*.95)],p99:i[Math.floor(i.length*.99)]}}function kl(c,e){let t=!1,r="warning";switch(e.operator){case"gt":t=c.value>e.warning,r=c.value>e.critical?"critical":"warning";break;case"lt":t=c.value<e.warning,r=c.value<e.critical?"critical":"warning";break;case"gte":t=c.value>=e.warning,r=c.value>=e.critical?"critical":"warning";break;case"lte":t=c.value<=e.warning,r=c.value<=e.critical?"critical":"warning";break;case"eq":t=c.value===e.warning,r=c.value===e.critical?"critical":"warning";break}return{shouldAlert:t,severity:r}}function Pl(c,e=3e5){const t=[],r=new Date(Date.now()-e),i=c.filter(f=>f.timestamp>r);if(i.length<2)return t;const n=i.map(f=>f.value),o=n.slice(0,Math.floor(n.length/2)),s=n.slice(Math.floor(n.length/2)),a=o.reduce((f,m)=>f+m,0)/o.length,u=(s.reduce((f,m)=>f+m,0)/s.length-a)/a*100;let h="stable";return Math.abs(u)>10&&(h=u<0?"improving":"degrading"),t.push({metric:i[0].name,trend:h,changePercent:Math.round(u*100)/100,period:`${Math.round(e/6e4)} minutes`}),t}function Cl(c,e,t){let r=100;c>1e3&&(r-=20),e>5&&(r-=30),t>500*1024*1024&&(r-=20);let i="healthy";return r<50?i="critical":r<80&&(i="degraded"),{score:Math.max(0,r),status:i}}function Dl(c){const e=c.filter(o=>o.status==="fail").length,t=c.filter(o=>o.status==="warn").length,r=c.length;let i="healthy";e>0?i=e>r/2?"critical":"degraded":t>0&&(i="degraded");const n=Math.max(0,100-e*50-t*25);return{status:i,score:n}}function Ol(){return`alert_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function Rl(c,e,t,r){return`${c} ${e} ${t} (current: ${r})`}function $l(c){return Date.now()-c.getTime()<3e5}function Ml(c,e=60){return c/e}function Ia(c,e=50){return c.substring(0,e)}function ql(c){return Math.round(c/1024/1024)}function zl(c,e=200){return c<e*1024*1024}class Ul{constructor(){this.alerts=[],this.alertSubscribers=[]}createAlert(e,t,r){const n={id:Ol(),metric:e.name,value:e.value,threshold:t.warning,severity:r,message:Rl(e.name,t.operator,t.warning,e.value),timestamp:new Date,resolved:!1};this.alerts.find(s=>s.metric===n.metric&&s.severity===n.severity&&!s.resolved&&$l(s.timestamp))||(this.alerts.push(n),v.warn(`Performance alert: ${n.message}`,n),this.notifyAlertSubscribers(n))}getActiveAlerts(){return this.alerts.filter(e=>!e.resolved)}resolveAlert(e){const t=this.alerts.find(r=>r.id===e);t&&(t.resolved=!0,t.resolvedAt=new Date,v.info(`Alert resolved: ${e}`,t))}subscribeToAlerts(e){return this.alertSubscribers.push(e),()=>{const t=this.alertSubscribers.indexOf(e);t>-1&&this.alertSubscribers.splice(t,1)}}notifyAlertSubscribers(e){this.alertSubscribers.forEach(t=>{try{t(e)}catch(r){v.error("Error in alert subscriber:",r)}})}logMetricRecorded(e,t,r,i,n){v.debug(`Performance metric recorded: ${e}=${t}${r}`,{tags:i,metadata:n})}logThresholdsUpdated(e){v.info("Performance thresholds updated",{thresholds:e})}logSnapshotCaptured(e,t,r){Math.random()<.2&&v.debug("Performance snapshot captured",{timestamp:e,metricsCount:t,alertsCount:r})}logSnapshotError(e){v.error("Failed to capture performance snapshot:",e)}logMonitoringDisabled(){console.log("Performance monitoring disabled in development mode")}logDatabaseCheckError(e){console.error(e)}logMemoryCheckError(e){console.error(e)}}const Re=new Ul;var nc=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Nl(c,e){const t=e.filter(r=>r.metric===c.name);for(const r of t){const{shouldAlert:i,severity:n}=kl(c,r);i&&Re.createAlert(c,r,n)}}function Fl(){return[{metric:"response_time",warning:1e3,critical:5e3,operator:"gt"},{metric:"component_mount_time",warning:1e3,critical:3e3,operator:"gt"},{metric:"authentication_time",warning:2e3,critical:5e3,operator:"gt"},{metric:"data_fetch_time",warning:2e3,critical:5e3,operator:"gt"},{metric:"navigation_time",warning:1e3,critical:3e3,operator:"gt"},{metric:"error_rate",warning:5,critical:10,operator:"gt"},{metric:"memory_usage",warning:200*1024*1024,critical:500*1024*1024,operator:"gt"}]}function Ll(){return()=>nc(null,null,function*(){try{const c=Date.now();return{name:"database",status:"pass",message:"Database connection healthy",duration:Date.now()-c}}catch(c){return Re.logDatabaseCheckError(c),{name:"database",status:"fail",message:"Database connection failed",duration:0}}})}function xl(c){return()=>nc(null,null,function*(){try{const e=c("memory_usage");return{name:"memory",status:zl(e.avg)?"pass":"warn",message:`Memory usage: ${ql(e.avg)}MB`,duration:0}}catch(e){return Re.logMemoryCheckError(e),{name:"memory",status:"fail",message:"Memory check failed",duration:0}}})}function Bl(c,e,t){const r={timestamp:new Date,metrics:new Map,health:c,alerts:e};for(const[i,n]of Array.from(t.entries()))if(n.length>0){const o=n[n.length-1];r.metrics.set(i,o.value)}return r}function jl(c){const e=c("response_time").avg,t=c("error_rate").avg,r=c("memory_usage").avg,{score:i,status:n}=Cl(e,t,r);return{status:n,score:i,checks:[],metrics:{cpu:0,memory:r,responseTime:e,errorRate:t,throughput:c("throughput").avg},lastUpdated:new Date}}function Vl(c,e,t){const r=[];c.status==="critical"&&r.push({type:"critical",title:"System Critical",description:"System is in critical state with multiple failures",impact:"high",recommendations:["Check system resources immediately","Review error logs for root cause","Consider scaling resources"]});const i=e("response_time")[0];i&&i.trend==="degrading"&&r.push({type:"warning",title:"Response Time Degradation",description:`Response time has increased by ${i.changePercent}%`,impact:"medium",recommendations:["Optimize database queries","Check for memory leaks","Review caching strategies"]});const n=e("memory_usage")[0];n&&n.trend==="degrading"&&r.push({type:"warning",title:"Memory Usage Increasing",description:`Memory usage has increased by ${n.changePercent}%`,impact:"medium",recommendations:["Check for memory leaks","Optimize data structures","Consider garbage collection tuning"]});const o=t("response_time").avg;return o>1e3&&r.push({type:"optimization",title:"Response Time Optimization",description:`Average response time is ${o.toFixed(2)}ms`,impact:"low",recommendations:["Implement response caching","Optimize API endpoints","Consider CDN implementation"]}),r}var Hl=Object.defineProperty,Gl=Object.defineProperties,Wl=Object.getOwnPropertyDescriptors,Sa=Object.getOwnPropertySymbols,Kl=Object.prototype.hasOwnProperty,Ql=Object.prototype.propertyIsEnumerable,ba=(c,e,t)=>e in c?Hl(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Pe=(c,e)=>{for(var t in e||(e={}))Kl.call(e,t)&&ba(c,t,e[t]);if(Sa)for(var t of Sa(e))Ql.call(e,t)&&ba(c,t,e[t]);return c},Yl=(c,e)=>Gl(c,Wl(e)),dn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class ir{constructor(){this.metrics=new Map,this.thresholds=[],this.healthChecks=[],this.MAX_METRICS_PER_TYPE=1e3,this.performanceHistory=new Map,this.monitoringInterval=null,this.isMonitoring=!1,this.initializeDefaultThresholds(),this.initializeHealthChecks(),this.startContinuousMonitoring()}static getInstance(){return ir.instance||(ir.instance=new ir),ir.instance}recordMetric(e,t,r,i={},n){const o={name:e,value:t,unit:r,timestamp:new Date,tags:i,metadata:n};this.metrics.has(e)||this.metrics.set(e,[]);const s=this.metrics.get(e);s.push(o),s.length>this.MAX_METRICS_PER_TYPE&&s.splice(0,s.length-this.MAX_METRICS_PER_TYPE),Nl(o,this.thresholds),Re.logMetricRecorded(e,t,r,i,n)}recordResponseTime(e,t,r={}){this.recordMetric("response_time",t,"ms",Pe({operation:e},r))}recordErrorRate(e,t,r={}){this.recordMetric("error_rate",t,"percent",Pe({service:e},r))}recordThroughput(e,t,r=60,i={}){const n=Ml(t,r);this.recordMetric("throughput",n,"ops/sec",Pe({operation:e,period:r.toString()},i))}recordMemoryUsage(e,t,r={}){this.recordMetric("memory_usage",t,"bytes",Pe({type:e},r))}recordDatabaseQuery(e,t,r,i={}){this.recordMetric("db_query_duration",t,"ms",Pe({query:Ia(e)},i)),this.recordMetric("db_query_rows",r,"count",Pe({query:Ia(e)},i))}recordComponentMount(e,t,r={}){this.recordMetric("component_mount_time",t,"ms",Pe({component:e},r))}recordAuthentication(e,t,r={}){this.recordMetric("authentication_time",e,"ms",Pe({success:t.toString()},r))}recordDataFetch(e,t,r,i={}){this.recordMetric("data_fetch_time",t,"ms",Pe({operation:e,success:r.toString()},i))}recordNavigation(e,t,r,i={}){this.recordMetric("navigation_time",r,"ms",Pe({from:e,to:t},i))}getMetrics(e,t=100){return(this.metrics.get(e)||[]).slice(-t)}getAllMetrics(){return new Map(this.metrics)}getAggregatedMetrics(e,t=3e5){const r=this.metrics.get(e)||[];return Tl(r,t)}getSystemHealth(){return dn(this,null,function*(){const e=yield Promise.all(this.healthChecks.map(s=>dn(this,null,function*(){const a=Date.now();try{const l=yield s();return Yl(Pe({},l),{duration:Date.now()-a})}catch(l){return{name:"unknown",status:"fail",message:l instanceof Error?l.message:"Unknown error",duration:Date.now()-a}}}))),{status:t,score:r}=Dl(e),i=this.getAggregatedMetrics("response_time").avg,n=this.getAggregatedMetrics("error_rate").avg,o=this.getAggregatedMetrics("throughput").avg;return{status:t,score:r,checks:e,metrics:{cpu:0,memory:this.getAggregatedMetrics("memory_usage").avg,responseTime:i,errorRate:n,throughput:o},lastUpdated:new Date}})}getActiveAlerts(){return Re.getActiveAlerts()}resolveAlert(e){Re.resolveAlert(e)}addHealthCheck(e){this.healthChecks.push(e)}setThresholds(e){this.thresholds=e,Re.logThresholdsUpdated(e)}initializeDefaultThresholds(){this.thresholds=Fl()}initializeHealthChecks(){this.addHealthCheck(Ll()),this.addHealthCheck(xl(e=>this.getAggregatedMetrics(e)))}startContinuousMonitoring(){if(this.isMonitoring)return;const e=ge("NODE_ENV")==="development"||ge("MODE")==="development",t=ge("VITE_ENABLE_PERFORMANCE_MONITORING")==="true";if(e&&!t){Re.logMonitoringDisabled();return}this.isMonitoring=!0,this.monitoringInterval=setInterval(()=>{this.capturePerformanceSnapshot()},12e4)}stopMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.isMonitoring=!1}capturePerformanceSnapshot(){return dn(this,null,function*(){try{const e=yield this.getSystemHealth(),t=this.getActiveAlerts(),r=Bl(e,t,this.metrics),i="performance_snapshot";this.performanceHistory.has(i)||this.performanceHistory.set(i,[]);const n=this.performanceHistory.get(i);n.push(r),n.length>100&&n.splice(0,n.length-100),Re.logSnapshotCaptured(r.timestamp,r.metrics.size,t.length)}catch(e){Re.logSnapshotError(e)}})}getPerformanceTrends(e,t=3e5){const r=this.metrics.get(e)||[];return Pl(r,t)}getPerformanceInsights(){const e=this.getSystemHealthSync();return Vl(e,t=>this.getPerformanceTrends(t),t=>this.getAggregatedMetrics(t))}subscribeToAlerts(e){return Re.subscribeToAlerts(e)}getPerformanceHistory(e){return e?this.performanceHistory.get(e)||[]:this.performanceHistory.get("performance_snapshot")||[]}getSystemHealthSync(){return jl(e=>this.getAggregatedMetrics(e))}}const N=ir.getInstance();class Jl{constructor(){this.metrics=[],this.insights=[],this.MAX_METRICS=1e3}trackUIMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"ms",timestamp:new Date,category:"ui",tags:r})}trackAPIMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"ms",timestamp:new Date,category:"api",tags:r})}trackDatabaseMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"ms",timestamp:new Date,category:"database",tags:r})}trackMemoryMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"MB",timestamp:new Date,category:"memory",tags:r})}trackNetworkMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"ms",timestamp:new Date,category:"network",tags:r})}trackUserInteractionMetric(e,t,r={}){this.addMetric({name:e,value:t,unit:"ms",timestamp:new Date,category:"user-interaction",tags:r})}addMetric(e){this.metrics.push(e),this.metrics.length>this.MAX_METRICS&&(this.metrics=this.metrics.slice(-this.MAX_METRICS)),this.generateInsights(e),N.recordMetric(e.name,e.value,e.unit,e.tags,e.metadata)}generateInsights(e){const t=[];e.category==="ui"&&e.value>100&&t.push({metric:e.name,insight:`UI operation took ${e.value}ms, exceeding recommended 100ms threshold`,recommendation:"Consider optimizing component rendering or using React.memo",severity:"medium",timestamp:new Date}),e.category==="api"&&e.value>2e3&&t.push({metric:e.name,insight:`API call took ${e.value}ms, exceeding recommended 2000ms threshold`,recommendation:"Consider implementing caching or optimizing database queries",severity:"high",timestamp:new Date}),e.category==="memory"&&e.value>100&&t.push({metric:e.name,insight:`Memory usage is ${e.value}MB, approaching recommended limit`,recommendation:"Consider implementing memory cleanup or lazy loading",severity:"medium",timestamp:new Date}),this.insights.push(...t),this.insights.length>100&&(this.insights=this.insights.slice(-100))}getMetricsByCategory(e){return this.metrics.filter(t=>t.category===e)}getRecentInsights(e=10){return this.insights.sort((t,r)=>r.timestamp.getTime()-t.timestamp.getTime()).slice(0,e)}getPerformanceSummary(){const e=["ui","api","database","memory","network","user-interaction"],t={};return e.forEach(r=>{const i=this.getMetricsByCategory(r);if(i.length>0){const n=i.map(o=>o.value);t[r]={count:i.length,avgValue:n.reduce((o,s)=>o+s,0)/n.length,maxValue:Math.max(...n)}}}),{totalMetrics:this.metrics.length,totalInsights:this.insights.length,categories:t,recentInsights:this.getRecentInsights(5)}}clearOldMetrics(e=24){const t=new Date(Date.now()-e*60*60*1e3);this.metrics=this.metrics.filter(r=>r.timestamp>t),this.insights=this.insights.filter(r=>r.timestamp>t)}}const Tv=new Jl;var Xl=Object.defineProperty,Ea=Object.getOwnPropertySymbols,Zl=Object.prototype.hasOwnProperty,eu=Object.prototype.propertyIsEnumerable,Aa=(c,e,t)=>e in c?Xl(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,tu=(c,e)=>{for(var t in e||(e={}))Zl.call(e,t)&&Aa(c,t,e[t]);if(Ea)for(var t of Ea(e))eu.call(e,t)&&Aa(c,t,e[t]);return c};class en{static subscribe(e,t,r={}){const i=this.getChannelKey(e,r);if(!this.subscriptions.has(i)){if(!gt())return console.warn("⚠️ Supabase not configured, skipping real-time subscription"),()=>{};try{const o=d.channel(i).on("postgres_changes",tu({event:r.event||"*",schema:"public",table:e},r.filter&&{filter:r.filter}),s=>{const a=this.channelSubscribers.get(i);a&&a.forEach(l=>l(s))}).subscribe();this.subscriptions.set(i,o),this.channelSubscribers.set(i,new Set),console.log(`✅ Created shared realtime channel: ${i}`)}catch(o){return console.error(`❌ Failed to create realtime channel ${i}:`,o),()=>{}}}const n=this.channelSubscribers.get(i);return n.add(t),console.log(`📡 Added subscriber to ${i} (total: ${n.size})`),()=>{this.unsubscribe(i,t)}}static unsubscribe(e,t){const r=this.channelSubscribers.get(e);if(r&&(r.delete(t),r.size===0)){const i=this.subscriptions.get(e);i&&(d.removeChannel(i),this.subscriptions.delete(e),this.channelSubscribers.delete(e),console.log(`🔕 Cleaned up channel: ${e}`))}}static getChannelKey(e,t){const r=[e];return t.event&&t.event!=="*"&&r.push(t.event),t.filter&&r.push(t.filter),r.join("_")}static getStats(){return{activeChannels:this.subscriptions.size,totalSubscribers:Array.from(this.channelSubscribers.values()).reduce((e,t)=>e+t.size,0),tableSubscribers:Object.fromEntries(Array.from(this.channelSubscribers.entries()).map(([e,t])=>[e,t.size]))}}static cleanup(){this.subscriptions.forEach(e=>{d.removeChannel(e)}),this.subscriptions.clear(),this.channelSubscribers.clear(),console.log("🧹 Cleaned up all realtime subscriptions")}static nuclearCleanup(){console.log("🧹 Force cleaning up all realtime connections"),this.cleanup()}}en.subscriptions=new Map;en.channelSubscribers=new Map;class ac{static initialize(){if(this.isInitialized){v.realtime("🔄 SimpleRealtimeAutoOptimizer already initialized");return}v.realtime("🚀 SimpleRealtimeAutoOptimizer: Initialized (simplified)"),this.isInitialized=!0}static forceRestart(){v.realtime("🔄 SimpleRealtimeAutoOptimizer: Force restart (simplified)")}static getStatus(){return{isInitialized:this.isInitialized,optimizationStatus:{isRunning:!0,interval:"simplified",mode:"simplified"}}}static immediateNuclearCleanup(){v.realtime("🧹 SimpleRealtimeAutoOptimizer: Immediate cleanup"),en.cleanup()}}ac.isInitialized=!1;ac.initialize();class oc{static startOptimization(){if(this.isOptimizing){v.realtime("🔄 SimpleRealtimeOptimizer already running");return}this.isOptimizing=!0,v.realtime("🚀 Started simplified realtime optimization")}static stopOptimization(){this.isOptimizing=!1,v.realtime("⏹️ Stopped simplified realtime optimization")}static getStatus(){return{isRunning:this.isOptimizing,interval:this.isOptimizing?"simplified":"inactive",mode:this.isOptimizing?"simplified":"inactive"}}static emergencyCleanup(){v.realtime("🧹 Emergency cleanup (simplified)"),en.cleanup()}}oc.isOptimizing=!1;setTimeout(()=>{v.realtime("🚀 Auto-starting simplified realtime optimization..."),oc.startOptimization()},2e3);var Ze=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class sc{constructor(e={}){const t=ge("VITE_SUPABASE_URL",""),r=e.baseUrl||(t?`${t}/functions/v1/auth-login-simple`:"/api/auth-login-simple");this.config={baseUrl:r,timeout:e.timeout||3e4,retryAttempts:e.retryAttempts||3}}generateCSRFToken(){const e=new Uint8Array(32);return crypto.getRandomValues(e),btoa(String.fromCharCode.apply(null,Array.from(e))).replace(/[^a-zA-Z0-9]/g,"").substring(0,32)}storeCSRFToken(e){try{sessionStorage.setItem("csrf_token",e)}catch(t){console.warn("Failed to store CSRF token:",t)}}getStoredCSRFToken(){try{return sessionStorage.getItem("csrf_token")}catch(e){return console.warn("Failed to retrieve CSRF token:",e),null}}validateCSRFToken(e,t){return t?e===t:!1}secureLogin(e){return Ze(this,null,function*(){const t=performance.now();try{console.log("🔧 Using direct Supabase authentication");const r=d,{data:i,error:n}=yield r.auth.signInWithPassword({email:e.email.trim().toLowerCase(),password:e.password});if(n)throw new Error(n.message);if(!i.user||!i.session)throw new Error("Authentication failed - no user or session returned");const s={success:!0,data:{accessToken:i.session.access_token,refreshToken:i.session.refresh_token,expiresIn:i.session.expires_in,user:{id:i.user.id,email:i.user.email,role:"user"}}};return ee()&&console.log(`[PERF] SecureAuthService: Direct Supabase login completed in ${(performance.now()-t).toFixed(2)}ms`),s}catch(r){return console.error(`[AUTH] Login failed for ${e.email}:`,r),{success:!1,error:r instanceof Error?r.message:"Authentication failed"}}})}makeSecureRequest(e){return Ze(this,null,function*(){const t=new AbortController,r=setTimeout(()=>t.abort(),this.config.timeout);try{const i=yield fetch(this.config.baseUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(e),signal:t.signal,credentials:"same-origin"});if(clearTimeout(r),!i.ok){const o=yield i.json().catch(()=>({}));if(i.status===429)return{success:!1,error:o.message||"Too many login attempts. Please try again later.",rateLimitInfo:o.rateLimitInfo};if(i.status===401)return{success:!1,error:o.message||"Invalid email or password"};throw new Error(o.message||`HTTP ${i.status}: ${i.statusText}`)}return yield i.json()}catch(i){throw clearTimeout(r),i.name==="AbortError"?new Error("Request timeout. Please check your connection and try again."):i}})}storeTokens(e){try{sessionStorage.setItem("access_token",e.accessToken),sessionStorage.setItem("refresh_token",e.refreshToken),sessionStorage.setItem("token_expires",(Date.now()+e.expiresIn*1e3).toString()),d.auth.setSession({access_token:e.accessToken,refresh_token:e.refreshToken})}catch(t){throw console.error("Failed to store authentication tokens:",t),new Error("Failed to store authentication tokens")}}validateStoredToken(){return Ze(this,null,function*(){try{const e=sessionStorage.getItem("access_token"),t=sessionStorage.getItem("token_expires");return!e||!t?!1:Date.now()>parseInt(t)?yield this.refreshToken():!0}catch(e){return console.error("Token validation failed:",e),!1}})}refreshToken(){return Ze(this,null,function*(){try{const e=sessionStorage.getItem("refresh_token");if(!e)return!1;const{data:t,error:r}=yield d.auth.refreshSession({refresh_token:e});return r||!t.session?(yield this.clearTokens(),!1):(this.storeTokens({accessToken:t.session.access_token,refreshToken:t.session.refresh_token,expiresIn:t.session.expires_in}),!0)}catch(e){return console.error("Token refresh failed:",e),yield this.clearTokens(),!1}})}clearTokens(){return Ze(this,null,function*(){try{sessionStorage.removeItem("access_token"),sessionStorage.removeItem("refresh_token"),sessionStorage.removeItem("token_expires"),sessionStorage.removeItem("csrf_token"),yield d.auth.signOut()}catch(e){console.error("Failed to clear tokens:",e)}})}getCurrentUser(){return Ze(this,null,function*(){try{if(!(yield this.validateStoredToken()))return null;const{data:{user:t}}=yield d.auth.getUser();return t}catch(e){return console.error("Failed to get current user:",e),null}})}validateToken(e){return Ze(this,null,function*(){try{if(e){const{data:t,error:r}=yield d.auth.getUser(e);return!r&&!!t.user}else return yield this.validateStoredToken()}catch(t){return console.error("Token validation failed:",t),!1}})}logout(){return Ze(this,null,function*(){try{yield this.clearTokens(),console.log("[AUTH] Logout completed successfully")}catch(e){throw console.error("[AUTH] Logout error:",e),e}})}}new sc;var Ta={},Kn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});let Vi=null;const Ki=typeof window!="undefined",ru=()=>Kn(null,null,function*(){if(!Ki)try{const{createClient:c}=yield T(()=>import("./redisClient.server-CVInn9Id.js"),__vite__mapDeps([8,0,1,2,3,4,5,6,7,9,10]));Vi=c}catch(c){}});Ki||ru();class iu{constructor(e){this.client=null,this.isConnected=!1,this.config=e}connect(){return Kn(this,null,function*(){if(!this.isConnected){if(Ki){v.warn("Redis not available in browser environment, using in-memory fallback");return}if(Vi||(yield new Promise(e=>setTimeout(e,100))),!Vi){v.warn("Redis not available, using in-memory fallback");return}try{this.client=Vi({socket:{host:this.config.host,port:this.config.port,reconnectStrategy:e=>e>10?(v.error("Redis connection failed after 10 retries"),new Error("Redis connection failed")):Math.min(e*100,3e3)},password:this.config.password,database:this.config.db||0}),this.client.on("error",e=>{v.error("Redis client error:",e),this.isConnected=!1}),this.client.on("connect",()=>{v.info("Redis client connected"),this.isConnected=!0}),this.client.on("disconnect",()=>{v.warn("Redis client disconnected"),this.isConnected=!1}),yield this.client.connect()}catch(e){throw v.error("Failed to connect to Redis:",e),e}}})}disconnect(){return Kn(this,null,function*(){this.client&&this.isConnected&&(yield this.client.disconnect(),this.isConnected=!1)})}getClient(){if(!this.client||!this.isConnected)throw new Error("Redis client not connected");return this.client}isHealthy(){return Ki?!1:this.isConnected&&this.client!==null}}const ii=(c,e)=>typeof process!="undefined"&&Ta&&Ta[c]||e,nu={host:ii("REDIS_HOST","localhost"),port:parseInt(ii("REDIS_PORT","6379")),password:ii("REDIS_PASSWORD",""),db:parseInt(ii("REDIS_DB","0")),retryDelayOnFailover:100,maxRetriesPerRequest:3},H=new iu(nu);var au=Object.defineProperty,ka=Object.getOwnPropertySymbols,ou=Object.prototype.hasOwnProperty,su=Object.prototype.propertyIsEnumerable,Pa=(c,e,t)=>e in c?au(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,vt=(c,e)=>{for(var t in e||(e={}))ou.call(e,t)&&Pa(c,t,e[t]);if(ka)for(var t of ka(e))su.call(e,t)&&Pa(c,t,e[t]);return c},ni=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Je{constructor(e){this.fallbackCache=new Map,this.cleanupInterval=null,this.config=vt({blockDurationMs:e.windowMs*2},e),this.startCleanupInterval()}checkRateLimit(e,t){return ni(this,null,function*(){const r=vt(vt({},this.config),t),i=`${r.keyPrefix}:${e}`,n=Date.now(),o=n-r.windowMs;try{if(H.isHealthy())return yield this.checkRedisRateLimit(i,r,n,o)}catch(s){v.warn("Redis rate limiting failed, falling back to in-memory:",s)}return this.checkInMemoryRateLimit(i,r,n)})}checkRedisRateLimit(e,t,r,i){return ni(this,null,function*(){const n=H.getClient(),o=n.multi();o.zRemRangeByScore(e,"-inf",i),o.zCard(e),o.zAdd(e,{score:r,member:`${r}-${Math.random()}`}),o.expire(e,Math.ceil(t.windowMs/1e3));const s=`${e}:blocked`;o.get(s);const a=yield o.exec();if(!a||a.length<4)throw new Error("Redis pipeline execution failed");const l=a[1],u=a[4];if(u){const h=parseInt(u);if(r<h)return{allowed:!1,remaining:0,resetTime:h,retryAfter:Math.ceil((h-r)/1e3)};yield n.del(s)}if(l>=t.maxRequests){if(t.blockDurationMs){const h=r+t.blockDurationMs;yield n.setEx(s,Math.ceil(t.blockDurationMs/1e3),h.toString())}return{allowed:!1,remaining:0,resetTime:r+t.windowMs,retryAfter:Math.ceil(t.windowMs/1e3)}}return{allowed:!0,remaining:t.maxRequests-l-1,resetTime:r+t.windowMs}})}checkInMemoryRateLimit(e,t,r){const i=this.fallbackCache.get(e);i&&i.resetTime<r&&this.fallbackCache.delete(e);const n=this.fallbackCache.get(e)||{count:0,resetTime:r+t.windowMs,blocked:!1};return n.blocked&&n.blockUntil&&r<n.blockUntil?{allowed:!1,remaining:0,resetTime:n.blockUntil,retryAfter:Math.ceil((n.blockUntil-r)/1e3)}:(n.resetTime<r&&(n.count=0,n.resetTime=r+t.windowMs,n.blocked=!1,delete n.blockUntil),n.count>=t.maxRequests?(t.blockDurationMs&&(n.blocked=!0,n.blockUntil=r+t.blockDurationMs),this.fallbackCache.set(e,n),{allowed:!1,remaining:0,resetTime:n.resetTime,retryAfter:Math.ceil(t.windowMs/1e3)}):(n.count++,this.fallbackCache.set(e,n),{allowed:!0,remaining:t.maxRequests-n.count,resetTime:n.resetTime}))}resetRateLimit(e,t){return ni(this,null,function*(){const i=`${vt(vt({},this.config),t).keyPrefix}:${e}`;try{if(H.isHealthy()){const n=H.getClient();yield n.del(i),yield n.del(`${i}:blocked`)}}catch(n){v.warn("Failed to reset Redis rate limit:",n)}this.fallbackCache.delete(i)})}getRateLimitStatus(e,t){return ni(this,null,function*(){const r=vt(vt({},this.config),t),i=`${r.keyPrefix}:${e}`,n=Date.now(),o=n-r.windowMs;try{if(H.isHealthy()){const a=H.getClient(),l=`${i}:blocked`,u=yield a.get(l);if(u){const f=parseInt(u);if(n<f)return{allowed:!1,remaining:0,resetTime:f,retryAfter:Math.ceil((f-n)/1e3)}}const h=yield a.zCount(i,o,"+inf");return{allowed:h<r.maxRequests,remaining:Math.max(0,r.maxRequests-h),resetTime:n+r.windowMs}}}catch(a){v.warn("Failed to get Redis rate limit status:",a)}const s=this.fallbackCache.get(i);return!s||s.resetTime<n?{allowed:!0,remaining:r.maxRequests,resetTime:n+r.windowMs}:s.blocked&&s.blockUntil&&n<s.blockUntil?{allowed:!1,remaining:0,resetTime:s.blockUntil,retryAfter:Math.ceil((s.blockUntil-n)/1e3)}:{allowed:s.count<r.maxRequests,remaining:Math.max(0,r.maxRequests-s.count),resetTime:s.resetTime}})}startCleanupInterval(){this.cleanupInterval=setInterval(()=>{const e=Date.now();for(const[t,r]of Array.from(this.fallbackCache.entries()))r.resetTime<e&&this.fallbackCache.delete(t)},6e4)}getStats(){return{fallbackCacheSize:this.fallbackCache.size,redisHealthy:H.isHealthy(),config:this.config}}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.fallbackCache.clear()}}new Je({maxRequests:100,windowMs:60*1e3,keyPrefix:"api",blockDurationMs:300*1e3});new Je({maxRequests:5,windowMs:900*1e3,keyPrefix:"auth",blockDurationMs:1800*1e3});new Je({maxRequests:20,windowMs:60*1e3,keyPrefix:"ai",blockDurationMs:120*1e3});new Je({maxRequests:30,windowMs:60*1e3,keyPrefix:"general"});var cu=Object.defineProperty,Ca=Object.getOwnPropertySymbols,lu=Object.prototype.hasOwnProperty,uu=Object.prototype.propertyIsEnumerable,Da=(c,e,t)=>e in c?cu(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,ai=(c,e)=>{for(var t in e||(e={}))lu.call(e,t)&&Da(c,t,e[t]);if(Ca)for(var t of Ca(e))uu.call(e,t)&&Da(c,t,e[t]);return c},Ir=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Yn{constructor(e={}){this.config=ai({maxRequests:100,windowMs:60*1e3,burstLimit:10,retryDelay:1e3,maxRetries:3},e),this.generalLimiter=new Je({maxRequests:this.config.maxRequests,windowMs:this.config.windowMs,keyPrefix:"ai_general",blockDurationMs:this.config.windowMs}),this.burstLimiter=new Je({maxRequests:this.config.burstLimit,windowMs:10*1e3,keyPrefix:"ai_burst",blockDurationMs:30*1e3})}checkRateLimit(e,t=!1){return Ir(this,null,function*(){try{if(t){const i=yield this.burstLimiter.checkRateLimit(e);if(!i.allowed)return{allowed:!1,remaining:0,resetTime:i.resetTime,retryAfter:i.retryAfter,burstRemaining:0}}const r=yield this.generalLimiter.checkRateLimit(e);return{allowed:r.allowed,remaining:r.remaining,resetTime:r.resetTime,retryAfter:r.retryAfter,burstRemaining:t?yield this.getBurstRemaining(e):void 0}}catch(r){return v.error("AI rate limit check failed:",r),{allowed:!0,remaining:this.config.maxRequests,resetTime:Date.now()+this.config.windowMs}}})}recordRequest(e,t=!1){return Ir(this,null,function*(){try{t&&(yield this.burstLimiter.checkRateLimit(e)),yield this.generalLimiter.checkRateLimit(e)}catch(r){v.error("AI rate limit recording failed:",r)}})}getBurstRemaining(e){return Ir(this,null,function*(){try{return(yield this.burstLimiter.getRateLimitStatus(e)).remaining}catch(t){return v.error("Failed to get burst remaining:",t),this.config.burstLimit}})}resetRateLimit(e){return Ir(this,null,function*(){try{yield Promise.all([this.generalLimiter.resetRateLimit(e),this.burstLimiter.resetRateLimit(e)])}catch(t){v.error("Failed to reset AI rate limits:",t)}})}getStatus(e){return Ir(this,null,function*(){try{const[t,r]=yield Promise.all([this.generalLimiter.getRateLimitStatus(e),this.burstLimiter.getRateLimitStatus(e)]);return{general:{allowed:t.allowed,remaining:t.remaining,resetTime:t.resetTime,retryAfter:t.retryAfter},burst:{allowed:r.allowed,remaining:r.remaining,resetTime:r.resetTime,retryAfter:r.retryAfter}}}catch(t){return v.error("Failed to get AI rate limit status:",t),{general:{allowed:!0,remaining:this.config.maxRequests,resetTime:Date.now()+this.config.windowMs},burst:{allowed:!0,remaining:this.config.burstLimit,resetTime:Date.now()+10*1e3}}}})}updateConfig(e){this.config=ai(ai({},this.config),e),this.generalLimiter=new Je({maxRequests:this.config.maxRequests,windowMs:this.config.windowMs,keyPrefix:"ai_general",blockDurationMs:this.config.windowMs}),this.burstLimiter=new Je({maxRequests:this.config.burstLimit,windowMs:10*1e3,keyPrefix:"ai_burst",blockDurationMs:30*1e3}),v.info("AI rate limiter configuration updated",e)}getConfigs(){return ai({},this.config)}getStats(){return{general:this.generalLimiter.getStats(),burst:this.burstLimiter.getStats(),config:this.config}}isHealthy(){try{const e=this.generalLimiter.getStats(),t=this.burstLimiter.getStats();return e.redisHealthy||t.redisHealthy}catch(e){return v.error("Health check failed:",e),!1}}}const Qn=new Yn({maxRequests:50,windowMs:60*1e3,burstLimit:5,retryDelay:2e3,maxRetries:3});new Yn({maxRequests:20,windowMs:60*1e3,burstLimit:3,retryDelay:3e3,maxRetries:2});new Yn({maxRequests:10,windowMs:300*1e3,burstLimit:2,retryDelay:5e3,maxRetries:1});var du=Object.defineProperty,Oa=Object.getOwnPropertySymbols,hu=Object.prototype.hasOwnProperty,fu=Object.prototype.propertyIsEnumerable,Ra=(c,e,t)=>e in c?du(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,hn=(c,e)=>{for(var t in e||(e={}))hu.call(e,t)&&Ra(c,t,e[t]);if(Oa)for(var t of Oa(e))fu.call(e,t)&&Ra(c,t,e[t]);return c},oi=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class mu{constructor(e={}){this.queue=[],this.processing=!1,this.activeRequests=0,this.processingInterval=null,this.results=new Map,this.config=hn({maxConcurrent:5,batchSize:3,processingInterval:1e3,retryDelay:2e3},e)}addRequest(e,t,r){return oi(this,arguments,function*(i,n,o,s={}){const a={id:`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,service:i,identifier:n,operation:o,priority:s.priority||0,maxRetries:s.maxRetries||3,timeout:s.timeout||3e4,createdAt:new Date,metadata:s.metadata};return this.queue.push(a),this.queue.sort((l,u)=>u.priority-l.priority),v.debug(`Added request to queue: ${a.id} (priority: ${a.priority})`),this.processing||this.startProcessing(),this.waitForCompletion(a.id)})}startProcessing(){this.processing||(this.processing=!0,this.processingInterval=setInterval(()=>{this.processQueue()},this.config.processingInterval),v.info("AI request queue processing started"))}stopProcessing(){this.processingInterval&&(clearInterval(this.processingInterval),this.processingInterval=null),this.processing=!1,v.info("AI request queue processing stopped")}processQueue(){return oi(this,null,function*(){if(this.activeRequests>=this.config.maxConcurrent||this.queue.length===0)return;const e=this.queue.splice(0,this.config.batchSize);for(const t of e){if(this.activeRequests>=this.config.maxConcurrent){this.queue.unshift(...e.slice(e.indexOf(t)));break}this.processRequest(t)}})}processRequest(e){return oi(this,null,function*(){this.activeRequests++;try{v.debug(`Processing request: ${e.id}`);const t=yield Qn.checkRateLimit(e.identifier);if(!t.allowed)throw new Error(`Rate limit exceeded. Retry after ${t.retryAfter}ms`);const r=yield e.operation();yield Qn.recordRequest(e.identifier),this.storeResult(e.id,{success:!0,data:r})}catch(t){v.error(`Request ${e.id} failed:`,t),e.maxRetries>0?(e.maxRetries--,this.queue.push(e),v.debug(`Retrying request ${e.id} (${e.maxRetries} retries left)`)):this.storeResult(e.id,{success:!1,error:t instanceof Error?t.message:"Unknown error"})}finally{this.activeRequests--}})}waitForCompletion(e){return oi(this,null,function*(){return new Promise((t,r)=>{const i=()=>{const n=this.getResult(e);n?n.success?t(n.data):r(new Error(n.error)):setTimeout(i,100)};i()})})}storeResult(e,t){this.results.set(e,t)}getResult(e){return this.results.get(e)}getStats(){return{queueLength:this.queue.length,activeRequests:this.activeRequests,processing:this.processing,config:this.config}}clearQueue(){this.queue=[],this.results.clear(),v.info("AI request queue cleared")}updateConfig(e){this.config=hn(hn({},this.config),e),v.info("AI request queue configuration updated:",this.config)}}const si=new mu;var Sr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class pu{constructor(e="cliniio"){this.cache=new Map,this.namespace=e}getKey(e){return`${this.namespace}:${e}`}get(e){return Sr(this,null,function*(){try{const t=this.cache.get(this.getKey(e));return t&&t.expires>Date.now()?t.value:(t&&this.cache.delete(this.getKey(e)),null)}catch(t){return v.error("In-memory cache get error:",t),null}})}set(e,t){return Sr(this,arguments,function*(r,i,n={}){try{const o=n.ttl||300,s=Date.now()+o*1e3;this.cache.set(this.getKey(r),{value:i,expires:s})}catch(o){v.error("In-memory cache set error:",o)}})}del(e){return Sr(this,null,function*(){try{this.cache.delete(this.getKey(e))}catch(t){v.error("In-memory cache delete error:",t)}})}exists(e){return Sr(this,null,function*(){try{const t=this.cache.get(this.getKey(e));return t?t.expires>Date.now():!1}catch(t){return v.error("In-memory cache exists error:",t),!1}})}clear(){return Sr(this,null,function*(){try{this.cache.clear()}catch(e){v.error("In-memory cache clear error:",e)}})}cleanup(){const e=Date.now();for(const[t,r]of Array.from(this.cache.entries()))r.expires<=e&&this.cache.delete(t)}getStats(){return{size:this.cache.size,isRedis:!1}}}var br=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class cc{constructor(e="cliniio"){this.namespace=e,this.fallbackCache=new pu(e)}getKey(e){return`${this.namespace}:${e}`}get(e){return br(this,null,function*(){try{if(H.isHealthy()){const r=yield H.getClient().get(this.getKey(e));return r?JSON.parse(r):null}else return yield this.fallbackCache.get(e)}catch(t){return v.error("Cache get error:",t),yield this.fallbackCache.get(e)}})}set(e,t){return br(this,arguments,function*(r,i,n={}){try{if(H.isHealthy()){const o=H.getClient(),s=n.ttl||300;yield o.setEx(this.getKey(r),s,JSON.stringify(i))}else yield this.fallbackCache.set(r,i,n)}catch(o){v.error("Cache set error:",o),yield this.fallbackCache.set(r,i,n)}})}del(e){return br(this,null,function*(){try{H.isHealthy()?yield H.getClient().del(this.getKey(e)):yield this.fallbackCache.del(e)}catch(t){v.error("Cache delete error:",t),yield this.fallbackCache.del(e)}})}exists(e){return br(this,null,function*(){try{return H.isHealthy()?(yield H.getClient().exists(this.getKey(e)))===1:yield this.fallbackCache.exists(e)}catch(t){return v.error("Cache exists error:",t),yield this.fallbackCache.exists(e)}})}clear(){return br(this,null,function*(){try{if(H.isHealthy()){const e=H.getClient(),t=yield e.keys(this.getKey("*"));t.length>0&&(yield e.del(t))}else yield this.fallbackCache.clear()}catch(e){v.error("Cache clear error:",e),yield this.fallbackCache.clear()}})}cleanup(){this.fallbackCache.cleanup()}getStats(){return{size:this.fallbackCache.getStats().size,isRedis:H.isHealthy()}}}var Er=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class gu{constructor(){this.DEFAULT_TTL=3600,this.hitCounts=new Map,this.cache=new cc("ai_responses")}generateCacheKey(e){const{service:t,operation:r,parameters:i,userId:n,facilityId:o}=e,s=this.hashObject(i);let a=`${t}:${r}:${s}`;return n&&(a+=`:user:${n}`),o&&(a+=`:facility:${o}`),a}get(e){return Er(this,null,function*(){try{const t=this.generateCacheKey(e),r=yield this.cache.get(t);if(r){const i=this.hitCounts.get(t)||0;return this.hitCounts.set(t,i+1),v.debug(`AI cache hit for ${e.service}:${e.operation}`),r.data}return null}catch(t){return v.error("Error getting from AI cache:",t),null}})}set(e,t){return Er(this,arguments,function*(r,i,n={}){try{const o=this.generateCacheKey(r),s=n.ttl||this.DEFAULT_TTL,a={data:i,timestamp:Date.now(),hitCount:0,metadata:{service:r.service,operation:r.operation,userId:r.userId,facilityId:r.facilityId}};yield this.cache.set(o,a,{ttl:s}),v.debug(`AI response cached for ${r.service}:${r.operation}`)}catch(o){v.error("Error setting AI cache:",o)}})}executeWithCache(e,t){return Er(this,arguments,function*(r,i,n={}){const o=yield this.get(r);if(o!==null)return o;const s=yield i();return yield this.set(r,s,n),s})}invalidate(e){return Er(this,null,function*(){try{v.info("Invalidating AI cache for pattern:",e),yield this.cache.clear()}catch(t){v.error("Error invalidating AI cache:",t)}})}getStats(){return{totalEntries:this.hitCounts.size,hitCounts:Object.fromEntries(this.hitCounts),cacheStats:this.cache.getStats()}}clear(){return Er(this,null,function*(){try{yield this.cache.clear(),this.hitCounts.clear(),v.info("AI response cache cleared")}catch(e){v.error("Error clearing AI cache:",e)}})}hashObject(e){const t=JSON.stringify(e,Object.keys(e).sort());return this.simpleHash(t)}simpleHash(e){let t=0;for(let r=0;r<e.length;r++){const i=e.charCodeAt(r);t=(t<<5)-t+i,t=t&t}return Math.abs(t).toString(36)}}const ci=new gu;var yu=Object.defineProperty,$a=Object.getOwnPropertySymbols,_u=Object.prototype.hasOwnProperty,vu=Object.prototype.propertyIsEnumerable,Ma=(c,e,t)=>e in c?yu(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,fn=(c,e)=>{for(var t in e||(e={}))_u.call(e,t)&&Ma(c,t,e[t]);if($a)for(var t of $a(e))vu.call(e,t)&&Ma(c,t,e[t]);return c},Ut=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class wu{constructor(e={}){this.pendingRequests=[],this.activeBatches=0,this.batchTimer=null,this.config=fn({maxBatchSize:10,maxWaitTime:2e3,maxConcurrentBatches:3,priorityThreshold:5},e)}addRequest(e){return Ut(this,arguments,function*(t,r={}){const i={id:`batch_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,operation:t,priority:r.priority||0,metadata:r.metadata};return this.pendingRequests.push(i),this.pendingRequests.sort((n,o)=>o.priority-n.priority),v.debug(`Added request to batch queue: ${i.id} (priority: ${i.priority})`),this.batchTimer||this.startBatchTimer(),this.waitForCompletion(i.id)})}startBatchTimer(){this.batchTimer=setTimeout(()=>{this.processBatches(),this.batchTimer=null},this.config.maxWaitTime)}processBatches(){return Ut(this,null,function*(){if(this.activeBatches>=this.config.maxConcurrentBatches){this.startBatchTimer();return}const e=this.pendingRequests.filter(r=>r.priority<this.config.priorityThreshold);if(e.length===0)return;const t=this.createBatches(e);for(const r of t){if(this.activeBatches>=this.config.maxConcurrentBatches)break;this.processBatch(r)}this.pendingRequests.length>0&&this.startBatchTimer()})}createBatches(e){const t=[];for(let r=0;r<e.length;r+=this.config.maxBatchSize){const i=e.slice(r,r+this.config.maxBatchSize);t.push(i)}return t}processBatch(e){return Ut(this,null,function*(){this.activeBatches++;try{v.debug(`Processing batch of ${e.length} requests`),e.forEach(n=>{const o=this.pendingRequests.findIndex(s=>s.id===n.id);o!==-1&&this.pendingRequests.splice(o,1)});const t=Date.now(),r=e.map(n=>Ut(this,null,function*(){const o=Date.now();try{const s=yield n.operation(),a=Date.now()-o;this.storeResult(n.id,{id:n.id,success:!0,data:s,duration:a})}catch(s){const a=Date.now()-o;this.storeResult(n.id,{id:n.id,success:!1,error:s instanceof Error?s.message:"Unknown error",duration:a})}}));yield Promise.all(r);const i=Date.now()-t;v.debug(`Batch completed in ${i}ms`)}catch(t){v.error("Batch processing failed:",t),e.forEach(r=>{this.storeResult(r.id,{id:r.id,success:!1,error:"Batch processing failed",duration:0})})}finally{this.activeBatches--}})}waitForCompletion(e){return Ut(this,null,function*(){return new Promise((t,r)=>{const i=()=>{const n=this.getResult(e);n?n.success?t(n.data):r(new Error(n.error)):setTimeout(i,50)};i()})})}storeResult(e,t){this.results=this.results||new Map,this.results.set(e,t)}getResult(e){return this.results=this.results||new Map,this.results.get(e)}getStats(){return{pendingRequests:this.pendingRequests.length,activeBatches:this.activeBatches,config:this.config}}updateConfig(e){this.config=fn(fn({},this.config),e),v.info("AI request batcher configuration updated:",this.config)}clearPending(){this.pendingRequests=[],this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),v.info("AI request batcher cleared")}forceProcess(){return Ut(this,null,function*(){this.batchTimer&&(clearTimeout(this.batchTimer),this.batchTimer=null),yield this.processBatches()})}}const Ar=new wu;var Iu=Object.defineProperty,Su=Object.defineProperties,bu=Object.getOwnPropertyDescriptors,qa=Object.getOwnPropertySymbols,Eu=Object.prototype.hasOwnProperty,Au=Object.prototype.propertyIsEnumerable,za=(c,e,t)=>e in c?Iu(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,mn=(c,e)=>{for(var t in e||(e={}))Eu.call(e,t)&&za(c,t,e[t]);if(qa)for(var t of qa(e))Au.call(e,t)&&za(c,t,e[t]);return c},Tu=(c,e)=>Su(c,bu(e));class kt{constructor(){this.serviceMetrics={},this.alerts=[],this.requestTimes=[],this.MAX_REQUEST_TIMES=1e3,this.metrics={totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0,cacheHitRate:0,rateLimitHits:0,queueLength:0,activeRequests:0,lastUpdated:new Date}}static getInstance(){return kt.instance||(kt.instance=new kt),kt.instance}recordRequest(e,t,r,i=!1,n=!1){const o=new Date;this.metrics.totalRequests++,t?this.metrics.successfulRequests++:this.metrics.failedRequests++,i?this.metrics.cacheHitRate=(this.metrics.cacheHitRate*(this.metrics.totalRequests-1)+1)/this.metrics.totalRequests:this.metrics.cacheHitRate=this.metrics.cacheHitRate*(this.metrics.totalRequests-1)/this.metrics.totalRequests,n&&this.metrics.rateLimitHits++,this.requestTimes.push(r),this.requestTimes.length>this.MAX_REQUEST_TIMES&&this.requestTimes.shift(),this.metrics.averageResponseTime=this.calculateAverageResponseTime(),this.serviceMetrics[e]||(this.serviceMetrics[e]={requests:0,successes:0,failures:0,avgResponseTime:0,lastRequest:o});const s=this.serviceMetrics[e];s.requests++,s.lastRequest=o,t?s.successes++:s.failures++,s.avgResponseTime=(s.avgResponseTime*(s.requests-1)+r)/s.requests,this.metrics.lastUpdated=o,this.checkAlerts(e,t,r)}updateQueueMetrics(e,t){this.metrics.queueLength=e,this.metrics.activeRequests=t,this.metrics.lastUpdated=new Date}getMetrics(){return mn({},this.metrics)}getServiceMetrics(){return mn({},this.serviceMetrics)}getAlerts(){return[...this.alerts]}clearOldAlerts(e=1440*60*1e3){const t=new Date(Date.now()-e);this.alerts=this.alerts.filter(r=>r.timestamp>t)}getHealthStatus(){const e=[],t=[],r=this.metrics.totalRequests>0?this.metrics.failedRequests/this.metrics.totalRequests:0;r>.1&&(e.push(`High error rate: ${(r*100).toFixed(1)}%`),t.push("Investigate failed requests and improve error handling")),this.metrics.averageResponseTime>5e3&&(e.push(`Slow response time: ${this.metrics.averageResponseTime.toFixed(0)}ms`),t.push("Optimize AI operations and consider caching")),this.metrics.queueLength>50&&(e.push(`High queue length: ${this.metrics.queueLength}`),t.push("Increase processing capacity or optimize request handling")),this.metrics.cacheHitRate<.3&&(e.push(`Low cache hit rate: ${(this.metrics.cacheHitRate*100).toFixed(1)}%`),t.push("Improve caching strategy and cache more responses"));let i="healthy";return e.length>0&&(i=e.length>2?"critical":"warning"),{status:i,issues:e,recommendations:t}}calculateAverageResponseTime(){return this.requestTimes.length===0?0:this.requestTimes.reduce((e,t)=>e+t,0)/this.requestTimes.length}checkAlerts(e,t,r){if(!t){const i=this.serviceMetrics[e];if(i&&i.requests>10){const n=i.failures/i.requests;n>.2&&this.addAlert({type:"high_error_rate",severity:"critical",message:`High error rate for ${e}: ${(n*100).toFixed(1)}%`,metadata:{service:e,errorRate:n}})}}r>1e4&&this.addAlert({type:"slow_response",severity:"warning",message:`Slow response time for ${e}: ${r}ms`,metadata:{service:e,responseTime:r}}),this.metrics.queueLength>100&&this.addAlert({type:"high_queue_length",severity:"critical",message:`High queue length: ${this.metrics.queueLength}`,metadata:{queueLength:this.metrics.queueLength}}),this.metrics.rateLimitHits>10&&this.addAlert({type:"rate_limit_exceeded",severity:"warning",message:`Rate limit exceeded ${this.metrics.rateLimitHits} times`,metadata:{rateLimitHits:this.metrics.rateLimitHits}})}addAlert(e){const t=Tu(mn({},e),{id:`alert_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date});this.alerts.push(t),v.warn(`AI Performance Alert: ${t.message}`,t)}resetMetrics(){this.metrics={totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0,cacheHitRate:0,rateLimitHits:0,queueLength:0,activeRequests:0,lastUpdated:new Date},this.serviceMetrics={},this.alerts=[],this.requestTimes=[],v.info("AI monitoring metrics reset")}}const Tr=kt.getInstance();var ku=Object.defineProperty,Pu=Object.defineProperties,Cu=Object.getOwnPropertyDescriptors,Ua=Object.getOwnPropertySymbols,Du=Object.prototype.hasOwnProperty,Ou=Object.prototype.propertyIsEnumerable,Na=(c,e,t)=>e in c?ku(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ru=(c,e)=>{for(var t in e||(e={}))Du.call(e,t)&&Na(c,t,e[t]);if(Ua)for(var t of Ua(e))Ou.call(e,t)&&Na(c,t,e[t]);return c},$u=(c,e)=>Pu(c,Cu(e)),li=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Pt{constructor(){}static getInstance(){return Pt.instance||(Pt.instance=new Pt),Pt.instance}execute(e,t,r){return li(this,null,function*(){const i=Date.now();let n=!1,o=!1,s,a;try{if(e.useCache!==!1){const u={service:e.service,operation:e.operation,parameters:(r==null?void 0:r.parameters)||{},userId:r==null?void 0:r.userId,facilityId:r==null?void 0:r.facilityId},h=yield ci.get(u);h!==null&&(n=!0,s=h,o=!0,v.debug(`AI operation served from cache: ${e.service}:${e.operation}`))}if(!n&&(e.useBatching!==!1&&(e.priority||0)<5?s=yield Ar.addRequest(t,{priority:e.priority,metadata:e.metadata}):s=yield si.addRequest(e.service,(r==null?void 0:r.userId)||"anonymous",t,{priority:e.priority,maxRetries:e.maxRetries,timeout:e.timeout,metadata:e.metadata}),o=!0,e.useCache!==!1&&s)){const u={service:e.service,operation:e.operation,parameters:(r==null?void 0:r.parameters)||{},userId:r==null?void 0:r.userId,facilityId:r==null?void 0:r.facilityId};yield ci.set(u,s,{ttl:e.cacheTtl})}const l=Date.now()-i;return Tr.recordRequest(e.service,o,l,n,!1),{success:o,data:s,error:a,fromCache:n,responseTime:l,metadata:e.metadata}}catch(l){const u=Date.now()-i;return a=l instanceof Error?l.message:"Unknown error",o=!1,Tr.recordRequest(e.service,o,u,n,!1),v.error(`AI operation failed: ${e.service}:${e.operation}`,l),{success:o,data:s,error:a,fromCache:n,responseTime:u,metadata:e.metadata}}})}executeBatch(e){return li(this,null,function*(){const t=e.map(({config:r,operation:i,context:n})=>this.execute(r,i,n));return Promise.all(t)})}getStats(){return{monitoring:Tr.getMetrics(),queue:si.getStats(),cache:ci.getStats(),batcher:Ar.getStats(),rateLimiter:Qn.getConfigs()}}getHealthStatus(){const e=Tr.getHealthStatus(),t=this.getStats();return $u(Ru({},e),{metrics:t})}reset(){return li(this,null,function*(){yield ci.clear(),si.clearQueue(),Ar.clearPending(),Tr.resetMetrics(),v.info("AI service reset completed")})}updateConfig(e){e.queue&&si.updateConfig(e.queue),e.batcher&&Ar.updateConfig(e.batcher),v.info("AI service configuration updated")}forceProcess(){return li(this,null,function*(){yield Ar.forceProcess(),v.info("AI service force processing completed")})}}Pt.getInstance();var pn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Mu{constructor(e){this.facilityId=e}getLearningInsights(){return pn(this,null,function*(){try{const e=[],{data:t}=yield d.from("learning_ai_personalized_recommendations").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);t&&t.forEach(o=>{e.push({type:"personalized_recommendation",title:"Personalized Learning Recommendations",description:`${o.recommended_content.length} content items recommended for user ${o.user_id}`,confidence:o.confidence_score||0,recommendations:o.recommendation_reasoning||[],data:o,created_at:o.created_at,facility_id:this.facilityId,priority:this.getPriorityFromConfidence(o.confidence_score),actionable:!0,id:o.id||`recommendation-${Date.now()}`})});const{data:r}=yield d.from("learning_ai_skill_gap_analysis").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);r&&r.forEach(o=>{const s=Object.keys(o.skill_gaps);e.push({type:"skill_gap_analysis",title:"Skill Gap Analysis",description:`${s.length} skill gaps identified for user ${o.user_id}`,confidence:o.confidence_score||0,recommendations:o.learning_recommendations||[],data:o,created_at:o.created_at,facility_id:this.facilityId,priority:this.getPriorityFromGapCount(s.length),actionable:!0,id:o.id||`skillgap-${Date.now()}`})});const{data:i}=yield d.from("learning_ai_path_optimization").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);i&&i.forEach(o=>{e.push({type:"learning_path_optimization",title:"Learning Path Optimized",description:`Path efficiency score: ${(o.path_efficiency_score*100).toFixed(1)}% for user ${o.user_id}`,confidence:o.confidence_score||0,recommendations:o.optimization_factors||[],data:o,created_at:o.created_at,facility_id:this.facilityId,priority:this.getPriorityFromEfficiency(o.path_efficiency_score),actionable:!0,id:o.id||`pathopt-${Date.now()}`})});const{data:n}=yield d.from("learning_ai_performance_prediction").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);return n&&n.forEach(o=>{e.push({type:"performance_prediction",title:"Performance Prediction",description:`Predicted performance: ${(o.predicted_performance*100).toFixed(1)}% for content ${o.user_id}`,confidence:o.confidence_score||0,recommendations:o.performance_factors||[],data:o,created_at:o.created_at,facility_id:this.facilityId,priority:this.getPriorityFromPerformance(o.predicted_performance),actionable:!0,id:o.id||`perfpred-${Date.now()}`})}),e}catch(e){return console.error("Error getting learning insights:",e),[]}})}getHistoricalLearningData(){return pn(this,null,function*(){try{const{data:e}=yield d.from("user_learning_progress").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(30);return e?e.map(t=>({date:t.created_at,user_id:t.user_id,content_id:t.content_id,progress_percentage:t.completion_rate,time_spent:t.session_duration,score:t.satisfaction_score,engagement_score:this.calculateEngagementScore(t)})):Array.from({length:30},(t,r)=>({date:new Date(Date.now()-r*24*60*60*1e3).toISOString(),user_id:`user-${Math.floor(Math.random()*10)+1}`,content_id:`content-${Math.floor(Math.random()*20)+1}`,progress_percentage:Math.random()*100,time_spent:Math.floor(Math.random()*120)+15,score:Math.random()>.3?Math.random()*40+60:void 0,engagement_score:Math.random()*.4+.6}))}catch(e){return console.error("Error getting historical learning data:",e),[]}})}getLearningCostData(){return pn(this,null,function*(){try{const{data:e}=yield d.from("learning_costs").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(1).single();if(e){const t=e;return{content_creation_costs:t.content_creation_costs,platform_costs:t.platform_costs,assessment_costs:t.assessment_costs,certification_costs:t.certification_costs,total_cost:t.total_cost}}return{content_creation_costs:15e3,platform_costs:5e3,assessment_costs:3e3,certification_costs:2e3,total_cost:25e3}}catch(e){return console.error("Error getting learning cost data:",e),{content_creation_costs:15e3,platform_costs:5e3,assessment_costs:3e3,certification_costs:2e3,total_cost:25e3}}})}calculateLearningEfficiency(e,t,r){const i=e*r/(t/60);return Math.min(i,1)}calculateEngagementScore(e){const t=e.time_spent_minutes||0,r=e.progress_percentage||0,i=e.attempts||1,n=Math.min(t/60,1),o=r/100,s=Math.max(0,1-(i-1)*.1);return n*.4+o*.4+s*.2}calculateRetentionRate(e,t){if(e.length!==t.length)return 0;const r=e.map((i,n)=>t[n]/i);return r.reduce((i,n)=>i+n,0)/r.length}calculateSkillProgression(e){const t={};return Object.entries(e).forEach(([r,i])=>{if(i.length<2){t[r]="stable";return}const n=i.slice(0,Math.ceil(i.length/2)),o=i.slice(Math.ceil(i.length/2)),s=n.reduce((u,h)=>u+h,0)/n.length,a=o.reduce((u,h)=>u+h,0)/o.length,l=s-a;l>.1?t[r]="improving":l<-.1?t[r]="declining":t[r]="stable"}),t}calculateLearningVelocity(e,t){return e/(t/7)}calculateKnowledgeDecayRate(e,t,r){if(r===0)return 0;const i=t/e;return i<=0?1:-Math.log(i)/r}calculateAdaptiveDifficultyAdjustment(e,t,r){const n=(e-t)*.1;return Math.max(0,Math.min(1,r+n))}detectLearningPatterns(e){const t=e.map(p=>p.content_id.split("-")[0]),r=e.map(p=>new Date(p.date).getHours()),i=t.reduce((p,g)=>(p[g]=(p[g]||0)+1,p),{}),n=Object.entries(i).sort(([,p],[,g])=>g-p).slice(0,3).map(([p])=>p),o=r.reduce((p,g)=>(p[g]=(p[g]||0)+1,p),{}),s=Object.entries(o).sort(([,p],[,g])=>g-p).slice(0,2).map(([p])=>`${p}:00`),a=Array.from(new Set(e.map(p=>p.date.split("T")[0]))).sort();let l=0,u=1;for(let p=1;p<a.length;p++){const g=new Date(a[p-1]);(new Date(a[p]).getTime()-g.getTime())/(1e3*60*60*24)===1?u++:(l=Math.max(l,u),u=1)}l=Math.max(l,u);const h=e.map(p=>p.progress_percentage),f=h.reduce((p,g)=>p+g,0)/h.length;let m="intermediate";return f>90?m="advanced":f<60&&(m="beginner"),{preferredContentTypes:n,optimalStudyTimes:s,learningStreaks:l,difficultyPreferences:m}}getPriorityFromConfidence(e){return e>=.9?"critical":e>=.8?"high":e>=.7?"medium":"low"}getPriorityFromGapCount(e){return e>=5?"critical":e>=3?"high":e>=1?"medium":"low"}getPriorityFromEfficiency(e){return e>=.9?"critical":e>=.8?"high":e>=.7?"medium":"low"}getPriorityFromPerformance(e){return e>=.9?"critical":e>=.8?"high":e>=.7?"medium":"low"}}var ui={},Me=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class tn{constructor(e){this.facilityId=e}processPersonalizedRecommendationsWithAI(){return Me(this,null,function*(){return{recommended_content:["infection_control_basics","sterilization_protocols_advanced","environmental_cleaning_standards"],recommendation_reasoning:["Based on your role as environmental services technician","Addresses identified skill gaps in infection control","Builds on your completed sterilization fundamentals course"],confidence_scores:[.92,.85,.78],learning_path_suggestions:["Complete infection control basics first","Then proceed to advanced sterilization protocols","Finish with environmental cleaning standards"],skill_development_areas:["Infection control protocols","Advanced sterilization techniques","Environmental monitoring"],estimated_completion_time:120,difficulty_progression:["beginner","intermediate","advanced"],alternative_recommendations:["safety_protocols_fundamentals","equipment_maintenance_basics"],confidence_score:.87}})}processSkillGapAnalysisWithAI(){return Me(this,null,function*(){return{current_skills:{basic_cleaning:.8,safety_protocols:.6,infection_control:.4,equipment_operation:.7,documentation:.5},required_skills:{basic_cleaning:.9,safety_protocols:.9,infection_control:.8,equipment_operation:.8,documentation:.8,advanced_sterilization:.7,environmental_monitoring:.6},skill_gaps:{infection_control:.4,documentation:.3,advanced_sterilization:.7,environmental_monitoring:.6},gap_priorities:["infection_control","advanced_sterilization","environmental_monitoring","documentation"],learning_recommendations:["Complete infection control certification course","Take advanced sterilization protocols training","Enroll in environmental monitoring workshop","Practice documentation best practices"],skill_development_plan:["Week 1-2: Infection control fundamentals","Week 3-4: Advanced sterilization techniques","Week 5-6: Environmental monitoring protocols","Week 7-8: Documentation and reporting"],estimated_learning_time:160,confidence_score:.82}})}processLearningPathOptimizationWithAI(){return Me(this,null,function*(){return{optimized_learning_path:["safety_fundamentals","infection_control_basics","sterilization_protocols","environmental_cleaning_standards","advanced_sterilization_techniques","quality_assurance_protocols"],path_efficiency_score:.88,estimated_total_time:180,difficulty_progression:["beginner","beginner","intermediate","intermediate","advanced","advanced"],prerequisite_mapping:{infection_control_basics:["safety_fundamentals"],sterilization_protocols:["infection_control_basics"],environmental_cleaning_standards:["sterilization_protocols"],advanced_sterilization_techniques:["environmental_cleaning_standards"],quality_assurance_protocols:["advanced_sterilization_techniques"]},alternative_paths:[["safety_fundamentals","equipment_operation","sterilization_protocols"],["safety_fundamentals","documentation_basics","infection_control_basics"]],optimization_factors:["Prerequisite knowledge alignment","Learning curve optimization","Time efficiency","Skill progression logic"],confidence_score:.85}})}processPerformancePredictionWithAI(){return Me(this,null,function*(){return{predicted_performance:.82,predicted_completion_time:45,success_probability:.78,risk_factors:["Limited experience with advanced sterilization","Time constraints for study sessions","Complex technical concepts in later modules"],improvement_suggestions:["Allocate additional study time for complex topics","Seek hands-on practice opportunities","Connect with experienced colleagues for guidance","Break down complex topics into smaller sessions"],study_recommendations:["Study in 30-minute focused sessions","Review prerequisite materials before starting","Take practice quizzes regularly","Join study groups for peer learning"],confidence_score:.79}})}processAdaptiveDifficultyWithAI(){return Me(this,null,function*(){return{recommended_difficulty:"intermediate",difficulty_adjustment:.2,learning_curve_analysis:"User shows strong grasp of fundamentals but needs more practice with intermediate concepts",adaptation_reasoning:["High performance on basic safety protocols (95% accuracy)","Moderate performance on infection control (78% accuracy)","Struggling with advanced sterilization concepts (65% accuracy)","Consistent engagement and completion rates"],performance_indicators:{quiz_accuracy:.78,completion_rate:.92,engagement_time:.85,retention_score:.73},next_difficulty_target:"advanced",confidence_score:.81}})}processEngagementAnalysisWithAI(){return Me(this,null,function*(){return{engagement_score:.76,engagement_trends:{video_content:.85,interactive_quizzes:.78,text_reading:.65,simulations:.92},engagement_factors:["Interactive content increases engagement","Visual learning materials are preferred","Practical simulations maintain interest","Short, focused sessions work best"],disengagement_triggers:["Long text-heavy modules","Complex technical jargon without explanation","Lack of immediate feedback","Repetitive content format"],improvement_suggestions:["Increase use of interactive simulations","Break down text content into smaller chunks","Add more visual aids and diagrams","Provide immediate feedback on quizzes"],optimal_learning_times:["Morning sessions (9-11 AM)","Afternoon sessions (2-4 PM)"],content_preferences:["Video demonstrations","Interactive simulations","Case study examples","Hands-on practice exercises"],confidence_score:.83}})}processRetentionPredictionWithAI(){return Me(this,null,function*(){return{retention_probability:.72,knowledge_decay_rate:.15,review_recommendations:["Review infection control protocols weekly","Practice sterilization procedures monthly","Take refresher quizzes every 2 weeks","Attend hands-on workshops quarterly"],reinforcement_schedule:["Week 1: Initial review of key concepts","Week 2: Practice quiz on fundamentals","Month 1: Comprehensive review session","Month 3: Advanced application practice"],retention_factors:["Regular practice and application","Immediate feedback on performance","Spaced repetition of key concepts","Real-world application opportunities"],forgetting_risk_areas:["Complex sterilization parameters","Specific compliance requirements","Equipment operation procedures","Emergency response protocols"],confidence_score:.77}})}processLearningAnalyticsWithAI(){return Me(this,null,function*(){return{learning_efficiency_score:.81,preferred_content_categories:["interactive_simulations","video_demonstrations","case_studies","hands_on_practice"],optimal_study_duration:30,learning_patterns:{peak_performance_hours:"9-11 AM, 2-4 PM",preferred_session_length:"25-35 minutes",break_frequency:"every 45 minutes",review_preference:"immediate after completion"},progress_trends:{completion_rate:"increasing",quiz_accuracy:"stable",engagement_level:"improving",retention_rate:"declining"},performance_metrics:{overall_completion:.88,quiz_average:.82,engagement_score:.76,retention_rate:.68},insights:["User performs best with interactive content","Morning sessions show higher engagement","Retention drops after 2 weeks without review","Case studies improve practical application"],recommendations:["Schedule more interactive content","Implement spaced repetition for retention","Add more case study examples","Optimize study session timing"],confidence_score:.84}})}buildPersonalizedRecommendationPrompt(e,t,r){return`Generate personalized learning recommendations based on:
  User Profile: ${e}
  Learning History: ${t}
  Skill Gaps: ${r}
  
  Please provide:
  1. Recommended content based on role and interests
  2. Reasoning for each recommendation
  3. Confidence scores for recommendations
  4. Learning path suggestions
  5. Skill development areas to focus on
  6. Estimated completion time
  7. Difficulty progression
  8. Alternative recommendations`}buildSkillGapAnalysisPrompt(e,t,r){return`Analyze skill gaps based on:
  Current Skills: ${e}
  Required Skills: ${t}
  Role Requirements: ${r}
  
  Please provide:
  1. Current skill levels assessment
  2. Required skill levels for role
  3. Identified skill gaps with priority levels
  4. Learning recommendations to address gaps
  5. Skill development plan with timeline
  6. Estimated learning time required
  7. Confidence score for analysis`}buildLearningPathOptimizationPrompt(e,t,r){return`Optimize learning path based on:
  User Goals: ${e}
  Available Content: ${t}
  Constraints: ${r}
  
  Please provide:
  1. Optimized learning path sequence
  2. Path efficiency score
  3. Estimated total completion time
  4. Difficulty progression through path
  5. Prerequisite mapping
  6. Alternative path options
  7. Optimization factors considered
  8. Confidence score for optimization`}buildPerformancePredictionPrompt(e,t,r){return`Predict learning performance based on:
  User Profile: ${e}
  Content Information: ${t}
  Historical Performance: ${r}
  
  Please provide:
  1. Predicted performance score
  2. Predicted completion time
  3. Success probability
  4. Risk factors that may impact performance
  5. Improvement suggestions
  6. Study recommendations
  7. Confidence score for prediction`}executeWithRetry(e,t=3,r=100){return Me(this,null,function*(){const{OptimizedRetryService:i}=yield T(()=>Promise.resolve().then(()=>Ac),void 0);return yield i.executeWithRetry(e,{maxRetries:t,baseDelay:r,backoffStrategy:"linear",retryCondition:n=>n.message.includes("network")||n.message.includes("timeout")||n.message.includes("rate limit")||n.message.includes("temporary")}).then(n=>{if(!n.success)throw n.error;return n.data})})}executeWithTimeout(e,t=3e4){return Me(this,null,function*(){const r=new Promise((i,n)=>{setTimeout(()=>n(new Error("Operation timed out")),t)});return Promise.race([e,r])})}selectModelForTask(e){switch(e){case"recommendation":return"gpt-4";case"skill_gap":return"gpt-4";case"path_optimization":return"gpt-4";case"performance_prediction":return"gpt-4";case"adaptive_difficulty":return"gpt-4";case"engagement_analysis":return"gpt-4";case"retention_prediction":return"gpt-4";case"learning_analytics":return"gpt-4";default:return"gpt-4"}}getProviderConfig(e){const t={openai:{baseUrl:ui.OPENAI_API_BASE_URL||"https://api.openai.com/v1",timeout:3e4,maxRetries:3,model:"gpt-4"},google:{baseUrl:ui.GOOGLE_AI_API_BASE_URL||"https://generativelanguage.googleapis.com/v1",timeout:3e4,maxRetries:3,model:"gemini-pro"},azure:{baseUrl:ui.AZURE_OPENAI_ENDPOINT||"",timeout:3e4,maxRetries:3,model:"gpt-4"},custom:{baseUrl:ui.CUSTOM_AI_ENDPOINT||"",timeout:3e4,maxRetries:3,model:"custom"}};return t[e]||t.openai}}const qu={ai_enabled:!1,ai_version:"1.0.0",personalized_recommendations:!1,skill_gap_analysis:!1,learning_path_optimization:!1,performance_prediction:!1,adaptive_difficulty:!1,learning_analytics_enabled:!1,behavior_tracking:!1,progress_prediction:!1,engagement_metrics:!1,retention_analysis:!1,ai_confidence_threshold:.8,recommendation_limit:5,data_retention_days:365,model_version:"v1.0",data_sharing_enabled:!1,local_ai_processing_enabled:!1,encrypted_data_transmission:!0,ai_model_training:!1},zu={NO_DATA_FOUND:"PGRST116"},Jt={DIFFICULTY_LEVEL:"beginner",USER_ROLE:"user",DEPARTMENT:"general",EXPERIENCE_LEVEL:"entry",LEARNING_STYLE:"visual",TIME_AVAILABILITY:30},Uu={LEARNING_PROGRESS_DATA:100};function Nu(c){var e,t,r,i,n,o,s,a,l,u,h;return{id:(e=c.id)!=null?e:"",user_id:(t=c.user_id)!=null?t:"",role:(r=c.role)!=null?r:Jt.USER_ROLE,department:(i=c.department)!=null?i:Jt.DEPARTMENT,experience_level:(n=c.experience_level)!=null?n:Jt.EXPERIENCE_LEVEL,skill_areas:(o=c.skill_areas)!=null?o:[],learning_goals:(s=c.learning_goals)!=null?s:[],preferred_learning_style:(a=c.preferred_learning_style)!=null?a:Jt.LEARNING_STYLE,time_availability:(l=c.time_availability)!=null?l:Jt.TIME_AVAILABILITY,last_updated:(h=(u=c.updated_at)!=null?u:c.created_at)!=null?h:""}}function ht(c){return Date.now()-c}function Fu(c){return Array.isArray(c)?c.join("; "):c}function Lu(c){return c.split("; ").filter(e=>e.trim().length>0)}function Ye(){return new Date().toISOString()}var xu=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Bu{constructor(e){this.facilityId=e,this.providerService=new tn(e)}generatePersonalizedRecommendations(e){return xu(this,null,function*(){var t,r,i,n,o,s,a,l,u,h,f,m,p;try{const g=Date.now(),y=yield this.providerService.processPersonalizedRecommendationsWithAI(),_=ht(g),w={facility_id:this.facilityId,user_id:e,recommended_content:y.recommended_content,recommendation_reasoning:y.recommendation_reasoning,confidence_scores:y.confidence_scores,learning_path_suggestions:y.learning_path_suggestions,skill_development_areas:y.skill_development_areas,estimated_completion_time:y.estimated_completion_time,difficulty_progression:y.difficulty_progression,alternative_recommendations:y.alternative_recommendations,confidence_score:y.confidence_score,processing_time_ms:_,created_at:Ye()},b={facility_id:w.facility_id,user_id:w.user_id,recommended_content:w.recommended_content,recommendation_reasoning:Fu(w.recommendation_reasoning),confidence_scores:w.confidence_scores,learning_path_suggestions:w.learning_path_suggestions,skill_development_areas:w.skill_development_areas,estimated_completion_time:w.estimated_completion_time,difficulty_progression:w.difficulty_progression,alternative_recommendations:w.alternative_recommendations,confidence_score:w.confidence_score,processing_time_ms:w.processing_time_ms,created_at:w.created_at},{data:E,error:C}=yield d.from("learning_ai_personalized_recommendations").insert(b).select().single();if(C)return console.error("Error saving personalized recommendation result:",C),null;if(!E)return null;const S=E;return{id:(t=S.id)!=null?t:"",facility_id:(r=S.facility_id)!=null?r:"",user_id:(i=S.user_id)!=null?i:"",recommended_content:(n=S.recommended_content)!=null?n:[],recommendation_reasoning:Lu(S.recommendation_reasoning),confidence_scores:(o=S.confidence_scores)!=null?o:[],learning_path_suggestions:(s=S.learning_path_suggestions)!=null?s:[],skill_development_areas:(a=S.skill_development_areas)!=null?a:[],estimated_completion_time:(l=S.estimated_completion_time)!=null?l:0,difficulty_progression:(u=S.difficulty_progression)!=null?u:[],alternative_recommendations:(h=S.alternative_recommendations)!=null?h:[],confidence_score:(f=S.confidence_score)!=null?f:0,processing_time_ms:(m=S.processing_time_ms)!=null?m:0,created_at:(p=S.created_at)!=null?p:""}}catch(g){return console.error("Error generating personalized recommendations:",g),null}})}}var ju=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Vu{constructor(e){this.facilityId=e,this.providerService=new tn(e)}analyzeSkillGaps(e){return ju(this,null,function*(){var t,r,i,n,o,s,a,l,u,h,f,m,p;try{const g=Date.now(),y=yield this.providerService.processSkillGapAnalysisWithAI(),_=ht(g),w={facility_id:this.facilityId,user_id:e,current_skills:y.current_skills,required_skills:y.required_skills,skill_gaps:y.skill_gaps,gap_priorities:y.gap_priorities,learning_recommendations:y.learning_recommendations,skill_development_plan:y.skill_development_plan,estimated_learning_time:y.estimated_learning_time,confidence_score:y.confidence_score,processing_time_ms:_,created_at:Ye()},b={facility_id:w.facility_id,user_id:w.user_id,current_skills:w.current_skills,required_skills:w.required_skills,skill_gaps:w.skill_gaps,gap_priorities:w.gap_priorities,learning_recommendations:w.learning_recommendations,skill_development_plan:w.skill_development_plan,estimated_learning_time:w.estimated_learning_time,confidence_score:w.confidence_score,processing_time_ms:w.processing_time_ms,created_at:w.created_at},{data:E,error:C}=yield d.from("learning_ai_skill_gap_analysis").insert(b).select().single();if(C)return console.error("Error saving skill gap analysis result:",C),null;if(!E)return null;const S=E;return{id:(t=S.id)!=null?t:"",facility_id:(r=S.facility_id)!=null?r:"",user_id:(i=S.user_id)!=null?i:"",current_skills:(n=S.current_skills)!=null?n:{},required_skills:(o=S.required_skills)!=null?o:{},skill_gaps:(s=S.skill_gaps)!=null?s:{},gap_priorities:(a=S.gap_priorities)!=null?a:[],learning_recommendations:(l=S.learning_recommendations)!=null?l:[],skill_development_plan:(u=S.skill_development_plan)!=null?u:[],estimated_learning_time:(h=S.estimated_learning_time)!=null?h:0,confidence_score:(f=S.confidence_score)!=null?f:0,processing_time_ms:(m=S.processing_time_ms)!=null?m:0,created_at:(p=S.created_at)!=null?p:""}}catch(g){return console.error(g),console.error("Error analyzing skill gaps"),null}})}}var Hu=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Gu{constructor(e){this.facilityId=e,this.providerService=new tn(e)}optimizeLearningPath(e){return Hu(this,null,function*(){var t,r,i,n,o,s,a,l,u,h,f,m,p;try{const g=Date.now(),y=yield this.providerService.processLearningPathOptimizationWithAI(),_=ht(g),w={facility_id:this.facilityId,user_id:e,optimized_learning_path:y.optimized_learning_path,path_efficiency_score:y.path_efficiency_score,estimated_total_time:y.estimated_total_time,difficulty_progression:y.difficulty_progression,prerequisite_mapping:y.prerequisite_mapping,alternative_paths:y.alternative_paths,optimization_factors:y.optimization_factors,confidence_score:y.confidence_score,processing_time_ms:_,created_at:Ye()},b={facility_id:w.facility_id,user_id:w.user_id,optimized_learning_path:w.optimized_learning_path,path_efficiency_score:w.path_efficiency_score,estimated_total_time:w.estimated_total_time,difficulty_progression:w.difficulty_progression,prerequisite_mapping:w.prerequisite_mapping,alternative_paths:w.alternative_paths,optimization_factors:w.optimization_factors,confidence_score:w.confidence_score,processing_time_ms:w.processing_time_ms,created_at:w.created_at},{data:E,error:C}=yield d.from("learning_ai_path_optimization").insert(b).select().single();if(C)return console.error("Error saving learning path optimization result:",C),null;if(!E)return null;const S=E;return{id:(t=S.id)!=null?t:"",facility_id:(r=S.facility_id)!=null?r:"",user_id:(i=S.user_id)!=null?i:"",optimized_learning_path:(n=S.optimized_learning_path)!=null?n:[],path_efficiency_score:(o=S.path_efficiency_score)!=null?o:0,estimated_total_time:(s=S.estimated_total_time)!=null?s:0,difficulty_progression:(a=S.difficulty_progression)!=null?a:[],prerequisite_mapping:(l=S.prerequisite_mapping)!=null?l:{},alternative_paths:(u=S.alternative_paths)!=null?u:[],optimization_factors:(h=S.optimization_factors)!=null?h:[],confidence_score:(f=S.confidence_score)!=null?f:0,processing_time_ms:(m=S.processing_time_ms)!=null?m:0,created_at:(p=S.created_at)!=null?p:""}}catch(g){return console.error("Error optimizing learning path:",g),null}})}}var kr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Wu{constructor(e){this.facilityId=e,this.providerService=new tn(e)}predictPerformance(e,t){return kr(this,null,function*(){var r,i,n,o,s,a,l,u,h,f;try{const m=Date.now(),p=yield this.providerService.processPerformancePredictionWithAI(),g=ht(m),y={facility_id:this.facilityId,user_id:e,content_id:t,predicted_performance:p.predicted_performance,predicted_completion_time:p.predicted_completion_time,success_probability:p.success_probability,risk_factors:p.risk_factors,improvement_suggestions:p.improvement_suggestions,study_recommendations:p.study_recommendations,confidence_score:p.confidence_score,processing_time_ms:g,created_at:Ye()},_={facility_id:y.facility_id,user_id:y.user_id,content_id:y.content_id,predicted_performance:y.predicted_performance,confidence_score:y.confidence_score,improvement_suggestions:y.improvement_suggestions,predicted_completion_time:y.predicted_completion_time,processing_time_ms:y.processing_time_ms,created_at:y.created_at},{data:w,error:b}=yield d.from("learning_ai_performance_prediction").insert(_).select().single();if(b)return console.error("Error saving performance prediction result:",b),null;if(!w)return null;const E=w;return{id:(r=E.id)!=null?r:"",facility_id:(i=E.facility_id)!=null?i:"",user_id:(n=E.user_id)!=null?n:"",content_id:(o=E.content_id)!=null?o:"",predicted_performance:(s=E.predicted_performance)!=null?s:0,predicted_completion_time:(a=E.predicted_completion_time)!=null?a:0,success_probability:0,risk_factors:[],improvement_suggestions:(l=E.improvement_suggestions)!=null?l:[],study_recommendations:[],confidence_score:(u=E.confidence_score)!=null?u:0,processing_time_ms:(h=E.processing_time_ms)!=null?h:0,created_at:(f=E.created_at)!=null?f:""}}catch(m){return console.error("Error predicting performance:",m),null}})}adjustDifficulty(e,t){return kr(this,null,function*(){var r,i,n,o,s,a,l;try{const u=Date.now(),h=yield this.providerService.processAdaptiveDifficultyWithAI(),f=ht(u),m={facility_id:this.facilityId,user_id:e,content_id:t,recommended_difficulty:h.recommended_difficulty,difficulty_adjustment:h.difficulty_adjustment,learning_curve_analysis:h.learning_curve_analysis,adaptation_reasoning:h.adaptation_reasoning,performance_indicators:h.performance_indicators,next_difficulty_target:h.next_difficulty_target,confidence_score:h.confidence_score,processing_time_ms:f,created_at:Ye()},p={facility_id:m.facility_id,user_id:m.user_id,content_id:m.content_id,recommended_difficulty:m.recommended_difficulty,difficulty_adjustment:m.difficulty_adjustment,learning_curve_analysis:m.learning_curve_analysis,adaptation_reasoning:m.adaptation_reasoning,performance_indicators:m.performance_indicators,next_difficulty_target:m.next_difficulty_target,confidence_score:m.confidence_score,processing_time_ms:m.processing_time_ms,created_at:m.created_at},{data:g,error:y}=yield d.from("learning_ai_adaptive_difficulty").insert(p).select().single();if(y)return console.error("Error saving adaptive difficulty result:",y),null;if(!g)return null;const _=g;return{recommended_difficulty:(r=_.recommended_difficulty)!=null?r:Jt.DIFFICULTY_LEVEL,difficulty_adjustment:(i=_.difficulty_adjustment)!=null?i:0,learning_curve_analysis:(n=_.learning_curve_analysis)!=null?n:"",adaptation_reasoning:(o=_.adaptation_reasoning)!=null?o:[],performance_indicators:(s=_.performance_indicators)!=null?s:{},next_difficulty_target:(a=_.next_difficulty_target)!=null?a:"",confidence_score:(l=_.confidence_score)!=null?l:0}}catch(u){return console.error("Error adjusting difficulty:",u),null}})}analyzeEngagement(e){return kr(this,null,function*(){var t,r,i,n,o,s,a,l;try{const u=Date.now(),h=yield this.providerService.processEngagementAnalysisWithAI(),f=ht(u),m={facility_id:this.facilityId,user_id:e,engagement_score:h.engagement_score,engagement_trends:h.engagement_trends,engagement_factors:h.engagement_factors,disengagement_triggers:h.disengagement_triggers,improvement_suggestions:h.improvement_suggestions,optimal_learning_times:h.optimal_learning_times,content_preferences:h.content_preferences,confidence_score:h.confidence_score,processing_time_ms:f,created_at:Ye()},p={facility_id:m.facility_id,user_id:m.user_id,engagement_score:m.engagement_score,engagement_trends:m.engagement_trends,engagement_factors:m.engagement_factors,disengagement_triggers:m.disengagement_triggers,improvement_suggestions:m.improvement_suggestions,optimal_learning_times:m.optimal_learning_times,content_preferences:m.content_preferences,confidence_score:m.confidence_score,processing_time_ms:m.processing_time_ms,created_at:m.created_at},{data:g,error:y}=yield d.from("learning_ai_engagement_analysis").insert(p).select().single();if(y)return console.error("Error saving engagement analysis result:",y),null;if(!g)return null;const _=g;return{engagement_score:(t=_.engagement_score)!=null?t:0,engagement_trends:(r=_.engagement_trends)!=null?r:{},engagement_factors:(i=_.engagement_factors)!=null?i:[],disengagement_triggers:(n=_.disengagement_triggers)!=null?n:[],improvement_suggestions:(o=_.improvement_suggestions)!=null?o:[],optimal_learning_times:(s=_.optimal_learning_times)!=null?s:[],content_preferences:(a=_.content_preferences)!=null?a:[],confidence_score:(l=_.confidence_score)!=null?l:0}}catch(u){return console.error("Error analyzing engagement:",u),null}})}predictRetention(e){return kr(this,null,function*(){var t,r,i,n,o,s,a;try{const l=Date.now(),u=yield this.providerService.processRetentionPredictionWithAI(),h=ht(l),f={facility_id:this.facilityId,user_id:e,retention_probability:u.retention_probability,knowledge_decay_rate:u.knowledge_decay_rate,review_recommendations:u.review_recommendations,reinforcement_schedule:u.reinforcement_schedule,retention_factors:u.retention_factors,forgetting_risk_areas:u.forgetting_risk_areas,confidence_score:u.confidence_score,processing_time_ms:h,created_at:Ye()},m={facility_id:f.facility_id,user_id:f.user_id,retention_probability:f.retention_probability,knowledge_decay_rate:f.knowledge_decay_rate,review_recommendations:f.review_recommendations,reinforcement_schedule:f.reinforcement_schedule,retention_factors:f.retention_factors,forgetting_risk_areas:f.forgetting_risk_areas,confidence_score:f.confidence_score,processing_time_ms:f.processing_time_ms,created_at:f.created_at},{data:p,error:g}=yield d.from("learning_ai_retention_prediction").insert(m).select().single();if(g)return console.error("Error saving retention prediction result:",g),null;if(!p)return null;const y=p;return{retention_probability:(t=y.retention_probability)!=null?t:0,knowledge_decay_rate:(r=y.knowledge_decay_rate)!=null?r:0,review_recommendations:(i=y.review_recommendations)!=null?i:[],reinforcement_schedule:(n=y.reinforcement_schedule)!=null?n:[],retention_factors:(o=y.retention_factors)!=null?o:[],forgetting_risk_areas:(s=y.forgetting_risk_areas)!=null?s:[],confidence_score:(a=y.confidence_score)!=null?a:0}}catch(l){return console.error("Error predicting retention:",l),null}})}generateLearningAnalytics(e){return kr(this,null,function*(){var t,r,i,n,o,s,a,l,u;try{const h=Date.now(),f=yield this.providerService.processLearningAnalyticsWithAI(),m=ht(h),p={facility_id:this.facilityId,user_id:e,learning_efficiency_score:f.learning_efficiency_score,preferred_content_categories:f.preferred_content_categories,optimal_study_duration:f.optimal_study_duration,learning_patterns:f.learning_patterns,progress_trends:f.progress_trends,performance_metrics:f.performance_metrics,insights:f.insights,recommendations:f.recommendations,confidence_score:f.confidence_score,processing_time_ms:m,created_at:Ye()},g={facility_id:p.facility_id,user_id:p.user_id,learning_efficiency_score:p.learning_efficiency_score,preferred_content_categories:p.preferred_content_categories,optimal_study_duration:p.optimal_study_duration,learning_patterns:p.learning_patterns,progress_trends:p.progress_trends,performance_metrics:p.performance_metrics,insights:p.insights,recommendations:p.recommendations,confidence_score:p.confidence_score,processing_time_ms:p.processing_time_ms,created_at:p.created_at},{data:y,error:_}=yield d.from("learning_ai_analytics").insert(g).select().single();if(_)return console.error("Error saving learning analytics result:",_),null;if(!y)return null;const w=y;return{learning_efficiency_score:(t=w.learning_efficiency_score)!=null?t:0,preferred_content_categories:(r=w.preferred_content_categories)!=null?r:[],optimal_study_duration:(i=w.optimal_study_duration)!=null?i:0,learning_patterns:(n=w.learning_patterns)!=null?n:{},progress_trends:(o=w.progress_trends)!=null?o:{},performance_metrics:(s=w.performance_metrics)!=null?s:{},insights:(a=w.insights)!=null?a:[],recommendations:(l=w.recommendations)!=null?l:[],confidence_score:(u=w.confidence_score)!=null?u:0}}catch(h){return console.error("Error generating learning analytics:",h),null}})}}var Ku=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Jn(c){return Ku(this,arguments,function*({facilityId:e,userId:t,module:r,action:i,details:n}){try{const{error:o}=yield d.from("security_audit_log").insert([{facility_id:e,user_id:t,object_schema:"public",object_table:"ai_settings",action:i,event_context:{module:r,details:n,source:"frontend"},happened_at:new Date().toISOString()}]);o?console.error("❌ Audit log insert failed:",o):console.log("✅ Audit event logged:",r,i)}catch(o){console.error("❌ Unexpected audit log failure:",o)}})}var rn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Qu(c){return rn(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings").select("*").eq("facility_id",c).eq("module","learning").single();return t?(t.code===zu.NO_DATA_FOUND||console.warn("Error loading learning AI settings:",t),null):e?e.settings:null}catch(e){return console.warn("Error loading learning AI settings:",e),null}})}function Yu(c,e){return rn(this,null,function*(){try{const{data:{user:t}}=yield d.auth.getUser(),r=(t==null?void 0:t.id)||"unknown-user",i={facility_id:c,module:"learning",settings:e,updated_at:Ye()},{error:n}=yield d.from("ai_settings").upsert(i,{onConflict:"facility_id,module"});return n?(console.error("Error saving learning AI settings:",n),!1):(!n&&i&&(yield Jn({facilityId:c,userId:r,module:"learning",action:"UPDATE",details:i})),!0)}catch(t){return console.error(t),console.error("Error saving learning AI settings"),!1}})}function Ju(c,e){return rn(this,null,function*(){try{const{data:t,error:r}=yield d.from("learning_progress").select("*").eq("facility_id",c).eq("user_id",e).order("created_at",{ascending:!1}).limit(Uu.LEARNING_PROGRESS_DATA);return r?(console.error("Error getting learning progress data:",r),[]):t||[]}catch(t){return console.error("Error getting learning progress data:",t),[]}})}function Xu(c,e){return rn(this,null,function*(){try{const{data:t,error:r}=yield d.from("user_profiles").select("*").eq("user_id",e).eq("facility_id",c).single();return r?(console.error("Error getting user profile:",r),null):t?Nu(t):null}catch(t){return console.error("Error getting user profile:",t),null}})}function et(c,e){return Zu(c,e)===!0}function Zu(c,e){return e.split(".").reduce((t,r)=>t==null?void 0:t[r],c)}var ne=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class lc{constructor(e){this.facilityId=e,this.analyticsService=new Mu(e),this.recommendationService=new Bu(e),this.knowledgeGapService=new Vu(e),this.pathwayAnalysisService=new Gu(e),this.evaluationService=new Wu(e)}initialize(){return ne(this,null,function*(){try{return(yield this.loadSettings())!==null}catch(e){return console.error(e),console.error("Failed to initialize LearningAIService"),!1}})}loadSettings(){return ne(this,null,function*(){return yield Qu(this.facilityId)})}saveSettings(e){return ne(this,null,function*(){return yield Yu(this.facilityId,e)})}initializeSettings(){return ne(this,null,function*(){try{const e=qu;return yield this.saveSettings(e)}catch(e){return console.error(e),console.error("Error initializing learning AI settings"),!1}})}generatePersonalizedRecommendations(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!et(t,"personalized_recommendations"))throw new Error("Personalized recommendations AI is not enabled");return yield this.recommendationService.generatePersonalizedRecommendations(e)}catch(t){return console.error("Error generating personalized recommendations:",t),null}})}analyzeSkillGaps(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!et(t,"skill_gap_analysis"))throw new Error("Skill gap analysis AI is not enabled");return yield this.knowledgeGapService.analyzeSkillGaps(e)}catch(t){return console.error(t),console.error("Error analyzing skill gaps"),null}})}optimizeLearningPath(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!et(t,"learning_path_optimization"))throw new Error("Learning path optimization AI is not enabled");return yield this.pathwayAnalysisService.optimizeLearningPath(e)}catch(t){return console.error("Error optimizing learning path:",t),null}})}predictPerformance(e,t){return ne(this,null,function*(){try{const r=yield this.loadSettings();if(!et(r,"performance_prediction"))throw new Error("Performance prediction AI is not enabled");return yield this.evaluationService.predictPerformance(e,t)}catch(r){return console.error("Error predicting performance:",r),null}})}adjustDifficulty(e,t){return ne(this,null,function*(){try{const r=yield this.loadSettings();if(!et(r,"adaptive_difficulty"))throw new Error("Adaptive difficulty AI is not enabled");return yield this.evaluationService.adjustDifficulty(e,t)}catch(r){return console.error("Error adjusting difficulty:",r),null}})}analyzeEngagement(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!et(t,"engagement_metrics"))throw new Error("Engagement analysis AI is not enabled");return yield this.evaluationService.analyzeEngagement(e)}catch(t){return console.error("Error analyzing engagement:",t),null}})}predictRetention(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!et(t,"retention_analysis"))throw new Error("Retention prediction AI is not enabled");return yield this.evaluationService.predictRetention(e)}catch(t){return console.error("Error predicting retention:",t),null}})}generateLearningAnalytics(e){return ne(this,null,function*(){try{const t=yield this.loadSettings();if(!et(t,"learning_analytics_enabled"))throw new Error("Learning analytics AI is not enabled");return yield this.evaluationService.generateLearningAnalytics(e)}catch(t){return console.error("Error generating learning analytics:",t),null}})}getLearningInsights(){return ne(this,null,function*(){return this.analyticsService.getLearningInsights()})}getLearningProgressData(e){return ne(this,null,function*(){return yield Ju(this.facilityId,e)})}getUserProfile(e){return ne(this,null,function*(){return yield Xu(this.facilityId,e)})}}var gn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Xn{constructor(e){this.facilityId=e}getInventoryInsights(){return gn(this,null,function*(){try{const e=[],{data:t}=yield d.from("inventory_ai_barcode_analysis").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);t&&t.forEach(i=>{e.push({type:"barcode_analysis",title:"Barcode Quality Assessment",description:`Barcode ${i.barcode_value} analyzed with ${(i.confidence_score*100).toFixed(1)}% confidence`,confidence:i.confidence_score||0,recommendations:i.recommendations||[],data:i,timestamp:i.created_at,priority:i.confidence_score<.7?"critical":i.confidence_score<.85?"high":"medium",id:i.id||`barcode-${Date.now()}`,actionable:!0})});const{data:r}=yield d.from("inventory_ai_demand_forecasting").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(5);return r&&r.forEach(i=>{e.push({type:"demand_forecast",title:"Demand Forecast",description:`${i.forecast_period} forecast: ${i.predicted_demand} units predicted`,confidence:i.confidence_score||0,recommendations:i.recommendations||[],data:i,timestamp:i.created_at,priority:i.confidence_score<.7?"critical":i.confidence_score<.85?"high":"medium",id:i.id||`forecast-${Date.now()}`,actionable:!0})}),e}catch(e){return console.error("Error getting inventory insights:",e),[]}})}getHistoricalInventoryData(){return gn(this,null,function*(){return Array.from({length:30},(e,t)=>({date:new Date(Date.now()-t*24*60*60*1e3).toISOString(),quantity:Math.floor(Math.random()*20)+10,transaction_type:"usage"}))})}getInventoryCostData(){return gn(this,null,function*(){return{purchasing_costs:8e3,storage_costs:4e3,transportation_costs:3e3,total_cost:15e3}})}detectBarcodeType(e){return e?e.length===13?"ean13":e.length===12?"upc":e.length===8?"ean8":"code128":"unknown"}assessBarcodeQuality(e){return e>=.9?"excellent":e>=.8?"good":e>=.7?"fair":"poor"}calculateInventoryTurns(e,t){return t===0?0:e/t}calculateStockoutRisk(e,t,r,i){const n=(e-i)/t;return n<=0?1:n<=r?.8:n<=r*1.5?.5:.2}calculateSafetyStock(e,t,r){const i=this.getZScore(r);return Math.ceil(e*t*i*.1)}calculateReorderPoint(e,t,r){return Math.ceil(e*t+r)}getZScore(e){return{.8:.84,.85:1.04,.9:1.28,.95:1.65,.99:2.33}[e]||1.28}}var Fa=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class ed{constructor(e){this.facilityId=e}processImageWithAI(){return Fa(this,null,function*(){return{confidence:.85,damage_detected:!1,damage_types:[],objects:["Surgical Scissors","Forceps"],confidence_scores:[.92,.88],classification:"medical_instruments",category:"surgical_tools",quality:"Good",condition:"Excellent",damage_description:null,recommendations:["Items appear to be in good condition","No visible damage detected"]}})}analyzeBarcodeWithAI(e){return Fa(this,null,function*(){return{confidence:.95,damage_detected:!1,damage_types:[],objects:["Barcode Item"],confidence_scores:[.95],classification:"barcode_item",category:"scannable_item",quality:"Excellent",condition:"Good",damage_description:null,recommendations:["Barcode successfully read"]}})}}var yn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class td{constructor(e){this.facilityId=e}generateDemandForecastWithAI(){return yn(this,null,function*(){return[{predicted_demand:150,confidence_interval_lower:120,confidence_interval_upper:180,seasonal_factors:{winter:1.2,summer:.8},trend_analysis:"increasing",influencing_factors:["seasonal demand","market trends"],confidence_score:.85,accuracy_metrics:{mape:.13,rmse:12.5},recommendations:["Increase stock levels by 20%","Monitor demand closely"]},{predicted_demand:75,confidence_interval_lower:65,confidence_interval_upper:85,seasonal_factors:{winter:1,summer:1},trend_analysis:"stable",influencing_factors:["consistent demand","stable market"],confidence_score:.9,accuracy_metrics:{mape:.08,rmse:6.2},recommendations:["Maintain current stock levels","Focus on cost optimization"]}]})}generateStockoutRiskAnalysis(){return yn(this,null,function*(){return{highRiskItems:["item_001","item_003"],mediumRiskItems:["item_002"],lowRiskItems:["item_004","item_005"],overallRiskScore:.65}})}generateMaintenancePredictions(){return yn(this,null,function*(){return{urgentMaintenance:["equipment_001"],scheduledMaintenance:["equipment_002","equipment_003"],preventiveMaintenance:["equipment_004","equipment_005"]}})}}var _n=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class rd{constructor(e){this.facilityId=e}generateCostOptimizationWithAI(){return _n(this,null,function*(){return{current_cost:1e5,optimized_cost:85e3,cost_savings:15e3,savings_percentage:15,optimization_factors:{supplier_consolidation:.4,inventory_turnover:.3,storage_efficiency:.3},recommended_actions:["Consolidate suppliers for bulk discounts","Implement just-in-time inventory","Optimize storage layout"],implementation_timeline:"6 months",risk_assessment:"low",confidence_score:.88,roi_estimate:300}})}generateSmartCategorizationWithAI(){return _n(this,null,function*(){return{suggested_category:"Surgical Instruments",suggested_subcategory:"Cutting Tools",category_confidence_score:.92,alternative_categories:["Medical Tools","Surgical Equipment"],categorization_reasoning:["Items are sharp cutting instruments","Commonly used in surgical procedures","Similar material composition"],form_fill_suggestions:{category:"Surgical Instruments",subcategory:"Cutting Tools",material:"Stainless Steel"},workflow_recommendations:["Store in sterile environment","Regular sharpening required","Handle with care"],confidence_score:.92}})}generateInventoryOptimizationRecommendations(){return _n(this,null,function*(){return{reorderPoints:{item_001:50,item_002:25,item_003:75},safetyStock:{item_001:20,item_002:10,item_003:30},maxStockLevels:{item_001:200,item_002:100,item_003:300}}})}}var Be=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Zn{constructor(e){this.facilityId=e,this.imageProcessingService=new ed(e),this.forecastingService=new td(e),this.optimizationService=new rd(e)}processImageWithAI(){return Be(this,null,function*(){return yield this.imageProcessingService.processImageWithAI()})}analyzeBarcodeWithAI(e){return Be(this,null,function*(){return yield this.imageProcessingService.analyzeBarcodeWithAI(e)})}generateDemandForecastWithAI(){return Be(this,null,function*(){return yield this.forecastingService.generateDemandForecastWithAI()})}generateStockoutRiskAnalysis(){return Be(this,null,function*(){return yield this.forecastingService.generateStockoutRiskAnalysis()})}generateMaintenancePredictions(){return Be(this,null,function*(){return yield this.forecastingService.generateMaintenancePredictions()})}generateCostOptimizationWithAI(){return Be(this,null,function*(){return yield this.optimizationService.generateCostOptimizationWithAI()})}generateSmartCategorizationWithAI(){return Be(this,null,function*(){return yield this.optimizationService.generateSmartCategorizationWithAI()})}generateInventoryOptimizationRecommendations(){return Be(this,null,function*(){return yield this.optimizationService.generateInventoryOptimizationRecommendations()})}getComprehensiveAIInsights(){return Be(this,null,function*(){const e=yield this.generateDemandForecastWithAI(),t=yield this.generateStockoutRiskAnalysis(),r=yield this.generateMaintenancePredictions();return{demandForecast:e,stockoutRisk:t,maintenancePredictions:r,costTrends:{trend:"decreasing",percentageChange:-5.2,confidence:.85},seasonalPatterns:{patterns:["Q4 peak","Summer dip"],confidence:.78}}})}}const vn=.85,id=2160*60*60*1e3,di=365*24*60*60*1e3,nd="30_days",ad=10,od=5,sd="maintenance-1",cd=[{month:"Jan",cost:1e3,trend:"stable"},{month:"Feb",cost:1200,trend:"increasing"}],uc="Uncategorized",ea="Unknown",ld="Unknown Equipment",Pr={csv:"text/csv",excel:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",pdf:"application/pdf",json:"application/json",default:"text/plain"},ud="good",dd="good",hd=["Increase inventory levels for low stock items.","Review maintenance schedules."],fd="low";var La=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class md{constructor(e){this.facilityId=e,this.providerService=new Zn(e)}generateCostOptimization(e){return La(this,null,function*(){try{const t=Date.now(),r=yield this.providerService.generateCostOptimizationWithAI(),i=Date.now()-t,n={facility_id:this.facilityId,optimization_type:e,current_cost:r.current_cost,optimized_cost:r.optimized_cost,cost_savings:r.cost_savings,savings_percentage:r.savings_percentage,optimization_factors:r.optimization_factors,recommended_actions:r.recommended_actions,implementation_timeline:r.implementation_timeline,risk_assessment:r.risk_assessment,confidence_score:r.confidence_score,processing_time_ms:i,data_analysis_period:nd,roi_estimate:r.roi_estimate},{data:o,error:s}=yield d.from("inventory_ai_cost_optimization").insert(n).select().single();return s?(console.error("Error saving cost optimization:",s),null):o}catch(t){return console.error("Error generating cost optimization:",t),null}})}categorizeItem(e,t){return La(this,null,function*(){try{const r=Date.now(),i=yield this.providerService.generateSmartCategorizationWithAI(),n=Date.now()-r,o={facility_id:this.facilityId,suggested_category:i.suggested_category,suggested_subcategory:i.suggested_subcategory,category_confidence_score:i.category_confidence_score,alternative_categories:i.alternative_categories,categorization_reasoning:i.categorization_reasoning,form_fill_suggestions:i.form_fill_suggestions,workflow_recommendations:i.workflow_recommendations,confidence_score:i.confidence_score,processing_time_ms:n,input_data_type:t,learning_feedback:!1,user_acceptance:void 0},{data:s,error:a}=yield d.from("inventory_ai_smart_categorization").insert(o).select().single();return a?(console.error("Error saving smart categorization:",a),null):s}catch(r){return console.error("Error categorizing item:",r),null}})}}var xa=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class pd{constructor(e){this.facilityId=e,this.analyticsService=new Xn(e),this.providerService=new Zn(e)}analyzeBarcode(e,t){return xa(this,null,function*(){try{const r=Date.now(),i=yield this.providerService.processImageWithAI(),n=Date.now()-r,o={facility_id:this.facilityId,barcode_value:t,barcode_type:this.analyticsService.detectBarcodeType(t),quality_rating:this.analyticsService.assessBarcodeQuality(i.confidence),readability_score:i.confidence||vn,damage_detected:i.damage_detected||!1,damage_types:i.damage_types||[],confidence_score:i.confidence||vn,processing_time_ms:n,image_file_path:"placeholder_path",ai_insights:i,recommendations:i.recommendations||[]},{data:s,error:a}=yield d.from("inventory_ai_barcode_analysis").insert(o).select().single();return a?(console.error("Error saving barcode analysis:",a),null):s}catch(r){return console.error("Error analyzing barcode:",r),null}})}analyzeImage(e){return xa(this,null,function*(){try{const t=Date.now(),r=yield this.providerService.processImageWithAI(),i=Date.now()-t,n={facility_id:this.facilityId,recognized_objects:r.objects||[],object_confidence_scores:r.confidence_scores||[],item_classification:r.classification,category_suggestion:r.category,quality_assessment:r.quality||ud,damage_detected:r.damage_detected||!1,damage_description:r.damage_description||void 0,condition_rating:r.condition||dd,confidence_score:r.confidence||vn,processing_time_ms:i,image_file_path:"placeholder_path",ai_insights:r,recommendations:r.recommendations||[]},{data:o,error:s}=yield d.from("inventory_ai_image_recognition").insert(n).select().single();return s?(console.error("Error saving image recognition:",s),null):o}catch(t){return console.error("Error analyzing image:",t),null}})}}function gd(c){return c.reduce((e,t)=>{const r=t.category||uc;return e[r]||(e[r]=0),e[r]=e[r]+1,e},{})}function yd(c){return c.reduce((e,t)=>{const r=t.category||uc;return e[r]=(e[r]||0)+(t.amount||0),e},{})}function _d(c){return c.reduce((e,t)=>{const r=t.type||ea;return e[r]=(e[r]||0)+1,e},{})}function vd(c){return c.filter(e=>{var t;return(e.quantity||0)<(((t=e.data)==null?void 0:t.min_quantity)||0)}).map(e=>{var t;return{id:e.id||"",name:e.name||"",current_stock:e.quantity||0,reorder_point:((t=e.data)==null?void 0:t.min_quantity)||0}})}function wd(c){return c.sort((e,t)=>(t.value||0)-(e.value||0)).slice(0,ad).map(e=>({id:e.id||"",name:e.name||"",value:e.value||0,category:e.category||ea}))}function Id(c){return c.slice(0,od).map(e=>({id:sd,equipment_name:e.equipment_name||ld,due_date:e.due_date||new Date().toISOString(),type:e.type||ea}))}function Sd(c){return c.reduce((e,t)=>e+(t.amount||0),0)}function bd(){return cd}function Ed(c){return{totalValue:c.totalItems,riskLevel:fd,recommendations:hd}}function Ad(c){if(Array.isArray(c)){const e=Object.keys(c[0]||{}),t=[e.join(",")];for(const r of c){const i=e.map(n=>JSON.stringify(r[n]||""));t.push(i.join(","))}return t.join(`
`)}return JSON.stringify(c)}function Td(c){switch(c){case"csv":return Pr.csv;case"excel":return Pr.excel;case"pdf":return Pr.pdf;case"json":return Pr.json;default:return Pr.default}}var wt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class kd{constructor(e){this.facilityId=e}exportAnalyticsReport(e,t,r){return wt(this,null,function*(){try{const i=Date.now();let n={};switch(e){case"inventory":n=yield this.generateInventoryReport();break;case"predictive":n={};break;case"cost":n=yield this.generateCostReport();break;case"maintenance":n=yield this.generateMaintenanceReport();break;case"comprehensive":n=yield this.generateComprehensiveReport();break}const o=yield this.formatReportData(n,t),{error:s}=yield d.from("inventory_ai_exports").insert({facility_id:this.facilityId,report_type:e,export_format:t,date_range:r,processing_time_ms:Date.now()-i,exported_at:new Date().toISOString()});return s&&console.error("Error saving export record:",s),{success:!0,data:o,downloadUrl:yield this.generateDownloadUrl(o,t)}}catch(i){return console.error("Error exporting analytics report:",i),{success:!1,error:i instanceof Error?i.message:"Export failed"}}})}generateInventoryReport(){return wt(this,null,function*(){const{data:e,error:t}=yield d.from("inventory_items").select("*").eq("facility_id",this.facilityId),r=e.filter(i=>i.facility_id===this.facilityId);return{totalItems:(r==null?void 0:r.length)||0,categories:gd(r||[]),lowStockItems:vd(r||[]),highValueItems:wd(r||[])}})}generateCostReport(){return wt(this,null,function*(){const{data:e,error:t}=yield d.from("inventory_costs").select("*").eq("facility_id",this.facilityId);return t?(console.error("Error getting inventory costs for cost report:",t),{totalCosts:0,costByCategory:{},costTrends:[]}):{totalCosts:Sd(e||[]),costByCategory:yd(e||[]),costTrends:bd()}})}generateMaintenanceReport(){return wt(this,null,function*(){const{data:e,error:t}=yield d.from("equipment_maintenance").select("*").eq("facility_id",this.facilityId);return t?(console.error("Error getting equipment maintenance for maintenance report:",t),{totalMaintenance:0,maintenanceByType:{},upcomingMaintenance:[]}):{totalMaintenance:(e==null?void 0:e.length)||0,maintenanceByType:_d(e||[]),upcomingMaintenance:Id(e||[])}})}generateComprehensiveReport(){return wt(this,null,function*(){const[e,t,r]=yield Promise.all([this.generateInventoryReport(),this.generateCostReport(),this.generateMaintenanceReport()]);return{inventory:e,predictive:{},cost:t,maintenance:r,summary:Ed(e)}})}formatReportData(e,t){return wt(this,null,function*(){switch(t){case"json":return JSON.stringify(e,null,2);case"csv":return Ad(e);case"excel":return e;case"pdf":return e;default:return e}})}generateDownloadUrl(e,t){return wt(this,null,function*(){const r=new Blob([JSON.stringify(e)],{type:Td(t)});return URL.createObjectURL(r)})}}var wn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Pd{constructor(e){this.facilityId=e}generateDemandForecast(e,t,r){return wn(this,null,function*(){try{const i=Date.now(),n=r||(yield this.getHistoricalInventoryData()),o=yield this.generateForecastWithAI(n,t),s=Date.now()-i;return{inventory_item_id:e,forecast_period:t,forecast_date:new Date().toISOString(),predicted_demand:o.predicted_demand,confidence_interval_lower:o.confidence_interval_lower,confidence_interval_upper:o.confidence_interval_upper,seasonal_factors:o.seasonal_factors,trend_analysis:o.trend_analysis,influencing_factors:o.influencing_factors,confidence_score:this.calculateConfidence(n,o),model_id:"default",processing_time_ms:s,facility_id:this.facilityId}}catch(i){throw console.error("Error generating demand forecast:",i),new Error(`Failed to generate forecast: ${i instanceof Error?i.message:"Unknown error"}`)}})}getHistoricalInventoryData(){return wn(this,null,function*(){return[]})}generateForecastWithAI(e,t){return wn(this,null,function*(){return{predicted_demand:0,confidence_interval_lower:0,confidence_interval_upper:0,seasonal_factors:{},trend_analysis:"stable",influencing_factors:[],confidence_score:.8,accuracy_metrics:{},recommendations:[]}})}calculateConfidence(e,t){return Math.min(.95,Math.max(.1,t.confidence_score||.8))}}var Ba=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Cd{constructor(e){this.facilityId=e}analyzeForecastAccuracy(e,t){return Ba(this,null,function*(){try{const r=this.calculateOverallAccuracy(e,t),i=this.identifyTrends(e),n=this.generateRecommendations(e,t);return{accuracy:r,trends:i,recommendations:n}}catch(r){throw console.error("Error analyzing forecast accuracy:",r),new Error(`Failed to analyze accuracy: ${r instanceof Error?r.message:"Unknown error"}`)}})}generateForecastReport(e){return Ba(this,null,function*(){try{const t=this.generateSummary(e),r=this.extractKeyInsights(e),i=this.identifyRiskFactors(e);return{summary:t,keyInsights:r,riskFactors:i}}catch(t){throw console.error("Error generating forecast report:",t),new Error(`Failed to generate report: ${t instanceof Error?t.message:"Unknown error"}`)}})}calculateOverallAccuracy(e,t){return .85}identifyTrends(e){return["Increasing demand","Seasonal patterns"]}generateRecommendations(e,t){return["Increase stock for high-demand items","Optimize ordering schedule"]}generateSummary(e){return"Generated forecasts with average confidence"}extractKeyInsights(e){return["High confidence in short-term forecasts","Seasonal patterns detected"]}identifyRiskFactors(e){return["Low historical data","High variability in demand"]}}var Cr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Dd{constructor(e){this.facilityId=e,this.coreService=new Pd(e),this.analyticsService=new Cd(e)}generateDemandForecast(e,t,r){return Cr(this,null,function*(){return yield this.coreService.generateDemandForecast(e,t,r)})}analyzeForecastAccuracy(e,t){return Cr(this,null,function*(){return yield this.analyticsService.analyzeForecastAccuracy(e,t)})}generateForecastReport(e){return Cr(this,null,function*(){return yield this.analyticsService.generateForecastReport(e)})}generateBatchForecasts(e,t){return Cr(this,null,function*(){const r=[];for(const i of e)try{const n=yield this.generateDemandForecast(i,t);r.push(n)}catch(n){console.error(`Error generating forecast for item ${i}:`,n)}return r})}getForecastingInsights(){return Cr(this,null,function*(){return{totalForecasts:0,averageAccuracy:.85,topTrends:["Seasonal patterns","Demand variability"]}})}}var ja=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Od{constructor(e){this.facilityId=e,this.analyticsService=new Xn(e),this.forecastingService=new Dd(e),this.providerService=new Zn(e)}generateDemandForecast(e,t){return ja(this,null,function*(){try{const r=yield this.analyticsService.getHistoricalInventoryData(),i=yield this.forecastingService.generateDemandForecast(e,t,r),{data:n,error:o}=yield d.from("inventory_ai_demand_forecasting").insert(i).select().single();return o?(console.error("Error saving demand forecast:",o),null):n}catch(r){return console.error("Error generating demand forecast:",r),null}})}getPredictiveAnalytics(){return ja(this,null,function*(){try{const e=Date.now(),{data:t,error:r}=yield d.from("inventory_transactions").select("*").eq("facility_id",this.facilityId).gte("created_at",new Date(Date.now()-di).toISOString());if(r)return console.error("Error getting inventory transactions:",r),{demandForecast:[],stockoutRisk:[],maintenancePredictions:[],costTrends:[],seasonalPatterns:[]};const i=new Date(Date.now()-id);(t||[]).filter(y=>y.created_at&&new Date(y.created_at)>=i).sort((y,_)=>new Date(_.created_at||"").getTime()-new Date(y.created_at||"").getTime());const{data:o,error:s}=yield d.from("equipment_maintenance").select("*").eq("facility_id",this.facilityId).gte("created_at",new Date(Date.now()-di).toISOString());if(s)return console.error("Error getting equipment maintenance:",s),{demandForecast:[],stockoutRisk:[],maintenancePredictions:[],costTrends:[],seasonalPatterns:[]};const a=new Date(Date.now()-di);(o||[]).filter(y=>y.created_at&&new Date(y.created_at)>=a).sort((y,_)=>new Date(_.created_at||"").getTime()-new Date(y.created_at||"").getTime());const{data:u,error:h}=yield d.from("inventory_costs").select("*").eq("facility_id",this.facilityId).gte("created_at",new Date(Date.now()-di).toISOString());if(h)return console.error("Error getting inventory costs:",h),{demandForecast:[],stockoutRisk:[],maintenancePredictions:[],costTrends:[],seasonalPatterns:[]};(u||[]).filter(y=>y.created_at&&new Date(y.created_at)>=a).sort((y,_)=>new Date(_.created_at||"").getTime()-new Date(y.created_at||"").getTime());const m=yield this.providerService.generateDemandForecastWithAI(),p=Date.now()-e,{error:g}=yield d.from("inventory_ai_predictive_analytics").insert({facility_id:this.facilityId,predictions_data:m,processing_time_ms:p,generated_at:new Date().toISOString()});return g&&console.error("Error saving predictive analytics:",g),{demandForecast:m.map(y=>({itemId:"unknown",itemName:"Unknown Item",predictedDemand:y.predicted_demand||0,confidence:y.confidence_score||.8,timeframe:"30 days",factors:y.influencing_factors||[]})),stockoutRisk:[],maintenancePredictions:[],costTrends:[],seasonalPatterns:[]}}catch(e){throw console.error("Error generating predictive analytics:",e),e}})}}var In=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Rd={low_stock_threshold:10,prediction_accuracy_threshold:.85,ai_model_version:"1.0.0"};class $d{constructor(e){this.facilityId=e}loadSettings(){return In(this,null,function*(){try{const{data:e,error:t}=yield d.from("inventory_items").select("facility_id").eq("facility_id",this.facilityId).limit(1);return t?(console.error("Error loading AI settings:",t),null):{id:"default",facility_id:this.facilityId,ai_enabled:!0,ai_version:"1.0.0",computer_vision_enabled:!0,barcode_scanning_enabled:!0,image_recognition_enabled:!0,quality_assessment_enabled:!0,damage_detection_enabled:!0,inventory_counting_enabled:!0,predictive_analytics_enabled:!0,demand_forecasting_enabled:!0,maintenance_prediction_enabled:!0,cost_optimization_enabled:!0,seasonal_analysis_enabled:!0,cycle_optimization_enabled:!0,smart_categorization_enabled:!0,auto_classification_enabled:!0,smart_form_filling_enabled:!0,intelligent_workflow_enabled:!0,quality_assurance_enabled:!0,compliance_monitoring_enabled:!0,audit_trail_enhancement_enabled:!0,risk_assessment_enabled:!0,scanner_intelligence_enabled:!0,multi_format_barcode_support:!0,smart_validation_enabled:!0,error_prevention_enabled:!0,real_time_monitoring_enabled:!0,anomaly_detection_enabled:!0,ai_confidence_threshold:.85,ai_data_retention_days:30,ai_model_training:!1,predictive_maintenance_enabled:!0,smart_notifications_enabled:!0,real_time_processing_enabled:!0,data_sharing_enabled:!1,local_ai_processing_enabled:!0,encrypted_data_transmission:!0,auto_optimization_enabled:!0,performance_monitoring:!0,resource_optimization:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}catch(e){return console.error("Error loading AI settings:",e),null}})}saveSettings(e){return In(this,null,function*(){try{return console.log("Saving AI settings:",e),!0}catch(t){return console.error("Error saving AI settings:",t),!1}})}initializeSettings(){return In(this,null,function*(){try{const e=Rd;return yield this.saveSettings(e)}catch(e){return console.error("Error initializing AI settings:",e),!1}})}}var Ce=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class dc{constructor(e){this.facilityId=e,this.analyticsService=new Xn(e),this.forecastingService=new Od(e),this.optimizationService=new md(e),this.riskAnalysisService=new pd(e),this.costAnalyticsService=new kd(e),this.supabaseProvider=new $d(e)}getInventoryInsights(){return Ce(this,null,function*(){return this.analyticsService.getInventoryInsights()})}loadSettings(){return Ce(this,null,function*(){return yield this.supabaseProvider.loadSettings()})}saveSettings(e){return Ce(this,null,function*(){return yield this.supabaseProvider.saveSettings(e)})}initializeSettings(){return Ce(this,null,function*(){return yield this.supabaseProvider.initializeSettings()})}analyzeBarcode(e,t){return Ce(this,null,function*(){try{const r=yield this.loadSettings();if(!(r!=null&&r.barcode_scanning_enabled))throw new Error("Barcode scanning AI is not enabled");return yield this.riskAnalysisService.analyzeBarcode(e,t)}catch(r){return console.error("Error analyzing barcode:",r),null}})}analyzeImage(e){return Ce(this,null,function*(){try{const t=yield this.loadSettings();if(!(t!=null&&t.image_recognition_enabled))throw new Error("Image recognition AI is not enabled");return yield this.riskAnalysisService.analyzeImage(e)}catch(t){return console.error("Error analyzing image:",t),null}})}generateDemandForecast(e,t){return Ce(this,null,function*(){try{const r=yield this.loadSettings();if(!(r!=null&&r.demand_forecasting_enabled))throw new Error("Demand forecasting AI is not enabled");return yield this.forecastingService.generateDemandForecast(e,t)}catch(r){return console.error("Error generating demand forecast:",r),null}})}generateCostOptimization(e){return Ce(this,null,function*(){try{const t=yield this.loadSettings();if(!(t!=null&&t.cost_optimization_enabled))throw new Error("Cost optimization AI is not enabled");return yield this.optimizationService.generateCostOptimization(e)}catch(t){return console.error("Error generating cost optimization:",t),null}})}categorizeItem(e,t){return Ce(this,null,function*(){try{const r=yield this.loadSettings();if(!(r!=null&&r.smart_categorization_enabled))throw new Error("Smart categorization AI is not enabled");return yield this.optimizationService.categorizeItem(e,t)}catch(r){return console.error("Error categorizing item:",r),null}})}getPredictiveAnalytics(){return Ce(this,null,function*(){try{const e=yield this.loadSettings();if(!(e!=null&&e.predictive_analytics_enabled))throw new Error("Predictive analytics AI is not enabled");return yield this.forecastingService.getPredictiveAnalytics()}catch(e){throw console.error("Error generating predictive analytics:",e),e}})}exportAnalyticsReport(e,t,r){return Ce(this,null,function*(){try{const i=yield this.loadSettings();if(!(i!=null&&i.predictive_analytics_enabled))throw new Error("Analytics export is not enabled");return yield this.costAnalyticsService.exportAnalyticsReport(e,t,r)}catch(i){return console.error("Error exporting analytics report:",i),{success:!1,error:i instanceof Error?i.message:"Export failed"}}})}}var Va=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Md{constructor(e){this.settings=null,this.facilityId=e}loadSettings(){return Va(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings").select("*").eq("facility_id",this.facilityId).eq("module","sterilization").single();return t?(console.error("Error loading AI settings:",t),null):(this.settings=e.settings,e.settings)}catch(e){return console.error("Error loading AI settings:",e),null}})}saveSettings(e){return Va(this,null,function*(){try{const{data:{user:t}}=yield d.auth.getUser(),r=(t==null?void 0:t.id)||"unknown-user",i={facility_id:this.facilityId,module:"sterilization",settings:e,updated_at:new Date().toISOString()},{error:n}=yield d.from("ai_settings").upsert(i,{onConflict:"facility_id,module"});return n?(console.error("Error saving AI settings:",n),!1):(!n&&i&&(yield Jn({facilityId:this.facilityId,userId:r,module:"sterilization",action:"UPDATE",details:i})),yield this.loadSettings(),!0)}catch(t){return console.error("Error saving AI settings:",t),!1}})}isFeatureEnabled(e){var t;return(t=this.settings)!=null&&t.ai_enabled?this.settings[e]===!0:!1}getCurrentSettings(){return this.settings}getOpenAIKey(){var e;return((e=this.settings)==null?void 0:e.openai_api_key_encrypted)||ge("VITE_OPENAI_API_KEY")}isComputerVisionEnabled(){return this.isFeatureEnabled("computer_vision_enabled")}isToolConditionAssessmentEnabled(){return this.isFeatureEnabled("tool_condition_assessment")}isBarcodeQualityDetectionEnabled(){return this.isFeatureEnabled("barcode_quality_detection")}isToolTypeRecognitionEnabled(){return this.isFeatureEnabled("tool_type_recognition")}isPredictiveAnalyticsEnabled(){return this.isFeatureEnabled("predictive_analytics_enabled")}isCycleOptimizationEnabled(){return this.isFeatureEnabled("cycle_optimization")}isIntelligentWorkflowSelectionEnabled(){return this.isFeatureEnabled("intelligent_workflow_selection")}isAutomatedProblemDetectionEnabled(){return this.isFeatureEnabled("automated_problem_detection")}isRealTimeMonitoringEnabled(){return this.isFeatureEnabled("real_time_monitoring_enabled")}isComplianceMonitoringEnabled(){return this.isFeatureEnabled("compliance_monitoring")}isBiologicalIndicatorAnalysisEnabled(){return this.isFeatureEnabled("biological_indicator_analysis")}getConfidenceThreshold(){var e;return((e=this.settings)==null?void 0:e.ai_confidence_threshold)||.8}getDataRetentionDays(){var e;return((e=this.settings)==null?void 0:e.ai_data_retention_days)||365}}function qd(){try{const c=localStorage.getItem("currentUser");if(c){const e=JSON.parse(c);return(e==null?void 0:e.id)||null}return null}catch(c){return console.warn("Failed to get user ID from storage:",c),null}}function Le(c){const e=qd();return e||c||null}const Ha={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};var zd=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Ct{constructor(){this.logLevel="info"}static getInstance(){return Ct.instance||(Ct.instance=new Ct),Ct.instance}error(e,t,r){this.log("error",e,t,r)}warn(e,t,r){this.log("warn",e,t,r)}info(e,t,r){this.log("info",e,t,r)}debug(e,t,r){this.log("debug",e,t,r)}log(e,t,r,i){if(!this.shouldLog(e))return;const n={level:e,message:this.sanitizeMessage(t),module:r.module,facilityId:r.facilityId,userId:r.userId,metadata:this.sanitizeMetadata(i),timestamp:new Date().toISOString()};this.storeLogEntry(n)}shouldLog(e){const t=["error","warn","info","debug"],r=t.indexOf(this.logLevel);return t.indexOf(e)<=r}sanitizeMessage(e){return e.replace(/sk-[a-zA-Z0-9]{20,}/g,"[REDACTED_API_KEY]").replace(/Bearer [a-zA-Z0-9._-]+/g,"[REDACTED_TOKEN]").replace(/password["\s]*[:=]["\s]*[^"\s,}]+/gi,"password: [REDACTED]").replace(/api[_-]?key["\s]*[:=]["\s]*[^"\s,}]+/gi,"api_key: [REDACTED]").substring(0,1e3)}sanitizeMetadata(e){if(!e)return;const t={};for(const[r,i]of Object.entries(e)){const n=r.toLowerCase();if(n.includes("password")||n.includes("secret")||n.includes("token")||n.includes("key")||n.includes("auth")){t[r]="[REDACTED]";continue}typeof i=="string"?t[r]=this.sanitizeMessage(i):typeof i=="object"&&i!==null?t[r]=this.sanitizeMetadata(i):t[r]=i}return t}storeLogEntry(e){return zd(this,null,function*(){try{yield d.from("system_logs").insert({level:e.level,message:e.message,module:e.module,facility_id:e.facilityId,user_id:e.userId,metadata:e.metadata,created_at:e.timestamp})}catch(t){}})}static validateEnvironment(){const t=["VITE_SUPABASE_URL","VITE_SUPABASE_ANON_KEY"].filter(i=>!Ha[i]);if(t.length>0)throw new Error(`Missing required environment variables: ${t.join(", ")}`);const r=["VITE_SUPABASE_ANON_KEY","VITE_SUPABASE_SERVICE_ROLE_KEY","VITE_GOOGLE_VISION_API_KEY","VITE_AZURE_VISION_API_KEY"];for(const i of r){const n=Ha[i];n&&(n.includes("sk-")||n.includes("Bearer "))&&console.warn(`Potential secret leakage detected in environment variable: ${i}`)}}}const hc=Ct.getInstance();Ct.validateEnvironment();var Ga=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class D{static callOpenAI(e,t){return Ga(this,null,function*(){if(!t)throw new Error("OpenAI API key not configured");try{const i=`You are a healthcare AI specialist for Cliniio, specializing in sterilization facility management, medical instrument analysis, and compliance workflows. Provide accurate, actionable insights based on the data provided.

${e}`;return yield Xr.askAI(i,{module:"sterilization-analysis",facilityId:"unknown"})}catch(r){throw hc.error("OpenAI API call failed",{module:"sterilization-analysis",facilityId:"unknown"},{error:r instanceof Error?r.message:String(r),promptLength:e.length}),new Error("AI analysis failed")}})}static testConnection(e){return Ga(this,null,function*(){try{return{success:!0,response:yield this.callOpenAI("Hello! This is a test message from Cliniio sterilization AI service. Please respond with a brief confirmation that you are working.",e)}}catch(t){return{success:!1,response:"",error:t instanceof Error?t.message:"Unknown error"}}})}static parseConditionFromAI(e){return e.includes("excellent")||e.includes("perfect")?"excellent":e.includes("good")||e.includes("acceptable")?"good":e.includes("fair")||e.includes("adequate")?"fair":e.includes("poor")||e.includes("unacceptable")?"poor":e.includes("damaged")||e.includes("broken")?"damaged":"good"}static parseWearLevelFromAI(e){return e.includes("minimal")||e.includes("new")?"minimal":e.includes("moderate")||e.includes("normal")?"moderate":e.includes("significant")||e.includes("worn")?"significant":e.includes("critical")||e.includes("severe")?"critical":"moderate"}static parseCleaningQualityFromAI(e){return e.includes("excellent")||e.includes("clean")?"excellent":e.includes("good")||e.includes("acceptable")?"good":e.includes("fair")||e.includes("adequate")?"fair":e.includes("poor")||e.includes("dirty")?"poor":"good"}static parseDamageFromAI(e){return e.includes("damage")||e.includes("broken")||e.includes("cracked")}static parseDamageTypesFromAI(e){const t=[];return e.includes("crack")&&t.push("crack"),e.includes("scratch")&&t.push("scratch"),e.includes("rust")&&t.push("rust"),e.includes("bend")&&t.push("bent"),t}static parseBarcodeQualityFromAI(e){return e.includes("excellent")||e.includes("clear")?"excellent":e.includes("good")||e.includes("readable")?"good":e.includes("fair")||e.includes("acceptable")?"fair":e.includes("poor")||e.includes("unreadable")?"poor":"good"}static parseToolTypeFromAI(e){return e.includes("handpiece")?"Dental Handpiece":e.includes("scalpel")?"Surgical Scalpel":e.includes("forceps")?"Surgical Forceps":e.includes("scissors")?"Surgical Scissors":"Medical Instrument"}static parseToolCategoryFromAI(e){return e.includes("dental")?"Dental Instruments":e.includes("surgical")?"Surgical Instruments":e.includes("ophthalmic")?"Ophthalmic Instruments":"General Medical Instruments"}static parseRiskLevel(e){return e.includes("high")||e.includes("critical")?"high":e.includes("medium")||e.includes("moderate")?"medium":"low"}static parseComplianceScore(e){return e.includes("excellent")||e.includes("100%")?.95:e.includes("good")||e.includes("90%")?.9:e.includes("fair")||e.includes("80%")?.8:.75}static generateRecommendations(e){const t=[];return e.includes("clean")&&t.push("Ensure thorough cleaning before sterilization"),e.includes("inspect")&&t.push("Perform detailed visual inspection"),e.includes("maintenance")&&t.push("Schedule maintenance check"),t.length===0&&t.push("Tool appears in good condition"),t}static generateBarcodeRecommendations(e){const t=[];return e.includes("poor")&&t.push("Replace barcode label"),e.includes("fair")&&t.push("Clean barcode surface"),e.includes("good")&&t.push("Monitor for degradation"),t}static generateToolSuggestions(e){const t=[];return e.includes("high-speed")&&t.push("High-speed handpiece - requires special sterilization cycle"),e.includes("delicate")&&t.push("Delicate instrument - handle with care"),e.includes("sharp")&&t.push("Sharp instrument - use protective packaging"),t}static parseOptimizationSuggestions(e){const t=[];return e.includes("temperature")&&t.push("Optimize temperature settings"),e.includes("duration")&&t.push("Adjust cycle duration"),e.includes("grouping")&&t.push("Improve tool grouping"),t.length===0&&t.push("Review cycle parameters"),t}static parseRecommendedParameters(e){const t={};return e.includes("temperature")&&(t.temperature=134),e.includes("duration")&&(t.duration=20),e.includes("pressure")&&(t.pressure=30),t}static parseRecommendedWorkflow(e){return e.includes("clean")?"clean":e.includes("dirty")?"dirty":e.includes("problem")?"problem":e.includes("packaging")?"packaging":"dirty"}static parseWorkflowReasoning(){return["Tool condition assessment completed","Historical usage patterns analyzed","Sterilization requirements verified"]}static parseAlternativeWorkflows(){return[{workflow:"clean",confidence:.75,reasoning:"Alternative cleaning approach"}]}static parseIssues(e){const t=[];return e.includes("wear")&&t.push("Tool wear detected"),e.includes("damage")&&t.push("Potential damage"),e.includes("maintenance")&&t.push("Maintenance needed"),t}static parseRiskFactors(e){const t=[];return e.includes("temperature")&&t.push("Temperature variations"),e.includes("pressure")&&t.push("Pressure fluctuations"),e.includes("time")&&t.push("Timing issues"),t}static parseRequiredActions(e){const t=[];return e.includes("document")&&t.push("Document variations"),e.includes("investigate")&&t.push("Investigate causes"),e.includes("correct")&&t.push("Correct procedures"),t}static parseAuditRecommendations(e){const t=[];return e.includes("review")&&t.push("Review procedures"),e.includes("monitor")&&t.push("Monitor parameters"),e.includes("train")&&t.push("Staff training"),t}static parseBIValidation(e){return e.includes("pass")||e.includes("success")?!0:(e.includes("fail")||e.includes("failure"),!1)}}var Ud=Object.defineProperty,Nd=Object.defineProperties,Fd=Object.getOwnPropertyDescriptors,Wa=Object.getOwnPropertySymbols,Ld=Object.prototype.hasOwnProperty,xd=Object.prototype.propertyIsEnumerable,Ka=(c,e,t)=>e in c?Ud(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Bd=(c,e)=>{for(var t in e||(e={}))Ld.call(e,t)&&Ka(c,t,e[t]);if(Wa)for(var t of Wa(e))xd.call(e,t)&&Ka(c,t,e[t]);return c},jd=(c,e)=>Nd(c,Fd(e)),It=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Vd{constructor(e){this.facilityId=e}recordMetric(e){return It(this,null,function*(){try{const t=jd(Bd({facility_id:this.facilityId},e),{created_at:new Date().toISOString()}),{data:r,error:i}=yield d.from("ai_performance_metrics").insert(t).select("id").single();return i?(console.error("Error recording performance metric:",i),null):r.id}catch(t){return console.error("Error recording performance metric:",t),null}})}getPerformanceSummary(e="day",t){return It(this,null,function*(){try{const r=this.getStartDate(e);let i=d.from("ai_performance_metrics").select("*").eq("facility_id",this.facilityId).gte("created_at",r.toISOString());t&&(i=i.eq("service_name",t));const{data:n,error:o}=yield i;return o?(console.error("Error fetching performance metrics:",o),this.getDefaultPerformanceSummary()):this.calculatePerformanceSummary(n||[])}catch(r){return console.error("Error getting performance summary:",r),this.getDefaultPerformanceSummary()}})}getServicePerformance(e="day"){return It(this,null,function*(){try{const t=this.getStartDate(e),{data:r,error:i}=yield d.from("ai_performance_metrics").select("*").eq("facility_id",this.facilityId).gte("created_at",t.toISOString());return i?(console.error("Error fetching service performance:",i),[]):this.calculateServicePerformance(r||[])}catch(t){return console.error("Error getting service performance:",t),[]}})}getDetailedMetrics(e){return It(this,null,function*(){try{const t=this.getStartDate(e.timeRange||"day");let r=d.from("ai_performance_metrics").select("*").eq("facility_id",this.facilityId).gte("created_at",t.toISOString()).order("created_at",{ascending:!1});e.serviceName&&(r=r.eq("service_name",e.serviceName)),e.operationName&&(r=r.eq("operation_name",e.operationName)),e.success!==void 0&&(r=r.eq("success",e.success)),e.limit&&(r=r.limit(e.limit));const{data:i,error:n}=yield r;return n?(console.error("Error fetching detailed metrics:",n),[]):i}catch(t){return console.error("Error getting detailed metrics:",t),[]}})}getPerformanceTrends(e="month",t){return It(this,null,function*(){try{const r=this.getStartDate(e),i=this.getInterval(e);let n=d.from("ai_performance_metrics").select("*").eq("facility_id",this.facilityId).gte("created_at",r.toISOString()).order("created_at",{ascending:!0});t&&(n=n.eq("service_name",t));const{data:o,error:s}=yield n;return s?(console.error("Error fetching performance trends:",s),{dates:[],processingTimes:[],successRates:[],operationCounts:[]}):this.calculateTrends(o||[],i)}catch(r){return console.error("Error getting performance trends:",r),{dates:[],processingTimes:[],successRates:[],operationCounts:[]}}})}getOptimizationRecommendations(){return It(this,null,function*(){try{const e=yield this.getPerformanceSummary("week"),t=[];return e.averageProcessingTime>5e3&&t.push("Consider optimizing AI model selection or reducing input complexity"),e.p95ProcessingTime>1e4&&t.push("Investigate performance bottlenecks in AI service calls"),e.successRate<.9&&t.push("Review error patterns and improve error handling"),e.errorRate>.1&&t.push("Implement retry mechanisms and fallback strategies"),e.performanceTrend==="degrading"&&t.push("Monitor system resources and consider scaling AI services"),t.length===0&&t.push("Performance is within acceptable ranges - continue monitoring"),t}catch(e){return console.error("Error getting optimization recommendations:",e),["Unable to generate recommendations at this time"]}})}cleanupOldMetrics(e=90){return It(this,null,function*(){try{const t=new Date(Date.now()-e*24*60*60*1e3),{data:r,error:i}=yield d.from("ai_performance_metrics").delete().lt("created_at",t.toISOString()).eq("facility_id",this.facilityId).select("id");return i?(console.error("Error cleaning up old metrics:",i),0):(r==null?void 0:r.length)||0}catch(t){return console.error("Error cleaning up old metrics:",t),0}})}getStartDate(e){const t=new Date;switch(e){case"hour":return new Date(t.getTime()-3600*1e3);case"day":return new Date(t.getTime()-1440*60*1e3);case"week":return new Date(t.getTime()-10080*60*1e3);case"month":return new Date(t.getTime()-720*60*60*1e3);case"quarter":return new Date(t.getTime()-2160*60*60*1e3);default:return new Date(t.getTime()-1440*60*1e3)}}getInterval(e){switch(e){case"week":return 1440*60*1e3;case"month":return 1440*60*1e3;case"quarter":return 10080*60*1e3;default:return 1440*60*1e3}}calculatePerformanceSummary(e){if(e.length===0)return this.getDefaultPerformanceSummary();const t=e.map(g=>g.processing_time_ms).filter(g=>g>0),r=e.filter(g=>g.success),i=e.filter(g=>!g.success),n=t.sort((g,y)=>g-y),o=e.length,s=r.length/o,a=t.reduce((g,y)=>g+y,0)/t.length,l=n[Math.floor(n.length/2)],u=n[Math.floor(n.length*.95)],h=n[Math.floor(n.length*.99)],f=e.slice(-10),m=f.reduce((g,y)=>g+y.processing_time_ms,0)/f.length,p=m<a*.9?"improving":m>a*1.1?"degrading":"stable";return{totalOperations:o,successRate:s,averageProcessingTime:a,medianProcessingTime:l,p95ProcessingTime:u,p99ProcessingTime:h,totalErrors:i.length,errorRate:i.length/o,performanceTrend:p,recommendations:this.generateRecommendations(e)}}calculateServicePerformance(e){const t=new Map;return e.forEach(r=>{t.has(r.service_name)||t.set(r.service_name,[]),t.get(r.service_name).push(r)}),Array.from(t.entries()).map(([r,i])=>{var n;const o=i.map(g=>g.processing_time_ms).filter(g=>g>0),s=i.filter(g=>g.success),a=((n=i[0])==null?void 0:n.created_at)||"",l=i.length,u=s.length/l,h=o.length>0?o.reduce((g,y)=>g+y,0)/o.length:0,f=Math.max(0,100-h/100),m=u*100,p=Math.round((f+m)/2);return{serviceName:r,operationCount:l,successRate:u,averageTime:h,totalErrors:i.filter(g=>!g.success).length,lastOperation:a,performanceScore:p}}).sort((r,i)=>i.performanceScore-r.performanceScore)}calculateTrends(e,t){const r=new Date,i=new Map;for(let o=0;o<10;o++){const a=new Date(r.getTime()-o*t).toISOString().split("T")[0];i.set(a,{times:[],success:0,total:0})}e.forEach(o=>{const s=new Date(o.created_at).toISOString().split("T")[0],a=i.get(s);a&&(a.times.push(o.processing_time_ms),a.total++,o.success&&a.success++)});const n=Array.from(i.entries()).sort(([o],[s])=>o.localeCompare(s));return{dates:n.map(([o])=>o),processingTimes:n.map(([,o])=>o.times.length>0?o.times.reduce((s,a)=>s+a,0)/o.times.length:0),successRates:n.map(([,o])=>o.total>0?o.success/o.total:0),operationCounts:n.map(([,o])=>o.total)}}generateRecommendations(e){const t=[];if(e.length===0)return["No performance data available for recommendations"];const r=e.reduce((n,o)=>n+o.processing_time_ms,0)/e.length,i=e.filter(n=>n.success).length/e.length;return r>5e3&&t.push("Consider optimizing AI model selection for faster processing"),i<.9&&t.push("Review error patterns and implement better error handling"),t.length===0&&t.push("Performance is within acceptable ranges"),t}getDefaultPerformanceSummary(){return{totalOperations:0,successRate:0,averageProcessingTime:0,medianProcessingTime:0,p95ProcessingTime:0,p99ProcessingTime:0,totalErrors:0,errorRate:0,performanceTrend:"stable",recommendations:["No performance data available"]}}}var Dr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Hd{constructor(e){this.analysisStartTime=0,this.facilityId=e,this.performanceMetrics=new Vd(e)}analyzeToolCondition(e,t,r){return Dr(this,null,function*(){this.analysisStartTime=Date.now();try{let i;t?i=`Analyze medical instrument data for tool ID: ${e}. Provide general condition assessment, wear level estimation, cleaning quality recommendations, and damage detection guidance based on best practices for medical instrument sterilization.`:i=`Analyze medical instrument data for tool ID: ${e}. Provide general condition assessment, wear level estimation, cleaning quality recommendations, and damage detection guidance based on best practices for medical instrument sterilization.`;const n=yield D.callOpenAI(i,r||""),o={success:!0,toolId:e,condition:D.parseConditionFromAI(n),wearLevel:D.parseWearLevelFromAI(n),cleaningQuality:D.parseCleaningQualityFromAI(n),damageDetected:D.parseDamageFromAI(n),damageTypes:D.parseDamageTypesFromAI(n),confidence:.8,recommendations:D.generateRecommendations(n)},s=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"analyzeToolCondition",processing_time_ms:s,success:!0,input_size_bytes:(t==null?void 0:t.size)||0,ai_model_used:"gpt-4",confidence_score:o.confidence,user_id:Le()||void 0}),yield this.saveToolAssessment(o),o}catch(i){const n=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"analyzeToolCondition",processing_time_ms:n,success:!1,error_message:i instanceof Error?i.message:"Unknown error",user_id:Le()||void 0}),console.error("Tool condition analysis failed:",i),{success:!1,condition:"good",wearLevel:"moderate",cleaningQuality:"good",damageDetected:!1,confidence:.5,recommendations:["Analysis failed - manual inspection recommended"],error:i instanceof Error?i.message:"Unknown error"}}})}detectBarcodeQuality(e,t){return Dr(this,null,function*(){this.analysisStartTime=Date.now();try{let r;e?r=yield D.callOpenAI("Provide general guidance on barcode quality assessment for medical instruments. Include best practices for barcode readability, common issues, and maintenance recommendations.",t||""):r=yield D.callOpenAI("Provide general guidance on barcode quality assessment for medical instruments. Include best practices for barcode readability, common issues, and maintenance recommendations.",t||"");const i=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"detectBarcodeQuality",processing_time_ms:i,success:!0,input_size_bytes:(e==null?void 0:e.size)||0,ai_model_used:"gpt-4",confidence_score:.9,user_id:Le()||void 0}),{success:!0,quality:D.parseBarcodeQualityFromAI(r),confidence:.9,recommendations:D.generateBarcodeRecommendations(r)}}catch(r){const i=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"detectBarcodeQuality",processing_time_ms:i,success:!1,error_message:r instanceof Error?r.message:"Unknown error",user_id:Le()||void 0}),console.error("Barcode quality detection failed:",r),{success:!1,quality:"fair",confidence:.5,recommendations:["Analysis failed - manual verification recommended"]}}})}identifyToolType(e,t){return Dr(this,null,function*(){this.analysisStartTime=Date.now();try{let r;return e?r=yield D.callOpenAI("Provide comprehensive guidance on medical instrument classification and sterilization requirements. Include common instrument types, categories, sterilization cycles, and best practices for healthcare facilities.",t||""):r=yield D.callOpenAI("Provide comprehensive guidance on medical instrument classification and sterilization requirements. Include common instrument types, categories, sterilization cycles, and best practices for healthcare facilities.",t||""),{success:!0,toolType:D.parseToolTypeFromAI(r),category:D.parseToolCategoryFromAI(r),confidence:.8,suggestions:D.generateToolSuggestions(r)}}catch(r){return console.error("Tool type identification failed:",r),{success:!1,confidence:.5,suggestions:["Identification failed - manual classification needed"]}}})}detectPotentialProblems(e,t,r){return Dr(this,null,function*(){this.analysisStartTime=Date.now();try{const i=yield D.callOpenAI(`Analyze tool data for potential problems: ${JSON.stringify(t)}. Identify risks and provide recommendations.`,r||""),n=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"detectPotentialProblems",processing_time_ms:n,success:!0,ai_model_used:"gpt-4",confidence_score:.8,user_id:Le()||void 0}),{success:!0,problemsDetected:i.includes("problem")||i.includes("risk"),riskLevel:D.parseRiskLevel(i),issues:D.parseIssues(i),recommendations:D.generateRecommendations(i)}}catch(i){const n=Date.now()-this.analysisStartTime;return yield this.performanceMetrics.recordMetric({service_name:"AnalysisServices",operation_name:"detectPotentialProblems",processing_time_ms:n,success:!1,error_message:i instanceof Error?i.message:"Unknown error",user_id:Le()||void 0}),console.error("Problem detection failed:",i),{success:!1,problemsDetected:!1,riskLevel:"low",issues:[],recommendations:["Analysis failed - manual inspection recommended"]}}})}saveToolAssessment(e){return Dr(this,null,function*(){try{const t={facility_id:this.facilityId,tool_id:e.toolId,cycle_id:null,condition_rating:e.condition,wear_level:e.wearLevel,cleaning_quality:e.cleaningQuality,damage_detected:e.damageDetected,damage_types:e.damageTypes||[],confidence_score:e.confidence,model_id:null,processing_time_ms:Date.now()-this.analysisStartTime,image_file_path:null,ai_insights:{recommendations:e.recommendations},created_by:Le()},{data:r,error:i}=yield d.from("sterilization_ai_tool_assessments").insert(t).select("id").single();return i?(console.error("Error saving tool assessment:",i),null):r.id}catch(t){return console.error("Error saving tool assessment:",t),null}})}}var hi=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Gd{constructor(e){this.facilityId=e}getCycleOptimization(e,t){return hi(this,null,function*(){try{const{data:r}=yield d.from("sterilization_cycles").select("*").eq("facility_id",this.facilityId).eq("status","completed").order("created_at",{ascending:!1}).limit(100);if(!r||r.length===0)throw new Error("No historical cycle data available");const i=yield D.callOpenAI(`Analyze sterilization cycle data for optimization. Historical cycles: ${JSON.stringify(r)}. Provide efficiency improvements and parameter recommendations.`,t||""),n={cycleId:e,currentEfficiency:this.calculateCurrentEfficiency(r),predictedEfficiency:this.calculatePredictedEfficiency(r),optimizationSuggestions:D.parseOptimizationSuggestions(i),estimatedTimeSavings:this.calculateTimeSavings(),recommendedParameters:D.parseRecommendedParameters(i),confidence:.85};return yield this.saveCycleOptimization(n),n}catch(r){throw console.error("Cycle optimization failed:",r),new Error("Cycle optimization analysis failed")}})}getWorkflowSuggestion(e,t,r){return hi(this,null,function*(){try{const{data:i}=yield d.from("tools").select("*").eq("id",e).eq("facility_id",this.facilityId).single();if(!i)throw new Error("Tool not found");const n=yield D.callOpenAI(`Recommend sterilization workflow for tool: ${JSON.stringify(i)}. History: ${JSON.stringify(t)}. Consider tool type, condition, and usage patterns.`,r||""),o={toolId:e,recommendedWorkflow:D.parseRecommendedWorkflow(n),confidence:this.calculateWorkflowConfidence(i,t),reasoning:D.parseWorkflowReasoning(),alternativeWorkflows:D.parseAlternativeWorkflows()};return yield this.saveWorkflowSuggestion(o),o}catch(i){throw console.error("Workflow suggestion failed:",i),new Error("Workflow suggestion failed")}})}calculateCurrentEfficiency(e){if(!e||e.length===0)return .75;const t=e.reduce((r,i)=>r+(i.duration_minutes||0),0)/e.length;return Math.max(.5,Math.min(1,1-(t-20)/100))}calculatePredictedEfficiency(e){const t=this.calculateCurrentEfficiency(e);return Math.min(1,t+.15)}calculateTimeSavings(){return Math.floor(Math.random()*15)+5}calculateWorkflowConfidence(e,t){let r=.5;return e.condition==="excellent"&&(r+=.2),t.usage_count<100&&(r+=.1),Math.min(r,.95)}saveCycleOptimization(e){return hi(this,null,function*(){try{const t={facility_id:this.facilityId,cycle_id:e.cycleId,current_efficiency:e.currentEfficiency,predicted_efficiency:e.predictedEfficiency,estimated_time_savings:e.estimatedTimeSavings,recommended_parameters:e.recommendedParameters,confidence_score:e.confidence,model_id:null,processing_time_ms:0,optimization_factors:{},created_by:null};yield d.from("sterilization_ai_cycle_optimizations").insert(t)}catch(t){console.error("Error saving cycle optimization:",t)}})}saveWorkflowSuggestion(e){return hi(this,null,function*(){try{const t={facility_id:this.facilityId,tool_id:e.toolId,recommended_workflow:e.recommendedWorkflow,confidence_score:e.confidence,reasoning:e.reasoning,alternative_workflows:e.alternativeWorkflows,model_id:null,processing_time_ms:0,tool_history_data:{},created_by:null};yield d.from("sterilization_ai_workflow_suggestions").insert(t)}catch(t){console.error("Error saving workflow suggestion:",t)}})}}var tt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Wd{constructor(e){this.facilityId=e}getPredictiveAnalytics(e){return tt(this,null,function*(){try{const{data:t}=yield d.from("autoclave_equipment").select("*").eq("facility_id",this.facilityId),{data:r}=yield d.from("sterilization_cycles").select("*").eq("facility_id",this.facilityId).eq("status","completed").order("created_at",{ascending:!1}).limit(50),i=`
        Analyze sterilization data for predictive insights:
        Equipment: ${JSON.stringify(t)}
        Recent cycles: ${JSON.stringify(r)}
        
        Provide:
        1. Equipment maintenance predictions
        2. Cycle efficiency trends
        3. Quality metrics analysis
        4. Risk factors and recommendations
      `,n=yield D.callOpenAI(i,e||"");return this.parsePredictiveAnalytics(n,t)}catch(t){throw console.error("Predictive analytics failed:",t),new Error("Predictive analytics failed")}})}getRealTimeInsights(){return tt(this,null,function*(){try{const{data:e}=yield d.from("sterilization_cycles").select("*").eq("facility_id",this.facilityId).gte("created_at",new Date(Date.now()-864e5).toISOString()),t=[];if(e&&e.length>0){const i=yield this.analyzeCycleEfficiency(e);i&&t.push(i)}const{data:r}=yield d.from("autoclave_equipment").select("*").eq("facility_id",this.facilityId);if(r&&r.length>0){const i=yield this.analyzeEquipmentMaintenance(r);i&&t.push(i)}return t}catch(e){return console.error("Real-time insights failed:",e),[]}})}getHistoricalTrends(e){return tt(this,null,function*(){try{const t=new Date,r=new Date;switch(e){case"week":r.setDate(t.getDate()-7);break;case"month":r.setMonth(t.getMonth()-1);break;case"quarter":r.setMonth(t.getMonth()-3);break;case"year":r.setFullYear(t.getFullYear()-1);break}const{data:i}=yield d.from("sterilization_cycles").select("*").eq("facility_id",this.facilityId).gte("created_at",r.toISOString()).lte("created_at",t.toISOString()).order("created_at",{ascending:!0});if(!i||i.length===0)throw new Error("No historical data available");const n=this.calculateTrends(i),o=this.generateTrendInsights(n),s=this.generateTrendPredictions(n);return{success:!0,trends:n,insights:o,predictions:s}}catch(t){return console.error("Historical trends analysis failed:",t),{success:!1,trends:{efficiency:[],quality:[],duration:[],temperature:[]},insights:["Analysis failed"],predictions:["Unable to generate predictions"]}}})}parsePredictiveAnalytics(e,t){return{equipmentMaintenance:(t==null?void 0:t.map(r=>({equipmentId:r.id,nextMaintenanceDue:new Date(Date.now()+720*60*60*1e3).toISOString(),riskLevel:"medium",predictedIssues:["Calibration needed","Wear detection"]})))||[],cycleEfficiency:{trend:"improving",factors:["Optimized parameters","Better tool grouping"],recommendations:["Continue current practices","Monitor performance"]},qualityMetrics:{currentQuality:.94,predictedQuality:.96,riskFactors:["Temperature variations"],improvementActions:["Standardize procedures"]}}}analyzeCycleEfficiency(e){return tt(this,null,function*(){try{const t=this.calculateCurrentEfficiency(e);return t<.8?{id:`efficiency-${Date.now()}`,type:"efficiency_improvement",title:"Cycle Efficiency Improvement Opportunity",description:`Current efficiency is ${(t*100).toFixed(1)}%. Optimization could improve this by 15-20%.`,confidence:.85,priority:"medium",actionable:!0,recommendations:["Review cycle parameters","Optimize tool grouping","Analyze temperature settings"],data:{currentEfficiency:t,potentialEfficiency:t+.15},created_at:new Date().toISOString(),facility_id:this.facilityId,severity:"medium",category:"efficiency",timestamp:new Date().toISOString()}:null}catch(t){return console.error("Cycle efficiency analysis failed:",t),null}})}analyzeEquipmentMaintenance(e){return tt(this,null,function*(){try{const t=e.filter(r=>(new Date(r.last_maintenance).getTime()-Date.now())/(1e3*60*60*24)<=14);return t.length>0?{id:`maintenance-${Date.now()}`,type:"maintenance_prediction",title:"Equipment Maintenance Due Soon",description:`${t.length} piece(s) of equipment require maintenance within 2 weeks.`,confidence:.9,priority:"high",actionable:!0,recommendations:["Schedule maintenance","Review maintenance logs","Check calibration status"],data:{equipmentCount:t.length,daysUntilMaintenance:14},created_at:new Date().toISOString(),facility_id:this.facilityId,severity:"high",category:"maintenance",timestamp:new Date().toISOString()}:null}catch(t){return console.error("Equipment maintenance analysis failed:",t),null}})}calculateCurrentEfficiency(e){if(!e||e.length===0)return .75;const t=e.reduce((r,i)=>{var n;return r+((n=i.duration_minutes)!=null?n:0)},0)/e.length;return Math.max(.5,Math.min(1,1-(t-20)/100))}calculateTrends(e){const t=[],r=[],i=[],n=[];return e.forEach((o,s)=>{var a,l;t.push(.75+s*.02+Math.random()*.1),r.push(.9+s*.01+Math.random()*.05),i.push((a=o.duration_minutes)!=null?a:20),n.push((l=o.temperature)!=null?l:134)}),{efficiency:t,quality:r,duration:i,temperature:n}}generateTrendInsights(e){const t=[];if(e.efficiency.length>1){const r=e.efficiency[e.efficiency.length-1]-e.efficiency[0];r>.1&&t.push(`Efficiency has improved ${(r*100).toFixed(1)}% over the period`)}return e.quality.length>1&&e.quality.reduce((i,n)=>i+n,0)/e.quality.length>.95&&t.push("Quality metrics remain consistently high"),t}generateTrendPredictions(e){const t=[];if(e.efficiency.length>1){const r=e.efficiency[e.efficiency.length-1],i=Math.min(1,r+.05);t.push(`Efficiency expected to reach ${(i*100).toFixed(1)}% by end of quarter`)}return e.quality.length>1&&t.push("Quality metrics likely to maintain 96%+ levels"),t}exportAnalyticsReport(e,t,r){return tt(this,null,function*(){try{const i=Date.now();let n={};switch(e){case"insights":n={insights:yield this.getRealTimeInsights()};break;case"predictive":n={predictive:yield this.getPredictiveAnalytics()};break;case"historical":n=yield this.getHistoricalTrends("month");break;case"comprehensive":{const[a,l,u]=yield Promise.all([this.getRealTimeInsights(),this.getPredictiveAnalytics(),this.getHistoricalTrends("month")]);n={insights:a,predictive:l,historical:u};break}}const o=yield this.formatReportData(n,t),{error:s}=yield d.from("sterilization_ai_exports").insert({facility_id:this.facilityId,report_type:e,export_format:t,date_range:r,processing_time_ms:Date.now()-i,exported_at:new Date().toISOString()});return s&&console.error("Error saving export record:",s),{success:!0,data:o,downloadUrl:yield this.generateDownloadUrl(o,t)}}catch(i){return console.error("Error exporting analytics report:",i),{success:!1,error:i instanceof Error?i.message:"Export failed"}}})}formatReportData(e,t){return tt(this,null,function*(){switch(t){case"json":return JSON.stringify(e,null,2);case"csv":return this.convertToCSV(e);case"excel":return this.convertToExcel(e);case"pdf":return this.convertToPDF(e);default:return e}})}generateDownloadUrl(e,t){return tt(this,null,function*(){const r=new Blob([JSON.stringify(e)],{type:this.getMimeType(t)});return URL.createObjectURL(r)})}getMimeType(e){switch(e){case"csv":return"text/csv";case"excel":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"pdf":return"application/pdf";case"json":return"application/json";default:return"text/plain"}}convertToCSV(e){if(Array.isArray(e)){const t=Object.keys(e[0]||{}),r=[t.join(",")];for(const i of e){const n=t.map(o=>{var s;return JSON.stringify((s=i[o])!=null?s:"")});r.push(n.join(","))}return r.join(`
`)}return JSON.stringify(e)}convertToExcel(e){return e}convertToPDF(e){return e}}var Qa=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Kd{constructor(e){this.facilityId=e}analyzeCompliance(e,t){return Qa(this,null,function*(){try{const{data:r}=yield d.from("sterilization_cycles").select("*").eq("id",e).single();if(!r)throw new Error("Cycle not found");const i=yield D.callOpenAI(`Analyze sterilization cycle for compliance: ${JSON.stringify(r)}. Check for regulatory requirements and audit recommendations.`,t||"");return{cycleId:e,complianceScore:D.parseComplianceScore(i),riskFactors:D.parseRiskFactors(i),requiredActions:D.parseRequiredActions(i),auditRecommendations:D.parseAuditRecommendations(i),regulatoryUpdates:this.parseRegulatoryUpdates()}}catch(r){throw console.error("Compliance analysis failed:",r),new Error("Compliance analysis failed")}})}validateBiologicalIndicators(e,t){return Qa(this,null,function*(){try{const r=yield D.callOpenAI(`Analyze biological indicator data: ${JSON.stringify(e)}. Determine if sterilization conditions were properly achieved.`,t||"");return{valid:D.parseBIValidation(r),confidence:.95,recommendations:["Continue current sterilization parameters","Monitor for any trend changes","Schedule next validation per protocol"]}}catch(r){return console.error("BI validation failed:",r),{valid:!1,confidence:.5,recommendations:["Manual validation required"]}}})}parseRegulatoryUpdates(){return["New FDA guidelines effective Q1 2025","Updated AAMI standards for autoclave validation"]}}var te=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class fc{constructor(e){this.facilityId=e,this.settingsManager=new Md(e),this.analysisServices=new Hd(e),this.optimizationServices=new Gd(e),this.analyticsServices=new Wd(e),this.complianceServices=new Kd(e)}initialize(){return te(this,null,function*(){try{return(yield this.settingsManager.loadSettings())!==null}catch(e){return console.error("Failed to initialize SterilizationAIService:",e),!1}})}loadSettings(){return te(this,null,function*(){return this.settingsManager.loadSettings()})}saveSettings(e){return te(this,null,function*(){return this.settingsManager.saveSettings(e)})}analyzeToolCondition(e,t){return te(this,null,function*(){if(!this.settingsManager.isToolConditionAssessmentEnabled())throw new Error("Tool condition assessment is not enabled");const r=this.settingsManager.getOpenAIKey();return this.analysisServices.analyzeToolCondition(e,t,r)})}detectBarcodeQuality(e){return te(this,null,function*(){if(!this.settingsManager.isBarcodeQualityDetectionEnabled())throw new Error("Barcode quality detection is not enabled");const t=this.settingsManager.getOpenAIKey();return this.analysisServices.detectBarcodeQuality(e,t)})}identifyToolType(e){return te(this,null,function*(){if(!this.settingsManager.isToolTypeRecognitionEnabled())throw new Error("Tool type recognition is not enabled");const t=this.settingsManager.getOpenAIKey();return this.analysisServices.identifyToolType(e,t)})}getCycleOptimization(e){return te(this,null,function*(){if(!this.settingsManager.isCycleOptimizationEnabled())throw new Error("Cycle optimization is not enabled");const t=this.settingsManager.getOpenAIKey();return this.optimizationServices.getCycleOptimization(e,t)})}getWorkflowSuggestion(e,t){return te(this,null,function*(){if(!this.settingsManager.isIntelligentWorkflowSelectionEnabled())throw new Error("Intelligent workflow selection is not enabled");const r=this.settingsManager.getOpenAIKey();return this.optimizationServices.getWorkflowSuggestion(e,t,r)})}getPredictiveAnalytics(){return te(this,null,function*(){if(!this.settingsManager.isPredictiveAnalyticsEnabled())throw new Error("Predictive analytics is not enabled");const e=this.settingsManager.getOpenAIKey();return this.analyticsServices.getPredictiveAnalytics(e)})}getRealTimeInsights(){return te(this,null,function*(){if(!this.settingsManager.isRealTimeMonitoringEnabled())throw new Error("Real-time monitoring is not enabled");return this.analyticsServices.getRealTimeInsights()})}getHistoricalTrends(e){return te(this,null,function*(){if(!this.settingsManager.isPredictiveAnalyticsEnabled())throw new Error("Predictive analytics is not enabled");return this.analyticsServices.getHistoricalTrends(e)})}exportAnalyticsReport(e,t,r){return te(this,null,function*(){if(!this.settingsManager.isPredictiveAnalyticsEnabled())throw new Error("Analytics export is not enabled");return this.analyticsServices.exportAnalyticsReport(e,t,r)})}detectPotentialProblems(e,t){return te(this,null,function*(){if(!this.settingsManager.isAutomatedProblemDetectionEnabled())throw new Error("Automated problem detection is not enabled");const r=this.settingsManager.getOpenAIKey();return this.analysisServices.detectPotentialProblems(e,t,r)})}analyzeCompliance(e){return te(this,null,function*(){if(!this.settingsManager.isComplianceMonitoringEnabled())throw new Error("Compliance monitoring is not enabled");const t=this.settingsManager.getOpenAIKey();return this.complianceServices.analyzeCompliance(e,t)})}validateBiologicalIndicators(e){return te(this,null,function*(){if(!this.settingsManager.isBiologicalIndicatorAnalysisEnabled())throw new Error("Biological indicator analysis is not enabled");const t=this.settingsManager.getOpenAIKey();return this.complianceServices.validateBiologicalIndicators(e,t)})}testChatGPT4Connection(){return te(this,null,function*(){const e=this.settingsManager.getOpenAIKey();return e?D.testConnection(e):{success:!1,response:"",error:"OpenAI API key not configured"}})}isFeatureEnabled(e){return this.settingsManager.isFeatureEnabled(e)}getCurrentSettings(){return this.settingsManager.getCurrentSettings()}getConfidenceThreshold(){return this.settingsManager.getConfidenceThreshold()}getDataRetentionDays(){return this.settingsManager.getDataRetentionDays()}}var fi={},qe=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Qd{constructor(e){this.facilityId=e}processPredictiveCleaningWithAI(){return qe(this,null,function*(){return{predicted_cleaning_date:new Date(Date.now()+2880*60*1e3).toISOString(),confidence_score:.85,urgency_level:"medium",cleaning_type:"routine",estimated_duration:45,required_resources:["cleaning_supplies","staff_2","equipment_standard"],risk_factors:["high_traffic_area","recent_contamination"],optimization_suggestions:["Schedule during low-traffic hours","Use eco-friendly cleaning products","Implement double-cleaning for high-risk areas"]}})}processContaminationPredictionWithAI(){return qe(this,null,function*(){return{contamination_probability:.25,predicted_contamination_type:"bacterial",risk_factors:["high_occupancy","inadequate_ventilation","recent_illness"],prevention_measures:["Increase cleaning frequency","Improve ventilation","Implement additional disinfection protocols"],early_warning_signs:["Increased moisture levels","Unusual odors","Staff illness reports"],confidence_score:.78}})}processResourceOptimizationWithAI(){return qe(this,null,function*(){return{current_usage:{cleaning_supplies:100,staff_hours:40,equipment_usage:8,water_usage:200,energy_consumption:150},optimized_usage:{cleaning_supplies:85,staff_hours:35,equipment_usage:7,water_usage:180,energy_consumption:135},savings_percentage:15,cost_savings:2500,efficiency_improvement:20,recommended_actions:["Implement smart scheduling to reduce staff hours","Use concentrated cleaning products to reduce supply usage","Optimize equipment usage patterns","Install water-efficient cleaning systems"],implementation_timeline:"2-4 weeks",risk_assessment:"low",confidence_score:.82}})}processSmartSchedulingWithAI(){return qe(this,null,function*(){return{optimal_cleaning_time:"2024-09-04T14:00:00Z",staff_recommendations:["experienced_cleaner_1","trainee_cleaner_2"],resource_requirements:["standard_cleaning_kit","disinfection_spray","mop_bucket"],conflict_avoidance:["Avoid patient visiting hours","Schedule around maintenance windows","Coordinate with other departments"],efficiency_score:.88,cost_optimization:.75,quality_assurance:["Pre-cleaning inspection","Post-cleaning verification","Quality checklist completion"],confidence_score:.85}})}processRiskAssessmentWithAI(){return qe(this,null,function*(){return{overall_risk_score:.35,risk_categories:{contamination:.4,compliance:.2,safety:.3,efficiency:.5},risk_factors:["High-traffic areas with increased contamination risk","Aging equipment requiring maintenance","Staff training gaps in new protocols","Inconsistent cleaning schedules"],mitigation_strategies:["Implement enhanced cleaning protocols for high-risk areas","Schedule preventive maintenance for aging equipment","Provide additional staff training on new protocols","Standardize cleaning schedules across all areas"],priority_actions:["Immediate: Schedule equipment maintenance","Short-term: Implement enhanced cleaning protocols","Medium-term: Comprehensive staff training program"],confidence_score:.79}})}processTrendAnalysisWithAI(){return qe(this,null,function*(){return{analysis_type:"cleaning_efficiency",trend_direction:"improving",trend_strength:.7,key_insights:["Cleaning efficiency has improved 15% over the past quarter","Resource usage optimization is showing positive results","Quality scores are consistently above target thresholds"],contributing_factors:["Implementation of new cleaning protocols","Staff training improvements","Better scheduling optimization","Upgraded cleaning equipment"],recommendations:["Continue current optimization strategies","Expand successful protocols to other areas","Monitor for potential plateau effects","Consider additional technology investments"],confidence_score:.84}})}processAnomalyDetectionWithAI(){return qe(this,null,function*(){return{anomaly_type:"resource_spike",severity:"medium",description:"Unusual increase in cleaning supply usage detected in Room 204",detected_at:new Date().toISOString(),normal_range:{daily_usage:"10-15 units",weekly_usage:"70-105 units"},actual_value:{daily_usage:"25 units",weekly_usage:"175 units"},potential_causes:["Increased contamination requiring additional cleaning","Equipment malfunction causing waste","Staff training issue with proper usage","Room usage pattern changes"],recommended_actions:["Investigate room conditions and usage patterns","Check equipment functionality","Review staff training records","Implement usage monitoring for this area"],confidence_score:.76}})}processQualityAssuranceWithAI(){return qe(this,null,function*(){return{quality_score:.87,quality_metrics:{cleanliness:.92,compliance:.85,efficiency:.88,safety:.9},quality_trends:{cleanliness_trend:"improving",compliance_trend:"stable",efficiency_trend:"improving",safety_trend:"stable"},improvement_areas:["Documentation completeness","Staff training consistency","Equipment maintenance scheduling"],best_practices:["Standardized cleaning protocols","Regular quality inspections","Staff feedback integration","Continuous improvement processes"],compliance_status:"compliant",audit_recommendations:["Maintain current quality standards","Focus on documentation improvements","Schedule regular compliance reviews","Implement additional quality checkpoints"],confidence_score:.83}})}buildPredictiveCleaningPrompt(e,t){return`Analyze the following room and historical cleaning data:
    Room Data: ${e}
    Historical Data: ${t}
    
    Please provide:
    1. Predicted optimal cleaning date
    2. Confidence score for prediction
    3. Urgency level assessment
    4. Recommended cleaning type
    5. Estimated duration
    6. Required resources
    7. Risk factors to consider
    8. Optimization suggestions`}buildContaminationPredictionPrompt(e,t){return`Analyze contamination risk based on:
    Room Data: ${e}
    Environmental Data: ${t}
    
    Please provide:
    1. Contamination probability score
    2. Predicted contamination type
    3. Risk factors identified
    4. Prevention measures
    5. Early warning signs to monitor
    6. Confidence score for prediction`}buildResourceOptimizationPrompt(e,t){return`Optimize resource usage based on:
    Current Usage: ${e}
    Cost Data: ${t}
    
    Please provide:
    1. Current vs optimized usage comparison
    2. Savings percentage and cost reduction
    3. Efficiency improvement metrics
    4. Recommended actions
    5. Implementation timeline
    6. Risk assessment
    7. Confidence score for optimization`}buildSmartSchedulingPrompt(e,t,r){return`Create optimal cleaning schedule based on:
    Room Data: ${e}
    Staff Availability: ${t}
    Constraints: ${r}
    
    Please provide:
    1. Optimal cleaning time
    2. Staff recommendations
    3. Resource requirements
    4. Conflict avoidance strategies
    5. Efficiency and cost optimization scores
    6. Quality assurance measures
    7. Confidence score for scheduling`}executeWithRetry(e,t=3,r=100){return qe(this,null,function*(){const{OptimizedRetryService:i}=yield T(()=>Promise.resolve().then(()=>Ac),void 0);return yield i.executeWithRetry(e,{maxRetries:t,baseDelay:r,backoffStrategy:"linear",retryCondition:n=>n.message.includes("network")||n.message.includes("timeout")||n.message.includes("rate limit")||n.message.includes("temporary")}).then(n=>{if(!n.success)throw n.error;return n.data})})}executeWithTimeout(e,t=3e4){return qe(this,null,function*(){const r=new Promise((i,n)=>{setTimeout(()=>n(new Error("Operation timed out")),t)});return Promise.race([e,r])})}selectModelForTask(e){switch(e){case"predictive_cleaning":return"gpt-4";case"contamination_prediction":return"gpt-4";case"resource_optimization":return"gpt-4";case"smart_scheduling":return"gpt-4";case"risk_assessment":return"gpt-4";case"trend_analysis":return"gpt-4";case"anomaly_detection":return"gpt-4";case"quality_assurance":return"gpt-4";default:return"gpt-4"}}getProviderConfig(e){const t={openai:{baseUrl:fi.OPENAI_API_BASE_URL||"https://api.openai.com/v1",timeout:3e4,maxRetries:3,model:"gpt-4"},google:{baseUrl:fi.GOOGLE_AI_API_BASE_URL||"https://generativelanguage.googleapis.com/v1",timeout:3e4,maxRetries:3,model:"gemini-pro"},azure:{baseUrl:fi.AZURE_OPENAI_ENDPOINT||"",timeout:3e4,maxRetries:3,model:"gpt-4"},custom:{baseUrl:fi.CUSTOM_AI_ENDPOINT||"",timeout:3e4,maxRetries:3,model:"custom"}};return t[e]||t.openai}}var Sn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Yd{constructor(e){this.facilityId=e}getEnvironmentalInsights(){return Sn(this,null,function*(){try{return[]}catch(e){return console.error("Error getting environmental insights:",e),[]}})}getHistoricalCleaningData(){return Sn(this,null,function*(){try{const{data:e}=yield d.from("environmental_cleans_enhanced").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(30);return e?e.map(t=>({date:t.created_at,room_id:t.room_id,cleaning_type:t.session_type||"routine",duration:this.calculateDuration(t.created_at,t.created_at),quality_score:t.cleaning_quality_score||.8,resources_used:{cleaning_supplies:5,staff_hours:1,equipment_usage:1,water_usage:20,energy_consumption:10}})):[]}catch(e){return console.error("Error getting historical cleaning data:",e),[]}})}calculateDuration(e,t){if(!e||!t)return 30;const r=new Date(e),n=new Date(t).getTime()-r.getTime();return Math.max(Math.floor(n/(1e3*60)),1)}getEnvironmentalCleaningCostData(){return Sn(this,null,function*(){try{return{staff_costs:12e3,supply_costs:3e3,equipment_costs:2e3,utility_costs:1500,total_cost:18500}}catch(e){return console.error("Error getting environmental cleaning cost data:",e),{staff_costs:12e3,supply_costs:3e3,equipment_costs:2e3,utility_costs:1500,total_cost:18500}}})}calculateCleaningEfficiency(e,t,r){const i=this.calculateResourceUsageFactor(r),n=e/(t*i);return Math.min(n,1)}calculateResourceUsageFactor(e){const t=e.staff_hours||1,r=e.cleaning_supplies||1,i=e.equipment_usage||1;return(t*.4+r*.3+i*.3)/10}calculateContaminationRisk(e,t,r,i){const n=(Date.now()-new Date(r).getTime())/864e5;let o=.1;o+={operating_room:.3,icu:.25,patient_room:.15,common_area:.1,storage:.05}[e]||.1,o+=t*.2,n>7?o+=.3:n>3&&(o+=.15);const a=i.humidity||50,l=i.temperature||20;return a>70&&(o+=.1),l>25&&(o+=.05),Math.min(o,1)}calculateCostSavings(e,t){const r=e-t,i=r/e*100;return{savings:r,percentage:i}}calculateQualityTrend(e){if(e.length<2)return"stable";const t=e.slice(0,Math.ceil(e.length/2)),r=e.slice(Math.ceil(e.length/2)),i=t.reduce((s,a)=>s+a,0)/t.length,n=r.reduce((s,a)=>s+a,0)/r.length,o=i-n;return o>.05?"improving":o<-.05?"declining":"stable"}calculateResourceEfficiency(e,t){const r=Object.values(e).reduce((n,o)=>n+o,0),i=Object.values(t).reduce((n,o)=>n+o,0);return r===0?0:(r-i)/r*100}detectAnomalies(e,t=2){if(e.length<3)return[];const r=e.reduce((o,s)=>o+s,0)/e.length,i=e.reduce((o,s)=>o+Math.pow(s-r,2),0)/e.length,n=Math.sqrt(i);return e.map((o,s)=>({index:s,value:o,deviation:Math.abs(o-r)/n})).filter(o=>o.deviation>t)}getPriorityFromUrgency(e){switch(e){case"critical":return"critical";case"high":return"high";case"medium":return"medium";case"low":return"low";default:return"medium"}}getPriorityFromProbability(e){return e>=.8?"critical":e>=.6?"high":e>=.4?"medium":"low"}getPriorityFromSavings(e){return e>=30?"critical":e>=20?"high":e>=10?"medium":"low"}getPriorityFromSeverity(e){switch(e){case"critical":return"critical";case"high":return"high";case"medium":return"medium";case"low":return"low";default:return"medium"}}}var ae=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class mc{constructor(e){this.facilityId=e,this.providerService=new Qd(e),this.analyticsService=new Yd(e)}initialize(){return ae(this,null,function*(){try{return(yield this.loadSettings())!==null}catch(e){return console.error(e),console.error("Failed to initialize EnvironmentalAIService"),!1}})}loadSettings(){return ae(this,null,function*(){return null})}saveSettings(e){return ae(this,null,function*(){return!1})}initializeSettings(){return ae(this,null,function*(){return!1})}generatePredictiveCleaning(e){return ae(this,null,function*(){return null})}predictContamination(e){return ae(this,null,function*(){return null})}optimizeResources(e){return ae(this,null,function*(){return null})}generateSmartSchedule(e){return ae(this,null,function*(){return null})}assessRisk(e){return ae(this,null,function*(){return null})}analyzeTrends(e){return ae(this,null,function*(){return null})}detectAnomalies(e){return ae(this,null,function*(){return null})}assessQuality(e){return ae(this,null,function*(){return null})}getEnvironmentalInsights(){return ae(this,null,function*(){return this.analyticsService.getEnvironmentalInsights()})}getHistoricalCleaningData(){return ae(this,null,function*(){try{const{data:e,error:t}=yield d.from("environmental_cleans_enhanced").select("*").eq("facility_id",this.facilityId).order("created_at",{ascending:!1}).limit(100);return t?(console.error("Error getting historical cleaning data:",t),[]):(e==null?void 0:e.map(i=>({id:i.id,facility_id:i.facility_id,room_id:i.room_id,room_name:i.room_name,cleaning_type:i.cleaning_type,status:i.status,started_time:i.started_time,completed_time:i.completed_time,created_at:i.created_at,updated_at:i.updated_at})))||[]}catch(e){return console.error("Error getting historical cleaning data:",e),[]}})}getRoomData(e){return ae(this,null,function*(){var t,r,i,n,o,s,a,l;try{const{data:u,error:h}=yield d.from("environmental_cleans_enhanced").select("*").eq("id",e).eq("facility_id",this.facilityId).single();if(h)return console.error("Error getting room data:",h),null;const f=u;return{id:f.id,room_id:f.id,room_name:(t=f.room_name)!=null?t:"Unknown Room",room_type:(r=f.room_type)!=null?r:"unknown",last_cleaned:(i=f.last_cleaned)!=null?i:new Date().toISOString(),cleaning_frequency:(n=f.cleaning_frequency)!=null?n:1,priority_level:(o=f.priority_level)!=null?o:"medium",contamination_risk:(s=f.contamination_risk)!=null?s:.5,usage_pattern:(a=f.usage_pattern)!=null?a:{},maintenance_status:(l=f.maintenance_status)!=null?l:"good"}}catch(u){return console.error("Error getting room data:",u),null}})}isFeatureEnabled(e,t){return this.getNestedProperty(e,t)===!0}getNestedProperty(e,t){return t.split(".").reduce((r,i)=>r==null?void 0:r[i],e)}}const Ya={"gpt-4":{input:3e-5,output:6e-5},"gpt-4o-mini":{input:15e-5,output:6e-4},"gpt-3.5-turbo":{input:5e-4,output:.0015}};class nr{constructor(){this.usageCache=new Map,this.tokenLimit=1e3,this.monitoringService=kt.getInstance()}static getInstance(){return nr.instance||(nr.instance=new nr),nr.instance}recordTokenUsage(e,t,r,i,n){const o=Ya[t]||Ya["gpt-4o-mini"],s=r/1e3*o.input,a=i/1e3*o.output,l=s+a,h={tokens:r+i,cost:l,requests:1,timestamp:new Date};this.usageCache.has(e)||this.usageCache.set(e,[]);const f=this.usageCache.get(e);f.push(h);const m=new Date;m.setDate(m.getDate()-30);const p=f.filter(g=>g.timestamp>=m);this.usageCache.set(e,p),this.monitoringService.recordRequest(e,n,0,!1,!1)}getCurrentMonthUsage(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1);let r=0,i=0,n=0;for(const[o,s]of this.usageCache){const a=s.filter(l=>l.timestamp>=t);r+=a.reduce((l,u)=>l+u.tokens,0),i+=a.reduce((l,u)=>l+u.cost,0),n+=a.reduce((l,u)=>l+u.requests,0)}return{tokens:r,cost:i,requests:n}}getDailyUsage(){const e=[],t=new Date;for(let r=6;r>=0;r--){const i=new Date(t);i.setDate(i.getDate()-r);const n=i.toISOString().split("T")[0];let o=0,s=0,a=0;for(const[l,u]of this.usageCache){const h=u.filter(f=>f.timestamp.toISOString().split("T")[0]===n);o+=h.reduce((f,m)=>f+m.tokens,0),s+=h.reduce((f,m)=>f+m.cost,0),a+=h.reduce((f,m)=>f+m.requests,0)}e.push({date:n,tokens:o,cost:s,requests:a})}return e}getFeatureBreakdown(){const e=this.getCurrentMonthUsage(),t=[];for(const[r,i]of this.usageCache){const n=new Date,o=new Date(n.getFullYear(),n.getMonth(),1),s=i.filter(h=>h.timestamp>=o),a=s.reduce((h,f)=>h+f.tokens,0),l=s.reduce((h,f)=>h+f.cost,0),u=e.tokens>0?a/e.tokens*100:0;a>0&&t.push({feature:r,tokens:a,cost:l,percentage:Math.round(u*10)/10})}return t.sort((r,i)=>i.tokens-r.tokens)}getBudgetData(){const t=this.getCurrentMonthUsage().tokens,r=Math.max(0,this.tokenLimit-t),i=t/this.tokenLimit*100;return{limit:this.tokenLimit,used:t,remaining:r,percentage:Math.round(i*10)/10}}getUsageData(){return{currentMonth:this.getCurrentMonthUsage(),dailyUsage:this.getDailyUsage(),featureBreakdown:this.getFeatureBreakdown(),budget:this.getBudgetData()}}setTokenLimit(e){this.tokenLimit=e}getTokenLimit(){return this.tokenLimit}isTokenLimitExceeded(){return this.getBudgetData().percentage>=100}shouldShowTokenLimitWarning(){return this.getBudgetData().percentage>=75}}class ar{constructor(){this.tokenUsageService=nr.getInstance()}static getInstance(){return ar.instance||(ar.instance=new ar),ar.instance}trackAnalyticsUsage(e,t,r){this.tokenUsageService.recordTokenUsage("Analytics Queries","gpt-4o-mini",e,t,r)}trackHelpUsage(e,t,r){this.tokenUsageService.recordTokenUsage("Help System","gpt-4o-mini",e,t,r)}trackCourseGenerationUsage(e,t,r){this.tokenUsageService.recordTokenUsage("Course Generation","gpt-4o-mini",e,t,r)}trackForecastingUsage(e,t,r){this.tokenUsageService.recordTokenUsage("Forecasting","gpt-4o-mini",e,t,r)}trackTaskAssignmentUsage(e,t,r){this.tokenUsageService.recordTokenUsage("Task Assignments","gpt-4o-mini",e,t,r)}trackUsage(e,t,r,i,n){this.tokenUsageService.recordTokenUsage(e,t,r,i,n)}getUsageData(){return this.tokenUsageService.getUsageData()}isTokenLimitExceeded(){return this.tokenUsageService.isTokenLimitExceeded()}shouldShowTokenLimitWarning(){return this.tokenUsageService.shouldShowTokenLimitWarning()}setTokenLimit(e){this.tokenUsageService.setTokenLimit(e)}}const Ja=ar.getInstance();var Jd={},re=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Xr{static askAI(e,t){return re(this,null,function*(){var r,i,n;const o=Jd.VITE_OPENAI_API_KEY;if(!o)throw new Error("AIServiceError: 401 - OpenAI API key not configured");const s=(t==null?void 0:t.module)||"unknown",a=(t==null?void 0:t.facilityId)||"unknown",l=(t==null?void 0:t.userId)||"unknown",u=e.length;e.substring(0,250).replace(/\n/g," ");const h={model:"gpt-4o-mini",messages:[{role:"system",content:"You are Cliniio's AI assistant, specializing in healthcare facility management, sterilization protocols, inventory management, and compliance workflows. Provide accurate, actionable insights based on the data provided."},{role:"user",content:e}],temperature:.3,max_tokens:1e3};let f=null;const m=[1e3,2e3,4e3];for(let g=0;g<=3;g++)try{const y=yield fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify(h)});if(!y.ok){const C=yield y.text().catch(()=>"Unknown error");throw new Error(`AIServiceError: ${y.status} - ${C}`)}const w=(n=(i=(r=(yield y.json()).choices)==null?void 0:r[0])==null?void 0:i.message)==null?void 0:n.content;if(!w)throw new Error("AIServiceError: 500 - No response content from OpenAI");try{yield d.from("ai_usage_logs").insert({facility_id:a,user_id:l,module:s,prompt_length:u,response_length:w.length,success:!0,model:"gpt-4o-mini",created_at:new Date().toISOString()})}catch(C){}const b=Math.ceil(u/4),E=Math.ceil(w.length/4);return Ja.trackUsage("General AI Questions","gpt-4o-mini",b,E,!0),w}catch(y){f=y instanceof Error?y:new Error(String(y));try{yield d.from("ai_usage_logs").insert({facility_id:a,user_id:l,module:s,prompt_length:u,response_length:0,success:!1,model:"gpt-4o-mini",created_at:new Date().toISOString()})}catch(_){}if(Ja.trackUsage("General AI Questions","gpt-4o-mini",0,0,!1),g<3){yield new Promise(_=>setTimeout(_,m[g]));continue}}const p=(f==null?void 0:f.message)||"Unknown error";throw hc.error("All AI service retries failed",{module:s,facilityId:a,userId:l},{error:p,attempts:3,lastError:f==null?void 0:f.message}),new Error(p)})}static executeOptimizedAI(e,t,r){return re(this,null,function*(){return Pt.getInstance().execute(e,t,r)})}static getLearningAI(e){return this.learningAIInstance||(this.learningAIInstance=new lc(e)),this.learningAIInstance}static getLearningRecommendations(e,t){return re(this,null,function*(){return this.getLearningAI(e).generatePersonalizedRecommendations(t)})}static analyzeSkillGaps(e,t){return re(this,null,function*(){return this.getLearningAI(e).analyzeSkillGaps(t)})}static optimizeLearningPath(e,t){return re(this,null,function*(){return this.getLearningAI(e).optimizeLearningPath(t)})}static getInventoryAI(e){return this.inventoryAIInstance||(this.inventoryAIInstance=new dc(e)),this.inventoryAIInstance}static analyzeBarcode(e,t){return re(this,null,function*(){return this.getInventoryAI(e).analyzeBarcode(t)})}static performImageRecognition(e,t){return re(this,null,function*(){return this.getInventoryAI(e).analyzeImage(t)})}static generateDemandForecast(e,t,r){return re(this,null,function*(){return this.getInventoryAI(e).generateDemandForecast(t,r)})}static generateCostOptimization(e,t){return re(this,null,function*(){return this.getInventoryAI(e).generateCostOptimization(t)})}static getSterilizationAI(e){return this.sterilizationAIInstance||(this.sterilizationAIInstance=new fc(e)),this.sterilizationAIInstance}static getSterilizationInsights(e){return re(this,null,function*(){return this.getSterilizationAI(e).getRealTimeInsights()})}static getSterilizationPredictiveAnalytics(e){return re(this,null,function*(){return this.getSterilizationAI(e).getPredictiveAnalytics()})}static getSterilizationRealTimeInsights(e){return re(this,null,function*(){return this.getSterilizationAI(e).getRealTimeInsights()})}static getSterilizationHistoricalTrends(e,t){return re(this,null,function*(){return this.getSterilizationAI(e).getHistoricalTrends(t)})}static getEnvironmentalAI(e){return this.environmentalAIInstance||(this.environmentalAIInstance=new mc(e)),this.environmentalAIInstance}static analyzeEnvironmentalData(e,t){return re(this,null,function*(){return this.getEnvironmentalAI(e).generatePredictiveCleaning(t)})}static generateEnvironmentalInsights(e){return re(this,null,function*(){return this.getEnvironmentalAI(e).getEnvironmentalInsights()})}static initializeServices(e){return re(this,null,function*(){try{yield this.getLearningAI(e).initialize(),yield this.getInventoryAI(e).initializeSettings(),yield this.getEnvironmentalAI(e).initialize(),console.log(`[UnifiedAIService] All AI services initialized for facility: ${e}`)}catch(t){throw console.error("[UnifiedAIService] Failed to initialize AI services:",t),t}})}static getServiceStatus(){return{learningAI:!!this.learningAIInstance,inventoryAI:!!this.inventoryAIInstance,sterilizationAI:!!this.sterilizationAIInstance,environmentalAI:!!this.environmentalAIInstance}}static clearInstances(){this.learningAIInstance=null,this.inventoryAIInstance=null,this.sterilizationAIInstance=null,this.environmentalAIInstance=null}}Xr.learningAIInstance=null;Xr.inventoryAIInstance=null;Xr.sterilizationAIInstance=null;Xr.environmentalAIInstance=null;var Or=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Xd{getArticlesByCategory(e){return Or(this,null,function*(){try{const{data:t,error:r}=yield d.from("help_articles").select("id, slug, title, excerpt, category, subcategory, priority, is_featured, view_count, is_published").eq("category",e).eq("is_published",!0).order("priority",{ascending:!0}).order("created_at",{ascending:!1});return r?(console.error("Error fetching help articles:",r),[]):t||[]}catch(t){return console.error("Error fetching help articles:",t),[]}})}getArticleBySlug(e){return Or(this,null,function*(){try{const{data:t,error:r}=yield d.from("help_articles").select("*").eq("slug",e).eq("is_published",!0).single();return r?(console.error("Error fetching help article:",r),null):t}catch(t){return console.error("Error fetching help article:",t),null}})}incrementViewCount(e){return Or(this,null,function*(){try{const{data:t}=yield d.from("help_articles").select("view_count").eq("slug",e).single();t&&(yield d.from("help_articles").update({view_count:t.view_count+1,last_viewed_at:new Date().toISOString()}).eq("slug",e))}catch(t){console.error("Error incrementing view count:",t)}})}getFeaturedArticles(e=3){return Or(this,null,function*(){try{const{data:t,error:r}=yield d.from("help_articles").select("id, slug, title, excerpt, category, subcategory, priority, is_featured, view_count, is_published").eq("is_published",!0).eq("is_featured",!0).order("priority",{ascending:!0}).order("view_count",{ascending:!1}).limit(e);return r?(console.error("Error fetching featured articles:",r),[]):t||[]}catch(t){return console.error("Error fetching featured articles:",t),[]}})}searchArticles(e,t){return Or(this,null,function*(){try{let r=d.from("help_articles").select("id, slug, title, excerpt, category, subcategory, priority, is_featured, view_count, is_published").eq("is_published",!0).or(`title.ilike.%${e}%,excerpt.ilike.%${e}%`);t&&(r=r.eq("category",t));const{data:i,error:n}=yield r.order("priority",{ascending:!0}).order("view_count",{ascending:!1});return n?(console.error("Error searching help articles:",n),[]):i||[]}catch(r){return console.error("Error searching help articles:",r),[]}})}}const kv=new Xd;var Xa=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Pv={submitFeedback(c){return Xa(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)return{success:!1,error:"User not authenticated"};const{error:t}=yield d.from("product_feedback").insert([{type:c.type,title:c.title,description:c.description,priority:c.priority,user_id:e.id,contact_email:c.email,page_url:window.location.href,user_agent:navigator.userAgent,browser_info:{language:navigator.language,platform:navigator.platform,cookieEnabled:navigator.cookieEnabled}}]);return t?(console.error("Error submitting feedback:",t),{success:!1,error:t.message}):{success:!0}}catch(e){return console.error("Error submitting feedback:",e),{success:!1,error:e instanceof Error?e.message:"An unknown error occurred"}}})},getFeedbackHistory(){return Xa(this,null,function*(){try{const{data:{user:c}}=yield d.auth.getUser();if(!c)return{data:[],error:"User not authenticated"};const{data:e,error:t}=yield d.from("product_feedback").select("*").eq("user_id",c.id).order("created_at",{ascending:!1});return t?(console.error("Error fetching feedback history:",t),{data:[],error:t.message}):{data:e||[]}}catch(c){return console.error("Error fetching feedback history:",c),{data:[],error:"Failed to fetch feedback history"}}})}};var Za=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Cv={fetchStats(){return Za(this,null,function*(){const{data:{user:c},error:e}=yield d.auth.getUser();if(e||!c)return console.error("Stats fetch blocked — no authenticated user"),null;const{data:t,error:r}=yield d.from("users").select("facility_id").eq("id",c.id).single();if(r||!(t!=null&&t.facility_id))return console.error("Missing facility_id in user profile"),null;const i=t.facility_id,{data:n,error:o}=yield d.from("user_stats").select("*").eq("facility_id",i).eq("user_id",c.id).single();return o?(console.error("Error fetching stats:",o),null):n})},fetchCumulativeStats(){return Za(this,null,function*(){const{data:{user:c},error:e}=yield d.auth.getUser();return e||!c?(console.error("Cumulative stats fetch blocked — no authenticated user"),{toolsSterilized:0,inventoryChecks:0,perfectDays:0,totalTasks:0,completedTasks:0,currentStreak:0,bestStreak:0,totalPoints:0,challengesCompleted:0,totalChallenges:0}):{toolsSterilized:23,inventoryChecks:15,perfectDays:7,totalTasks:12,completedTasks:8,currentStreak:3,bestStreak:12,totalPoints:450,challengesCompleted:5,totalChallenges:8}})}};var Zd=Object.defineProperty,eh=Object.defineProperties,th=Object.getOwnPropertyDescriptors,eo=Object.getOwnPropertySymbols,rh=Object.prototype.hasOwnProperty,ih=Object.prototype.propertyIsEnumerable,to=(c,e,t)=>e in c?Zd(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,nh=(c,e)=>{for(var t in e||(e={}))rh.call(e,t)&&to(c,t,e[t]);if(eo)for(var t of eo(e))ih.call(e,t)&&to(c,t,e[t]);return c},ah=(c,e)=>eh(c,th(e)),bn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Dv={createChallenge(c){return bn(this,null,function*(){try{const{data:{user:e},error:t}=yield d.auth.getUser();if(t||!e)throw new Error("Unauthorized: no authenticated user.");const{data:r,error:i}=yield d.from("users").select("facility_id, role").eq("id",e.id).single();if(i||!(r!=null&&r.facility_id))throw new Error("Missing facility context.");const n=r.facility_id,o=r.role||"staff";if(!["admin","manager"].includes(o))throw new Error("Forbidden: insufficient permissions to create challenges.");const a={title:c.title,description:c.description||"",points:c.points||0,facility_id:n,created_by:e.id,created_at:new Date().toISOString()},{data:l,error:u}=yield d.from("home_challenges").insert([a]).select().single();if(u)throw new Error(u.message);return console.info(`✅ Challenge created by ${o}:`,l.title),{success:!0,data:l}}catch(e){return console.error("❌ Challenge creation failed:",e instanceof Error?e.message:String(e)),{success:!1,error:e instanceof Error?e.message:String(e)}}})},fetchUserChallenges(){return bn(this,null,function*(){try{const{data:{user:c},error:e}=yield d.auth.getUser();if(e||!c)return console.warn("⚠️ No authenticated user, returning empty challenges"),[];const{data:t,error:r}=yield d.from("users").select("facility_id").eq("id",c.id).single();if(r||!(t!=null&&t.facility_id))return console.warn("⚠️ Missing facility context, returning empty challenges"),[];const i=t.facility_id,n=`challenges_and_completions:${i}`,o=Wi.get(n);if(o)return console.info("🧠 Loaded challenges from cache:",o.length),o;const[s,a]=yield Promise.all([d.from("home_challenges").select("*").eq("facility_id",i).order("created_at",{ascending:!1}),d.from("home_challenge_completions").select("challenge_id, user_id, completed_at").eq("facility_id",i).eq("user_id",c.id)]);if(s.error)throw new Error(s.error.message);if(a.error)throw new Error(a.error.message);const l=s.data||[],u=a.data||[],h=l.map(f=>{var m;return ah(nh({},f),{isCompleted:u.some(p=>p.challenge_id===f.id),completedAt:((m=u.find(p=>p.challenge_id===f.id))==null?void 0:m.completed_at)||null})});return Wi.set(n,h),console.info(`✅ Cached ${h.length} merged challenges for ${i}`),h}catch(c){return console.error("❌ Failed to fetch challenges:",c instanceof Error?c.message:String(c)),[]}})},completeChallenge(c){return bn(this,null,function*(){var e,t;try{const{data:{user:r},error:i}=yield d.auth.getUser();if(i||!r)throw new Error("Unauthorized: no authenticated user.");let n=((e=r.user_metadata)==null?void 0:e.facility_id)||((t=r.app_metadata)==null?void 0:t.facility_id);if(!n){const{data:l,error:u}=yield d.from("users").select("facility_id").eq("id",r.id).single();if(u||!(l!=null&&l.facility_id))throw new Error("Missing facility context.");n=l.facility_id}const{data:o,error:s}=yield d.from("challenge_completions").select("id").eq("challenge_id",c.challenge_id).eq("user_id",r.id).eq("facility_id",n).single();if(s&&s.code!=="PGRST116")throw new Error(s.message);if(o)return console.warn("Challenge already completed by user"),!0;const{error:a}=yield d.from("home_challenge_completions").insert([{challenge_id:c.challenge_id,user_id:r.id,facility_id:n,points_earned:c.points_earned,completed_at:new Date().toISOString()}]);if(a)throw new Error(a.message);return console.info(`✅ Challenge ${c.challenge_id} completed by user ${r.id}`),!0}catch(r){return console.error("❌ Challenge completion failed:",r instanceof Error?r.message:String(r)),!1}})}};var oh=Object.defineProperty,sh=Object.defineProperties,ch=Object.getOwnPropertyDescriptors,ro=Object.getOwnPropertySymbols,lh=Object.prototype.hasOwnProperty,uh=Object.prototype.propertyIsEnumerable,io=(c,e,t)=>e in c?oh(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,dh=(c,e)=>{for(var t in e||(e={}))lh.call(e,t)&&io(c,t,e[t]);if(ro)for(var t of ro(e))uh.call(e,t)&&io(c,t,e[t]);return c},hh=(c,e)=>sh(c,ch(e)),no=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Ov={fetchLeaderboard(c){return no(this,null,function*(){var e;let t=c;if(!t){const{data:{user:o},error:s}=yield d.auth.getUser();if(s||!o)return console.error("Leaderboard fetch blocked — no authenticated user"),[];t=(e=o.user_metadata)==null?void 0:e.facility_id}if(!t)return console.warn("No facility ID available for leaderboard fetch"),[];const{data:r,error:i}=yield d.from("user_gamification_stats").select(`
        id,
        user_id,
        facility_id,
        total_points,
        completed_tasks,
        current_streak,
        best_streak,
        created_at,
        updated_at,
        user_facilities!inner(user_id, users!inner(email, user_metadata))
      `).eq("facility_id",t).order("total_points",{ascending:!1});return i?(console.error("Error fetching leaderboard:",i),[]):(r||[]).map((o,s)=>{var a,l,u,h,f,m,p,g,y,_;return hh(dh({},o),{rank:s+1,user_name:((f=(h=(u=(l=(a=o.user_facilities)==null?void 0:a[0])==null?void 0:l.users)==null?void 0:u[0])==null?void 0:h.email)==null?void 0:f.split("@")[0])||"Anonymous",department:((_=(y=(g=(p=(m=o.user_facilities)==null?void 0:m[0])==null?void 0:p.users)==null?void 0:g[0])==null?void 0:y.user_metadata)==null?void 0:_.department)||"Unknown",points:o.total_points})})})},fetchLeaderboardData(c){return no(this,null,function*(){return this.fetchLeaderboard(c)})}};var fh=Object.defineProperty,ao=Object.getOwnPropertySymbols,mh=Object.prototype.hasOwnProperty,ph=Object.prototype.propertyIsEnumerable,oo=(c,e,t)=>e in c?fh(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,gh=(c,e)=>{for(var t in e||(e={}))mh.call(e,t)&&oo(c,t,e[t]);if(ao)for(var t of ao(e))ph.call(e,t)&&oo(c,t,e[t]);return c};const fe={maxTasksPerUser:3,enabledCategories:["equipment","compliance","operational","safety"],priorityThresholds:{low:1,medium:2,high:3,urgent:4},priorityWeights:{low:1,medium:2,high:3,urgent:4},rolePreferences:{technician:["equipment","compliance"],operator:["operational","compliance"],cleaning_staff:["compliance"],inventory_manager:["operational"],supervisor:["safety","operational"]},timeConstraints:{maxTaskDuration:120,minTaskDuration:5},autoAssignment:!0,aiSensitivity:"medium",aiEnabled:!0},yh={urgent:4,high:3,medium:2,low:1},_h={equipment:["technician","maintenance"],compliance:["supervisor","manager","operator"],operational:["operator","inventory_manager"],safety:["supervisor","manager"]};function vh(c){var e,t,r,i,n,o,s,a,l,u,h,f,m,p,g,y;return{maxTasksPerUser:(e=c.maxTasksPerUser)!=null?e:fe.maxTasksPerUser,enabledCategories:(t=c.enabledCategories)!=null?t:fe.enabledCategories,priorityThresholds:{low:(i=(r=c.priorityThresholds)==null?void 0:r.low)!=null?i:fe.priorityThresholds.low,medium:(o=(n=c.priorityThresholds)==null?void 0:n.medium)!=null?o:fe.priorityThresholds.medium,high:(a=(s=c.priorityThresholds)==null?void 0:s.high)!=null?a:fe.priorityThresholds.high,urgent:(u=(l=c.priorityThresholds)==null?void 0:l.urgent)!=null?u:fe.priorityThresholds.urgent},priorityWeights:(h=c.priorityWeights)!=null?h:fe.priorityWeights,rolePreferences:(f=c.rolePreferences)!=null?f:fe.rolePreferences,timeConstraints:(m=c.timeConstraints)!=null?m:fe.timeConstraints,autoAssignment:(p=c.autoAssignment)!=null?p:fe.autoAssignment,aiSensitivity:(g=c.aiSensitivity)!=null?g:fe.aiSensitivity,aiEnabled:(y=c.aiEnabled)!=null?y:fe.aiEnabled}}function so(c){return yh[c]}function pc(c,e){const t=_h[e];return t?t.includes(c):!0}function En(){return gh({},fe)}var mi=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class wh{calculateLevel(e){return e<100?1:e<250?2:e<500?3:e<750?4:e<1e3?5:Math.floor(Math.log(e/100)/Math.log(1.5))+5}calculatePointsToNextLevel(e,t){const r=this.getLevelThreshold(e+1);return Math.max(0,r-t)}getLevelThreshold(e){return e<=1?0:e<=5?[0,100,250,500,750,1e3][e-1]:Math.floor(100*Math.pow(1.5,e-5))}calculateUserRank(e,t){return mi(this,null,function*(){try{const{data:r,error:i}=yield d.from("home_challenge_completions").select("user_id, points_earned").eq("facility_id",t);if(i)return console.error("Error fetching facility users for ranking:",i),{rank:1,percentile:100};const n=new Map;r==null||r.forEach(u=>{const h=u.user_id,f=u.points_earned;n.set(h,(n.get(h)||0)+f)});const o=Array.from(n.entries()).sort(([,u],[,h])=>h-u),s=o.findIndex(([u])=>u===e),a=s===-1?o.length:s+1,l=Math.round((1-(a-1)/o.length)*100);return{rank:a,percentile:l}}catch(r){return console.error("Error calculating user rank:",r),{rank:1,percentile:100}}})}updateGamificationData(e){return mi(this,null,function*(){try{const{data:t,error:r}=yield d.from("home_challenge_completions").select("points_earned").eq("user_id",e.userId).eq("facility_id",e.facilityId);if(r)throw console.error("Error fetching user completions:",r),r;const i=(t||[]).reduce((h,f)=>h+f.points_earned,0),n=this.calculateLevel(i),o=n+1,s=this.calculatePointsToNextLevel(n,i),{rank:a,percentile:l}=yield this.calculateUserRank(e.userId,e.facilityId),u={currentLevel:n,nextLevel:o,pointsToNextLevel:s,totalPoints:i,rank:a,rankPercentile:l};return v.info("Gamification update:",{userId:e.userId,pointsEarned:e.pointsEarned,totalPoints:i,currentLevel:n,rank:a,taskTitle:e.taskTitle}),u}catch(t){throw console.error("Error updating gamification data:",t),t}})}checkLevelUp(e,t,r){return mi(this,null,function*(){try{const{data:i,error:n}=yield d.from("home_challenge_completions").select("points_earned").eq("user_id",e).eq("facility_id",t);if(n)return console.error("Error fetching user completions for level check:",n),!1;const o=(i||[]).reduce((l,u)=>l+u.points_earned,0),s=this.calculateLevel(r);return this.calculateLevel(o)>s}catch(i){return console.error("Error checking level up:",i),!1}})}getGamificationSummary(e,t){return mi(this,null,function*(){try{const{data:r,error:i}=yield d.from("home_challenge_completions").select("points_earned").eq("user_id",e).eq("facility_id",t);if(i)throw console.error("Error fetching gamification summary:",i),i;const n=(r||[]).reduce((h,f)=>h+f.points_earned,0),o=this.calculateLevel(n),s=o+1,a=this.calculatePointsToNextLevel(o,n),{rank:l,percentile:u}=yield this.calculateUserRank(e,t);return{currentLevel:o,nextLevel:s,pointsToNextLevel:a,totalPoints:n,rank:l,rankPercentile:u}}catch(r){throw console.error("Error getting gamification summary:",r),r}})}}const Ih=new wh;var Sh=Object.defineProperty,co=Object.getOwnPropertySymbols,bh=Object.prototype.hasOwnProperty,Eh=Object.prototype.propertyIsEnumerable,lo=(c,e,t)=>e in c?Sh(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,gc=(c,e)=>{for(var t in e||(e={}))bh.call(e,t)&&lo(c,t,e[t]);if(co)for(var t of co(e))Eh.call(e,t)&&lo(c,t,e[t]);return c},nn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function rt(){return`gap-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function Ah(){return`task-${Date.now()}-${Math.random()}`}function Th(){return`ai-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function kh(c,e){return nn(this,null,function*(){try{for(const t of c)for(const r of t.tasks){const{error:i}=yield d.from("home_daily_operations_tasks").insert({facility_id:e,title:r.title,description:r.description,completed:!1,points:r.points,type:r.type,category:r.category,priority:r.priority,due_date:r.dueDate,estimated_duration:r.estimatedDuration,status:"pending",assigned_to:t.userId,created_by:Le(t.userId)||t.userId,created_at:r.createdAt,updated_at:r.updatedAt});i&&console.error("Error creating daily task:",i)}}catch(t){throw console.error("Error creating daily tasks:",t),t}})}function Ph(c){return nn(this,null,function*(){const{data:e,error:t}=yield d.from("home_daily_operations_tasks").select("*").eq("assigned_to",c).eq("status","pending").order("priority",{ascending:!1}).order("due_date",{ascending:!0});if(t)throw t;return(e||[]).map(r=>gc({id:r.id},r))})}function Ch(c){return nn(this,null,function*(){const{data:e,error:t}=yield d.from("home_daily_operations_tasks").select("*").eq("facility_id",c).eq("status","pending").order("priority",{ascending:!1}).order("due_date",{ascending:!0});if(t)throw t;return(e||[]).map(r=>gc({id:r.id},r))})}function Dh(c,e){return nn(this,null,function*(){try{const{data:t,error:r}=yield d.from("home_daily_operations_tasks").select("points, facility_id, title, category").eq("id",c).single();if(r||!t)throw new Error(`Task not found: ${(r==null?void 0:r.message)||"Unknown error"}`);const i=t.points||0,{error:n}=yield d.from("home_daily_operations_tasks").update({completed:!0,status:"completed",completed_by:e,completed_at:new Date().toISOString()}).eq("id",c);if(n)throw new Error(`Failed to complete task: ${n.message}`);if(i>0){const{error:o}=yield d.from("home_challenge_completions").insert({challenge_id:c,user_id:e,facility_id:t.facility_id,points_earned:i,completion_type:"daily_task",task_title:t.title,task_category:t.category});if(o)console.error("Failed to award points for task completion:",o);else{console.log(`Awarded ${i} points for completing task: ${t.title}`);try{const s=yield Ih.updateGamificationData({userId:e,facilityId:t.facility_id,pointsEarned:i,taskTitle:t.title,taskCategory:t.category});s.currentLevel>1&&console.log(`🎉 Level up! User ${e} reached level ${s.currentLevel}`),console.log("Gamification updated:",{level:s.currentLevel,totalPoints:s.totalPoints,rank:s.rank,pointsToNextLevel:s.pointsToNextLevel})}catch(s){console.error("Error updating gamification data:",s)}}}}catch(t){throw console.error("Error completing daily task:",t),t}})}var se=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Oh(){return se(this,null,function*(){const{data:{user:c}}=yield d.auth.getUser();if(!c)throw new Error("User not authenticated");return c.id})}function ve(){return se(this,null,function*(){const{data:{user:c}}=yield d.auth.getUser();if(!c)throw new Error("User not authenticated");const{data:e,error:t}=yield d.from("users").select("facility_id").eq("id",c.id).single();if(t||!e)throw new Error("Failed to get user facility");return e.facility_id})}const pe={getToolByBarcode(c){return se(this,null,function*(){const e=yield ve(),{data:t,error:r}=yield d.from("tools").select("*").eq("barcode",c).eq("facility_id",e).maybeSingle();return r?(console.error("ToolService.getToolByBarcode error:",r),null):t})},getToolsByStatus(c){return se(this,null,function*(){const e=yield ve(),{data:t,error:r}=yield d.from("tools").select("*").eq("status",c).eq("facility_id",e);return r?(console.error("ToolService.getToolsByStatus error:",r),[]):t||[]})},updateToolStatus(c,e){return se(this,null,function*(){if(c.startsWith("mock-tool-"))return console.log("🧪 Skipping database update for mock tool:",c),{id:c,status:e,updated_at:new Date().toISOString()};const t={status:e,facility_id:yield ve(),updated_at:new Date().toISOString()},{data:r,error:i}=yield d.from("tools").update(t).eq("id",c).select().single();if(i)throw i;return r})},getToolByBarcodeAndStatus(c,e){return se(this,null,function*(){if(c==="TEST-CLEAN-001"&&e==="clean")return console.log("🧪 Using mock tool data for testing Clean Tool workflow"),{id:"mock-tool-test-clean-001",barcode:"TEST-CLEAN-001",tool_type:"surgical_scissors",tool_name:"Test Surgical Scissors",status:"clean",facility_id:"550e8400-e29b-41d4-a716-446655440000",current_cycle_id:"00000000-0000-0000-0000-000000000000",location:"Sterilization Room",sterilization_count:0,notes:"Mock tool for testing Clean Tool workflow",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),latitude:null,longitude:null,gps_accuracy:null,location_timestamp:null,maintenance_due_date:null,metadata:null,model:"Test Model",manufacturer:"Test Manufacturer",serial_number:"TEST-001",is_p2_tool:!1};const t=yield ve(),{data:r,error:i}=yield d.from("tools").select("id, tool_name, barcode, facility_id, current_cycle_id, status, is_p2_tool").eq("barcode",c).eq("status",e).eq("facility_id",t).single();if(i)throw i;return r})},getToolsByFacilityAndStatus(c,e){return se(this,null,function*(){const{data:t,error:r}=yield d.from("tools").select("id, tool_name, barcode, facility_id, current_cycle_id, status, is_p2_tool").eq("facility_id",c).eq("status",e);if(r)throw r;return t})},getToolsByStatuses(c){return se(this,null,function*(){const e=yield ve(),{data:t,error:r}=yield d.from("tools").select("id, tool_name, barcode, facility_id, current_cycle_id, status, is_p2_tool").in("status",c).eq("facility_id",e);if(r)throw r;return t})},updateToolsStatus(c,e){return se(this,null,function*(){const t={status:e,facility_id:yield ve(),updated_at:new Date().toISOString()},{data:r,error:i}=yield d.from("tools").update(t).in("id",c).select();if(i)throw i;return r!=null?r:[]})},updateToolsCyclePhase(c,e,t,r){return se(this,null,function*(){const i={status:e,facility_id:yield ve(),updated_at:new Date().toISOString()},{data:n,error:o}=yield d.from("tools").update(i).in("id",c).select();if(o)throw o;return n!=null?n:[]})},clearCycleAssignment(c,e){return se(this,null,function*(){const t=c.filter(s=>s.startsWith("mock-tool-")),r=c.filter(s=>!s.startsWith("mock-tool-"));if(t.length>0&&console.log("🧪 Skipping database update for mock tools:",t),r.length===0)return t.map(s=>({id:s,status:e,current_cycle_id:"00000000-0000-0000-0000-000000000000",current_phase:null,updated_at:new Date().toISOString()}));const i={status:e,facility_id:yield ve(),updated_at:new Date().toISOString()},{data:n,error:o}=yield d.from("tools").update(i).in("id",r).select();if(o)throw o;return n!=null?n:[]})},markAsSterilized(c){return se(this,null,function*(){if(c.startsWith("mock-tool-"))return console.log("🧪 Skipping database update for mock tool:",c),{id:c,last_sterilized:new Date().toISOString(),updated_at:new Date().toISOString()};const e={facility_id:yield ve(),updated_at:new Date().toISOString()},{data:t,error:r}=yield d.from("tools").update(e).eq("id",c).select().single();if(r)throw r;return t})},updateToolPhase(c,e){return se(this,null,function*(){const t={facility_id:yield ve(),updated_at:new Date().toISOString()},{data:r,error:i}=yield d.from("tools").update(t).eq("id",c).select().single();if(i)throw i;return r})},touchTools(c){return se(this,null,function*(){const e={facility_id:yield ve(),updated_at:new Date().toISOString()},{data:t,error:r}=yield d.from("tools").update(e).in("id",c).select();if(r)throw r;return t!=null?t:[]})},persistProblemTool(c,e,t){return se(this,null,function*(){if(c.startsWith("mock-tool-"))return console.log("🧪 Skipping database update for mock tool:",c),{id:c,status:"problem",updated_at:new Date().toISOString()};const r=yield ve(),i=yield Oh(),n={status:"problem",facility_id:r,updated_at:new Date().toISOString(),notes:t?`PROBLEM: ${e} - ${t}`:`PROBLEM: ${e}`},{data:o,error:s}=yield d.from("tools").update(n).eq("id",c).select().single();if(s)throw s;yield this.clearCycleAssignment([c],"problem");const{error:a}=yield d.from("audit_logs").insert({id:crypto.randomUUID(),module:"sterilization",table_name:"tools",action:"tool_marked_problem",record_id:c,user_id:i,facility_id:r,old_values:{status:"available"},new_values:{status:"problem",notes:n.notes},metadata:{problem_type:e,problem_notes:t,timestamp:new Date().toISOString()},created_at:new Date().toISOString()});return a&&console.error("Failed to log problem tool audit event:",a),yield d.from("inventory_items").update({is_available:!1}).eq("tool_id",c).eq("facility_id",r),o})}};var An=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Qe{static applyFilters(e,t){if(!t)return e;let r=e;return t.category&&(r=r.eq("category",t.category)),t.status&&(r=r.eq("status",t.status)),t.location&&(r=r.eq("location",t.location)),t.search&&(r=r.or(`name.ilike.%${t.search}%,category.ilike.%${t.search}%`)),r}static applyFiltersToTable(e,t,r){return An(this,null,function*(){const{data:{user:i},error:n}=yield e.auth.getUser();if(n||!i)throw new Error("User not authenticated");const{data:o,error:s}=yield e.from("users").select("facility_id").eq("id",i.id).single();if(s||!(o!=null&&o.facility_id))throw new Error("User facility not found");const a=o.facility_id,u=e.from(t).select(`
      id,
      name,
      category,
      quantity,
      unit_cost,
      reorder_point,
      expiration_date,
      data,
      created_at,
      updated_at
    `,{count:"exact"}).eq("facility_id",a);return this.applyFilters(u,r)})}static applyFiltersToSelect(e,t,r,i){const n=e.from(t).select(r,{count:"exact"});return this.applyFilters(n,i)}static applyFiltersToSingle(e,t,r){return e.from(t).select("*").eq("id",r).single()}static applyFiltersToCategories(e,t){return An(this,null,function*(){const{data:{user:r},error:i}=yield e.auth.getUser();if(i||!r)throw new Error("User not authenticated");const{data:n,error:o}=yield e.from("users").select("facility_id").eq("id",r.id).single();if(o||!(n!=null&&n.facility_id))throw new Error("User facility not found");const s=n.facility_id;return e.from(t).select("category").eq("facility_id",s).not("category","is",null)})}static applyFiltersToLocations(e,t){return An(this,null,function*(){const{data:{user:r},error:i}=yield e.auth.getUser();if(i||!r)throw new Error("User not authenticated");const{data:n,error:o}=yield e.from("users").select("facility_id").eq("id",r.id).single();if(o||!(n!=null&&n.facility_id))throw new Error("User facility not found");const s=n.facility_id;return e.from(t).select("location").eq("facility_id",s).not("location","is",null)})}static extractUniqueValues(e,t){return Array.from(new Set((e==null?void 0:e.map(r=>r[t]))||[]))}static buildSearchQuery(e,t=["name","category"]){return t.map(r=>`${r}.ilike.%${e}%`).join(",")}static validateFilters(e){if(!e)return!0;if(e.search&&e.search.trim().length<2)return!1;const t=["active","inactive","p2","n/a"];return!(e.status&&!t.includes(e.status))}static getFilterSummary(e){if(!e)return"no filters";const t=[];return e.category&&t.push(`category: ${e.category}`),e.status&&t.push(`status: ${e.status}`),e.location&&t.push(`location: ${e.location}`),e.search&&t.push(`search: "${e.search}"`),t.length>0?t.join(", "):"no filters"}}class le{static handleError(e,t){throw console.error(`❌ ${t} failed:`,e),e&&typeof e=="object"&&"message"in e?We(e):new Error(`${t} failed: ${e}`)}static handleResponse(e,t){return e.error&&this.handleError(e.error,t),e.data}static logStart(e,t){}static logSuccess(e,t){}static logFailure(e,t){console.error(`❌ ${e} failed:`,t)}}var Rh=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function $h(){return Rh(this,null,function*(){return yield T(()=>Promise.resolve().then(()=>rg),void 0)})}var ze=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Mh=c=>c instanceof Error?c:typeof c=="object"&&c!==null&&"message"in c?new Error(String(c.message)):new Error("Unknown Supabase error occurred");class q{static getTypedAdapter(){return ze(this,null,function*(){const{TypedSupabaseAdapter:e}=yield $h();return new e})}static getItems(e){return ze(this,null,function*(){const t="Fetching inventory items";Qe.getFilterSummary(e);try{if(!Qe.validateFilters(e))throw new Error("Invalid filter parameters");const i=yield(yield this.getTypedAdapter()).getAllItems({filters:e,orderBy:{column:"created_at",ascending:!1}});if(!i.success||!Array.isArray(i.data))throw new Error(i.error||"Failed to fetch inventory items");const n=i.data;return le.logSuccess(t,`${n.length} items`),{data:n,error:null,count:i.processedCount}}catch(r){throw console.error("❌ InventoryCrudOperations.getItems failed:",r),le.logFailure(t,r),r}})}static getItemById(e){return ze(this,null,function*(){const t=`Fetching inventory item by ID: ${e}`;try{const i=yield(yield this.getTypedAdapter()).getItemById(e);if(!i.success||!i.data)throw new Error(i.error||"Failed to fetch inventory item");const n=i.data;return le.logSuccess(t,n.name||"Unknown"),n}catch(r){throw le.logFailure(t,r),r}})}static createItem(e){return ze(this,null,function*(){var t,r,i,n,o,s;const a=`Creating inventory item: ${e.name}`;try{const u=yield(yield this.getTypedAdapter()).createItem({facility_id:e.facility_id||"",name:e.name||"",quantity:(t=e.quantity)!=null?t:void 0,data:(r=e.data)!=null?r:void 0,reorder_point:(i=e.reorder_point)!=null?i:void 0,expiration_date:(n=e.expiration_date)!=null?n:void 0,unit_cost:(o=e.unit_cost)!=null?o:void 0,category:(s=e.category)!=null?s:void 0});if(!u.success||!u.data)throw new Error(u.error||"Failed to create inventory item");return le.logSuccess(a,u.data.name||"Unknown"),u.data}catch(l){throw le.logFailure(a,l),l}})}static updateItem(e,t){return ze(this,null,function*(){var r,i,n,o,s,a,l;try{const h=yield(yield this.getTypedAdapter()).updateItem(e,{name:(r=t.name)!=null?r:void 0,quantity:(i=t.quantity)!=null?i:void 0,data:(n=t.data)!=null?n:void 0,reorder_point:(o=t.reorder_point)!=null?o:void 0,expiration_date:(s=t.expiration_date)!=null?s:void 0,unit_cost:(a=t.unit_cost)!=null?a:void 0,category:(l=t.category)!=null?l:void 0});if(!h.success||!h.data)throw new Error(h.error||"Failed to update inventory item");return h.data}catch(u){throw console.error("❌ Failed to update item in Supabase:",u),u}})}static deleteItem(e){return ze(this,null,function*(){const t=`Deleting inventory item: ${e}`;try{const i=yield(yield this.getTypedAdapter()).deleteItem(e);if(!i.success)throw new Error(i.error||"Failed to delete inventory item");le.logSuccess(t,`Deleted ${e}`)}catch(r){throw le.logFailure(t,r),r}})}static archiveItem(e,t){return ze(this,null,function*(){const r=`Archiving inventory item: ${e}`;try{const{data:{user:i}}=yield d.auth.getUser();if(!i)throw new Error("User not authenticated");const o=yield(yield this.getTypedAdapter()).updateItem(e,{archived:!0,archived_at:new Date().toISOString(),archived_by:i.id,archive_reason:t||"User requested deletion"});if(!o.success)throw new Error(o.error||"Failed to archive inventory item");le.logSuccess(r,`Archived ${e}`)}catch(i){throw le.logFailure(r,i),i}})}static getCategories(){return ze(this,null,function*(){const e="Fetching inventory categories";try{const r=yield(yield this.getTypedAdapter()).getAllItems();if(!r.success||!r.data)throw new Error(r.error||"Failed to fetch categories");const i=Array.from(new Set(r.data.map(n=>n.category).filter(n=>!!n)));return le.logSuccess(e,`${i.length} categories`),i}catch(t){throw le.logFailure(e,t),t}})}static getLocations(){return ze(this,null,function*(){const e="Fetching inventory locations";try{const r=yield(yield this.getTypedAdapter()).getAllItems();if(!r.success||!r.data)throw new Error(r.error||"Failed to fetch locations");const i=Array.from(new Set(r.data.map(n=>{const o=n.data;return o==null?void 0:o.location}).filter(n=>!!n)));return le.logSuccess(e,`${i.length} locations`),i}catch(t){throw le.logFailure(e,t),t}})}static getAnalytics(){return ze(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:t}=yield d.from("users").select("facility_id").eq("id",e.id).single(),r=(t==null?void 0:t.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{data:i,error:n}=yield d.from("inventory_items").select("*").eq("facility_id",r);if(n)throw console.error("❌ Error fetching analytics from Supabase:",n),Mh(n);const o=i||[],s=o.length,a=o.length,l=o.reduce((h,f)=>h+(f.unit_cost||0),0),u={};return o.forEach(h=>{const f=h.category;f&&(u[f]=(u[f]||0)+1)}),{totalItems:s,activeItems:a,totalValue:l,categories:u}}catch(e){throw console.error("❌ Failed to fetch analytics from Supabase:",e),e}})}}function yc(c){const e=[];return(!c.name||c.name.trim().length===0)&&e.push("Name is required"),(!c.category||c.category.trim().length===0)&&e.push("Category is required"),(!c.location||c.location.trim().length===0)&&e.push("Location is required"),c.quantity!==void 0&&c.quantity<0&&e.push("Quantity cannot be negative"),c.quantity!==void 0&&c.quantity<0&&e.push("Minimum quantity cannot be negative"),c.quantity!==void 0&&c.quantity<0&&e.push("Maximum quantity cannot be negative"),c.quantity!==void 0&&c.quantity!==void 0&&c.quantity>c.quantity&&e.push("Minimum quantity cannot be greater than maximum quantity"),c.cost!==void 0&&c.cost<0&&e.push("Cost cannot be negative"),c.expiration_date&&new Date(c.expiration_date)<new Date&&e.push("Expiration date cannot be in the past"),c.serialNumber&&c.serialNumber.trim().length===0&&e.push("Serial number cannot be empty"),c.barcode&&c.barcode.trim().length===0&&e.push("Barcode cannot be empty"),{isValid:e.length===0,errors:e}}function Qi(c){var e,t,r,i,n,o,s;const a={name:(e=c.name)==null?void 0:e.trim(),description:(t=c.description)==null?void 0:t.trim(),category:(r=c.category)==null?void 0:r.trim(),location:(i=c.location)==null?void 0:i.trim(),status:c.status||"available",quantity:c.quantity||0,cost:c.cost||0,supplier:(n=c.supplier)==null?void 0:n.trim(),serialNumber:(o=c.serialNumber)==null?void 0:o.trim(),barcode:(s=c.barcode)==null?void 0:s.trim(),expiration_date:c.expiration_date,lastUpdated:new Date().toISOString()};return Object.keys(a).forEach(l=>{a[l]===void 0&&delete a[l]}),a}var qh=Object.defineProperty,zh=Object.defineProperties,Uh=Object.getOwnPropertyDescriptors,uo=Object.getOwnPropertySymbols,Nh=Object.prototype.hasOwnProperty,Fh=Object.prototype.propertyIsEnumerable,ho=(c,e,t)=>e in c?qh(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Lh=(c,e)=>{for(var t in e||(e={}))Nh.call(e,t)&&ho(c,t,e[t]);if(uo)for(var t of uo(e))Fh.call(e,t)&&ho(c,t,e[t]);return c},xh=(c,e)=>zh(c,Uh(e)),K=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Bh(c){return K(this,null,function*(){try{return(yield q.getItems(c)).data||[]}catch(e){throw console.error("Error getting items:",e),new Error("Failed to get items")}})}function jh(c){return K(this,null,function*(){try{return yield q.getItemById(c)}catch(e){throw console.error("Error getting item by ID:",e),new Error("Failed to get item by ID")}})}function _c(c){return K(this,null,function*(){try{return(yield q.getItems({category:c})).data||[]}catch(e){throw console.error("Error getting items by category:",e),new Error("Failed to get items by category")}})}function Vh(c){return K(this,null,function*(){try{return(yield q.getItems({location:c})).data||[]}catch(e){throw console.error("Error getting items by location:",e),new Error("Failed to get items by location")}})}function Hh(c){return K(this,null,function*(){try{return(yield q.getItems({status:c})).data||[]}catch(e){throw console.error("Error getting items by status:",e),new Error("Failed to get items by status")}})}function Gh(c){return K(this,null,function*(){try{return(yield q.getItems({search:c})).data||[]}catch(e){throw console.error("Error searching items:",e),new Error("Failed to search items")}})}function Wh(){return K(this,null,function*(){try{return(yield q.getItems({})).data||[]}catch(c){throw console.error("Error getting low stock items:",c),new Error("Failed to get low stock items")}})}function Kh(c=30){return K(this,null,function*(){try{return(yield q.getItems({})).data||[]}catch(e){throw console.error("Error getting expiring items:",e),new Error("Failed to get expiring items")}})}function vc(c){return K(this,null,function*(){try{const e=Qi(c);return yield q.createItem(e)}catch(e){throw console.error("Error creating item:",e),new Error("Failed to create item")}})}function Yi(c,e){return K(this,null,function*(){try{if(!c)throw new Error("Item ID is required");const t=Qi(e);return yield q.updateItem(c,t)}catch(t){throw console.error("Error updating item:",t),new Error("Failed to update item")}})}function Ji(c){return K(this,null,function*(){try{if(!c)throw new Error("Item ID is required");yield q.deleteItem(c)}catch(e){throw console.error("Error deleting item:",e),new Error("Failed to delete item")}})}function wc(c){return K(this,null,function*(){try{if(!c)throw new Error("Item ID is required");return yield q.updateItem(c,{status:"archived",lastUpdated:new Date().toISOString()})}catch(e){throw console.error("Error archiving item:",e),new Error("Failed to archive item")}})}function Ic(c){return K(this,null,function*(){try{if(!c)throw new Error("Item ID is required");const e=yield q.getItemById(c);if(!e)throw new Error("Original item not found");const t=xh(Lh({},e),{name:`${e.name} (Copy)`,id:void 0,lastUpdated:void 0});return yield q.createItem(t)}catch(e){throw console.error("Error duplicating item:",e),new Error("Failed to duplicate item")}})}function Sc(c,e){return K(this,null,function*(){try{const r=(yield _c(c)).map(o=>q.updateItem(o.id,e));return{updatedCount:(yield Promise.allSettled(r)).filter(o=>o.status==="fulfilled").length}}catch(t){throw console.error("Error in bulk update by category:",t),new Error("Failed to bulk update items by category")}})}function Qh(c){return K(this,null,function*(){try{return yield Gc(c)}catch(e){throw console.error("Error getting suppliers by facility:",e),new Error("Failed to get suppliers by facility")}})}function Yh(c){return K(this,null,function*(){try{return yield Wc(c)}catch(e){throw console.error("Error getting inventory transactions by facility:",e),new Error("Failed to get inventory transactions by facility")}})}function Jh(c){return K(this,null,function*(){try{return yield Kc(c)}catch(e){throw console.error("Error getting inventory costs by facility:",e),new Error("Failed to get inventory costs by facility")}})}function Xh(c){return K(this,null,function*(){try{return yield Qc(c)}catch(e){throw console.error("Error getting equipment maintenance by facility:",e),new Error("Failed to get equipment maintenance by facility")}})}const Tn=Object.freeze(Object.defineProperty({__proto__:null,archiveItem:wc,bulkUpdateItemsByCategory:Sc,createItem:vc,deleteItem:Ji,duplicateItem:Ic,getEquipmentMaintenanceByFacilityDb:Xh,getExpiringItems:Kh,getInventoryCostsByFacilityDb:Jh,getInventoryTransactionsByFacilityDb:Yh,getItemById:jh,getItems:Bh,getItemsByCategory:_c,getItemsByLocation:Vh,getItemsByStatus:Hh,getLowStockItems:Wh,getSuppliersByFacilityDb:Qh,searchItems:Gh,updateItem:Yi},Symbol.toStringTag,{value:"Module"}));class Zh{constructor(){this.cache={data:null,timestamp:0,ttl:300*1e3,hits:0,misses:0,evictions:0}}get(){return this.cache.data&&Date.now()-this.cache.timestamp<this.cache.ttl?(this.cache.hits++,this.cache.data):(this.cache.misses++,null)}set(e){this.cache.data=e,this.cache.timestamp=Date.now()}clear(){this.cache.data&&this.cache.evictions++,this.cache.data=null,this.cache.timestamp=0}getStats(){return{hits:this.cache.hits,misses:this.cache.misses,evictions:this.cache.evictions,size:this.cache.data?JSON.stringify(this.cache.data).length:0,lastUpdated:new Date(this.cache.timestamp).toISOString(),updated_at:new Date(this.cache.timestamp).toISOString()}}isValid(){return!!(this.cache.data&&Date.now()-this.cache.timestamp<this.cache.ttl)}}var fo=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class P{static handleOperation(e,t){return fo(this,null,function*(){try{return yield t()}catch(r){throw console.error(`❌ ${e} failed:`,r),r}})}static executeWithRetry(e,t,r=3){return fo(this,null,function*(){let i=null;for(let n=1;n<=r;n++)try{return yield t()}catch(o){if(i=o instanceof Error?o:new Error("Unknown error"),n===r)throw o;console.warn(`Retry attempt ${n}/${r} for operation: ${e}`),yield new Promise(s=>setTimeout(s,1e3*n))}throw i||new Error("Operation failed after all retry attempts")})}static delay(e){return new Promise(t=>setTimeout(t,e))}}class ta{constructor(){this.cacheManagers=new Map}static getInstance(){return this.instance||(this.instance=new ta),this.instance}registerCacheManager(e,t){this.cacheManagers.set(e,t),console.log(`📝 Registered cache manager: ${e}`)}unregisterCacheManager(e){this.cacheManagers.delete(e),console.log(`📝 Unregistered cache manager: ${e}`)}onInvalidation(){console.log("📝 Cache invalidation listener registered (simplified)")}offInvalidation(){console.log("📝 Cache invalidation listener removed (simplified)")}invalidatePattern(e){console.log(`🧹 Invalidating cache pattern: ${e}`),this.cacheManagers.forEach((t,r)=>{(r.includes(e)||e==="all")&&(t.invalidatePattern?t.invalidatePattern(e):t.clearCache())})}invalidateKey(e){console.log(`🧹 Invalidating cache key: ${e}`),this.cacheManagers.forEach(t=>{t.invalidateKey&&t.invalidateKey(e)})}invalidateRelated(e,t){console.log(`🧹 Invalidating related caches for operation: ${e}${t?` (${t})`:""}`),e.startsWith("inventory:")?this.invalidatePattern("inventory"):e.startsWith("knowledge:")?this.invalidatePattern("knowledge"):e.startsWith("cleaning:")?this.invalidatePattern("cleaning"):(e==="user:login"||e==="user:logout"||e==="app:refresh")&&this.clearAllCaches()}clearAllCaches(){console.log("🧹 Clearing all caches"),this.cacheManagers.forEach(e=>{e.clearCache()})}getRegisteredManagers(){return Array.from(this.cacheManagers.keys())}isRegistered(e){return this.cacheManagers.has(e)}}const G=ta.getInstance();var ef=Object.defineProperty,mo=Object.getOwnPropertySymbols,tf=Object.prototype.hasOwnProperty,rf=Object.prototype.propertyIsEnumerable,po=(c,e,t)=>e in c?ef(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Rr=(c,e)=>{for(var t in e||(e={}))tf.call(e,t)&&po(c,t,e[t]);if(mo)for(var t of mo(e))rf.call(e,t)&&po(c,t,e[t]);return c},pi=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class x{static initialize(){this.flushInterval=setInterval(()=>{this.flushQueues()},3e4),this.setupErrorHandlers(),console.log("Monitoring service initialized")}static logEvent(e,t,r,i="info",n){const o={category:e,action:t,level:i,message:r,metadata:n,timestamp:new Date().toISOString()};this.eventQueue.push(o),i==="error"&&this.flushQueues()}static trackMetric(e,t,r,i,n){const o={name:e,value:t,unit:r,category:i,timestamp:new Date().toISOString(),metadata:n};this.metricQueue.push(o),this.metricQueue.length>=this.MAX_BATCH_SIZE&&this.flushQueues()}static reportError(e,t,r){const i={error:e,context:t,userAgent:navigator.userAgent,timestamp:new Date().toISOString(),metadata:r};this.errorQueue.push(i),console.error(`[ERROR] ${t}:`,e,r),this.flushQueues()}static trackUserAction(e,t,r){this.logEvent(t,e,`User performed ${e}`,"info",r)}static trackApiCall(e,t,r,i,n){this.trackMetric("api_call_duration",r,"ms","api",Rr({endpoint:e,method:t,status:i},n)),r>1e3&&this.logEvent("api","slow_request",`Slow API call: ${t} ${e} took ${r}ms`,"warn",Rr({endpoint:e,method:t,duration:r,status:i},n)),i>=400&&this.logEvent("api","failed_request",`Failed API call: ${t} ${e} returned ${i}`,"error",Rr({endpoint:e,method:t,status:i},n))}static trackPageView(e,t){this.logEvent("navigation","page_view",`User viewed ${e}`,"info",Rr({page:e},t))}static trackFeatureUsage(e,t,r){this.logEvent("feature",t,`Feature used: ${e}`,"info",Rr({feature:e},r))}static flushQueues(){return pi(this,null,function*(){try{if(!gt()){console.warn("⚠️ Supabase not configured, skipping monitoring queue flush");return}this.eventQueue.length>0&&(yield this.flushEvents()),this.metricQueue.length>0&&(yield this.flushMetrics()),this.errorQueue.length>0&&(yield this.flushErrors())}catch(e){console.error("Failed to flush monitoring queues:",e)}})}static flushEvents(){return pi(this,null,function*(){const e=this.eventQueue.splice(0,this.MAX_BATCH_SIZE);console.log("📊 Monitoring: Would flush",e.length,"events (disabled for debugging)");const{data:{user:t}}=yield d.auth.getUser();let r=null;if(t){const{data:i}=yield d.from("users").select("facility_id").eq("id",t.id).single();r=(i==null?void 0:i.facility_id)||null}console.log("📊 Monitoring: User context:",{userId:t==null?void 0:t.id,facilityId:r,eventsQueued:this.eventQueue.length})})}static flushMetrics(){return pi(this,null,function*(){const e=this.metricQueue.splice(0,this.MAX_BATCH_SIZE),{data:{user:t}}=yield d.auth.getUser();let r=null;if(t){const{data:n}=yield d.from("users").select("facility_id").eq("id",t.id).single();r=(n==null?void 0:n.facility_id)||null}const{error:i}=yield d.from("monitoring_performance_metrics").insert(e.map(n=>({metric_name:n.name,metric_value:n.value,facility_id:r||"default",created_at:n.timestamp})));i&&(console.error("Failed to flush performance metrics:",i),this.metricQueue.unshift(...e))})}static flushErrors(){return pi(this,null,function*(){const e=this.errorQueue.splice(0,this.MAX_BATCH_SIZE),{data:{user:t}}=yield d.auth.getUser();let r=null;if(t){const{data:n}=yield d.from("users").select("facility_id").eq("id",t.id).single();r=(n==null?void 0:n.facility_id)||null}const{error:i}=yield d.from("error_reports").insert(e.map(n=>({error_message:n.error instanceof Error?n.error.message:n.error,error_stack:n.error instanceof Error?n.error.stack:void 0,context:n.context,user_agent:n.userAgent,metadata:n.metadata,user_id:(t==null?void 0:t.id)||null,facility_id:r,created_at:n.timestamp})));i&&(console.error("Failed to flush error reports:",i),this.errorQueue.unshift(...e))})}static setupErrorHandlers(){window.addEventListener("unhandledrejection",e=>{this.reportError(e.reason,"unhandled_promise_rejection",{promise:e.promise})}),window.addEventListener("error",e=>{this.reportError(e.error||new Error(e.message),"javascript_error",{filename:e.filename,lineno:e.lineno,colno:e.colno})})}static cleanup(){this.flushInterval&&(clearInterval(this.flushInterval),this.flushInterval=null),this.flushQueues()}}x.MAX_BATCH_SIZE=50;x.eventQueue=[];x.metricQueue=[];x.errorQueue=[];x.flushInterval=null;const M=x.logEvent.bind(x);x.trackMetric.bind(x);x.reportError.bind(x);const z=x.trackUserAction.bind(x);x.trackApiCall.bind(x);x.trackPageView.bind(x);x.trackFeatureUsage.bind(x);typeof window!="undefined"&&x.initialize();var nf=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class A{static trackEvent(e,t){return nf(this,null,function*(){try{console.log("Analytics Event:",{eventName:e,properties:t,timestamp:new Date}),(e.includes("track_")||e.includes("tool_"))&&console.log("Event forwarded to tracking analytics service:",e)}catch(r){console.warn("Failed to track analytics event:",r)}})}}var af=Object.defineProperty,of=Object.defineProperties,sf=Object.getOwnPropertyDescriptors,go=Object.getOwnPropertySymbols,cf=Object.prototype.hasOwnProperty,lf=Object.prototype.propertyIsEnumerable,yo=(c,e,t)=>e in c?af(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,uf=(c,e)=>{for(var t in e||(e={}))cf.call(e,t)&&yo(c,t,e[t]);if(go)for(var t of go(e))lf.call(e,t)&&yo(c,t,e[t]);return c},df=(c,e)=>of(c,sf(e)),we=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function hf(c){return Xe.categorizeItems(c)}function ff(c){return Xe.withNormalizedCategory(c)}class Xe{constructor(e,t){this.adapter=e,this.adapterType=t}static normalizeCategory(e){const t=e.toLowerCase().trim();return t.includes("mask")||t.includes("glove")||t.includes("gown")||t.includes("supply")?"Supplies":t.includes("scalpel")||t.includes("forceps")||t.includes("tool")||t.includes("instrument")?"Tools":t.includes("chair")||t.includes("autoclave")||t.includes("machine")||t.includes("equipment")?"Equipment":t.includes("computer")||t.includes("printer")||t.includes("office")||t.includes("hardware")?"Office Hardware":"Tools"}static categorizeItems(e){const t=[],r=[],i=[],n=[];return e.forEach(o=>{switch(this.normalizeCategory(String(o.category||""))){case"Tools":t.push(o);break;case"Supplies":r.push(o);break;case"Equipment":i.push(o);break;case"Office Hardware":n.push(o);break;default:t.push(o);break}}),{tools:t,supplies:r,equipment:i,officeHardware:n}}static withNormalizedCategory(e){return e.map(t=>df(uf({},t),{category:this.normalizeCategory(t.category)}))}addCategory(e){return we(this,null,function*(){return{success:yield P.handleOperation("addCategory",()=>we(this,null,function*(){return yield this.adapter.addCategory(e),G.invalidateRelated("inventory:categories",e),M("inventory","category_created",`Category created: ${e}`,"info",{category:e,adapterType:this.adapterType}),z("create_category","inventory",{category:e}),A.trackEvent("inventory_category_created",{category:e,adapterType:this.adapterType}),!0})),error:null}})}deleteCategory(e){return we(this,null,function*(){return{success:yield P.handleOperation("deleteCategory",()=>we(this,null,function*(){return yield this.adapter.deleteCategory(e),G.invalidateRelated("inventory:categories",e),M("inventory","category_deleted",`Category deleted: ${e}`,"info",{category:e,adapterType:this.adapterType}),z("delete_category","inventory",{category:e}),A.trackEvent("inventory_category_deleted",{category:e,adapterType:this.adapterType}),!0})),error:null}})}getCategories(){return we(this,null,function*(){return{data:yield P.handleOperation("getCategories",()=>we(this,null,function*(){return yield this.adapter.fetchCategories()})),error:null}})}getNormalizedCategories(){return we(this,null,function*(){return{data:yield P.handleOperation("getNormalizedCategories",()=>we(this,null,function*(){const r=(yield this.adapter.fetchCategories()).map(i=>Xe.normalizeCategory(i));return Array.from(new Set(r))})),error:null}})}getCategoryStats(){return we(this,null,function*(){return{data:yield P.handleOperation("getCategoryStats",()=>we(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r={};return t.forEach(i=>{const n=Xe.normalizeCategory(i.category||"");r[n]=(r[n]||0)+1}),r})),error:null}})}static validateCategoryName(e){const t=[];return(!e||e.trim()==="")&&t.push("Category name is required"),e.length>100&&t.push("Category name must be less than 100 characters"),/^[a-zA-Z0-9\s\-_]+$/.test(e)||t.push("Category name contains invalid characters"),{isValid:t.length===0,errors:t}}static getCategorySuggestions(e){const t=e.toLowerCase(),r=[];return(t.includes("mask")||t.includes("glove")||t.includes("gown"))&&r.push("Supplies"),(t.includes("scalpel")||t.includes("forceps")||t.includes("tool"))&&r.push("Tools"),(t.includes("chair")||t.includes("autoclave")||t.includes("machine"))&&r.push("Equipment"),(t.includes("computer")||t.includes("printer")||t.includes("office"))&&r.push("Office Hardware"),r.length===0&&r.push("Tools","Supplies","Equipment","Office Hardware"),r}mergeCategories(e,t){return we(this,null,function*(){return{success:yield P.handleOperation("mergeCategories",()=>we(this,null,function*(){const n=(yield this.adapter.fetchInventoryItems()).filter(a=>a.category===e);for(const a of n)yield this.adapter.updateInventoryItem(a.id,{category:t});return(yield this.adapter.fetchInventoryItems()).some(a=>a.category===e)||(yield this.adapter.deleteCategory(e)),M("inventory","category_merged",`Category merged: ${e} -> ${t}`,"info",{sourceCategory:e,targetCategory:t,itemsUpdated:n.length,adapterType:this.adapterType}),z("merge_category","inventory",{sourceCategory:e,targetCategory:t,itemsUpdated:n.length}),A.trackEvent("inventory_category_merged",{sourceCategory:e,targetCategory:t,itemsUpdated:n.length,adapterType:this.adapterType}),!0})),error:null}})}}var mf=Object.defineProperty,pf=Object.defineProperties,gf=Object.getOwnPropertyDescriptors,_o=Object.getOwnPropertySymbols,yf=Object.prototype.hasOwnProperty,_f=Object.prototype.propertyIsEnumerable,vo=(c,e,t)=>e in c?mf(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,vf=(c,e)=>{for(var t in e||(e={}))yf.call(e,t)&&vo(c,t,e[t]);if(_o)for(var t of _o(e))_f.call(e,t)&&vo(c,t,e[t]);return c},wf=(c,e)=>pf(c,gf(e)),j=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class If{constructor(e,t){this.adapter=e,this.adapterType=t}fetchInventoryItems(){return j(this,null,function*(){return yield P.handleOperation("fetchInventoryItems",()=>j(this,null,function*(){return yield this.adapter.fetchInventoryItems()}))})}getItemById(e){return j(this,null,function*(){return yield P.handleOperation("getItemById",()=>j(this,null,function*(){return{data:(yield this.adapter.fetchInventoryItems()).find(n=>n.id===e)||null,error:null}}))})}createItem(e){return j(this,null,function*(){return{data:yield P.handleOperation("createItem",()=>j(this,null,function*(){const r=yield this.adapter.addInventoryItem(e);return G.invalidateRelated("inventory:create",r.id),M("inventory","item_created",`Inventory item created: ${e.name||e.item}`,"info",{itemId:r.id,itemName:e.name||e.item,category:e.category,adapterType:this.adapterType}),z("create_item","inventory",{itemId:r.id,itemName:e.name||e.item,category:e.category}),A.trackEvent("inventory_item_created",{itemId:r.id,itemName:e.name||e.item,category:e.category,adapterType:this.adapterType}),r})),error:null}})}updateItem(e,t){return j(this,null,function*(){return{data:yield P.handleOperation("updateItem",()=>j(this,null,function*(){const i=yield this.adapter.updateInventoryItem(e,t);return G.invalidateRelated("inventory:update",e),M("inventory","item_updated",`Inventory item updated: ${e}`,"info",{itemId:e,updates:Object.keys(t),adapterType:this.adapterType}),z("update_item","inventory",{itemId:e,updates:Object.keys(t)}),A.trackEvent("inventory_item_updated",{itemId:e,updates:Object.keys(t).join(","),adapterType:this.adapterType}),i})),error:null}})}deleteItem(e){return j(this,null,function*(){return{success:yield P.handleOperation("deleteItem",()=>j(this,null,function*(){return yield this.adapter.deleteInventoryItem(e),G.invalidateRelated("inventory:delete",e),M("inventory","item_deleted",`Inventory item deleted: ${e}`,"info",{itemId:e,adapterType:this.adapterType}),z("delete_item","inventory",{itemId:e}),A.trackEvent("inventory_item_deleted",{itemId:e,adapterType:this.adapterType}),!0})),error:null}})}addInventoryItem(e){return j(this,null,function*(){return yield P.handleOperation("addInventoryItem",()=>j(this,null,function*(){const r=yield this.adapter.addInventoryItem(e);return G.invalidateRelated("inventory:create",e.id),M("inventory","item_created",`Inventory item created: ${e.name||e.item}`,"info",{itemId:e.id,itemName:e.name||e.item,category:e.category,adapterType:this.adapterType}),z("create_item","inventory",{itemId:e.id,itemName:e.name||e.item,category:e.category}),A.trackEvent("inventory_item_created",{itemId:e.id,itemName:e.name||e.item,category:e.category,adapterType:this.adapterType}),r}))})}static validateItemData(e){const t=[];return!e.name&&!e.item&&t.push("Item name is required"),e.category||t.push("Category is required"),e.quantity!==void 0&&e.quantity<0&&t.push("Quantity must be non-negative"),e.minimumStock!==void 0&&e.minimumStock<0&&t.push("Minimum stock must be non-negative"),e.location&&e.location.length>200&&t.push("Location must be less than 200 characters"),e.description&&e.description.length>1e3&&t.push("Description must be less than 1000 characters"),{isValid:t.length===0,errors:t}}duplicateItem(e,t){return j(this,null,function*(){return{data:yield P.handleOperation("duplicateItem",()=>j(this,null,function*(){const i=yield this.getItemById(e);if(!i.data)throw new Error("Original item not found");const n=wf(vf({},i.data),{name:t||`${i.data.name} (Copy)`,id:""}),o=yield this.adapter.addInventoryItem(n);return G.invalidateRelated("inventory:create",o.id),M("inventory","item_duplicated",`Inventory item duplicated: ${e} -> ${o.id}`,"info",{originalItemId:e,newItemId:o.id,adapterType:this.adapterType}),z("duplicate_item","inventory",{originalItemId:e,newItemId:o.id}),A.trackEvent("inventory_item_duplicated",{originalItemId:e,newItemId:o.id,adapterType:this.adapterType}),o})),error:null}})}archiveItem(e,t){return j(this,null,function*(){return{data:yield P.handleOperation("archiveItem",()=>j(this,null,function*(){const i=yield this.adapter.updateInventoryItem(e,{status:"archived",archiveReason:t});return G.invalidateRelated("inventory:update",e),M("inventory","item_archived",`Inventory item archived: ${e}`,"info",{itemId:e,reason:t,adapterType:this.adapterType}),z("archive_item","inventory",{itemId:e,reason:t}),A.trackEvent("inventory_item_archived",{itemId:e,reason:t,adapterType:this.adapterType}),i})),error:null}})}restoreItem(e){return j(this,null,function*(){return{data:yield P.handleOperation("restoreItem",()=>j(this,null,function*(){const r=yield this.adapter.updateInventoryItem(e,{status:"active",archiveReason:null});return G.invalidateRelated("inventory:update",e),M("inventory","item_restored",`Inventory item restored: ${e}`,"info",{itemId:e,adapterType:this.adapterType}),z("restore_item","inventory",{itemId:e}),A.trackEvent("inventory_item_restored",{itemId:e,adapterType:this.adapterType}),r})),error:null}})}}var ue=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Sf{constructor(e,t){this.adapter=e,this.adapterType=t}bulkCreateItems(e){return ue(this,null,function*(){return yield P.handleOperation("bulkCreateItems",()=>ue(this,null,function*(){const r=[],i=[];let n=0,o=0;for(const s of e)try{const a=yield this.adapter.addInventoryItem(s);r.push(a),G.invalidateRelated("inventory:create",a.id),n++}catch(a){i.push(`Failed to create item ${s.name||s.item}: ${a instanceof Error?a.message:"Unknown error"}`),o++}return M("inventory","bulk_items_created",`Bulk created ${n} items, ${o} failed`,"info",{totalItems:e.length,successCount:n,errorCount:o,adapterType:this.adapterType}),z("bulk_create_items","inventory",{totalItems:e.length,successCount:n,errorCount:o}),A.trackEvent("inventory_bulk_items_created",{totalItems:e.length,successCount:n,errorCount:o,adapterType:this.adapterType}),{success:o===0,processedCount:e.length,successCount:n,errorCount:o,errors:i,data:r}}))})}bulkUpdateItems(e){return ue(this,null,function*(){return yield P.handleOperation("bulkUpdateItems",()=>ue(this,null,function*(){const r=[],i=[];let n=0,o=0;for(const s of e)try{const a=yield this.adapter.updateInventoryItem(s.id,s.updates);r.push(a),G.invalidateRelated("inventory:update",s.id),n++}catch(a){i.push(`Failed to update item ${s.id}: ${a instanceof Error?a.message:"Unknown error"}`),o++}return M("inventory","bulk_items_updated",`Bulk updated ${n} items, ${o} failed`,"info",{totalItems:e.length,successCount:n,errorCount:o,adapterType:this.adapterType}),z("bulk_update_items","inventory",{totalItems:e.length,successCount:n,errorCount:o}),A.trackEvent("inventory_bulk_items_updated",{totalItems:e.length,successCount:n,errorCount:o,adapterType:this.adapterType}),{success:o===0,processedCount:e.length,successCount:n,errorCount:o,errors:i,data:r}}))})}bulkDeleteItems(e){return ue(this,null,function*(){return yield P.handleOperation("bulkDeleteItems",()=>ue(this,null,function*(){const r=[];let i=0,n=0;for(const o of e)try{yield this.adapter.deleteInventoryItem(o),G.invalidateRelated("inventory:delete",o),i++}catch(s){r.push(`Failed to delete item ${o}: ${s instanceof Error?s.message:"Unknown error"}`),n++}return M("inventory","bulk_items_deleted",`Bulk deleted ${i} items, ${n} failed`,"info",{totalItems:e.length,successCount:i,errorCount:n,adapterType:this.adapterType}),z("bulk_delete_items","inventory",{totalItems:e.length,successCount:i,errorCount:n}),A.trackEvent("inventory_bulk_items_deleted",{totalItems:e.length,successCount:i,errorCount:n,adapterType:this.adapterType}),{success:n===0,processedCount:e.length,successCount:i,errorCount:n,errors:r,data:[]}}))})}bulkArchiveItems(e,t){return ue(this,null,function*(){return yield P.handleOperation("bulkArchiveItems",()=>ue(this,null,function*(){const i=[],n=[];let o=0,s=0;for(const a of e)try{const l=yield this.adapter.updateInventoryItem(a,{status:"archived",archiveReason:t});i.push(l),G.invalidateRelated("inventory:update",a),o++}catch(l){n.push(`Failed to archive item ${a}: ${l instanceof Error?l.message:"Unknown error"}`),s++}return M("inventory","bulk_items_archived",`Bulk archived ${o} items, ${s} failed`,"info",{totalItems:e.length,successCount:o,errorCount:s,reason:t,adapterType:this.adapterType}),z("bulk_archive_items","inventory",{totalItems:e.length,successCount:o,errorCount:s,reason:t}),A.trackEvent("inventory_bulk_items_archived",{totalItems:e.length,successCount:o,errorCount:s,reason:t,adapterType:this.adapterType}),{success:s===0,processedCount:e.length,successCount:o,errorCount:s,errors:n,data:i}}))})}bulkRestoreItems(e){return ue(this,null,function*(){return yield P.handleOperation("bulkRestoreItems",()=>ue(this,null,function*(){const r=[],i=[];let n=0,o=0;for(const s of e)try{const a=yield this.adapter.updateInventoryItem(s,{status:"active",archiveReason:null});r.push(a),G.invalidateRelated("inventory:update",s),n++}catch(a){i.push(`Failed to restore item ${s}: ${a instanceof Error?a.message:"Unknown error"}`),o++}return M("inventory","bulk_items_restored",`Bulk restored ${n} items, ${o} failed`,"info",{totalItems:e.length,successCount:n,errorCount:o,adapterType:this.adapterType}),z("bulk_restore_items","inventory",{totalItems:e.length,successCount:n,errorCount:o}),A.trackEvent("inventory_bulk_items_restored",{totalItems:e.length,successCount:n,errorCount:o,adapterType:this.adapterType}),{success:o===0,processedCount:e.length,successCount:n,errorCount:o,errors:i,data:r}}))})}bulkChangeCategory(e,t){return ue(this,null,function*(){return yield P.handleOperation("bulkChangeCategory",()=>ue(this,null,function*(){const i=[],n=[];let o=0,s=0;for(const a of e)try{const l=yield this.adapter.updateInventoryItem(a,{category:t});i.push(l),G.invalidateRelated("inventory:update",a),o++}catch(l){n.push(`Failed to change category for item ${a}: ${l instanceof Error?l.message:"Unknown error"}`),s++}return M("inventory","bulk_category_changed",`Bulk changed category for ${o} items, ${s} failed`,"info",{totalItems:e.length,successCount:o,errorCount:s,newCategory:t,adapterType:this.adapterType}),z("bulk_change_category","inventory",{totalItems:e.length,successCount:o,errorCount:s,newCategory:t}),A.trackEvent("inventory_bulk_category_changed",{totalItems:e.length,successCount:o,errorCount:s,newCategory:t,adapterType:this.adapterType}),{success:s===0,processedCount:e.length,successCount:o,errorCount:s,errors:n,data:i}}))})}bulkChangeLocation(e,t){return ue(this,null,function*(){return yield P.handleOperation("bulkChangeLocation",()=>ue(this,null,function*(){const i=[],n=[];let o=0,s=0;for(const a of e)try{const l=yield this.adapter.updateInventoryItem(a,{});i.push(l),G.invalidateRelated("inventory:update",a),o++}catch(l){n.push(`Failed to change location for item ${a}: ${l instanceof Error?l.message:"Unknown error"}`),s++}return M("inventory","bulk_location_changed",`Bulk changed location for ${o} items, ${s} failed`,"info",{totalItems:e.length,successCount:o,errorCount:s,newLocation:t,adapterType:this.adapterType}),z("bulk_change_location","inventory",{totalItems:e.length,successCount:o,errorCount:s,newLocation:t}),A.trackEvent("inventory_bulk_location_changed",{totalItems:e.length,successCount:o,errorCount:s,newLocation:t,adapterType:this.adapterType}),{success:s===0,processedCount:e.length,successCount:o,errorCount:s,errors:n,data:i}}))})}static validateBulkOperationData(e,t){const r=[];switch((!t||t.length===0)&&r.push("No data provided for bulk operation"),t.length>1e3&&r.push("Bulk operation limited to 1000 items maximum"),e){case"create":t.forEach((i,n)=>{if(!i||typeof i!="object"){r.push(`Item ${n+1}: Invalid item data`);return}const o=i;!o.name&&!o.item&&r.push(`Item ${n+1}: Name is required`),o.category||r.push(`Item ${n+1}: Category is required`)});break;case"update":t.forEach((i,n)=>{if(!i||typeof i!="object"){r.push(`Update ${n+1}: Invalid update data`);return}const o=i;o.id||r.push(`Update ${n+1}: ID is required`),o.updates||r.push(`Update ${n+1}: Updates object is required`)});break;case"delete":case"archive":case"restore":t.forEach((i,n)=>{(typeof i!="string"||!i.trim())&&r.push(`ID ${n+1}: Valid ID is required`)});break}return{isValid:r.length===0,errors:r}}}var Ie=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class bf{constructor(e){this.adapter=e}searchItems(e){return Ie(this,null,function*(){return yield P.handleOperation("searchItems",()=>Ie(this,null,function*(){return{data:(yield this.adapter.fetchInventoryItems()).filter(n=>{var o,s,a,l;return((o=n.name)==null?void 0:o.toLowerCase().includes(e.toLowerCase()))||((a=(s=n.data)==null?void 0:s.description)==null?void 0:a.toString().toLowerCase().includes(e.toLowerCase()))||((l=n.category)==null?void 0:l.toLowerCase().includes(e.toLowerCase()))}),error:null}}))})}getFilteredItems(e){return Ie(this,null,function*(){return yield P.handleOperation("getFilteredItems",()=>Ie(this,null,function*(){let i=yield this.adapter.fetchInventoryItems();if(e.category&&(i=i.filter(n=>n.category===e.category)),e.status&&(i=i.filter(n=>n.status===e.status)),e.location&&(i=i.filter(n=>n.location===e.location)),e.searchQuery){const n=e.searchQuery.toLowerCase();i=i.filter(o=>{var s,a,l;return((s=o.name)==null?void 0:s.toLowerCase().includes(n))||((l=(a=o.data)==null?void 0:a.description)==null?void 0:l.toString().toLowerCase().includes(n))})}return e.minQuantity!==void 0&&(i=i.filter(n=>(n.quantity||0)>=e.minQuantity)),e.maxQuantity!==void 0&&(i=i.filter(n=>(n.quantity||0)<=e.maxQuantity)),e.dateRange&&(i=i.filter(n=>{const o=new Date(n.lastUpdated||n.created_at);return o>=e.dateRange.start&&o<=e.dateRange.end})),e.tags&&e.tags.length>0&&(i=i.filter(n=>{var o;const s=((o=n.data)==null?void 0:o.tags)||[];return e.tags.some(a=>s.includes(a))})),{data:i,error:null}}))})}advancedSearch(e){return Ie(this,arguments,function*(t,r={}){return yield P.handleOperation("advancedSearch",()=>Ie(this,null,function*(){let o=yield this.adapter.fetchInventoryItems();if(t.category&&(o=o.filter(a=>a.category===t.category)),t.status&&(o=o.filter(a=>a.status===t.status)),t.location&&(o=o.filter(a=>a.location===t.location)),t.searchQuery){const a=t.searchQuery.toLowerCase();o=o.filter(l=>{var u,h,f,m;return((u=l.name)==null?void 0:u.toLowerCase().includes(a))||((f=(h=l.data)==null?void 0:h.description)==null?void 0:f.toString().toLowerCase().includes(a))||((m=l.category)==null?void 0:m.toLowerCase().includes(a))})}t.minQuantity!==void 0&&(o=o.filter(a=>(a.quantity||0)>=t.minQuantity)),t.maxQuantity!==void 0&&(o=o.filter(a=>(a.quantity||0)<=t.maxQuantity)),t.dateRange&&(o=o.filter(a=>{const l=new Date(a.lastUpdated||a.created_at);return l>=t.dateRange.start&&l<=t.dateRange.end})),t.tags&&t.tags.length>0&&(o=o.filter(a=>{var l;const u=((l=a.data)==null?void 0:l.tags)||[];return t.tags.some(h=>u.includes(h))})),r.includeArchived||(o=o.filter(a=>a.status!=="archived")),r.sortBy&&(o=this.sortItems(o,r.sortBy,r.sortOrder||"asc"));const s=o.length;if(r.limit||r.offset){const a=r.offset||0,l=r.limit?a+r.limit:o.length;o=o.slice(a,l)}return{data:o,total:s,filters:t,options:r,error:null}}))})}searchByNormalizedCategory(e){return Ie(this,arguments,function*(t,r={}){return yield P.handleOperation("searchByNormalizedCategory",()=>Ie(this,null,function*(){let s=(yield this.adapter.fetchInventoryItems()).filter(l=>Xe.normalizeCategory(l.category||"")===t);r.includeArchived||(s=s.filter(l=>l.status!=="archived")),r.sortBy&&(s=this.sortItems(s,r.sortBy,r.sortOrder||"asc"));const a=s.length;if(r.limit||r.offset){const l=r.offset||0,u=r.limit?l+r.limit:s.length;s=s.slice(l,u)}return{data:s,total:a,filters:{category:t},options:r,error:null}}))})}getSearchSuggestions(e,t=10){return Ie(this,null,function*(){return(yield P.handleOperation("getSearchSuggestions",()=>Ie(this,null,function*(){const i=yield this.adapter.fetchInventoryItems(),n=new Set;if(!e||e.trim()==="")return[];const o=e.toLowerCase();return i.forEach(s=>{var a;s.name&&s.name.toLowerCase().includes(o)&&n.add(s.name),s.category&&s.category.toLowerCase().includes(o)&&n.add(s.category),s.location&&s.location.toLowerCase().includes(o)&&n.add(s.location);const l=(a=s.data)==null?void 0:a.description;l&&l.toLowerCase().includes(o)&&l.split(/\s+/).filter(h=>h.toLowerCase().includes(o)&&h.length>2).forEach(h=>n.add(h))}),Array.from(n).slice(0,t)})))||[]})}getLocations(){return Ie(this,null,function*(){return{data:yield P.handleOperation("getLocations",()=>Ie(this,null,function*(){const t=yield this.adapter.fetchInventoryItems();return Array.from(new Set(t.map(i=>i.location).filter(Boolean)))})),error:null}})}sortItems(e,t,r){return e.sort((i,n)=>{let o,s;switch(t){case"name":o=i.name||"",s=n.name||"";break;case"category":o=i.category||"",s=n.category||"";break;case"location":o=i.location||"",s=n.location||"";break;case"quantity":o=i.quantity||0,s=n.quantity||0;break;case"lastUpdated":o=new Date(i.lastUpdated||i.created_at),s=new Date(n.lastUpdated||n.created_at);break;default:o=i.name||"",s=n.name||""}return o<s?r==="asc"?-1:1:o>s?r==="asc"?1:-1:0})}static validateSearchFilters(e){const t=[];return e.minQuantity!==void 0&&e.maxQuantity!==void 0&&e.minQuantity>e.maxQuantity&&t.push("Minimum quantity cannot be greater than maximum quantity"),e.dateRange&&e.dateRange.start>e.dateRange.end&&t.push("Start date cannot be after end date"),e.searchQuery&&e.searchQuery.length>100&&t.push("Search query must be less than 100 characters"),{isValid:t.length===0,errors:t}}static validateSearchOptions(e){const t=[];e.limit!==void 0&&e.limit<1&&t.push("Limit must be greater than 0"),e.limit!==void 0&&e.limit>1e3&&t.push("Limit cannot exceed 1000"),e.offset!==void 0&&e.offset<0&&t.push("Offset must be non-negative");const r=["name","category","location","quantity","lastUpdated"];e.sortBy&&!r.includes(e.sortBy)&&t.push(`Invalid sort field. Must be one of: ${r.join(", ")}`);const i=["asc","desc"];return e.sortOrder&&!i.includes(e.sortOrder)&&t.push(`Invalid sort order. Must be one of: ${i.join(", ")}`),{isValid:t.length===0,errors:t}}}var Ef=Object.defineProperty,Af=Object.defineProperties,Tf=Object.getOwnPropertyDescriptors,wo=Object.getOwnPropertySymbols,kf=Object.prototype.hasOwnProperty,Pf=Object.prototype.propertyIsEnumerable,Io=(c,e,t)=>e in c?Ef(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,$r=(c,e)=>{for(var t in e||(e={}))kf.call(e,t)&&Io(c,t,e[t]);if(wo)for(var t of wo(e))Pf.call(e,t)&&Io(c,t,e[t]);return c},Cf=(c,e)=>Af(c,Tf(e));class Df{constructor(e){this.adapterType=e}trackItemCreated(e,t,r){const i={properties:{itemId:e,itemName:t,category:r,adapterType:this.adapterType}};this.logEvent("inventory","item_created",`Inventory item created: ${t}`,"info",i.properties),this.trackUserAction("create_item","inventory",{itemId:e,itemName:t,category:r}),this.trackAnalyticsEvent("inventory_item_created",i.properties)}trackItemUpdated(e,t){const r={properties:{itemId:e,updates:t,adapterType:this.adapterType}};this.logEvent("inventory","item_updated",`Inventory item updated: ${e}`,"info",r.properties),this.trackUserAction("update_item","inventory",{itemId:e,updates:t}),this.trackAnalyticsEvent("inventory_item_updated",r.properties)}trackItemDeleted(e){const t={properties:{itemId:e,adapterType:this.adapterType}};this.logEvent("inventory","item_deleted",`Inventory item deleted: ${e}`,"info",t.properties),this.trackUserAction("delete_item","inventory",{itemId:e}),this.trackAnalyticsEvent("inventory_item_deleted",t.properties)}trackCategoryCreated(e){const t={properties:{category:e,adapterType:this.adapterType}};this.logEvent("inventory","category_created",`Category created: ${e}`,"info",t.properties),this.trackUserAction("create_category","inventory",{category:e}),this.trackAnalyticsEvent("inventory_category_created",t.properties)}trackCategoryDeleted(e){const t={properties:{category:e,adapterType:this.adapterType}};this.logEvent("inventory","category_deleted",`Category deleted: ${e}`,"info",t.properties),this.trackUserAction("delete_category","inventory",{category:e}),this.trackAnalyticsEvent("inventory_category_deleted",t.properties)}trackBulkOperation(e,t,r,i,n){const o={properties:$r({totalItems:t,successCount:r,errorCount:i,adapterType:this.adapterType},n)};this.logEvent("inventory",`bulk_${e}`,`Bulk ${e}: ${r} successful, ${i} failed`,"info",o.properties),this.trackUserAction(`bulk_${e}`,"inventory",$r({totalItems:t,successCount:r,errorCount:i},n)),this.trackAnalyticsEvent(`inventory_bulk_${e}`,o.properties)}trackSearch(e,t,r){const i={properties:{query:e,resultCount:t,filters:r,adapterType:this.adapterType}};this.logEvent("inventory","search_performed",`Search: "${e}" returned ${t} results`,"info",i.properties),this.trackUserAction("search_items","inventory",{query:e,resultCount:t,filters:r}),this.trackAnalyticsEvent("inventory_search",i.properties)}trackFilter(e,t){const r={properties:{filters:e,resultCount:t,adapterType:this.adapterType}};this.logEvent("inventory","filter_applied",`Filter applied, returned ${t} results`,"info",r.properties),this.trackUserAction("filter_items","inventory",{filters:e,resultCount:t}),this.trackAnalyticsEvent("inventory_filter",r.properties)}trackItemDuplicated(e,t){const r={properties:{originalItemId:e,newItemId:t,adapterType:this.adapterType}};this.logEvent("inventory","item_duplicated",`Item duplicated: ${e} -> ${t}`,"info",r.properties),this.trackUserAction("duplicate_item","inventory",{originalItemId:e,newItemId:t}),this.trackAnalyticsEvent("inventory_item_duplicated",r.properties)}trackItemArchived(e,t){const r={properties:{itemId:e,reason:t,adapterType:this.adapterType}};this.logEvent("inventory","item_archived",`Item archived: ${e}`,"info",r.properties),this.trackUserAction("archive_item","inventory",{itemId:e,reason:t}),this.trackAnalyticsEvent("inventory_item_archived",r.properties)}trackItemRestored(e){const t={properties:{itemId:e,adapterType:this.adapterType}};this.logEvent("inventory","item_restored",`Item restored: ${e}`,"info",t.properties),this.trackUserAction("restore_item","inventory",{itemId:e}),this.trackAnalyticsEvent("inventory_item_restored",t.properties)}trackCategoryMerged(e,t,r){const i={properties:{sourceCategory:e,targetCategory:t,itemsUpdated:r,adapterType:this.adapterType}};this.logEvent("inventory","category_merged",`Category merged: ${e} -> ${t}`,"info",i.properties),this.trackUserAction("merge_category","inventory",{sourceCategory:e,targetCategory:t,itemsUpdated:r}),this.trackAnalyticsEvent("inventory_category_merged",i.properties)}trackAdapterInitialized(e){const t={properties:{adapterType:e}};this.logEvent("inventory","adapter_initialized",`Adapter initialized: ${e}`,"info",t.properties),this.trackUserAction("initialize_adapter","inventory",{adapterType:e}),this.trackAnalyticsEvent("inventory_adapter_initialized",t.properties)}trackError(e,t,r){const i={properties:$r({operation:e,errorMessage:t.message,errorStack:t.stack,adapterType:this.adapterType},r)};this.logEvent("inventory","error_occurred",`Error in ${e}: ${t.message}`,"error",i.properties),this.trackUserAction("error_occurred","inventory",$r({operation:e,errorMessage:t.message},r)),this.trackAnalyticsEvent("inventory_error",i.properties)}trackPerformance(e,t,r){const i={properties:{operation:e,duration:t,itemCount:r,adapterType:this.adapterType}};this.logEvent("inventory","performance_metric",`${e} took ${t}ms`,"info",i.properties),this.trackUserAction("performance_metric","inventory",{operation:e,duration:t,itemCount:r}),this.trackAnalyticsEvent("inventory_performance",i.properties)}logEvent(e,t,r,i,n){M(e,t,r,i,n)}trackUserAction(e,t,r){z(e,t,r)}trackAnalyticsEvent(e,t){A.trackEvent(e,t)}createCustomEvent(e,t,r,i,n,o){return{eventType:e,category:t,action:r,label:i,value:n,properties:Cf($r({},o),{adapterType:this.adapterType})}}trackCustomEvent(e){this.logEvent(e.category,e.action,e.label||e.action,"info",e.properties),this.trackUserAction(e.action,e.category,e.properties),this.trackAnalyticsEvent(e.eventType,e.properties)}}var Of=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Rf(){return Of(this,null,function*(){return yield T(()=>Promise.resolve().then(()=>fg),void 0)})}var $f=Object.defineProperty,Mf=Object.defineProperties,qf=Object.getOwnPropertyDescriptors,So=Object.getOwnPropertySymbols,zf=Object.prototype.hasOwnProperty,Uf=Object.prototype.propertyIsEnumerable,bo=(c,e,t)=>e in c?$f(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Eo=(c,e)=>{for(var t in e||(e={}))zf.call(e,t)&&bo(c,t,e[t]);if(So)for(var t of So(e))Uf.call(e,t)&&bo(c,t,e[t]);return c},Nf=(c,e)=>Mf(c,qf(e)),Mr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class bc{constructor(e,t){this.isInitialized=!1,this.lastError=null,this.lastSyncTime=null,this.pendingChanges=!1,this.config=e,this.metadata=Nf(Eo({},t),{config:e})}getMetadata(){return Eo({},this.metadata)}batchAddItems(e){return Mr(this,null,function*(){const t=[];for(const r of e)try{const i=yield this.addInventoryItem(r);t.push(i)}catch(i){throw this.setError(i),i}return t})}batchUpdateItems(e){return Mr(this,null,function*(){const t=[];for(const r of e)try{const i=yield this.updateInventoryItem(r.id,r.item);t.push(i)}catch(i){throw this.setError(i),i}return t})}batchDeleteItems(e){return Mr(this,null,function*(){for(const t of e)try{yield this.deleteInventoryItem(t)}catch(r){throw this.setError(r),r}})}sync(){return Mr(this,null,function*(){try{this.lastSyncTime=new Date,this.pendingChanges=!1}catch(e){throw this.setError(e),e}})}getLastSyncTime(){return this.lastSyncTime}hasPendingChanges(){return this.pendingChanges}getLastError(){return this.lastError}clearError(){this.lastError=null}disconnect(){return Mr(this,null,function*(){this.isInitialized=!1,this.lastError=null})}setError(e){this.lastError=e,console.error(`[${this.metadata.name}] Error:`,e)}setPendingChanges(){this.pendingChanges=!0}validateInitialization(){if(!this.isInitialized)throw new Error(`Adapter ${this.metadata.name} is not initialized. Call initialize() first.`)}}var Ff=Object.defineProperty,Lf=Object.defineProperties,xf=Object.getOwnPropertyDescriptors,Ao=Object.getOwnPropertySymbols,Bf=Object.prototype.hasOwnProperty,jf=Object.prototype.propertyIsEnumerable,To=(c,e,t)=>e in c?Ff(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,gi=(c,e)=>{for(var t in e||(e={}))Bf.call(e,t)&&To(c,t,e[t]);if(Ao)for(var t of Ao(e))jf.call(e,t)&&To(c,t,e[t]);return c},ko=(c,e)=>Lf(c,xf(e)),Ue=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const he={INVENTORY_DATA:"inventory_data",CATEGORIES:"inventory_categories",LAST_SYNC:"inventory_last_sync",PENDING_CHANGES:"inventory_pending_changes"};class Vf extends bc{constructor(e={type:"localStorage"}){const t={supportsRead:!0,supportsWrite:!0,supportsDelete:!0,supportsRealTime:!1,supportsOffline:!0,supportsBatch:!0};super(e,{name:"LocalStorageAdapter",version:"1.0.0",description:"Adapter for localStorage-based inventory data",capabilities:t}),this.storage=window.localStorage}initialize(){return Ue(this,null,function*(){try{if(!this.storage)throw new Error("localStorage is not available");this.storage.getItem(he.INVENTORY_DATA)||(yield this.initializeDefaultData()),this.isInitialized=!0,this.lastSyncTime=this.getLastSyncTimeFromStorage(),this.pendingChanges=this.getPendingChangesFromStorage()}catch(e){throw this.setError(e),e}})}isConnected(){return this.isInitialized&&!!this.storage}fetchAllInventoryData(){return Ue(this,null,function*(){this.validateInitialization();const e=this.getInventoryDataFromStorage(),t=[];return t.push(...e.tools),t.push(...e.supplies),t.push(...e.equipment),t.push(...e.officeHardware),{data:t,error:null,count:t.length}})}fetchInventoryItems(){return Ue(this,null,function*(){this.validateInitialization();const e=this.getInventoryDataFromStorage(),t=[];return t.push(...e.tools),t.push(...e.supplies),t.push(...e.equipment),t.push(...e.officeHardware),t})}fetchCategories(){return Ue(this,null,function*(){this.validateInitialization();const e=this.storage.getItem(he.CATEGORIES);return e?JSON.parse(e):this.getDefaultCategories()})}addInventoryItem(e){return Ue(this,null,function*(){this.validateInitialization();const t=this.getInventoryDataFromStorage(),r=ko(gi({},e),{id:this.generateId(),createdAt:new Date().toISOString()}),i=(r.category||"").toLowerCase();return i.includes("tool")||i.includes("instrument")?t.tools.push(r):i.includes("supply")||i.includes("consumable")?t.supplies.push(r):i.includes("equipment")||i.includes("device")?t.equipment.push(r):t.officeHardware.push(r),this.saveInventoryDataToStorage(t),this.setPendingChanges(),this.updateLastSyncTime(),r})}updateInventoryItem(e,t){return Ue(this,null,function*(){this.validateInitialization();const r=this.getInventoryDataFromStorage(),i=ko(gi({},t),{id:e,lastUpdated:new Date().toISOString()}),n=[r.tools,r.supplies,r.equipment,r.officeHardware];let o=!1;for(const s of n){const a=s.findIndex(l=>this.getItemId(l)===e);if(a!==-1){s[a]=gi(gi({},s[a]),i),o=!0;break}}if(!o)throw new Error(`Item with id ${e} not found`);return this.saveInventoryDataToStorage(r),this.setPendingChanges(),this.updateLastSyncTime(),i})}deleteInventoryItem(e){return Ue(this,null,function*(){this.validateInitialization();const t=this.getInventoryDataFromStorage(),r=[t.tools,t.supplies,t.equipment,t.officeHardware];let i=!1;for(const n of r){const o=n.findIndex(s=>this.getItemId(s)===e);if(o!==-1){n.splice(o,1),i=!0;break}}if(!i)throw new Error(`Item with id ${e} not found`);this.saveInventoryDataToStorage(t),this.setPendingChanges(),this.updateLastSyncTime()})}addCategory(e){return Ue(this,null,function*(){this.validateInitialization();const t=yield this.fetchCategories();return t.includes(e)||(t.push(e),this.storage.setItem(he.CATEGORIES,JSON.stringify(t)),this.setPendingChanges(),this.updateLastSyncTime()),e})}deleteCategory(e){return Ue(this,null,function*(){this.validateInitialization();const t=yield this.fetchCategories(),r=t.indexOf(e);r!==-1&&(t.splice(r,1),this.storage.setItem(he.CATEGORIES,JSON.stringify(t)),this.setPendingChanges(),this.updateLastSyncTime())})}getInventoryDataFromStorage(){const e=this.storage.getItem(he.INVENTORY_DATA);return e?JSON.parse(e):{tools:[],supplies:[],equipment:[],officeHardware:[],categories:this.getDefaultCategories(),isLoading:!1,error:null}}saveInventoryDataToStorage(e){this.storage.setItem(he.INVENTORY_DATA,JSON.stringify(e))}getLastSyncTimeFromStorage(){const e=this.storage.getItem(he.LAST_SYNC);return e?new Date(e):null}getPendingChangesFromStorage(){const e=this.storage.getItem(he.PENDING_CHANGES);return e?JSON.parse(e):!1}updateLastSyncTime(){this.lastSyncTime=new Date,this.storage.setItem(he.LAST_SYNC,this.lastSyncTime.toISOString())}setPendingChanges(){this.pendingChanges=!0,this.storage.setItem(he.PENDING_CHANGES,JSON.stringify(!0))}initializeDefaultData(){return Ue(this,null,function*(){const e={tools:[],supplies:[],equipment:[],officeHardware:[],categories:this.getDefaultCategories(),isLoading:!1,error:null};this.saveInventoryDataToStorage(e),this.storage.setItem(he.CATEGORIES,JSON.stringify(this.getDefaultCategories())),this.storage.setItem(he.LAST_SYNC,new Date().toISOString()),this.storage.setItem(he.PENDING_CHANGES,JSON.stringify(!1))})}generateId(){return`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getItemId(e){if(e.data&&typeof e.data=="object"&&e.data!==null){const t=e.data;if(t.toolId&&typeof t.toolId=="string")return t.toolId;if(t.supplyId&&typeof t.supplyId=="string")return t.supplyId;if(t.equipmentId&&typeof t.equipmentId=="string")return t.equipmentId;if(t.hardwareId&&typeof t.hardwareId=="string")return t.hardwareId}return e.id||this.generateId()}getDefaultCategories(){return["Surgical Instruments","Medical Supplies","Equipment","Office Hardware","Consumables","Disposables","Tools","Devices"]}}var Hf=Object.defineProperty,Po=Object.getOwnPropertySymbols,Gf=Object.prototype.hasOwnProperty,Wf=Object.prototype.propertyIsEnumerable,Co=(c,e,t)=>e in c?Hf(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,yi=(c,e)=>{for(var t in e||(e={}))Gf.call(e,t)&&Co(c,t,e[t]);if(Po)for(var t of Po(e))Wf.call(e,t)&&Co(c,t,e[t]);return c},qr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Kf{constructor(e){this.registry={},this.defaultAdapter=null,this.config={defaultAdapter:e.defaultAdapter||"localStorage",adapters:yi({},e.adapters),fallbackAdapter:e.fallbackAdapter||"supabase"}}createAdapter(e,t){return qr(this,null,function*(){if(this.registry[e])return this.registry[e];let r;switch(e){case"static":{const{StaticDataAdapter:i}=yield T(()=>Promise.resolve().then(()=>Ig),void 0);r=new i(t||{type:"static"});break}case"localStorage":{r=new Vf(t||this.config.adapters.localStorage);break}case"api":{const{ApiAdapter:i,isApiAdapterConfig:n}=yield T(()=>Promise.resolve().then(()=>Pg),void 0),o=t||this.config.adapters.api;if(!o)throw new Error("API adapter configuration is required");if(!n(o))throw new Error("API adapter requires baseUrl configuration");r=new i(o);break}case"supabase":{const{SupabaseAdapter:i}=yield Rf(),n=t||this.config.adapters.supabase;if(!n)throw new Error("Supabase adapter configuration is required");r=new i(n);break}default:throw new Error(`Unknown adapter type: ${e}`)}return yield r.initialize(),this.registerAdapter(e,r),r})}getAdapter(e){return this.registry[e]||null}registerAdapter(e,t){this.registry[e]=t,e===this.config.defaultAdapter&&(this.defaultAdapter=t)}unregisterAdapter(e){const t=this.registry[e];t&&(t.disconnect().catch(console.error),delete this.registry[e],this.defaultAdapter===t&&(this.defaultAdapter=null))}initializeDefaultAdapter(){return qr(this,null,function*(){if(this.defaultAdapter)return this.defaultAdapter;try{const e=yield this.createAdapter(this.config.defaultAdapter);return this.defaultAdapter=e,e}catch(e){if(console.error(e),console.error(`Failed to initialize default adapter (${this.config.defaultAdapter}):`),this.config.fallbackAdapter&&this.config.fallbackAdapter!==this.config.defaultAdapter)try{const t=yield this.createAdapter(this.config.fallbackAdapter);return this.defaultAdapter=t,t}catch(t){throw console.error(`Failed to initialize fallback adapter (${this.config.fallbackAdapter}):`,t),new Error("No available adapters could be initialized")}throw new Error("No available adapters could be initialized")}})}getAvailableAdapters(){return Object.keys(this.registry)}getAdapterMetadata(e){const t=this.registry[e];return t?t.getMetadata():null}updateConfig(e){this.config=yi(yi({},this.config),e)}getConfig(){return yi({},this.config)}switchDefaultAdapter(e){return qr(this,null,function*(){if(!["localStorage","api","supabase"].includes(e))throw new Error(`Invalid adapter type: ${e}`);return this.config.defaultAdapter=e,this.defaultAdapter=null,this.initializeDefaultAdapter()})}getBestAvailableAdapter(){return qr(this,null,function*(){try{return yield this.initializeDefaultAdapter()}catch(e){console.error(e);const t=["supabase","localStorage"];for(const r of t)try{return yield this.createAdapter(r)}catch(i){console.warn(`Failed to create adapter ${r}:`,i);continue}throw new Error("No adapters are available")}})}cleanup(){return qr(this,null,function*(){const e=Object.values(this.registry).map(t=>t.disconnect().catch(console.error));yield Promise.all(e),this.registry={},this.defaultAdapter=null})}}const or=new Kf({defaultAdapter:"supabase",adapters:{supabase:{type:"supabase"},localStorage:{type:"localStorage"}},fallbackAdapter:"localStorage"});var V=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Qf{constructor(e,t){this.adapter=e,this.adapterType=t}getInventoryStats(){return V(this,null,function*(){return{data:yield P.handleOperation("getInventoryStats",()=>V(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r={totalItems:t.length,categories:Array.from(new Set(t.map(n=>n.category))).length,locations:Array.from(new Set(t.map(n=>n.location))).length,activeItems:t.filter(n=>n.status==="active").length,maintenanceItems:t.filter(n=>n.status==="maintenance").length,inactiveItems:t.filter(n=>n.status==="inactive").length,retiredItems:t.filter(n=>n.status==="retired").length,archivedItems:t.filter(n=>n.status==="archived").length,lowStockItems:t.filter(n=>{const o=n.quantity||0,s=n.minimumStock||0;return o>0&&o<=s}).length,outOfStockItems:t.filter(n=>(n.quantity||0)===0).length,normalizedCategories:{tools:0,supplies:0,equipment:0,officeHardware:0},statusDistribution:{},categoryDistribution:{},locationDistribution:{},averageQuantity:0};t.forEach(n=>{const o=Xe.normalizeCategory(n.category||"");r.normalizedCategories[o.toLowerCase().replace(" ","")]++}),t.forEach(n=>{const o=n.status||"unknown";r.statusDistribution[o]=(r.statusDistribution[o]||0)+1}),t.forEach(n=>{const o=n.category||"unknown";r.categoryDistribution[o]=(r.categoryDistribution[o]||0)+1}),t.forEach(n=>{const o=n.location||"unknown";r.locationDistribution[o]=(r.locationDistribution[o]||0)+1});const i=t.reduce((n,o)=>n+(o.quantity||0),0);return r.averageQuantity=t.length>0?i/t.length:0,r})),error:null}})}getCategoryStats(){return V(this,null,function*(){return{data:yield P.handleOperation("getCategoryStats",()=>V(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r={};return t.forEach(i=>{const n=Xe.normalizeCategory(i.category||"");r[n]=(r[n]||0)+1}),r})),error:null}})}getStatusStats(){return V(this,null,function*(){return{data:yield P.handleOperation("getStatusStats",()=>V(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r={};return t.forEach(i=>{const n=i.status||"unknown";r[n]=(r[n]||0)+1}),r})),error:null}})}getLocationStats(){return V(this,null,function*(){return{data:yield P.handleOperation("getLocationStats",()=>V(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r={};return t.forEach(i=>{const n=i.location||"unknown";r[n]=(r[n]||0)+1}),r})),error:null}})}getStockLevelStats(){return V(this,null,function*(){return{data:yield P.handleOperation("getStockLevelStats",()=>V(this,null,function*(){const t=yield this.adapter.fetchInventoryItems();let r=0,i=0,n=0,o=0;return t.forEach(s=>{const a=s.quantity||0,l=s.minimumStock||0,u=s.maximumStock||1/0;a===0?n++:a<=l?i++:a>=u?o++:r++}),{inStock:r,lowStock:i,outOfStock:n,overStock:o}})),error:null}})}getTrendingItems(e=10){return V(this,null,function*(){return{data:yield P.handleOperation("getTrendingItems",()=>V(this,null,function*(){const r=yield this.adapter.fetchInventoryItems(),i={};return r.forEach(o=>{i[o.id]=(i[o.id]||0)+1}),r.sort((o,s)=>new Date(s.lastUpdated||s.created_at).getTime()-new Date(o.lastUpdated||o.created_at).getTime()).slice(0,e).map(o=>({id:o.id,name:o.name||o.item||"Unknown",category:o.category||"Unknown",lastUpdated:o.lastUpdated||o.created_at,updateCount:i[o.id]||1}))})),error:null}})}getCurrentAdapterType(){return this.adapterType}getAdapterMetadata(){return or.getAdapterMetadata(this.adapterType)||null}getAvailableAdapters(){return or.getAvailableAdapters()}getAdapterCapabilities(){const e=this.getAdapterMetadata();return(e==null?void 0:e.capabilities)||[]}supportsOperation(e){const t=this.getAdapterMetadata();return(t==null?void 0:t.supportedOperations.includes(e))||!1}getPerformanceMetrics(){return V(this,null,function*(){return{data:yield P.handleOperation("getPerformanceMetrics",()=>V(null,null,function*(){return{averageResponseTime:150,totalOperations:1e3,errorRate:.02,cacheHitRate:.85}})),error:null}})}getDataQualityMetrics(){return V(this,null,function*(){return{data:yield P.handleOperation("getDataQualityMetrics",()=>V(this,null,function*(){const t=yield this.adapter.fetchInventoryItems(),r=[];let i=0,n=0;t.forEach(l=>{["name","category","status"].forEach(h=>{n++,l[h]?i++:r.push(`Missing ${h} for item ${l.id}`)}),l.quantity!==void 0&&l.minimumStock!==void 0&&(l.quantity<0&&r.push(`Negative quantity for item ${l.id}`),l.minimumStock<0&&r.push(`Negative minimum stock for item ${l.id}`))});const o=n>0?i/n:0,s=1-r.length/t.length,a=1-r.filter(l=>l.includes("consistency")).length/t.length;return{completeness:o,accuracy:Math.max(0,s),consistency:Math.max(0,a),issues:r}})),error:null}})}generateInventoryReport(){return V(this,null,function*(){return{data:yield P.handleOperation("generateInventoryReport",()=>V(this,null,function*(){const[t,r,i,n,o]=yield Promise.all([this.getInventoryStats(),this.getCategoryStats(),this.getStatusStats(),this.getLocationStats(),this.getStockLevelStats()]),s=[];return t.data&&(t.data.lowStockItems>0&&s.push(`Consider restocking ${t.data.lowStockItems} low stock items`),t.data.outOfStockItems>0&&s.push(`Urgent: ${t.data.outOfStockItems} items are out of stock`),t.data.archivedItems>t.data.totalItems*.1&&s.push("Consider cleaning up archived items")),{summary:t.data,categoryBreakdown:r.data||{},statusBreakdown:i.data||{},locationBreakdown:n.data||{},stockLevels:o.data||{inStock:0,lowStock:0,outOfStock:0,overStock:0},recommendations:s,generatedAt:new Date().toISOString()}})),error:null}})}}var F=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Yf{constructor(){this.currentAdapter=null,this.adapterType="static",this.initialized=!1,this.categoryProvider=null,this.itemCrudProvider=null,this.bulkOperationsProvider=null,this.searchFilterProvider=null,this.analyticsProvider=null,this.statsProvider=null}get isInitialized(){return this.initialized}initialize(e,t){return F(this,null,function*(){this.initialized||(this.currentAdapter=e,this.adapterType=t,typeof this.currentAdapter.initialize=="function"&&(yield this.currentAdapter.initialize()),this.categoryProvider=new Xe(e,t),this.itemCrudProvider=new If(e,t),this.bulkOperationsProvider=new Sf(e,t),this.searchFilterProvider=new bf(e),this.analyticsProvider=new Df(t),this.statsProvider=new Qf(e,t),this.initialized=!0,console.info("[InventoryRepository] Initialized successfully."))})}getAdapter(){if(!this.initialized||!this.currentAdapter)throw new Error("Inventory repository not initialized. Must call initialize() first.");return this.currentAdapter}fetchInventoryItems(){return F(this,null,function*(){return this.itemCrudProvider.fetchInventoryItems()})}getAllItems(){return F(this,null,function*(){return this.itemCrudProvider.fetchInventoryItems()})}fetchAllInventoryData(){return F(this,null,function*(){const e=yield P.handleOperation("fetchAllInventoryData",()=>F(this,null,function*(){const r=yield this.getAdapter().fetchAllInventoryData(),i=r.data||[],n=ff(i),o=hf(n),s=new Set,a=new Set;[o.tools,o.supplies,o.equipment,o.officeHardware].forEach(u=>{u.forEach(h=>{s.has(h.id)&&a.add(h.id),s.add(h.id)})}),a.size>0&&console.warn(`Found ${a.size} duplicate item IDs:`,Array.from(a));const l=Array.from(new Set(n.map(u=>u.category).filter(Boolean)));return{tools:o.tools,supplies:o.supplies,equipment:o.equipment,officeHardware:o.officeHardware,categories:l,isLoading:!1,error:r.error}}));return{tools:e.tools||[],supplies:e.supplies||[],equipment:e.equipment||[],officeHardware:e.officeHardware||[],categories:e.categories,isLoading:e.isLoading,error:e.error}})}getItemById(e){return F(this,null,function*(){return this.itemCrudProvider.getItemById(e)})}createItem(e){return F(this,null,function*(){return this.itemCrudProvider.createItem(e)})}updateItem(e,t){return F(this,null,function*(){return this.itemCrudProvider.updateItem(e,t)})}deleteItem(e){return F(this,null,function*(){return this.itemCrudProvider.deleteItem(e)})}addInventoryItem(e){return F(this,null,function*(){return this.itemCrudProvider.addInventoryItem(e)})}addCategory(e){return F(this,null,function*(){return this.categoryProvider.addCategory(e)})}deleteCategory(e){return F(this,null,function*(){return this.categoryProvider.deleteCategory(e)})}bulkCreateItems(e){return F(this,null,function*(){return this.bulkOperationsProvider.bulkCreateItems(e)})}bulkUpdateItems(e){return F(this,null,function*(){return this.bulkOperationsProvider.bulkUpdateItems(e)})}bulkDeleteItems(e){return F(this,null,function*(){return this.bulkOperationsProvider.bulkDeleteItems(e)})}searchItems(e){return F(this,null,function*(){return this.searchFilterProvider.searchItems(e)})}getFilteredItems(e){return F(this,null,function*(){return this.searchFilterProvider.getFilteredItems(e)})}getCategories(){return F(this,null,function*(){return this.categoryProvider.getCategories()})}getLocations(){return F(this,null,function*(){return this.searchFilterProvider.getLocations()})}getInventoryStats(){return F(this,null,function*(){const e=yield this.statsProvider.getInventoryStats();return{data:e.data,error:e.error}})}getCurrentAdapterType(){return this.statsProvider.getCurrentAdapterType()}getAdapterMetadata(){return this.statsProvider.getAdapterMetadata()}getAvailableAdapters(){return this.statsProvider.getAvailableAdapters()}}var Jf=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Xf{constructor(){this.currentAdapter=null,this.adapterType="static",this.initialized=!1}initialize(){return Jf(this,null,function*(){this.initialized||(this.currentAdapter=yield or.initializeDefaultAdapter(),this.adapterType=or.getConfig().defaultAdapter,this.initialized=!0)})}getAdapter(){if(!this.currentAdapter)throw new Error("Inventory service facade not initialized. Call initialize() first.");return this.currentAdapter}getCurrentAdapterType(){return this.adapterType}getAdapterMetadata(){return or.getAdapterMetadata(this.adapterType)}getAvailableAdapters(){return or.getAvailableAdapters()}}const Zf={realtime:{get enabled(){return gt()}}};var em=Object.defineProperty,tm=Object.defineProperties,rm=Object.getOwnPropertyDescriptors,Do=Object.getOwnPropertySymbols,im=Object.prototype.hasOwnProperty,nm=Object.prototype.propertyIsEnumerable,Oo=(c,e,t)=>e in c?em(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ro=(c,e)=>{for(var t in e||(e={}))im.call(e,t)&&Oo(c,t,e[t]);if(Do)for(var t of Do(e))nm.call(e,t)&&Oo(c,t,e[t]);return c},$o=(c,e)=>tm(c,rm(e)),Ne=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class sr{constructor(){this.isConnected=!1,this.connectionTestPromise=null}static getInstance(){return sr.instance||(sr.instance=new sr),sr.instance}testConnection(){return Ne(this,null,function*(){return this.connectionTestPromise?this.connectionTestPromise:(this.connectionTestPromise=this.performConnectionTest(),this.connectionTestPromise)})}performConnectionTest(){return Ne(this,null,function*(){if(!gt())return console.warn("Supabase not configured, connection test skipped"),!1;try{const{error:e}=yield d.from("inventory_items").select("count").limit(1);return e?(console.error("❌ Supabase connection test failed:",e),this.isConnected=!1,!1):(this.isConnected=!0,!0)}catch(e){return console.error("❌ Supabase connection test error:",e),this.isConnected=!1,!1}})}getAnalytics(){return Ne(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");return q.getAnalytics()})}getCategories(){return Ne(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const{data:t,error:r}=yield d.from("inventory_items").select("category").not("category","is",null);if(r)throw new Error(`Failed to fetch categories: ${r.message}`);return Array.from(new Set((t==null?void 0:t.map(n=>n.category).filter(Boolean))||[]))}catch(t){throw console.error("❌ Error fetching categories:",t),t}})}getLocations(){return Ne(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const{error:t}=yield d.from("inventory_items").select("location").not("location","is",null);if(t)throw new Error(`Failed to fetch locations: ${t.message}`);return[]}catch(t){throw console.error("❌ Error fetching locations:",t),t}})}getItems(e){return Ne(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{let r=d.from("inventory_items").select("*",{count:"exact"});e!=null&&e.category&&(r=r.eq("category",e.category)),e!=null&&e.limit&&(r=r.limit(e.limit)),e!=null&&e.offset&&(r=r.range(e.offset,e.offset+(e.limit||10)-1));const{data:i,error:n,count:o}=yield r;if(n)throw new Error(`Failed to fetch items: ${n.message}`);return{data:i||[],count:o||0,error:null}}catch(r){return console.error("❌ Error fetching items:",r),{data:[],count:0,error:r instanceof Error?r.message:"Unknown error"}}})}subscribeToChanges(e){if(!Zf.realtime.enabled)return()=>{};try{return Gi.subscribe("inventory_items",e,{event:"*"})}catch(t){return console.error("❌ Failed to set up real-time subscription:",t),()=>{}}}resetConnectionTest(){this.connectionTestPromise=null,this.isConnected=!1}getConnectionStatus(){return{isConnected:this.isConnected,isConfigured:gt()}}getItemById(e){return Ne(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const{data:r,error:i}=yield d.from("inventory_items").select("*").eq("id",e).single();if(i){if(i.code==="PGRST116")return null;throw new Error(`Failed to fetch item: ${i.message}`)}return r}catch(r){throw console.error("❌ Error fetching item by ID:",r),r}})}createItem(e){return Ne(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const r=$o(Ro({},e),{data:e.data}),{data:i,error:n}=yield d.from("inventory_items").insert(r).select().single();if(n)throw new Error(`Failed to create item: ${n.message}`);return i}catch(r){throw console.error("❌ Error creating item:",r),r}})}updateItem(e,t){return Ne(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const i=$o(Ro({},t),{data:t.data}),{data:n,error:o}=yield d.from("inventory_items").update(i).eq("id",e).select().single();if(o)throw new Error(`Failed to update item: ${o.message}`);return n}catch(i){throw console.error("❌ Error updating item:",i),i}})}deleteItem(e){return Ne(this,null,function*(){if(!(yield this.testConnection()))throw new Error("Supabase connection not available");try{const{error:r}=yield d.from("inventory_items").delete().eq("id",e);if(r)throw new Error(`Failed to delete item: ${r.message}`)}catch(r){throw console.error("❌ Error deleting item:",r),r}})}}const am=sr.getInstance();var Nt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class om{constructor(e,t){this.repository=e,this.adapterManager=t}getItemById(e){return Nt(this,null,function*(){return yield this.repository.getItemById(e)})}createItem(e){return Nt(this,null,function*(){var t,r;const i=performance.now();try{const n=yield this.repository.createItem(e);yield A.trackEvent("inventory_item_created",{itemId:(t=n.data)==null?void 0:t.id,category:e.category,adapterType:this.adapterManager.getCurrentAdapterType()});const o=performance.now()-i;return N.recordResponseTime("inventory_item_create",o,{itemId:(r=n.data)==null?void 0:r.id}),n}catch(n){throw yield A.trackEvent("inventory_item_create_error",{error:n instanceof Error?n.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),n}})}updateItem(e,t){return Nt(this,null,function*(){const r=performance.now();try{const i=yield this.repository.updateItem(e,t);yield A.trackEvent("inventory_item_updated",{itemId:e,updatedFields:Object.keys(t).join(","),adapterType:this.adapterManager.getCurrentAdapterType()});const n=performance.now()-r;return N.recordResponseTime("inventory_item_update",n,{itemId:e}),i}catch(i){throw yield A.trackEvent("inventory_item_update_error",{itemId:e,error:i instanceof Error?i.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),i}})}deleteItem(e){return Nt(this,null,function*(){const t=performance.now();try{const r=yield this.repository.deleteItem(e);yield A.trackEvent("inventory_item_deleted",{itemId:e,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return N.recordResponseTime("inventory_item_delete",i,{itemId:e}),r}catch(r){throw yield A.trackEvent("inventory_item_delete_error",{itemId:e,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}addInventoryItem(e){return Nt(this,null,function*(){return yield this.repository.addInventoryItem(e)})}validateItem(e){return Nt(this,null,function*(){const t=[];return(!e.name||e.name.trim()==="")&&t.push("Item name is required"),(!e.category||e.category.trim()==="")&&t.push("Category is required"),(!e.location||e.location.trim()==="")&&t.push("Location is required"),e.quantity!==void 0&&e.quantity<0&&t.push("Quantity must be non-negative"),{isValid:t.length===0,errors:t}})}}var zr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class sm{constructor(e,t){this.repository=e,this.adapterManager=t}searchItems(e,t){return zr(this,null,function*(){var r,i;const n=performance.now();try{const o=yield this.repository.searchItems(e);yield A.trackEvent("inventory_search",{query:e,resultCount:((r=o.data)==null?void 0:r.length)||0,adapterType:this.adapterManager.getCurrentAdapterType()});const s=performance.now()-n;return N.recordResponseTime("inventory_search",s,{query:e,resultCount:String(((i=o.data)==null?void 0:i.length)||0)}),o}catch(o){throw yield A.trackEvent("inventory_search_error",{query:e,error:o instanceof Error?o.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),o}})}getFilteredItems(e,t,r){return zr(this,null,function*(){var i;const n=performance.now();try{const o=yield this.repository.getFilteredItems(e,t,r);yield A.trackEvent("inventory_filter",{filterCount:Object.keys(e).length,resultCount:((i=o.data)==null?void 0:i.length)||0,adapterType:this.adapterManager.getCurrentAdapterType()});const s=performance.now()-n;return N.recordResponseTime("inventory_filter",s,{filterCount:Object.keys(e).length.toString()}),o}catch(o){throw yield A.trackEvent("inventory_filter_error",{filters:e,error:o instanceof Error?o.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),o}})}fetchInventoryItems(){return zr(this,null,function*(){return yield this.repository.fetchInventoryItems()})}getAllItems(){return zr(this,null,function*(){return yield this.repository.getAllItems()})}refreshData(){return zr(this,null,function*(){const e=performance.now();try{const t=yield this.repository.refreshData();yield A.trackEvent("inventory_refresh",{adapterType:this.adapterManager.getCurrentAdapterType()});const r=performance.now()-e;return N.recordResponseTime("inventory_refresh",r,{}),t}catch(t){throw yield A.trackEvent("inventory_refresh_error",{error:t instanceof Error?t.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),t}})}}var kn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class cm{constructor(e,t){this.repository=e,this.adapterManager=t}bulkCreateItems(e){return kn(this,null,function*(){const t=performance.now();try{const r=yield this.repository.bulkCreateItems(e);yield A.trackEvent("inventory_bulk_create",{itemCount:e.length,successCount:r.successCount,errorCount:r.errorCount,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return N.recordResponseTime("inventory_bulk_create",i,{itemCount:e.length.toString()}),r}catch(r){throw yield A.trackEvent("inventory_bulk_create_error",{itemCount:e.length,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}bulkUpdateItems(e){return kn(this,null,function*(){const t=performance.now();try{const r=yield this.repository.bulkUpdateItems(e);yield A.trackEvent("inventory_bulk_update",{updateCount:e.length,successCount:r.successCount,errorCount:r.errorCount,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return N.recordResponseTime("inventory_bulk_update",i,{updateCount:e.length.toString()}),r}catch(r){throw yield A.trackEvent("inventory_bulk_update_error",{updateCount:e.length,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}bulkDeleteItems(e){return kn(this,null,function*(){const t=performance.now();try{const r=yield this.repository.bulkDeleteItems(e);yield A.trackEvent("inventory_bulk_delete",{itemCount:e.length,successCount:r.successCount,errorCount:r.errorCount,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return N.recordResponseTime("inventory_bulk_delete",i,{itemCount:e.length.toString()}),r}catch(r){throw yield A.trackEvent("inventory_bulk_delete_error",{itemCount:e.length,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}}var _i=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class lm{constructor(e,t){this.repository=e,this.adapterManager=t}addCategory(e){return _i(this,null,function*(){const t=performance.now();try{const r=yield this.repository.addCategory(e);yield A.trackEvent("inventory_category_added",{category:e,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return N.recordResponseTime("inventory_category_add",i,{category:e}),r}catch(r){throw yield A.trackEvent("inventory_category_add_error",{category:e,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}deleteCategory(e){return _i(this,null,function*(){const t=performance.now();try{const r=yield this.repository.deleteCategory(e);yield A.trackEvent("inventory_category_deleted",{category:e,adapterType:this.adapterManager.getCurrentAdapterType()});const i=performance.now()-t;return N.recordResponseTime("inventory_category_delete",i,{category:e}),r}catch(r){throw yield A.trackEvent("inventory_category_delete_error",{category:e,error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}getCategories(){return _i(this,null,function*(){var e;const t=performance.now();try{const r=yield this.repository.getCategories(),i=performance.now()-t;return N.recordResponseTime("inventory_categories_fetch",i,{categoryCount:((e=r.data)==null?void 0:e.length)||0}),r}catch(r){throw yield A.trackEvent("inventory_categories_fetch_error",{error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}getLocations(){return _i(this,null,function*(){var e;const t=performance.now();try{const r=yield this.repository.getLocations(),i=performance.now()-t;return N.recordResponseTime("inventory_locations_fetch",i,{locationCount:((e=r.data)==null?void 0:e.length)||0}),r}catch(r){throw yield A.trackEvent("inventory_locations_fetch_error",{error:r instanceof Error?r.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),r}})}}var Pn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class um{constructor(e,t){this.repository=e,this.adapterManager=t}getInventoryStats(){return Pn(this,null,function*(){const e=performance.now();try{const t=yield this.repository.getAllItems(),r={totalItems:t.length,categoriesCount:new Set(t.map(n=>n.category)).size,locationsCount:new Set(t.map(n=>n.location)).size,lowStockItems:t.filter(n=>(n.quantity||0)<10).length,expiredItems:t.filter(n=>n.expiration_date?new Date(n.expiration_date)<new Date:!1).length,lastUpdated:new Date},i=performance.now()-e;return N.recordResponseTime("inventory_stats_calculate",i,{totalItems:r.totalItems}),r}catch(t){throw yield A.trackEvent("inventory_stats_error",{error:t instanceof Error?t.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),t}})}getItemHistory(){return Pn(this,null,function*(){const e=performance.now();try{const t=yield this.repository.getItemHistory(),r=performance.now()-e;return N.recordResponseTime("inventory_history_fetch",r,{historyCount:t.length}),t}catch(t){throw yield A.trackEvent("inventory_history_error",{error:t instanceof Error?t.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),t}})}refresh(){return Pn(this,null,function*(){const e=performance.now();try{yield this.repository.refreshData();const t=performance.now()-e;return N.recordResponseTime("inventory_refresh",t,{}),{success:!0,error:null}}catch(t){return yield A.trackEvent("inventory_refresh_error",{error:t instanceof Error?t.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}})}}var dm=Object.defineProperty,Mo=Object.getOwnPropertySymbols,hm=Object.prototype.hasOwnProperty,fm=Object.prototype.propertyIsEnumerable,qo=(c,e,t)=>e in c?dm(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,mm=(c,e)=>{for(var t in e||(e={}))hm.call(e,t)&&qo(c,t,e[t]);if(Mo)for(var t of Mo(e))fm.call(e,t)&&qo(c,t,e[t]);return c},O=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Ec=class me{constructor(){this.cacheManager=new Zh,this.repository=new Yf,this.adapterManager=new Xf,this.isInitialized=!1,this.initializationPromise=null,G.isRegistered("inventory_service")||G.registerCacheManager("inventory_service",this),this.coreService=new om(this.repository,this.adapterManager),this.searchService=new sm(this.repository,this.adapterManager),this.bulkService=new cm(this.repository,this.adapterManager),this.categoryManagementService=new lm(this.repository,this.adapterManager),this.statsService=new um(this.repository,this.adapterManager)}static getInstance(){return me.instance||(me.instance=new me),me.instance}static initialize(){return O(this,null,function*(){yield me.getInstance().initialize()})}static createItem(e){return O(this,null,function*(){return me.getInstance().createItem(e)})}static updateItem(e,t){return O(this,null,function*(){return me.getInstance().updateItem(e,t)})}static deleteItem(e){return O(this,null,function*(){return me.getInstance().deleteItem(e)})}static getItem(e){return O(this,null,function*(){return me.getInstance(),me.getItem(e)})}static getAllItems(e){return O(this,null,function*(){return me.getInstance().getAllItems(e)})}getInstanceId(){return`instance_${this===me.instance?"SINGLETON":"NEW"}`}initialize(){return O(this,null,function*(){const e=performance.now();if(!this.isInitialized){if(this.initializationPromise){yield this.initializationPromise;return}this.initializationPromise=O(this,null,function*(){try{yield this.adapterManager.initialize(),yield this.repository.initialize(this.adapterManager.getAdapter(),this.adapterManager.getCurrentAdapterType()),this.isInitialized=!0;const t=performance.now()-e;N.recordResponseTime("inventory_service_initialization",t,{service:"InventoryServiceFacade",operation:"initialize"})}finally{this.initializationPromise=null}}),yield this.initializationPromise}})}isReady(){return this.isInitialized}fetchInventoryItems(){return O(this,null,function*(){return yield this.searchService.fetchInventoryItems()})}fetchAllInventoryData(){return O(this,null,function*(){const e=performance.now();try{const t=yield this.searchService.fetchInventoryItems(),r=yield this.statsService.getInventoryStats(),i={tools:t.filter(o=>o.category==="Tools"),supplies:t.filter(o=>o.category==="Supplies"),equipment:t.filter(o=>o.category==="Equipment"),officeHardware:t.filter(o=>o.category==="Office Hardware"),categories:Array.from(new Set(t.map(o=>o.category).filter(Boolean))),isLoading:!1,error:null},n=performance.now()-e;return N.recordResponseTime("inventory_fetch_all_data",n,{itemCount:t.length.toString()}),i}catch(t){throw yield A.trackEvent("inventory_fetch_all_data_error",{error:t instanceof Error?t.message:"Unknown error",adapterType:this.adapterManager.getCurrentAdapterType()}),t}})}getAllItems(e,t){return O(this,null,function*(){try{const r=yield this.searchService.getAllItems();return{data:r,count:Array.isArray(r)?r.length:0,error:null}}catch(r){return{data:[],count:0,error:r instanceof Error?r.message:"Unknown error"}}})}getItemById(e){return O(this,null,function*(){return yield this.coreService.getItemById(e)})}createItem(e){return O(this,null,function*(){return yield this.coreService.createItem(e)})}updateItem(e,t){return O(this,null,function*(){return yield this.coreService.updateItem(e,t)})}deleteItem(e){return O(this,null,function*(){return yield this.coreService.deleteItem(e)})}addInventoryItem(e){return O(this,null,function*(){return yield this.coreService.addInventoryItem(e)})}addCategory(e){return O(this,null,function*(){const t=yield this.categoryManagementService.addCategory(e);return{success:t.success,error:t.error||null}})}deleteCategory(e){return O(this,null,function*(){const t=yield this.categoryManagementService.deleteCategory(e);return{success:t.success,error:t.error||null}})}bulkCreateItems(e){return O(this,null,function*(){return yield this.bulkService.bulkCreateItems(e)})}bulkUpdateItems(e){return O(this,null,function*(){return yield this.bulkService.bulkUpdateItems(e)})}bulkDeleteItems(e){return O(this,null,function*(){return yield this.bulkService.bulkDeleteItems(e)})}searchItems(e){return O(this,null,function*(){return yield this.searchService.searchItems(e)})}getFilteredItems(e,t,r){return O(this,null,function*(){return yield this.searchService.getFilteredItems(e,t,r)})}getCategories(){return O(this,null,function*(){return yield this.categoryManagementService.getCategories()})}getLocations(){return O(this,null,function*(){return yield this.categoryManagementService.getLocations()})}getInventoryStats(){return O(this,null,function*(){try{const e=yield this.statsService.getInventoryStats();return{data:{totalItems:e.totalItems,categoriesCount:e.categoriesCount,locationsCount:e.locationsCount,lowStockItems:e.lowStockItems,expiredItems:e.expiredItems,lastUpdated:e.lastUpdated},error:null}}catch(e){return{data:null,error:e instanceof Error?e.message:"Unknown error"}}})}refresh(){return O(this,null,function*(){return yield this.statsService.refresh()})}validateItem(e){return O(this,null,function*(){return yield this.coreService.validateItem(e)})}getItemHistory(){return O(this,null,function*(){return yield this.statsService.getItemHistory()})}updateInventoryItem(e,t){return O(this,null,function*(){const r=yield this.coreService.updateItem(e,t);if(r.data)return r.data;throw new Error(r.error||"Failed to update item")})}deleteInventoryItem(e){return O(this,null,function*(){const t=yield this.coreService.deleteItem(e);if(!t.success)throw new Error(t.error||"Failed to delete item")})}refreshData(){return O(this,null,function*(){return yield this.searchService.refreshData()})}switchAdapter(e){return O(this,null,function*(){const t=performance.now();try{const r={success:!0,error:null},i=performance.now()-t;return N.recordResponseTime("inventory_adapter_switch",i,{adapterType:e}),r}catch(r){throw yield A.trackEvent("inventory_adapter_switch_error",{adapterType:e,error:r instanceof Error?r.message:"Unknown error"}),r}})}transformDataForModal(e){return e.map(t=>mm({},t))}clearCache(){this.cacheManager.clear()}getCacheStats(){const e=this.cacheManager.getStats();return{hits:e.hits,misses:e.misses,evictions:e.evictions,totalRequests:e.hits+e.misses,size:e.size,updated_at:e.updated_at}}getCurrentAdapterType(){return this.adapterManager.getCurrentAdapterType()}getAdapterMetadata(){const e=this.adapterManager.getAdapterMetadata();return e&&typeof e=="object"?{type:e.type||"static",name:e.name||"Unknown",version:e.version||"1.0.0",capabilities:e.capabilities||[]}:{type:"static",name:"Default Adapter",version:"1.0.0",capabilities:[]}}subscribeToChanges(e){return am.subscribeToChanges(t=>{this.clearCache(),A.trackEvent("inventory_realtime_update",{source:"facade",payload_type:typeof t,adapter_type:this.adapterManager.getCurrentAdapterType()}),e(t)})}};Ec.instance=null;let pm=Ec;const Rv=pm.getInstance();var gm=Object.defineProperty,ym=Object.defineProperties,_m=Object.getOwnPropertyDescriptors,zo=Object.getOwnPropertySymbols,vm=Object.prototype.hasOwnProperty,wm=Object.prototype.propertyIsEnumerable,Uo=(c,e,t)=>e in c?gm(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Xt=(c,e)=>{for(var t in e||(e={}))vm.call(e,t)&&Uo(c,t,e[t]);if(zo)for(var t of zo(e))wm.call(e,t)&&Uo(c,t,e[t]);return c},Zt=(c,e)=>ym(c,_m(e));const er={QUICK:{maxRetries:1,baseDelay:100,maxDelay:200,backoffStrategy:"fixed"},STANDARD:{maxRetries:3,baseDelay:100,maxDelay:1e3,backoffStrategy:"linear"},NETWORK:{maxRetries:5,baseDelay:200,maxDelay:2e3,backoffStrategy:"exponential"},CRITICAL:{maxRetries:5,baseDelay:500,maxDelay:5e3,backoffStrategy:"exponential"},BACKGROUND:{maxRetries:2,baseDelay:1e3,maxDelay:5e3,backoffStrategy:"linear"}},ft={NETWORK_ONLY:c=>{const e=c.message.toLowerCase();return e.includes("network")||e.includes("timeout")||e.includes("fetch")||e.includes("connection")},TEMPORARY_ONLY:c=>{const e=c.message.toLowerCase();return e.includes("rate limit")||e.includes("temporary")||e.includes("busy")||e.includes("unavailable")},NETWORK_AND_TEMPORARY:c=>ft.NETWORK_ONLY(c)||ft.TEMPORARY_ONLY(c),ALL:()=>!0,NONE:()=>!1},Ur={UI_OPERATION:Zt(Xt({},er.QUICK),{retryCondition:ft.NETWORK_ONLY}),DATA_FETCH:Zt(Xt({},er.STANDARD),{retryCondition:ft.NETWORK_AND_TEMPORARY}),API_CALL:Zt(Xt({},er.NETWORK),{retryCondition:ft.NETWORK_AND_TEMPORARY}),AUTH:Zt(Xt({},er.CRITICAL),{retryCondition:ft.NETWORK_AND_TEMPORARY}),BACKGROUND_TASK:Zt(Xt({},er.BACKGROUND),{retryCondition:ft.ALL})};Zt(Xt({},er.BACKGROUND),{retryCondition:ft.NETWORK_AND_TEMPORARY,syncInterval:3e4,maxConcurrentSyncs:3});var Im=Object.defineProperty,No=Object.getOwnPropertySymbols,Sm=Object.prototype.hasOwnProperty,bm=Object.prototype.propertyIsEnumerable,Fo=(c,e,t)=>e in c?Im(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Lo=(c,e)=>{for(var t in e||(e={}))Sm.call(e,t)&&Fo(c,t,e[t]);if(No)for(var t of No(e))bm.call(e,t)&&Fo(c,t,e[t]);return c},Ft=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Rt{static executeWithRetry(e){return Ft(this,arguments,function*(t,r={}){const i=performance.now(),n=Lo(Lo({},this.DEFAULT_CONFIG),r);let o,s=0;for(let l=0;l<=n.maxRetries;l++){s=l+1;try{const u=yield t(),h=performance.now()-i;return N.recordResponseTime("retry_operation_success",h,{service:"OptimizedRetryService",operation:"executeWithRetry",attempts:s.toString(),strategy:n.backoffStrategy}),{success:!0,data:u,attempts:s,totalDuration:h}}catch(u){if(o=u,l===n.maxRetries||n.retryCondition&&!n.retryCondition(o))break;const h=this.calculateDelay(l,n),f=n.jitter?h+Math.random()*100:h;console.warn(`[OptimizedRetryService] Operation failed (attempt ${s}/${n.maxRetries+1}): ${o.message}. Retrying in ${f.toFixed(0)}ms...`),yield this.sleep(f)}}const a=performance.now()-i;return N.recordErrorRate("retry_operation_failure",100,{service:"OptimizedRetryService",operation:"executeWithRetry",attempts:s.toString(),strategy:n.backoffStrategy,error:o.message}),{success:!1,error:o,attempts:s,totalDuration:a}})}static calculateDelay(e,t){let r;switch(t.backoffStrategy){case"linear":r=t.baseDelay*(e+1);break;case"exponential":r=t.baseDelay*Math.pow(2,e);break;case"fixed":r=t.baseDelay;break;default:r=t.baseDelay}return Math.min(r,t.maxDelay)}static sleep(e){return new Promise(t=>setTimeout(t,e))}static quickRetry(e){return Ft(this,null,function*(){const t=yield this.executeWithRetry(e,Ur.UI_OPERATION);if(!t.success)throw t.error;return t.data})}static standardRetry(e){return Ft(this,null,function*(){const t=yield this.executeWithRetry(e,Ur.DATA_FETCH);if(!t.success)throw t.error;return t.data})}static networkRetry(e){return Ft(this,null,function*(){const t=yield this.executeWithRetry(e,Ur.API_CALL);if(!t.success)throw t.error;return t.data})}static authRetry(e){return Ft(this,null,function*(){const t=yield this.executeWithRetry(e,Ur.AUTH);if(!t.success)throw t.error;return t.data})}static backgroundRetry(e){return Ft(this,null,function*(){const t=yield this.executeWithRetry(e,Ur.BACKGROUND_TASK);if(!t.success)throw t.error;return t.data})}}Rt.DEFAULT_CONFIG={maxRetries:3,baseDelay:100,maxDelay:1e3,backoffStrategy:"linear",jitter:!0};const Em=Rt.quickRetry,Am=Rt.standardRetry,Tm=Rt.networkRetry,km=Rt.authRetry,Pm=Rt.backgroundRetry,Ac=Object.freeze(Object.defineProperty({__proto__:null,OptimizedRetryService:Rt,authRetry:km,backgroundRetry:Pm,networkRetry:Tm,quickRetry:Em,standardRetry:Am},Symbol.toStringTag,{value:"Module"}));var Cm=Object.defineProperty,Dm=Object.defineProperties,Om=Object.getOwnPropertyDescriptors,xo=Object.getOwnPropertySymbols,Rm=Object.prototype.hasOwnProperty,$m=Object.prototype.propertyIsEnumerable,Bo=(c,e,t)=>e in c?Cm(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Tc=(c,e)=>{for(var t in e||(e={}))Rm.call(e,t)&&Bo(c,t,e[t]);if(xo)for(var t of xo(e))$m.call(e,t)&&Bo(c,t,e[t]);return c},kc=(c,e)=>Dm(c,Om(e)),_e=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const $t=(c,e)=>{console.log(`Analytics Event: ${c}`,e)};function $v(c,e,t){return _e(this,null,function*(){try{const r=yc(c);if(!r.isValid)throw new Error(r.errors.join(", "));const i=yield vc(c);e(i)}catch(r){t(r instanceof Error?r.message:"Failed to create item")}})}function Mv(c,e,t,r){return _e(this,null,function*(){try{if(!c)throw new Error("Item ID is required");const i=yc(e);if(!i.isValid)throw new Error(i.errors.join(", "));const n=yield Yi(c,e);t(n)}catch(i){r(i instanceof Error?i.message:"Failed to update item")}})}function qv(c,e,t){return _e(this,null,function*(){try{if(!c)throw new Error("Item ID is required");yield Ji(c),M("inventory","item_deleted",`Inventory item deleted: ${c}`,"info",{itemId:c,deletionMethod:"single_item"}),z("delete_item","inventory",{itemId:c,deletionMethod:"single_item"}),$t("inventory_item_deleted",{itemId:c,deletionMethod:"single_item"}),e()}catch(r){t(r instanceof Error?r.message:"Failed to delete item")}})}function zv(c,e,t,r,i){return _e(this,null,function*(){try{if(!e||e.length===0)throw new Error("No items selected for bulk operation");let n;switch(c){case"delete":n=yield Mm(e,t==null?void 0:t.progressConfig);break;case"update":if(!(t!=null&&t.updateData))throw new Error("Update data is required for bulk update operation");n=yield qm(e,t.updateData,t.progressConfig);break;case"export":if(!(t!=null&&t.exportOptions))throw new Error("Export options are required for bulk export operation");n=yield zm(e,t.exportOptions);break;default:throw new Error(`Unsupported bulk operation: ${c}`)}return r==null||r(n),n}catch(n){const o=n instanceof Error?n.message:"Bulk operation failed";throw i==null||i(o),new Error(o)}})}function Uv(c,e,t,r){return _e(this,null,function*(){try{if(!c)throw new Error("No file selected for import");const i=e||{validateData:!0,skipDuplicates:!0,createMissingCategories:!0},n=Um(i);if(!n.isValid)throw new Error(`Invalid import options: ${n.errors.join(", ")}`);const o=yield Yc.importItems(c,i);return M("inventory","bulk_import_completed",`Bulk import completed: ${o.importedCount} items imported`,"info",{fileName:o.fileName,importedCount:o.importedCount,failedCount:o.failedCount,skippedCount:o.skippedCount,errors:o.errors.length,warnings:o.warnings.length}),t==null||t(o),o}catch(i){console.error("Bulk import failed:",i);const n=i instanceof Error?i.message:"Bulk import failed";throw r==null||r(n),new Error(n)}})}function Nv(c,e,t){return _e(this,null,function*(){try{if(!c)throw new Error("Item ID is required");const r=yield Ic(c);M("inventory","item_duplicated",`Inventory item duplicated: ${c}`,"info",{originalItemId:c,duplicatedItemId:r.id}),z("duplicate_item","inventory",{originalItemId:c,duplicatedItemId:r.id}),$t("inventory_item_duplicated",{originalItemId:c,duplicatedItemId:r.id}),e(r)}catch(r){t(r instanceof Error?r.message:"Failed to duplicate item")}})}function Fv(c,e,t){return _e(this,null,function*(){try{if(!c)throw new Error("Item ID is required");const r=yield wc(c);M("inventory","item_archived",`Inventory item archived: ${c}`,"info",{itemId:c,archiveMethod:"single_item"}),z("archive_item","inventory",{itemId:c,archiveMethod:"single_item"}),$t("inventory_item_archived",{itemId:c,archiveMethod:"single_item"}),e(r)}catch(r){t(r instanceof Error?r.message:"Failed to archive item")}})}function Lv(c,e){return _e(this,null,function*(){try{const t=yield Sc(c,e);return M("inventory","bulk_update_by_category_completed",`Bulk update by category completed: ${t.updatedCount} items updated`,"info",{category:c,updatedCount:t.updatedCount}),z("bulk_update_by_category","inventory",{category:c,updatedCount:t.updatedCount}),$t("inventory_bulk_update_by_category_completed",{category:c,updatedCount:t.updatedCount}),t}catch(t){throw console.error("Error in bulk update by category:",t),new Error("Failed to bulk update items by category")}})}function Mm(c,e){return _e(this,null,function*(){try{if(e){const{results:t,failed:r,errors:i,metrics:n}=yield ec.processBulkOperation(c,o=>_e(null,null,function*(){return yield Ji(o)}),kc(Tc({},e),{enableCaching:!0,maxConcurrentWorkers:4,memoryLimit:104857600,onMemoryWarning:(o,s)=>{console.warn(`Memory usage high: ${Math.round(o/1048576)}MB / ${Math.round(s/1048576)}MB`)}}));return console.log("Bulk deletion completed with performance metrics:",{total:c.length,successful:t.length,failed:r.length,errors:i.length,processingTime:n.averageProcessingTime,memoryUsage:n.peakMemoryUsage,processingRate:n.processingRate}),{deletedCount:t.length}}else{const r=(yield Promise.allSettled(c.map(i=>Ji(i)))).filter(i=>i.status==="fulfilled").length;return M("inventory","bulk_deletion_completed",`Bulk deletion completed: ${r}/${c.length} items`,"info",{totalItems:c.length,deletedCount:r,failedCount:c.length-r,deletionMethod:"bulk_operation"}),z("bulk_delete_items","inventory",{totalItems:c.length,deletedCount:r,failedCount:c.length-r}),$t("inventory_bulk_deletion_completed",{totalItems:c.length,deletedCount:r,failedCount:c.length-r,deletionMethod:"bulk_operation"}),{deletedCount:r}}}catch(t){throw console.error("Error in bulk deletion:",t),new Error("Bulk deletion failed")}})}function qm(c,e,t){return _e(this,null,function*(){try{if(t){const{results:r,failed:i,errors:n,metrics:o}=yield ec.processBulkOperation(c,s=>_e(null,null,function*(){return yield Yi(s,Qi(e))}),kc(Tc({},t),{enableCaching:!0,maxConcurrentWorkers:4,memoryLimit:104857600,onMemoryWarning:(s,a)=>{console.warn(`Memory usage high: ${Math.round(s/1048576)}MB / ${Math.round(a/1048576)}MB`)}}));return console.log("Bulk update completed with performance metrics:",{total:c.length,successful:r.length,failed:i.length,errors:n.length,processingTime:o.averageProcessingTime,memoryUsage:o.peakMemoryUsage,processingRate:o.processingRate}),{updatedCount:r.length}}else{const i=(yield Promise.allSettled(c.map(n=>Yi(n,Qi(e))))).filter(n=>n.status==="fulfilled").length;return M("inventory","bulk_update_completed",`Bulk update completed: ${i}/${c.length} items`,"info",{totalItems:c.length,updatedCount:i,failedCount:c.length-i,updateMethod:"bulk_operation"}),z("bulk_update_items","inventory",{totalItems:c.length,updatedCount:i,failedCount:c.length-i}),$t("inventory_bulk_update_completed",{totalItems:c.length,updatedCount:i,failedCount:c.length-i,updateMethod:"bulk_operation"}),{updatedCount:i}}}catch(r){throw console.error("Error in bulk update:",r),new Error("Bulk update failed")}})}function zm(c,e){return _e(this,null,function*(){try{const t=yield Jc.exportItems(c,e);return M("inventory","bulk_export_completed",`Bulk export completed: ${c.length} items exported`,"info",{totalItems:c.length,exportFormat:e.format,exportMethod:"bulk_operation"}),z("bulk_export_items","inventory",{totalItems:c.length,exportFormat:e.format}),$t("inventory_bulk_export_completed",{totalItems:c.length,exportFormat:e.format,exportMethod:"bulk_operation"}),console.log("Bulk export completed with performance metrics:",{totalItems:c.length,exportFormat:e.format,exportMethod:"bulk_operation"}),{exportedCount:c.length}}catch(t){throw console.error("Error in bulk export:",t),new Error("Bulk export failed")}})}function Um(c){const e=[];return typeof c.validateData!="boolean"&&e.push("validateData must be a boolean"),typeof c.skipDuplicates!="boolean"&&e.push("skipDuplicates must be a boolean"),typeof c.createMissingCategories!="boolean"&&e.push("createMissingCategories must be a boolean"),{isValid:e.length===0,errors:e}}var Se=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Nm{scanOperationalGaps(e){return Se(this,null,function*(){const t=[],r=yield this.scanEquipmentMaintenance(e);t.push(...r);const i=yield this.scanComplianceGaps(e);t.push(...i);const n=yield this.scanOperationalIssues(e);t.push(...n);const o=yield this.scanSafetyGaps(e);return t.push(...o),t})}scanEquipmentMaintenance(e){return Se(this,null,function*(){const t=[],r=new Date;try{const i=yield this.scanAutoclaveMaintenance(e,r);t.push(...i);const n=yield this.scanToolMaintenance(e);t.push(...n)}catch(i){console.error("Error scanning equipment maintenance:",i)}return t})}scanAutoclaveMaintenance(e,t){return Se(this,null,function*(){const r=[],{data:i,error:n}=yield d.from("autoclaves").select("*").eq("facility_id",e).eq("status","active");if(n)throw n;return i==null||i.forEach(o=>{const s=o;s.next_maintenance&&new Date(s.next_maintenance)<=t&&r.push({id:rt(),type:"equipment",priority:"high",title:`Autoclave Maintenance Due: ${s.autoclave_name}`,description:`Maintenance is due for autoclave ${s.autoclave_name}. Schedule maintenance to ensure proper operation.`,category:"equipment",dueDate:s.next_maintenance,estimatedPoints:75,estimatedDuration:120,assignedRole:"technician",facilityId:e,metadata:{autoclaveId:s.id,equipmentType:"autoclave"}}),s.calibration_due&&new Date(s.calibration_due)<=t&&r.push({id:rt(),type:"compliance",priority:"urgent",title:`Autoclave Calibration Due: ${s.autoclave_name}`,description:`Calibration is due for autoclave ${s.autoclave_name}. This is critical for compliance.`,category:"compliance",dueDate:s.calibration_due,estimatedPoints:100,estimatedDuration:60,assignedRole:"technician",facilityId:e,metadata:{autoclaveId:s.id,equipmentType:"autoclave"}})}),r})}scanToolMaintenance(e){return Se(this,null,function*(){const t=[],r=yield pe.getToolsByFacilityAndStatus(e,"problem");return r==null||r.forEach(i=>{t.push({id:rt(),type:"equipment",priority:"medium",title:`Tool Maintenance Required: ${i.name||i.id}`,description:`Tool ${i.name||i.id} requires maintenance. Check condition and repair if possible.`,category:"equipment",dueDate:new Date().toISOString().split("T")[0],estimatedPoints:50,estimatedDuration:45,assignedRole:"technician",facilityId:e,metadata:{toolId:i.id,toolName:i.name||i.id}})}),t})}scanComplianceGaps(e){return Se(this,null,function*(){const t=[],r=new Date;try{const i=yield this.scanBITests(e,r);t.push(...i);const n=yield this.scanCleaningTasks(e,r);t.push(...n)}catch(i){console.error("Error scanning compliance gaps:",i)}return t})}scanBITests(e,t){return Se(this,null,function*(){const r=[],{data:i,error:n}=yield d.from("biological_indicator_tests").select("*").eq("facility_id",e).eq("status","pending").lte("due_date",t.toISOString().split("T")[0]);if(n)throw n;return i==null||i.forEach(o=>{const s=o;r.push({id:rt(),type:"compliance",priority:"urgent",title:"Daily BI Test Required",description:"Daily Biological Indicator test is required for sterilization compliance.",category:"compliance",dueDate:s.due_date,estimatedPoints:80,estimatedDuration:30,assignedRole:"operator",facilityId:e,metadata:{biTestId:s.id,testType:"daily_bi"}})}),r})}scanCleaningTasks(e,t){return Se(this,null,function*(){const r=[],{data:i,error:n}=yield d.from("cleaning_tasks").select("*").eq("facility_id",e).eq("status","pending").lte("due_date",t.toISOString());if(n)throw n;return i==null||i.forEach(o=>{const s=o;r.push({id:rt(),type:"compliance",priority:s.priority==="critical"?"urgent":"high",title:`Cleaning Task Overdue: ${s.name}`,description:`Cleaning task "${s.name}" is overdue. Complete to maintain compliance.`,category:"compliance",dueDate:s.due_date,estimatedPoints:60,estimatedDuration:s.estimated_duration_minutes||60,assignedRole:"cleaning_staff",facilityId:e,metadata:{taskId:s.id,taskName:s.name,location:s.location}})}),r})}scanOperationalIssues(e){return Se(this,null,function*(){const t=[];try{const r=yield this.scanStuckTools(e);t.push(...r);const i=yield this.scanLowInventory(e);t.push(...i)}catch(r){console.error("Error scanning operational issues:",r)}return t})}scanStuckTools(e){return Se(this,null,function*(){const t=[],r=["bath1","bath2","airDry","autoclave"],n=(yield Promise.all(r.map(o=>pe.getToolsByFacilityAndStatus(e,o)))).flat();return n==null||n.forEach(o=>{t.push({id:rt(),type:"operational",priority:"medium",title:`Tool Stuck in Phase: ${o.name||o.id}`,description:`Tool ${o.name||o.id} appears to be stuck in ${o.status} phase. Check workflow status.`,category:"operational",dueDate:new Date().toISOString().split("T")[0],estimatedPoints:40,estimatedDuration:30,assignedRole:"operator",facilityId:e,metadata:{toolId:o.id,toolName:o.name||o.id,currentPhase:o.status}})}),t})}scanLowInventory(e){return Se(this,null,function*(){const t=[],i=(yield _r.getItems()).filter(n=>{var o,s;return n.facility_id===e&&(n.quantity||0)<(((o=n.data)==null?void 0:o.min_quantity)||0)&&((s=n.data)==null?void 0:s.isActive)===!0});return i==null||i.forEach(n=>{var o;t.push({id:rt(),type:"operational",priority:"high",title:`Low Stock Alert: ${n.name}`,description:`Inventory item ${n.name} is running low. Current quantity: ${n.quantity}.`,category:"operational",dueDate:new Date().toISOString().split("T")[0],estimatedPoints:35,estimatedDuration:20,assignedRole:"inventory_manager",facilityId:e,metadata:{itemId:n.id,itemName:n.name,currentQuantity:n.quantity,minQuantity:(o=n.data)==null?void 0:o.min_quantity}})}),t})}scanSafetyGaps(e){return Se(this,null,function*(){const t=[];try{const r=yield this.scanFailedCycles(e);t.push(...r)}catch(r){console.error("Error scanning safety gaps:",r)}return t})}scanFailedCycles(e){return Se(this,null,function*(){const t=[],{data:r,error:i}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e).eq("status","failed").gte("created_at",new Date(Date.now()-6048e5).toISOString());if(i)throw i;return r==null||r.forEach(n=>{const o=n;t.push({id:rt(),type:"safety",priority:"high",title:`Investigate Failed Cycle: ${o.id}`,description:`Sterilization cycle ${o.id} failed and requires investigation to prevent future failures.`,category:"safety",dueDate:new Date().toISOString().split("T")[0],estimatedPoints:70,estimatedDuration:90,assignedRole:"supervisor",facilityId:e,metadata:{cycleId:o.id,failureReason:o.failure_reason}})}),t})}getGapStatistics(e){const t=e.length,r=e.reduce((l,u)=>(l[u.type]=(l[u.type]||0)+1,l),{}),i=e.reduce((l,u)=>(l[u.priority]=(l[u.priority]||0)+1,l),{}),n=e.reduce((l,u)=>(l[u.category]=(l[u.category]||0)+1,l),{}),o=e.reduce((l,u)=>(l[u.assignedRole]=(l[u.assignedRole]||0)+1,l),{}),s=t>0?e.reduce((l,u)=>l+u.estimatedPoints,0)/t:0,a=e.reduce((l,u)=>l+u.estimatedDuration,0);return{total:t,byType:r,byPriority:i,byCategory:n,byRole:o,averagePoints:s,totalEstimatedDuration:a}}filterGaps(e,t){return e.filter(r=>!(t.type&&r.type!==t.type||t.priority&&r.priority!==t.priority||t.category&&r.category!==t.category||t.assignedRole&&r.assignedRole!==t.assignedRole||t.facilityId&&r.facilityId!==t.facilityId))}sortGapsByPriority(e){const t={urgent:4,high:3,medium:2,low:1};return e.sort((r,i)=>{const n=(t[i.priority]||0)-(t[r.priority]||0);return n!==0?n:new Date(r.dueDate).getTime()-new Date(i.dueDate).getTime()})}getGapsDueToday(e){const t=new Date().toISOString().split("T")[0];return e.filter(r=>r.dueDate<=t)}getOverdueGaps(e){const t=new Date().toISOString().split("T")[0];return e.filter(r=>r.dueDate<t)}}var Fm=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Lm="undefined/functions/v1/openai";function xm(c){return Fm(this,arguments,function*({prompt:e,context:t=""}){throw console.warn("askCliniioAI() is deprecated. Use UnifiedAIService.askAI() instead."),Lm?new Error("Missing NEXT_PUBLIC_SUPABASE_ANON_KEY"):new Error("Missing NEXT_PUBLIC_SUPABASE_URL")})}var Bm=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class jm{assignTasksWithAI(e,t,r){return Bm(this,null,function*(){try{const i=this.prepareAnalysisData(e,t,r),n=yield xm({prompt:this.buildAIPrompt(i),context:"Daily Operations Task Assignment"});return this.parseAITaskAssignments(n,e,t,r)}catch(i){return console.error("AI task assignment failed, using fallback logic:",i),this.fallbackTaskAssignment(e,t,r)}})}prepareAnalysisData(e,t,r){return{operationalGaps:e,availableUsers:t,configuration:r,facilityContext:{totalGaps:e.length,gapTypes:e.reduce((i,n)=>(i[n.type]=(i[n.type]||0)+1,i),{}),priorityDistribution:e.reduce((i,n)=>(i[n.priority]=(i[n.priority]||0)+1,i),{})}}}buildAIPrompt(e){return`Analyze the following operational gaps and assign tasks to users optimally:

Operational Gaps: ${JSON.stringify(e.operationalGaps,null,2)}
Available Users: ${JSON.stringify(e.availableUsers,null,2)}
Configuration: ${JSON.stringify(e.configuration,null,2)}
Facility Context: ${JSON.stringify(e.facilityContext,null,2)}

Please provide a JSON response with task assignments that:
1. Respects max tasks per user (${e.configuration.maxTasksPerUser})
2. Prioritizes urgent and high priority tasks
3. Matches user roles to task categories
4. Balances workload across users
5. Considers task priority and estimated duration

Return ONLY valid JSON in this exact format:
[
  {
    "userId": "user_id_here",
    "tasks": [
      {
        "gapId": "gap_id_here"
      }
    ]
  }
]

Each task should reference a gapId from the operational gaps. Do not include any explanatory text, only the JSON array.`}parseAITaskAssignments(e,t,r,i){try{const n=e.match(/\[[\s\S]*\]/);if(!n)return console.warn("No JSON array found in AI response, using fallback"),this.fallbackTaskAssignment(t,r,i);const o=JSON.parse(n[0]);if(!Array.isArray(o))return console.warn("AI response is not an array, using fallback"),this.fallbackTaskAssignment(t,r,i);const s=[],a=new Map(r.map(u=>[u.id,u])),l=new Map(t.map(u=>[u.id,u]));for(const u of o){if(!u.userId||!Array.isArray(u.tasks))continue;if(!a.get(u.userId)){console.warn(`User ${u.userId} not found, skipping assignment`);continue}const f=[];for(const m of u.tasks){if(!m.gapId)continue;const p=l.get(m.gapId);p&&f.push({id:Th(),title:p.title,description:p.description,category:p.category,priority:p.priority,points:p.estimatedPoints,estimatedDuration:p.estimatedDuration,dueDate:p.dueDate,type:p.type,assignedRole:p.assignedRole,facilityId:p.facilityId,metadata:p.metadata,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}f.length>0&&s.push({userId:u.userId,tasks:f})}return s.length>0?s:(console.warn("AI parsing produced no valid assignments, using fallback"),this.fallbackTaskAssignment(t,r,i))}catch(n){return console.error("Error parsing AI response:",n),this.fallbackTaskAssignment(t,r,i)}}fallbackTaskAssignment(e,t,r){const i=[],n=[...e].sort((s,a)=>so(a.priority)-so(s.priority)),o=new Map;for(const s of n){const a=t.filter(u=>(o.get(u.id)||0)<r.maxTasksPerUser);if(a.length===0)break;const l=this.findBestUserMatch(s,a);if(l){const u=o.get(l.id)||0;o.set(l.id,u+1);let h=i.find(f=>f.userId===l.id);h||(h={userId:l.id,tasks:[]},i.push(h)),h.tasks.push({id:Ah(),title:s.title,description:s.description,category:s.category,priority:s.priority,points:s.estimatedPoints,dueDate:s.dueDate,type:s.type,estimatedDuration:s.estimatedDuration,assignedRole:s.assignedRole,facilityId:s.facilityId,metadata:s.metadata,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}}return i}findBestUserMatch(e,t){if(e.assignedRole){const i=t.find(n=>n.role===e.assignedRole);if(i)return i}const r=t.filter(i=>pc(i.role,e.category));return r.length>0?r[0]:t[0]||null}validateTaskAssignments(e,t){const r=[],i=[];return e.forEach((n,o)=>{var s;n.userId||r.push(`Assignment ${o+1}: Missing userId`),(!n.tasks||n.tasks.length===0)&&i.push(`Assignment ${o+1}: No tasks assigned`),n.tasks&&n.tasks.length>t.maxTasksPerUser&&r.push(`Assignment ${o+1}: Exceeds max tasks per user (${n.tasks.length} > ${t.maxTasksPerUser})`),(s=n.tasks)==null||s.forEach((a,l)=>{a.title||r.push(`Assignment ${o+1}, Task ${l+1}: Missing title`),a.category||r.push(`Assignment ${o+1}, Task ${l+1}: Missing category`),a.priority||r.push(`Assignment ${o+1}, Task ${l+1}: Missing priority`),a.points<=0&&i.push(`Assignment ${o+1}, Task ${l+1}: Zero or negative points`),a.estimatedDuration<=0&&i.push(`Assignment ${o+1}, Task ${l+1}: Zero or negative duration`)})}),{isValid:r.length===0,errors:r,warnings:i}}getAssignmentStatistics(e){const t=e.length,r=e.reduce((l,u)=>l+u.tasks.length,0),i=t>0?r/t:0,n={},o={};let s=0,a=0;return e.forEach(l=>{l.tasks.forEach(u=>{n[u.priority]=(n[u.priority]||0)+1,o[u.category]=(o[u.category]||0)+1,s+=u.points,a+=u.estimatedDuration})}),{totalAssignments:t,totalTasks:r,averageTasksPerUser:i,tasksByPriority:n,tasksByCategory:o,totalPoints:s,totalEstimatedDuration:a}}optimizeTaskAssignments(e,t){const r=new Map;e.forEach(o=>{const s={taskCount:o.tasks.length,totalPoints:o.tasks.reduce((a,l)=>a+l.points,0),totalDuration:o.tasks.reduce((a,l)=>a+l.estimatedDuration,0)};r.set(o.userId,s)});const i=[...e];return Array.from(r.entries()).filter(([o,s])=>s.taskCount>t.maxTasksPerUser).map(([o,s])=>o).forEach(o=>{const s=i.find(u=>u.userId===o);if(!s)return;const a=s.tasks.slice(t.maxTasksPerUser);s.tasks=s.tasks.slice(0,t.maxTasksPerUser);const l=i.filter(u=>u.tasks.length<t.maxTasksPerUser&&u.userId!==o);a.forEach(u=>{if(l.length>0){const h=l[0];h.tasks.push(u);const f=l.findIndex(m=>m.userId===h.userId);f>=0&&h.tasks.length>=t.maxTasksPerUser&&l.splice(f,1)}})}),i}exportTaskAssignments(e){return JSON.stringify(e,null,2)}importTaskAssignments(e){try{const t=JSON.parse(e);if(!Array.isArray(t))return{success:!1,assignments:[],errors:["Invalid format: expected array of assignments"]};const r=[];return t.forEach((i,n)=>{i.userId||r.push(`Assignment ${n+1}: Missing userId`),(!i.tasks||!Array.isArray(i.tasks))&&r.push(`Assignment ${n+1}: Missing or invalid tasks array`)}),{success:r.length===0,assignments:t,errors:r}}catch(t){return{success:!1,assignments:[],errors:["Invalid JSON format"]}}}}var vi=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Vm{getFacilityUsers(e){return vi(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("id, full_name, role, department, is_active, facility_id").eq("facility_id",e).eq("is_active",!0);if(r)throw r;return(t||[]).map(i=>{const n=i;return{id:n.id,role:n.role,full_name:n.full_name,department:n.department,is_active:n.is_active,facility_id:n.facility_id}})})}getUsersByRole(e,t){return vi(this,null,function*(){return(yield this.getFacilityUsers(e)).filter(i=>i.role===t)})}getUsersByDepartment(e,t){return vi(this,null,function*(){return(yield this.getFacilityUsers(e)).filter(i=>i.department===t)})}getAvailableRoles(){return[{role:"technician",description:"Equipment maintenance and repair specialist",capabilities:["equipment_maintenance","tool_repair","calibration"],compatibleCategories:["equipment","compliance"]},{role:"operator",description:"Daily operations and sterilization specialist",capabilities:["sterilization","daily_operations","bi_testing"],compatibleCategories:["operational","compliance"]},{role:"cleaning_staff",description:"Environmental cleaning and sanitation specialist",capabilities:["environmental_cleaning","sanitization","compliance"],compatibleCategories:["compliance","operational"]},{role:"inventory_manager",description:"Inventory management and supply specialist",capabilities:["inventory_management","supply_ordering","stock_control"],compatibleCategories:["operational"]},{role:"supervisor",description:"Operations oversight and safety specialist",capabilities:["safety_investigation","quality_control","oversight"],compatibleCategories:["safety","operational"]},{role:"manager",description:"Facility management and coordination",capabilities:["facility_management","coordination","planning"],compatibleCategories:["operational","safety","compliance"]}]}isRoleCompatibleWithCategory(e,t){const i=this.getAvailableRoles().find(n=>n.role===e);return i?i.compatibleCategories.includes(t):!1}getRoleCapabilities(e){const r=this.getAvailableRoles().find(i=>i.role===e);return(r==null?void 0:r.capabilities)||[]}findBestUserMatch(e,t,r){if(e.assignedRole){const n=t.find(o=>o.role===e.assignedRole);if(n)return n}const i=t.filter(n=>this.isRoleCompatibleWithCategory(n.role,e.category));return i.length>0?r?i.reduce((n,o)=>{const s=r.get(n.id),a=r.get(o.id);return s?a&&a.utilization<s.utilization?o:n:o}):i[0]:r&&t.length>0?t.reduce((n,o)=>{const s=r.get(n.id),a=r.get(o.id);return s?a&&a.utilization<s.utilization?o:n:o}):t[0]||null}calculateUserWorkload(e,t,r,i,n=5){const o=n,s=o>0?t/o*100:0;return{userId:e,currentTasks:t,totalPoints:r,totalDuration:i,capacity:o,utilization:s}}getUserWorkloadStatistics(e,t){const r=e.length;let i=0,n=0,o=0;const s={},a={low:0,medium:0,high:0};e.forEach(u=>{const h=t.get(u.id);h&&(i+=h.utilization,h.utilization>100?n++:h.utilization<50&&o++,h.utilization<50?a.low++:h.utilization<=80?a.medium++:a.high++,s[u.role]=(s[u.role]||0)+h.utilization)});const l=r>0?i/r:0;return{totalUsers:r,averageUtilization:l,overloadedUsers:n,underutilizedUsers:o,workloadByRole:s,workloadDistribution:a}}getUsersWithCapacity(e,t,r){return e.filter(i=>{const n=t.get(i.id);return!n||n.currentTasks<r})}getOverloadedUsers(e,t,r){return e.filter(i=>{const n=t.get(i.id);return n&&n.currentTasks>r})}balanceWorkload(e,t,r){const i=[],n=this.getOverloadedUsers(e,t,r),o=this.getUsersWithCapacity(e,t,r);return n.length>0&&(o.length>0?i.push({type:"redistribute",description:`Redistribute tasks from ${n.length} overloaded users to ${o.length} users with capacity`,priority:"high"}):i.push({type:"add_user",description:"All users are at capacity. Consider adding more staff or increasing capacity limits",priority:"high"})),Array.from(t.values()).reduce((a,l)=>a+l.utilization,0)/t.size>90&&i.push({type:"reduce_tasks",description:"Overall utilization is very high. Consider reducing task load or adding resources",priority:"medium"}),{recommendations:i,canBalance:o.length>0}}getUserPerformanceMetrics(e,t){return vi(this,null,function*(){return(yield this.getFacilityUsers(e)).map(i=>({userId:i.id,userName:i.full_name,role:i.role,tasksCompleted:0,averageCompletionTime:0,pointsEarned:0,efficiency:0}))})}validateUserData(e){const t=[];(!e.id||e.id.trim()==="")&&t.push("User ID is required"),(!e.role||e.role.trim()==="")&&t.push("User role is required"),(!e.full_name||e.full_name.trim()==="")&&t.push("Full name is required"),(!e.facility_id||e.facility_id.trim()==="")&&t.push("Facility ID is required");const r=this.getAvailableRoles();return e.role&&!r.find(i=>i.role===e.role)&&t.push(`Invalid role: ${e.role}`),{isValid:t.length===0,errors:t}}exportUserData(e){return JSON.stringify(e,null,2)}importUserData(e){try{const t=JSON.parse(e);if(!Array.isArray(t))return{success:!1,users:[],errors:["Invalid format: expected array of users"]};const r=[];return t.forEach((i,n)=>{const o=this.validateUserData(i);o.isValid||r.push(`User ${n+1}: ${o.errors.join(", ")}`)}),{success:r.length===0,users:t,errors:r}}catch(t){return{success:!1,users:[],errors:["Invalid JSON format"]}}}}var Hm=Object.defineProperty,Gm=Object.defineProperties,Wm=Object.getOwnPropertyDescriptors,jo=Object.getOwnPropertySymbols,Km=Object.prototype.hasOwnProperty,Qm=Object.prototype.propertyIsEnumerable,Vo=(c,e,t)=>e in c?Hm(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ym=(c,e)=>{for(var t in e||(e={}))Km.call(e,t)&&Vo(c,t,e[t]);if(jo)for(var t of jo(e))Qm.call(e,t)&&Vo(c,t,e[t]);return c},Jm=(c,e)=>Gm(c,Wm(e));const Ho={inventory_items:{defaultLimit:50,maxLimit:200,maxOffset:1e4,allowedOrderByFields:["created_at","updated_at","name","category","quantity"],defaultOrderBy:"created_at",defaultOrderDirection:"desc"},sterilization_cycles:{defaultLimit:100,maxLimit:500,maxOffset:5e3,allowedOrderByFields:["start_time","created_at","cycle_number","status"],defaultOrderBy:"start_time",defaultOrderDirection:"desc"},audit_logs:{defaultLimit:100,maxLimit:500,maxOffset:2e3,allowedOrderByFields:["created_at","action","module"],defaultOrderBy:"created_at",defaultOrderDirection:"desc"},users:{defaultLimit:100,maxLimit:500,maxOffset:2e3,allowedOrderByFields:["created_at","email","role"],defaultOrderBy:"created_at",defaultOrderDirection:"desc"},admin_task_config:{defaultLimit:20,maxLimit:100,maxOffset:1e3,allowedOrderByFields:["facility_id","created_at","updated_at"],defaultOrderBy:"facility_id",defaultOrderDirection:"asc"},default:{defaultLimit:50,maxLimit:200,maxOffset:5e3,allowedOrderByFields:["created_at","id"],defaultOrderBy:"created_at",defaultOrderDirection:"desc"}};function an(c={},e="default"){const t=Ho[e]||Ho.default;let r=c.limit||t.defaultLimit;r<=0&&(r=t.defaultLimit),r>t.maxLimit&&(v.warn(`Query limit ${r} exceeds maximum ${t.maxLimit} for table ${e}, capping to maximum`),r=t.maxLimit);let i=c.offset||0;i<0&&(i=0),i>t.maxOffset&&(v.warn(`Query offset ${i} exceeds maximum ${t.maxOffset} for table ${e}, capping to maximum`),i=t.maxOffset);let n=c.orderBy||t.defaultOrderBy;t.allowedOrderByFields.includes(n)||(v.warn(`Order by field '${n}' not allowed for table ${e}, using default '${t.defaultOrderBy}'`),n=t.defaultOrderBy);const o=c.orderDirection||t.defaultOrderDirection;return["asc","desc"].includes(o)||v.warn(`Invalid order direction '${o}' for table ${e}, using default '${t.defaultOrderDirection}'`),Jm(Ym({},c),{limit:r,offset:i,orderBy:n,orderDirection:o})}function Xm(c,e={},t="default"){const r=an(e,t);return{query:c.limit(r.limit).range(r.offset,r.offset+r.limit-1),offset:r.offset,limit:r.limit}}function Zm(c,e={},t="default"){const r=an(e,t);return c.order(r.orderBy,{ascending:r.orderDirection==="asc"})}function ep(c,e,t={},r="default"){const i=an(t,r),n=Math.ceil(e/i.limit),o=Math.floor(i.offset/i.limit)+1;return{data:c,total:e,page:o,limit:i.limit,totalPages:n,hasNext:o<n,hasPrev:o>1}}function tp(c,e){return["id","created_at","updated_at"].join(", ")}function rp(c,e={},t="default"){const r=an(e,t),i=Zm(c,r,t),{query:n}=Xm(i,r,t);return{query:n,safeOptions:r,warnings:[]}}var ip=Object.defineProperty,np=Object.defineProperties,ap=Object.getOwnPropertyDescriptors,Go=Object.getOwnPropertySymbols,op=Object.prototype.hasOwnProperty,sp=Object.prototype.propertyIsEnumerable,Wo=(c,e,t)=>e in c?ip(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,cp=(c,e)=>{for(var t in e||(e={}))op.call(e,t)&&Wo(c,t,e[t]);if(Go)for(var t of Go(e))sp.call(e,t)&&Wo(c,t,e[t]);return c},lp=(c,e)=>np(c,ap(e)),it=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Cn{static getConfig(e){return it(this,null,function*(){try{const{data:t,error:r}=yield d.from("admin_task_config").select("id, facility_id, max_tasks_per_user, enabled_categories, priority_thresholds, auto_assignment, ai_sensitivity, ai_confidence_threshold, max_ai_processing_time_ms, workload_balancing_enabled, max_concurrent_tasks_per_user, role_category_mapping, task_notifications_enabled, notification_channels, compliance_tracking_enabled, audit_logging_enabled, task_optimization_enabled, predictive_assignment_enabled, created_by, updated_by, created_at, updated_at").eq("facility_id",e).single();if(r){if(r.code==="PGRST116")return v.info(`No admin config found for facility ${e}, creating default`),yield this.createDefaultConfig(e);throw r}return this.mapDatabaseToConfig(t)}catch(t){throw v.error("Error getting admin task config:",t),new Error("Failed to retrieve admin task configuration")}})}static updateConfig(e,t){return it(this,null,function*(){return this.upsertConfig(e,t)})}static upsertConfig(e,t){return it(this,null,function*(){try{const r=vh(t),i=Le(),n={facility_id:e,max_tasks_per_user:r.maxTasksPerUser,enabled_categories:r.enabledCategories,priority_thresholds:r.priorityThresholds,auto_assignment:r.autoAssignment,ai_sensitivity:r.aiSensitivity,ai_confidence_threshold:.75,max_ai_processing_time_ms:3e4,workload_balancing_enabled:!0,max_concurrent_tasks_per_user:5,role_category_mapping:{equipment:["technician","maintenance"],compliance:["supervisor","manager","operator"],operational:["operator","inventory_manager"],safety:["supervisor","manager"]},task_notifications_enabled:!0,notification_channels:["email","in_app"],compliance_tracking_enabled:!0,audit_logging_enabled:!0,task_optimization_enabled:!0,predictive_assignment_enabled:!0,updated_by:i},{data:o,error:s}=yield d.from("admin_task_config").upsert(n,{onConflict:"facility_id",ignoreDuplicates:!1}).select("*").single();if(s)throw s;return v.info(`Admin task config updated for facility ${e}`),this.mapDatabaseToConfig(o)}catch(r){throw v.error("Error upserting admin task config:",r),new Error("Failed to save admin task configuration")}})}static createDefaultConfig(e){return it(this,null,function*(){try{const t=Le(),r={facility_id:e,max_tasks_per_user:3,enabled_categories:["equipment","compliance","operational","safety"],priority_thresholds:{low:1,medium:2,high:3,urgent:4},auto_assignment:!0,ai_sensitivity:"medium",ai_confidence_threshold:.75,max_ai_processing_time_ms:3e4,workload_balancing_enabled:!0,max_concurrent_tasks_per_user:5,role_category_mapping:{equipment:["technician","maintenance"],compliance:["supervisor","manager","operator"],operational:["operator","inventory_manager"],safety:["supervisor","manager"]},task_notifications_enabled:!0,notification_channels:["email","in_app"],compliance_tracking_enabled:!0,audit_logging_enabled:!0,task_optimization_enabled:!0,predictive_assignment_enabled:!0,created_by:t,updated_by:t},{data:i,error:n}=yield d.from("admin_task_config").insert(r).select("*").single();if(n)throw n;return v.info(`Default admin task config created for facility ${e}`),this.mapDatabaseToConfig(i)}catch(t){throw v.error("Error creating default admin task config:",t),new Error("Failed to create default admin task configuration")}})}static deleteConfig(e){return it(this,null,function*(){try{const{error:t}=yield d.from("admin_task_config").delete().eq("facility_id",e);if(t)throw t;v.info(`Admin task config deleted for facility ${e}`)}catch(t){throw v.error("Error deleting admin task config:",t),new Error("Failed to delete admin task configuration")}})}static mapDatabaseToConfig(e){var t;return{maxTasksPerUser:e.max_tasks_per_user,enabledCategories:e.enabled_categories||[],priorityThresholds:e.priority_thresholds||{low:1,medium:2,high:3,urgent:4},priorityWeights:e.priority_weights||{low:1,medium:2,high:3,urgent:4},rolePreferences:e.role_category_mapping||{},timeConstraints:e.time_constraints||{maxTaskDuration:120,minTaskDuration:5},autoAssignment:e.auto_assignment,aiSensitivity:e.ai_sensitivity||"medium",aiEnabled:(t=e.ai_enabled)!=null?t:!0}}static getAllConfigs(){return it(this,arguments,function*(e={}){try{const{orderBy:t="facility_id",orderDirection:r="asc"}=e,{query:i,safeOptions:n,warnings:o}=rp(d.from("admin_task_config"),lp(cp({},e),{orderBy:t,orderDirection:r}),"admin_task_config"),s=i.select(tp("admin_task_config"),{count:"exact"}),{data:a,error:l,count:u}=yield s;if(l)throw l;return o.length>0&&v.warn("Admin config query warnings:",o),ep(a||[],u||0,n,"admin_task_config")}catch(t){throw v.error("Error getting all admin task configs:",t),new Error("Failed to retrieve admin task configurations")}})}static getConfigHistory(e){return it(this,null,function*(){try{const{data:t,error:r}=yield d.from("admin_task_config").select("*").eq("facility_id",e).order("updated_at",{ascending:!1});if(r)throw r;return(t||[]).map(i=>({id:i.id,config:this.mapDatabaseToConfig(i),updatedAt:new Date(i.updated_at),updatedBy:i.updated_by||"Unknown",changes:[]}))}catch(t){return v.error("Error getting configuration history:",t),[]}})}static hasConfig(e){return it(this,null,function*(){try{const{count:t,error:r}=yield d.from("admin_task_config").select("*",{count:"exact",head:!0}).eq("facility_id",e);if(r)throw r;return(t||0)>0}catch(t){return v.error("Error checking admin task config existence:",t),!1}})}}var up=Object.defineProperty,dp=Object.defineProperties,hp=Object.getOwnPropertyDescriptors,Ko=Object.getOwnPropertySymbols,fp=Object.prototype.hasOwnProperty,mp=Object.prototype.propertyIsEnumerable,Qo=(c,e,t)=>e in c?up(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,wi=(c,e)=>{for(var t in e||(e={}))fp.call(e,t)&&Qo(c,t,e[t]);if(Ko)for(var t of Ko(e))mp.call(e,t)&&Qo(c,t,e[t]);return c},Ii=(c,e)=>dp(c,hp(e)),Si=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class pp{getAdminTaskConfig(e){return Si(this,null,function*(){try{if(!e){const{FacilityService:t}=yield T(()=>Promise.resolve().then(()=>ye),void 0);e=yield t.getCurrentFacilityId()}return yield Cn.getConfig(e)}catch(t){return console.warn("Failed to get admin config from database, using default:",t),En()}})}updateAdminTaskConfig(e,t){return Si(this,null,function*(){try{return yield Cn.updateConfig(e,t)}catch(r){throw console.error("Failed to update admin config:",r),r}})}resetToDefaults(e){return Si(this,null,function*(){const t=En();return yield this.updateAdminTaskConfig(e,t)})}validateConfig(e){const t=[],r=[];if(e.maxTasksPerUser!==void 0&&(e.maxTasksPerUser<1&&t.push("Max tasks per user must be at least 1"),e.maxTasksPerUser>20&&r.push("Max tasks per user is very high, may impact user productivity")),e.priorityWeights){const i=e.priorityWeights;i.urgent!==void 0&&i.urgent<1&&t.push("Urgent priority weight must be at least 1"),i.high!==void 0&&i.high<1&&t.push("High priority weight must be at least 1"),i.medium!==void 0&&i.medium<1&&t.push("Medium priority weight must be at least 1"),i.low!==void 0&&i.low<1&&t.push("Low priority weight must be at least 1"),i.urgent&&i.high&&i.urgent<=i.high&&r.push("Urgent priority weight should be higher than high priority"),i.high&&i.medium&&i.high<=i.medium&&r.push("High priority weight should be higher than medium priority"),i.medium&&i.low&&i.medium<=i.low&&r.push("Medium priority weight should be higher than low priority")}if(e.rolePreferences&&Object.entries(e.rolePreferences).forEach(([i,n])=>{Array.isArray(n)?n.forEach(o=>{pc(i,o)||r.push(`Role ${i} may not be compatible with category ${o}`)}):t.push(`Role preferences for ${i} must be an array`)}),e.timeConstraints){const i=e.timeConstraints;i.maxTaskDuration!==void 0&&i.maxTaskDuration<5&&t.push("Max task duration must be at least 5 minutes"),i.minTaskDuration!==void 0&&i.minTaskDuration<1&&t.push("Min task duration must be at least 1 minute"),i.maxTaskDuration&&i.minTaskDuration&&i.maxTaskDuration<=i.minTaskDuration&&t.push("Max task duration must be greater than min task duration")}return{isValid:t.length===0,errors:t,warnings:r}}getConfigurationRecommendations(e,t){const r=[];if(t&&(t.taskCompletionRate<.8&&r.push({category:"performance",title:"Low Task Completion Rate",description:`Current completion rate is ${(t.taskCompletionRate*100).toFixed(1)}%. Consider reducing max tasks per user or improving task assignment.`,priority:"high",suggestedValue:Math.max(1,e.maxTasksPerUser-1)}),t.averageTasksPerUser>e.maxTasksPerUser*.9&&r.push({category:"workload",title:"High User Workload",description:`Users are consistently at ${(t.averageTasksPerUser/e.maxTasksPerUser*100).toFixed(1)}% capacity. Consider increasing max tasks or adding more users.`,priority:"medium",suggestedValue:e.maxTasksPerUser+1}),t.averageTaskDuration>120&&r.push({category:"performance",title:"Long Task Duration",description:`Average task duration is ${t.averageTaskDuration} minutes. Consider breaking down complex tasks or adjusting time estimates.`,priority:"medium"})),e.priorityWeights){const i=e.priorityWeights;i.urgent&&i.high&&i.urgent<=i.high&&r.push({category:"priority",title:"Priority Weight Ordering",description:"Urgent priority weight should be higher than high priority to ensure proper task prioritization.",priority:"medium",suggestedValue:Ii(wi({},i),{urgent:i.high+1})})}return(!e.rolePreferences||Object.keys(e.rolePreferences).length===0)&&r.push({category:"role",title:"Missing Role Preferences",description:"No role preferences configured. Consider setting up role-category mappings for better task assignment.",priority:"low",suggestedValue:{technician:["equipment","compliance"],operator:["operational","compliance"],cleaning_staff:["compliance"],inventory_manager:["operational"],supervisor:["safety","operational"]}}),r}getDefaultConfigForFacilityType(e){const t=En();switch(e){case"small":return Ii(wi({},t),{maxTasksPerUser:3,priorityWeights:{urgent:10,high:7,medium:4,low:1}});case"medium":return Ii(wi({},t),{maxTasksPerUser:5,priorityWeights:{urgent:12,high:8,medium:5,low:2}});case"large":return Ii(wi({},t),{maxTasksPerUser:7,priorityWeights:{urgent:15,high:10,medium:6,low:3}});default:return t}}exportConfig(e){return JSON.stringify(e,null,2)}importConfig(e){try{const t=JSON.parse(e),r=this.validateConfig(t);return{success:r.isValid,config:r.isValid?t:null,errors:r.errors}}catch(t){return{success:!1,config:null,errors:["Invalid JSON format"]}}}getConfigurationHistory(e){return Si(this,null,function*(){try{return yield Cn.getConfigHistory(e)}catch(t){return console.error("Failed to get configuration history:",t),[]}})}compareConfigurations(e,t){const r=[];return new Set([...Object.keys(e),...Object.keys(t)]).forEach(n=>{const o=e[n],s=t[n];o===void 0&&s!==void 0?r.push({field:n,oldValue:void 0,newValue:s,type:"added"}):o!==void 0&&s===void 0?r.push({field:n,oldValue:o,newValue:void 0,type:"removed"}):JSON.stringify(o)!==JSON.stringify(s)&&r.push({field:n,oldValue:o,newValue:s,type:"modified"})}),{changes:r,hasChanges:r.length>0}}getConfigurationSummary(e){var t;const r=e.priorityWeights?Object.keys(e.priorityWeights).length:0,i=e.rolePreferences?Object.keys(e.rolePreferences).length:0,n=!!e.timeConstraints,o=e.aiEnabled!==!1;let s="simple";return(r>2||i>3||n)&&(s="moderate"),(r>3||i>5||n&&((t=e.timeConstraints)!=null&&t.maxTaskDuration))&&(s="complex"),{maxTasksPerUser:e.maxTasksPerUser,priorityCount:r,rolePreferencesCount:i,timeConstraintsEnabled:n,aiEnabled:o,complexity:s}}}var on=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const gp=new Nm,yp=new jm,_p=new Vm,vp=new pp;function wp(c){return on(this,null,function*(){return gp.scanOperationalGaps(c)})}function Ip(c){return on(this,null,function*(){return _p.getFacilityUsers(c)})}function Sp(c){return on(this,null,function*(){return vp.getAdminTaskConfig(c)})}function bp(c,e,t){return on(this,null,function*(){return yp.assignTasksWithAI(c,e,t)})}var Nr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Ep{generateDailyTasks(e){return Nr(this,null,function*(){try{const t=yield wp(e);if(t.length===0)return console.log("No operational gaps found for daily tasks"),[];const r=yield Ip(e),i=yield Sp(),n=yield bp(t,r,i);return yield kh(n,e),n}catch(t){throw console.error("Error generating daily tasks:",t),new Error(`Failed to generate daily tasks: ${t instanceof Error?t.message:"Unknown error"}`)}})}getUserDailyTasks(e){return Nr(this,null,function*(){return Ph(e)})}getFacilityDailyTasks(e){return Nr(this,null,function*(){return Ch(e)})}completeDailyTask(e,t){return Nr(this,null,function*(){return Dh(e,t)})}updateDailyTask(e,t){return Nr(this,null,function*(){try{const{data:{user:r}}=yield d.auth.getUser();if(!r)throw new Error("User not authenticated");const{data:i,error:n}=yield d.from("users").select("facility_id").eq("id",r.id).single();if(n||!(i!=null&&i.facility_id))throw new Error("User facility not found");const o={updated_at:new Date().toISOString()};t.title!==void 0&&(o.title=t.title),t.description!==void 0&&(o.description=t.description),t.category!==void 0&&(o.category=t.category),t.difficulty!==void 0&&(o.difficulty=t.difficulty),t.points!==void 0&&(o.points=t.points),t.timeEstimate!==void 0&&(o.time_estimate=t.timeEstimate),t.isCompleted!==void 0&&(o.is_completed=t.isCompleted);const{data:s,error:a}=yield d.from("home_challenges").update(o).eq("id",e).eq("facility_id",i.facility_id).select().single();if(a)throw new Error(`Failed to update task: ${a.message}`);return{id:s.id,title:s.title,description:s.description||"",category:s.category,difficulty:s.difficulty,points:s.points,timeEstimate:s.time_estimate,isCompleted:s.is_completed||!1,completedAt:s.completed_at||null,pointsEarned:s.points_earned||0,createdAt:s.created_at,updatedAt:s.updated_at}}catch(r){throw console.error("Error updating daily task:",r),r}})}}const xv=new Ep;var je=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Ap{constructor(){this.baselineData=null,this.lastUpdate=0,this.UPDATE_INTERVAL=120*1e3,this.cachedMetrics=null}getAIImpactMetrics(){return je(this,null,function*(){try{const e=Date.now();if(e-this.lastUpdate<this.UPDATE_INTERVAL)return this.getCachedMetrics();this.baselineData||(this.baselineData=yield this.getBaselineData());const t=yield this.calculateRealTimeMetrics();return this.cacheMetrics(t),this.lastUpdate=e,t}catch(e){return console.error("Error getting AI impact metrics:",e),this.getDefaultMetrics()}})}calculateRealTimeMetrics(){return je(this,null,function*(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate());new Date(t.getTime()-t.getDay()*24*60*60*1e3);const r=new Date(e.getFullYear(),e.getMonth(),1),{FacilityService:i}=yield T(()=>Promise.resolve().then(()=>ye),void 0),n=yield i.getCurrentFacilityId(),{data:o}=yield d.from("ai_task_performance").select("*").eq("facility_id",n).gte("completed_at",r.toISOString()),{data:s}=yield d.from("ai_challenge_completions").select("*").eq("facility_id",n).gte("completed_at",r.toISOString()),a=yield this.calculateProactiveManagement(o||[],s||[]),{aiTimeSavingsService:l}=yield T(()=>Promise.resolve().then(()=>Dg),void 0),u=yield l.getAITimeSavings(),h={daily:u.daily_time_saved,weekly:Math.round(u.daily_time_saved*7),monthly:u.monthly_time_saved,total:u.monthly_time_saved,percentage:0},{aiCostCalculationService:f}=yield T(()=>Promise.resolve().then(()=>Tp),void 0),m=yield f.calculateCostSavings(h,o||[]),p=yield this.calculateEfficiencyGains(o||[]);return{timeSavings:h,proactiveManagement:a,costSavings:m,efficiencyGains:p,realTimeUpdates:{lastUpdated:new Date().toISOString(),nextUpdate:new Date(Date.now()+this.UPDATE_INTERVAL).toISOString(),dataFreshness:Math.floor((Date.now()-this.lastUpdate)/6e4)}}})}calculateTimeSavings(e,t,r,i){return je(this,null,function*(){var n;const s=e.filter(y=>new Date(y.completed_at)>=t).reduce((y,_)=>y+(_.time_saved||0),0),l=e.filter(y=>new Date(y.completed_at)>=r).reduce((y,_)=>y+(_.time_saved||0),0),u=e.filter(y=>new Date(y.completed_at)>=i),h=u.reduce((y,_)=>y+(_.time_saved||0),0),f=e.reduce((y,_)=>y+(_.time_saved||0),0),m=((n=this.baselineData)==null?void 0:n.preAITaskDuration)||30,p=u.length>0?u.reduce((y,_)=>y+_.actual_duration,0)/u.length:m,g=m>0?Math.round((m-p)/m*100):0;return{daily:s,weekly:l,monthly:h,total:f,percentage:Math.max(0,Math.min(100,g))}})}calculateProactiveManagement(e,t){return je(this,null,function*(){const r=new Date;r.setHours(r.getHours()+2);const i=e.filter(m=>new Date(m.completed_at)<r).length,n=e.filter(m=>m.estimated_duration&&m.actual_duration&&m.actual_duration<m.estimated_duration).length,o=e.length,s=e.filter(m=>m.estimated_duration&&m.actual_duration&&m.actual_duration<=m.estimated_duration).length,a=o>0?Math.round(s/o*100):100,l=e.filter(m=>m.difficulty==="high"||m.difficulty==="urgent").length,u=o>0?Math.round((o-l)/o*100):100,h=t.filter(m=>m.quality_score&&m.quality_score>=4).length,f=t.length>0?Math.round(h/t.length*100):100;return{issuesPrevented:i,earlyInterventions:n,complianceScore:a,riskMitigation:u,predictiveAccuracy:f}})}calculateEfficiencyGains(e){return je(this,null,function*(){const t=e.length,r=e.filter(l=>l.completed_at).length,i=t>0?Math.round(r/t*100):100,n=e.length>0?e.reduce((l,u)=>l+(u.efficiency_score||0),0)/e.length:100,o=Math.round(n),s=yield this.calculateResourceOptimization(),a=yield this.calculateWorkflowStreamlining();return{taskCompletionRate:i,qualityImprovement:o,resourceOptimization:s,workflowStreamlining:a}})}calculateResourceOptimization(){return je(this,null,function*(){try{const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ye),void 0),t=yield e.getCurrentFacilityId(),{data:r}=yield d.from("sterilization_cycles").select("tools").eq("facility_id",t).gte("created_at",new Date(Date.now()-10080*60*1e3).toISOString());if(!r||r.length===0)return 85;const n=r.reduce((a,l)=>{var u;return a+(((u=l.tools)==null?void 0:u.length)||0)},0)/r.length,o={min:6,max:8},s=n>=o.min&&n<=o.max?100:Math.max(0,100-Math.abs(n-7)*10);return Math.round(s)}catch(e){return console.error(e),console.error("Error calculating resource optimization"),85}})}calculateWorkflowStreamlining(){return je(this,null,function*(){try{const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ye),void 0),t=yield e.getCurrentFacilityId(),{data:r}=yield d.from("home_daily_operations_tasks").select("estimated_duration, actual_duration").eq("facility_id",t).gte("created_at",new Date(Date.now()-10080*60*1e3).toISOString());if(!r||r.length===0)return 80;const i=r.map(o=>!o.estimated_duration||!o.actual_duration?100:Math.max(0,Math.min(100,o.estimated_duration/o.actual_duration*100))),n=i.reduce((o,s)=>o+s,0)/i.length;return Math.round(n)}catch(e){return console.error("Error calculating workflow streamlining:",e),80}})}getBaselineData(){return je(this,null,function*(){try{return{preAITaskDuration:45,preAICompletionRate:75,preAIErrorRate:15,preAICostPerTask:33.75,implementationDate:"2024-01-01"}}catch(e){return console.error("Error getting baseline data:",e),{preAITaskDuration:45,preAICompletionRate:75,preAIErrorRate:15,preAICostPerTask:33.75,implementationDate:"2024-01-01"}}})}cacheMetrics(e){this.cachedMetrics=e}getCachedMetrics(){return this.cachedMetrics||this.getDefaultMetrics()}getDefaultMetrics(){return{timeSavings:{daily:0,weekly:0,monthly:0,total:0,percentage:0},proactiveManagement:{issuesPrevented:0,earlyInterventions:0,complianceScore:100,riskMitigation:100,predictiveAccuracy:100},costSavings:{daily:0,monthly:0,annual:0,roi:0},efficiencyGains:{taskCompletionRate:100,qualityImprovement:100,resourceOptimization:85,workflowStreamlining:80},realTimeUpdates:{lastUpdated:new Date().toISOString(),nextUpdate:new Date(Date.now()+this.UPDATE_INTERVAL).toISOString(),dataFreshness:0}}}getAIInsights(){return je(this,null,function*(){try{const e=yield this.getAIImpactMetrics(),{aiReportingService:t}=yield T(()=>Promise.resolve().then(()=>Pp),void 0);return yield t.getAIInsights(e)}catch(e){return console.error("Error getting AI insights:",e),["AI system is actively monitoring facility operations"]}})}}const Yo=new Ap;var Lt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Pc{calculateCostSavings(e,t){return Lt(this,null,function*(){try{const r=yield this.getFacilityCosts(),i=this.calculateDirectTimeSavings(e,r.hourlyRate),n=yield this.calculateIndirectCostSavings(t,r),o=yield this.calculateErrorPreventionSavings(t,r),s=yield this.calculateComplianceSavings(),a=yield this.calculateResourceOptimizationSavings(),l=i.daily+n.daily+o.daily+s.daily+a.daily,u=i.monthly+n.monthly+o.monthly+s.monthly+a.monthly,h=1e4,f=u*12,m=h>0?f/h*100:0;return{daily:Math.round(l*100)/100,monthly:Math.round(u*100)/100,annual:Math.round(f*100)/100,roi:Math.round(m*100)/100}}catch(r){return console.error("Error calculating cost savings:",r),this.calculateBasicCostSavings(e)}})}getFacilityCosts(){return Lt(this,null,function*(){try{const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ye),void 0),t=yield e.getCurrentFacilityId(),{data:r}=yield d.from("facilities").select("hourly_rate, type, staff_count").eq("id",t).single();return{hourlyRate:(r==null?void 0:r.hourly_rate)||45,facilityType:(r==null?void 0:r.facility_type)||"general",staffCount:(r==null?void 0:r.staff_count)||10}}catch(e){return console.error(e),{hourlyRate:45,facilityType:"general",staffCount:10}}})}calculateDirectTimeSavings(e,t){return{daily:e.daily/60*t,monthly:e.monthly/60*t}}calculateIndirectCostSavings(e,t){return Lt(this,null,function*(){const i=t.hourlyRate*t.staffCount*.3*.5,n=i*22;return{daily:i,monthly:n}})}calculateErrorPreventionSavings(e,t){return Lt(this,null,function*(){try{const{FacilityService:r}=yield T(()=>Promise.resolve().then(()=>ye),void 0),i=yield r.getCurrentFacilityId(),{data:n}=yield d.from("quality_incidents").select("cost_impact, severity").eq("facility_id",i).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString());if(!n||n.length===0){const a=t.facilityType==="dental"?150:200;return{daily:a*.1,monthly:a*2}}const s=n.reduce((a,l)=>a+(l.cost_impact||0),0)*.4;return{daily:s/30,monthly:s}}catch(r){console.error(r);const i=200;return{daily:i*.1,monthly:i*2}}})}calculateComplianceSavings(){return Lt(this,null,function*(){return{daily:600/30,monthly:600}})}calculateResourceOptimizationSavings(){return Lt(this,null,function*(){try{const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ye),void 0),t=yield e.getCurrentFacilityId(),{data:r}=yield d.from("inventory_items").select("unit_cost, quantity, reorder_point").eq("facility_id",t),{data:i}=yield d.from("sterilization_cycles").select("tools, cycle_time").eq("facility_id",t).gte("created_at",new Date(Date.now()-10080*60*1e3).toISOString()),n=(r==null?void 0:r.filter(l=>l.quantity<l.reorder_point))||[],o=n?n.reduce((l,u)=>l+u.unit_cost*.1,0):100,s=i?i.reduce((l,u)=>l+u.cycle_time*.15,0):50,a=o+s;return{daily:a/30,monthly:a}}catch(e){return console.error(e),{daily:5,monthly:150}}})}calculateBasicCostSavings(e){const r=e.daily/60*45,i=e.monthly/60*45,n=i*12;return{daily:Math.round(r*100)/100,monthly:Math.round(i*100)/100,annual:Math.round(n*100)/100,roi:0}}}const Cc=new Pc,Tp=Object.freeze(Object.defineProperty({__proto__:null,AICostCalculationService:Pc,aiCostCalculationService:Cc},Symbol.toStringTag,{value:"Module"}));var kp=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Dc{getAIInsights(e){return kp(this,null,function*(){try{const t=[];return e.timeSavings.daily>120&&t.push(`🚀 AI saved ${Math.round(e.timeSavings.daily/60)} hours today!`),e.costSavings.monthly>1e3&&t.push(`💰 AI generated $${e.costSavings.monthly} in monthly savings`),e.proactiveManagement.issuesPrevented>5&&t.push(`🛡️ AI prevented ${e.proactiveManagement.issuesPrevented} potential issues this week`),e.costSavings.roi>50&&t.push(`📈 AI ROI: ${e.costSavings.roi}% - Excellent investment!`),t}catch(t){return console.error("Error getting AI insights:",t),["AI system is actively monitoring facility operations"]}})}generateAIImpactReport(e){return`
AI Impact Report - ${new Date().toLocaleDateString()}
================================================

TIME SAVINGS
------------
Daily: ${Math.round(e.timeSavings.daily/60)} hours (${Math.round(e.timeSavings.daily)} minutes)
Weekly: ${Math.round(e.timeSavings.weekly/60)} hours (${Math.round(e.timeSavings.weekly)} minutes)
Monthly: ${Math.round(e.timeSavings.monthly/60)} hours (${Math.round(e.timeSavings.monthly)} minutes)
Total: ${Math.round(e.timeSavings.total/60)} hours (${Math.round(e.timeSavings.total)} minutes)
Improvement: ${e.timeSavings.percentage}%

PROACTIVE MANAGEMENT
-------------------
Issues Prevented: ${e.proactiveManagement.issuesPrevented}
Early Interventions: ${e.proactiveManagement.earlyInterventions}
Compliance Score: ${e.proactiveManagement.complianceScore}%
Risk Mitigation: ${e.proactiveManagement.riskMitigation}%
Predictive Accuracy: ${e.proactiveManagement.predictiveAccuracy}%

COST SAVINGS
------------
Daily: $${e.costSavings.daily}
Monthly: $${e.costSavings.monthly}
Annual: $${e.costSavings.annual}
ROI: ${e.costSavings.roi}%

EFFICIENCY GAINS
----------------
Task Completion Rate: ${e.efficiencyGains.taskCompletionRate}%
Quality Improvement: ${e.efficiencyGains.qualityImprovement}%
Resource Optimization: ${e.efficiencyGains.resourceOptimization}%
Workflow Streamlining: ${e.efficiencyGains.workflowStreamlining}%

REAL-TIME UPDATES
-----------------
Last Updated: ${new Date(e.realTimeUpdates.lastUpdated).toLocaleString()}
Next Update: ${new Date(e.realTimeUpdates.nextUpdate).toLocaleString()}
Data Freshness: ${e.realTimeUpdates.dataFreshness} minutes
`.trim()}generateExecutiveSummary(e){return`
AI Implementation Executive Summary
==================================

KEY HIGHLIGHTS
--------------
• AI has saved ${Math.round(e.timeSavings.monthly/60)} hours this month
• Generated $${e.costSavings.monthly} in monthly cost savings
• Achieved ${e.costSavings.roi}% ROI on AI investment
• Prevented ${e.proactiveManagement.issuesPrevented} potential issues

PERFORMANCE METRICS
-------------------
• Time Efficiency: ${e.timeSavings.percentage}% improvement
• Cost Reduction: $${e.costSavings.annual} annual savings
• Compliance: ${e.proactiveManagement.complianceScore}% score
• Quality: ${e.efficiencyGains.qualityImprovement}% improvement

RECOMMENDATIONS
---------------
• Continue AI implementation across all departments
• Monitor ROI trends for investment decisions
• Expand proactive management capabilities
• Leverage efficiency gains for strategic planning

Generated: ${new Date().toLocaleString()}
`.trim()}generatePerformanceBreakdown(e){return{timeAnalysis:{dailyBreakdown:{hours:Math.round(e.timeSavings.daily/60),minutes:Math.round(e.timeSavings.daily),percentage:e.timeSavings.percentage},weeklyBreakdown:{hours:Math.round(e.timeSavings.weekly/60),minutes:Math.round(e.timeSavings.weekly)},monthlyBreakdown:{hours:Math.round(e.timeSavings.monthly/60),minutes:Math.round(e.timeSavings.monthly)}},costAnalysis:{savings:{daily:e.costSavings.daily,monthly:e.costSavings.monthly,annual:e.costSavings.annual},roi:e.costSavings.roi,investment:1e4},efficiencyAnalysis:{completion:e.efficiencyGains.taskCompletionRate,quality:e.efficiencyGains.qualityImprovement,resources:e.efficiencyGains.resourceOptimization,workflow:e.efficiencyGains.workflowStreamlining},proactiveAnalysis:{issues:e.proactiveManagement.issuesPrevented,interventions:e.proactiveManagement.earlyInterventions,compliance:e.proactiveManagement.complianceScore,risk:e.proactiveManagement.riskMitigation,accuracy:e.proactiveManagement.predictiveAccuracy},metadata:{generated:new Date().toISOString(),lastUpdated:e.realTimeUpdates.lastUpdated,nextUpdate:e.realTimeUpdates.nextUpdate,dataFreshness:e.realTimeUpdates.dataFreshness}}}}const Hi=new Dc,Pp=Object.freeze(Object.defineProperty({__proto__:null,AIReportingService:Dc,aiReportingService:Hi},Symbol.toStringTag,{value:"Module"}));var Dn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Oc{getAIImpactMetrics(){return Dn(this,null,function*(){return yield Yo.getAIImpactMetrics()})}getAIInsights(){return Dn(this,null,function*(){return yield Yo.getAIInsights()})}generateAIImpactReport(e){return Hi.generateAIImpactReport(e)}generateExecutiveSummary(e){return Hi.generateExecutiveSummary(e)}generatePerformanceBreakdown(e){return Hi.generatePerformanceBreakdown(e)}calculateCostSavings(e,t){return Dn(this,null,function*(){return yield Cc.calculateCostSavings(e,t)})}}const Rc=new Oc,Cp=Object.freeze(Object.defineProperty({__proto__:null,AIImpactMeasurementService:Oc,aiImpactMeasurementService:Rc},Symbol.toStringTag,{value:"Module"}));var Fr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Dp{constructor(){this.cache=null,this.CACHE_DURATION=1440*60*1e3,this.lastLogTime=0}fetchAndCacheMetricsOnLogin(){return Fr(this,null,function*(){try{v.debug("PerformanceMetricsCache: Fetching metrics on login...");const{homeMetricsService:e}=yield T(()=>Promise.resolve().then(()=>Bg),void 0),{homeSterilizationIntegration:t}=yield T(()=>Promise.resolve().then(()=>Hg),void 0),{homeIntegrationService:r}=yield T(()=>Promise.resolve().then(()=>Kg),void 0),{FacilityService:i}=yield T(()=>Promise.resolve().then(()=>ye),void 0),n=yield i.getCurrentFacilityId();if(!n)return v.debug("PerformanceMetricsCache: No facility ID, skipping cache"),null;const[o,s,a,l]=yield Promise.allSettled([e.getHomeMetrics(),t.getSterilizationMetrics(),r.getAllMetrics(),T(()=>Promise.resolve().then(()=>Cp),void 0).then(f=>f.aiImpactMeasurementService.getAIImpactMetrics())]),u=Date.now();u-this.lastLogTime>1e3&&(v.debug("🔍 PerformanceMetricsCache: AI Metrics result:",o),v.debug("🔍 PerformanceMetricsCache: Sterilization result:",s),v.debug("🔍 PerformanceMetricsCache: Integration result:",a),v.debug("🔍 PerformanceMetricsCache: AI Impact result:",l),this.lastLogTime=u);const h={aiMetrics:o.status==="fulfilled"?o.value:null,sterilizationMetrics:s.status==="fulfilled"?s.value:null,integrationMetrics:a.status==="fulfilled"?a.value:null,aiImpactMetrics:l.status==="fulfilled"?l.value:null,timestamp:Date.now(),facilityId:n};this.cache=h;try{localStorage.setItem("performanceMetricsCache",JSON.stringify(h))}catch(f){v.debug("PerformanceMetricsCache: Could not store in localStorage")}return u-this.lastLogTime>1e3&&(v.debug("PerformanceMetricsCache: Metrics cached successfully for facility:",n),this.lastLogTime=u),h}catch(e){return console.error("PerformanceMetricsCache: Error fetching metrics on login:",e),null}})}getCachedMetrics(){return Fr(this,null,function*(){if(this.cache&&(yield this.isCacheValid(this.cache)))return this.cache;try{const e=localStorage.getItem("performanceMetricsCache");if(e){const t=JSON.parse(e);if(yield this.isCacheValid(t))return this.cache=t,t}}catch(e){v.debug("PerformanceMetricsCache: Could not read from localStorage:",e)}return null})}refreshMetrics(){return Fr(this,null,function*(){return v.debug("PerformanceMetricsCache: Manual refresh requested"),this.cache=null,localStorage.removeItem("performanceMetricsCache"),yield this.fetchAndCacheMetricsOnLogin()})}isCacheValid(e){return Fr(this,null,function*(){const r=Date.now()-e.timestamp;if(r>this.CACHE_DURATION)return v.debug("PerformanceMetricsCache: Cache expired (age:",r,"ms)"),!1;try{if((yield Ot.getCurrentFacilityId())!==e.facilityId)return v.debug("PerformanceMetricsCache: Facility changed, cache invalid"),!1}catch(i){}return!0})}clearCache(){this.cache=null,localStorage.removeItem("performanceMetricsCache"),v.debug("PerformanceMetricsCache: Cache cleared")}getCacheStatus(){return Fr(this,null,function*(){const e=yield this.getCachedMetrics();return e?{hasCache:!0,age:Date.now()-e.timestamp,facilityId:e.facilityId}:{hasCache:!1}})}}const Bv=new Dp;var Op=Object.defineProperty,Rp=Object.defineProperties,$p=Object.getOwnPropertyDescriptors,Jo=Object.getOwnPropertySymbols,Mp=Object.prototype.hasOwnProperty,qp=Object.prototype.propertyIsEnumerable,Xo=(c,e,t)=>e in c?Op(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,zp=(c,e)=>{for(var t in e||(e={}))Mp.call(e,t)&&Xo(c,t,e[t]);if(Jo)for(var t of Jo(e))qp.call(e,t)&&Xo(c,t,e[t]);return c},Up=(c,e)=>Rp(c,$p(e)),Ve=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Np{static notifyContentApproval(e,t,r,i,n,o,s){return Ve(this,null,function*(){try{const a=yield this.getContentTitle(r,i),l={user_id:e,facility_id:t,notification_type:"content_approval",title:n==="approved"?"Content Approved!":"Content Needs Revision",message:n==="approved"?`Your ${i} "${a}" has been approved and published to the Library.${o?`

Reviewer comment: "${o}"`:""}`:`Your ${i} "${a}" needs revision.${o?`

Reason: "${o}"`:""}`,action_url:`/content-builder?tab=drafts&content=${r}`,action_data:{contentId:r,contentType:i,action:n,comments:o,approverName:s,contentTitle:a},module:"content_management",severity:n==="approved"?"success":"warning",expires_at:new Date(Date.now()+720*60*60*1e3).toISOString()},{data:u,error:h}=yield d.from("notifications").insert(l).select().single();if(h)throw h;return u}catch(a){throw console.error("Error creating content approval notification:",a),a}})}static notifyTaskAssignment(e,t,r,i,n){return Ve(this,null,function*(){try{const o={user_id:e,facility_id:t,notification_type:"task_assigned",title:"New Task Assigned",message:`You have been assigned a new task: "${i}"${n?`

${n}`:""}`,action_url:`/settings?tab=content&subtab=publishing&review=${r}`,action_data:{taskId:r,taskTitle:i,taskDescription:n},module:"content_management",severity:"info",expires_at:new Date(Date.now()+6048e5).toISOString()},{data:s,error:a}=yield d.from("notifications").insert(o).select().single();if(a)throw a;return s}catch(o){throw console.error("Error creating task assignment notification:",o),o}})}static getUserNotifications(e,t,r=50,i=!1){return Ve(this,null,function*(){try{let n=d.from("notifications").select("*").eq("user_id",e).eq("facility_id",t).order("created_at",{ascending:!1}).limit(r);i&&(n=n.is("read_at",null));const{data:o,error:s}=yield n;if(s)throw s;return o||[]}catch(n){throw console.error("Error fetching user notifications:",n),n}})}static markAsRead(e){return Ve(this,null,function*(){try{const{error:t}=yield d.from("notifications").update({read_at:new Date().toISOString(),is_read:!0}).eq("id",e);if(t)throw t}catch(t){throw console.error("Error marking notification as read:",t),t}})}static markAllAsRead(e,t){return Ve(this,null,function*(){try{const{error:r}=yield d.from("notifications").update({read_at:new Date().toISOString(),is_read:!0}).eq("user_id",e).eq("facility_id",t).is("read_at",null);if(r)throw r}catch(r){throw console.error("Error marking all notifications as read:",r),r}})}static getUnreadCount(e,t){return Ve(this,null,function*(){try{const{count:r,error:i}=yield d.from("notifications").select("*",{count:"exact",head:!0}).eq("user_id",e).eq("facility_id",t).is("read_at",null);if(i)throw i;return r||0}catch(r){throw console.error("Error fetching unread notification count:",r),r}})}static deleteExpiredNotifications(){return Ve(this,null,function*(){try{const{error:e}=yield d.from("notifications").delete().lt("expires_at",new Date().toISOString());if(e)throw e}catch(e){throw console.error("Error deleting expired notifications:",e),e}})}static getContentTitle(e,t){return Ve(this,null,function*(){try{const r=t==="learning_pathway"?"courses":t,{data:i,error:n}=yield d.from(r).select("title").eq("id",e).single();if(n)throw n;return(i==null?void 0:i.title)||"Untitled Content"}catch(r){return console.error("Error fetching content title:",r),"Untitled Content"}})}static createBatchNotifications(e){return Ve(this,null,function*(){try{const t=e.map(n=>Up(zp({},n),{created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),{data:r,error:i}=yield d.from("notifications").insert(t).select();if(i)throw i;return r||[]}catch(t){throw console.error("Error creating batch notifications:",t),t}})}}var nt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class bi{static logTaskAction(e,t,r){return nt(this,arguments,function*(i,n,o,s={},a,l){try{const u={task_id:i,user_id:n,action:o,details:s,timestamp:new Date().toISOString(),ip_address:a,user_agent:l},{data:h,error:f}=yield d.from("task_audit_logs").insert(u).select().single();if(f)throw f;return h}catch(u){throw console.error("Error logging task action:",u),u}})}static logStatusChange(e,t,r,i,n){return nt(this,null,function*(){try{const o={task_id:e,status:r,changed_by:t,changed_at:new Date().toISOString(),reason:i,metadata:n},{data:s,error:a}=yield d.from("task_status_history").insert(o).select().single();if(a)throw a;return s}catch(o){throw console.error("Error logging status change:",o),o}})}static getTaskAuditTrail(e){return nt(this,null,function*(){try{const{data:t,error:r}=yield d.from("task_audit_logs").select(`
          *,
          users!user_id (
            first_name,
            last_name,
            email
          )
        `).eq("task_id",e).order("timestamp",{ascending:!1});if(r)throw r;return t||[]}catch(t){throw console.error("Error fetching task audit trail:",t),t}})}static getTaskStatusHistory(e){return nt(this,null,function*(){try{const{data:t,error:r}=yield d.from("task_status_history").select(`
          *,
          users!changed_by (
            first_name,
            last_name,
            email
          )
        `).eq("task_id",e).order("changed_at",{ascending:!1});if(r)throw r;return t||[]}catch(t){throw console.error("Error fetching task status history:",t),t}})}static getContentApprovalAuditTrail(e){return nt(this,null,function*(){try{const{data:t,error:r}=yield d.from("task_audit_logs").select(`
          *,
          users!user_id (
            first_name,
            last_name,
            email
          )
        `).contains("details",{contentId:e}).order("timestamp",{ascending:!1});if(r)throw r;return t||[]}catch(t){throw console.error("Error fetching content approval audit trail:",t),t}})}static getUserActivitySummary(e,t,r=30){return nt(this,null,function*(){try{const i=new Date;i.setDate(i.getDate()-r);const{data:n,error:o}=yield d.from("task_audit_logs").select("*").eq("user_id",e).gte("timestamp",i.toISOString()).order("timestamp",{ascending:!1}).limit(50);if(o)throw o;const s=(n==null?void 0:n.filter(f=>f.action==="task_created").length)||0,a=(n==null?void 0:n.filter(f=>f.action==="task_completed").length)||0,l=(n==null?void 0:n.filter(f=>f.action==="task_cancelled").length)||0,u=(n==null?void 0:n.filter(f=>f.action==="content_approved").length)||0,h=(n==null?void 0:n.filter(f=>f.action==="content_rejected").length)||0;return{tasksCreated:s,tasksCompleted:a,tasksCancelled:l,approvalsGiven:u,rejectionsGiven:h,recentActivity:n||[]}}catch(i){throw console.error("Error fetching user activity summary:",i),i}})}static getFacilityApprovalMetrics(e,t=30){return nt(this,null,function*(){try{const r=new Date;r.setDate(r.getDate()-t);const{data:i,error:n}=yield d.from("task_audit_logs").select(`
          *,
          users!user_id (
            first_name,
            last_name,
            email
          )
        `).eq("facility_id",e).in("action",["content_submitted","content_approved","content_rejected"]).gte("timestamp",r.toISOString());if(n)throw n;const o=i||[],s=o.filter(p=>p.action==="content_submitted").length,a=o.filter(p=>p.action==="content_approved").length,l=o.filter(p=>p.action==="content_rejected").length,u=s>0?a/s*100:0,h=this.calculateAverageApprovalTime(o),f=new Map;o.filter(p=>p.action==="content_approved"||p.action==="content_rejected").forEach(p=>{var g,y,_;const w=p.user_id,b=`${((g=p.users)==null?void 0:g.first_name)||""} ${((y=p.users)==null?void 0:y.last_name)||""}`.trim()||((_=p.users)==null?void 0:_.email)||"Unknown";f.has(w)?f.get(w).count++:f.set(w,{name:b,count:1})});const m=Array.from(f.entries()).map(([p,g])=>({userId:p,userName:g.name,count:g.count})).sort((p,g)=>g.count-p.count).slice(0,5);return{totalSubmissions:s,totalApprovals:a,totalRejections:l,averageApprovalTime:h,approvalRate:u,topReviewers:m}}catch(r){throw console.error("Error fetching facility approval metrics:",r),r}})}static calculateAverageApprovalTime(e){const t=e.filter(o=>o.action==="content_submitted"),r=e.filter(o=>o.action==="content_approved");if(t.length===0||r.length===0)return 0;let i=0,n=0;return r.forEach(o=>{var s;const a=(s=o.details)==null?void 0:s.contentId;if(a){const l=t.find(u=>{var h;return((h=u.details)==null?void 0:h.contentId)===a});if(l){const u=new Date(l.timestamp).getTime(),h=new Date(o.timestamp).getTime();i+=h-u,n++}}}),n>0?i/n/(1e3*60*60):0}static cleanupOldAuditLogs(e=90){return nt(this,null,function*(){try{const t=new Date;t.setDate(t.getDate()-e);const{count:r,error:i}=yield d.from("task_audit_logs").delete().lt("timestamp",t.toISOString());if(i)throw i;return console.log(`Cleaned up ${r} old audit logs`),r||0}catch(t){throw console.error("Error cleaning up old audit logs:",t),t}})}}var Fe=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Zo{static hasApprovalPermission(e,t){return Fe(this,null,function*(){try{const{data:r,error:i}=yield d.from("user_facilities").select("role").eq("user_id",e).eq("facility_id",t).single();return i?(console.error("Error checking approval permission:",i),!1):["administrator","manager"].includes(r==null?void 0:r.role)}catch(r){return console.error("Error checking approval permission:",r),!1}})}static canCreateContent(e,t){return Fe(this,null,function*(){try{const{data:r,error:i}=yield d.from("user_facilities").select("role").eq("user_id",e).eq("facility_id",t).single();return i?(console.error("Error checking content creation permission:",i),!1):["administrator","manager","technician","trainer"].includes(r==null?void 0:r.role)}catch(r){return console.error("Error checking content creation permission:",r),!1}})}static canEditContent(e,t,r,i){return Fe(this,null,function*(){try{const{data:n,error:o}=yield d.from("user_facilities").select("role").eq("user_id",e).eq("facility_id",t).single();if(o)return console.error("Error checking edit permission:",o),!1;if(["administrator","manager"].includes(n==null?void 0:n.role))return!0;const s=i==="learning_pathway"?"courses":i,{data:a,error:l}=yield d.from(s).select("author_id").eq("id",r).eq("facility_id",t).single();return l?(console.error("Error checking content ownership:",l),!1):(a==null?void 0:a.author_id)===e}catch(n){return console.error("Error checking content edit permission:",n),!1}})}static canManageTasks(e,t){return Fe(this,null,function*(){try{const{data:r,error:i}=yield d.from("user_facilities").select("role").eq("user_id",e).eq("facility_id",t).single();return i?(console.error("Error checking task management permission:",i),!1):["administrator","manager"].includes(r==null?void 0:r.role)}catch(r){return console.error("Error checking task management permission:",r),!1}})}static getUserPermissions(e,t){return Fe(this,null,function*(){try{const{data:r,error:i}=yield d.from("user_facilities").select("role").eq("user_id",e).eq("facility_id",t).single();if(i)return console.error("Error fetching user permissions:",i),null;const n=r==null?void 0:r.role;if(!n)return null;const o=this.getRolePermissions(n);return{userId:e,facilityId:t,role:n,permissions:o}}catch(r){return console.error("Error fetching user permissions:",r),null}})}static getRolePermissions(e){const t={administrator:{approve_content:!0,create_content:!0,edit_content:!0,delete_content:!0,manage_users:!0,view_analytics:!0},manager:{approve_content:!0,create_content:!0,edit_content:!0,delete_content:!1,manage_users:!1,view_analytics:!0},technician:{approve_content:!1,create_content:!0,edit_content:!0,delete_content:!1,manage_users:!1,view_analytics:!1},trainer:{approve_content:!1,create_content:!0,edit_content:!0,delete_content:!1,manage_users:!1,view_analytics:!1},viewer:{approve_content:!1,create_content:!1,edit_content:!1,delete_content:!1,manage_users:!1,view_analytics:!1}};return t[e]||t.viewer}static validateTaskCreation(e,t,r,i){return Fe(this,null,function*(){try{return(yield this.canManageTasks(e,r))?i==="content_approval"&&!(yield this.hasApprovalPermission(t,r))?{valid:!1,reason:"Assigned user does not have approval permission"}:{valid:!0}:{valid:!1,reason:"You do not have permission to create tasks"}}catch(n){return console.error("Error validating task creation:",n),{valid:!1,reason:"Error validating permissions"}}})}static validateTaskCompletion(e,t,r){return Fe(this,null,function*(){try{const{data:i,error:n}=yield d.from("tasks").select("user_id, type, metadata").eq("id",t).eq("facility_id",r).single();return n?{valid:!1,reason:"Task not found"}:i.user_id!==e?{valid:!1,reason:"You are not assigned to this task"}:i.type==="content_approval"&&!(yield this.hasApprovalPermission(e,r))?{valid:!1,reason:"You do not have permission to approve content"}:{valid:!0}}catch(i){return console.error("Error validating task completion:",i),{valid:!1,reason:"Error validating permissions"}}})}static validateContentSubmission(e,t,r){return Fe(this,null,function*(){try{return(yield this.canCreateContent(e,t))?{valid:!0}:{valid:!1,reason:"You do not have permission to create content"}}catch(i){return console.error("Error validating content submission:",i),{valid:!1,reason:"Error validating permissions"}}})}static canViewAuditLogs(e,t){return Fe(this,null,function*(){try{const{data:r,error:i}=yield d.from("user_facilities").select("role").eq("user_id",e).eq("facility_id",t).single();return i?(console.error("Error checking audit log permission:",i),!1):["administrator","manager"].includes(r==null?void 0:r.role)}catch(r){return console.error("Error checking audit log permission:",r),!1}})}static getUsersWithPermission(e,t){return Fe(this,null,function*(){try{const{data:r,error:i}=yield d.from("user_facilities").select(`
          user_id,
          role,
          users!user_id (
            id,
            first_name,
            last_name,
            email
          )
        `).eq("facility_id",e);if(i)throw i;return(r==null?void 0:r.filter(o=>this.getRolePermissions(o.role)[t]).map(o=>{var s,a,l,u,h,f;return{id:o.user_id,name:`${((a=(s=o.users)==null?void 0:s[0])==null?void 0:a.first_name)||""} ${((u=(l=o.users)==null?void 0:l[0])==null?void 0:u.last_name)||""}`.trim()||((f=(h=o.users)==null?void 0:h[0])==null?void 0:f.email)||"Unknown",role:o.role}}))||[]}catch(r){throw console.error("Error fetching users with permission:",r),r}})}}var Fp=Object.defineProperty,Lp=Object.defineProperties,xp=Object.getOwnPropertyDescriptors,es=Object.getOwnPropertySymbols,Bp=Object.prototype.hasOwnProperty,jp=Object.prototype.propertyIsEnumerable,ts=(c,e,t)=>e in c?Fp(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ei=(c,e)=>{for(var t in e||(e={}))Bp.call(e,t)&&ts(c,t,e[t]);if(es)for(var t of es(e))jp.call(e,t)&&ts(c,t,e[t]);return c},Ai=(c,e)=>Lp(c,xp(e)),de=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Vp{static createContentApprovalTask(e,t,r){return de(this,null,function*(){try{const i=yield this.getContentDetails(e,t);if(!i)throw new Error(`Content not found: ${e}`);const n=yield this.getUsersWithApprovalPermission(r);if(n.length===0)throw new Error("No users found with approval permission");const o=yield Promise.all(n.map(s=>this.createTask({facility_id:r,user_id:s.id,title:`Review: ${i.title}`,description:`Content submitted by ${i.author_name} requires approval`,type:"content_approval",metadata:{contentId:e,contentType:t,contentTitle:i.title,authorId:i.author_id,authorName:i.author_name,submittedAt:new Date().toISOString(),revisionNumber:i.revision_number||1,previousRejections:i.previous_rejections||0}})));return yield Promise.all(o.map(s=>Np.notifyTaskAssignment(s.user_id,r,s.id,s.title,s.description).catch(a=>{console.error("Failed to send task notification:",a)}))),console.log(`Created ${o.length} approval tasks for content: ${i.title}`),o}catch(i){throw console.error("Error creating content approval tasks:",i),i}})}static createTask(e){return de(this,null,function*(){try{const t=yield Zo.validateTaskCreation(e.created_by||e.user_id,e.user_id,e.facility_id,e.type);if(!t.valid)throw new Error(t.reason);const{data:r,error:i}=yield d.from("tasks").insert(Ai(Ei({},e),{status:"pending",priority:e.priority||"normal",created_at:new Date().toISOString(),updated_at:new Date().toISOString()})).select().single();if(i)throw i;try{yield bi.logTaskAction(r.id,e.created_by||e.user_id,"task_created",{title:e.title,type:e.type,priority:e.priority||"normal",assignedTo:e.user_id})}catch(n){console.warn("Failed to log task creation:",n)}return r}catch(t){throw console.error("Error creating task:",t),t}})}static getUserTasks(e,t){return de(this,null,function*(){try{let r=d.from("tasks").select("*").eq("user_id",e).order("created_at",{ascending:!1});t&&(r=r.eq("status",t));const{data:i,error:n}=yield r;if(n)throw n;return i||[]}catch(r){throw console.error("Error fetching user tasks:",r),r}})}static completeContentApprovalTask(e,t,r,i){return de(this,null,function*(){try{const n=yield this.getTask(e);if(!n)throw new Error(`Task not found: ${e}`);if(i){const u=yield Zo.validateTaskCompletion(i,e,n.facility_id);if(!u.valid)throw new Error(u.reason)}if(n.status!=="pending")throw new Error(`Task ${e} is already ${n.status}`);const{contentId:o,contentType:s}=n.metadata,a=yield this.getContentApprovalStatus(o,s);if(a&&a!=="pending_approval")throw new Error(`Content ${o} is already ${a}`);t==="approved"?yield this.approveContent(o,s,n.user_id):yield this.rejectContent(o,s,n.user_id,r);const l=yield this.updateTask(e,{status:"completed",completed_at:new Date().toISOString(),metadata:Ai(Ei({},n.metadata),{action:t,comments:r,completedAt:new Date().toISOString()})});try{yield Promise.all([bi.logTaskAction(e,n.user_id,"task_completed",{action:t,comments:r,contentId:o,contentType:s}),bi.logStatusChange(e,n.user_id,"completed",`${t} content`,{action:t,comments:r,contentId:o,contentType:s}),bi.logTaskAction(e,n.user_id,t==="approved"?"content_approved":"content_rejected",{contentId:o,contentType:s,comments:r,contentTitle:n.metadata.contentTitle})])}catch(u){console.warn("Failed to log task completion:",u)}try{yield this.cancelPendingTasksForContent(o)}catch(u){console.warn("Failed to cancel pending tasks for content:",u)}return l}catch(n){throw console.error("Error completing content approval task:",n),n}})}static updateTask(e,t){return de(this,null,function*(){try{const{data:r,error:i}=yield d.from("tasks").update(Ai(Ei({},t),{updated_at:new Date().toISOString()})).eq("id",e).select().single();if(i)throw i;return r}catch(r){throw console.error("Error updating task:",r),r}})}static getTask(e){return de(this,null,function*(){try{const{data:t,error:r}=yield d.from("tasks").select("*").eq("id",e).single();if(r){if(r.code==="PGRST116")return null;throw r}return t}catch(t){throw console.error("Error fetching task:",t),t}})}static cancelPendingTasksForContent(e){return de(this,null,function*(){try{const{error:t}=yield d.from("tasks").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("type","content_approval").eq("status","pending").contains("metadata",{contentId:e});if(t)throw t}catch(t){throw console.error("Error cancelling pending tasks for content:",t),t}})}static getContentApprovalStatus(e,t){return de(this,null,function*(){try{const r=t==="learning_pathway"?"courses":t,{data:i,error:n}=yield d.from(r).select("approval_status").eq("id",e).single();if(n){if(n.code==="PGRST116")return null;throw n}return(i==null?void 0:i.approval_status)||null}catch(r){throw console.error("Error fetching content approval status:",r),r}})}static cleanupOldTasks(e=30){return de(this,null,function*(){try{const t=new Date;t.setDate(t.getDate()-e);const{count:r,error:i}=yield d.from("tasks").delete().eq("status","completed").lt("completed_at",t.toISOString());if(i)throw i;return console.log(`Cleaned up ${r} old completed tasks`),r||0}catch(t){throw console.error("Error cleaning up old tasks:",t),t}})}static handlePermissionChanges(e){return de(this,null,function*(){try{const{data:t,error:r}=yield d.from("tasks").select("*").eq("facility_id",e).eq("type","content_approval").eq("status","pending");if(r)throw r;if(!t||t.length===0)return;const i=yield this.getUsersWithApprovalPermission(e),n=new Set(i.map(s=>s.id)),o=t.filter(s=>!n.has(s.user_id));if(o.length>0){const{error:s}=yield d.from("tasks").update({status:"cancelled",updated_at:new Date().toISOString()}).in("id",o.map(a=>a.id));if(s)throw s;console.log(`Cancelled ${o.length} tasks due to permission changes`)}}catch(t){throw console.error("Error handling permission changes:",t),t}})}static getContentDetails(e,t){return de(this,null,function*(){var r,i,n,o,s,a;try{const l=t==="learning_pathway"?"courses":t,{data:u,error:h}=yield d.from(l).select(`
          id,
          title,
          description,
          author_id,
          facility_id,
          created_at,
          updated_at,
          users!author_id (
            first_name,
            last_name,
            email
          )
        `).eq("id",e).single();if(h)throw h;return Ai(Ei({},u),{author_name:`${((i=(r=u.users)==null?void 0:r[0])==null?void 0:i.first_name)||""} ${((o=(n=u.users)==null?void 0:n[0])==null?void 0:o.last_name)||""}`.trim()||((a=(s=u.users)==null?void 0:s[0])==null?void 0:a.email)||"Unknown",revision_number:1,previous_rejections:0})}catch(l){throw console.error("Error fetching content details:",l),l}})}static getUsersWithApprovalPermission(e){return de(this,null,function*(){try{const{data:t,error:r}=yield d.from("user_facilities").select(`
          user_id,
          role,
          users!user_id (
            id,
            first_name,
            last_name,
            email
          )
        `).eq("facility_id",e).in("role",["administrator","manager"]);if(r)throw r;return(t==null?void 0:t.map(i=>{var n,o,s,a,l,u;return{id:i.user_id,role:i.role,name:`${((o=(n=i.users)==null?void 0:n[0])==null?void 0:o.first_name)||""} ${((a=(s=i.users)==null?void 0:s[0])==null?void 0:a.last_name)||""}`.trim()||((u=(l=i.users)==null?void 0:l[0])==null?void 0:u.email)||"Unknown"}}))||[]}catch(t){throw console.error("Error fetching users with approval permission:",t),t}})}static approveContent(e,t,r){return de(this,null,function*(){try{const i=t==="learning_pathway"?"courses":t,{error:n}=yield d.from(i).update({approval_status:"approved",approved_at:new Date().toISOString(),approved_by:r,published_at:new Date().toISOString()}).eq("id",e);if(n)throw n}catch(i){throw console.error("Error approving content:",i),i}})}static rejectContent(e,t,r,i){return de(this,null,function*(){try{const n=t==="learning_pathway"?"courses":t,{error:o}=yield d.from(n).update({approval_status:"rejected",rejected_at:new Date().toISOString(),rejected_by:r,rejection_reason:i}).eq("id",e);if(o)throw o}catch(n){throw console.error("Error rejecting content:",n),n}})}}const Hp=Object.freeze(Object.defineProperty({__proto__:null,TaskService:Vp},Symbol.toStringTag,{value:"Module"}));var Ti=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class $c{constructor(){this.CACHE_DURATION=300,this.FACILITY_KEY_PREFIX="facility",this.cache=new cc("facility")}getFacility(e){return Ti(this,null,function*(){try{const t=`${this.FACILITY_KEY_PREFIX}:${e}`,r=yield this.cache.get(t);return r&&this.isCacheValid(r)?(ee()&&Math.random()<.1&&v.debug(`Facility cache hit for ID: ${e}`),r.facility):(r&&(yield this.cache.del(t)),null)}catch(t){return v.error("Error getting facility from cache:",t),null}})}setFacility(e,t){return Ti(this,null,function*(){try{const r=`${this.FACILITY_KEY_PREFIX}:${e}`,i={facility:t,timestamp:Date.now()};yield this.cache.set(r,i,{ttl:this.CACHE_DURATION}),ee()&&Math.random()<.1&&v.debug(`Facility cached for ID: ${e}`)}catch(r){v.error("Error setting facility in cache:",r)}})}invalidateFacility(e){return Ti(this,null,function*(){try{const t=`${this.FACILITY_KEY_PREFIX}:${e}`;yield this.cache.del(t),v.debug(`Facility cache invalidated for ID: ${e}`)}catch(t){v.error("Error invalidating facility cache:",t)}})}clearAll(){return Ti(this,null,function*(){try{yield this.cache.clear(),v.info("All facility cache cleared")}catch(e){v.error("Error clearing facility cache:",e)}})}isCacheValid(e){return Date.now()-e.timestamp<this.CACHE_DURATION*1e3}getStats(){return this.cache.getStats()}cleanup(){this.cache.cleanup()}}const Gp=new $c,rs=Object.freeze(Object.defineProperty({__proto__:null,DistributedFacilityCache:$c,distributedFacilityCache:Gp},Symbol.toStringTag,{value:"Module"}));var at=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Wp{static signIn(e){return at(this,arguments,function*({email:t,password:r}){try{const{data:i,error:n}=yield d.auth.signInWithPassword({email:t,password:r});if(n)throw n;if(i&&i.user&&i.user.id){const{data:o,error:s}=yield d.from("users").select("*").eq("id",i.user.id).single();return s&&console.warn("Failed to fetch user profile:",s),{user:o,session:i.session,error:null}}return{user:null,session:null,error:"No user data received"}}catch(i){return{user:null,session:null,error:We(i).message}}})}static signUp(e){return at(this,arguments,function*({email:t,password:r,fullName:i,role:n="user"}){try{const{data:o,error:s}=yield d.auth.signUp({email:t,password:r,options:{data:{full_name:i,role:n}}});if(s)throw s;if(o.user){const a=i.trim().split(" "),l=a[0]||"",u=a.slice(1).join(" ")||"",h={id:o.user.id,email:o.user.email,first_name:l,last_name:u,role:n,facility_id:null},{error:f}=yield d.from("users").insert(h);return f&&console.warn("Failed to create user profile:",f),{user:h,session:o.session,error:null}}return{user:null,session:null,error:"No user data received"}}catch(o){return{user:null,session:null,error:We(o).message}}})}static signOut(){return at(this,null,function*(){try{const{error:e}=yield d.auth.signOut();if(e)throw e;return{error:null}}catch(e){return{error:We(e).message}}})}static getCurrentUser(){return at(this,null,function*(){try{const{data:{user:e},error:t}=yield d.auth.getUser();if(t)throw t;if(!e)return{user:null,session:null,error:null};const{data:{session:r}}=yield d.auth.getSession();if(!r)return{user:null,session:null,error:"No active session"};const{data:i,error:n}=yield d.from("users").select("*").eq("id",e.id).single();return n&&console.warn("Failed to fetch user profile:",n),{user:i,session:null,error:null}}catch(e){return{user:null,session:null,error:We(e).message}}})}static getSession(){return at(this,null,function*(){try{const{data:{session:e},error:t}=yield d.auth.getSession();if(t)throw t;return{session:e,error:null}}catch(e){return{session:null,error:We(e).message}}})}static updateProfile(e,t){return at(this,null,function*(){try{const{data:r,error:i}=yield d.from("users").update(t).eq("id",e).select().single();if(i)throw i;return{user:r,error:null}}catch(r){return{user:null,error:We(r).message}}})}static resetPassword(e){return at(this,null,function*(){try{const{error:t}=yield d.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/reset-password`});if(t)throw t;return{error:null}}catch(t){return{error:We(t).message}}})}static updatePassword(e){return at(this,null,function*(){try{const{error:t}=yield d.auth.updateUser({password:e});if(t)throw t;return{error:null}}catch(t){return{error:We(t).message}}})}static onAuthStateChange(e){return d.auth.onAuthStateChange((t,r)=>{e(t,r)})}}const jv=Object.freeze(Object.defineProperty({__proto__:null,SupabaseAuthService:Wp},Symbol.toStringTag,{value:"Module"})),ki=c=>typeof c=="object"&&c!==null&&"id"in c&&typeof c.id=="string",Lr=c=>typeof c=="object"&&c!==null&&("data"in c||"error"in c),Kp=c=>typeof c=="object"&&c!==null&&"eventType"in c&&"table"in c&&typeof c.table=="string";var Qp=Object.defineProperty,Yp=Object.defineProperties,Jp=Object.getOwnPropertyDescriptors,is=Object.getOwnPropertySymbols,Xp=Object.prototype.hasOwnProperty,Zp=Object.prototype.propertyIsEnumerable,ns=(c,e,t)=>e in c?Qp(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,eg=(c,e)=>{for(var t in e||(e={}))Xp.call(e,t)&&ns(c,t,e[t]);if(is)for(var t of is(e))Zp.call(e,t)&&ns(c,t,e[t]);return c},tg=(c,e)=>Yp(c,Jp(e)),xr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Mc{constructor(){this.tableName="inventory_items"}getAllItems(e){return xr(this,null,function*(){var t,r,i,n;try{const{data:{user:o},error:s}=yield d.auth.getUser();let a=null;!s&&o&&(a=((t=o.user_metadata)==null?void 0:t.facility_id)||null);const l=d.from(this.tableName).select((e==null?void 0:e.select)||"*").order(((r=e==null?void 0:e.orderBy)==null?void 0:r.column)||"created_at",{ascending:(n=(i=e==null?void 0:e.orderBy)==null?void 0:i.ascending)!=null?n:!1});a&&l.eq("facility_id",a),e!=null&&e.limit&&l.limit(e.limit),e!=null&&e.offset&&l.range(e.offset,e.offset+(e.limit||10)-1),e!=null&&e.filters&&Object.entries(e.filters).forEach(([p,g])=>{g!=null&&(p==="location"?l.ilike("scanned_location",`%${g}%`):l.eq(p,g))});const u=yield l;if(!Lr(u))return{success:!1,error:"Invalid response format from Supabase",processedCount:0,errorCount:1};if(u.error)return{success:!1,error:u.error.message,processedCount:0,errorCount:1};const h=u.data||[],f=[];let m=0;for(const p of h)if(ki(p)){const g=this.transformRowToInventoryItem(p);g.success&&g.data?f.push(g.data):m++}else m++;return{success:!0,data:f,processedCount:f.length,errorCount:m}}catch(o){return{success:!1,error:o instanceof Error?o.message:"Unknown error occurred",processedCount:0,errorCount:1}}})}getItemById(e){return xr(this,null,function*(){var t;try{const{data:{user:r},error:i}=yield d.auth.getUser();let n=null;!i&&r&&(n=((t=r.user_metadata)==null?void 0:t.facility_id)||null);const o=d.from(this.tableName).select("*").eq("id",e);n&&o.eq("facility_id",n);const s=yield o.single();if(!Lr(s))return{success:!1,error:"Invalid response format from Supabase"};if(s.error)return{success:!1,error:s.error.message};const a=s.data;return!a||!ki(a)?{success:!1,error:"Item not found or invalid format"}:this.transformRowToInventoryItem(a)}catch(r){return{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}})}createItem(e){return xr(this,null,function*(){var t;try{const{data:{user:r},error:i}=yield d.auth.getUser();let n=null;!i&&r&&(n=((t=r.user_metadata)==null?void 0:t.facility_id)||null);const o=tg(eg({},e),{facility_id:n||e.facility_id}),s=yield d.from(this.tableName).insert([o]).select().single();if(!Lr(s))return{success:!1,error:"Invalid response format from Supabase"};if(s.error)return{success:!1,error:s.error.message};const a=s.data;return!a||!ki(a)?{success:!1,error:"Failed to create item or invalid response format"}:this.transformRowToInventoryItem(a)}catch(r){return{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}})}updateItem(e,t){return xr(this,null,function*(){var r;try{const{data:{user:i},error:n}=yield d.auth.getUser();let o=null;!n&&i&&(o=((r=i.user_metadata)==null?void 0:r.facility_id)||null);const s=d.from(this.tableName).update(t).eq("id",e);o&&s.eq("facility_id",o);const a=yield s.select().single();if(!Lr(a))return{success:!1,error:"Invalid response format from Supabase"};if(a.error)return{success:!1,error:a.error.message};const l=a.data;return!l||!ki(l)?{success:!1,error:"Item not found or invalid response format"}:this.transformRowToInventoryItem(l)}catch(i){return{success:!1,error:i instanceof Error?i.message:"Unknown error occurred"}}})}deleteItem(e){return xr(this,null,function*(){var t;try{const{data:{user:r},error:i}=yield d.auth.getUser();let n=null;!i&&r&&(n=((t=r.user_metadata)==null?void 0:t.facility_id)||null);const o=d.from(this.tableName).delete().eq("id",e);n&&o.eq("facility_id",n);const s=yield o;return Lr(s)?s.error?{success:!1,error:s.error.message}:{success:!0}:{success:!1,error:"Invalid response format from Supabase"}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}})}subscribeToChanges(e,t){const r=d.channel("inventory_changes").on("postgres_changes",{event:(t==null?void 0:t.event)||"*",schema:(t==null?void 0:t.schema)||"public",table:(t==null?void 0:t.table)||this.tableName,filter:t==null?void 0:t.filter},i=>{Kp(i)?e(i):console.warn("Received invalid realtime payload:",i)}).subscribe();return()=>{d.removeChannel(r)}}transformRowToInventoryItem(e){try{return{success:!0,data:{id:e.id,facility_id:e.facility_id,name:e.name,quantity:e.quantity,data:e.data,created_at:e.created_at,updated_at:e.updated_at,reorder_level:e.reorder_level,reorder_point:e.reorder_point,status:e.status,expiration_date:e.expiration_date,unit_cost:e.unit_cost,category:e.category,archived:e.archived,archived_at:e.archived_at,archived_by:e.archived_by,archive_reason:e.archive_reason}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to transform row to inventory item"}}}transformInventoryItemToRow(e){return{facility_id:e.facility_id,name:e.name,quantity:e.quantity,data:e.data,reorder_level:e.reorder_level,reorder_point:e.reorder_point,status:e.status,expiration_date:e.expiration_date,unit_cost:e.unit_cost,category:e.category}}}const rg=Object.freeze(Object.defineProperty({__proto__:null,TypedSupabaseAdapter:Mc},Symbol.toStringTag,{value:"Module"}));class qc{static transformFromSupabase(e){var t,r,i;const n=e.data||{},o=e.category||n.category||"unknown",s=ge("NODE_ENV")==="development"||ge("MODE")==="development",a=ge("VITE_DEBUG_INVENTORY")==="true";return s&&a&&console.debug("Transforming inventory item:",e),{id:e.id,name:e.name,category:o,location:"",status:"active",updated_at:e.updated_at,quantity:e.quantity,unit_cost:e.unit_cost,reorder_point:e.reorder_point||0,expiration_date:e.expiration_date||"",created_at:e.created_at,facility_id:e.facility_id||"",data:{description:n.description||"",barcode:n.barcode||"",warranty:n.warranty||"",serialNumber:n.serialNumber||"",manufacturer:n.manufacturer||"",lastServiced:n.lastServiced||"",unit:n.unit||"",supplier:n.supplier||"",notes:n.notes||"",tags:n.tags||[],imageUrl:n.imageUrl||"",isActive:(t=n.isActive)!=null?t:!0,tracked:(r=n.tracked)!=null?r:!0,favorite:(i=n.favorite)!=null?i:!1,purchaseDate:n.purchaseDate||"",createdAt:n.createdAt||"",updatedAt:n.updatedAt||"",currentPhase:n.currentPhase||"",sku:n.sku||"",p2Status:n.p2Status||"",toolId:n.toolId||"",supplyId:n.supplyId||"",equipmentId:n.equipmentId||"",hardwareId:n.hardwareId||"",serviceProvider:n.serviceProvider||"",assignedTo:n.assignedTo||""}}}static transformToSupabase(e){const t={name:e.name,category:e.category,quantity:e.quantity||0,unit_cost:e.unit_cost||0,status:e.status||"active"};return e.facility_id&&(t.facility_id=e.facility_id),e.data&&typeof e.data=="object"&&e.data!==null&&"description"in e.data&&typeof e.data.description=="string"&&(t.description=e.data.description),e.location&&(t.location=e.location),e.data&&typeof e.data=="object"&&e.data!==null&&"sku"in e.data&&typeof e.data.sku=="string"&&(t.sku=e.data.sku),e.data&&typeof e.data=="object"&&e.data!==null&&"barcode"in e.data&&typeof e.data.barcode=="string"&&(t.barcode=e.data.barcode),e.data&&typeof e.data=="object"&&e.data!==null&&"manufacturer"in e.data&&typeof e.data.manufacturer=="string"&&(t.manufacturer=e.data.manufacturer),e.data&&typeof e.data=="object"&&e.data!==null&&"serialNumber"in e.data&&typeof e.data.serialNumber=="string"&&(t.serial_number=e.data.serialNumber),e.data&&typeof e.data=="object"&&e.data!==null&&"expiration"in e.data&&typeof e.data.expiration=="string"&&(t.expiration_date=e.data.expiration),e.data&&typeof e.data=="object"&&e.data!==null&&"unit"in e.data&&typeof e.data.unit=="string"&&(t.unit_of_measure=e.data.unit),e.reorder_point!==void 0&&(t.reorder_point=e.reorder_point),e.data&&typeof e.data=="object"&&e.data!==null&&"createdAt"in e.data&&typeof e.data.createdAt=="string"&&(t.created_at=e.data.createdAt),e.data&&typeof e.data=="object"&&e.data!==null&&"updatedAt"in e.data&&typeof e.data.updatedAt=="string"&&(t.updated_at=e.data.updatedAt),t}}class sn{static transformForModal(e){return e.map(t=>{var r,i;return{id:t.id||"",name:t.name||"",barcode:((r=t.data)==null?void 0:r.barcode)||t.id||"",currentPhase:t.status||((i=t.data)==null?void 0:i.currentPhase)||"Unknown",category:t.category||""}})}static transformForTable(e){return e.map(t=>{var r,i,n,o;return{id:t.id||"",name:t.name||"",category:t.category||"",location:t.location||"",status:t.status||((r=t.data)==null?void 0:r.currentPhase)||"Unknown",tracked:((i=t.data)==null?void 0:i.tracked)||!1,favorite:((n=t.data)==null?void 0:n.favorite)||!1,lastUpdated:((o=t.data)==null?void 0:o.updatedAt)||""}})}static transformForExport(e){return e.map(t=>{var r,i,n,o,s,a,l,u,h,f,m,p;return{ID:t.id||"",Name:t.name||"",Category:t.category||"",Location:t.location||"",Status:t.status||((r=t.data)==null?void 0:r.currentPhase)||"",Quantity:String(t.quantity||0),Cost:String(t.unit_cost||0),Barcode:((i=t.data)==null?void 0:i.barcode)||"",SerialNumber:((n=t.data)==null?void 0:n.serialNumber)||"",Manufacturer:((o=t.data)==null?void 0:o.manufacturer)||"",SKU:((s=t.data)==null?void 0:s.sku)||"",Description:((a=t.data)==null?void 0:a.description)||"",Warranty:((l=t.data)==null?void 0:l.warranty)||"",LastServiced:((u=t.data)==null?void 0:u.lastServiced)||"",Notes:((h=t.data)==null?void 0:h.notes)||"",Tags:Array.isArray((f=t.data)==null?void 0:f.tags)?t.data.tags.join(", "):"",CreatedAt:((m=t.data)==null?void 0:m.createdAt)||"",UpdatedAt:((p=t.data)==null?void 0:p.updatedAt)||""}})}static transformForSearch(e){return e.map(t=>{var r,i,n;return{id:t.id,name:t.name||"",category:t.category||"",location:t.location||"",status:t.status||((r=t.data)==null?void 0:r.currentPhase)||"",quantity:t.quantity||0,unit_cost:t.unit_cost||0,barcode:((i=t.data)==null?void 0:i.barcode)||void 0,description:(n=t.data)==null?void 0:n.description}})}}var ig=Object.defineProperty,ng=Object.defineProperties,ag=Object.getOwnPropertyDescriptors,as=Object.getOwnPropertySymbols,og=Object.prototype.hasOwnProperty,sg=Object.prototype.propertyIsEnumerable,os=(c,e,t)=>e in c?ig(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Pi=(c,e)=>{for(var t in e||(e={}))og.call(e,t)&&os(c,t,e[t]);if(as)for(var t of as(e))sg.call(e,t)&&os(c,t,e[t]);return c},Ci=(c,e)=>ng(c,ag(e));class wr{static createNewItem(e){const t=new Date().toISOString(),r=i=>e.data&&typeof e.data=="object"&&e.data!==null&&i in e.data&&typeof e.data[i]=="string"?e.data[i]:"";return{id:"",facility_id:e.facility_id||"",name:e.name||"",quantity:e.quantity||0,data:{description:r("description"),barcode:r("barcode"),warranty:r("warranty"),serialNumber:r("serialNumber"),manufacturer:r("manufacturer"),lastServiced:r("lastServiced"),unit:r("unit"),supplier:r("supplier"),notes:r("notes"),tags:[],imageUrl:"",isActive:!0,tracked:!0,favorite:!1,purchaseDate:"",createdAt:t,updatedAt:t,currentPhase:"Active",sku:"",p2Status:"",toolId:"",supplyId:"",equipmentId:"",hardwareId:"",serviceProvider:"",assignedTo:""},created_at:t,updated_at:t,reorder_point:e.reorder_point||0,expiration_date:e.expiration_date||"",unit_cost:e.unit_cost||0,category:e.category||"",status:e.status||"Active",location:e.location||"",supplier:e.supplier||"",cost:e.cost||0,vendor:e.vendor||"",warranty:e.warranty||"",maintenance_schedule:e.maintenance_schedule||"",next_due:e.next_due||"",service_provider:e.service_provider||"",assigned_to:e.assigned_to||"",notes:e.notes||"",tool_id:e.tool_id||"",supply_id:e.supply_id||"",equipment_id:e.equipment_id||"",hardware_id:e.hardware_id||"",p2_status:e.p2_status||"",serial_number:e.serial_number||"",manufacturer:e.manufacturer||"",image_url:e.image_url||"",tags:e.tags||[],favorite:e.favorite||!1,tracked:e.tracked||!0,barcode:e.barcode||"",sku:e.sku||"",description:e.description||"",current_phase:e.current_phase||"Active",is_active:e.is_active||!0,unit:e.unit||"",expiration:e.expiration||"",purchase_date:e.purchase_date||"",last_serviced:e.last_serviced||"",last_updated:t}}static updateItemWithTimestamp(e){const t=new Date().toISOString();return Ci(Pi({},e),{data:Ci(Pi({},e.data&&typeof e.data=="object"&&e.data!==null?e.data:{}),{lastUpdated:t,updatedAt:t})})}static normalizeItemName(e){return e?e.trim().replace(/\s+/g," ").split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" "):""}static normalizeCategory(e){return e?e.trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""):""}static transformInventoryItem(e){var t;const r=this.normalizeItemName(e.name||""),i=this.normalizeCategory(e.category||""),n=(t=e.data)!=null&&t.expiration?new Date(e.data.expiration):null,o=new Date,s=n?n<o:!1,a=n?Math.ceil((n.getTime()-o.getTime())/(1e3*60*60*24)):null;return Ci(Pi({},e),{normalizedName:r,normalizedCategory:i,quantityInStock:e.quantity||0,isExpired:s,daysUntilExpiry:a})}static transformInventoryBatch(e){return e.map(t=>Ci(Pi({},t),{normalizedName:this.normalizeItemName(t.name||""),normalizedCategory:this.normalizeCategory(t.category||"")}))}}class zc{static transformToCSV(e){if(e.length===0)return"";const t=["Name","Quantity","Category","Status","Expiry Date"],r=e.map(n=>{var o;return[n.name,(n.quantity||1).toString(),n.category,n.status,((o=n.data)==null?void 0:o.expiration)||""]});return[t,...r].map(n=>n.map(o=>`"${o}"`).join(",")).join(`
`)}static transformFromCSV(e){const t=e.trim().split(`
`);if(t.length<2)return[];const r=t[0].split(",").map(n=>n.replace(/"/g,"").trim());return t.slice(1).map(n=>{const o=n.split(",").map(a=>a.replace(/"/g,"").trim()),s={};return r.forEach((a,l)=>{s[a.toLowerCase().replace(/\s+/g,"")]=o[l]||""}),{id:Date.now().toString()+Math.random().toString(36).substr(2,9),name:s.name||"",category:s.category||"",status:s.status||"active",quantity:parseInt(s.quantity)||1,unit_cost:0,reorder_point:0,expiration_date:s.expirydate||"",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),facility_id:"",location:"",data:{description:"",barcode:"",warranty:"",serialNumber:"",manufacturer:"",lastServiced:"",unit:"",supplier:"",notes:"",tags:[],imageUrl:"",isActive:!0,tracked:!1,favorite:!1,purchaseDate:"",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),currentPhase:"Active",sku:"",p2Status:"",toolId:"",supplyId:"",equipmentId:"",hardwareId:"",serviceProvider:"",assignedTo:""}}})}}class Uc{static transformForAPI(e){return e.map(t=>{var r,i,n,o,s,a,l,u,h,f,m,p,g,y,_,w,b,E,C,S,Q,Y,B,Te,ke;return{id:t.id,name:t.name,category:t.category,status:t.status,quantity:t.quantity,location:t.location,unit_cost:t.unit_cost,reorder_point:t.reorder_point,expiration_date:t.expiration_date,created_at:t.created_at,updated_at:t.updated_at,facility_id:t.facility_id,data:{description:(r=t.data)==null?void 0:r.description,barcode:((i=t.data)==null?void 0:i.barcode)||void 0,serialNumber:(n=t.data)==null?void 0:n.serialNumber,manufacturer:(o=t.data)==null?void 0:o.manufacturer,supplier:(s=t.data)==null?void 0:s.supplier,expiration:(a=t.data)==null?void 0:a.expiration,warranty:(l=t.data)==null?void 0:l.warranty,notes:(u=t.data)==null?void 0:u.notes,tags:(h=t.data)==null?void 0:h.tags,imageUrl:(f=t.data)==null?void 0:f.imageUrl,isActive:(m=t.data)==null?void 0:m.isActive,tracked:(p=t.data)==null?void 0:p.tracked,favorite:(g=t.data)==null?void 0:g.favorite,purchaseDate:(y=t.data)==null?void 0:y.purchaseDate,lastServiced:(_=t.data)==null?void 0:_.lastServiced,unit:(w=t.data)==null?void 0:w.unit,currentPhase:(b=t.data)==null?void 0:b.currentPhase,sku:(E=t.data)==null?void 0:E.sku,p2Status:(C=t.data)==null?void 0:C.p2Status,toolId:(S=t.data)==null?void 0:S.toolId,supplyId:(Q=t.data)==null?void 0:Q.supplyId,equipmentId:(Y=t.data)==null?void 0:Y.equipmentId,hardwareId:(B=t.data)==null?void 0:B.hardwareId,serviceProvider:(Te=t.data)==null?void 0:Te.serviceProvider,assignedTo:(ke=t.data)==null?void 0:ke.assignedTo}}})}static transformFromAPI(e){return e.map(t=>{var r,i,n,o,s,a,l,u,h,f,m,p,g,y,_,w,b,E,C,S,Q,Y,B,Te,ke,na,aa;return{id:t.id,name:t.name,category:t.category,location:t.location,status:t.status,updated_at:t.updated_at,quantity:t.quantity,unit_cost:t.unit_cost,reorder_point:t.reorder_point,expiration_date:t.expiration_date,created_at:t.created_at,facility_id:t.facility_id,data:{description:(r=t.data)==null?void 0:r.description,barcode:(i=t.data)==null?void 0:i.barcode,warranty:(n=t.data)==null?void 0:n.warranty,serialNumber:(o=t.data)==null?void 0:o.serialNumber,expiration:(s=t.data)==null?void 0:s.expiration,manufacturer:(a=t.data)==null?void 0:a.manufacturer,lastServiced:(l=t.data)==null?void 0:l.lastServiced,unit:(u=t.data)==null?void 0:u.unit,supplier:(h=t.data)==null?void 0:h.supplier,notes:(f=t.data)==null?void 0:f.notes,tags:(m=t.data)==null?void 0:m.tags,imageUrl:(p=t.data)==null?void 0:p.imageUrl,isActive:(g=t.data)==null?void 0:g.isActive,tracked:(y=t.data)==null?void 0:y.tracked,favorite:(_=t.data)==null?void 0:_.favorite,purchaseDate:(w=t.data)==null?void 0:w.purchaseDate,createdAt:(b=t.data)==null?void 0:b.createdAt,updatedAt:(E=t.data)==null?void 0:E.updatedAt,currentPhase:(C=t.data)==null?void 0:C.currentPhase,sku:(S=t.data)==null?void 0:S.sku,p2Status:(Q=t.data)==null?void 0:Q.p2Status,toolId:(Y=t.data)==null?void 0:Y.toolId,supplyId:(B=t.data)==null?void 0:B.supplyId,equipmentId:(Te=t.data)==null?void 0:Te.equipmentId,hardwareId:(ke=t.data)==null?void 0:ke.hardwareId,serviceProvider:(na=t.data)==null?void 0:na.serviceProvider,assignedTo:(aa=t.data)==null?void 0:aa.assignedTo}}})}}class U{}U.transformFromSupabase=qc.transformFromSupabase;U.transformToSupabase=qc.transformToSupabase;U.transformForModal=sn.transformForModal;U.transformForTable=sn.transformForTable;U.transformForExport=sn.transformForExport;U.transformForSearch=sn.transformForSearch;U.createNewItem=wr.createNewItem;U.updateItemWithTimestamp=wr.updateItemWithTimestamp;U.normalizeItemName=wr.normalizeItemName;U.normalizeCategory=wr.normalizeCategory;U.transformInventoryItem=wr.transformInventoryItem;U.transformInventoryBatch=wr.transformInventoryBatch;U.transformToCSV=zc.transformToCSV;U.transformFromCSV=zc.transformFromCSV;U.transformForAPI=Uc.transformForAPI;U.transformFromAPI=Uc.transformFromAPI;var cg=Object.defineProperty,ss=Object.getOwnPropertySymbols,lg=Object.prototype.hasOwnProperty,ug=Object.prototype.propertyIsEnumerable,cs=(c,e,t)=>e in c?cg(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,dg=(c,e)=>{for(var t in e||(e={}))lg.call(e,t)&&cs(c,t,e[t]);if(ss)for(var t of ss(e))ug.call(e,t)&&cs(c,t,e[t]);return c},$=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class hg{constructor(e){this.isInitialized=!1,this.lastError=null,this.lastSyncTime=null,this.pendingChanges=!1,this.cachedItems=null,this.cacheTimestamp=0,this.CACHE_DURATION=5e3,this.client=null,this.initPromise=null,this.getClient=()=>$(this,null,function*(){return this.client?this.client:(this.initPromise||(this.initPromise=$(this,null,function*(){const t=d,{error:r}=yield t.from("inventory_items").select("id").limit(1);return r?console.warn("SupabaseAdapter.ts:test ❌ Probe failed",r.message||r):console.log("Supabase client initialized successfully"),this.client=t,t})),this.initPromise)}),this.getAllItems=t=>$(this,null,function*(){const r=Date.now();if(this.cachedItems&&r-this.cacheTimestamp<this.CACHE_DURATION)return this.cachedItems;let i=t==null?void 0:t.facilityId;if(!i){const{FacilityService:o}=yield T(()=>Promise.resolve().then(()=>ye),void 0);i=yield o.getCurrentFacilityId()}const n=yield this.typedAdapter.getAllItems({filters:{facility_id:i}});if(!n.success||!n.data)throw console.warn("Failed to get inventory items:",n.error),new Error(n.error||"Failed to get inventory items");return this.cachedItems=n.data,this.cacheTimestamp=Date.now(),n.data}),this.config=e,this.typedAdapter=new Mc}initialize(){return $(this,null,function*(){if(!this.isInitialized){if(!gt())throw new Error("Supabase is not properly configured");this.isInitialized=!0,this.testConnectionAsync()}})}testConnectionAsync(){return $(this,null,function*(){try{const e=yield q.getItems();e.error?console.warn("⚠️ Supabase connection test failed:",e.error):console.log("Supabase connection test passed")}catch(e){console.warn("⚠️ Supabase connection test failed:",e)}})}getItemsByCategory(e){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const t=yield this.typedAdapter.getAllItems({filters:{_category:e}});if(!t.success||!t.data)throw new Error(t.error||"Failed to get items by category");return t.data||[]}catch(t){throw new Error(`Failed to get items by category: ${t instanceof Error?t.message:"Unknown error"}`)}})}getFilteredItems(e,t){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const r=yield this.typedAdapter.getAllItems({filters:dg({search:e},t)});if(!r.success||!r.data)throw new Error(r.error||"Failed to get filtered items");return r.data||[]}catch(r){throw new Error(`Failed to get filtered items: ${r instanceof Error?r.message:"Unknown error"}`)}})}getCategories(){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{return(yield q.getCategories())||[]}catch(e){throw new Error(`Failed to get categories: ${e instanceof Error?e.message:"Unknown error"}`)}})}fetchCategories(){return $(this,null,function*(){return this.getCategories()})}updateInventoryItem(e,t){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const r=U.transformToSupabase(t);return yield q.updateItem(e,r)}catch(r){throw new Error(`Failed to update inventory item: ${r instanceof Error?r.message:"Unknown error"}`)}})}deleteInventoryItem(e){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{yield q.deleteItem(e)}catch(t){throw new Error(`Failed to delete inventory item: ${t instanceof Error?t.message:"Unknown error"}`)}})}isConnected(){return this.isInitialized}getMetadata(){return{name:"Supabase Adapter",version:"1.0.0",description:"Supabase-based inventory data adapter",capabilities:{supportsRead:!0,supportsWrite:!0,supportsDelete:!0,supportsRealTime:!0,supportsOffline:!1,supportsBatch:!1},config:this.config}}fetchAllInventoryData(){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const e=yield this.getAllItems();return{data:e,error:null,count:e.length}}catch(e){const t=e instanceof Error?e.message:"Unknown error occurred";return{data:[],error:t,count:0}}})}fetchInventoryItems(){return $(this,null,function*(){return this.getAllItems()||[]})}addInventoryItem(e){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const t=U.transformToSupabase(e);return yield q.createItem(t)}catch(t){throw new Error(`Failed to add inventory item: ${t instanceof Error?t.message:"Unknown error"}`)}})}addCategory(e){return $(this,null,function*(){return e})}deleteCategory(e){return $(this,null,function*(){})}batchAddItems(e){return $(this,null,function*(){const t=[];for(const r of e)try{const i=yield this.addInventoryItem(r);t.push(i)}catch(i){throw this.lastError=i,i}return t})}batchUpdateItems(e){return $(this,null,function*(){const t=[];for(const r of e)try{const i=yield this.updateInventoryItem(r.id,r.item);t.push(i)}catch(i){throw this.lastError=i,i}return t})}batchDeleteItems(e){return $(this,null,function*(){for(const t of e)try{yield this.deleteInventoryItem(t)}catch(r){throw this.lastError=r,r}})}sync(){return $(this,null,function*(){try{this.lastSyncTime=new Date,this.pendingChanges=!1}catch(e){throw this.lastError=e,e}})}getLastSyncTime(){return this.lastSyncTime}hasPendingChanges(){return this.pendingChanges}getLastError(){return this.lastError}clearError(){this.lastError=null}disconnect(){return $(this,null,function*(){this.isInitialized=!1,this.lastError=null})}fetchData(){return $(this,null,function*(){this.isInitialized||(yield this.initialize())})}createItem(e){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const t=U.transformToSupabase(e);return yield q.createItem(t)}catch(t){throw new Error(`Failed to create inventory item: ${t instanceof Error?t.message:"Unknown error"}`)}})}updateItem(e,t){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const r=U.transformToSupabase(t);return yield q.updateItem(e,r)}catch(r){throw new Error(`Failed to update inventory item: ${r instanceof Error?r.message:"Unknown error"}`)}})}deleteItem(e){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{yield q.deleteItem(e)}catch(t){throw new Error(`Failed to delete inventory item: ${t instanceof Error?t.message:"Unknown error"}`)}})}getAnalyticsData(){return $(this,null,function*(){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{const e=yield q.getAnalytics();return{totalItems:e.totalItems,activeItems:e.activeItems,totalValue:e.totalValue,categories:e.categories}}catch(e){throw new Error(`Failed to get analytics data: ${e instanceof Error?e.message:"Unknown error"}`)}})}transformToInventoryItems(e){return e.map(t=>U.transformFromSupabase(t))}subscribeToChanges(e){if(!this.isInitialized)throw new Error("Supabase adapter not initialized");try{return this.typedAdapter.subscribeToChanges(t=>{e&&e(t)},{event:"*"})}catch(t){return console.error("❌ Failed to set up real-time subscription in SupabaseAdapter:",t),()=>{}}}getConfig(){return this.config}clearCache(){this.cachedItems=null,this.cacheTimestamp=0}isReady(){return this.isInitialized}}const fg=Object.freeze(Object.defineProperty({__proto__:null,SupabaseAdapter:hg},Symbol.toStringTag,{value:"Module"}));var mg=Object.defineProperty,pg=Object.defineProperties,gg=Object.getOwnPropertyDescriptors,ls=Object.getOwnPropertySymbols,yg=Object.prototype.hasOwnProperty,_g=Object.prototype.propertyIsEnumerable,us=(c,e,t)=>e in c?mg(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,ds=(c,e)=>{for(var t in e||(e={}))yg.call(e,t)&&us(c,t,e[t]);if(ls)for(var t of ls(e))_g.call(e,t)&&us(c,t,e[t]);return c},vg=(c,e)=>pg(c,gg(e)),He=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class wg extends bc{constructor(e={type:"static"}){const t={supportsRead:ee()||!ce(),supportsWrite:ee()||!ce(),supportsDelete:ee()||!ce(),supportsRealTime:!1,supportsOffline:ee()||!ce(),supportsBatch:!1};super(e,{name:"StaticDataAdapter",version:"1.0.0",description:"Static data adapter for development or when Supabase is not configured",capabilities:t})}initialize(){return He(this,null,function*(){if(!(ee()||!ce()))throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}isConnected(){return ee()||!ce()}fetchAllInventoryData(){return He(this,null,function*(){if(ee()||!ce())return{data:this.getMockInventoryItems(),error:null,count:this.getMockInventoryItems().length};throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}fetchInventoryItems(){return He(this,null,function*(){if(ee()||!ce())return this.getMockInventoryItems();throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}fetchCategories(){return He(this,null,function*(){if(ee()||!ce())return this.getMockCategories();throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}addInventoryItem(e){return He(this,null,function*(){if(ee()||!ce())return vg(ds({},e),{id:`mock-${Date.now()}`});throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}updateInventoryItem(e,t){return He(this,null,function*(){if(ee()||!ce())return ds({id:e,name:"Mock Item"},t);throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}deleteInventoryItem(e){return He(this,null,function*(){if(!(ee()||!ce()))throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}addCategory(e){return He(this,null,function*(){if(ee()||!ce())return e;throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}deleteCategory(e){return He(this,null,function*(){if(!(ee()||!ce()))throw new Error("Static data adapter is disabled. This project should not use mock data. Please configure Supabase instead.")})}getMockInventoryItems(){return[{id:"mock-1",facility_id:"mock-facility",name:"Surgical Scissors",category:"Surgical Instruments",status:"Available",quantity:5,unit_cost:150,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),reorder_point:2,expiration_date:null,data:{lastUpdated:new Date().toISOString()},reorder_level:2,archived:!1,archived_at:null,archived_by:null,archive_reason:null},{id:"mock-2",facility_id:"mock-facility",name:"Stethoscope",category:"Diagnostic Equipment",status:"Available",quantity:3,unit_cost:75,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),reorder_point:1,expiration_date:null,data:{lastUpdated:new Date().toISOString()},reorder_level:1,archived:!1,archived_at:null,archived_by:null,archive_reason:null},{id:"mock-3",facility_id:"mock-facility",name:"Blood Pressure Cuff",category:"Diagnostic Equipment",status:"In Use",quantity:2,unit_cost:45,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),reorder_point:1,expiration_date:null,data:{lastUpdated:new Date().toISOString()},reorder_level:1,archived:!1,archived_at:null,archived_by:null,archive_reason:null}]}getMockCategories(){return["Surgical Instruments","Diagnostic Equipment","Medical Supplies","Office Equipment","Emergency Equipment"]}}const Ig=Object.freeze(Object.defineProperty({__proto__:null,StaticDataAdapter:wg},Symbol.toStringTag,{value:"Module"}));var Sg=Object.defineProperty,hs=Object.getOwnPropertySymbols,bg=Object.prototype.hasOwnProperty,Eg=Object.prototype.propertyIsEnumerable,fs=(c,e,t)=>e in c?Sg(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ag=(c,e)=>{for(var t in e||(e={}))bg.call(e,t)&&fs(c,t,e[t]);if(hs)for(var t of hs(e))Eg.call(e,t)&&fs(c,t,e[t]);return c},ie=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Tg(c){return c.type==="api"&&"baseUrl"in c}class kg{constructor(e){this.isInitialized=!1,this.config=Ag({timeout:1e4,retryAttempts:3},e)}initialize(){return ie(this,null,function*(){try{const e=yield this.makeRequest("GET","/health");if(!e.ok)throw new Error(`API health check failed: ${e.statusText}`);this.isInitialized=!0}catch(e){throw console.error("Failed to initialize API adapter:",e),e}})}isConnected(){return this.isInitialized}disconnect(){return ie(this,null,function*(){this.isInitialized=!1})}fetchAllInventoryData(){return ie(this,null,function*(){const t=yield(yield this.makeRequest("GET","/inventory")).json();return{data:t.items||[],error:null,count:t.totalCount||0}})}fetchInventoryItems(){return ie(this,null,function*(){return(yield this.makeRequest("GET","/inventory/items")).json()})}fetchCategories(){return ie(this,null,function*(){return(yield this.makeRequest("GET","/inventory/categories")).json()})}addInventoryItem(e){return ie(this,null,function*(){return(yield this.makeRequest("POST","/inventory/items",e)).json()})}updateInventoryItem(e,t){return ie(this,null,function*(){return(yield this.makeRequest("PUT",`/inventory/items/${e}`,t)).json()})}deleteInventoryItem(e){return ie(this,null,function*(){yield this.makeRequest("DELETE",`/inventory/items/${e}`)})}addCategory(e){return ie(this,null,function*(){return(yield(yield this.makeRequest("POST","/inventory/categories",{name:e})).json()).id||e})}deleteCategory(e){return ie(this,null,function*(){yield this.makeRequest("DELETE",`/inventory/categories/${e}`)})}batchAddItems(e){return ie(this,null,function*(){return(yield this.makeRequest("POST","/inventory/items/batch",{items:e})).json()})}batchUpdateItems(e){return ie(this,null,function*(){return(yield this.makeRequest("PUT","/inventory/items/batch",{updates:e})).json()})}batchDeleteItems(e){return ie(this,null,function*(){yield this.makeRequest("DELETE","/inventory/items/batch",{ids:e})})}sync(){return ie(this,null,function*(){return Promise.resolve()})}getLastSyncTime(){return new Date}hasPendingChanges(){return!1}getLastError(){return null}clearError(){}searchItems(e){return ie(this,null,function*(){return(yield this.makeRequest("GET",`/inventory/search?q=${encodeURIComponent(e)}`)).json()})}getMetadata(){return{name:"API Adapter",version:"1.0.0",description:"Adapter for external API data sources",capabilities:{supportsRead:!0,supportsWrite:!0,supportsDelete:!0,supportsBatch:!0,supportsRealTime:!1,supportsOffline:!1},config:this.config}}makeRequest(e,t,r){return ie(this,null,function*(){if(!this.isInitialized)throw new Error("API adapter not initialized");const i=`${this.config.baseUrl}${t}`,n={"Content-Type":"application/json"};this.config.apiKey&&(n.Authorization=`Bearer ${this.config.apiKey}`);const o={method:e,headers:n,signal:AbortSignal.timeout(this.config.timeout)};r&&(o.body=JSON.stringify(r));let s=null;for(let a=1;a<=this.config.retryAttempts;a++)try{const l=yield fetch(i,o);if(!l.ok)throw new Error(`API request failed: ${l.status} ${l.statusText}`);return l}catch(l){s=l instanceof Error?l:new Error("Unknown error"),a<this.config.retryAttempts&&(console.warn(`API request attempt ${a} failed, retrying...`,s.message),yield this.delay(Math.pow(2,a)*1e3))}throw s||new Error("API request failed after all retry attempts")})}delay(e){return new Promise(t=>setTimeout(t,e))}}const Pg=Object.freeze(Object.defineProperty({__proto__:null,ApiAdapter:kg,isApiAdapterConfig:Tg},Symbol.toStringTag,{value:"Module"}));var Br=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Cg{constructor(){this.CACHE_DURATION=300*1e3,this.cache=new Map}isCacheValid(e){return Date.now()-e<this.CACHE_DURATION}getCachedData(e){const t=this.cache.get(e);return t&&this.isCacheValid(t.timestamp)?t.data:null}setCachedData(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}getAITimeSavings(){return Br(this,null,function*(){try{const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ye),void 0),t=yield e.getCurrentFacilityId();if(!t)return v.debug("AITimeSavingsService: No facility ID, returning defaults"),{daily_time_saved:0,monthly_time_saved:0};const r=`ai-time-savings-${t}-${new Date().toISOString().split("T")[0]}`,i=this.getCachedData(r);if(i)return i;const[n,o,s,a]=yield Promise.all([this.calculateAITaskPerformanceSavings(t),this.calculateAITrainingSavings(t),this.calculateAIComplianceSavings(t),this.calculateAIPredictiveSavings(t)]),l=n.daily+o.daily+s.daily+a.daily,u=n.monthly+o.monthly+s.monthly+a.monthly,h={daily_time_saved:Math.round(l),monthly_time_saved:Math.round(u)};return this.setCachedData(r,h),v.debug("AITimeSavingsService: Calculated AI time savings:",h),h}catch(e){return v.error("AITimeSavingsService: Error calculating AI time savings:",e),{daily_time_saved:0,monthly_time_saved:0}}})}calculateAITaskPerformanceSavings(e){return Br(this,null,function*(){try{const t=new Date().toISOString().split("T")[0],r=new Date().toISOString().slice(0,7),{data:i}=yield d.from("ai_task_performance").select("time_saved").eq("facility_id",e).gte("completed_at",`${t}T00:00:00`).lt("completed_at",`${t}T23:59:59`),{data:n}=yield d.from("ai_task_performance").select("time_saved").eq("facility_id",e).gte("completed_at",`${r}-01T00:00:00`).lt("completed_at",`${r}-31T23:59:59`),o=(i||[]).reduce((a,l)=>a+(l.time_saved||0),0),s=(n||[]).reduce((a,l)=>a+(l.time_saved||0),0);return{daily:o,monthly:s}}catch(t){return v.error("AITimeSavingsService: Error calculating AI task performance savings:",t),{daily:0,monthly:0}}})}calculateAITrainingSavings(e){return Br(this,null,function*(){try{return{daily:30,monthly:900}}catch(t){return v.error("AITimeSavingsService: Error calculating AI training savings:",t),{daily:0,monthly:0}}})}calculateAIComplianceSavings(e){return Br(this,null,function*(){try{return{daily:20,monthly:600}}catch(t){return v.error("AITimeSavingsService: Error calculating AI compliance savings:",t),{daily:0,monthly:0}}})}calculateAIPredictiveSavings(e){return Br(this,null,function*(){try{return{daily:25,monthly:750}}catch(t){return v.error("AITimeSavingsService: Error calculating AI predictive savings:",t),{daily:0,monthly:0}}})}clearCache(){this.cache.clear()}}const Nc=new Cg,Dg=Object.freeze(Object.defineProperty({__proto__:null,aiTimeSavingsService:Nc},Symbol.toStringTag,{value:"Module"}));function Og(c){return c.toISOString().split("T")[0]}var Rg=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function $g(c,e){return Rg(this,null,function*(){const{data:t}=yield d.from("performance_metrics").select("*").eq("date",c).eq("facility_id",e);return t||[]})}var Mg=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function qg(){return Mg(this,null,function*(){try{const c=yield Rc.getAIImpactMetrics();return{monthly:c.costSavings.monthly,annual:c.costSavings.annual}}catch(c){return console.warn("Failed to get AI impact metrics for cost savings:",c),{monthly:0,annual:0}}})}var Fc=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function zg(){return Fc(this,null,function*(){try{const c=yield qg();return{monthly_cost_savings:c.monthly,annual_cost_savings:c.annual}}catch(c){return console.error("Error getting cost savings aggregates:",c),{monthly_cost_savings:0,annual_cost_savings:0}}})}function Ug(){return Fc(this,null,function*(){try{const{FacilityService:c}=yield T(()=>Promise.resolve().then(()=>ye),void 0),e=yield c.getCurrentFacilityId(),t=Og(new Date);console.log("👥 getTeamPerformanceAggregates: Fetching for facility:",e,"date:",t);const r=yield $g(t,e);console.log("👥 getTeamPerformanceAggregates: Daily metrics:",r);const i=r==null?void 0:r.find(o=>o.metric_type==="team_performance");console.log("👥 getTeamPerformanceAggregates: Team performance data:",i);const n={skills_score:(i==null?void 0:i.skills)||85,inventory_score:(i==null?void 0:i.inventory)||92,sterilization_score:(i==null?void 0:i.sterilization)||88};return console.log("👥 getTeamPerformanceAggregates: Returning:",n),n}catch(c){return console.error("Error getting team performance aggregates:",c),{skills_score:85,inventory_score:92,sterilization_score:88}}})}var Di=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Ng{constructor(){this.CACHE_DURATION=300*1e3,this.cache=new Map}isCacheValid(e){return Date.now()-e<this.CACHE_DURATION}getCachedData(e){const t=this.cache.get(e);return t&&this.isCacheValid(t.timestamp)?t.data:null}setCachedData(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}getOperationalTimeSavings(){return Di(this,null,function*(){try{console.log("🔍 OperationalTimeSavingsService: Starting calculation...");const{FacilityService:e}=yield T(()=>Promise.resolve().then(()=>ye),void 0),t=yield e.getCurrentFacilityId();if(console.log("🏥 OperationalTimeSavingsService: Facility ID:",t),!t)return console.log("❌ OperationalTimeSavingsService: No facility ID, returning defaults"),{daily_time_saved:0,monthly_time_saved:0};const r=`operational-time-savings-${t}-${new Date().toISOString().split("T")[0]}`,i=this.getCachedData(r);if(i)return console.log("📊 OperationalTimeSavingsService: Using cached data:",i),i;console.log("🧮 OperationalTimeSavingsService: Calculating from multiple sources...");const[n,o,s]=yield Promise.all([this.calculateSterilizationTimeSavings(t),this.calculateTaskCompletionTimeSavings(t),this.calculateCleaningTimeSavings(t)]);console.log("📈 OperationalTimeSavingsService: Individual savings:",{sterilization:n,tasks:o,cleaning:s});const a=n.daily+o.daily+s.daily,l=n.monthly+o.monthly+s.monthly,u={daily_time_saved:Math.round(a),monthly_time_saved:Math.round(l)};return this.setCachedData(r,u),console.log("✅ OperationalTimeSavingsService: Final result:",u),u}catch(e){return console.error("❌ OperationalTimeSavingsService: Error calculating operational time savings:",e),{daily_time_saved:0,monthly_time_saved:0}}})}calculateSterilizationTimeSavings(e){return Di(this,null,function*(){try{const t=new Date().toISOString().split("T")[0],r=new Date().toISOString().slice(0,7),{data:i}=yield d.from("sterilization_cycles").select("duration_minutes, end_time").eq("facility_id",e).eq("status","completed").gte("end_time",`${t}T00:00:00`).lt("end_time",`${t}T23:59:59`),{data:n}=yield d.from("sterilization_cycles").select("duration_minutes, end_time").eq("facility_id",e).eq("status","completed").gte("end_time",`${r}-01T00:00:00`).lt("end_time",`${r}-31T23:59:59`),o=(i||[]).reduce((a,l)=>{const h=l.duration_minutes||60;return a+Math.max(0,60-h)},0),s=(n||[]).reduce((a,l)=>{const h=l.duration_minutes||60;return a+Math.max(0,60-h)},0);return{daily:o,monthly:s}}catch(t){return v.error("OperationalTimeSavingsService: Error calculating sterilization savings:",t),{daily:0,monthly:0}}})}calculateTaskCompletionTimeSavings(e){return Di(this,null,function*(){try{const t=new Date().toISOString().split("T")[0],r=new Date().toISOString().slice(0,7),{data:i}=yield d.from("home_daily_operations_tasks").select("estimated_duration, actual_duration").eq("facility_id",e).eq("completed",!0).gte("completed_at",`${t}T00:00:00`).lt("completed_at",`${t}T23:59:59`),{data:n}=yield d.from("home_daily_operations_tasks").select("estimated_duration, actual_duration").eq("facility_id",e).eq("completed",!0).gte("completed_at",`${r}-01T00:00:00`).lt("completed_at",`${r}-31T23:59:59`),o=(i||[]).reduce((a,l)=>{const u=l.estimated_duration||30,h=l.actual_duration||u;return a+Math.max(0,u-h)},0),s=(n||[]).reduce((a,l)=>{const u=l.estimated_duration||30,h=l.actual_duration||u;return a+Math.max(0,u-h)},0);return{daily:o,monthly:s}}catch(t){return v.error("OperationalTimeSavingsService: Error calculating task completion savings:",t),{daily:0,monthly:0}}})}calculateCleaningTimeSavings(e){return Di(this,null,function*(){try{return{daily:45,monthly:1350}}catch(t){return v.error("OperationalTimeSavingsService: Error calculating cleaning savings:",t),{daily:0,monthly:0}}})}clearCache(){this.cache.clear()}}const Fg=new Ng;var Oi=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Lg{constructor(){this.cache=new Map,this.CACHE_TTL=300*1e3}isCacheValid(e){return Date.now()-e<this.CACHE_TTL}getCachedData(e){const t=this.cache.get(e);return t&&this.isCacheValid(t.timestamp)?t.data:null}setCachedData(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}getHomeMetrics(){return Oi(this,null,function*(){try{const e=new Date().toISOString().split("T")[0],t=`home-metrics-${e}`,r=this.getCachedData(t);if(r)return r;const{data:{user:i}}=yield d.auth.getUser();if(!i)throw new Error("User not authenticated");const{data:n,error:o}=yield d.from("users").select("facility_id").eq("id",i.id).single();if(o)return console.warn("Failed to fetch user profile, using default facility:",o),this.getDefaultMetrics();const s=(n==null?void 0:n.facility_id)||"550e8400-e29b-41d4-a716-446655440000";console.log("🏠 HomeMetricsService: Fetching metrics for facility:",s);const[a,l,u,h,f,m]=yield Promise.allSettled([Fg.getOperationalTimeSavings(),Nc.getAITimeSavings(),zg(),Ug(),this.getDailyMetrics(e,s),this.getGamificationStats(e,s)]),p=a.status==="fulfilled"?a.value:{daily_time_saved:0,monthly_time_saved:0},g=l.status==="fulfilled"?l.value:{daily_time_saved:0,monthly_time_saved:0},y=u.status==="fulfilled"?u.value:{monthly_cost_savings:0,annual_cost_savings:0},_=h.status==="fulfilled"?h.value:{skills_score:0,inventory_score:0,sterilization_score:0},w=f.status==="fulfilled"?f.value:[],b=m.status==="fulfilled"?m.value:[];console.log("📊 HomeMetricsService: Received operational time savings:",p),console.log("📊 HomeMetricsService: Received AI time savings:",g),console.log("📊 HomeMetricsService: Received cost savings:",y),console.log("📊 HomeMetricsService: Received team performance:",_);const E={timeSaved:{daily:p.daily_time_saved,monthly:p.monthly_time_saved},aiTimeSaved:{daily:g.daily_time_saved,monthly:g.monthly_time_saved},costSavings:{monthly:y.monthly_cost_savings,annual:y.annual_cost_savings},aiEfficiency:{timeSavings:this.extractAIEfficiency(w,"time_savings"),proactiveMgmt:this.extractAIEfficiency(w,"proactive_mgmt")},teamPerformance:{skills:_.skills_score,inventory:_.inventory_score,sterilization:_.sterilization_score},gamificationStats:{totalTasks:this.calculateTotalTasks(b),completedTasks:this.calculateCompletedTasks(b),perfectDays:this.calculatePerfectDays(b),currentStreak:this.calculateCurrentStreak(b),bestStreak:this.calculateBestStreak(b)}};return this.setCachedData(t,E),E}catch(e){return console.warn("Failed to fetch home metrics, using defaults:",e),this.getDefaultMetrics()}})}getDailyMetrics(e,t){return Oi(this,null,function*(){const{data:r}=yield d.from("performance_metrics").select("*").eq("date",e).eq("facility_id",t);return r||[]})}getMonthlyMetrics(e,t){return Oi(this,null,function*(){const{data:r}=yield d.from("performance_metrics").select("*").like("month",e).eq("facility_id",t);return r||[]})}getGamificationStats(e,t){return Oi(this,null,function*(){const{data:r}=yield d.from("user_gamification_stats").select("*").eq("date",e).eq("facility_id",t).limit(10);return r||[]})}extractTimeSaved(e,t){const r=e.find(i=>i.metric_type==="time_saved");return t==="daily"?(r==null?void 0:r.daily_time_saved)||0:(r==null?void 0:r.monthly_time_saved)||0}extractCostSavings(e,t){const r=e.find(i=>i.metric_type==="cost_savings");return t==="monthly"?(r==null?void 0:r.monthly_cost_savings)||0:(r==null?void 0:r.annual_cost_savings)||0}extractAIEfficiency(e,t){const r=e.find(i=>i.metric_type==="ai_efficiency");return(r==null?void 0:r[t])||0}extractTeamPerformance(e,t){const r=e.find(i=>i.metric_type==="team_performance");return(r==null?void 0:r[t])||0}calculateTotalTasks(e){return e.reduce((t,r)=>t+(r.total_tasks||0),0)}calculateCompletedTasks(e){return e.reduce((t,r)=>t+(r.completed_tasks||0),0)}calculatePerfectDays(e){return e.filter(t=>(t.completed_tasks||0)===(t.total_tasks||0)).length}calculateCurrentStreak(e){return e.reduce((t,r)=>Math.max(t,r.current_streak||0),0)}calculateBestStreak(e){return e.reduce((t,r)=>Math.max(t,r.best_streak||0),0)}getDefaultMetrics(){return{timeSaved:{daily:0,monthly:0},aiTimeSaved:{daily:0,monthly:0},costSavings:{monthly:0,annual:0},aiEfficiency:{timeSavings:0,proactiveMgmt:0},teamPerformance:{skills:0,inventory:0,sterilization:0},gamificationStats:{totalTasks:0,completedTasks:0,perfectDays:0,currentStreak:0,bestStreak:0}}}}const xg=new Lg,Bg=Object.freeze(Object.defineProperty({__proto__:null,homeMetricsService:xg},Symbol.toStringTag,{value:"Module"}));var Ge=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class jg{getCachedUser(){return null}getSterilizationMetrics(){return Ge(this,null,function*(){try{const e=yield this.getCachedUser();return e?yield this.getConsolidatedSterilizationMetrics(e.facility_id):this.getDefaultSterilizationMetrics()}catch(e){return console.error("Error fetching sterilization metrics:",e),this.getDefaultSterilizationMetrics()}})}getConsolidatedSterilizationMetrics(e){return Ge(this,null,function*(){const t=new Date().toISOString().split("T")[0],r=new Date;r.setDate(r.getDate()-7);const i=new Date;i.setDate(i.getDate()-30);const{data:n,error:o}=yield d.from("sterilization_cycles").select("id, status, created_at, end_time").eq("facility_id",e).gte("created_at",i.toISOString()).lte("created_at",t).order("created_at",{ascending:!1});return o?(console.error("Error fetching consolidated sterilization metrics:",o),yield this.getFallbackSterilizationMetrics(e)):n&&Array.isArray(n)&&n.length>0?this.mapDatabaseResponseToMetrics(n[0]):this.getDefaultSterilizationMetrics()})}mapDatabaseResponseToMetrics(e){return{cyclesToday:e.cycles_today||0,cyclesThisWeek:e.cycles_this_week||0,biPassRate:e.bi_pass_rate||0,averageCycleTime:e.average_cycle_time||0,toolsInCycle:e.tools_in_cycle||0,toolsCompletedToday:e.tools_completed_today||0,performanceScore:e.performance_score||0}}getFallbackSterilizationMetrics(e){return Ge(this,null,function*(){const[t,r,i,n,o,s]=yield Promise.all([this.getCyclesToday(e),this.getCyclesThisWeek(e),this.getBITestResults(e),this.getCycleTimes(e),this.getToolsInCycle(e),this.getToolsCompletedToday(e)]),a=this.calculateBIPassRate(i),l=this.calculateAverageCycleTime(n),u=this.calculatePerformanceScore({biPassRate:a,averageCycleTime:l,cyclesToday:t});return{cyclesToday:t,cyclesThisWeek:r,biPassRate:a,averageCycleTime:l,toolsInCycle:o,toolsCompletedToday:s,performanceScore:u}})}getCyclesToday(e){return Ge(this,null,function*(){const{data:t,error:r}=yield d.from("sterilization_cycles").select("id").eq("facility_id",e).gte("created_at",new Date().toISOString().split("T")[0]);return r?(console.error("Error fetching cycles today:",r),0):(t==null?void 0:t.length)||0})}getCyclesThisWeek(e){return Ge(this,null,function*(){const t=new Date;t.setDate(t.getDate()-7);const{data:r,error:i}=yield d.from("sterilization_cycles").select("id").eq("facility_id",e).gte("created_at",t.toISOString());return i?(console.error("Error fetching cycles this week:",i),0):(r==null?void 0:r.length)||0})}getBITestResults(e){return Ge(this,null,function*(){const{data:t,error:r}=yield d.from("bi_test_results").select("result").eq("facility_id",e).gte("created_at",new Date(Date.now()-2592e6).toISOString());return r?(console.error("Error fetching BI test results:",r),[]):t||[]})}getCycleTimes(e){return Ge(this,null,function*(){const{data:t,error:r}=yield d.from("sterilization_cycles").select("start_time, end_time, duration_minutes").eq("facility_id",e).eq("status","completed").gte("created_at",new Date(Date.now()-6048e5).toISOString());return r?(console.error("Error fetching cycle times:",r),[]):t||[]})}getToolsInCycle(e){return Ge(this,null,function*(){try{return(yield pe.getToolsByFacilityAndStatus(e,"in_cycle")).length}catch(t){return console.error("Error fetching tools in cycle:",t),0}})}getToolsCompletedToday(e){return Ge(this,null,function*(){try{const t=yield pe.getToolsByFacilityAndStatus(e,"available"),r=new Date().toISOString().split("T")[0];return t.filter(n=>n.updated_at&&n.updated_at.split("T")[0]>=r).length}catch(t){return console.error("Error fetching tools completed today:",t),0}})}calculateBIPassRate(e){if(e.length===0)return 0;const t=e.filter(r=>r.result==="pass").length;return Math.round(t/e.length*100)}calculateAverageCycleTime(e){if(e.length===0)return 0;const t=e.reduce((r,i)=>r+(i.duration_minutes||0),0);return Math.round(t/e.length)}calculatePerformanceScore(e){const t=Math.min(e.biPassRate,100),r=Math.min(e.cyclesToday*10,50),i=Math.max(0,50-e.averageCycleTime);return Math.round((t+r+i)/3)}getDefaultSterilizationMetrics(){return{cyclesToday:0,cyclesThisWeek:0,biPassRate:0,averageCycleTime:0,toolsInCycle:0,toolsCompletedToday:0,performanceScore:0}}}const Vg=new jg,Hg=Object.freeze(Object.defineProperty({__proto__:null,homeSterilizationIntegration:Vg},Symbol.toStringTag,{value:"Module"}));var On=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Gg{getInventoryMetrics(){return On(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:t}=yield d.from("users").select("facility_id").eq("id",e.id).single(),r=(t==null?void 0:t.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{data:i,error:n}=yield d.from("inventory_items").select("status").eq("facility_id",r);if(n)return console.warn("Failed to fetch aggregated inventory metrics, using fallback:",n),{lowStockItems:0,totalItems:0,expiringItems:0,inventoryAccuracy:0};const o=(i==null?void 0:i.length)||0,s=(i==null?void 0:i.filter(u=>u.status==="low_stock").length)||0,a=(i==null?void 0:i.filter(u=>u.status==="expiring").length)||0,l=o>0?(o-s)/o*100:0;return{lowStockItems:s,totalItems:o,expiringItems:a,inventoryAccuracy:l}}catch(e){return console.error("Error fetching inventory metrics:",e),{lowStockItems:0,totalItems:0,expiringItems:0,inventoryAccuracy:0}}})}getEnvironmentalCleanMetrics(){return On(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:t}=yield d.from("users").select("facility_id").eq("id",e.id).single(),r=(t==null?void 0:t.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{data:i,error:n}=yield d.from("environmental_clean_logs").select("status, area").eq("facility_id",r);if(n)return console.warn("Failed to fetch aggregated environmental clean metrics, using fallback:",n),{cleaningEfficiency:0,totalRooms:0,cleanRooms:0,complianceScore:98};const o=(i==null?void 0:i.length)||0,s=(i==null?void 0:i.filter(u=>u.status==="completed").length)||0,a=o>0?s/o*100:0,l=a>90?98:Math.max(70,a);return{cleaningEfficiency:a,totalRooms:o,cleanRooms:s,complianceScore:l}}catch(e){return console.error("Error fetching environmental clean metrics:",e),{cleaningEfficiency:0,totalRooms:0,cleanRooms:0,complianceScore:98}}})}getAllMetrics(){return On(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:t}=yield d.from("users").select("facility_id").eq("id",e.id).single(),r=(t==null?void 0:t.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{data:i,error:n}=yield d.from("sterilization_cycles").select("status, created_at, end_time").eq("facility_id",r).order("created_at",{ascending:!1}).limit(10);if(n){console.warn("Failed to fetch combined metrics, falling back to individual calls:",n);const[s,a]=yield Promise.all([this.getInventoryMetrics(),this.getEnvironmentalCleanMetrics()]);return{inventory:s,environmentalClean:a}}const o=(i==null?void 0:i[0])||{};return{inventory:{lowStockItems:(o==null?void 0:o.inventory_low_stock_items)||0,totalItems:(o==null?void 0:o.inventory_total_items)||0,expiringItems:(o==null?void 0:o.inventory_expiring_items)||0,inventoryAccuracy:(o==null?void 0:o.inventory_accuracy)||0},environmentalClean:{cleaningEfficiency:(o==null?void 0:o.cleaning_efficiency)||0,totalRooms:(o==null?void 0:o.cleaning_total_rooms)||0,cleanRooms:(o==null?void 0:o.cleaning_clean_rooms)||0,complianceScore:(o==null?void 0:o.cleaning_compliance_score)||98}}}catch(e){return console.error("Error fetching all home integration metrics:",e),{inventory:{lowStockItems:0,totalItems:0,expiringItems:0,inventoryAccuracy:0},environmentalClean:{cleaningEfficiency:0,totalRooms:0,cleanRooms:0,complianceScore:98}}}})}}const Wg=new Gg,Kg=Object.freeze(Object.defineProperty({__proto__:null,homeIntegrationService:Wg},Symbol.toStringTag,{value:"Module"}));var Rn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Vv{static scanToolForCleanWorkflow(e,t){return Rn(this,null,function*(){try{let r;try{if(r=yield pe.getToolByBarcodeAndStatus(e,"clean"),!r)return{success:!1,message:`Tool with barcode "${e}" not found or not available for sterilization.`}}catch(a){return{success:!1,message:`Tool with barcode "${e}" not found or not available for sterilization.`}}if(r.current_cycle_id&&!r.id.startsWith("mock-tool-")){const{data:a}=yield d.from("sterilization_cycles").select("status").eq("id",r.current_cycle_id).single();if((a==null?void 0:a.status)!=="completed")return{success:!1,message:`Tool "${r.tool_name}" is not ready for clean workflow. Current cycle status: ${(a==null?void 0:a.status)||"unknown"}`}}const i=yield pe.updateToolStatus(r.id,"dirty");yield pe.clearCycleAssignment([r.id],"dirty"),yield pe.markAsSterilized(r.id);const n={user_id:t,facility_id:r.facility_id,module:"sterilization",action:"tool_scanned_clean_workflow",table_name:"sterilization_tools",record_id:r.id,old_values:{status:"available",current_cycle_id:r.current_cycle_id},new_values:{status:"in_cycle",current_cycle_id:null},metadata:{barcode:e,workflow:"clean",previous_phase:"complete",new_phase:"dirty"}};yield d.from("audit_logs").insert(n);const o=i,s={id:o.id,name:o.tool_name,barcode:o.barcode,category:o.category||"general",type:o.tool_type,currentPhase:"failed",status:o.status,location:o.location,cycleCount:o.sterilization_count||0,lastSterilized:o.last_sterilized,notes:o.notes,is_p2_tool:o.is_p2_tool};return{success:!0,message:`Successfully scanned tool "${o.tool_name}" and marked as dirty. Ready for sterilization.`,tool:s}}catch(r){return console.error("Error scanning tool for clean workflow:",r),{success:!1,message:"An unexpected error occurred while scanning the tool."}}})}static scanToolForProblemWorkflow(e,t,r,i){return Rn(this,null,function*(){try{const{data:n,error:o}=yield d.from("tools").select("*").eq("barcode",e).single();if(o||!n)return{success:!1,message:`Tool with barcode "${e}" not found in system.`};const s=n;let a=null;if(s.current_cycle_id){const{data:p}=yield d.from("sterilization_cycles").select("*").eq("id",s.current_cycle_id).single();a=p}const l=yield pe.updateToolStatus(s.id,"problem");yield pe.clearCycleAssignment([s.id],"problem");const{error:u}=yield d.from("tools").update({updated_at:new Date().toISOString(),notes:`PROBLEM: ${t} - ${r}`}).eq("id",s.id);if(u)return console.error("Failed to update tool status:",u),{success:!1,message:"Failed to update tool status. Please try again."};const h={user_id:i,facility_id:s.facility_id,module:"sterilization",action:"tool_scanned_problem_workflow",table_name:"sterilization_tools",record_id:s.id,old_values:{status:s.status,current_cycle_id:s.current_cycle_id,sterilization_count:s.sterilization_count,last_sterilized:s.last_sterilized},new_values:{status:"quarantine",current_cycle_id:null,notes:`PROBLEM: ${t} - ${r}`},metadata:{barcode:e,workflow:"problem",problem_type:t,problem_notes:r,previous_phase:"clean_workflow_scan",new_phase:"quarantine",last_cycle_id:s.current_cycle_id,last_cycle_status:a==null?void 0:a.status,last_cycle_completed:a==null?void 0:a.completed_at,sterilization_count_at_problem:s.sterilization_count,process_improvement_flag:!0,inspection_quality_issue:t.includes("damage")||t.includes("inspection"),cleaning_quality_issue:t.includes("cleaning")||t.includes("contamination")}};yield d.from("audit_logs").insert(h);const f=l,m={id:f.id,name:f.tool_name,barcode:f.barcode,category:f.category||"general",type:f.tool_type,currentPhase:"quarantine",status:f.status,location:f.location,cycleCount:f.sterilization_count||0,lastSterilized:f.last_sterilized,notes:f.notes,is_p2_tool:f.is_p2_tool};return{success:!0,message:`Tool "${f.tool_name}" marked as problem (${t}). Process improvement data collected.`,tool:m}}catch(n){return console.error("Error scanning tool for problem workflow:",n),{success:!1,message:"An unexpected error occurred while processing the problem tool."}}})}static getAvailableTools(e){return Rn(this,null,function*(){try{return(yield pe.getToolsByFacilityAndStatus(e,"clean")).sort((i,n)=>(i.name||"").localeCompare(n.name||"")).map(i=>{const n=i;return{id:n.id,name:n.tool_name,barcode:n.barcode,category:n.category||"general",type:n.tool_type,currentPhase:n.current_cycle_id?"complete":"available",status:n.status,location:n.location,cycleCount:n.sterilization_count||0,lastSterilized:n.last_sterilized,notes:n.notes}})}catch(t){return console.error("Error fetching available tools:",t),[]}})}}var Gr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function jr(){return Gr(this,null,function*(){const{data:{user:c}}=yield d.auth.getUser();if(!c)throw new Error("User not authenticated");const{data:e,error:t}=yield d.from("users").select("facility_id").eq("id",c.id).single();if(t||!e)throw new Error("Failed to get user facility");return e.facility_id})}class Hv{static getBatchInfoForTool(e){return Gr(this,null,function*(){try{const{data:t,error:r}=yield d.from("sterilization_batches").select("*").eq("id",e).order("created_at",{ascending:!1}).limit(1).single();if(r||!t)return null;const i=t;let n;if(i.cycle_id){const l=yield jr(),{data:u,error:h}=yield d.from("sterilization_cycles").select("cycle_name").eq("id",i.cycle_id).eq("facility_id",l).single();!h&&u&&(n=u.cycle_name)}const{data:o,error:s}=yield d.from("users").select("name").eq("id",i.requested_by).single(),a=s?"Unknown":(o==null?void 0:o.full_name)||"Unknown";return{batchId:i.id,batchName:i.batch_name,cycleId:i.cycle_id,cycleName:n,status:i.status,totalItems:i.total_items,createdBy:a,createdAt:new Date(i.created_at),completedAt:i.completed_at?new Date(i.completed_at):void 0}}catch(t){return console.error("Error getting batch info for tool:",t),null}})}static getBatchInfoForTools(e){return Gr(this,null,function*(){try{if(e.length===0)return[];const{data:t,error:r}=yield d.from("sterilization_batches").select("*").in("id",e).order("created_at",{ascending:!1});if(r||!t)return[];const i=yield jr(),{data:n,error:o}=yield d.from("tools").select("id, tool_name, barcode, last_sterilized, sterilization_count").in("id",e).eq("facility_id",i);if(o||!n)return[];const s=new Map(n.map(h=>[h.id,{name:h.tool_name,barcode:h.barcode,lastSterilized:h.last_sterilized,cycleCount:h.sterilization_count}])),a=t,l=Array.from(new Set(a.map(h=>h.cycle_id).filter(Boolean))),u=new Map;if(l.length>0){const h=yield jr(),{data:f,error:m}=yield d.from("sterilization_cycles").select("id, cycle_name").in("id",l).eq("facility_id",h);!m&&f&&f.forEach(p=>{u.set(p.id,p.cycle_name)})}return a.map(h=>{const f=s.get(h.id);return{toolId:h.id,toolName:(f==null?void 0:f.name)||"Unknown Tool",barcode:(f==null?void 0:f.barcode)||"Unknown",batchId:h.id,batchName:h.batch_name,cycleId:h.cycle_id,cycleName:h.cycle_id?u.get(h.cycle_id):void 0,status:h.status,lastSterilized:f!=null&&f.lastSterilized?new Date(f.lastSterilized):void 0,cycleCount:(f==null?void 0:f.cycleCount)||0}})}catch(t){return console.error("Error getting batch info for tools:",t),[]}})}static getCurrentBatchFromCycle(e){return Gr(this,null,function*(){try{const t=yield jr(),{data:r,error:i}=yield d.from("tools").select("current_cycle_id, tool_name").eq("id",e).eq("facility_id",t).single(),n=r;if(i||!r||!n.current_cycle_id)return null;const{data:o,error:s}=yield d.from("sterilization_cycles").select("*").eq("id",n.current_cycle_id).eq("facility_id",t).single();if(s||!o)return null;const{data:a,error:l}=yield d.from("sterilization_batches").select("*").eq("cycle_id",n.current_cycle_id).single(),u=o;if(l||!a)return{batchId:`VIRTUAL-${n.current_cycle_id}`,batchName:`Cycle ${u.cycle_name||u.id}`,cycleId:n.current_cycle_id,cycleName:u.cycle_name,status:u.status,totalItems:1,createdBy:"System",createdAt:new Date(u.start_time),completedAt:u.end_time?new Date(u.end_time):void 0};const h=a,{data:f,error:m}=yield d.from("users").select("name").eq("id",h.requested_by).single(),p=f,g=m?"Unknown":(p==null?void 0:p.full_name)||"Unknown";return{batchId:h.id,batchName:h.batch_name,cycleId:h.cycle_id||void 0,cycleName:u.cycle_name,status:h.status,totalItems:h.total_items,createdBy:g,createdAt:new Date(h.created_at),completedAt:h.completed_at?new Date(h.completed_at):void 0}}catch(t){return console.error("Error getting current batch from cycle:",t),null}})}static generateBatchIdFromCycleData(e){try{if(e.cycleId)return`BATCH-${e.cycleId}`;if(e.lastSterilized){const t=new Date(e.lastSterilized);return`BATCH-${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}${String(t.getDate()).padStart(2,"0")}-${e.id.slice(-4)}`}return e.currentCycleId?`BATCH-${e.currentCycleId}`:null}catch(t){return console.error("Failed to generate batch ID from cycle data:",t),null}}static getMostRecentBatchForTool(e){return Gr(this,null,function*(){try{let t=yield this.getBatchInfoForTool(e);if(t||(t=yield this.getCurrentBatchFromCycle(e),t))return t;const r=yield jr(),{data:i,error:n}=yield d.from("tools").select("tool_name, last_sterilized, sterilization_count").eq("id",e).eq("facility_id",r).single();if(n||!i)return null;const o=i;if(o.last_sterilized){const s=new Date(o.last_sterilized);return{batchId:`VIRTUAL-${e}`,batchName:`Last Sterilization - ${o.tool_name}`,status:"completed",totalItems:1,createdBy:"System",createdAt:s,completedAt:s}}return null}catch(t){return console.error("Error getting most recent batch for tool:",t),null}})}}var Qg=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Gv(c){return Qg(this,null,function*(){var e;const{assignedLocation:t,toolsCount:r}=c;if(!t||t.trim()==="")return{status:"unassigned",confidence:1,reasoning:"No location assigned to batch"};if(r===0)return{status:"unassigned",confidence:1,reasoning:"No tools in batch to assign location"};try{const{data:{user:i}}=yield d.auth.getUser(),n=(e=i==null?void 0:i.user_metadata)==null?void 0:e.facility_id;if(!n)return{status:"invalid_location",confidence:.8,reasoning:"Cannot validate location without facility context"};const{data:o,error:s}=yield d.from("rooms").select("id, name").eq("facility_id",n).ilike("name",`%${t}%`).limit(1);return s||!o||o.length===0?{status:"invalid_location",confidence:.9,reasoning:`Location "${t}" not found in facility`}:{status:"valid",confidence:1,reasoning:`Location "${t}" validated successfully`}}catch(i){return console.error("Location validation failed:",i),{status:"invalid_location",confidence:.3,reasoning:"Location validation error occurred"}}})}var Yg=Object.defineProperty,Jg=Object.defineProperties,Xg=Object.getOwnPropertyDescriptors,ms=Object.getOwnPropertySymbols,Zg=Object.prototype.hasOwnProperty,ey=Object.prototype.propertyIsEnumerable,ps=(c,e,t)=>e in c?Yg(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,ty=(c,e)=>{for(var t in e||(e={}))Zg.call(e,t)&&ps(c,t,e[t]);if(ms)for(var t of ms(e))ey.call(e,t)&&ps(c,t,e[t]);return c},ry=(c,e)=>Jg(c,Xg(e));class iy{constructor(){this.events=[],this.MAX_EVENTS=1e4}recordEvent(e){const t=ry(ty({},e),{id:`analytics_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date().toISOString()});this.events.push(t),this.events.length>this.MAX_EVENTS&&(this.events=this.events.slice(-this.MAX_EVENTS)),this.sendToExternalAnalytics(t),console.log("📊 Analytics Event:",t)}sendToExternalAnalytics(e){try{console.log("📈 External Analytics:",{service:"tracking_analytics",eventType:e.eventType,toolId:e.toolId,doctorName:e.doctorName,timestamp:e.timestamp})}catch(t){console.warn("Failed to send to external analytics:",t)}}recordTrackStarted(e,t,r,i,n,o){this.recordEvent({eventType:"track_started",toolId:e,toolName:t,doctorName:r,priority:i,metadata:{queuePosition:n,totalInQueue:o}})}recordTrackStopped(e,t,r,i,n){this.recordEvent({eventType:"track_stopped",toolId:e,toolName:t,doctorName:r,priority:i,metadata:{waitTime:n}})}recordToolAvailable(e,t,r,i,n){this.recordEvent({eventType:"tool_available",toolId:e,toolName:t,doctorName:r,priority:i,metadata:{waitTime:n}})}recordToolClaimed(e,t,r,i,n){this.recordEvent({eventType:"tool_claimed",toolId:e,toolName:t,doctorName:r,priority:i,metadata:{waitTime:n}})}recordQueuePositionChanged(e,t,r,i,n,o,s){this.recordEvent({eventType:"queue_position_changed",toolId:e,toolName:t,doctorName:r,priority:i,metadata:{queuePosition:n,totalInQueue:s,previousPosition:o}})}getAnalyticsSummary(e){let t=this.events;e&&(t=this.events.filter(m=>{const p=new Date(m.timestamp);return p>=e.start&&p<=e.end}));const r=t.length,i=new Set(t.map(m=>m.toolId)).size,n=new Set(t.map(m=>m.doctorName)).size,o=t.filter(m=>{var p;return(p=m.metadata)==null?void 0:p.waitTime}),s=o.length>0?o.reduce((m,p)=>{var g;return m+(((g=p.metadata)==null?void 0:g.waitTime)||0)},0)/o.length:0,a=new Map;t.forEach(m=>{if(m.eventType==="track_started"){const p=a.get(m.toolId)||{toolName:m.toolName,count:0};p.count++,a.set(m.toolId,p)}});const l=Array.from(a.entries()).map(([m,p])=>({toolId:m,toolName:p.toolName,trackingCount:p.count})).sort((m,p)=>p.trackingCount-m.trackingCount).slice(0,10),u={high:t.filter(m=>m.priority==="high").length,medium:t.filter(m=>m.priority==="medium").length,low:t.filter(m=>m.priority==="low").length},h=Array.from({length:24},(m,p)=>({hour:p,count:t.filter(g=>new Date(g.timestamp).getHours()===p).length})),f=Array.from({length:30},(m,p)=>{const g=new Date;g.setDate(g.getDate()-p);const y=g.toISOString().split("T")[0];return{date:y,count:t.filter(_=>_.timestamp.split("T")[0]===y).length}}).reverse();return{totalTrackingEvents:r,uniqueToolsTracked:i,uniqueUsersTracking:n,averageQueueWaitTime:s,mostTrackedTools:l,trackingByPriority:u,trackingByHour:h,trackingByDay:f}}getToolAnalytics(e){return this.events.filter(t=>t.toolId===e)}getUserAnalytics(e){return this.events.filter(t=>t.doctorName===e)}clearOldEvents(e=30){const t=new Date;t.setDate(t.getDate()-e),this.events=this.events.filter(r=>new Date(r.timestamp)>t)}}const $n=new iy;class ny{constructor(){this.statusCallbacks=[],this.toolStatuses=new Map,this.monitoringInterval=null,this.MONITORING_INTERVAL=3e4}startMonitoring(){this.monitoringInterval||(console.log("🔄 Starting real-time tool status monitoring..."),this.monitoringInterval=setInterval(()=>{this.checkToolStatuses()},this.MONITORING_INTERVAL))}stopMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null,console.log("⏹️ Stopped real-time tool status monitoring"))}subscribe(e){return this.statusCallbacks.push(e),()=>{const t=this.statusCallbacks.indexOf(e);t>-1&&this.statusCallbacks.splice(t,1)}}checkToolStatuses(){const e=Array.from(this.toolStatuses.keys());if(e.length===0){[{id:"demo-tool-1",name:"Surgical Scissors",status:"available"},{id:"demo-tool-2",name:"Forceps",status:"in_use"},{id:"demo-tool-3",name:"Scalpel",status:"unavailable"}].forEach(r=>{this.toolStatuses.set(r.id,r.status)});return}e.forEach(t=>{if(Math.random()<.05){const r=this.toolStatuses.get(t),i=this.getRandomStatus(r);i!==r&&this.handleStatusChange(t,r,i)}})}getRandomStatus(e){const r=["available","unavailable","in_use","maintenance"].filter(i=>i!==e);return r[Math.floor(Math.random()*r.length)]}handleStatusChange(e,t,r){this.toolStatuses.set(e,r);const i={toolId:e,toolName:`Tool ${e.slice(0,8)}...`,oldStatus:t,newStatus:r,timestamp:new Date().toISOString(),reason:this.getStatusChangeReason(t,r)};(t==="unavailable"||r==="unavailable"||t==="maintenance"||r==="maintenance")&&console.log("📊 Tool status changed:",i),this.statusCallbacks.forEach(n=>{try{n(i)}catch(o){console.error("Error in status change callback:",o)}})}getStatusChangeReason(e,t){var r;return((r={available:{in_use:"Tool was checked out",unavailable:"Tool was removed from inventory",maintenance:"Tool sent for maintenance"},in_use:{available:"Tool was returned",unavailable:"Tool was damaged during use",maintenance:"Tool requires maintenance after use"},unavailable:{available:"Tool was repaired and returned",in_use:"Tool was checked out despite being unavailable",maintenance:"Tool sent for repair"},maintenance:{available:"Maintenance completed successfully",unavailable:"Tool requires replacement after maintenance",in_use:"Tool checked out after maintenance"}}[e])==null?void 0:r[t])||"Status changed"}triggerStatusChange(e,t,r){const i=this.toolStatuses.get(e)||"available",n={toolId:e,toolName:r||`Tool ${e.slice(0,8)}...`,oldStatus:i,newStatus:t,timestamp:new Date().toISOString(),reason:this.getStatusChangeReason(i,t)};this.toolStatuses.set(e,t),this.statusCallbacks.forEach(o=>{try{o(n)}catch(s){console.error("Error in status change callback:",s)}})}getToolStatus(e){return this.toolStatuses.get(e)}getAllToolStatuses(){return new Map(this.toolStatuses)}isMonitoring(){return this.monitoringInterval!==null}}const Lc=new ny,Wv=Object.freeze(Object.defineProperty({__proto__:null,realTimeStatusMonitor:Lc},Symbol.toStringTag,{value:"Module"}));var Ri=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class ay{constructor(){this.SYNC_INTERVAL=3e4,this.syncInterval=null,this.pendingSyncs=new Map}startAutoSync(){this.syncInterval||(console.log("🔄 Starting automatic database synchronization..."),this.syncInterval=setInterval(()=>{this.syncAllPendingChanges()},this.SYNC_INTERVAL))}stopAutoSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null,console.log("⏹️ Stopped automatic database synchronization"))}queueSync(e){const t=`${e.toolId}-${e.doctorName}`;this.pendingSyncs.set(t,e),console.log("📝 Queued sync for:",{toolId:e.toolId,doctorName:e.doctorName,priority:e.priority,status:e.status})}syncAllPendingChanges(){return Ri(this,null,function*(){if(this.pendingSyncs.size===0)return{success:!0,syncedCount:0};console.log(`🔄 Syncing ${this.pendingSyncs.size} pending changes...`);try{const e=yield this.performDatabaseSync(Array.from(this.pendingSyncs.values()));return e.success?(this.pendingSyncs.clear(),console.log(`✅ Successfully synced ${e.syncedCount} changes`)):console.error("❌ Database sync failed:",e.error),e}catch(e){return console.error("❌ Database sync error:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}})}performDatabaseSync(e){return Ri(this,null,function*(){yield new Promise(r=>setTimeout(r,1e3));const t=Math.random()>.1;return{success:t,syncedCount:e.length,error:t?void 0:"Simulated database error"}})}syncImmediate(e){return Ri(this,null,function*(){try{const t=yield this.performDatabaseSync([e]);if(t.success){const r=`${e.toolId}-${e.doctorName}`;this.pendingSyncs.delete(r)}return t}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}})}getPendingSyncCount(){return this.pendingSyncs.size}getPendingSyncs(){return Array.from(this.pendingSyncs.values())}clearPendingSyncs(){this.pendingSyncs.clear(),console.log("🗑️ Cleared all pending syncs")}isAutoSyncRunning(){return this.syncInterval!==null}forceSync(){return Ri(this,null,function*(){return console.log("🔄 Force syncing all pending changes..."),yield this.syncAllPendingChanges()})}}const Mn=new ay;var oy=Object.defineProperty,sy=Object.defineProperties,cy=Object.getOwnPropertyDescriptors,gs=Object.getOwnPropertySymbols,ly=Object.prototype.hasOwnProperty,uy=Object.prototype.propertyIsEnumerable,ys=(c,e,t)=>e in c?oy(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,dy=(c,e)=>{for(var t in e||(e={}))ly.call(e,t)&&ys(c,t,e[t]);if(gs)for(var t of gs(e))uy.call(e,t)&&ys(c,t,e[t]);return c},hy=(c,e)=>sy(c,cy(e)),qn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class fy{constructor(){this.notifications=[],this.priorityQueue=[],this.statusChangeCallbacks=[],Lc.subscribe(this.handleToolStatusChange.bind(this)),Mn.startAutoSync()}trackTool(e,t,r="medium",i){return qn(this,null,function*(){const n=this.priorityQueue.findIndex(l=>l.toolId===e&&l.doctorName===t);n>=0?this.priorityQueue[n]=hy(dy({},this.priorityQueue[n]),{timestamp:new Date().toISOString(),priority:r,status:"waiting"}):this.priorityQueue.push({toolId:e,doctorName:t,timestamp:new Date().toISOString(),priority:r,status:"waiting"}),yield this.syncWithDatabase(e,!0);const o=this.getToolTrackers(e).length,s=this.getQueuePosition(e,t);console.log("🔔 Tool tracked:",{toolId:e,totalInQueue:o,queuePosition:s,doctorName:t});const a=i||`Tool ${e}`;ri.notifyToolAvailable(e,a,s,o,r),$n.recordTrackStarted(e,a,t,r,s,o)})}untrackTool(e,t){return qn(this,null,function*(){const r=this.priorityQueue.findIndex(i=>i.toolId===e&&i.doctorName===t);if(r>=0){const i=this.getToolTrackers(e),n=this.priorityQueue[r];this.priorityQueue.splice(r,1),this.notifyQueuePositionChanges(e,i,n.doctorName);const o=this.priorityQueue.some(s=>s.toolId===e);yield this.syncWithDatabase(e,o),$n.recordTrackStopped(e,`Tool ${e}`,t,n.priority)}})}notifyQueuePositionChanges(e,t,r){const i=this.getToolTrackers(e);t.forEach((n,o)=>{n.doctorName!==r&&i.findIndex(s=>s.doctorName===n.doctorName)})}isToolTracked(e){return this.priorityQueue.some(t=>t.toolId===e)}getToolTrackers(e){return this.priorityQueue.filter(t=>t.toolId===e).sort((t,r)=>{const i={high:3,medium:2,low:1},n=i[r.priority]-i[t.priority];return n!==0?n:new Date(t.timestamp).getTime()-new Date(r.timestamp).getTime()})}monitorToolStatusChange(e,t,r){(r==="available"||r==="complete")&&this.handleToolBecameAvailable(e),t==="available"&&(r==="in_use"||r==="sterilizing")&&this.handleToolBecameUnavailable(e,`Tool ${e}`),this.statusChangeCallbacks.forEach(i=>i(e,t,r))}handleToolBecameAvailable(e){const t=this.getToolTrackers(e);if(t.length===0)return;const r={high:3,medium:2,low:1},i=[...t].sort((s,a)=>r[a.priority]-r[s.priority]),n=i[0];if(n&&n.status==="waiting"){const s=`Tool ${e}`;ri.notifyToolAvailable(e,s,1,t.length);const a={id:`notification_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,toolId:e,toolName:s,doctorName:n.doctorName,timestamp:new Date().toISOString(),status:"pending",priority:n.priority,message:"Your tracked tool is now available! You have first priority to claim it."};this.notifications.push(a),n.status="notified"}i.map(s=>s.doctorName===n.doctorName?n:s).forEach(s=>{const a=this.priorityQueue.findIndex(l=>l.toolId===e&&l.doctorName===s.doctorName);a>=0&&(this.priorityQueue[a]=s)})}acknowledgeNotification(e){const t=this.notifications.find(r=>r.id===e);if(t){t.status="acknowledged";const r=this.priorityQueue.find(i=>i.toolId===t.toolId&&i.doctorName===t.doctorName);r&&(r.status="claimed")}}getPendingNotifications(e){return this.notifications.filter(t=>t.doctorName===e&&t.status==="pending")}getAllNotifications(e){return this.notifications.filter(t=>t.doctorName===e)}clearExpiredNotifications(){const e=new Date(Date.now()-864e5);this.notifications=this.notifications.filter(t=>{const r=new Date(t.timestamp)<e;return r&&t.status==="pending"&&(t.status="expired"),!r})}subscribeToStatusChanges(e){return this.statusChangeCallbacks.push(e),()=>{const t=this.statusChangeCallbacks.indexOf(e);t>=0&&this.statusChangeCallbacks.splice(t,1)}}isCleanStatus(e){const t=e.toLowerCase();return["clean","active"].includes(t)}getPriorityQueue(e){return this.priorityQueue.filter(t=>t.toolId===e).sort((t,r)=>{const i={high:3,medium:2,low:1},n=i[r.priority]-i[t.priority];return n!==0?n:new Date(t.timestamp).getTime()-new Date(r.timestamp).getTime()})}getTrackedToolsForDoctor(e){return this.priorityQueue.filter(t=>t.doctorName===e)}syncWithDatabase(e,t){return qn(this,null,function*(){const{data:{user:r}}=yield d.auth.getUser(),i=(r==null?void 0:r.id)||"unknown-user",n=this.getToolTrackers(e);if(t&&n.length>0)n.forEach(o=>{const s={toolId:e,doctorName:o.doctorName,priority:o.priority,timestamp:o.timestamp,status:o.status};Mn.queueSync(s)});else{const o={toolId:e,doctorName:i,priority:"medium",timestamp:new Date().toISOString(),status:"expired"};Mn.queueSync(o)}console.log(`📝 Queued database sync for tool ${e}: ${t?"tracked":"untracked"}`)})}getQueuePosition(e,t){const r=this.getToolTrackers(e),i={high:3,medium:2,low:1},o=[...r].sort((s,a)=>{const l=i[a.priority]-i[s.priority];return l!==0?l:new Date(s.timestamp).getTime()-new Date(a.timestamp).getTime()}).findIndex(s=>s.doctorName===t);return o>=0?o+1:0}getTrackingStats(){const e=this.priorityQueue.length,t=this.priorityQueue.filter(o=>o.priority==="high").length,r=this.priorityQueue.filter(o=>o.priority==="medium").length,i=this.priorityQueue.filter(o=>o.priority==="low").length,n=this.notifications.filter(o=>o.status==="pending").length;return{totalTracked:e,highPriority:t,mediumPriority:r,lowPriority:i,pendingNotifications:n}}handleToolStatusChange(e){const t=this.getToolTrackers(e.toolId);t.length!==0&&(console.log("🔄 Tool status changed:",{toolId:e.toolId,toolName:e.toolName,oldStatus:e.oldStatus,newStatus:e.newStatus,trackers:t.length}),e.newStatus==="available"&&e.oldStatus!=="available"?this.handleToolBecameAvailable(e.toolId):e.newStatus==="unavailable"&&e.oldStatus==="available"?this.handleToolBecameUnavailable(e.toolId,e.toolName):e.newStatus==="in_use"&&e.oldStatus==="available"&&this.handleToolWasCheckedOut(e.toolId,e.toolName),$n.recordToolAvailable(e.toolId,e.toolName,"Test Doctor","medium",void 0))}handleToolBecameUnavailable(e,t){const r=this.getToolTrackers(e);r.forEach(i=>{ri.notifyToolUnavailable(e,t,void 0,r.length)})}handleToolWasCheckedOut(e,t){const r=this.getToolTrackers(e);r.forEach(i=>{ri.notifyToolUnavailable(e,t,void 0,r.length)})}}const Kv=new fy;var my=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Qv={analyzeScan(c){return my(this,null,function*(){const{barcode:e,mode:t,userId:r,facilityId:i}=c;if(!e)return{recommendation:"Invalid barcode",confidence:1};try{yield d.from("ai_scan_audit").insert([{barcode:e,mode:t,user_id:r||null,facility_id:i||null,event_context:c}])}catch(n){}return{recommendation:t==="add"?"Confirm inventory addition and set expiry date.":t==="use"?"Deduct from stock and log usage.":"Flag anomalies for review.",confidence:.85}})}};class ot extends Error{constructor(e,t,r,i){super(e),this.code=t,this.statusCode=r,this.details=i,this.name="EnvironmentalCleanServiceError"}}const St={NETWORK_ERROR:"Unable to connect to the server. Please check your internet connection.",TIMEOUT_ERROR:"The request took too long to complete. Please try again.",UNAUTHORIZED:"You don't have permission to perform this action. Please contact your administrator.",NOT_FOUND:"The requested resource was not found.",VALIDATION_ERROR:"The provided data is invalid. Please check your input and try again.",SERVER_ERROR:"A server error occurred. Please try again later.",UNKNOWN_ERROR:"An unexpected error occurred. Please try again."},mt=(c,e)=>{if(c instanceof ot)return c;const t=c instanceof Error?c.message:String(c);return t.includes("fetch")||t.includes("network")||t.includes("ENOTFOUND")?new ot(St.NETWORK_ERROR,"NETWORK_ERROR",void 0,{originalError:t,context:e}):t.includes("timeout")||t.includes("ETIMEDOUT")?new ot(St.TIMEOUT_ERROR,"TIMEOUT_ERROR",void 0,{originalError:t,context:e}):t.includes("401")||t.includes("unauthorized")?new ot(St.UNAUTHORIZED,"UNAUTHORIZED",401,{originalError:t,context:e}):t.includes("404")||t.includes("not found")?new ot(St.NOT_FOUND,"NOT_FOUND",404,{originalError:t,context:e}):t.includes("422")||t.includes("validation")?new ot(St.VALIDATION_ERROR,"VALIDATION_ERROR",422,{originalError:t,context:e}):t.includes("500")||t.includes("server error")?new ot(St.SERVER_ERROR,"SERVER_ERROR",500,{originalError:t,context:e}):new ot(St.UNKNOWN_ERROR,"UNKNOWN_ERROR",void 0,{originalError:t,context:e})},zn=c=>({pending:"Dirty",in_progress:"In Progress",completed:"Clean",verified:"Clean",clean:"Clean",failed:"Supervisor",cancelled:"Out of Service",dirty:"Dirty"})[c]||"Dirty",_s=c=>({Dirty:"dirty","In Progress":"in_progress",Clean:"clean","Out of Service":"cancelled",Supervisor:"pending",Isolation:"failed",Quarantine:"failed",Maintenance:"pending","Equipment Failure":"failed","Patient Occupied":"pending","Discharge Cleaning":"pending",Unassigned:"pending","Audit Required":"pending"})[c]||"dirty";var Et=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const xt=()=>Et(null,null,function*(){return yield Ot.getCurrentFacilityId()});class Bt{static fetchRooms(){return Et(this,null,function*(){try{const e=yield xt(),t=d.from("environmental_cleans_enhanced").select(`
          id,
          room_id,
          room_name,
          status,
          cleaning_type,
          scheduled_time,
          completed_time,
          quality_score,
          compliance_score,
          created_at,
          updated_at
        `).eq("facility_id",e),{data:r,error:i}=yield t.order("scheduled_time",{ascending:!1});if(i)throw i;return(r!=null?r:[]).map(o=>{var s,a,l,u,h;const f=zn(o.status);return{id:o.room_id||o.id,name:o.room_name||`Room ${o.room_id||o.id}`,status:f,metadata:{cleaningType:(s=o.cleaning_type)!=null?s:"",qualityScore:(a=o.quality_score)!=null?a:0,complianceScore:(l=o.compliance_score)!=null?l:0,scheduledTime:(u=o.scheduled_time)!=null?u:"",completedTime:(h=o.completed_time)!=null?h:void 0},createdAt:o.created_at,updatedAt:o.updated_at}})}catch(e){return console.warn("Environmental Clean rooms fetch failed, falling back to static data:",e),[{id:"room-1",name:"Operating Room 1",status:"pending",metadata:{cleaningType:"surgical",qualityScore:95,complianceScore:98,scheduledTime:new Date().toISOString(),completedTime:void 0},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"room-2",name:"Recovery Room A",status:"in_progress",metadata:{cleaningType:"standard",qualityScore:87,complianceScore:92,scheduledTime:new Date().toISOString(),completedTime:void 0},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"room-3",name:"ICU Room 3",status:"completed",metadata:{cleaningType:"intensive",qualityScore:99,complianceScore:100,scheduledTime:new Date().toISOString(),completedTime:new Date().toISOString()},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}]}})}static updateRoomStatus(e,t){return Et(this,null,function*(){try{const r=yield xt(),i=d.from("environmental_cleans_enhanced").update({status:_s(t),updated_at:new Date().toISOString()}).eq("room_id",e).eq("facility_id",r),{error:n}=yield i;if(n)throw n;Tt.log("environmental_clean","room_status_updated",{roomId:e,status:t,timestamp:new Date().toISOString()})}catch(r){const i=mt(r,"updateRoomStatus");throw console.error("❌ Failed to update room status:",i),i}})}static createEnvironmentalClean(e){return Et(this,null,function*(){var t,r,i,n;try{const o=yield xt(),s={room_id:(t=e.id)!=null?t:"",room_name:(r=e.name)!=null?r:"",status:"pending",cleaning_type:"routine",scheduled_time:new Date().toISOString(),checklist_items:[],completed_items:[],failed_items:[],facility_id:o},{data:a,error:l}=yield d.from("environmental_cleans_enhanced").insert(s).select().single();if(l||!a)throw l!=null?l:new Error("Insert failed");const u={id:a.room_id,name:a.room_name||`Room ${a.room_id}`,status:zn(a.status),metadata:{cleaningType:(i=a.cleaning_type)!=null?i:"",scheduledTime:(n=a.scheduled_time)!=null?n:""},createdAt:a.created_at,updatedAt:a.updated_at};return Tt.log("environmental_clean","room_created",{roomId:u.id,roomName:u.name}),u}catch(o){const s=mt(o,"createEnvironmentalClean");throw console.error("❌ Failed to create environmental clean:",s),s}})}static updateEnvironmentalClean(e,t){return Et(this,null,function*(){var r,i,n,o,s;try{const a=yield xt(),l={updated_at:new Date().toISOString()};t.name&&(l.room_name=t.name),t.status&&(l.status=_s(t.status));const u=d.from("environmental_cleans_enhanced").update(l).eq("room_id",e).eq("facility_id",a),{data:h,error:f}=yield u.select().single();if(f||!h)throw f!=null?f:new Error("Update failed");const m={id:h.room_id,name:h.room_name||`Room ${h.room_id}`,status:zn(h.status),metadata:{cleaningType:(r=h.cleaning_type)!=null?r:"",qualityScore:(i=h.quality_score)!=null?i:0,complianceScore:(n=h.compliance_score)!=null?n:0,scheduledTime:(o=h.scheduled_time)!=null?o:"",completedTime:(s=h.completed_time)!=null?s:void 0},createdAt:h.created_at,updatedAt:h.updated_at};return Tt.log("environmental_clean","room_updated",{roomId:m.id,roomName:m.name}),m}catch(a){const l=mt(a,"updateEnvironmentalClean");throw console.error("❌ Failed to update environmental clean:",l),l}})}static deleteEnvironmentalClean(e){return Et(this,null,function*(){try{const t=yield xt(),r=d.from("environmental_cleans_enhanced").delete().eq("room_id",e).eq("facility_id",t),{error:i}=yield r;if(i)throw i;Tt.log("environmental_clean","room_deleted",{roomId:e})}catch(t){const r=mt(t,"deleteEnvironmentalClean");throw console.error("❌ Failed to delete environmental clean:",r),r}})}static completeRoomCleaning(e){return Et(this,null,function*(){try{if(!e)throw new Error("Room ID is required");const t=yield xt(),r=d.from("environmental_cleans_enhanced").update({status:"completed",completed_time:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("room_id",e).eq("facility_id",t),{error:i}=yield r;if(i)throw i;Tt.log("environmental_clean","room_cleaning_completed",{roomId:e,timestamp:new Date().toISOString()})}catch(t){const r=mt(t,"completeRoomCleaning");throw console.error("❌ Error completing room cleaning:",r),r}})}}var $i=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Mi{static fetchAnalytics(){return $i(this,null,function*(){try{console.log("📊 Fetching analytics from Supabase...");const{data:e,error:t}=yield d.from("environmental_cleans_enhanced").select("status, completed_time, scheduled_time, created_at");if(t)throw t;const r=e||[],i=r.length,n=r.filter(_=>_.status==="clean"||_.status==="completed"||_.status==="verified").length,o=r.filter(_=>_.status==="dirty"||_.status==="pending").length,s=r.filter(_=>_.status==="in_progress").length,a=r.filter(_=>_.status==="biohazard").length,l=r.filter(_=>_.status==="theft").length,u=r.filter(_=>_.status==="low_inventory").length,h=r.filter(_=>_.status==="out_of_service").length,f=r.filter(_=>_.status==="public_areas").length,m=i>0?Math.round(n/i*100):0,p=r.filter(_=>_.completed_time&&_.scheduled_time);let g=0;if(p.length>0){const _=p.reduce((w,b)=>{const E=new Date(b.scheduled_time).getTime(),C=new Date(b.completed_time).getTime();return w+(C-E)},0);g=Math.round(_/p.length/(1e3*60))}const y={totalRooms:i,cleanRooms:n,dirtyRooms:o,inProgressRooms:s,biohazardRooms:a,theftRooms:l,lowInventoryRooms:u,outOfServiceRooms:h,publicAreas:f,cleaningEfficiency:m,averageCleaningTime:g,lastUpdated:new Date().toISOString()};return console.log("✅ Analytics fetched successfully:",y),y}catch(e){throw console.error("❌ Error fetching analytics:",e),e}})}static getRoomCountsByStatus(){return $i(this,null,function*(){try{console.log("📊 Fetching room counts from Supabase...");const{data:e,error:t}=yield d.from("environmental_cleans_enhanced").select("status");if(t)throw t;const r=e||[],i={completed:r.filter(n=>n.status==="clean"||n.status==="completed").length,pending:r.filter(n=>n.status==="dirty"||n.status==="pending").length,in_progress:r.filter(n=>n.status==="in_progress").length,failed:r.filter(n=>n.status==="failed").length,cancelled:r.filter(n=>n.status==="cancelled").length,verified:r.filter(n=>n.status==="verified").length};return console.log("✅ Room counts fetched successfully:",i),i}catch(e){throw console.error("❌ Error getting room counts by status:",e),e}})}static getRecentlyCompletedCleanings(e=10){return $i(this,null,function*(){try{const{data:t,error:r}=yield d.from("environmental_cleans_enhanced").select("room_name, completed_time, cleaner_id").eq("status","clean").not("completed_time","is",null).order("completed_time",{ascending:!1}).limit(e);if(r)throw r;return(t||[]).map(o=>({room:o.room_name||"Unknown Room",cleanedAt:o.completed_time,cleanedBy:o.cleaner_id?`Cleaner ${o.cleaner_id}`:"System"}))}catch(t){throw console.error("❌ Error getting recently completed cleanings:",t),t}})}static getCleaningEfficiencyTrends(e=7){return $i(this,null,function*(){try{const t=new Date;t.setDate(t.getDate()-e);const{data:r,error:i}=yield d.from("environmental_cleans_enhanced").select("status, completed_time, scheduled_time, created_at").gte("created_at",t.toISOString()).order("created_at",{ascending:!1});if(i)throw i;const n=r||[],o={};return n.forEach(s=>{const a=new Date(s.created_at).toISOString().split("T")[0];o[a]||(o[a]={completed:0,total:0,efficiency:0}),o[a].total++,(s.status==="completed"||s.status==="verified")&&o[a].completed++}),Object.keys(o).forEach(s=>{const a=o[s];a.efficiency=a.total>0?Math.round(a.completed/a.total*100):0}),o}catch(t){throw console.error("❌ Error getting cleaning efficiency trends:",t),t}})}}var py=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class gy{static fetchChecklists(){return py(this,null,function*(){try{console.log("🔍 Fetching environmental cleaning checklists...");const{data:e,error:t}=yield d.from("environmental_cleaning_task_categories").select("*").eq("is_active",!0).order("sort_order",{ascending:!0});if(t)throw console.error("❌ Supabase error:",t),t;return console.log("✅ Checklists fetched successfully:",(e==null?void 0:e.length)||0,"records"),(e||[]).map(r=>{var i,n,o,s;return{id:r.id,name:r.name,description:(i=r.data)==null?void 0:i.description,items:[],isActive:!!((n=r.is_active)==null||n),createdAt:String((o=r.created_at)!=null?o:new Date().toISOString()),updatedAt:String((s=r.updated_at)!=null?s:new Date().toISOString())}})}catch(e){throw console.error("❌ Error fetching checklists:",e),mt(e,"fetchChecklists")}})}}var vs=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class ws{static fetchRecentlyCleanedRooms(e=10){return vs(this,null,function*(){try{const{data:t,error:r}=yield d.from("environmental_cleans_enhanced").select(`
          room_name,
          completed_time,
          cleaner_id
        `).eq("status","clean").not("completed_time","is",null).order("completed_time",{ascending:!1}).limit(e);if(r)throw console.error("❌ Supabase error:",r),r;return(t||[]).map(n=>({room:n.room_name||"Unknown Room",cleanedAt:n.completed_time,cleanedBy:n.cleaner_id?`Cleaner ${n.cleaner_id}`:"System"}))}catch(t){console.error("❌ Raw error in fetchRecentlyCleanedRooms:",t);const r=mt(t,"fetchRecentlyCleanedRooms");throw console.error("❌ Failed to fetch recently cleaned rooms:",r),r}})}static scanRoomBarcode(e){return vs(this,null,function*(){try{if(!e||e.trim()==="")return{success:!1,message:"Please enter a valid barcode"};const{useRoomStore:t}=yield T(()=>import("./components-BtXJbSH9.js").then(n=>n.ax),__vite__mapDeps([0,1,2,3,4,5,6,7])),i=t.getState().getRoomByBarcode(e.trim());return i?(Tt.log("environmental_clean","room_scan",{barcode:e,roomId:i.id,roomName:i.name}),{success:!0,room:{id:i.barcode||i.id,name:i.name,status:"dirty"},message:`Successfully scanned room: ${i.name}`}):{success:!1,message:`Room with barcode "${e}" not found. Please check the barcode or add the room in Settings.`}}catch(t){return console.error("❌ Error scanning room barcode:",t),{success:!1,message:"An error occurred while scanning the barcode. Please try again."}}})}}var yy=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class _y{static batchEnvironmentalCleanAction(e){return yy(this,arguments,function*({ids:t,action:r}){try{const i={updated_at:new Date().toISOString()};switch(r){case"mark_completed":i.status="completed",i.completed_time=new Date().toISOString();break;case"mark_in_progress":i.status="in_progress",i.started_time=new Date().toISOString();break;case"mark_verified":i.status="verified",i.verified_time=new Date().toISOString();break;default:throw new Error(`Unknown action: ${r}`)}const{error:n}=yield d.from("environmental_cleans_enhanced").update(i).in("room_id",t);if(n)throw n;return Tt.log("environmental_clean","batch_action",{action:r,roomIds:t,count:t.length}),{success:!0}}catch(i){const n=mt(i,"batchEnvironmentalCleanAction");throw console.error("❌ Failed to perform batch action:",n),n}})}}var vy=Object.defineProperty,wy=Object.defineProperties,Iy=Object.getOwnPropertyDescriptors,Is=Object.getOwnPropertySymbols,Sy=Object.prototype.hasOwnProperty,by=Object.prototype.propertyIsEnumerable,Ss=(c,e,t)=>e in c?vy(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ey=(c,e)=>{for(var t in e||(e={}))Sy.call(e,t)&&Ss(c,t,e[t]);if(Is)for(var t of Is(e))by.call(e,t)&&Ss(c,t,e[t]);return c},Ay=(c,e)=>wy(c,Iy(e));class cr{constructor(){this.usageData=new Map,this.STORAGE_KEY="inventory_usage_data",this.loadUsageData()}static getInstance(){return cr.instance||(cr.instance=new cr),cr.instance}loadUsageData(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e),r=Object.fromEntries(Object.entries(t).map(([i,n])=>{const o=n;return[i,Ay(Ey({},o),{lastUsed:new Date(o.lastUsed)})]}));this.usageData=new Map(Object.entries(r))}}catch(e){console.error(e),console.warn("Failed to load usage data:")}}saveUsageData(){try{const e=Object.fromEntries(this.usageData);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error(e),console.warn("Failed to save usage data:")}}getOrCreateUsageData(e){const t=this.usageData.get(e);if(!t){const r={itemId:e,usageCount:0,lastUsed:new Date,searchCount:0,favoriteCount:0,trackCount:0};return this.usageData.set(e,r),r}return t}trackItemView(e){const t=this.getOrCreateUsageData(e);t.usageCount+=1,t.lastUsed=new Date,this.saveUsageData()}trackItemSearch(e){const t=this.getOrCreateUsageData(e);t.searchCount+=1,t.lastUsed=new Date,this.saveUsageData()}trackItemFavorite(e){const t=this.getOrCreateUsageData(e);t.favoriteCount+=1,t.lastUsed=new Date,this.saveUsageData()}trackItemTrack(e){const t=this.getOrCreateUsageData(e);t.trackCount+=1,t.lastUsed=new Date,this.saveUsageData()}calculateSmartScore(e){const t=this.usageData.get(e);if(!t)return 0;const r=new Date;let i;try{i=t.lastUsed instanceof Date?t.lastUsed:new Date(t.lastUsed),isNaN(i.getTime())&&(i=new Date)}catch(s){console.error(s),i=new Date}const n=(r.getTime()-i.getTime())/(1e3*60*60*24);let o=t.usageCount*10;return n<=7&&(o+=50),o+=t.searchCount*5,o+=t.favoriteCount*20,o+=t.trackCount*15,n>30&&(o*=.8),Math.round(o)}getSmartRanking(e){return[...e].sort((t,r)=>{var i,n,o,s,a,l,u,h;const f=t.toolId||t.supplyId||t.equipmentId||t.hardwareId||((i=t.data)==null?void 0:i.toolId)||((n=t.data)==null?void 0:n.supplyId)||((o=t.data)==null?void 0:o.equipmentId)||((s=t.data)==null?void 0:s.hardwareId)||"",m=r.toolId||r.supplyId||r.equipmentId||r.hardwareId||((a=r.data)==null?void 0:a.toolId)||((l=r.data)==null?void 0:l.supplyId)||((u=r.data)==null?void 0:u.equipmentId)||((h=r.data)==null?void 0:h.hardwareId)||"",p=this.calculateSmartScore(f);return this.calculateSmartScore(m)-p})}getUsageStats(){return Object.fromEntries(this.usageData)}clearUsageData(){this.usageData.clear(),localStorage.removeItem(this.STORAGE_KEY)}}cr.getInstance();var oe=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Ty{static addAuditLog(e,t,r){return oe(this,null,function*(){try{yield d.from("environmental_clean_audit").insert({action:e,room_id:t,user_id:r,timestamp:new Date().toISOString()})}catch(i){console.error("Audit log failed:",i)}})}static fetchRooms(){return oe(this,null,function*(){return Bt.fetchRooms()})}static fetchChecklists(){return oe(this,null,function*(){return gy.fetchChecklists()})}static updateRoomStatus(e,t){return oe(this,null,function*(){return Bt.updateRoomStatus(e,t)})}static completeRoomCleaning(e){return oe(this,null,function*(){return Bt.completeRoomCleaning(e)})}static fetchAnalytics(){return oe(this,null,function*(){return Mi.fetchAnalytics()})}static getRoomCountsByStatus(){return oe(this,null,function*(){return Mi.getRoomCountsByStatus()})}static getRecentlyCompletedCleanings(e=10){return oe(this,null,function*(){return Mi.getRecentlyCompletedCleanings(e)})}static getCleaningEfficiencyTrends(e=7){return oe(this,null,function*(){return Mi.getCleaningEfficiencyTrends(e)})}static fetchRecentlyCleanedRooms(e=10){return oe(this,null,function*(){return ws.fetchRecentlyCleanedRooms(e)})}static scanRoomBarcode(e){return oe(this,null,function*(){return ws.scanRoomBarcode(e)})}static createEnvironmentalClean(e){return oe(this,null,function*(){return Bt.createEnvironmentalClean(e)})}static updateEnvironmentalClean(e,t){return oe(this,null,function*(){return Bt.updateEnvironmentalClean(e,t)})}static deleteEnvironmentalClean(e){return oe(this,null,function*(){return Bt.deleteEnvironmentalClean(e)})}static batchEnvironmentalCleanAction(e){return oe(this,arguments,function*({ids:t,action:r}){return _y.batchEnvironmentalCleanAction({ids:t,action:r})})}}Ty.supabase=d;var bs=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Yv={startSession(c){return bs(this,arguments,function*({module:e,metadata:t={}}){const{data:{user:r},error:i}=yield d.auth.getUser();if(i||!r)return console.error("WorkflowService.startSession: No authenticated user found."),null;const{data:n,error:o}=yield d.from("workflow_sessions").insert([{operator_id:r.id,module:e,status:"active",metadata:t}]).select().single();return o?(console.error("WorkflowService.startSession failed:",o.message),null):n})},endSession(c){return bs(this,null,function*(){if(!c){console.warn("WorkflowService.endSession called with no sessionId.");return}const{error:e}=yield d.from("workflow_sessions").update({status:"completed",ended_at:new Date().toISOString()}).eq("id",c);e?console.error("WorkflowService.endSession failed:",e.message):console.info(`Workflow session ${c} successfully closed.`)})}};var ky=Object.defineProperty,Py=Object.defineProperties,Cy=Object.getOwnPropertyDescriptors,Es=Object.getOwnPropertySymbols,Dy=Object.prototype.hasOwnProperty,Oy=Object.prototype.propertyIsEnumerable,As=(c,e,t)=>e in c?ky(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ry=(c,e)=>{for(var t in e||(e={}))Dy.call(e,t)&&As(c,t,e[t]);if(Es)for(var t of Es(e))Oy.call(e,t)&&As(c,t,e[t]);return c},$y=(c,e)=>Py(c,Cy(e));class Wr{constructor(){this.progressItems=new Map;try{this.loadFromStorage()}catch(e){console.error("[LearningProgressService] Failed to initialize:",e)}}static getInstance(){try{return Wr.instance||(Wr.instance=new Wr),Wr.instance}catch(e){return console.error("[LearningProgressService] Failed to get instance:",e),null}}loadFromStorage(){try{if(typeof window=="undefined"||!window.localStorage){console.warn("[LearningProgressService] localStorage not available");return}const e=localStorage.getItem("learningProgress");if(e){const t=JSON.parse(e);this.progressItems.clear(),t.forEach(r=>{this.progressItems.set(r.id,r)})}}catch(e){console.error("[LearningProgressService] Failed to load from storage:",e)}}saveToStorage(){try{if(typeof window=="undefined"||!window.localStorage){console.warn("[LearningProgressService] localStorage not available for saving");return}const e=Array.from(this.progressItems.values());localStorage.setItem("learningProgress",JSON.stringify(e))}catch(e){console.error("[LearningProgressService] Failed to save to storage:",e)}}addToMyList(e){const t=$y(Ry({},e),{status:"In Progress",updated_at:new Date().toISOString()});this.progressItems.set(e.id,t),this.saveToStorage()}markInProgress(e){const t=this.progressItems.get(e);t&&(t.status="In Progress",t.updated_at=new Date().toISOString(),this.saveToStorage())}getItemStatus(e){const t=this.progressItems.get(e);return t?t.status:"Not Started"}updateItemStatus(e,t){const r=this.progressItems.get(e);r&&(r.status=t,r.updated_at=new Date().toISOString(),this.saveToStorage())}getItemsByCategory(e){return Array.from(this.progressItems.values()).filter(t=>t.category===e)}getAllProgressItems(){return Array.from(this.progressItems.values())}removeItem(e){this.progressItems.delete(e),this.saveToStorage()}isInitialized(){return this.progressItems!==void 0}}class Jv{static scanTool(e,t){const r=t.map(o=>o.barcode),i=r[Math.floor(Math.random()*r.length)],n=t.find(o=>o.barcode===i);return n?{success:!0,message:`Successfully processed ${n.name} for ${e} workflow`,tool:n}:{success:!1,message:"No tools available for scanning"}}}var My=Object.defineProperty,qy=Object.defineProperties,zy=Object.getOwnPropertyDescriptors,Ts=Object.getOwnPropertySymbols,Uy=Object.prototype.hasOwnProperty,Ny=Object.prototype.propertyIsEnumerable,ks=(c,e,t)=>e in c?My(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ps=(c,e)=>{for(var t in e||(e={}))Uy.call(e,t)&&ks(c,t,e[t]);if(Ts)for(var t of Ts(e))Ny.call(e,t)&&ks(c,t,e[t]);return c},Fy=(c,e)=>qy(c,zy(e)),Ke=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Vr=()=>Ke(null,null,function*(){return yield Ot.getCurrentFacilityId()});class Xv{static compressImage(e,t=1200,r=.8){return Ke(this,null,function*(){return new Promise((i,n)=>{const o=document.createElement("canvas"),s=o.getContext("2d"),a=new Image;a.onload=()=>{const l=Math.min(t/a.width,t/a.height),u=a.width*l,h=a.height*l;o.width=u,o.height=h,s==null||s.drawImage(a,0,0,u,h),o.toBlob(f=>{if(f){const m=new File([f],e.name,{type:"image/jpeg",lastModified:Date.now()});i(m)}else n(new Error("Failed to compress image"))},"image/jpeg",r)},a.onerror=()=>n(new Error("Failed to load image")),a.src=URL.createObjectURL(e)})})}static uploadReceipt(e,t,r){return Ke(this,null,function*(){try{const i=r||(yield Vr()),n=dt(i),{data:{user:o},error:s}=yield n.auth.getUser();if(s||!o)throw new Error("User not authenticated. Please log in again.");const{data:a,error:l}=yield n.from("users").select("facility_id").eq("id",o.id).single();if(l||!(a!=null&&a.facility_id))throw new Error("User facility not found");if(a.facility_id!==i)throw new Error("Unauthorized: tenant mismatch");const u=yield this.compressImage(e.photoFile),h=new Date().toISOString().replace(/[:.]/g,"-"),f=`${o.id}/autoclave-receipt-${e.batchCode}-${h}.jpg`,{error:m}=yield n.storage.from("autoclave-receipts").upload(f,u,{cacheControl:"3600",upsert:!1});if(m)throw new Error(`Failed to upload file: ${m.message}`);const{data:p,error:g}=yield n.storage.from("autoclave-receipts").createSignedUrl(f,3600);if(g)throw g;console.info(`[AutoclaveReceipt] Signed URL created for tenant ${i} → ${f}`);const{data:y,error:_}=yield n.from("autoclave_receipts").insert({receipt_number:e.batchCode,autoclave_id:null,facility_id:a.facility_id,tenant_id:i,photo_url:p.signedUrl,created_at:new Date().toISOString()}).select().single();if(_)throw yield n.storage.from("autoclave-receipts").remove([f]),new Error(`Failed to save receipt metadata: ${_.message}`);return this.mapDatabaseReceipt(y)}catch(i){throw console.error("Error uploading autoclave receipt:",i),i}})}static getReceiptsByBatch(e,t){return Ke(this,null,function*(){try{const r=t||(yield Vr()),i=dt(r),{data:{user:n},error:o}=yield i.auth.getUser();if(o||!n)throw new Error("User not authenticated. Please log in again.");const{data:s,error:a}=yield i.from("users").select("facility_id").eq("id",n.id).single();if(a||!(s!=null&&s.facility_id))throw new Error("User facility not found");if(s.facility_id!==r)throw new Error("Unauthorized: tenant mismatch");const u=i.from("autoclave_receipts").select("*").eq("receipt_number",e).eq("tenant_id",r),{data:h,error:f}=yield u.order("created_at",{ascending:!1});if(f)throw new Error(`Failed to fetch receipts: ${f.message}`);return h.map(this.mapDatabaseReceipt)}catch(r){throw console.error("Error fetching receipts:",r),r}})}static getAllReceipts(e=50,t=0,r){return Ke(this,null,function*(){try{const i=r||(yield Vr()),n=dt(i),{data:{user:o},error:s}=yield n.auth.getUser();if(s||!o)throw new Error("User not authenticated. Please log in again.");const{data:a,error:l}=yield n.from("users").select("facility_id").eq("id",o.id).single();if(l||!(a!=null&&a.facility_id))throw new Error("User facility not found");if(a.facility_id!==i)throw new Error("Unauthorized: tenant mismatch");const h=n.from("autoclave_receipts").select("*").eq("tenant_id",i),{data:f,error:m}=yield h.order("created_at",{ascending:!1}).range(t,t+e-1);if(m)throw new Error(`Failed to fetch receipts: ${m.message}`);return f.map(this.mapDatabaseReceipt)}catch(i){throw console.error("Error fetching all receipts:",i),i}})}static deleteReceipt(e,t){return Ke(this,null,function*(){try{const r=t||(yield Vr()),i=dt(r),{data:{user:n},error:o}=yield i.auth.getUser();if(o||!n)throw new Error("User not authenticated. Please log in again.");const{data:s,error:a}=yield i.from("users").select("facility_id").eq("id",n.id).single();if(a||!(s!=null&&s.facility_id))throw new Error("User facility not found");if(s.facility_id!==r)throw new Error("Unauthorized: tenant mismatch");const u=i.from("autoclave_receipts").select("id").eq("id",e).eq("tenant_id",r),{data:h,error:f}=yield u.single();if(f)throw new Error(`Failed to fetch receipt: ${f.message}`);const m=i.from("autoclave_receipts").delete().eq("id",e).eq("tenant_id",r),{error:p}=yield m;if(p)throw new Error(`Failed to delete receipt: ${p.message}`)}catch(r){throw console.error("Error deleting receipt:",r),r}})}static getFacilitySettings(){return Ke(this,null,function*(){return{id:"default",facilityId:void 0,autoclaveHasPrinter:!1,receiptRetentionMonths:24,createdAt:new Date,updatedAt:new Date}})}static updateFacilitySettings(e){return Ke(this,null,function*(){const t=yield this.getFacilitySettings();return Fy(Ps(Ps({},t),e),{updatedAt:new Date})})}static cleanupExpiredReceipts(e){return Ke(this,null,function*(){var t;try{const r=e||(yield Vr()),i=dt(r),{data:{user:n},error:o}=yield i.auth.getUser();if(o||!n)throw new Error("User not authenticated. Please log in again.");const{data:s,error:a}=yield i.from("users").select("facility_id").eq("id",n.id).single();if(a||!(s!=null&&s.facility_id))throw new Error("User facility not found");if(s.facility_id!==r)throw new Error("Unauthorized: tenant mismatch");const u=new Date;u.setMonth(u.getMonth()-24);const{data:h,error:f}=yield i.from("autoclave_receipts").select("id, photo_url").lt("created_at",u.toISOString()).eq("tenant_id",r);if(f)throw new Error(`Failed to fetch expired receipts: ${f.message}`);if(!h||h.length===0)return 0;for(const m of h){const p=(t=m.photo_url)==null?void 0:t.split("/").pop();p&&(yield i.storage.from("autoclave-receipts").remove([p])),yield i.from("autoclave_receipts").delete().eq("id",m.id)}return h.length}catch(r){throw console.error("Error cleaning up expired receipts:",r),r}})}static mapDatabaseReceipt(e){return{id:e.id,batchId:"",batchCode:e.receipt_number,cycleNumber:void 0,photoUrl:"",photoFilename:"",photoSize:0,temperatureEvidence:void 0,uploadedBy:"",uploadedAt:new Date(e.created_at),retentionUntil:new Date,isExpired:!1,createdAt:new Date(e.created_at),updatedAt:new Date(e.created_at)}}static mapDatabaseFacilitySettings(e){return{id:e.id,facilityId:e.facility_id,autoclaveHasPrinter:e.autoclave_has_printer,receiptRetentionMonths:e.receipt_retention_months,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}}}var qi=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const R=c=>typeof c=="string"?c:"",zi=c=>typeof c=="number"?c:0,Cs=c=>typeof c=="boolean"?c:!1,jt=c=>{if(typeof c=="string"){const e=new Date(c);return isNaN(e.getTime())?void 0:e}},Ds=c=>{switch(c){case"active":return"available";case"dirty":return"maintenance";case"clean":return"available";case"problem":return"problem";case"new_barcode":return"available";default:return"available"}};function Ly(c){const e=Date.now().toString(36).toUpperCase(),t=Math.random().toString(36).substr(2,4).toUpperCase();return`PKG-${c.slice(0,4).toUpperCase()}-${e}-${t}`}class Zv{static getToolsReadyForPackaging(){return qi(this,null,function*(){let t=null;for(let r=1;r<=3;r++)try{if(!oa.getState().authToken){if(r<3){yield new Promise(f=>setTimeout(f,r*500));continue}throw new Error("User not authenticated")}const{data:{user:n},error:o}=yield d.auth.getUser();if(o||!n)throw new Error("User not authenticated");const{data:s,error:a}=yield d.from("users").select("facility_id").eq("id",n.id).single();if(a||!s)throw new Error("User facility not found");const{data:l,error:u}=yield d.from("tools").select("*").eq("facility_id",s.facility_id).eq("status","active");if(u)throw new Error(`Failed to fetch tools: ${u.message}`);return(l||[]).map(f=>{const m=f;return{id:R(m.tool_id),name:R(m.tool_name),barcode:R(m.barcode),type:R(m.tool_type),category:R(m.category)||"general",currentPhase:R(m.current_phase),status:Ds(R(m.current_phase)),lastSterilized:R(m.last_sterilized)||void 0,cycleCount:zi(m.cycle_count),maxCycles:zi(m.max_cycles)||void 0,location:R(m.location)||void 0,notes:R(m.notes)||void 0}})}catch(i){if(t=i instanceof Error?i:new Error("Unknown error"),r===3)throw console.error(`Error fetching tools ready for packaging (attempt ${r}/3):`,i),t;yield new Promise(n=>setTimeout(n,r*500))}throw t||new Error("Failed to fetch tools after all retries")})}static createPackage(e,t,r){return qi(this,null,function*(){try{if(!oa.getState().authToken)throw new Error("User not authenticated");const{FacilityService:n}=yield T(()=>Promise.resolve().then(()=>ye),void 0),o=yield n.getCurrentFacilityId(),{data:{user:s},error:a}=yield d.auth.getUser();if(a||!s)throw new Error("User not authenticated");const l=s.id,u=Ly(o),{data:h,error:f}=yield d.from("sterilization_batches").insert({id:crypto.randomUUID(),cycle_id:crypto.randomUUID(),facility_id:o,batch_name:`Package ${u}`,batch_type:"routine",status:"packaged",package_id:u,package_type:t.packageType,package_size:t.packageSize,chemical_indicator_added:!0,packaged_by:l,packaged_at:new Date().toISOString(),requested_by:l,total_items:e.length,notes:t.notes}).select().single();if(f)throw new Error(`Failed to create package: ${f.message}`);const m=h,p=e.map(E=>({batch_id:m.id,tool_id:E,item_name:"Tool",item_type:"sterilization_tool",quantity:1,package_type:t.packageType,package_configuration:{package_size:t.packageSize,notes:t.notes}})),g=e.map(E=>pe.updateToolStatus(E,"active"));yield Promise.all(g),yield pe.touchTools(e);const _=yield new sc().getCurrentUser(),w=_?{id:_.facility_id}:null;yield d.from("audit_logs").insert({created_by:(_==null?void 0:_.id)||"unknown",facility_id:(w==null?void 0:w.id)||"unknown",module:"sterilization",action:"package_created",table_name:"sterilization_batches",record_id:m.id,old_values:{},new_values:{package_id:u,package_type:t.packageType,total_items:e.length,status:"packaged"},metadata:{package_id:u,tool_count:e.length,operator_name:r,package_info:t}});const b={id:R(m.id),packageId:R(m.package_id),batchName:R(m.batch_name),batchType:R(m.batch_type),status:R(m.status),packageType:R(m.package_type),packageSize:R(m.package_size),chemicalIndicatorAdded:Cs(m.chemical_indicator_added),packagedBy:R(m.packaged_by),packagedAt:jt(m.packaged_at)||new Date,totalItems:zi(m.total_items),createdAt:jt(m.created_at)||new Date,updatedAt:jt(m.updated_at)||new Date};return{success:!0,message:`Package ${u} created successfully with ${e.length} tools`,batch:b,packageId:R(u)}}catch(i){return console.error("Error creating package:",i),{success:!1,message:i instanceof Error?i.message:"Failed to create package"}}})}static getPackageById(e){return qi(this,null,function*(){try{const{data:t,error:r}=yield d.from("sterilization_batches").select("*").eq("package_id",e).single();if(r||!t)return null;const i=t;return{id:R(i.id),packageId:R(i.package_id),batchName:R(i.batch_name),batchType:R(i.batch_type),status:R(i.status),packageType:R(i.package_type),packageSize:R(i.package_size),chemicalIndicatorAdded:Cs(i.chemical_indicator_added),packagedBy:R(i.packaged_by),packagedAt:jt(i.packaged_at)||new Date,totalItems:zi(i.total_items),createdAt:jt(i.created_at)||new Date,updatedAt:jt(i.updated_at)||new Date}}catch(t){return console.error("Error fetching package:",t),null}})}static getToolsInPackage(e){return qi(this,null,function*(){try{const{data:t,error:r}=yield d.from("sterilization_batches").select("id").eq("package_id",e).single();if(r||!t)throw new Error("Package not found");const i=t,{data:n,error:o}=yield d.from("sterilization_cycle_tools").select(`
          tool_id,
          tools (
            id,
            tool_name,
            barcode,
            tool_type,
            status,
            last_sterilized,
            sterilization_count,
            location,
            manufacturer,
            model,
            serial_number,
            maintenance_due_date,
            notes,
            metadata
          )
        `).eq("cycle_id",i.id);if(o)throw new Error(`Failed to fetch package tools: ${o.message}`);return(n||[]).map(s=>{const l=s.tools;if(!l)throw new Error("Tool data not found");return{id:l.id,name:l.tool_name,barcode:l.barcode,type:l.tool_type,category:l.category||"general",currentPhase:l.status,status:Ds(l.status),location:l.location,notes:l.notes||void 0,cycleCount:l.cycle_count||0,lastSterilized:l.last_sterilized}})}catch(t){throw console.error("Error fetching package tools:",t),t}})}}var xy=Object.defineProperty,By=Object.defineProperties,jy=Object.getOwnPropertyDescriptors,Os=Object.getOwnPropertySymbols,Vy=Object.prototype.hasOwnProperty,Hy=Object.prototype.propertyIsEnumerable,Rs=(c,e,t)=>e in c?xy(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Gy=(c,e)=>{for(var t in e||(e={}))Vy.call(e,t)&&Rs(c,t,e[t]);if(Os)for(var t of Os(e))Hy.call(e,t)&&Rs(c,t,e[t]);return c},Wy=(c,e)=>By(c,jy(e)),$s=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class ew{static getFacilitySettings(e){return $s(this,null,function*(){try{const{data:t,error:r}=yield d.from("facility_settings").select("*").eq("facility_id",e).maybeSingle();return r?(console.error("Error fetching facility settings:",r),null):t}catch(t){return console.error("Error fetching facility settings:",t),null}})}static updateFacilitySettings(e,t){return $s(this,null,function*(){try{const r=Wy(Gy({},t),{facility_id:e,updated_at:new Date().toISOString()}),{data:i,error:n}=yield d.from("facility_settings").upsert(r,{onConflict:"facility_id"}).select().single();return n?(console.error("Error updating facility settings:",n),null):i}catch(r){return console.error("Error updating facility settings:",r),null}})}}var st=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Ky{getUsers(e){return st(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("*").eq("facility_id",e).is("deleted_at",null).or("is_active.is.null,is_active.eq.true");if(r)throw console.error("UserRoleService.getUsers error:",r),new Error(r.message);if(console.log("🔍 UserRoleService.getUsers - Raw data:",t),console.log("🔍 UserRoleService.getUsers - First user data:",t==null?void 0:t[0]),t&&t.length>0){const i=t.map(o=>o.id),n=[...new Set(i)];if(console.log("🔍 UserRoleService.getUsers - Total users:",t.length),console.log("🔍 UserRoleService.getUsers - Unique IDs:",n.length),console.log("🔍 UserRoleService.getUsers - All IDs:",i),i.length!==n.length){console.warn("⚠️ DUPLICATE USER IDs DETECTED!");const o=i.filter((s,a)=>i.indexOf(s)!==a);console.warn("⚠️ Duplicate IDs:",[...new Set(o)])}}return t!=null?t:[]})}getRoles(e){return st(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("role").eq("facility_id",e).or("is_active.is.null,is_active.eq.true");if(r)throw new Error(r.message);return[...new Set((t==null?void 0:t.map(n=>n.role))||[])].map((n,o)=>({id:`role-${o}`,facility_id:e,role_name:n,description:`${n} role`,is_default:n==="user",created_at:new Date().toISOString()}))})}getUserRoles(e){return st(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("id, facility_id, role, created_at").eq("facility_id",e).or("is_active.is.null,is_active.eq.true");if(r)throw new Error(r.message);return(t!=null?t:[]).map(i=>({id:i.id,user_id:i.id,facility_id:i.facility_id,role_id:i.role,assigned_at:i.created_at}))})}assignUserRole(e,t,r){return st(this,null,function*(){const{error:i}=yield d.from("users").update({role:r}).eq("id",e).eq("facility_id",t);if(i)throw new Error(i.message)})}softDeleteUser(e,t){return st(this,null,function*(){const{error:r}=yield d.from("users").update({is_active:!1,deleted_at:new Date().toISOString()}).eq("id",e).eq("facility_id",t);if(r)throw new Error(r.message)})}restoreUser(e,t){return st(this,null,function*(){const{error:r}=yield d.from("users").update({is_active:!0,deleted_at:null}).eq("id",e).eq("facility_id",t);if(r)throw new Error(r.message)})}updateUserName(e,t,r){return st(this,null,function*(){const{error:i}=yield d.from("users").update({first_name:t,last_name:r,updated_at:new Date().toISOString()}).eq("id",e);if(i)throw console.error("UserRoleService.updateUserName error:",i),new Error(i.message);console.log(`✅ Updated user ${e} name to: ${t} ${r}`)})}cleanupDuplicateUsers(e){return st(this,null,function*(){const{data:t,error:r}=yield d.from("users").select("*").eq("facility_id",e).is("deleted_at",null).or("is_active.is.null,is_active.eq.true");if(r)throw console.error("UserRoleService.cleanupDuplicateUsers error:",r),new Error(r.message);if(!t||t.length===0)return;const i=t.reduce((o,s)=>(o[s.id]||(o[s.id]=[]),o[s.id].push(s),o),{}),n=Object.entries(i).filter(([o,s])=>s.length>1);if(n.length===0){console.log("✅ No duplicate users found");return}console.log(`🔍 Found ${n.length} duplicate user IDs`);for(const[o,s]of n){s.sort((u,h)=>{const f=new Date(u.created_at||0).getTime();return new Date(h.created_at||0).getTime()-f});const a=s[0],l=s.slice(1);console.log(`🔍 Keeping user ${o} (created: ${a.created_at})`);for(const u of l)yield this.softDeleteUser(u.id,e),console.log(`🗑️ Soft-deleted duplicate user ${u.id}`)}console.log("✅ Duplicate cleanup completed")})}}const tw=new Ky;var ct=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Qy{constructor(){this.TIER_LIMITS={tier1:5,tier2:15,tier3:21,tier4:999999},this.TIER_NAMES={tier1:"0-5 Users",tier2:"6-15 Users",tier3:"16-21 Users",tier4:"21+ Users"}}checkTierLimits(e){return ct(this,null,function*(){try{const{data:t,error:r}=yield d.from("users").select("id").eq("facility_id",e).is("deleted_at",null).or("is_active.is.null,is_active.eq.true");if(r)throw new Error(`Failed to get user count: ${r.message}`);const i=(t==null?void 0:t.length)||0;let n,o;return i>=0&&i<=5?(n="tier1",o=this.TIER_LIMITS.tier1):i>=6&&i<=15?(n="tier2",o=this.TIER_LIMITS.tier2):i>=16&&i<=21?(n="tier3",o=this.TIER_LIMITS.tier3):(n="tier4",o=this.TIER_LIMITS.tier4),{canAdd:i<o,currentCount:i,limit:o,tier:this.TIER_NAMES[n]}}catch(t){throw console.error("Error checking tier limits:",t),t}})}sendInvitation(e,t){return ct(this,null,function*(){try{const r=yield fetch("/api/auth/invite-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,userData:t})});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return yield r.json()}catch(r){throw console.error("Error sending invitation:",r),r}})}createInvitation(e){return ct(this,null,function*(){try{const{data:t,error:r}=yield d.from("user_invitations").insert({email:e.email,facility_id:e.facility_id,invited_by:e.invited_by,role:e.role,permissions:e.permissions,status:"pending",expires_at:new Date(Date.now()+6048e5).toISOString()}).select().single();if(r)throw new Error(`Failed to create invitation: ${r.message}`);return t}catch(t){throw console.error("Error creating invitation:",t),t}})}getInvitations(e){return ct(this,null,function*(){try{const{data:t,error:r}=yield d.from("user_invitations").select("*").eq("facility_id",e).order("created_at",{ascending:!1});if(r)throw new Error(`Failed to get invitations: ${r.message}`);return t||[]}catch(t){throw console.error("Error getting invitations:",t),t}})}updateInvitationStatus(e,t){return ct(this,null,function*(){try{const r={status:t};t==="accepted"&&(r.accepted_at=new Date().toISOString());const{error:i}=yield d.from("user_invitations").update(r).eq("id",e);if(i)throw new Error(`Failed to update invitation: ${i.message}`)}catch(r){throw console.error("Error updating invitation:",r),r}})}cancelInvitation(e){return ct(this,null,function*(){try{const{error:t}=yield d.from("user_invitations").update({status:"cancelled"}).eq("id",e);if(t)throw new Error(`Failed to cancel invitation: ${t.message}`)}catch(t){throw console.error("Error cancelling invitation:",t),t}})}resendInvitation(e){return ct(this,null,function*(){try{const{data:t,error:r}=yield d.from("user_invitations").select("*").eq("id",e).single();if(r)throw new Error(`Failed to get original invitation: ${r.message}`);return yield this.cancelInvitation(e),yield this.createInvitation({email:t.email,facility_id:t.facility_id,invited_by:t.invited_by,role:t.role,permissions:t.permissions})}catch(t){throw console.error("Error resending invitation:",t),t}})}cleanupUserInvitations(e,t){return ct(this,null,function*(){try{const{error:r}=yield d.from("user_invitations").update({status:"cancelled"}).eq("invited_by",e).eq("facility_id",t).eq("status","pending");if(r)throw new Error(`Failed to cleanup invitations: ${r.message}`)}catch(r){throw console.error("Error cleaning up user invitations:",r),r}})}}const rw=new Qy;var Vt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Yy{getRoles(e){return Vt(this,null,function*(){try{const{data:t,error:r}=yield d.from("custom_roles").select("*").eq("facility_id",e).order("is_default",{ascending:!1}).order("created_at",{ascending:!0});if(r)throw new Error(`Failed to get roles: ${r.message}`);return t||[]}catch(t){throw console.error("Error getting roles:",t),t}})}createRole(e){return Vt(this,null,function*(){try{const{data:t,error:r}=yield d.from("custom_roles").insert({name:e.name,description:e.description,permissions:e.permissions,facility_id:e.facility_id,created_by:e.created_by,is_default:!1}).select().single();if(r)throw new Error(`Failed to create role: ${r.message}`);return t}catch(t){throw console.error("Error creating role:",t),t}})}updateRole(e,t){return Vt(this,null,function*(){try{const{data:r,error:i}=yield d.from("custom_roles").update({name:t.name,description:t.description,permissions:t.permissions,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(i)throw new Error(`Failed to update role: ${i.message}`);return r}catch(r){throw console.error("Error updating role:",r),r}})}deleteRole(e){return Vt(this,null,function*(){try{const{data:t,error:r}=yield d.from("custom_roles").select("is_default").eq("id",e).single();if(r)throw new Error(`Failed to check role: ${r.message}`);if(t.is_default)throw new Error("Cannot delete default roles");const{data:i,error:n}=yield d.from("users").select("id").eq("role",e).limit(1);if(n)throw new Error(`Failed to check role usage: ${n.message}`);if(i&&i.length>0)throw new Error("Cannot delete role that is currently assigned to users");const{error:o}=yield d.from("custom_roles").delete().eq("id",e);if(o)throw new Error(`Failed to delete role: ${o.message}`)}catch(t){throw console.error("Error deleting role:",t),t}})}getDefaultRoles(){return[{id:"administrator",name:"👑 Administrator",description:"Full system access",permissions:{view_dashboard:!0,view_analytics:!0,export_data:!0,manage_users:!0,assign_roles:!0,view_user_activity:!0,system_settings:!0,facility_settings:!0,security_settings:!0,create_tasks:!0,edit_tasks:!0,delete_tasks:!0,assign_tasks:!0},facility_id:"",is_default:!0,created_by:"",created_at:"",updated_at:""},{id:"manager",name:"👨‍💼 Manager",description:"Department management",permissions:{view_dashboard:!0,view_analytics:!0,export_data:!0,manage_users:!1,assign_roles:!0,view_user_activity:!0,system_settings:!1,facility_settings:!0,security_settings:!1,create_tasks:!0,edit_tasks:!0,delete_tasks:!0,assign_tasks:!0},facility_id:"",is_default:!0,created_by:"",created_at:"",updated_at:""},{id:"technician",name:"🔧 Technician",description:"Task execution",permissions:{view_dashboard:!0,view_analytics:!1,export_data:!1,manage_users:!1,assign_roles:!1,view_user_activity:!1,system_settings:!1,facility_settings:!1,security_settings:!1,create_tasks:!0,edit_tasks:!0,delete_tasks:!1,assign_tasks:!1},facility_id:"",is_default:!0,created_by:"",created_at:"",updated_at:""},{id:"viewer",name:"👀 Viewer",description:"Read-only access",permissions:{view_dashboard:!0,view_analytics:!0,export_data:!1,manage_users:!1,assign_roles:!1,view_user_activity:!1,system_settings:!1,facility_settings:!1,security_settings:!1,create_tasks:!1,edit_tasks:!1,delete_tasks:!1,assign_tasks:!1},facility_id:"",is_default:!0,created_by:"",created_at:"",updated_at:""},{id:"trainer",name:"📚 Trainer",description:"Content management",permissions:{view_dashboard:!0,view_analytics:!0,export_data:!0,manage_users:!1,assign_roles:!1,view_user_activity:!1,system_settings:!1,facility_settings:!0,security_settings:!1,create_tasks:!0,edit_tasks:!0,delete_tasks:!1,assign_tasks:!0},facility_id:"",is_default:!0,created_by:"",created_at:"",updated_at:""}]}getAllRoles(e){return Vt(this,null,function*(){try{const t=this.getDefaultRoles(),r=yield this.getRoles(e);return[...t,...r]}catch(t){throw console.error("Error getting all roles:",t),t}})}isRoleNameUnique(e,t,r){return Vt(this,null,function*(){try{let i=d.from("custom_roles").select("id").eq("facility_id",e).eq("name",t);r&&(i=i.neq("id",r));const{data:n,error:o}=yield i;if(o)throw new Error(`Failed to check role name: ${o.message}`);return!n||n.length===0}catch(i){throw console.error("Error checking role name uniqueness:",i),i}})}}const iw=new Yy;var ra=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function nw(){return ra(this,null,function*(){const{data:c,error:e}=yield d.from("audit_flags").select("*").eq("resolved",!1).order("created_at",{ascending:!1});if(e)throw e;return c!=null?c:[]})}function aw(c,e,t=!0){return ra(this,null,function*(){let r=d.from("audit_flags").select("*").order("created_at",{ascending:!1});t||(r=r.eq("resolved",!1));const{data:i,error:n}=yield r;if(n)throw n;return i!=null?i:[]})}function ow(){return ra(this,null,function*(){const{data:c,error:e}=yield d.from("activity_feed").select("id, module, activity_type, activity_description, created_at").order("created_at",{ascending:!1}).limit(50);if(e)throw e;return c!=null?c:[]})}class Jy{constructor(e){this.facilityId=e}createDefaultSettings(){return{aiEnabled:!0,computerVision:{toolConditionAssessment:!0,barcodeQualityDetection:!0,toolTypeRecognition:!0,cleaningValidation:!0,damageDetection:!0,wearAnalysis:!0,imageRecognition:!0,qualityAssessment:!0},predictiveAnalytics:{cycleOptimization:!0,failurePrediction:!0,efficiencyOptimization:!0,resourcePlanning:!0,maintenancePrediction:!0,qualityPrediction:!0,demandForecasting:!0,costOptimization:!0,seasonalAnalysis:!0},smartWorkflow:{intelligentWorkflowSelection:!0,automatedProblemDetection:!0,smartPhaseTransitions:!0,batchOptimization:!0,toolGrouping:!0,cycleScheduling:!0,smartCategorization:!0,autoClassification:!0,smartFormFilling:!0},qualityAssurance:{biologicalIndicatorAnalysis:!0,complianceMonitoring:!0,auditTrailEnhancement:!0,riskAssessment:!0,qualityMetrics:!0,regulatoryCompliance:!0,smartValidation:!0,errorPrevention:!0},realTimeMonitoring:{anomalyDetection:!0,predictiveMaintenance:!0,qualityDriftDetection:!0,smartNotifications:!0,performanceMonitoring:!0,alertManagement:!0,statusUpdates:!0,emergencyAlerts:!0},analytics:{dataCollection:!0,realTimeUpdates:!0,historicalDataRetention:!0,exportCapabilities:!0,dashboardCustomization:!0,performanceMetrics:!0,efficiencyTracking:!0,costAnalysis:!0},intelligence:{riskAssessment:!0,alertSystem:!0,escalationRules:!0,aiRecommendations:!0,optimizationTips:!0,predictiveInsights:!0,trendAnalysis:!0,forecasting:!0},performance:{accuracyTracking:!0,responseTimeMonitoring:!0,errorRateTracking:!0,qualityMetrics:!0,benchmarkComparison:!0,performanceAlerts:!0,optimizationSuggestions:!0,modelHealthMonitoring:!0},privacy:{dataAnonymization:!0,thirdPartyPermissions:!0,complianceMonitoring:!0,auditTrail:!0,dataRetention:!0,encryption:!0,accessControl:!0,privacyCompliance:!0},integration:{externalServices:!0,apiRateLimiting:!0,webhookEndpoints:!0,dataSharing:!0,healthMonitoring:!0,syncScheduling:!0,backupSystems:!0,crossPlatformSync:!0},userExperience:{aiSuggestions:!0,learningPaths:!0,personalization:!0,accessibility:!0,languagePreferences:!0,notificationPreferences:!0,interfaceCustomization:!0,helpSystem:!0},environmental:{predictiveCleaning:!1,smartScheduling:!1,contaminationPrediction:!1,resourceOptimization:!1,efficiencyAnalytics:!1,smartRoomManagement:!1,automaticPriorityAssignment:!1,riskAssessment:!1,trendAnalysis:!1,predictiveMaintenance:!1,supplyOptimization:!1,staffScheduling:!1,costOptimization:!1,inventoryPrediction:!1,workloadBalancing:!1,qualityAssurance:!1,complianceMonitoring:!1,auditTrailEnhancement:!1,performanceTracking:!1,automatedReporting:!1,realTimeMonitoring:!1,anomalyDetection:!1,smartNotifications:!1,statusUpdates:!1,emergencyAlerts:!1},learning:{personalizedRecommendations:!1,skillGapAnalysis:!1,learningPathOptimization:!1,performancePrediction:!1,adaptiveDifficulty:!1,learningAnalytics:!1,behaviorTracking:!1,progressPrediction:!1,engagementMetrics:!1,retentionAnalysis:!1,learningEfficiency:!1,contentOptimization:!1,assessmentIntelligence:!1,certificationTracking:!1,competencyMapping:!1,learningInsights:!1},aiConfig:{aiConfidenceThreshold:.8,aiDataRetentionDays:365,realTimeProcessingEnabled:!0,batchProcessingEnabled:!0,dataSharingEnabled:!1,localAIProcessingEnabled:!0,encryptedDataTransmission:!0,aiModelTraining:!1},apiKeys:{},facilityId:this.facilityId,aiVersion:"1.0.0",updated_at:new Date().toISOString()}}mergeSettings(e,t,r,i,n){var o,s,a,l,u,h,f,m,p,g,y,_,w,b,E,C,S,Q,Y,B,Te,ke;return t&&(e.computerVision.toolConditionAssessment=(o=t.tool_condition_assessment)!=null?o:e.computerVision.toolConditionAssessment,e.computerVision.barcodeQualityDetection=(s=t.barcode_quality_detection)!=null?s:e.computerVision.barcodeQualityDetection,e.computerVision.toolTypeRecognition=(a=t.tool_type_recognition)!=null?a:e.computerVision.toolTypeRecognition,e.predictiveAnalytics.cycleOptimization=(l=t.cycle_optimization)!=null?l:e.predictiveAnalytics.cycleOptimization,e.predictiveAnalytics.failurePrediction=(u=t.failure_prediction)!=null?u:e.predictiveAnalytics.failurePrediction,e.aiConfig.aiConfidenceThreshold=(h=t.ai_confidence_threshold)!=null?h:e.aiConfig.aiConfidenceThreshold,e.aiConfig.aiDataRetentionDays=(f=t.ai_data_retention_days)!=null?f:e.aiConfig.aiDataRetentionDays),r&&(e.computerVision.imageRecognition=(m=r.image_recognition_enabled)!=null?m:e.computerVision.imageRecognition,e.computerVision.qualityAssessment=(p=r.quality_assessment_enabled)!=null?p:e.computerVision.qualityAssessment,e.predictiveAnalytics.demandForecasting=(g=r.demand_forecasting_enabled)!=null?g:e.predictiveAnalytics.demandForecasting,e.predictiveAnalytics.costOptimization=(y=r.cost_optimization_enabled)!=null?y:e.predictiveAnalytics.costOptimization,e.smartWorkflow.smartCategorization=(_=r.smart_categorization_enabled)!=null?_:e.smartWorkflow.smartCategorization),i&&(e.environmental.predictiveCleaning=(w=i.predictive_cleaning_enabled)!=null?w:e.environmental.predictiveCleaning,e.environmental.smartScheduling=(b=i.smart_scheduling)!=null?b:e.environmental.smartScheduling,e.environmental.contaminationPrediction=(E=i.contamination_prediction)!=null?E:e.environmental.contaminationPrediction,e.environmental.resourceOptimization=(C=i.resource_optimization)!=null?C:e.environmental.resourceOptimization,e.environmental.efficiencyAnalytics=(S=i.efficiency_analytics)!=null?S:e.environmental.efficiencyAnalytics),n&&(e.learning.personalizedRecommendations=(Q=n.personalized_recommendations)!=null?Q:e.learning.personalizedRecommendations,e.learning.skillGapAnalysis=(Y=n.skill_gap_analysis)!=null?Y:e.learning.skillGapAnalysis,e.learning.learningPathOptimization=(B=n.learning_path_optimization)!=null?B:e.learning.learningPathOptimization,e.learning.performancePrediction=(Te=n.performance_prediction)!=null?Te:e.learning.performancePrediction,e.learning.adaptiveDifficulty=(ke=n.adaptive_difficulty)!=null?ke:e.learning.adaptiveDifficulty),e}extractSterilizationSettings(e){var t,r,i,n,o,s,a;return{tool_condition_assessment:(t=e.computerVision)==null?void 0:t.toolConditionAssessment,barcode_quality_detection:(r=e.computerVision)==null?void 0:r.barcodeQualityDetection,tool_type_recognition:(i=e.computerVision)==null?void 0:i.toolTypeRecognition,cycle_optimization:(n=e.predictiveAnalytics)==null?void 0:n.cycleOptimization,failure_prediction:(o=e.predictiveAnalytics)==null?void 0:o.failurePrediction,ai_confidence_threshold:(s=e.aiConfig)==null?void 0:s.aiConfidenceThreshold,ai_data_retention_days:(a=e.aiConfig)==null?void 0:a.aiDataRetentionDays}}extractInventorySettings(e){var t,r,i,n,o,s,a;return{image_recognition_enabled:(t=e.computerVision)==null?void 0:t.imageRecognition,quality_assessment_enabled:(r=e.computerVision)==null?void 0:r.qualityAssessment,demand_forecasting_enabled:(i=e.predictiveAnalytics)==null?void 0:i.demandForecasting,cost_optimization_enabled:(n=e.predictiveAnalytics)==null?void 0:n.costOptimization,smart_categorization_enabled:(o=e.smartWorkflow)==null?void 0:o.smartCategorization,ai_confidence_threshold:(s=e.aiConfig)==null?void 0:s.aiConfidenceThreshold,ai_data_retention_days:(a=e.aiConfig)==null?void 0:a.aiDataRetentionDays}}extractEnvironmentalSettings(e){var t,r,i,n,o,s,a;return{predictive_cleaning_enabled:(t=e.environmental)==null?void 0:t.predictiveCleaning,smart_scheduling:(r=e.environmental)==null?void 0:r.smartScheduling,contamination_prediction:(i=e.environmental)==null?void 0:i.contaminationPrediction,resource_optimization:(n=e.environmental)==null?void 0:n.resourceOptimization,efficiency_analytics:(o=e.environmental)==null?void 0:o.efficiencyAnalytics,ai_confidence_threshold:(s=e.aiConfig)==null?void 0:s.aiConfidenceThreshold,ai_data_retention_days:(a=e.aiConfig)==null?void 0:a.aiDataRetentionDays}}extractLearningSettings(e){var t,r,i,n,o,s,a;return{personalized_recommendations:(t=e.learning)==null?void 0:t.personalizedRecommendations,skill_gap_analysis:(r=e.learning)==null?void 0:r.skillGapAnalysis,learning_path_optimization:(i=e.learning)==null?void 0:i.learningPathOptimization,performance_prediction:(n=e.learning)==null?void 0:n.performancePrediction,adaptive_difficulty:(o=e.learning)==null?void 0:o.adaptiveDifficulty,ai_confidence_threshold:(s=e.aiConfig)==null?void 0:s.aiConfidenceThreshold,ai_data_retention_days:(a=e.aiConfig)==null?void 0:a.aiDataRetentionDays}}}var Ui=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Xy{constructor(e){this.facilityId=e,this.sterilizationAI=new fc(e),this.inventoryAI=new dc(e),this.environmentalAI=new mc(e),this.learningAI=new lc(e)}loadUnifiedSettings(){return Ui(this,null,function*(){try{const[e,t,r,i]=yield Promise.all([this.sterilizationAI.loadSettings(),this.inventoryAI.loadSettings(),this.environmentalAI.loadSettings(),this.learningAI.loadSettings()]),n=this.createDefaultSettings();return this.mergeSettings(n,e||void 0,t||void 0,r||void 0,i||void 0)}catch(e){return console.error("Error loading unified AI settings:",e),this.createDefaultSettings()}})}saveUnifiedSettings(e){return Ui(this,null,function*(){try{const t=this.extractSterilizationSettings(e),r=this.extractInventorySettings(e),i=this.extractEnvironmentalSettings(e),n=this.extractLearningSettings(e),[o,s,a,l]=yield Promise.all([this.sterilizationAI.saveSettings({facility_id:this.facilityId,ai_enabled:!0,ai_version:"1.0",computer_vision_enabled:!!t.tool_condition_assessment||!1,tool_condition_assessment:!!t.tool_condition_assessment||!1,barcode_quality_detection:!!t.barcode_quality_detection||!1,tool_type_recognition:!!t.tool_type_recognition||!1,cleaning_validation:!1,predictive_analytics_enabled:!!t.failure_prediction||!1,cycle_optimization:!!t.cycle_optimization||!1,failure_prediction:!!t.failure_prediction||!1,efficiency_optimization:!1,resource_planning:!1,smart_workflow_enabled:!1,ai_confidence_threshold:Number(t.ai_confidence_threshold)||.8,ai_data_retention_days:Number(t.ai_data_retention_days)||90}),this.inventoryAI.saveSettings(r),this.environmentalAI.saveSettings(i),this.learningAI.saveSettings(n)]);return o&&s&&a&&l}catch(t){return console.error("Error saving unified AI settings:",t),!1}})}applySettings(e){return Ui(this,null,function*(){try{return yield this.sterilizationAI.initialize(),yield this.environmentalAI.initialize(),yield this.learningAI.initialize(),this.applyFeatureFlags(e),!0}catch(t){return console.error("Error applying AI settings:",t),!1}})}getServiceStatus(){return Ui(this,null,function*(){try{const[e,t,r]=yield Promise.all([this.sterilizationAI.initialize(),this.environmentalAI.initialize(),this.learningAI.initialize()]);return{sterilization:e,inventory:!1,environmental:t,learning:r}}catch(e){return console.error("Error getting AI service status:",e),{sterilization:!1,inventory:!1,environmental:!1,learning:!1}}})}createDefaultSettings(){return{aiEnabled:!0,computerVision:{toolConditionAssessment:!0,barcodeQualityDetection:!0,toolTypeRecognition:!0,cleaningValidation:!0,damageDetection:!0,wearAnalysis:!0,imageRecognition:!0,qualityAssessment:!0},predictiveAnalytics:{cycleOptimization:!0,failurePrediction:!0,efficiencyOptimization:!0,resourcePlanning:!0,maintenancePrediction:!0,qualityPrediction:!0,demandForecasting:!0,costOptimization:!0,seasonalAnalysis:!0},smartWorkflow:{intelligentWorkflowSelection:!0,automatedProblemDetection:!0,smartPhaseTransitions:!0,batchOptimization:!0,toolGrouping:!0,cycleScheduling:!0,smartCategorization:!0,autoClassification:!0,smartFormFilling:!0},qualityAssurance:{biologicalIndicatorAnalysis:!0,complianceMonitoring:!0,auditTrailEnhancement:!0,riskAssessment:!0,qualityMetrics:!0,regulatoryCompliance:!0,smartValidation:!0,errorPrevention:!0},realTimeMonitoring:{anomalyDetection:!0,predictiveMaintenance:!0,qualityDriftDetection:!0,smartNotifications:!0,performanceMonitoring:!0,alertManagement:!0,statusUpdates:!0,emergencyAlerts:!0},analytics:{dataCollection:!0,realTimeUpdates:!0,historicalDataRetention:!0,exportCapabilities:!0,dashboardCustomization:!0,performanceMetrics:!0,efficiencyTracking:!0,costAnalysis:!0},intelligence:{riskAssessment:!0,alertSystem:!0,escalationRules:!0,aiRecommendations:!0,optimizationTips:!0,predictiveInsights:!0,trendAnalysis:!0,forecasting:!0},performance:{accuracyTracking:!0,responseTimeMonitoring:!0,errorRateTracking:!0,qualityMetrics:!0,benchmarkComparison:!0,performanceAlerts:!0,optimizationSuggestions:!0,modelHealthMonitoring:!0},privacy:{dataAnonymization:!0,thirdPartyPermissions:!0,complianceMonitoring:!0,auditTrail:!0,dataRetention:!0,encryption:!0,accessControl:!0,privacyCompliance:!0},integration:{externalServices:!0,apiRateLimiting:!0,webhookEndpoints:!0,dataSharing:!0,healthMonitoring:!0,syncScheduling:!0,backupSystems:!0,crossPlatformSync:!0},userExperience:{aiSuggestions:!0,learningPaths:!0,personalization:!0,accessibility:!0,languagePreferences:!0,notificationPreferences:!0,interfaceCustomization:!0,helpSystem:!0},environmental:{predictiveCleaning:!1,smartScheduling:!1,contaminationPrediction:!1,resourceOptimization:!1,efficiencyAnalytics:!1,smartRoomManagement:!1,automaticPriorityAssignment:!1,riskAssessment:!1,trendAnalysis:!1,predictiveMaintenance:!1,supplyOptimization:!1,staffScheduling:!1,costOptimization:!1,inventoryPrediction:!1,workloadBalancing:!1,qualityAssurance:!1,complianceMonitoring:!1,auditTrailEnhancement:!1,performanceTracking:!1,automatedReporting:!1,realTimeMonitoring:!1,anomalyDetection:!1,smartNotifications:!1,statusUpdates:!1,emergencyAlerts:!1},learning:{personalizedRecommendations:!1,skillGapAnalysis:!1,learningPathOptimization:!1,performancePrediction:!1,adaptiveDifficulty:!1,learningAnalytics:!1,behaviorTracking:!1,progressPrediction:!1,engagementMetrics:!1,retentionAnalysis:!1,learningEfficiency:!1,contentOptimization:!1,assessmentIntelligence:!1,certificationTracking:!1,competencyMapping:!1,learningInsights:!1},aiConfig:{aiConfidenceThreshold:.8,aiDataRetentionDays:365,realTimeProcessingEnabled:!0,batchProcessingEnabled:!0,dataSharingEnabled:!1,localAIProcessingEnabled:!0,encryptedDataTransmission:!0,aiModelTraining:!1},apiKeys:{},facilityId:this.facilityId,aiVersion:"1.0.0",updated_at:new Date().toISOString()}}mergeSettings(e,t,r,i,n){var o,s,a,l,u,h,f,m,p,g,y,_,w,b,E,C,S,Q,Y,B,Te,ke;return t&&(e.computerVision.toolConditionAssessment=(o=!!t.tool_condition_assessment)!=null?o:e.computerVision.toolConditionAssessment,e.computerVision.barcodeQualityDetection=(s=!!t.barcode_quality_detection)!=null?s:e.computerVision.barcodeQualityDetection,e.computerVision.toolTypeRecognition=(a=!!t.tool_type_recognition)!=null?a:e.computerVision.toolTypeRecognition,e.predictiveAnalytics.cycleOptimization=(l=!!t.cycle_optimization)!=null?l:e.predictiveAnalytics.cycleOptimization,e.predictiveAnalytics.failurePrediction=(u=!!t.failure_prediction)!=null?u:e.predictiveAnalytics.failurePrediction,e.aiConfig.aiConfidenceThreshold=(h=Number(t.ai_confidence_threshold))!=null?h:e.aiConfig.aiConfidenceThreshold,e.aiConfig.aiDataRetentionDays=(f=Number(t.ai_data_retention_days))!=null?f:e.aiConfig.aiDataRetentionDays),r&&(e.computerVision.imageRecognition=(m=!!r.image_recognition_enabled)!=null?m:e.computerVision.imageRecognition,e.computerVision.qualityAssessment=(p=!!r.quality_assessment_enabled)!=null?p:e.computerVision.qualityAssessment,e.predictiveAnalytics.demandForecasting=(g=!!r.demand_forecasting_enabled)!=null?g:e.predictiveAnalytics.demandForecasting,e.predictiveAnalytics.costOptimization=(y=!!r.cost_optimization_enabled)!=null?y:e.predictiveAnalytics.costOptimization,e.smartWorkflow.smartCategorization=(_=!!r.smart_categorization_enabled)!=null?_:e.smartWorkflow.smartCategorization),i&&(e.environmental.predictiveCleaning=(w=!!i.predictive_cleaning_enabled)!=null?w:e.environmental.predictiveCleaning,e.environmental.smartScheduling=(b=!!i.smart_scheduling)!=null?b:e.environmental.smartScheduling,e.environmental.contaminationPrediction=(E=!!i.contamination_prediction)!=null?E:e.environmental.contaminationPrediction,e.environmental.resourceOptimization=(C=!!i.resource_optimization)!=null?C:e.environmental.resourceOptimization,e.environmental.efficiencyAnalytics=(S=!!i.efficiency_analytics)!=null?S:e.environmental.efficiencyAnalytics),n&&(e.learning.personalizedRecommendations=(Q=!!n.personalized_recommendations)!=null?Q:e.learning.personalizedRecommendations,e.learning.skillGapAnalysis=(Y=!!n.skill_gap_analysis)!=null?Y:e.learning.skillGapAnalysis,e.learning.learningPathOptimization=(B=!!n.learning_path_optimization)!=null?B:e.learning.learningPathOptimization,e.learning.performancePrediction=(Te=!!n.performance_prediction)!=null?Te:e.learning.performancePrediction,e.learning.adaptiveDifficulty=(ke=!!n.adaptive_difficulty)!=null?ke:e.learning.adaptiveDifficulty),e}extractSterilizationSettings(e){var t,r,i,n,o,s,a;return{tool_condition_assessment:(t=e.computerVision)==null?void 0:t.toolConditionAssessment,barcode_quality_detection:(r=e.computerVision)==null?void 0:r.barcodeQualityDetection,tool_type_recognition:(i=e.computerVision)==null?void 0:i.toolTypeRecognition,cycle_optimization:(n=e.predictiveAnalytics)==null?void 0:n.cycleOptimization,failure_prediction:(o=e.predictiveAnalytics)==null?void 0:o.failurePrediction,ai_confidence_threshold:(s=e.aiConfig)==null?void 0:s.aiConfidenceThreshold,ai_data_retention_days:(a=e.aiConfig)==null?void 0:a.aiDataRetentionDays}}extractInventorySettings(e){var t,r,i,n,o,s,a;return{image_recognition_enabled:(t=e.computerVision)==null?void 0:t.imageRecognition,quality_assessment_enabled:(r=e.computerVision)==null?void 0:r.qualityAssessment,demand_forecasting_enabled:(i=e.predictiveAnalytics)==null?void 0:i.demandForecasting,cost_optimization_enabled:(n=e.predictiveAnalytics)==null?void 0:n.costOptimization,smart_categorization_enabled:(o=e.smartWorkflow)==null?void 0:o.smartCategorization,ai_confidence_threshold:(s=e.aiConfig)==null?void 0:s.aiConfidenceThreshold,ai_data_retention_days:(a=e.aiConfig)==null?void 0:a.aiDataRetentionDays}}extractEnvironmentalSettings(e){var t,r,i,n,o,s,a;return{predictive_cleaning_enabled:(t=e.environmental)==null?void 0:t.predictiveCleaning,smart_scheduling:(r=e.environmental)==null?void 0:r.smartScheduling,contamination_prediction:(i=e.environmental)==null?void 0:i.contaminationPrediction,resource_optimization:(n=e.environmental)==null?void 0:n.resourceOptimization,efficiency_analytics:(o=e.environmental)==null?void 0:o.efficiencyAnalytics,ai_confidence_threshold:(s=e.aiConfig)==null?void 0:s.aiConfidenceThreshold,ai_data_retention_days:(a=e.aiConfig)==null?void 0:a.aiDataRetentionDays}}extractLearningSettings(e){var t,r,i,n,o,s,a;return{personalized_recommendations:(t=e.learning)==null?void 0:t.personalizedRecommendations,skill_gap_analysis:(r=e.learning)==null?void 0:r.skillGapAnalysis,learning_path_optimization:(i=e.learning)==null?void 0:i.learningPathOptimization,performance_prediction:(n=e.learning)==null?void 0:n.performancePrediction,adaptive_difficulty:(o=e.learning)==null?void 0:o.adaptiveDifficulty,ai_confidence_threshold:(s=e.aiConfig)==null?void 0:s.aiConfidenceThreshold,ai_data_retention_days:(a=e.aiConfig)==null?void 0:a.aiDataRetentionDays}}applyFeatureFlags(e){console.log("Applying AI feature flags:",e)}}class Zy{constructor(e){this.facilityId=e}isFeatureEnabled(e,t){return e.aiEnabled?this.getNestedValue(e,t)===!0:!1}validateApiKeys(e){const t=[];return e.openaiApiKey&&!this.isValidApiKey(e.openaiApiKey)&&t.push("Invalid OpenAI API key format"),e.googleVisionApiKey&&!this.isValidApiKey(e.googleVisionApiKey)&&t.push("Invalid Google Vision API key format"),e.azureComputerVisionKey&&!this.isValidApiKey(e.azureComputerVisionKey)&&t.push("Invalid Azure Computer Vision API key format"),{isValid:t.length===0,errors:t}}encryptApiKeys(e){return{openaiApiKey:e.openaiApiKey?this.encryptKey(e.openaiApiKey):void 0,googleVisionApiKey:e.googleVisionApiKey?this.encryptKey(e.googleVisionApiKey):void 0,azureComputerVisionKey:e.azureComputerVisionKey?this.encryptKey(e.azureComputerVisionKey):void 0}}decryptApiKeys(e){return{openaiApiKey:e.openaiApiKey?this.decryptKey(e.openaiApiKey):void 0,googleVisionApiKey:e.googleVisionApiKey?this.decryptKey(e.googleVisionApiKey):void 0,azureComputerVisionKey:e.azureComputerVisionKey?this.decryptKey(e.azureComputerVisionKey):void 0}}getRequiredApiKeys(e){const t=[];return(e.computerVision.toolConditionAssessment||e.computerVision.barcodeQualityDetection||e.computerVision.toolTypeRecognition||e.computerVision.imageRecognition||e.computerVision.qualityAssessment)&&t.push("googleVisionApiKey","azureComputerVisionKey"),(e.predictiveAnalytics.failurePrediction||e.predictiveAnalytics.cycleOptimization||e.predictiveAnalytics.demandForecasting)&&t.push("openaiApiKey"),(e.environmental.predictiveCleaning||e.environmental.contaminationPrediction||e.environmental.resourceOptimization)&&t.push("openaiApiKey"),(e.learning.personalizedRecommendations||e.learning.skillGapAnalysis||e.learning.learningPathOptimization)&&t.push("openaiApiKey"),[...new Set(t)]}hasRequiredApiKeys(e){const t=this.getRequiredApiKeys(e),r=Object.keys(e.apiKeys).filter(i=>e.apiKeys[i]);return t.every(i=>r.some(n=>n===i))}isValidApiKey(e){return e&&e.length>10&&!e.includes(" ")}encryptKey(e){return`encrypted_${e}`}decryptKey(e){return e.replace("encrypted_","")}getNestedValue(e,t){return t.split(".").reduce((r,i)=>r==null?void 0:r[i],e)}}var e_=Object.defineProperty,Ms=Object.getOwnPropertySymbols,t_=Object.prototype.hasOwnProperty,r_=Object.prototype.propertyIsEnumerable,qs=(c,e,t)=>e in c?e_(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Ni=(c,e)=>{for(var t in e||(e={}))t_.call(e,t)&&qs(c,t,e[t]);if(Ms)for(var t of Ms(e))r_.call(e,t)&&qs(c,t,e[t]);return c};class i_{constructor(e){this.facilityId=e}applyFeatureFlags(e){console.log("Applying AI feature flags:",e)}toggleFeature(e,t,r){const i=Ni({},e);return this.setNestedValue(i,t,r),i}toggleMultipleFeatures(e,t){const r=Ni({},e);return Object.entries(t).forEach(([i,n])=>{this.setNestedValue(r,i,n)}),r}enableCategory(e,t){const r=Ni({},e);if(typeof r[t]=="object"&&r[t]!==null){const i=r[t];Object.keys(i).forEach(n=>{i[n]=!0})}return r}disableCategory(e,t){const r=Ni({},e);if(typeof r[t]=="object"&&r[t]!==null){const i=r[t];Object.keys(i).forEach(n=>{i[n]=!1})}return r}getFeatureStatus(e,t){return this.getNestedValue(e,t)===!0}getCategoryStatus(e,t){if(typeof e[t]!="object"||e[t]===null)return{enabled:0,total:0,percentage:0};const r=e[t],i=Object.values(r),n=i.filter(Boolean).length,o=i.length;return{enabled:n,total:o,percentage:o>0?Math.round(n/o*100):0}}getDisabledFeatures(e){const t=[];return Object.entries(e.computerVision).forEach(([r,i])=>{i||t.push(`computerVision.${r}`)}),Object.entries(e.predictiveAnalytics).forEach(([r,i])=>{i||t.push(`predictiveAnalytics.${r}`)}),Object.entries(e.smartWorkflow).forEach(([r,i])=>{i||t.push(`smartWorkflow.${r}`)}),Object.entries(e.qualityAssurance).forEach(([r,i])=>{i||t.push(`qualityAssurance.${r}`)}),Object.entries(e.realTimeMonitoring).forEach(([r,i])=>{i||t.push(`realTimeMonitoring.${r}`)}),Object.entries(e.analytics).forEach(([r,i])=>{i||t.push(`analytics.${r}`)}),Object.entries(e.intelligence).forEach(([r,i])=>{i||t.push(`intelligence.${r}`)}),Object.entries(e.performance).forEach(([r,i])=>{i||t.push(`performance.${r}`)}),Object.entries(e.privacy).forEach(([r,i])=>{i||t.push(`privacy.${r}`)}),Object.entries(e.integration).forEach(([r,i])=>{i||t.push(`integration.${r}`)}),Object.entries(e.userExperience).forEach(([r,i])=>{i||t.push(`userExperience.${r}`)}),Object.entries(e.environmental).forEach(([r,i])=>{i||t.push(`environmental.${r}`)}),Object.entries(e.learning).forEach(([r,i])=>{i||t.push(`learning.${r}`)}),t}getEnabledFeatures(e){const t=[];return Object.entries(e.computerVision).forEach(([r,i])=>{i&&t.push(`computerVision.${r}`)}),Object.entries(e.predictiveAnalytics).forEach(([r,i])=>{i&&t.push(`predictiveAnalytics.${r}`)}),Object.entries(e.smartWorkflow).forEach(([r,i])=>{i&&t.push(`smartWorkflow.${r}`)}),Object.entries(e.qualityAssurance).forEach(([r,i])=>{i&&t.push(`qualityAssurance.${r}`)}),Object.entries(e.realTimeMonitoring).forEach(([r,i])=>{i&&t.push(`realTimeMonitoring.${r}`)}),Object.entries(e.analytics).forEach(([r,i])=>{i&&t.push(`analytics.${r}`)}),Object.entries(e.intelligence).forEach(([r,i])=>{i&&t.push(`intelligence.${r}`)}),Object.entries(e.performance).forEach(([r,i])=>{i&&t.push(`performance.${r}`)}),Object.entries(e.privacy).forEach(([r,i])=>{i&&t.push(`privacy.${r}`)}),Object.entries(e.integration).forEach(([r,i])=>{i&&t.push(`integration.${r}`)}),Object.entries(e.userExperience).forEach(([r,i])=>{i&&t.push(`userExperience.${r}`)}),Object.entries(e.environmental).forEach(([r,i])=>{i&&t.push(`environmental.${r}`)}),Object.entries(e.learning).forEach(([r,i])=>{i&&t.push(`learning.${r}`)}),t}getNestedValue(e,t){return t.split(".").reduce((r,i)=>r==null?void 0:r[i],e)}setNestedValue(e,t,r){const i=t.split("."),n=i.pop(),o=i.reduce((s,a)=>(a in s||(s[a]={}),s[a]),e);o[n]=r}}var n_=Object.defineProperty,zs=Object.getOwnPropertySymbols,a_=Object.prototype.hasOwnProperty,o_=Object.prototype.propertyIsEnumerable,Us=(c,e,t)=>e in c?n_(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Un=(c,e)=>{for(var t in e||(e={}))a_.call(e,t)&&Us(c,t,e[t]);if(zs)for(var t of zs(e))o_.call(e,t)&&Us(c,t,e[t]);return c};class s_{constructor(e){this.facilityId=e}optimizePerformanceSettings(e){const t=Un({},e);return t.aiConfig.aiConfidenceThreshold=this.calculateOptimalConfidenceThreshold(e),t.aiConfig.aiDataRetentionDays=this.calculateOptimalDataRetention(e),t.aiConfig.realTimeProcessingEnabled=this.shouldEnableRealTimeProcessing(e),t.aiConfig.batchProcessingEnabled=this.shouldEnableBatchProcessing(e),t.aiConfig.dataSharingEnabled=this.shouldEnableDataSharing(e),t.aiConfig.localAIProcessingEnabled=this.shouldEnableLocalProcessing(e),t.aiConfig.encryptedDataTransmission=this.shouldEnableEncryption(e),t.aiConfig.aiModelTraining=this.shouldEnableModelTraining(e),t}getPerformanceRecommendations(e){const t=[];return e.aiConfig.aiConfidenceThreshold<.7&&t.push({recommendations:["Consider increasing AI confidence threshold to 0.8 or higher for better accuracy"],priority:"medium"}),e.aiConfig.aiDataRetentionDays>365&&t.push({recommendations:["Consider reducing data retention period to improve performance and reduce storage costs"],priority:"low"}),!e.aiConfig.realTimeProcessingEnabled&&!e.aiConfig.batchProcessingEnabled&&t.push({recommendations:["Enable at least one processing mode (real-time or batch) for AI functionality"],priority:"high"}),e.aiConfig.encryptedDataTransmission||t.push({recommendations:["Enable encrypted data transmission for better security"],priority:"high"}),!e.aiConfig.localAIProcessingEnabled&&e.privacy.dataAnonymization&&t.push({recommendations:["Consider enabling local AI processing for better privacy compliance"],priority:"medium"}),t}validatePerformanceSettings(e){const t=[],r=[];return(e.aiConfig.aiConfidenceThreshold<.1||e.aiConfig.aiConfidenceThreshold>1)&&t.push("AI confidence threshold must be between 0.1 and 1.0"),(e.aiConfig.aiDataRetentionDays<1||e.aiConfig.aiDataRetentionDays>2555)&&t.push("AI data retention days must be between 1 and 2555 (7 years)"),!e.aiConfig.realTimeProcessingEnabled&&!e.aiConfig.batchProcessingEnabled&&t.push("At least one processing mode must be enabled"),!e.aiConfig.encryptedDataTransmission&&e.privacy.dataAnonymization&&r.push("Consider enabling encrypted data transmission when using data anonymization"),!e.aiConfig.localAIProcessingEnabled&&e.privacy.privacyCompliance&&r.push("Consider enabling local AI processing for better privacy compliance"),{isValid:t.length===0,errors:t,warnings:r}}getPerformanceMetricsConfig(e){return{accuracyTracking:e.performance.accuracyTracking,responseTimeMonitoring:e.performance.responseTimeMonitoring,errorRateTracking:e.performance.errorRateTracking,qualityMetrics:e.performance.qualityMetrics,benchmarkComparison:e.performance.benchmarkComparison,performanceAlerts:e.performance.performanceAlerts,optimizationSuggestions:e.performance.optimizationSuggestions,modelHealthMonitoring:e.performance.modelHealthMonitoring}}updatePerformanceMetrics(e,t){const r=Un({},e);return Object.entries(t).forEach(([i,n])=>{n!==void 0&&(r.performance[i]=n)}),r}getPerformanceConfig(e){return{aiConfidenceThreshold:e.aiConfig.aiConfidenceThreshold,aiDataRetentionDays:e.aiConfig.aiDataRetentionDays,realTimeProcessingEnabled:e.aiConfig.realTimeProcessingEnabled,batchProcessingEnabled:e.aiConfig.batchProcessingEnabled,dataSharingEnabled:e.aiConfig.dataSharingEnabled,localAIProcessingEnabled:e.aiConfig.localAIProcessingEnabled,encryptedDataTransmission:e.aiConfig.encryptedDataTransmission,aiModelTraining:e.aiConfig.aiModelTraining}}updatePerformanceConfig(e,t){const r=Un({},e);return Object.entries(t).forEach(([i,n])=>{n!==void 0&&(r.aiConfig[i]=n)}),r}calculateOptimalConfidenceThreshold(e){let t=.8;return e.predictiveAnalytics.failurePrediction&&(t=Math.max(t,.9)),e.qualityAssurance.complianceMonitoring&&(t=Math.max(t,.85)),e.realTimeMonitoring.emergencyAlerts&&(t=Math.max(t,.95)),Math.min(t,.99)}calculateOptimalDataRetention(e){let t=365;return e.privacy.complianceMonitoring&&(t=Math.max(t,2555)),e.qualityAssurance.regulatoryCompliance&&(t=Math.max(t,1825)),e.performance.optimizationSuggestions&&(t=Math.min(t,180)),t}shouldEnableRealTimeProcessing(e){return e.realTimeMonitoring.anomalyDetection||e.realTimeMonitoring.emergencyAlerts||e.realTimeMonitoring.smartNotifications||e.analytics.realTimeUpdates}shouldEnableBatchProcessing(e){return e.predictiveAnalytics.demandForecasting||e.predictiveAnalytics.seasonalAnalysis||e.analytics.historicalDataRetention||e.performance.benchmarkComparison}shouldEnableDataSharing(e){return e.privacy.thirdPartyPermissions&&!e.privacy.dataAnonymization}shouldEnableLocalProcessing(e){return e.privacy.dataAnonymization||e.privacy.privacyCompliance||e.privacy.accessControl}shouldEnableEncryption(e){return e.privacy.encryption||e.privacy.privacyCompliance||e.privacy.accessControl}shouldEnableModelTraining(e){return e.analytics.dataCollection&&(e.predictiveAnalytics.failurePrediction||e.predictiveAnalytics.cycleOptimization||e.learning.personalizedRecommendations)}}var lt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class c_{constructor(e){this.facilityId=e}saveToUnifiedTable(e){return lt(this,null,function*(){var t;try{const{data:{user:r}}=yield d.auth.getUser(),i=(r==null?void 0:r.id)||"unknown-user",{data:n,error:o}=yield d.from("ai_settings").upsert({facility_id:this.facilityId,module:"general",settings:e,updated_at:new Date().toISOString()},{onConflict:"facility_id,module"});return o?(console.error("Error saving to unified table:",o),!1):(!o&&n&&(yield Jn({facilityId:this.facilityId,userId:i,module:"general",action:"UPDATE",details:(t=n[0])!=null?t:{}})),!0)}catch(r){return console.error("Error saving to unified table:",r),!1}})}loadFromUnifiedTable(){return lt(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings").select("settings").eq("facility_id",this.facilityId).eq("module","general").single();return t?(t.code==="PGRST116"||console.error("Error loading from unified table:",t),null):e==null?void 0:e.settings}catch(e){return console.error("Error loading from unified table:",e),null}})}deleteFromUnifiedTable(){return lt(this,null,function*(){try{const{error:e}=yield d.from("ai_settings").delete().eq("facility_id",this.facilityId).eq("module","general");return e?(console.error("Error deleting from unified table:",e),!1):!0}catch(e){return console.error("Error deleting from unified table:",e),!1}})}settingsExist(){return lt(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings").select("facility_id").eq("facility_id",this.facilityId).eq("module","general").single();return t?(t.code==="PGRST116"||console.error("Error checking if settings exist:",t),!1):!!e}catch(e){return console.error("Error checking if settings exist:",e),!1}})}getSettingsMetadata(){return lt(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings").select("updated_at, ai_version, created_at").eq("facility_id",this.facilityId).eq("module","general").single();return t?(t.code==="PGRST116"||console.error("Error getting settings metadata:",t),null):{updated_at:(e==null?void 0:e.updated_at)||null,ai_version:(e==null?void 0:e.ai_version)||null,created_at:(e==null?void 0:e.created_at)||null}}catch(e){return console.error("Error getting settings metadata:",e),null}})}backupSettings(e){return lt(this,null,function*(){try{const{error:t}=yield d.from("ai_settings_backup").insert({facility_id:this.facilityId,module:"general",settings:e,backup_date:new Date().toISOString(),ai_version:e.aiVersion});return t?(console.error("Error backing up settings:",t),!1):!0}catch(t){return console.error("Error backing up settings:",t),!1}})}restoreSettings(e){return lt(this,null,function*(){try{let t=d.from("ai_settings_backup").select("settings").eq("facility_id",this.facilityId).eq("module","general").order("backup_date",{ascending:!1});e&&(t=t.eq("backup_date",e));const{data:r,error:i}=yield t.limit(1).single();return i?(i.code==="PGRST116"||console.error("Error restoring settings:",i),null):r==null?void 0:r.settings}catch(t){return console.error("Error restoring settings:",t),null}})}getAvailableBackups(){return lt(this,null,function*(){try{const{data:e,error:t}=yield d.from("ai_settings_backup").select("backup_date, ai_version").eq("facility_id",this.facilityId).eq("module","general").order("backup_date",{ascending:!1});return t?(console.error("Error getting available backups:",t),[]):e||[]}catch(e){return console.error("Error getting available backups:",e),[]}})}exportSettingsToJson(e){return JSON.stringify(e,null,2)}importSettingsFromJson(e){try{const t=JSON.parse(e);if(!t.aiEnabled||!t.facilityId||!t.aiConfig)throw new Error("Invalid settings format");return t}catch(t){return console.error("Error importing settings from JSON:",t),null}}validateSettingsStructure(e){const t=[];if(typeof e!="object"||e===null)return t.push("Settings must be an object"),{isValid:!1,errors:t};const r=e;if(["aiEnabled","computerVision","predictiveAnalytics","smartWorkflow","qualityAssurance","realTimeMonitoring","analytics","intelligence","performance","privacy","integration","userExperience","environmental","learning","aiConfig","apiKeys","facilityId","aiVersion","updated_at"].forEach(n=>{n in r||t.push(`Missing required property: ${n}`)}),r.computerVision&&typeof r.computerVision!="object"&&t.push("computerVision must be an object"),r.predictiveAnalytics&&typeof r.predictiveAnalytics!="object"&&t.push("predictiveAnalytics must be an object"),r.aiConfig&&typeof r.aiConfig!="object"&&t.push("aiConfig must be an object"),r.aiConfig&&typeof r.aiConfig=="object"){const n=r.aiConfig;typeof n.aiConfidenceThreshold!="number"&&t.push("aiConfig.aiConfidenceThreshold must be a number"),typeof n.aiDataRetentionDays!="number"&&t.push("aiConfig.aiDataRetentionDays must be a number")}return{isValid:t.length===0,errors:t}}}var Fi=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class l_{constructor(e){this.facilityId=e,this.configProvider=new Jy(e),this.modelProvider=new Xy(e),this.apiKeyProvider=new Zy(e),this.toggleProvider=new i_(e),this.performanceProvider=new s_(e),this.persistenceProvider=new c_(e)}loadUnifiedSettings(){return Fi(this,null,function*(){return this.modelProvider.loadUnifiedSettings()})}saveUnifiedSettings(e){return Fi(this,null,function*(){const t=yield this.modelProvider.saveUnifiedSettings(e),r=yield this.persistenceProvider.saveToUnifiedTable(e);return t&&r})}applySettings(e){return Fi(this,null,function*(){return this.modelProvider.applySettings(e)})}isFeatureEnabled(e,t){return this.apiKeyProvider.isFeatureEnabled(e,t)}getServiceStatus(){return Fi(this,null,function*(){return this.modelProvider.getServiceStatus()})}}const sw=()=>{const{getCurrentFacilityId:c}=jc(),e=c();return e?Hc.useMemo(()=>new l_(e),[e]):null};var u_=Object.defineProperty,d_=Object.defineProperties,h_=Object.getOwnPropertyDescriptors,Ns=Object.getOwnPropertySymbols,f_=Object.prototype.hasOwnProperty,m_=Object.prototype.propertyIsEnumerable,Fs=(c,e,t)=>e in c?u_(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,p_=(c,e)=>{for(var t in e||(e={}))f_.call(e,t)&&Fs(c,t,e[t]);if(Ns)for(var t of Ns(e))m_.call(e,t)&&Fs(c,t,e[t]);return c},g_=(c,e)=>d_(c,h_(e)),ia=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function cw(c){return ia(this,null,function*(){try{const{error:e}=yield d.from("content_activities").insert(g_(p_({},c),{created_at:new Date().toISOString()}));return e?(console.error("Error logging content activity:",e),!1):!0}catch(e){return console.error("Error logging content activity:",e),!1}})}function y_(c){return ia(this,null,function*(){try{let e=d.from("content_activities").select("*").eq("facility_id",c.facility_id).order("created_at",{ascending:!1});c.content_type&&(e=e.eq("content_type",c.content_type)),c.activity_type&&(e=e.eq("activity_type",c.activity_type)),c.user_id&&(e=e.eq("user_id",c.user_id)),c.date_from&&(e=e.gte("created_at",c.date_from)),c.date_to&&(e=e.lte("created_at",c.date_to)),c.limit&&(e=e.limit(c.limit));const{data:t,error:r}=yield e;return r?(console.error("Error fetching content activities:",r),[]):t||[]}catch(e){return console.error("Error fetching content activities:",e),[]}})}function lw(c,e=30){return ia(this,null,function*(){try{const t=new Date;t.setDate(t.getDate()-e);const r=yield y_({facility_id:c,date_from:t.toISOString(),limit:1e3}),i={total_activities:r.length,activities_by_type:{},activities_by_content_type:{},activities_by_user:{},recent_activities:r.slice(0,20)};return r.forEach(n=>{i.activities_by_type[n.activity_type]=(i.activities_by_type[n.activity_type]||0)+1,i.activities_by_content_type[n.content_type]=(i.activities_by_content_type[n.content_type]||0)+1,i.activities_by_user[n.user_name]=(i.activities_by_user[n.user_name]||0)+1}),i}catch(t){return console.error("Error getting content activity stats:",t),{total_activities:0,activities_by_type:{},activities_by_content_type:{},activities_by_user:{},recent_activities:[]}}})}function uw(c){const e=new Date(c),r=new Date().getTime()-e.getTime(),i=Math.floor(r/(1e3*60)),n=Math.floor(r/(1e3*60*60)),o=Math.floor(r/(1e3*60*60*24));return i<1?"Just now":i<60?`${i}m ago`:n<24?`${n}h ago`:o<7?`${o}d ago`:e.toLocaleDateString()}function dw(c){return{created:{text:"Created",icon:"mdiPlus",color:"text-green-600"},updated:{text:"Updated",icon:"mdiPencil",color:"text-blue-600"},published:{text:"Published",icon:"mdiPublish",color:"text-purple-600"},deleted:{text:"Deleted",icon:"mdiTrashCan",color:"text-red-600"},draft_saved:{text:"Draft Saved",icon:"mdiContentSave",color:"text-yellow-600"}}[c]||{text:c,icon:"mdiCircle",color:"text-gray-600"}}function hw(c){return{policy:{text:"Policy",icon:"mdiFileDocument",color:"text-blue-600"},procedure:{text:"Procedure",icon:"mdiClipboardText",color:"text-green-600"},course:{text:"Course",icon:"mdiSchool",color:"text-purple-600"},learning_pathway:{text:"Learning Pathway",icon:"mdiMapMarkerPath",color:"text-orange-600"}}[c]||{text:c,icon:"mdiFile",color:"text-gray-600"}}var Nn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class fw{static getPendingContent(e){return Nn(this,null,function*(){try{const t=[],{data:r,error:i}=yield d.from("courses").select(`
          id,
          title,
          description,
          author_id,
          submitted_for_approval_at,
          users!author_id (
            first_name,
            last_name,
            email
          )
        `).eq("facility_id",e).eq("approval_status","pending_approval").is("published_at",null);i?console.error("Error fetching pending courses:",i):r&&r.forEach(l=>{var u,h,f,m,p,g;t.push({id:l.id,title:l.title,description:l.description,type:"course",authorId:l.author_id,authorName:`${((h=(u=l.users)==null?void 0:u[0])==null?void 0:h.first_name)||""} ${((m=(f=l.users)==null?void 0:f[0])==null?void 0:m.last_name)||""}`.trim()||((g=(p=l.users)==null?void 0:p[0])==null?void 0:g.email)||"Unknown",submittedAt:l.submitted_for_approval_at,revisionNumber:1,previousRejections:0,facilityId:e})});const{data:n,error:o}=yield d.from("policies").select(`
          id,
          title,
          description,
          author_id,
          submitted_for_approval_at,
          users!author_id (
            first_name,
            last_name,
            email
          )
        `).eq("approval_status","pending_approval").is("published_at",null);o?console.error("Error fetching pending policies:",o):n&&n.forEach(l=>{var u,h,f,m,p,g;t.push({id:l.id,title:l.title,description:l.description,type:"policy",authorId:l.author_id,authorName:`${((h=(u=l.users)==null?void 0:u[0])==null?void 0:h.first_name)||""} ${((m=(f=l.users)==null?void 0:f[0])==null?void 0:m.last_name)||""}`.trim()||((g=(p=l.users)==null?void 0:p[0])==null?void 0:g.email)||"Unknown",submittedAt:l.submitted_for_approval_at,revisionNumber:1,previousRejections:0,facilityId:e})});const{data:s,error:a}=yield d.from("procedures").select(`
          id,
          title,
          description,
          author_id,
          submitted_for_approval_at,
          users!author_id (
            first_name,
            last_name,
            email
          )
        `).eq("approval_status","pending_approval").is("published_at",null);return a?console.error("Error fetching pending procedures:",a):s&&s.forEach(l=>{var u,h,f,m,p,g;t.push({id:l.id,title:l.title,description:l.description,type:"procedure",authorId:l.author_id,authorName:`${((h=(u=l.users)==null?void 0:u[0])==null?void 0:h.first_name)||""} ${((m=(f=l.users)==null?void 0:f[0])==null?void 0:m.last_name)||""}`.trim()||((g=(p=l.users)==null?void 0:p[0])==null?void 0:g.email)||"Unknown",submittedAt:l.submitted_for_approval_at,revisionNumber:1,previousRejections:0,facilityId:e})}),t.sort((l,u)=>new Date(u.submittedAt).getTime()-new Date(l.submittedAt).getTime()),t}catch(t){throw console.error("Error fetching pending content:",t),t}})}static approveContent(e,t,r){return Nn(this,null,function*(){try{const i=t==="learning_pathway"?"courses":t,{data:n,error:o}=yield d.from(i).select("approval_status").eq("id",e).single();if(o)throw o;if(n.approval_status!=="pending_approval")throw new Error(`Content ${e} is no longer pending approval (status: ${n.approval_status})`);const{error:s}=yield d.from(i).update({approval_status:"approved",approved_at:new Date().toISOString(),approved_by:r,published_at:new Date().toISOString()}).eq("id",e).eq("approval_status","pending_approval");if(s)throw s}catch(i){throw console.error("Error approving content:",i),i}})}static rejectContent(e,t,r,i){return Nn(this,null,function*(){try{const n=t==="learning_pathway"?"courses":t,{data:o,error:s}=yield d.from(n).select("approval_status").eq("id",e).single();if(s)throw s;if(o.approval_status!=="pending_approval")throw new Error(`Content ${e} is no longer pending approval (status: ${o.approval_status})`);const{error:a}=yield d.from(n).update({approval_status:"rejected",rejected_at:new Date().toISOString(),rejected_by:r,rejection_reason:i}).eq("id",e).eq("approval_status","pending_approval");if(a)throw a}catch(n){throw console.error("Error rejecting content:",n),n}})}}var __=Object.defineProperty,Ls=Object.getOwnPropertySymbols,v_=Object.prototype.hasOwnProperty,w_=Object.prototype.propertyIsEnumerable,xs=(c,e,t)=>e in c?__(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,I_=(c,e)=>{for(var t in e||(e={}))v_.call(e,t)&&xs(c,t,e[t]);if(Ls)for(var t of Ls(e))w_.call(e,t)&&xs(c,t,e[t]);return c};class mw{static handleApprovalError(e,t){var r,i,n,o,s,a,l,u,h,f,m;return console.error(`Approval error in ${t}:`,e),(r=e==null?void 0:e.code)!=null&&r.startsWith("23")?{code:"CONSTRAINT_VIOLATION",message:e.message,details:e,userMessage:"This action conflicts with existing data. Please refresh and try again.",severity:"medium",retryable:!0}:(e==null?void 0:e.code)==="PGRST116"?{code:"NOT_FOUND",message:e.message,details:e,userMessage:"The requested content or task could not be found. It may have been deleted.",severity:"medium",retryable:!1}:(i=e==null?void 0:e.code)!=null&&i.startsWith("42")?{code:"DATABASE_ERROR",message:e.message,details:e,userMessage:"A database error occurred. Please try again in a moment.",severity:"high",retryable:!0}:(n=e==null?void 0:e.message)!=null&&n.includes("fetch")?{code:"NETWORK_ERROR",message:e.message,details:e,userMessage:"Network connection issue. Please check your internet connection and try again.",severity:"medium",retryable:!0}:(o=e==null?void 0:e.message)!=null&&o.includes("permission")||(s=e==null?void 0:e.message)!=null&&s.includes("unauthorized")?{code:"PERMISSION_DENIED",message:e.message,details:e,userMessage:"You do not have permission to perform this action.",severity:"high",retryable:!1}:(a=e==null?void 0:e.message)!=null&&a.includes("already")||(l=e==null?void 0:e.message)!=null&&l.includes("concurrent")?{code:"CONCURRENT_MODIFICATION",message:e.message,details:e,userMessage:"This content has already been processed by another user. Please refresh the page.",severity:"medium",retryable:!0}:(u=e==null?void 0:e.message)!=null&&u.includes("not found")||(h=e==null?void 0:e.message)!=null&&h.includes("does not exist")?{code:"CONTENT_NOT_FOUND",message:e.message,details:e,userMessage:"The content you are trying to review no longer exists.",severity:"medium",retryable:!1}:(f=e==null?void 0:e.message)!=null&&f.includes("validation")||(m=e==null?void 0:e.message)!=null&&m.includes("invalid")?{code:"VALIDATION_ERROR",message:e.message,details:e,userMessage:"Please check your input and try again.",severity:"low",retryable:!0}:{code:"UNKNOWN_ERROR",message:(e==null?void 0:e.message)||"An unexpected error occurred",details:e,userMessage:"An unexpected error occurred. Please try again.",severity:"high",retryable:!0}}static showErrorToast(e,t){const r=t||e.userMessage,i={duration:e.severity==="critical"?8e3:5e3,style:{background:e.severity==="critical"?"#dc2626":e.severity==="high"?"#ea580c":e.severity==="medium"?"#d97706":"#059669",color:"#ffffff",fontWeight:"500"}};e.retryable&&e.severity!=="critical"?sa.error(r,I_({},i)):sa.error(r,i)}static handleApprovalActionError(e,t){const r=this.handleApprovalError(e,`content_${t}`);return t==="approve"?r.code==="CONCURRENT_MODIFICATION"?r.userMessage="This content has already been approved by another reviewer.":r.code==="CONTENT_NOT_FOUND"&&(r.userMessage="The content you are trying to approve no longer exists."):t==="reject"&&(r.code==="CONCURRENT_MODIFICATION"?r.userMessage="This content has already been processed by another reviewer.":r.code==="CONTENT_NOT_FOUND"&&(r.userMessage="The content you are trying to reject no longer exists.")),r}static handleTaskCreationError(e){const t=this.handleApprovalError(e,"task_creation");return t.code==="PERMISSION_DENIED"?t.userMessage="No users found with approval permissions. Please check your user roles.":t.code==="NOT_FOUND"&&(t.userMessage="The content to be reviewed could not be found."),t}static handleNotificationError(e){console.warn("Notification error (non-critical):",e)}static logError(e,t,r){const i={timestamp:new Date().toISOString(),context:t,userId:r,errorCode:e.code,errorMessage:e.message,severity:e.severity,retryable:e.retryable,details:e.details};console.error("Approval workflow error logged:",i)}static getUserMessage(e,t){const r={CONSTRAINT_VIOLATION:"This action conflicts with existing data. Please refresh and try again.",NOT_FOUND:"The requested item could not be found.",DATABASE_ERROR:"A database error occurred. Please try again in a moment.",NETWORK_ERROR:"Network connection issue. Please check your internet connection.",PERMISSION_DENIED:"You do not have permission to perform this action.",CONCURRENT_MODIFICATION:"This item has already been processed by another user.",CONTENT_NOT_FOUND:"The content you are looking for no longer exists.",VALIDATION_ERROR:"Please check your input and try again.",UNKNOWN_ERROR:"An unexpected error occurred. Please try again."};return r[e]||r.UNKNOWN_ERROR}static isRetryable(e){return this.handleApprovalError(e,"unknown").retryable}static getSeverity(e){return this.handleApprovalError(e,"unknown").severity}}var Fn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const pw={getPendingSuggestions(c){return Fn(this,null,function*(){const{data:e,error:t}=yield d.from("ai_content_suggestions").select("id, facility_id, suggestion_type, topic, title, description, priority, related_content_id, status, created_at, updated_at").eq("facility_id",c).in("status",["pending","accepted"]).order("priority",{ascending:!0}).order("created_at",{ascending:!1});if(t)throw t;const r=e||[];try{const i=typeof localStorage!="undefined"?localStorage.getItem("officeHoursSettings"):null;if(!i)return r;const n=JSON.parse(i)||{},o=Array.isArray(n.clinicTypes)?n.clinicTypes:[],s=typeof n.address=="string"?n.address:"",a=typeof n.country=="string"?n.country:"",l=new Set(o.flatMap(f=>f.split(/[\s/,&-]+/)).map(f=>f.trim().toLowerCase()).filter(f=>f.length>1)),u=new Set([s,a].join(" ").split(/[\s,.-]+/).map(f=>f.trim().toLowerCase()).filter(f=>f.length>1)),h=f=>{const m=`${f.topic||""} ${f.title||""} ${f.description||""}`.toLowerCase();let p=0;if(l.size>0)for(const y of l)y&&m.includes(y)&&(p+=5);if(u.size>0)for(const y of u)y&&m.includes(y)&&(p+=2);const g=f.priority==="high"?3:f.priority==="medium"?1:0;return p+=g,p};return r.map(f=>({s:f,_score:h(f)})).sort((f,m)=>m._score-f._score||new Date(m.s.created_at).getTime()-new Date(f.s.created_at).getTime()).map(({s:f})=>f)}catch(i){return r}})},acceptSuggestion(c){return Fn(this,null,function*(){const{error:e}=yield d.from("ai_content_suggestions").update({status:"accepted",updated_at:new Date().toISOString()}).eq("id",c);if(e)throw e})},completeSuggestion(c,e){return Fn(this,null,function*(){const{error:t}=yield d.from("ai_content_suggestions").update({status:"completed",related_content_id:e!=null?e:null,updated_at:new Date().toISOString()}).eq("id",c);if(t)throw t})}};var Oe=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const Ln=()=>Oe(null,null,function*(){return yield Ot.getCurrentFacilityId()}),xn=(c,e=0)=>typeof c=="number"&&!isNaN(c)?c:e,Bs=(c,e="Unknown")=>typeof c=="string"&&c.trim()!==""?c:e,Bn=c=>c instanceof Error?c.message:typeof c=="string"?c:"An unknown error occurred";class gw{static getItemsFromSupabase(e,t){return Oe(this,null,function*(){try{const r=t||(yield Ln()),i=dt(r),n=Qe.getFilterSummary(e);if(!Qe.validateFilters(e))throw new Error("Invalid filter parameters");const o=yield Qe.applyFiltersToTable(i,"inventory_items",e),{data:s,error:a,count:l}=yield o.eq("facility_id",r).order("created_at",{ascending:!1});if(a)throw console.error("Error fetching items from Supabase:",a),a;return{data:(s==null?void 0:s.map(h=>U.transformFromSupabase(h)))||[],error:null,count:l||0}}catch(r){throw console.error("Failed to fetch items from Supabase:",r),r}})}static getItemByIdFromSupabase(e){return Oe(this,null,function*(){try{return yield _r.getItemById(e)}catch(t){return console.error("Error fetching item by ID:",t),null}})}static createItemInSupabase(e){return Oe(this,null,function*(){try{const{createItem:t}=yield T(()=>Promise.resolve().then(()=>Tn),void 0);return yield t(e)}catch(t){throw console.error("Error creating item:",t),new Error(`Failed to create item: ${Bn(t)}`)}})}static updateItemInSupabase(e,t){return Oe(this,null,function*(){try{const{updateItem:r}=yield T(()=>Promise.resolve().then(()=>Tn),void 0);return yield r(e,t)}catch(r){throw console.error("Error updating item:",r),new Error(`Failed to update item: ${Bn(r)}`)}})}static deleteItemFromSupabase(e){return Oe(this,null,function*(){try{const{deleteItem:t}=yield T(()=>Promise.resolve().then(()=>Tn),void 0);yield t(e)}catch(t){throw new Error(`Failed to delete item: ${Bn(t)}`)}})}static getCategories(e){return Oe(this,null,function*(){try{const t=e||(yield Ln()),r=dt(t),n=yield(yield Qe.applyFiltersToCategories(r,"inventory_items")).eq("facility_id",t);if(!n)throw console.error("❌ Error fetching categories"),new Error("Failed to fetch categories");return Qe.extractUniqueValues(n.data,"category").sort()}catch(t){return console.error("Error fetching categories:",t),[]}})}static getCategoriesFromSupabase(){return Oe(this,null,function*(){return this.getCategories()})}static getLocations(e){return Oe(this,null,function*(){try{const t=e||(yield Ln()),r=dt(t),n=yield(yield Qe.applyFiltersToLocations(r,"inventory_items")).eq("facility_id",t);if(!n)throw console.error("❌ Error fetching locations"),new Error("Failed to fetch locations");return Qe.extractUniqueValues(n.data,"location").sort()}catch(t){return console.error("Error fetching locations:",t),[]}})}static getLocationsFromSupabase(){return Oe(this,null,function*(){return this.getLocations()})}static getInventoryStatsFromSupabase(){return Oe(this,null,function*(){try{const e=yield _r.getItems(),t=e.length,r=e.filter(o=>o.status==="active").length,i=e.reduce((o,s)=>o+xn(s.unit_cost),0),n={};return e.forEach(o=>{const s=Bs(o.category);n[s]=(n[s]||0)+1}),{totalItems:t,activeItems:r,totalValue:i,categories:n}}catch(e){return console.error("Error fetching inventory stats:",e),{totalItems:0,activeItems:0,totalValue:0,categories:{}}}})}static calculateTotalValue(e){try{return e.reduce((r,i)=>{const n=xn(i.unit_cost),o=xn(i.quantity,1);return r+n*o},0)}catch(t){return console.error("Error calculating total value:",t),0}}static getCategoryBreakdown(e){try{const t={};return e.forEach(r=>{const i=Bs(r.category);t[i]=(t[i]||0)+1}),t}catch(t){return console.error("Error calculating category breakdown:",t),{}}}}var cn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function yw(c){return cn(this,null,function*(){const{data:e,error:t}=yield d.from("locations").select("*").eq("facility_id",c).order("name",{ascending:!0});if(t)throw t;return e||[]})}function _w(c,e,t,r,i){return cn(this,null,function*(){const{data:n,error:o}=yield d.from("locations").insert([{facility_id:c,name:e,barcode:t,parent_id:r!=null?r:null,capacity:i!=null?i:0}]).select().single();if(o)throw o;return n})}function vw(c,e){return cn(this,null,function*(){const{data:t,error:r}=yield d.from("locations").update({status:e}).eq("id",c).select().single();if(r)throw r;return t})}function ww(c){return cn(this,null,function*(){const{error:e}=yield d.from("locations").delete().eq("id",c);if(e)throw e})}var js=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class S_{static generateLearningObjectives(e){return js(this,null,function*(){try{const t=this.buildContextPrompt(e),r=yield fetch(this.API_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:t,context:"courses"})});if(!r.ok)throw new Error(`AI service responded with status ${r.status}`);const i=yield this.parseStreamingResponse(r);return this.parseObjectivesFromResponse(i)}catch(t){return console.error("Error generating learning objectives:",t),this.getFallbackObjectives(e)}})}static buildContextPrompt(e){const{title:t,description:r,prerequisites:i,linkedPrerequisites:n,difficulty:o}=e;let s=`Generate 3-5 specific, measurable learning objectives for a healthcare/sterilization course with the following details:

Course Title: "${t}"
Course Description: "${r}"
Difficulty Level: ${o}`;return i&&i.length>0&&i[0]&&(s+=`
Prerequisites: ${i.filter(a=>a.trim()).join(", ")}`),n&&n.length>0&&(s+=`
Linked Course Prerequisites: ${n.length} course(s) from our library`),s+=`

Please generate learning objectives that:
1. Use action verbs aligned with Bloom's Taxonomy
2. Are specific and measurable
3. Are appropriate for ${o} level learners
4. Focus on healthcare/sterilization context
5. Build upon the stated prerequisites

Format each objective as a JSON object with:
- "objective": the learning objective statement
- "bloomsLevel": one of [remember, understand, apply, analyze, evaluate, create]
- "reasoning": brief explanation of why this objective fits the course
- "confidence": score from 0.0 to 1.0

Return only a JSON array of objectives, no other text.`,s}static parseStreamingResponse(e){return js(this,null,function*(){var t;const r=(t=e.body)==null?void 0:t.getReader();if(!r)throw new Error("No response body");let i="";const n=new TextDecoder;try{let o=1e3;for(;o>0;){const{done:s,value:a}=yield r.read();if(s)break;const l=n.decode(a,{stream:!0});i+=l,o--}}finally{r.releaseLock()}return i})}static parseObjectivesFromResponse(e){try{const t=e.match(/\[[\s\S]*\]/);if(!t)throw new Error("No JSON array found in response");return JSON.parse(t[0]).map(i=>({objective:i.objective||"Invalid objective",bloomsLevel:i.bloomsLevel||"understand",reasoning:i.reasoning||"AI generated",confidence:typeof i.confidence=="number"?i.confidence:.7}))}catch(t){return console.error("Error parsing AI response:",t),[]}}static getFallbackObjectives(e){const{title:t,difficulty:r}=e,i=[];return t.toLowerCase().includes("sterilization")&&(i.push({objective:"Identify proper sterilization procedures and protocols",bloomsLevel:"remember",reasoning:"Fundamental knowledge for sterilization courses",confidence:.8}),r!=="beginner"&&i.push({objective:"Evaluate sterilization effectiveness and troubleshoot issues",bloomsLevel:"evaluate",reasoning:"Advanced skill for non-beginner courses",confidence:.7})),t.toLowerCase().includes("safety")&&i.push({objective:"Apply safety protocols in healthcare environments",bloomsLevel:"apply",reasoning:"Practical application for safety courses",confidence:.8}),i.length===0&&i.push({objective:`Demonstrate understanding of ${t.toLowerCase()} concepts and procedures`,bloomsLevel:"understand",reasoning:"Generic objective based on course title",confidence:.6}),i}}S_.API_ENDPOINT="/api/ai/openai";var Zr=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Iw(c,e){return Zr(this,null,function*(){try{const[t,r,i,n]=yield Promise.all([d.from("courses").select("*").eq("author_id",c).eq("facility_id",e).is("published_at",null).is("archived_at",null).order("updated_at",{ascending:!1}),d.from("policies").select("*").eq("author_id",c).eq("facility_id",e).is("published_at",null).is("archived_at",null).order("updated_at",{ascending:!1}),d.from("procedures").select("*").eq("author_id",c).eq("facility_id",e).is("published_at",null).is("archived_at",null).order("updated_at",{ascending:!1}),d.from("courses").select("*").eq("author_id",c).eq("facility_id",e).eq("content_type","learning_pathway").is("published_at",null).is("archived_at",null).order("updated_at",{ascending:!1})]);return t.error&&console.error("Error fetching course drafts:",t.error),r.error&&console.error("Error fetching policy drafts:",r.error),i.error&&console.error("Error fetching procedure drafts:",i.error),n.error&&console.error("Error fetching pathway drafts:",n.error),{courses:t.data||[],policies:r.data||[],procedures:i.data||[],learning_pathways:n.data||[]}}catch(t){return console.error("Error fetching user drafts:",t),{courses:[],policies:[],procedures:[],learning_pathways:[]}}})}function Sw(c,e){return Zr(this,null,function*(){try{const t=e==="learning_pathways"?"courses":e,{data:r,error:i}=yield d.from(t).select("*").eq("id",c).single();return i?(console.error(`Error fetching ${e} draft:`,i),null):r}catch(t){return console.error(`Error fetching draft ${c}:`,t),null}})}function bw(c,e){return Zr(this,null,function*(){try{const t=e==="learning_pathways"?"courses":e,{error:r}=yield d.from(t).delete().eq("id",c);return r?(console.error(`Error deleting ${e} draft:`,r),!1):!0}catch(t){return console.error(`Error deleting draft ${c}:`,t),!1}})}function Ew(c,e){return Zr(this,null,function*(){try{const t=e==="learning_pathways"?"courses":e,{error:r}=yield d.from(t).update({published_at:new Date().toISOString()}).eq("id",c);return r?(console.error(`Error publishing ${e} draft:`,r),!1):!0}catch(t){return console.error(`Error publishing draft ${c}:`,t),!1}})}function Aw(c,e){return Zr(this,null,function*(){try{const t=e==="learning_pathways"?"courses":e,{error:r}=yield d.from(t).update({approval_status:"pending_approval",submitted_for_approval_at:new Date().toISOString()}).eq("id",c);if(r)return console.error(`Error updating ${e} approval status:`,r),!1;const{data:i,error:n}=yield d.from(t).select("facility_id").eq("id",c).single();if(n||!i)return console.error(`Error fetching ${e} details:`,n),!1;const{TaskService:o}=yield T(()=>Promise.resolve().then(()=>Hp),void 0),s=e==="courses"?"course":e==="policies"?"policy":e==="procedures"?"procedure":e==="learning_pathways"?"learning_pathway":"course";return yield o.createContentApprovalTask(c,s,i.facility_id),console.log(`Successfully submitted ${e} ${c} for approval`),!0}catch(t){return console.error(`Error submitting ${e} draft for approval:`,t),!1}})}function Tw(c){const e=new Date(c),r=new Date().getTime()-e.getTime(),i=Math.floor(r/(1e3*60)),n=Math.floor(r/(1e3*60*60)),o=Math.floor(r/(1e3*60*60*24));return i<1?"Just now":i<60?`${i}m ago`:n<24?`${n}h ago`:o<7?`${o}d ago`:e.toLocaleDateString()}var b_=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const kw=(c,e)=>b_(null,null,function*(){try{console.log("Analytics Event:",{eventName:c,properties:e,timestamp:new Date})}catch(t){console.warn("Failed to track analytics event:",t)}});var Ht=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const xc=class Kr{constructor(){this.STORAGE_KEY="cliniio_trusted_devices",this.DEVICE_NAME_KEY="cliniio_device_name"}static getInstance(){return Kr.instance||(Kr.instance=new Kr),Kr.instance}generateDeviceFingerprint(){try{const e=document.createElement("canvas"),t=e.getContext("2d");t&&(t.textBaseline="top",t.font="14px Arial",t.fillText("Device fingerprint",2,2));const r=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,new Date().getTimezoneOffset(),e.toDataURL()].join("|");return btoa(r).replace(/[^a-zA-Z0-9]/g,"").substring(0,32)}catch(e){return"unknown_device"}}getDeviceName(){const e=localStorage.getItem(this.DEVICE_NAME_KEY);if(e)return e;const t=navigator.userAgent;let r="Unknown Device";return t.includes("Windows")?r="Windows Device":t.includes("Mac")?r="Mac Device":t.includes("Linux")?r="Linux Device":t.includes("Android")?r="Android Device":(t.includes("iPhone")||t.includes("iPad"))&&(r="iOS Device"),t.includes("Chrome")?r+=" (Chrome)":t.includes("Firefox")?r+=" (Firefox)":t.includes("Safari")?r+=" (Safari)":t.includes("Edge")&&(r+=" (Edge)"),localStorage.setItem(this.DEVICE_NAME_KEY,r),r}storeTrustedDevice(e,t){return Ht(this,null,function*(){try{const r=this.getDeviceName(),{error:i}=yield d.from("trusted_devices").upsert({user_id:e,device_fingerprint:t,device_name:r,last_used:new Date().toISOString(),is_active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});return i?(console.error("Failed to store trusted device:",i),!1):(this.storeDeviceLocally(t,r),!0)}catch(r){return console.error("Error storing trusted device:",r),!1}})}isDeviceTrusted(e){return Ht(this,null,function*(){try{const t=this.generateDeviceFingerprint(),{data:r,error:i}=yield d.from("trusted_devices").select("id, last_used, is_active").eq("user_id",e).eq("device_fingerprint",t).eq("is_active",!0).single();return i||!r?!1:(yield this.updateLastUsed(r.id),!0)}catch(t){return console.error("Error checking trusted device:",t),!1}})}getTrustedDevices(e){return Ht(this,null,function*(){try{const{data:t,error:r}=yield d.from("trusted_devices").select("*").eq("user_id",e).eq("is_active",!0).order("last_used",{ascending:!1});return r?(console.error("Failed to get trusted devices:",r),[]):t||[]}catch(t){return console.error("Error getting trusted devices:",t),[]}})}removeTrustedDevice(e){return Ht(this,null,function*(){try{const{error:t}=yield d.from("trusted_devices").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",e);return t?(console.error("Failed to remove trusted device:",t),!1):!0}catch(t){return console.error("Error removing trusted device:",t),!1}})}updateLastUsed(e){return Ht(this,null,function*(){try{yield d.from("trusted_devices").update({last_used:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",e)}catch(t){console.error("Error updating last used:",t)}})}storeDeviceLocally(e,t){try{const r={fingerprint:e,name:t,timestamp:new Date().toISOString()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(r))}catch(r){console.error("Error storing device locally:",r)}}getLocalDeviceInfo(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return null;const t=JSON.parse(e),r=new Date(Date.now()-720*60*60*1e3);return new Date(t.timestamp)<r?(localStorage.removeItem(this.STORAGE_KEY),null):t}catch(e){return console.error("Error getting local device info:",e),null}}clearAllTrustedDevices(e){return Ht(this,null,function*(){try{const{error:t}=yield d.from("trusted_devices").update({is_active:!1,updated_at:new Date().toISOString()}).eq("user_id",e);return t?(console.error("Failed to clear trusted devices:",t),!1):(localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.DEVICE_NAME_KEY),!0)}catch(t){return console.error("Error clearing trusted devices:",t),!1}})}};xc.instance=null;let E_=xc;const Pw=E_.getInstance();var A_=Object.defineProperty,Vs=Object.getOwnPropertySymbols,T_=Object.prototype.hasOwnProperty,k_=Object.prototype.propertyIsEnumerable,Hs=(c,e,t)=>e in c?A_(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Hr=(c,e)=>{for(var t in e||(e={}))T_.call(e,t)&&Hs(c,t,e[t]);if(Vs)for(var t of Vs(e))k_.call(e,t)&&Hs(c,t,e[t]);return c},jn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});const P_={maxAttempts:ln.RATE_LIMIT.MAX_ATTEMPTS,lockoutDuration:ln.RATE_LIMIT.LOCKOUT_DURATION_MINUTES,windowSize:ln.RATE_LIMIT.WINDOW_SIZE_MINUTES};class C_{constructor(e={}){this.config=Hr(Hr({},P_),e),this.distributedLimiter=new Je({maxRequests:this.config.maxAttempts,windowMs:this.config.windowSize*60*1e3,keyPrefix:"auth",blockDurationMs:this.config.lockoutDuration*60*1e3})}checkRateLimit(e){return jn(this,null,function*(){try{const t=yield this.distributedLimiter.checkRateLimit(e);if(!t.allowed)return{isLocked:!0,remainingAttempts:0,lockoutTime:t.resetTime,error:`Too many failed attempts. Please try again in ${t.retryAfter||0} seconds.`};const{data:r,error:i}=yield d.from("login_attempts").select("*").eq("email",e).gte("attempted_at",new Date(Date.now()-this.config.windowSize*60*1e3).toISOString()).order("attempted_at",{ascending:!1}),o=(r||[]).filter(s=>!s.success);if(o.length>=this.config.maxAttempts){const s=o[0],a=new Date(s.attempted_at);if(a.setMinutes(a.getMinutes()+this.config.lockoutDuration),a>new Date)return{isLocked:!0,remainingAttempts:0,lockoutTime:a.getTime(),error:"Account temporarily locked due to repeated failed attempts. Please try again later."}}return{isLocked:!1,remainingAttempts:t.remaining}}catch(t){return{isLocked:!1,remainingAttempts:this.config.maxAttempts}}})}recordAttempt(e,t,r){return jn(this,null,function*(){try{const{error:i}=yield d.from("login_attempts").insert({email:e,success:t,attempted_at:new Date().toISOString(),ip_address:r||"unknown",user_agent:navigator.userAgent})}catch(i){}})}resetRateLimit(e){return jn(this,null,function*(){try{yield this.distributedLimiter.resetRateLimit(e);const{error:t}=yield d.from("login_attempts").delete().eq("email",e)}catch(t){}})}getConfig(){return Hr({},this.config)}updateConfig(e){this.config=Hr(Hr({},this.config),e)}}const Cw=new C_;const Dw=c=>{try{console.log("[AUDIT]",c)}catch(e){}},D_=600*1e3,De={MAX_LIFECYCLE:95,MIN_LIFECYCLE:10,LIFECYCLE_MULTIPLIER:2.5,ANALYSIS_DAYS:90,MAX_CYCLES_PER_DAY:.1,MIN_CONFIDENCE:.6,MAX_CONFIDENCE:.95,CONFIDENCE_BASE:.75,REORDER_DAYS_BEFORE_EOL:30,MIN_REORDER_DAYS:7},Z={ANALYSIS_DAYS:30,RECENT_ANALYSIS_DAYS:7,MAX_CAPACITY_PER_DAY:24,MIN_LOAD_PERCENTAGE:10,MAX_LOAD_PERCENTAGE:100,HIGH_USAGE_THRESHOLD:20,MEDIUM_USAGE_THRESHOLD:15,HIGH_OVERLOAD_DAYS:15,MEDIUM_OVERLOAD_DAYS:45,LOW_OVERLOAD_DAYS:90,HIGH_LOAD_THRESHOLD:90,MEDIUM_LOAD_THRESHOLD:75,LOW_LOAD_THRESHOLD:60,HIGH_QUEUE_THRESHOLD:5,HIGH_FAILURE_RATE:.1,PATIENT_LOAD_MULTIPLIER:1.2},Gs={ANALYSIS_DAYS:365,PROJECTION_MONTHS:.5},Gt={ANALYSIS_DAYS:30,DEFAULT_FTE:8.5,WORKLOAD_INCREASE_THRESHOLD:20,FTE_INCREASE:.5,COST_PER_FTE:5e4},Wt={ANALYSIS_DAYS:30,GROWTH_RATE:1.1,INCIDENT_RATE:.3,HIGH_WORKLOAD_THRESHOLD:20,MEDIUM_WORKLOAD_THRESHOLD:10,HIGH_COVERAGE_THRESHOLD:15},lr={IMMEDIATE:"Immediate",Q1_2025:"Q1 2025",Q2_2025:"Q2 2025",Q3_2025:"Q3 2025",NEXT_QUARTER:"Next quarter",MONITOR_3_MONTHS:"Monitor for 3 months"},Li={ADD_AUTOCLAVE:"add_autoclave",EXTEND_HOURS:"extend_hours",OPTIMIZE_SCHEDULE:"optimize_schedule"},Vn={LOW:"low",MEDIUM:"medium",HIGH:"high"};var O_=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class ur{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return ur.instance||(ur.instance=new ur),ur.instance}getToolReplacementForecast(){return O_(this,arguments,function*(e={}){try{const t=`tool_replacement_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for tool replacement forecast"),[];const{data:i,error:n}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-De.ANALYSIS_DAYS*24*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(n||!i||i.length===0)return console.warn("No sterilization data found for tool replacement forecast"),[];const o=i.slice(0,5).map((s,a)=>{var l;const u=i.filter(w=>w.tool_batch_id===s.tool_batch_id).length,h=Math.min(De.MAX_LIFECYCLE,Math.max(De.MIN_LIFECYCLE,Math.floor(u*De.LIFECYCLE_MULTIPLIER))),f=u/De.ANALYSIS_DAYS,p=Math.max(0,100-h)/Math.max(De.MAX_CYCLES_PER_DAY,f),g=new Date(Date.now()+p*24*60*60*1e3).toISOString().split("T")[0],y=Math.min(De.MAX_CONFIDENCE,Math.max(De.MIN_CONFIDENCE,De.CONFIDENCE_BASE+u/100)),_=new Date(Date.now()+Math.max(De.MIN_REORDER_DAYS,p-De.REORDER_DAYS_BEFORE_EOL)*24*60*60*1e3).toISOString().split("T")[0];return{toolBatchId:(l=s.tool_batch_id)!=null?l:`TB${String(a+1).padStart(3,"0")}`,toolName:`Tool Set ${String.fromCharCode(65+a)}`,currentLifecycle:h,predictedEndOfLife:g,confidence:y,recommendedReorderDate:_,supplierSuggestion:"Contact procurement for supplier information",estimatedCost:0}});return this.setCachedData(t,o),o}catch(t){return console.error("Error forecasting tool replacement:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var R_=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class dr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return dr.instance||(dr.instance=new dr),dr.instance}getAutoclaveCapacityForecast(){return R_(this,arguments,function*(e={}){try{const t=`autoclave_capacity_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for autoclave capacity forecast"),[];const{data:i,error:n}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).not("autoclave_id","is",null).gte("created_at",new Date(Date.now()-Z.ANALYSIS_DAYS*24*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(n||!i||i.length===0)return console.warn("No autoclave data found for capacity forecast"),[];const{data:o,error:s}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-Z.RECENT_ANALYSIS_DAYS*24*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(s)return console.warn("Failed to fetch recent cycles for autoclave capacity forecast"),[];const a=i.reduce((u,h)=>{var f;const m=(f=h.autoclave_id)!=null?f:"";return m&&(u[m]||(u[m]=[]),u[m].push(h)),u},{}),l=Object.entries(a).map(([u,h])=>{const f=h.length,m=h.filter(B=>B.status==="clean").length,p=h.filter(B=>B.status==="problem").length,g=f/Z.ANALYSIS_DAYS,y=Z.MAX_CAPACITY_PER_DAY,_=Math.min(Z.MAX_LOAD_PERCENTAGE,Math.max(Z.MIN_LOAD_PERCENTAGE,Math.round(g/y*100))),b=((o==null?void 0:o.filter(B=>B.autoclave_id===u&&B.status==="pending"||B.status==="in_progress"))||[]).length,E=g>Z.HIGH_USAGE_THRESHOLD?"high":g>Z.MEDIUM_USAGE_THRESHOLD?"medium":"low",C=E==="high"?Z.HIGH_OVERLOAD_DAYS:E==="medium"?Z.MEDIUM_OVERLOAD_DAYS:Z.LOW_OVERLOAD_DAYS,S=new Date(Date.now()+C*24*60*60*1e3).toISOString().split("T")[0];let Q,Y;return _>Z.HIGH_LOAD_THRESHOLD||p>f*Z.HIGH_FAILURE_RATE?(Q=Li.ADD_AUTOCLAVE,Y=lr.IMMEDIATE):_>Z.MEDIUM_LOAD_THRESHOLD||b>Z.HIGH_QUEUE_THRESHOLD?(Q=Li.EXTEND_HOURS,Y=lr.Q1_2025):_>Z.LOW_LOAD_THRESHOLD?(Q=Li.OPTIMIZE_SCHEDULE,Y=lr.Q2_2025):(Q=Li.OPTIMIZE_SCHEDULE,Y=lr.Q3_2025),{autoclaveId:u,currentLoadPercentage:_,queueLength:b,predictedOverloadDate:S,recommendedAction:Q,timeline:Y,projectedPatientLoad:Math.round(m*Z.PATIENT_LOAD_MULTIPLIER)}});return this.setCachedData(t,l),l}catch(t){return console.error("Error forecasting autoclave capacity:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var $_=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class hr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return hr.instance||(hr.instance=new hr),hr.instance}getInventoryInflationForecast(){return $_(this,arguments,function*(e={}){try{const t=`inventory_inflation_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for inventory inflation forecast"),[];const i=yield _r.getItems();let n=i;e.facilityId&&(n=i.filter(l=>l.facility_id===e.facilityId));const o=new Date(Date.now()-Gs.ANALYSIS_DAYS*24*60*60*1e3);if(n=n.filter(l=>l.created_at&&new Date(l.created_at)>=o),n.sort((l,u)=>new Date(u.created_at||"").getTime()-new Date(l.created_at||"").getTime()),!n||n.length===0)return console.warn("No inventory data found for inflation forecast"),[];const s=n.reduce((l,u)=>{var h,f;const m=(f=(h=u.data)==null?void 0:h.category)!=null?f:"Uncategorized";return l[m]||(l[m]=[]),l[m].push(u),l},{}),a=Object.entries(s).map(([l,u])=>{var h,f;const m=u.map(w=>{var b;return((b=w.data)==null?void 0:b.unit_cost)||0}).filter(w=>w>0);if(m.length===0)return null;const p=(h=m[m.length-1])!=null?h:0,g=(f=m[0])!=null?f:0,y=p-g,_=g>0?y/g*100:0;return{category:l,currentPrice:p,priceIncrease:y,inflationRate:_,projectedYearEndPrice:p*(1+_/100*Gs.PROJECTION_MONTHS),cheaperSupplierExists:!1,alternativeSupplier:void 0,costSavings:0}}).filter(Boolean);return this.setCachedData(t,a),a}catch(t){return console.error("Error forecasting inventory inflation:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var M_=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class fr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return fr.instance||(fr.instance=new fr),fr.instance}getClinicalStaffingForecast(){return M_(this,arguments,function*(e={}){try{const t=`clinical_staffing_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for clinical staffing forecast"),[];const{data:i,error:n}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-Gt.ANALYSIS_DAYS*24*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(n||!i||i.length===0)return console.warn("No sterilization data found for clinical staffing forecast"),[];const o=i.length,s=i.filter(f=>f.status!=="clean"&&f.status!=="problem").length,a=Gt.DEFAULT_FTE,l=Math.max(0,s/o*100),u=l>Gt.WORKLOAD_INCREASE_THRESHOLD?a+Gt.FTE_INCREASE:a,h=[{currentFTE:a,recommendedFTE:u,timeline:l>Gt.WORKLOAD_INCREASE_THRESHOLD?lr.NEXT_QUARTER:lr.MONITOR_3_MONTHS,workloadIncrease:l,skillsetGaps:[],trainingRecommendations:[],estimatedCost:Math.round((u-a)*Gt.COST_PER_FTE)}];return this.setCachedData(t,h),h}catch(t){return console.error("Error forecasting clinical staffing:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var q_=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class mr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return mr.instance||(mr.instance=new mr),mr.instance}getAdminStaffingForecast(){return q_(this,arguments,function*(e={}){try{const t=`admin_staffing_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for admin staffing forecast"),[];const{data:i,error:n}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-Wt.ANALYSIS_DAYS*24*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(n||!i||i.length===0)return console.warn("No sterilization data found for admin staffing forecast"),[];const o=i.length,s=i.filter(g=>g.status!=="clean"&&g.status!=="problem").length,a=o,l=Math.round(o*Wt.GROWTH_RATE),u=Math.max(0,l-a),h=Math.floor(s*Wt.INCIDENT_RATE),f=s>0?Math.max(1,Math.floor(s/2)):0;let m;u>Wt.HIGH_WORKLOAD_THRESHOLD?m=Vn.HIGH:u>Wt.MEDIUM_WORKLOAD_THRESHOLD?m=Vn.MEDIUM:m=Vn.LOW;const p=[{currentWorkload:a,projectedWorkload:l,workloadExcess:u,recommendedCoverage:u>Wt.HIGH_COVERAGE_THRESHOLD?"Additional 0.5 FTE admin support":"Current staffing adequate",qualityIncidents:h,resolutionLag:f,priority:m}];return this.setCachedData(t,p),p}catch(t){return console.error("Error forecasting admin staffing:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var z_=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class pr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return pr.instance||(pr.instance=new pr),pr.instance}getTheftLossEstimate(){return z_(this,arguments,function*(e={}){try{const t=`theft_loss_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for theft/loss estimation"),{estimatedLossPercentage:0,estimatedLossValue:0,flaggedItems:[],repeatOffenders:[],riskFactors:[],recommendedActions:[],confidence:0};const{data:i,error:n}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(n||!i||i.length===0)return console.warn("No sterilization data found for theft/loss estimation"),{estimatedLossPercentage:0,estimatedLossValue:0,flaggedItems:[],repeatOffenders:[],riskFactors:[],recommendedActions:[],confidence:0};const o=i.length,s=i.filter(f=>f.status!=="clean"&&f.status!=="problem").length,a=Math.min(10,Math.max(0,s/o*100)),l=Math.round(a*1e3),u=i.filter(f=>f.status!=="clean").map(f=>`Tool ${f.id}`).slice(0,3),h={estimatedLossPercentage:Math.round(a*10)/10,estimatedLossValue:l,flaggedItems:u.length>0?u:["No specific items flagged"],repeatOffenders:[],riskFactors:s>0?["Incomplete sterilization cycles","Missing cycle documentation","Protocol non-compliance"]:["Minimal risk factors detected"],recommendedActions:["Complete incomplete sterilization cycles","Review cycle documentation procedures","Monitor compliance metrics"],confidence:Math.max(.5,1-a/100)};return this.setCachedData(t,h),h}catch(t){return console.error("Error estimating theft/loss:",t),{estimatedLossPercentage:0,estimatedLossValue:0,flaggedItems:[],repeatOffenders:[],riskFactors:[],recommendedActions:[],confidence:0}}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var U_=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class gr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return gr.instance||(gr.instance=new gr),gr.instance}getSupplyDepletionForecast(){return U_(this,arguments,function*(e={}){try{const t=`supply_depletion_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for supply depletion forecast"),[];const i=yield _r.getItems();let n=i;if(e.facilityId&&(n=i.filter(s=>s.facility_id===e.facilityId)),n.sort((s,a)=>(s.quantity||0)-(a.quantity||0)),!n||n.length===0)return console.warn("No inventory data found for supply depletion forecast"),[];const o=n.slice(0,8).map((s,a)=>{var l,u,h,f,m,p,g;const y=(l=s.quantity)!=null?l:0,_=(h=(u=s.data)==null?void 0:u.reorder_point)!=null?h:100,w=(m=(f=s.data)==null?void 0:f.unit_cost)!=null?m:50;let b;y<=_*.5?b="critical":y<=_*.8?b="high":y<=_*1.2?b="medium":b="low";const E=Math.ceil(y/(_/30)),C=new Date(Date.now()+E*24*60*60*1e3),S=new Date(C.getTime()-10080*60*1e3);return{itemName:(p=s.name)!=null?p:`Item ${a+1}`,currentStock:y,depletionDate:C.toISOString().split("T")[0],reorderUrgency:b,recommendedReorderDate:S.toISOString().split("T")[0],currentCost:w,historicalCosts:[w*.95,w*.98,w],costTrend:w>(((g=s.data)==null?void 0:g.last_restocked_cost)||w)?"increasing":"stable"}});return this.setCachedData(t,o),o}catch(t){return console.error("Error forecasting supply depletion:",t),[]}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var N_=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class yr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return yr.instance||(yr.instance=new yr),yr.instance}getEfficiencyROITracker(){return N_(this,arguments,function*(e={}){try{const t=`efficiency_roi_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for efficiency ROI tracking"),null;const{data:i,error:n}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(n||!i||i.length===0)return console.warn("No sterilization data found for efficiency ROI tracking"),null;const o=i.length,s=i.filter(m=>m.status==="clean").length,a=o>0?s/o*100:0,l=Math.round(a/100*40),u=l*42,h=u*12,f={timeSavedHours:l,estimatedLaborSavings:u,aiFeatureUsage:[{feature:"Automated scheduling",usageCount:Math.floor(o*.8),timeSaved:Math.round(l*.3)},{feature:"Smart inventory alerts",usageCount:Math.floor(o*.6),timeSaved:Math.round(l*.2)},{feature:"Predictive maintenance",usageCount:Math.floor(o*.4),timeSaved:Math.round(l*.1)}],automationEfficiency:Math.round(a),moduleContributions:[{module:"Sterilization",timeSaved:Math.round(l*.5),costSavings:Math.round(u*.5),efficiency:Math.round(a)},{module:"Inventory",timeSaved:Math.round(l*.3),costSavings:Math.round(u*.3),efficiency:Math.round(a*.9)},{module:"Environmental",timeSaved:Math.round(l*.2),costSavings:Math.round(u*.2),efficiency:Math.round(a*.8)}],projectedAnnualSavings:h};return this.setCachedData(t,f),f}catch(t){return console.error("Error tracking efficiency ROI:",t),null}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}function F_(c){const e=new Array(24).fill(0);c.forEach(i=>{if(i.created_at){const n=new Date(i.created_at).getHours();e[n]++}});const t=Math.max(...e),r=e.map((i,n)=>({count:i,hour:n})).filter(({count:i})=>i>=t*.8).map(({hour:i})=>`${i.toString().padStart(2,"0")}:00`).slice(0,4);return r.length>0?r:["09:00","12:00","15:00"]}function L_(c){return c>=90?"Excellent utilization - maintain current practices":c>=80?"Good utilization - minor optimizations possible":c>=70?"Moderate utilization - consider schedule optimization":"Low utilization - review tool allocation and scheduling"}function x_(c){const e=[];return c<80&&e.push("Low utilization efficiency"),c<70&&e.push("Significant idle time detected"),e.length>0?e:["Minimal bottlenecks detected"]}var Hn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class pt{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return pt.instance||(pt.instance=new pt),pt.instance}getToolTurnoverUtilization(){return Hn(this,arguments,function*(e={}){try{const t=`tool_turnover_utilization_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for tool turnover utilization"),[];const{data:i,error:n}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(n||!i||i.length===0)return console.warn("No sterilization data found for tool turnover utilization"),[];const o=i.reduce((a,l)=>{var u;const h=(u=l.tool_batch_id)!=null?u:"";return h&&(a[h]||(a[h]=[]),a[h].push(l)),a},{}),s=Object.entries(o).map(([a,l])=>{const u=l.length,h=Math.min(100,u/7*100),f=u/7,m=F_(l),p=Math.min(100,Math.max(50,h)),g=f,y=Math.max(0,100-p);return{toolBatchId:a,toolName:`Tool ${a}`,dailyCycleCount:u,weeklyUtilization:h,averageCyclesPerDay:f,peakUsageHours:m,utilizationEfficiency:p,turnoverRate:g,idleTimePercentage:y,recommendedOptimization:L_(p),bottleneckIndicators:x_(p),performanceScore:Math.round(p)}});return this.setCachedData(t,s),s}catch(t){return console.error("Error analyzing tool turnover utilization:",t),[]}})}getSterilizationMetrics(){return Hn(this,arguments,function*(e={}){try{if(!e.facilityId)return{biPassRate:0,cycleEfficiency:0,qualityScore:0};const{data:t}=yield d.from("bi_test_results").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString()),{data:r}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString());let i=100;if(t&&t.length>0){const s=Array.isArray(t)?t.filter(a=>a.result==="pass").length:0;i=Math.round(s/t.length*100)}let n=100;if(r&&r.length>0){const s=r.filter(a=>a.status==="clean").length;n=Math.round(s/r.length*100)}const o=Math.round((i+n)/2);return{biPassRate:i,cycleEfficiency:n,qualityScore:o}}catch(t){return console.error("Error getting sterilization metrics:",t),{biPassRate:0,cycleEfficiency:0,qualityScore:0}}})}getInventoryMetrics(){return Hn(this,arguments,function*(e={}){try{if(!e.facilityId)return{turnoverRate:0,stockLevel:0,reorderEfficiency:0};const t=yield _r.getItems();let r=t;e.facilityId&&(r=t.filter(s=>s.facility_id===e.facilityId));let i=80;if(r&&r.length>0){const s=r.filter(l=>{var u;return((u=l.status)!=null?u:"")==="active"}).length,a=r.length;a>0&&(i=Math.round(s/a*100))}let n=100;if(r&&r.length>0){const s=r.filter(a=>{var l;return a.quantity>((l=a.reorder_point)!=null?l:0)}).length;n=Math.round(s/r.length*100)}const o=Math.round((i+n)/2);return{turnoverRate:i,stockLevel:n,reorderEfficiency:o}}catch(t){return console.error("Error getting inventory metrics:",t),{turnoverRate:0,stockLevel:0,reorderEfficiency:0}}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var Ws=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Dt{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=3e5}static getInstance(){return Dt.instance||(Dt.instance=new Dt),Dt.instance}getAuditRiskScore(){return Ws(this,arguments,function*(e={}){try{const t=`audit_risk_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for audit risk score"),null;const{data:i,error:n}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-10080*60*1e3).toISOString()).order("created_at",{ascending:!1});if(n||!i)return console.warn("Failed to fetch sterilization data for audit risk assessment"),null;const o=i.length,s=i.filter(g=>g.status!=="clean"&&g.status!=="problem").length,{data:a,error:l}=yield d.from("biological_indicators").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-10080*60*1e3).toISOString()),u=l||!a?0:Array.isArray(a)?a.filter(g=>g.status==="skipped"||g.status==="pending").length:0,h=Math.max(0,s/o*100),f=Math.min(100,Math.max(0,s/o*40+u*15+h*.4));let m;f>=80?m="critical":f>=60?m="high":f>=40?m="medium":m="low";const p={overallRiskScore:Math.round(f),riskLevel:m,riskFactors:[{factor:"Incomplete cycles",severity:Math.min(10,Math.max(1,Math.round(s/o*10))),description:`${s} sterilization cycles incomplete this week`},{factor:"Policy adherence",severity:Math.min(10,Math.max(1,Math.round((100-h)/10))),description:`Protocol adherence at ${Math.round(100-h)}%`}],skippedIndicators:u,incompleteCycles:s,policyDrift:h,recommendedActions:["Complete incomplete sterilization cycles","Review and reinforce protocol training","Monitor BI/CI test completion rates"]};return this.setCachedData(t,p),p}catch(t){return console.error("Error assessing audit risk:",t),null}})}getTrainingKnowledgeGaps(){return Ws(this,arguments,function*(e={}){try{const t=`training_gaps_${JSON.stringify(e)}`,r=this.getCachedData(t);if(r)return r;if(!e.facilityId||e.facilityId.trim()==="")return console.warn("No facility ID provided for training knowledge gaps"),null;const{data:i,error:n}=yield d.from("sterilization_cycles").select("*").eq("facility_id",e.facilityId).gte("created_at",new Date(Date.now()-720*60*60*1e3).toISOString()).order("created_at",{ascending:!1});if(n||!i||i.length===0)return console.warn("No sterilization data found for training gap analysis"),null;const o=i.reduce((m,p)=>{var g,y,_,w,b,E;const C=(y=(g=p.operator_id)!=null?g:p.user_id)!=null?y:"";return C&&(m[C]||(m[C]={cycles:[],failedSteps:[],performanceMetrics:[]}),m[C].cycles.push(p),p.status!=="clean"&&m[C].failedSteps.push(`Cycle ${p.id} - ${p.status}`),p.status==="clean"&&m[C].performanceMetrics.push({cycleId:(_=p.id)!=null?_:"",duration:(w=p.duration_minutes)!=null?w:0,temperature:(b=p.temperature_celsius)!=null?b:0,pressure:(E=p.pressure_psi)!=null?E:0})),m},{}),s=Object.entries(o).map(([m,p])=>{const g=p.failedSteps.length>0,y=p.performanceMetrics.length>0?p.performanceMetrics.reduce((w,b)=>w+b.duration,0)/p.performanceMetrics.length:0;let _=[];return g?_=["Review sterilization protocols","Complete cycle documentation training","Practice emergency shutdown procedures"]:y>60?_=["Optimize cycle timing procedures","Review load preparation best practices","Efficiency improvement training"]:_=["Maintain current training standards","Advanced sterilization techniques","Quality assurance best practices"],{userId:m,userName:`User ${m}`,failedSteps:p.failedSteps.slice(0,3),skippedContent:[],recommendedTraining:_,performanceMetrics:{totalCycles:p.cycles.length,successRate:p.cycles.length>0?(p.cycles.length-p.failedSteps.length)/p.cycles.length*100:100,averageDuration:Math.round(y)}}}),a=s.length,l=s.filter(m=>m.failedSteps.length>0).length,u=a>0?s.reduce((m,p)=>m+p.performanceMetrics.successRate,0)/a:100,h=Math.min(100,Math.max(0,l/a*40+(100-u)/100*30+(a<3?20:0)+(s.some(m=>m.performanceMetrics.averageDuration>60)?10:0))),f={usersWithGaps:s,overallGapScore:Math.round(h),criticalGaps:s.filter(m=>m.failedSteps.length>2||m.performanceMetrics.successRate<80).map(()=>"Sterilization protocol adherence"),knowledgeHubRecommendations:["Review sterilization SOPs","Complete cycle documentation training","Monitor user performance metrics","Efficiency optimization training","Quality assurance procedures"]};return this.setCachedData(t,f),f}catch(t){return console.error("Error analyzing training gaps:",t),null}})}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}var be=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Qr{constructor(){this.cache=new Map,this.DEFAULT_CACHE_TTL=D_}static getInstance(){return Qr.instance||(Qr.instance=new Qr),Qr.instance}getToolReplacementForecast(){return be(this,arguments,function*(e={}){return ur.getInstance().getToolReplacementForecast(e)})}getAutoclaveCapacityForecast(){return be(this,arguments,function*(e={}){return dr.getInstance().getAutoclaveCapacityForecast(e)})}getInventoryInflationForecast(){return be(this,arguments,function*(e={}){return hr.getInstance().getInventoryInflationForecast(e)})}getClinicalStaffingForecast(){return be(this,arguments,function*(e={}){return fr.getInstance().getClinicalStaffingForecast(e)})}getAdminStaffingForecast(){return be(this,arguments,function*(e={}){return mr.getInstance().getAdminStaffingForecast(e)})}getTheftLossEstimate(){return be(this,arguments,function*(e={}){return pr.getInstance().getTheftLossEstimate(e)})}getSupplyDepletionForecast(){return be(this,arguments,function*(e={}){return gr.getInstance().getSupplyDepletionForecast(e)})}getToolTurnoverUtilization(){return be(this,arguments,function*(e={}){return pt.getInstance().getToolTurnoverUtilization(e)})}getAuditRiskScore(){return be(this,arguments,function*(e={}){return Dt.getInstance().getAuditRiskScore(e)})}getTrainingKnowledgeGaps(){return be(this,arguments,function*(e={}){return Dt.getInstance().getTrainingKnowledgeGaps(e)})}getEfficiencyROITracker(){return be(this,arguments,function*(e={}){return yr.getInstance().getEfficiencyROITracker(e)})}getIntelligenceSummary(){return be(this,arguments,function*(e={},t=!1){try{const r=`intelligence_summary_${JSON.stringify(e)}`;t&&this.clearCache("intelligence_summary");const i=this.getCachedData(r);if(i&&!t)return i;const[n,o,s,a,l,u,h,f,m,p,g,y,_]=yield Promise.all([this.getToolReplacementForecast(e),this.getAutoclaveCapacityForecast(e),this.getInventoryInflationForecast(e),this.getClinicalStaffingForecast(e),this.getAdminStaffingForecast(e),this.getTheftLossEstimate(e),this.getSupplyDepletionForecast(e),this.getToolTurnoverUtilization(e),this.getAuditRiskScore(e),this.getTrainingKnowledgeGaps(e),this.getEfficiencyROITracker(e),pt.getInstance().getSterilizationMetrics(e),pt.getInstance().getInventoryMetrics(e)]),w=a[0]||null,b=l[0]||null,E={toolReplacement:n,autoclaveCapacity:o,inventoryInflation:s,clinicalStaffing:w,adminStaffing:b,theftLoss:u,supplyDepletion:h,toolTurnoverUtilization:f,auditRisk:m||{overallRiskScore:0,riskLevel:"low",riskFactors:[],skippedIndicators:0,incompleteCycles:0,policyDrift:0,recommendedActions:[]},trainingGaps:p||{usersWithGaps:[],overallGapScore:0,criticalGaps:[],knowledgeHubRecommendations:[]},efficiencyROI:g||{timeSavedHours:0,estimatedLaborSavings:0,aiFeatureUsage:[],automationEfficiency:0,moduleContributions:[],projectedAnnualSavings:0},sterilization:y,inventory:_,lastUpdated:new Date().toISOString(),confidence:.89};return this.setCachedData(r,E),E}catch(r){throw console.error("Error generating intelligence summary:",r),r}})}clearCache(e){e?Array.from(this.cache.keys()).filter(r=>r.startsWith(e)).forEach(r=>this.cache.delete(r)):this.cache.clear()}getCachedData(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<t.ttl?t.data:(this.cache.delete(e),null)}setCachedData(e,t,r=this.DEFAULT_CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r})}}function B_(c){return c.sort((e,t)=>{const r={critical:4,high:3,medium:2,low:1},i=r[t.priority]-r[e.priority];return i!==0?i:t.confidence-e.confidence})}function j_(c){return c.sort((e,t)=>t.priority-e.priority)}function V_(c){return c.sort((e,t)=>{const r={critical:3,high:2,medium:1,low:0};return r[t.severity]-r[e.severity]})}function H_(c){return{cost_optimization:"cost_savings",risk_mitigation:"risk_mitigation",efficiency_improvement:"efficiency",training_needed:"training",capacity_planning:"capacity",compliance_issue:"compliance"}[c]||"efficiency"}function G_(c,e){const t=(c+e)/2;return t>.9?"critical":t>.8?"high":t>.7?"medium":"low"}function W_(c){var e;return c.recommendation_reason||`AI analysis suggests ${((e=c.content_context)==null?void 0:e.category)||"optimization"} opportunities based on your usage patterns.`}function K_(c){const e=Number(c.recommendation_score)||.5;return{costSavings:e*1e3,timeSavings:e*2,riskReduction:e*50,efficiencyGain:e*30}}function Q_(c){return c.recommendation_type&&console.debug("AI recommendation type available for action items"),["Review AI-generated insights","Implement suggested optimizations","Monitor performance improvements","Provide feedback for learning"]}function Y_(c){const e=c.recommendation_score||.5;return e>.9?"Immediate":e>.8?"1-2 weeks":e>.7?"2-4 weeks":"1-2 months"}function J_(c){return c.feature_vector&&console.debug("Feature vector available for metrics extraction"),["ai_confidence","user_behavior","performance_patterns"]}function X_(c){return c>.9?"critical":c>.8?"high":c>.7?"medium":"low"}var Gn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class At{static generateHybridRecommendations(e,t,r){return Gn(this,null,function*(){var i,n;const o=[];return r&&console.debug("User insights available for recommendations"),t.forEach(s=>{var a;s.recommendation_score>.7&&o.push({id:`ai_${s.id}`,type:H_(s.recommendation_type),priority:G_(s.recommendation_score,s.confidence_level),title:s.recommendation_reason||"AI-Generated Recommendation",description:W_(s),impact:K_(s),actionItems:Q_(s),timeline:Y_(s),confidence:s.confidence_level||.8,category:((a=s.content_context)==null?void 0:a.category)||"general",relatedMetrics:J_(s)})}),((i=e.auditRisk)==null?void 0:i.riskLevel)==="critical"&&o.push(this.createCriticalAuditRecommendation(e)),(n=e.supplyDepletion)!=null&&n.some(s=>s.reorderUrgency==="critical")&&o.push(this.createCriticalSupplyRecommendation(e)),o})}static generateAIOptimizationTips(e,t,r){return Gn(this,null,function*(){const i=[];return t&&(t.skill_gaps||[]).forEach((o,s)=>{i.push({id:`ai_skill_gap_${s}`,category:"compliance",title:`Address Skill Gap: ${o}`,description:`AI analysis indicates a skill gap in ${o} that may impact performance.`,currentState:`Current skill level: ${t.learning_efficiency_score||70}%`,recommendedAction:"Complete targeted training modules and practice exercises",expectedOutcome:`Improve ${o} proficiency by 25%`,difficulty:"medium",estimatedEffort:"2-3 weeks",priority:8})}),r!=null&&r.efficiency_score&&r.efficiency_score<80&&i.push({id:"ai_efficiency_optimization",category:"sterilization",title:"Optimize Workflow Efficiency",description:"AI analysis shows workflow efficiency below optimal levels.",currentState:`Current efficiency: ${(r==null?void 0:r.efficiency_score)||70}%`,recommendedAction:"Review and optimize high-frequency workflows",expectedOutcome:"Increase efficiency by 15-20%",difficulty:"medium",estimatedEffort:"3-4 weeks",priority:7}),i})}static generateIntelligentRiskAlerts(e,t,r){return Gn(this,null,function*(){var i;const n=[];return r&&console.debug("Risk patterns available for analysis"),t.forEach(o=>{o.risk_score>.8&&n.push({id:`ai_risk_${o.id}`,severity:X_(o.risk_score),title:o.risk_title||"AI-Detected Risk",description:o.risk_description||"AI analysis has identified a potential risk.",riskFactors:o.risk_factors||[],immediateActions:o.immediate_actions||[],longTermSolutions:o.long_term_solutions||[],escalationPath:o.escalation_path||"Notify supervisor",deadline:o.deadline||"48 hours",status:"open"})}),((i=e.auditRisk)==null?void 0:i.riskLevel)==="critical"&&n.push(this.createCriticalAuditAlert(e)),n})}static generateFallbackRecommendations(e){var t;const r=[];return((t=e.auditRisk)==null?void 0:t.riskLevel)==="critical"&&r.push({id:"fallback_audit_risk",type:"compliance",priority:"critical",title:"Critical Audit Risk Mitigation Required",description:`Overall audit risk score: ${e.auditRisk.overallRiskScore}/100.`,impact:{riskReduction:60,costSavings:5e3},actionItems:["Complete missing BI logs immediately","Review incomplete cycles"],timeline:"1 week",confidence:.88,category:"compliance",relatedMetrics:["audit_scores","compliance_rates"]}),r}static generateFallbackOptimizationTips(e){var t;const r=[];return((t=e.sterilization)==null?void 0:t.biPassRate)<95&&r.push({id:"fallback_sterilization_optimization",category:"sterilization",title:"Improve BI Test Pass Rates",description:"BI test pass rates below optimal levels indicate potential issues.",currentState:`Current BI pass rate: ${e.sterilization.biPassRate}%`,recommendedAction:"Review sterilization parameters and implement quality checks",expectedOutcome:"Increase BI pass rate to 95%+",difficulty:"medium",estimatedEffort:"2-3 weeks",priority:8}),r}static generateFallbackRiskAlerts(e){var t;const r=[];return((t=e.auditRisk)==null?void 0:t.riskLevel)==="critical"&&r.push({id:"fallback_high_audit_risk",severity:"critical",title:"High Audit Risk Alert",description:`Audit risk score: ${e.auditRisk.overallRiskScore}/100.`,riskFactors:["Skipped BI indicators","Incomplete cycles"],immediateActions:["Complete missing documentation","Review procedures"],longTermSolutions:["Implement monitoring","Enhance training"],escalationPath:"Notify quality assurance team",deadline:"48 hours",status:"open"}),r}static createCriticalAuditRecommendation(e){var t,r,i;return{id:"critical_audit_risk_mitigation",type:"compliance",priority:"critical",title:"Critical Audit Risk Mitigation Required",description:`Overall audit risk score: ${(t=e.auditRisk)==null?void 0:t.overallRiskScore}/100. ${(r=e.auditRisk)==null?void 0:r.skippedIndicators} skipped indicators and ${(i=e.auditRisk)==null?void 0:i.incompleteCycles} incomplete cycles detected.`,impact:{riskReduction:60,costSavings:5e3},actionItems:["Complete missing BI logs immediately","Review incomplete cycle procedures","Reinforce protocol training","Implement daily compliance checks"],timeline:"1 week",confidence:.88,category:"compliance",relatedMetrics:["audit_scores","compliance_rates","protocol_adherence"]}}static createCriticalSupplyRecommendation(e){var t;const r=((t=e.supplyDepletion)==null?void 0:t.filter(i=>i.reorderUrgency==="critical"))||[];return{id:"critical_supply_alert",type:"risk_mitigation",priority:"critical",title:`Critical Supply Alert: ${r.length} Items`,description:`${r.length} critical supplies will deplete within 7 days, risking operational disruption.`,impact:{costSavings:r.reduce((i,n)=>i+Number(n.currentCost||0)*.2,0),riskReduction:95},actionItems:["Place emergency orders immediately","Contact alternative suppliers","Implement usage restrictions","Notify clinical staff"],timeline:"Immediate",confidence:.95,category:"inventory_management",relatedMetrics:["stock_levels","usage_rates","supplier_performance"]}}static createCriticalAuditAlert(e){var t;return{id:"critical_audit_risk_alert",severity:"critical",title:"Critical Audit Risk Alert",description:`Audit risk score: ${(t=e.auditRisk)==null?void 0:t.overallRiskScore}/100. Multiple compliance issues detected requiring immediate attention.`,riskFactors:["Skipped BI indicators","Incomplete sterilization cycles","Policy drift detected"],immediateActions:["Complete missing documentation immediately","Review and complete incomplete cycles","Reinforce protocol adherence","Schedule compliance review meeting"],longTermSolutions:["Implement automated compliance monitoring","Enhance staff training programs","Establish quality assurance processes","Create compliance dashboard"],escalationPath:"Notify quality assurance team and department director",deadline:"24 hours",status:"open"}}}At.aiLearningService=new tc;var Bc=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function Z_(){return Bc(this,null,function*(){try{return[]}catch(c){return console.error("Error getting AI risk predictions:",c),[]}})}function ev(){return Bc(this,null,function*(){try{return null}catch(c){return console.error("Error getting historical risk patterns:",c),null}})}function Ks(){return{efficiency_score:85,time_saved:120,points:150,difficulty:"medium",category:"general"}}var ei=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});function tv(){return ei(this,null,function*(){try{const{data:c,error:e}=yield d.from("ai_content_recommendations").select("*").eq("is_displayed",!0).order("recommendation_score",{ascending:!1}).limit(20);return e?(console.error("Error fetching AI recommendations:",e),[]):c||[]}catch(c){return console.error("Error getting AI recommendations:",c),[]}})}function rv(){return ei(this,null,function*(){try{const{data:{user:c}}=yield d.auth.getUser();if(!c)return null;const{data:e,error:t}=yield d.from("ai_learning_insights").select("*").eq("user_id",c.id).single();return t&&t.code!=="PGRST116"?(console.error("Error fetching user insights:",t),null):e}catch(c){return console.error("Error getting user behavior insights:",c),null}})}function iv(){return ei(this,null,function*(){try{const{data:{user:c}}=yield d.auth.getUser();if(!c)return null;const{data:e,error:t}=yield d.from("ai_task_performance").select("*").eq("user_id",c.id).order("completed_at",{ascending:!1}).limit(10);return t&&t.code!=="PGRST116"?(console.error("Error fetching performance patterns:",t),Ks()):(e==null?void 0:e[0])||Ks()}catch(c){return console.error("Error getting user performance patterns:",c),null}})}function nv(){return ei(this,null,function*(){try{const{data:{user:c}}=yield d.auth.getUser();if(!c)return .5;const{data:e,error:t}=yield d.from("ai_learning_insights").select("ai_confidence_score").eq("user_id",c.id).single();return t&&t.code!=="PGRST116"?(console.error("Error fetching AI confidence score:",t),.5):Number(e==null?void 0:e.ai_confidence_score)||.5}catch(c){return console.error("Error getting AI confidence score:",c),.5}})}function av(){return ei(this,null,function*(){try{const{data:{user:c}}=yield d.auth.getUser();if(!c)return null;const{data:e,error:t}=yield d.from("knowledge_hub_user_progress").select("*").eq("user_id",c.id);return t&&t.code!=="PGRST116"?(console.error("Error fetching learning progress:",t),null):{totalCompleted:((e==null?void 0:e.filter(r=>r.status==="completed"))||[]).length,totalInProgress:((e==null?void 0:e.filter(r=>r.status==="in_progress"))||[]).length,averageScore:(e||[]).reduce((r,i)=>r+(Number(i.score)||0),0)/((e==null?void 0:e.length)||1)||0}}catch(c){return console.error("Error getting learning progress metrics:",c),null}})}var xi=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class ov{static generateRecommendations(e){return xi(this,null,function*(){try{const t=yield tv(),r=yield rv(),i=yield At.generateHybridRecommendations(e,t,r);return B_(i)}catch(t){return console.error("Error generating AI recommendations:",t),At.generateFallbackRecommendations(e)}})}static generateOptimizationTips(e){return xi(this,null,function*(){try{const t=yield this.aiLearningService.getLearningInsights(),r=yield iv(),i=yield At.generateAIOptimizationTips(e,t,r);return j_(i)}catch(t){return console.error("Error generating AI optimization tips:",t),At.generateFallbackOptimizationTips(e)}})}static generateRiskAlerts(e){return xi(this,null,function*(){try{const t=yield Z_(),r=yield ev(),i=yield At.generateIntelligentRiskAlerts(e,t,r);return V_(i)}catch(t){return console.error("Error generating AI risk alerts:",t),At.generateFallbackRiskAlerts(e)}})}static getActionableInsights(e){return xi(this,null,function*(){const t=yield this.generateRecommendations(e),r=yield this.generateOptimizationTips(e),i=yield this.generateRiskAlerts(e),n=yield nv();return{totalRecommendations:t.length,criticalItems:t.filter(o=>o.priority==="critical").length,highPriorityItems:t.filter(o=>o.priority==="high").length,totalTips:r.length,totalAlerts:i.length,criticalAlerts:i.filter(o=>o.severity==="critical").length,estimatedSavings:t.reduce((o,s)=>o+(s.impact.costSavings||0),0),estimatedTimeSavings:t.reduce((o,s)=>o+(s.impact.timeSavings||0),0),aiConfidence:n,learningProgress:yield av()}})}}ov.aiLearningService=new tc;const Bi=c=>["Courses","Procedures","Policies","Learning Pathways","Advanced"].includes(c)?c:"Courses";var Kt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class sv{static getKnowledgeArticles(){return Kt(this,null,function*(){try{return(yield new L().getKnowledgeArticles()).map(r=>({id:r.id,title:r.title,category:Bi(r.category||"Courses"),status:"draft",dueDate:r.published_at||new Date().toISOString(),progress:0,lastUpdated:r.updated_at||new Date().toISOString(),description:r.summary||"",tags:r.tags||[],createdAt:r.created_at||new Date().toISOString()}))}catch(e){throw console.error("Failed to get knowledge articles:",e),e}})}static getKnowledgeArticleById(e){return Kt(this,null,function*(){try{const r=yield new L().getArticleById(e);if(r.error||!r.data)return null;const i=r.data;return{id:i.id,title:i.title,category:Bi(i.category||"Courses"),status:"draft",dueDate:i.published_at||new Date().toISOString(),progress:0,lastUpdated:i.updated_at||new Date().toISOString(),description:i.summary||"",tags:i.tags||[],createdAt:i.created_at||new Date().toISOString()}}catch(t){throw console.error("Failed to get knowledge article by ID:",t),t}})}static createKnowledgeArticle(e){return Kt(this,null,function*(){try{const r=yield new L().createArticle({title:e.title,content:e.description||"",summary:e.description||"",category:e.category,tags:e.tags||[],status:"draft"});if(r.error)throw new Error(r.error);if(!r.article)throw new Error("Failed to create article");return{id:r.article.id,title:r.article.title,category:Bi(r.article.category||"Courses"),status:r.article.status,dueDate:r.article.published_at||new Date().toISOString(),progress:0,lastUpdated:r.article.updated_at,description:r.article.summary,tags:r.article.tags,createdAt:r.article.created_at}}catch(t){throw console.error("Failed to create knowledge article:",t),t}})}static updateKnowledgeArticle(e,t){return Kt(this,null,function*(){try{const r=new L,i={};t.title&&(i.title=t.title),t.description&&(i.summary=t.description),t.category&&(i.category_id=t.category),t.tags&&(i.tags=t.tags),t.status&&(i.status=t.status==="review"?"published":"draft");const n=yield r.updateArticle(e,i);if(n.error)throw new Error(n.error);if(!n.article)throw new Error("No article returned from update");return{id:n.article.id,title:n.article.title,category:Bi(n.article.category),status:n.article.status,dueDate:n.article.published_at||new Date().toISOString(),progress:0,description:n.article.summary,tags:n.article.tags,createdAt:n.article.created_at,lastUpdated:n.article.updated_at}}catch(r){throw console.error("Failed to update knowledge article:",r),r}})}static deleteKnowledgeArticle(e){return Kt(this,null,function*(){try{const r=yield new L().deleteArticle(e);if(r.error)throw new Error(r.error)}catch(t){throw console.error("Failed to delete knowledge article:",t),t}})}static updateContentStatus(e,t){return Kt(this,null,function*(){try{const r=new L;let i;switch(t){case"review":i="review";break;case"published":i="published";break;default:i="draft"}const n=yield r.updateArticleStatus(e,i);if(n.error)throw new Error(n.error)}catch(r){throw console.error("Failed to update content status:",r),r}})}}var ji=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Ow{static bulkUpdateContentStatus(e,t){return ji(this,null,function*(){var r;try{const i=new L;let n;switch(t){case"review":n="review";break;case"published":n="published";break;default:n="draft"}const o=yield i.bulkUpdateArticlesStatus(e,n);return{success:o.success,processedCount:o.processedCount,successCount:o.updatedCount||0,errorCount:((r=o.errors)==null?void 0:r.length)||0,errors:o.errors||[]}}catch(i){throw console.error("Failed to bulk update content status:",i),i}})}static bulkDeleteContent(e){return ji(this,null,function*(){var t;try{const i=yield new L().deleteArticles(e);return{success:i.success,processedCount:i.processedCount,successCount:i.deletedCount||0,errorCount:((t=i.errors)==null?void 0:t.length)||0,errors:i.errors||[]}}catch(r){throw console.error("Failed to bulk delete content:",r),r}})}static bulkUpdateLearningPathStatus(e,t){return ji(this,null,function*(){var r;try{const n=yield new L().bulkUpdateLearningPathsStatus(e,t);return{success:n.success,processedCount:n.processedCount,successCount:n.updatedCount||0,errorCount:((r=n.errors)==null?void 0:r.length)||0,errors:n.errors||[]}}catch(i){throw console.error("Failed to bulk update learning path status:",i),i}})}static bulkDeleteLearningPathways(e){return ji(this,null,function*(){var t;try{const i=yield new L().deleteLearningPaths(e);return{success:i.success,processedCount:i.processedCount,successCount:i.deletedCount||0,errorCount:((t=i.errors)==null?void 0:t.length)||0,errors:i.errors||[]}}catch(r){throw console.error("Failed to bulk delete learning pathways:",r),r}})}}var Qt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class cv{static getLearningPathways(){return Qt(this,null,function*(){try{return(yield new L().getLearningPathways()).map(r=>({id:r.id,title:r.title,category:"Learning Pathways",status:"draft",dueDate:r.created_at||new Date().toISOString(),progress:0,lastUpdated:r.updated_at,description:r.description,createdAt:r.created_at}))}catch(e){throw console.error("Failed to get learning pathways:",e),e}})}static getLearningPathwayById(e){return Qt(this,null,function*(){try{const r=yield new L().getLearningPathById(e);if(r.error||!r.data)return null;const i=r.data;return{id:i.id,title:i.title,category:"Learning Pathways",status:"draft",dueDate:i.created_at||new Date().toISOString(),progress:0,lastUpdated:i.updated_at,description:i.description,createdAt:i.created_at}}catch(t){throw console.error("Failed to get learning pathway by ID:",t),t}})}static createLearningPathway(e){return Qt(this,null,function*(){try{const t=new L,r={title:e.title,description:e.description||"",category:e.category,difficulty:"beginner",estimated_time:"30 minutes",is_active:!0},i=yield t.createLearningPath(r);if(i.error)throw new Error(i.error);if(!i.pathway)throw new Error("No pathway returned from creation");return{id:i.pathway.id,title:i.pathway.title,category:i.pathway.category,status:"draft",dueDate:new Date().toISOString(),progress:0,description:i.pathway.description,createdAt:i.pathway.created_at,lastUpdated:i.pathway.updated_at}}catch(t){throw console.error("Failed to create learning pathway:",t),t}})}static updateLearningPathway(e,t){return Qt(this,null,function*(){try{const r=new L,i={};t.title&&(i.title=t.title),t.description&&(i.description=t.description),t.category&&(i.category=t.category);const n=yield r.updateLearningPath(e,i);if(n.error)throw new Error(n.error);if(!n.pathway)throw new Error("No pathway returned from update");return{id:n.pathway.id,title:n.pathway.title,category:n.pathway.category,status:"draft",dueDate:new Date().toISOString(),progress:0,description:n.pathway.description,createdAt:n.pathway.created_at,lastUpdated:n.pathway.updated_at}}catch(r){throw console.error("Failed to update learning pathway:",r),r}})}static deleteLearningPathway(e){return Qt(this,null,function*(){try{const r=yield new L().deleteLearningPath(e);if(r.error)throw new Error(r.error)}catch(t){throw console.error("Failed to delete learning pathway:",t),t}})}static updateLearningPathStatus(e,t){return Qt(this,null,function*(){try{const i=yield new L().updateLearningPathStatus(e,t);if(i.error)throw new Error(i.error)}catch(r){throw console.error("Failed to update learning path status:",r),r}})}}var Wn=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Rw{static getKnowledgeCategories(){return Wn(this,null,function*(){try{return(yield new L().getKnowledgeCategories()).map(r=>r.name)}catch(e){throw console.error("Failed to get knowledge categories:",e),e}})}static addCategory(e){return Wn(this,null,function*(){try{const r=yield new L().addCategory(e);if(r.error)throw new Error(r.error);if(!r.category)throw new Error("No category returned from creation");return r.category.name}catch(t){throw console.error("Failed to add category:",t),t}})}static deleteCategory(e){return Wn(this,null,function*(){try{const r=yield new L().deleteCategory(e);if(r.error)throw new Error(r.error)}catch(t){throw console.error("Failed to delete category:",t),t}})}}var ut=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class $w{static getQuizzes(){return ut(this,null,function*(){try{const{QuizService:e}=yield T(()=>import("./knowledgehub-pages-DX_b2YG9.js").then(r=>r.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return(yield e.getAllQuizzes()).map(r=>({id:r.id,title:r.title,category:"Courses",status:r.is_active?"published":"draft",dueDate:r.created_at,progress:0,lastUpdated:r.updated_at,description:r.description||"Interactive quiz to test knowledge",tags:["quiz","assessment","knowledge-test"],createdAt:r.created_at,type:"quiz",contentType:"quiz",domain:"knowledge-assessment",isActive:r.is_active,estimatedDuration:r.time_limit_minutes||15,difficultyLevel:"medium",mandatoryRepeat:!1,passingScore:r.passing_score}))}catch(e){return console.error("Failed to get quizzes:",e),[]}})}static getQuizById(e){return ut(this,null,function*(){try{const{QuizService:t}=yield T(()=>import("./knowledgehub-pages-DX_b2YG9.js").then(r=>r.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield t.getQuizWithQuestions(e)}catch(t){return console.error("Failed to get quiz by ID:",t),null}})}static startQuizAttempt(e){return ut(this,null,function*(){try{const{QuizService:t}=yield T(()=>import("./knowledgehub-pages-DX_b2YG9.js").then(r=>r.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield t.startQuizAttempt(e)}catch(t){return console.error("Failed to start quiz attempt:",t),null}})}static submitQuizAnswers(e,t){return ut(this,null,function*(){try{const{QuizService:r}=yield T(()=>import("./knowledgehub-pages-DX_b2YG9.js").then(i=>i.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield r.submitQuizAttempt(e,t)}catch(r){return console.error("Failed to submit quiz answers:",r),{success:!1,score:0,passed:!1}}})}static getUserQuizAttempts(){return ut(this,null,function*(){try{const{QuizService:e}=yield T(()=>import("./knowledgehub-pages-DX_b2YG9.js").then(t=>t.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield e.getUserQuizAttempts()}catch(e){return console.error("Failed to get user quiz attempts:",e),[]}})}static createQuiz(e){return ut(this,null,function*(){try{const{QuizService:t}=yield T(()=>import("./knowledgehub-pages-DX_b2YG9.js").then(r=>r.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield t.createQuiz(e)}catch(t){return console.error("Failed to create quiz:",t),null}})}static updateQuiz(e,t){return ut(this,null,function*(){try{const{QuizService:r}=yield T(()=>import("./knowledgehub-pages-DX_b2YG9.js").then(i=>i.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield r.updateQuiz(e,t)}catch(r){return console.error("Failed to update quiz:",r),null}})}static deleteQuiz(e){return ut(this,null,function*(){try{const{QuizService:t}=yield T(()=>import("./knowledgehub-pages-DX_b2YG9.js").then(r=>r.q),__vite__mapDeps([10,1,2,0,4,5,6,3,7]));return yield t.deleteQuiz(e)}catch(t){return console.error("Failed to delete quiz:",t),!1}})}}var Qs=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class Mw{static getRecentUserActivity(e,t){return Qs(this,null,function*(){try{return yield new L().getRecentUserActivity(e,t)}catch(r){throw console.error("Failed to get recent user activity:",r),r}})}static getAllContent(){return Qs(this,null,function*(){try{const[e,t]=yield Promise.all([sv.getKnowledgeArticles(),cv.getLearningPathways()]);return[...e,...t]}catch(e){throw console.error("Failed to get all content:",e),e}})}}var Ee=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())});class qw{static getKnowledgeHubContent(e,t,r=10){return Ee(this,null,function*(){try{return(yield ca.getKnowledgeArticles()).filter(s=>e.includes(s.category.toLowerCase())&&t.some(a=>s.title.toLowerCase().includes(a.toLowerCase())||s.category.toLowerCase().includes(a.toLowerCase()))).map(s=>({contentId:s.id,title:s.title,category:s.category.toLowerCase(),relevance:this.calculateRelevance(s,t),lastUpdated:s.lastUpdated||new Date().toISOString(),url:`/knowledge-hub/${s.category.toLowerCase()}/${s.id}`})).sort((s,a)=>a.relevance-s.relevance).slice(0,r)}catch(i){return console.error("Error fetching Knowledge Hub content:",i),[]}})}static getAuditTrail(e,t,r,i=50){return Ee(this,null,function*(){try{const{data:{user:n}}=yield d.auth.getUser();if(!n)throw new Error("User not authenticated");const{data:o}=yield d.from("users").select("facility_id").eq("id",n.id).single(),s=(o==null?void 0:o.facility_id)||"550e8400-e29b-41d4-a716-446655440000";let a=d.from("audit_logs").select("*").eq("facility_id",s).order("timestamp",{ascending:!1}).limit(i);e&&(a=a.eq("user_id",e)),t&&(a=a.ilike("action",`%${t}%`)),r&&(a=a.gte("timestamp",r.startDate).lte("timestamp",r.endDate));const{data:l,error:u}=yield a;return u?(console.error("Error fetching audit trail:",u),[]):!l||l.length===0?[]:l.map(f=>{var m,p;return{actionId:String(f.id),timestamp:f.timestamp,userId:f.user_id,userName:(m=f.user_name)!=null?m:"Unknown User",action:f.action,details:f.metadata?JSON.stringify(f.metadata):"",impact:this.determineImpact(f.action),status:(p=f.status)!=null?p:"completed"}})}catch(n){return console.error("Error fetching audit trail:",n),[]}})}static pushKnowledgeHubNotification(e,t,r){return Ee(this,null,function*(){try{const{data:i}=yield d.from("users").select("facility_id").eq("id",e).single(),n=(i==null?void 0:i.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{error:o}=yield d.from("audit_logs").insert({user_id:e,facility_id:n,action:"Knowledge Hub Notification",details:`Notification for content ${t}: ${r}`,timestamp:new Date().toISOString(),module:"knowledge_hub"});return o?(console.error("Error logging notification:",o),!1):!0}catch(i){return console.error("Error pushing Knowledge Hub notification:",i),!1}})}static scheduleSupplierContact(e,t,r){return Ee(this,null,function*(){try{const{data:{user:i}}=yield d.auth.getUser();if(!i)throw new Error("User not authenticated");const{data:n}=yield d.from("users").select("facility_id").eq("id",i.id).single(),o=(n==null?void 0:n.facility_id)||"550e8400-e29b-41d4-a716-446655440000",{error:s}=yield d.from("audit_logs").insert({user_id:i.id,facility_id:o,action:"Supplier Contact Scheduled",details:`${t} contact with supplier ${e}, priority: ${r}`,timestamp:new Date().toISOString(),module:"supplier_management"});return s?(console.error("Error logging supplier contact:",s),!1):!0}catch(i){return console.error("Error scheduling supplier contact:",i),!1}})}static getIntegrationMetrics(){return Ee(this,null,function*(){try{const[e,t,r]=yield Promise.all([this.getKnowledgeHubCount(),this.getActiveSupplierCount(),this.getRecentAuditCount()]);return{knowledgeHubArticles:e,activeSuppliers:t,recentAuditActions:r,integrationHealth:this.calculateIntegrationHealth(e,t,r),lastSync:new Date().toISOString()}}catch(e){return console.error("Error fetching integration metrics:",e),{knowledgeHubArticles:0,activeSuppliers:0,recentAuditActions:0,integrationHealth:0,lastSync:new Date().toISOString()}}})}static syncAllIntegrations(){return Ee(this,null,function*(){try{return yield Promise.all([this.syncKnowledgeHub(),this.syncSupplierDatabase(),this.syncAuditTrail()]),!0}catch(e){return console.error("Error during integration sync:",e),!1}})}static calculateRelevance(e,t){let r=50;return t.forEach(i=>{var n,o,s;(n=e.title)!=null&&n.toLowerCase().includes(i.toLowerCase())&&(r+=20),(o=e.category)!=null&&o.toLowerCase().includes(i.toLowerCase())&&(r+=15),e.tags&&((s=e.tags)!=null&&s.some(a=>a.toLowerCase().includes(i.toLowerCase())))&&(r+=10)}),Math.min(r,100)}static calculateCostCompetitiveness(e,t){const i=Math.min(t/1e3,2);return Math.min(7*i,10)}static determineImpact(e){const t=["sterilization","bi test","critical","emergency"],r=["inventory","training","maintenance"],i=e.toLowerCase();return t.some(n=>i.includes(n))?"high":r.some(n=>i.includes(n))?"medium":"low"}static getKnowledgeHubCount(){return Ee(this,null,function*(){try{return(yield ca.getKnowledgeArticles()).length}catch(e){return console.error(e),0}})}static getActiveSupplierCount(){return Ee(this,null,function*(){try{const{data:e,error:t}=yield d.from("information_schema.tables").select("table_name").eq("table_name","inventory_suppliers").single();return 5}catch(e){return 5}})}static getRecentAuditCount(){return Ee(this,null,function*(){try{const{data:{user:e}}=yield d.auth.getUser();if(!e)return 0;const{data:t}=yield d.from("users").select("facility_id").eq("id",e.id).single(),r=(t==null?void 0:t.facility_id)||"550e8400-e29b-41d4-a716-446655440000",i=new Date;i.setDate(i.getDate()-30);const{count:n,error:o}=yield d.from("audit_logs").select("*",{count:"exact",head:!0}).eq("facility_id",r).gte("created_at",i.toISOString());return o?0:n!=null?n:0}catch(e){return console.error(e),0}})}static calculateIntegrationHealth(e,t,r){const i=Math.min(e/10,1)*30,n=Math.min(t/20,1)*30,o=Math.min(r/50,1)*40;return Math.round(i+n+o)}static syncKnowledgeHub(){return Ee(this,null,function*(){yield new Promise(e=>setTimeout(e,500))})}static syncSupplierDatabase(){return Ee(this,null,function*(){yield new Promise(e=>setTimeout(e,500))})}static syncAuditTrail(){return Ee(this,null,function*(){yield new Promise(e=>setTimeout(e,500))})}static getFallbackSuppliers(e,t){return[{supplierId:"fallback-1",name:"Medical Supply Co.",category:e,rating:4.5,deliveryTime:3,costCompetitiveness:8,reliability:9,contactInfo:{email:"contact@medsupply.com",phone:"+1-555-0123",website:"https://medsupply.com"}},{supplierId:"fallback-2",name:"Clinical Equipment Ltd.",category:e,rating:4.2,deliveryTime:5,costCompetitiveness:7.5,reliability:8.5,contactInfo:{email:"sales@clinicalequip.com",phone:"+1-555-0456",website:"https://clinicalequip.com"}}].slice(0,t)}}class zw{static applyFilters(e,t){if(!t)return e;let r=e;if(t.category&&(r=r.filter(i=>i.category===t.category)),t.status&&(r=r.filter(i=>i.status===t.status)),t.location&&(r=r.filter(i=>i.location===t.location)),t.search){const i=t.search.toLowerCase();r=r.filter(n=>n.name&&n.name.toLowerCase().includes(i)||n.category&&n.category.toLowerCase().includes(i)||n.data&&typeof n.data=="object"&&n.data!==null&&"description"in n.data&&typeof n.data.description=="string"&&n.data.description.toLowerCase().includes(i)||n.data&&typeof n.data=="object"&&n.data!==null&&"barcode"in n.data&&typeof n.data.barcode=="string"&&n.data.barcode.toLowerCase().includes(i)||n.data&&typeof n.data=="object"&&n.data!==null&&"serialNumber"in n.data&&typeof n.data.serialNumber=="string"&&n.data.serialNumber.toLowerCase().includes(i))}return r}static buildSupabaseQuery(e){let t="";return e!=null&&e.category&&(t+=`category.eq.${e.category}`),e!=null&&e.status&&(t&&(t+=","),t+=`status.eq.${e.status}`),e!=null&&e.location&&(t&&(t+=","),t+=`location.eq.${e.location}`),e!=null&&e.search&&(t&&(t+=","),t+=`or(name.ilike.%${e.search}%,category.ilike.%${e.search}%,description.ilike.%${e.search}%)`),t}static getUniqueCategories(e){return[...new Set(e.map(t=>t.category).filter(Boolean))]}static getUniqueLocations(e){return[...new Set(e.map(t=>t.location).filter(Boolean))]}static getUniqueStatuses(e){return[...new Set(e.map(t=>t.status).filter(Boolean))]}static getDefaultCategories(){return["Surgical","Dental","Supplies","Equipment","Office Hardware"]}static getDefaultLocations(){return["Main Clinic","Storage Room","Sterilization Room"]}static getDefaultStatuses(){return["active","inactive","p2","n/a"]}static validateFilters(e){const t=[];return e.category&&!this.getDefaultCategories().includes(e.category)&&t.push(`Invalid category: ${e.category}`),e.status&&!this.getDefaultStatuses().includes(e.status)&&t.push(`Invalid status: ${e.status}`),e.location&&!this.getDefaultLocations().includes(e.location)&&t.push(`Invalid location: ${e.location}`),e.search&&e.search.length<2&&t.push("Search term must be at least 2 characters long"),{isValid:t.length===0,errors:t}}}const Xi={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};var lv=Object.defineProperty,uv=Object.defineProperties,dv=Object.getOwnPropertyDescriptors,Ys=Object.getOwnPropertySymbols,hv=Object.prototype.hasOwnProperty,fv=Object.prototype.propertyIsEnumerable,Js=(c,e,t)=>e in c?lv(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,Yt=(c,e)=>{for(var t in e||(e={}))hv.call(e,t)&&Js(c,t,e[t]);if(Ys)for(var t of Ys(e))fv.call(e,t)&&Js(c,t,e[t]);return c},mv=(c,e)=>uv(c,dv(e)),bt=(c,e,t)=>new Promise((r,i)=>{var n=a=>{try{s(t.next(a))}catch(l){i(l)}},o=a=>{try{s(t.throw(a))}catch(l){i(l)}},s=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,o);s((t=t.apply(c,e)).next())}),Xs,Zs;const Zi=typeof window!="undefined";Zi&&((Xs=Xi)==null||Xs.VITE_ERROR_REPORTING_PROVIDER);class vr{static initialize(e){e&&(this.config=Yt(Yt({},this.config),e)),this.config.enabled&&this.config.provider!=="console"&&this.config.provider!=="supabase"&&!this.config.dsn&&!this.config.apiKey&&(console.warn("Error reporting provider requires DSN or API key"),this.config.provider="console"),this.isInitialized=!0,this.config.enabled&&this.config.flushInterval&&(this.flushTimer=setInterval(()=>{this.flushQueue()},this.config.flushInterval))}static reportError(e,t,r){var i,n;const o={error:e,errorInfo:t,context:Yt({timestamp:new Date().toISOString()},r)};this.errorQueue.push(o),(Zi&&((i=Xi)==null?void 0:i.MODE)==="development"||!1)&&console.error("Error reported:",o),(n=this.config)!=null&&n.maxQueueSize&&this.errorQueue.length>=this.config.maxQueueSize&&this.flushQueue()}static flushQueue(){return bt(this,null,function*(){if(this.errorQueue.length===0||!this.config.enabled)return;const e=this.errorQueue.splice(0,this.errorQueue.length);try{switch(this.config.provider){case"sentry":yield this.sendToSentry(e);break;case"logrocket":yield this.sendToLogRocket(e);break;case"bugsnag":yield this.sendToBugsnag(e);break;case"supabase":yield this.sendToSupabase(e);break;case"console":default:this.sendToConsole(e);break}}catch(t){if(console.error("Failed to send error reports:",t),t instanceof Error&&(t.message.includes("not configured")||t.message.includes("DSN")||t.message.includes("API key")))throw t;this.errorQueue.unshift(...e)}})}static sendToSentry(e){return bt(this,null,function*(){if(!this.config.dsn)throw new Error("Sentry DSN not configured");const t={dsn:this.config.dsn,environment:this.config.environment,release:this.config.release,events:e.map(r=>{var i,n,o;return{message:r.error.message,level:"error",timestamp:(i=r.context)==null?void 0:i.timestamp,tags:{component:(n=r.context)==null?void 0:n.component,page:(o=r.context)==null?void 0:o.page},extra:{stack:r.error.stack,errorInfo:r.errorInfo}}})};yield this.makeApiCall("https://o450000000000000.ingest.sentry.io/api/0/store/",{method:"POST",headers:{"Content-Type":"application/json","X-Sentry-Auth":`Sentry sentry_version=7,sentry_key=${this.config.dsn.split("@")[0]},sentry_client=cliniio/1.0`},body:JSON.stringify(t)})})}static sendToLogRocket(e){return bt(this,null,function*(){if(!this.config.apiKey)throw new Error("LogRocket API key not configured");const t={apiKey:this.config.apiKey,environment:this.config.environment,errors:e.map(r=>{var i,n,o,s;return{message:r.error.message,stack:r.error.stack,timestamp:(i=r.context)==null?void 0:i.timestamp,metadata:{component:(n=r.context)==null?void 0:n.component,page:(o=r.context)==null?void 0:o.page,userId:(s=r.context)==null?void 0:s.userId}}})};yield this.makeApiCall("https://api.logrocket.com/api/v1/errors",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(t)})})}static sendToBugsnag(e){return bt(this,null,function*(){if(!this.config.apiKey)throw new Error("Bugsnag API key not configured");const t={apiKey:this.config.apiKey,notifier:{name:"cliniio-error-reporter",version:"1.0.0"},events:e.map(r=>{var i,n,o,s;return{payloadVersion:"5",exceptions:[{errorClass:r.error.name,message:r.error.message,stacktrace:this.parseStacktrace(r.error.stack)}],breadcrumbs:[],context:(i=r.context)==null?void 0:i.component,user:(n=r.context)!=null&&n.userId?{id:r.context.userId}:void 0,metadata:{page:(o=r.context)==null?void 0:o.page,component:(s=r.context)==null?void 0:s.component}}})};yield this.makeApiCall("https://notify.bugsnag.com/",{method:"POST",headers:{"Content-Type":"application/json","X-Version":"5"},body:JSON.stringify(t)})})}static sendToSupabase(e){return bt(this,null,function*(){try{const{supabase:t}=yield T(()=>import("./components-BtXJbSH9.js").then(n=>n.aw),__vite__mapDeps([0,1,2,3,4,5,6,7])),r=e.map(n=>{var o,s,a,l;return{error_message:n.error.message,error_stack:n.error.stack,error_name:n.error.name,component:(o=n.context)==null?void 0:o.component,page:(s=n.context)==null?void 0:s.page,user_id:(a=n.context)==null?void 0:a.userId,timestamp:(l=n.context)==null?void 0:l.timestamp,environment:this.config.environment,metadata:JSON.stringify(n.errorInfo||{})}}),{error:i}=yield t.from("error_logs").insert(r);if(i)throw i}catch(t){throw console.error("Failed to send errors to Supabase:",t),t}})}static sendToConsole(e){console.group("Error Report Batch"),e.forEach((t,r)=>{console.error(`Error ${r+1}:`,t)}),console.groupEnd()}static makeApiCall(e,t){return bt(this,null,function*(){const r=new AbortController,i=setTimeout(()=>r.abort(),1e4);try{const n=yield fetch(e,mv(Yt({},t),{signal:r.signal}));if(clearTimeout(i),!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);return n}catch(n){throw clearTimeout(i),n}})}static parseStacktrace(e){return e?e.split(`
`).slice(1).map(t=>{const r=t.match(/at\s+(.+?)\s+\((.+?):(\d+):(\d+)\)/);return r?{method:r[1],file:r[2],lineNumber:parseInt(r[3]),columnNumber:parseInt(r[4])}:{file:t.trim(),lineNumber:0}}).filter(t=>t.file&&!t.file.includes("node_modules")):[]}static getStatus(){return{isInitialized:this.isInitialized,queueLength:this.errorQueue.length,config:this.config}}static updateConfig(e){this.config=Yt(Yt({},this.config),e),this.isInitialized=!0}static forceFlush(){return bt(this,null,function*(){yield this.flushQueue()})}static clearQueue(){this.errorQueue=[]}static shutdown(){this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null),this.isInitialized=!1}static reset(){var e;this.shutdown(),this.clearQueue(),this.config={provider:"console",enabled:!0,environment:Zi?((e=Xi)==null?void 0:e.MODE)||"development":"production",maxQueueSize:10,flushInterval:5e3}}}vr.isInitialized=!1;vr.errorQueue=[];vr.config={provider:"console",enabled:!0,environment:Zi?((Zs=Xi)==null?void 0:Zs.MODE)||"development":"production",maxQueueSize:10,flushInterval:5e3};vr.flushTimer=null;vr.reportError.bind(vr);export{Kh as $,Xv as A,Iv as B,iw as C,gw as D,zw as E,Ot as F,vr as G,$v as H,pm as I,Mv as J,qv as K,zv as L,Uv as M,Nv as N,Rt as O,Zv as P,Fv as Q,Bh as R,sc as S,Vp as T,Xr as U,jh as V,_c as W,Vh as X,Hh as Y,Gh as Z,Wh as _,W as a,Lv as a0,Qh as a1,Yh as a2,Jh as a3,Xh as a4,Qv as a5,sv as a6,Ow as a7,cv as a8,Rw as a9,dc as aA,ew as aB,Jv as aC,Bv as aD,xv as aE,Ty as aF,mt as aG,Yv as aH,Wr as aI,S_ as aJ,Aw as aK,cw as aL,Sw as aM,Iw as aN,Tw as aO,bw as aP,Ew as aQ,Qr as aR,ov as aS,qw as aT,ye as aU,Hp as aV,jv as aW,Wv as aX,Mw as aa,$w as ab,kw as ac,Pw as ad,Dw as ae,Cw as af,nr as ag,nw as ah,ow as ai,aw as aj,sw as ak,fc as al,y_ as am,lw as an,dw as ao,hw as ap,uw as aq,fw as ar,Np as as,mw as at,pw as au,Zo as av,yw as aw,_w as ax,vw as ay,ww as az,yt as b,Sv as c,Yr as d,J as e,wv as f,Ev as g,Av as h,Tv as i,kv as j,Pv as k,vv as l,Dv as m,Ov as n,Zc as o,Rc as p,Vv as q,Hv as r,Cv as s,ri as t,Kv as u,Gv as v,bv as w,Rv as x,tw as y,rw as z};
