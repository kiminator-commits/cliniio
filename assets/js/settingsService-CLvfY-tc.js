import{s as n}from"./login-CtXU169Q.js";import"./utils-DSBVV_PW.js";import"./vendor-DoALFvsH.js";import"./data-73RVSc-N.js";import"./ui-DETUEJ2B.js";var m=Object.defineProperty,_=Object.defineProperties,g=Object.getOwnPropertyDescriptors,h=Object.getOwnPropertySymbols,v=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable,p=(i,r,e)=>r in i?m(i,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[r]=e,y=(i,r)=>{for(var e in r||(r={}))v.call(r,e)&&p(i,e,r[e]);if(h)for(var e of h(r))w.call(r,e)&&p(i,e,r[e]);return i},P=(i,r)=>_(i,g(r)),a=(i,r,e)=>new Promise((t,s)=>{var o=u=>{try{c(e.next(u))}catch(d){s(d)}},l=u=>{try{c(e.throw(u))}catch(d){s(d)}},c=u=>u.done?t(u.value):Promise.resolve(u.value).then(o,l);c((e=e.apply(i,r)).next())});class f{constructor(){}static getInstance(){return f.instance||(f.instance=new f),f.instance}fetchUserProfile(){return a(this,null,function*(){try{const{data:{user:r},error:e}=yield n.auth.getUser();if(e||!r)throw new Error("User not authenticated");let{data:t}=yield n.from("users").select("*").eq("id",r.id).single();if(t||(t=yield this.createDefaultProfile(r)),t){const s=yield this.fetchActiveSessionsCount();return P(y({},t),{active_sessions:s})}return null}catch(r){throw console.error("Error fetching user profile:",r),r}})}createDefaultProfile(r){return a(this,null,function*(){const e={id:r.id,email:r.email||"",first_name:"",last_name:"",role:"user",phone:"",department:"",position:"",date_of_birth:"",bio:"",preferred_language:"en",timezone:"UTC",avatar_url:void 0,active_sessions:0},{data:t,error:s}=yield n.from("users").insert(e).select().single();return s?(console.error("Error creating default profile:",s),e):t})}fetchActiveSessionsCount(){return a(this,null,function*(){try{const{data:r}=yield n.from("user_sessions").select("id").eq("is_active",!0);return(r==null?void 0:r.length)||0}catch(r){return console.warn("Failed to fetch active sessions count:",r),0}})}saveProfile(r,e){return a(this,null,function*(){try{const{error:t}=yield n.from("users").update({first_name:e.first_name,last_name:e.last_name,phone:e.phone,department:e.department,position:e.position,date_of_birth:e.date_of_birth,bio:e.bio,preferred_language:e.preferred_language,timezone:e.timezone,updated_at:new Date().toISOString()}).eq("id",r);if(t)throw t;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to save profile"}}})}uploadProfilePhoto(r,e){return a(this,null,function*(){try{const t=r.name.split(".").pop(),o=`profile-photos/${`${e}-${Date.now()}.${t}`}`,{error:l}=yield n.storage.from("avatars").upload(o,r);if(l)throw l;const{data:{publicUrl:c}}=n.storage.from("avatars").getPublicUrl(o),{error:u}=yield n.from("users").update({avatar_url:c,updated_at:new Date().toISOString()}).eq("id",e);if(u)throw u;return{success:!0,url:c}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to upload photo"}}})}removeProfilePhoto(r){return a(this,null,function*(){try{const{error:e}=yield n.from("users").update({avatar_url:null,updated_at:new Date().toISOString()}).eq("id",r);if(e)throw e;return{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to remove photo"}}})}savePreferences(r,e){return a(this,null,function*(){try{const{error:t}=yield n.from("users").update({theme:e.theme,updated_at:new Date().toISOString()}).eq("id",r);if(t)throw t;return yield this.saveNotificationPreferences(r,e.notifications),{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to save preferences"}}})}saveNotificationPreferences(r,e){return a(this,null,function*(){try{localStorage.setItem(`user_${r}_notifications`,JSON.stringify(e))}catch(t){console.warn("Failed to save notification preferences:",t)}})}loadNotificationPreferences(r){return a(this,null,function*(){try{const e=localStorage.getItem(`user_${r}_notifications`);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load notification preferences:",e)}return{push:!0,sound:"gentle-chime",volume:50,vibration:"short-pulse",vibrationEnabled:!0}})}archiveAccount(r){return a(this,null,function*(){try{const{error:e}=yield n.from("users").update({is_active:!1,archived_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",r);if(e)throw e;return yield n.auth.signOut(),{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to archive account"}}})}changePassword(r,e){return a(this,null,function*(){try{const{error:t}=yield n.auth.updateUser({password:e});if(t)throw t;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to change password"}}})}refreshUserData(){return a(this,null,function*(){return this.fetchUserProfile()})}validateProfileData(r){return a(this,null,function*(){var e,t,s;const o=[];if((e=r.first_name)!=null&&e.trim()||o.push("First name is required"),(t=r.last_name)!=null&&t.trim()||o.push("Last name is required"),(s=r.email)!=null&&s.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.email)||o.push("Please enter a valid email address"):o.push("Email is required"),r.phone&&!/^[+]?[1-9][\d]{0,15}$/.test(r.phone.replace(/[\s\-()]/g,""))&&o.push("Please enter a valid phone number"),r.date_of_birth){const l=new Date(r.date_of_birth),c=new Date;l>c&&o.push("Date of birth cannot be in the future"),c.getFullYear()-l.getFullYear()>120&&o.push("Please enter a valid date of birth")}return{isValid:o.length===0,errors:o}})}}const M=f.getInstance();export{f as SettingsService,M as settingsService};
