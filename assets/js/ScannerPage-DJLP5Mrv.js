import{j as e,m as _}from"./utils-DSBVV_PW.js";import{u as T,a as b}from"./vendor-DoALFvsH.js";import{I as x,ah as $,S as D}from"./errors-CsB9ZK3e.js";import{d as w,e as j,g as k,f as q,h as B,S as z,i as U}from"./main-FsBT3Y_8.js";import{s as h}from"./login-em2Hs6UG.js";import"./ui-CbhfWbfq.js";import"./data-73RVSc-N.js";var F=Object.defineProperty,O=Object.getOwnPropertySymbols,L=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable,P=(g,s,t)=>s in g?F(g,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[s]=t,Q=(g,s)=>{for(var t in s||(s={}))L.call(s,t)&&P(g,t,s[t]);if(O)for(var t of O(s))K.call(s,t)&&P(g,t,s[t]);return g},v=(g,s,t)=>new Promise((l,i)=>{var u=a=>{try{c(t.next(a))}catch(n){i(n)}},d=a=>{try{c(t.throw(a))}catch(n){i(n)}},c=a=>a.done?l(a.value):Promise.resolve(a.value).then(u,d);c((t=t.apply(g,s)).next())});class y{static findSupabaseRoom(s){return v(this,null,function*(){var t,l,i,u,d;try{const{data:c,error:a}=yield h.from("rooms").select("*").or(`barcode.eq.${s},id.eq.${s}`).eq("is_active",!0).single();if(a||!c)return null;const n=c;return{id:n.id,barcode:n.barcode,name:n.name,department:(t=n.department)!=null?t:void 0,floor:(l=n.floor)!=null?l:void 0,building:(i=n.building)!=null?i:void 0,roomType:(u=n.room_type)!=null?u:void 0,capacity:(d=n.capacity)!=null?d:void 0,isActive:n.is_active,createdAt:n.created_at,updatedAt:n.updated_at}}catch(c){return console.error("❌ Error finding Supabase room:",c),null}})}static scanRoomBarcode(s){return v(this,null,function*(){try{if(!s||s.trim()==="")return{success:!1,message:"Please enter a valid barcode"};const t=yield this.findSupabaseRoom(s.trim());return t?(j.log("environmental_clean","room_scanned",{roomId:t.id,roomName:t.name,barcode:s,timestamp:new Date().toISOString()}),{success:!0,room:t,message:`Room "${t.name}" scanned successfully!`}):{success:!1,message:`Room with barcode "${s}" not found in system`}}catch(t){return console.error("❌ Error scanning room barcode:",t),{success:!1,message:"An error occurred while scanning the barcode. Please try again."}}})}static updateRoomStatus(s,t){return v(this,null,function*(){try{if(!s)return{success:!1,message:"Room ID is required"};if(!w.getState().getAllStatusTypes().map(p=>p.id).includes(t))return{success:!1,message:`Invalid status: ${t}`};const d=yield this.findSupabaseRoom(s);if(!d)return{success:!1,message:"Room not found in system"};const c=this.mapStatusToDatabase(t),a={status:c,updated_at:new Date().toISOString()};t==="available"&&(a.completed_time=new Date().toISOString());const{data:n}=yield h.from("environmental_cleans_enhanced").select("id").eq("room_id",s).order("created_at",{ascending:!1}).limit(1).single();if(n){const p=n,{error:o}=yield h.from("environmental_cleans_enhanced").update(a).eq("id",p.id);if(o)throw o}else{const p=Q({room_id:s,room_name:d.name,status:c,cleaning_type:"routine",scheduled_time:new Date().toISOString()},a),{error:o}=yield h.from("environmental_cleans_enhanced").insert(p);if(o)throw o}return j.log("environmental_clean","room_status_updated",{roomId:s,roomName:d.name,status:t,timestamp:new Date().toISOString()}),{success:!0,message:`Room "${d.name}" status updated to ${t}`,roomId:s,status:t}}catch(l){return console.error("❌ Error updating room status:",l),{success:!1,message:"An error occurred while updating room status. Please try again."}}})}static completeRoomCleaning(s,t){return v(this,null,function*(){var l;try{const i=yield this.findSupabaseRoom(s);if(!i)return{success:!1,message:"Room not found in system"};const{data:u,error:d}=yield h.from("environmental_cleans_enhanced").update({status:"completed",completed_time:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("room_id",s).order("created_at",{ascending:!1}).limit(1).select().single();if(d)throw d;if(t&&t.length>0&&u){const{data:c}=yield h.auth.getUser(),a=(l=c==null?void 0:c.user)==null?void 0:l.id,n=t.map(o=>({environmental_clean_id:u.id,inventory_item_id:o.itemId,quantity_used:o.quantity,usage_reason:o.usageReason,task_step:o.taskStep,used_by:a!=null?a:null})),{error:p}=yield h.from("environmental_cleaning_inventory_usage").insert(n);p&&console.error("❌ Error tracking inventory usage:",p)}return j.log("environmental_clean","room_cleaning_completed",{roomId:s,roomName:i.name,inventoryUsage:(t==null?void 0:t.length)||0,timestamp:new Date().toISOString()}),{success:!0,message:`Room "${i.name}" cleaning completed successfully`,roomId:s,status:"clean"}}catch(i){return console.error("❌ Error completing room cleaning:",i),{success:!1,message:"An error occurred while completing room cleaning. Please try again."}}})}static getAvailableStatuses(){const s=w.getState(),t=s.getCoreStatusTypes(),l=s.getPublishedStatusTypes();return[...t,...l.filter(i=>!i.isCore)]}static mapStatusToDatabase(s){return{Clean:"clean",Dirty:"dirty","In Progress":"in_progress","Out of Service":"cancelled",Supervisor:"pending",Isolation:"failed",Quarantine:"failed",Maintenance:"pending","Equipment Failure":"failed","Patient Occupied":"pending","Discharge Cleaning":"pending",Unassigned:"pending","Audit Required":"pending"}[s]||"dirty"}static mapDatabaseToStatus(s){return{completed:"Clean",clean:"Clean",pending:"Dirty",dirty:"Dirty",in_progress:"In Progress",failed:"Supervisor",cancelled:"Out of Service"}[s]||"Dirty"}}var N=(g,s,t)=>new Promise((l,i)=>{var u=a=>{try{c(t.next(a))}catch(n){i(n)}},d=a=>{try{c(t.throw(a))}catch(n){i(n)}},c=a=>a.done?l(a.value):Promise.resolve(a.value).then(u,d);c((t=t.apply(g,s)).next())});const Z=()=>{var g;const s=T(),{getAllStatusTypes:t}=w(),[l,i]=b.useState(!1),[u,d]=b.useState(null),[c,a]=b.useState(""),[n,p]=b.useState(""),[o,C]=b.useState(null),R=b.useMemo(()=>{const r=y.getAvailableStatuses(),f=U();return r.map(m=>({id:m.id,name:m.name,icon:B(m.icon||"default",f.iconMap),color:m.color||"#4b5563",bgColor:q(m.color||"#4b5563",f.bgColorMap),textColor:k(m.color||"#4b5563",f.textColorMap),description:m.description||"",isCore:m.isCore||!1}))},[]),E=()=>N(null,null,function*(){i(!0),d(null),C(null);try{const r=["ROOM-001","ROOM-002","ROOM-003","ROOM-004","ROOM-005"],f=r[Math.floor(Math.random()*r.length)],m=yield y.scanRoomBarcode(f);m.success&&m.room?(d("success"),a(m.message),C(m.room)):(d("error"),a(m.message))}catch(r){console.error(r),d("error"),a("An error occurred during scanning. Please try again.")}finally{i(!1)}}),M=r=>{const m={clean:"clean",dirty:"dirty",in_progress:"in_progress",available:"available",biohazard:"biohazard",theft:"theft",low_inventory:"low_inventory",out_of_service:"out_of_service",public_areas:"public_areas"}[r]||"dirty";p(m)},A=()=>N(null,null,function*(){if(!o){a("No room selected for cleaning completion");return}try{const r=yield y.completeRoomCleaning(o.id);r.success?(a(r.message),setTimeout(()=>{s("/environmental-clean")},2e3)):a(r.message)}catch(r){console.error(r),a("An error occurred while completing cleaning. Please try again.")}}),I=()=>N(null,null,function*(){if(!o||!n){a("Please select a room and status");return}try{const r=yield y.updateRoomStatus(o.id,n);r.success?(a(r.message),setTimeout(()=>{s("/environmental-clean")},2e3)):a(r.message)}catch(r){console.error(r),a("An error occurred while updating status. Please try again.")}}),S=()=>{s("/environmental-clean")};return e.jsxs(z,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 z-40",onClick:S,onKeyDown:r=>r.key==="Escape"&&S(),role:"button",tabIndex:0}),e.jsx(_.div,{initial:{x:"100%"},animate:{x:0},exit:{x:"100%"},transition:{duration:.3,ease:"easeInOut"},className:"fixed inset-y-0 right-0 w-[40%] bg-white shadow-2xl z-50",children:e.jsx("div",{className:"h-full flex flex-col",children:e.jsxs("div",{className:"bg-white overflow-hidden h-full",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center gap-4",children:[e.jsx("button",{onClick:S,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(x,{path:$,size:1.2,className:"text-gray-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Environmental Clean Scanner"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Scan rooms for cleaning management"})]})]}),e.jsx("div",{className:"p-4 overflow-y-auto flex-1 hide-scrollbar",children:n?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold text-blue-800 mb-1",children:[n.charAt(0).toUpperCase()+n.slice(1)," ","Status"]}),e.jsx("p",{className:"text-blue-600 text-sm",children:(g=R.find(r=>r.id===n))==null?void 0:g.description})]}),o&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-green-800 mb-1",children:"Scanned Room"}),e.jsxs("p",{className:"text-green-600 text-sm",children:[e.jsx("strong",{children:"Name:"})," ",o.name,e.jsx("br",{}),e.jsx("strong",{children:"Department:"})," ",o.department||"N/A",e.jsx("br",{}),e.jsx("strong",{children:"Floor:"})," ",o.floor||"N/A",e.jsx("br",{}),e.jsx("strong",{children:"Building:"})," ",o.building||"N/A"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs("div",{className:"relative bg-black h-64 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-900 to-black"}),e.jsx(_.div,{className:"absolute left-0 right-0 h-1 bg-[#4ECDC4]",animate:{top:["10%","90%","10%"],opacity:[.5,1,.5]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsxs("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-2 border-[#4ECDC4] w-48 h-48 rounded-lg",children:[e.jsx("div",{className:"absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-[#4ECDC4] rounded-tl"}),e.jsx("div",{className:"absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-[#4ECDC4] rounded-tr"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-[#4ECDC4] rounded-bl"}),e.jsx("div",{className:"absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-[#4ECDC4] rounded-br"})]}),e.jsxs("div",{className:"absolute bottom-4 right-4 flex items-center",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500 mr-2 animate-pulse"}),e.jsx("span",{className:"text-white text-xs",children:"Camera active"})]}),e.jsx("button",{onClick:E,disabled:l,className:`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-4 rounded-full transition-all duration-200 ${l?"bg-gray-600 cursor-not-allowed":"bg-[#4ECDC4] hover:bg-[#3db8b0] shadow-lg hover:shadow-xl"}`,children:e.jsx(x,{path:D,size:1.5,className:`${l?"text-gray-400":"text-white"}`})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800 mb-2",children:l?"Scanning...":"Click to Scan"}),e.jsx("p",{className:"text-gray-600 text-sm",children:l?"Position room barcode in camera view":"Use camera to scan room barcode"})]})]}),u&&e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`mt-4 p-4 rounded-lg ${u==="success"?"bg-green-100 border border-green-200":"bg-red-100 border border-red-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{path:D,size:1,className:u==="success"?"text-green-600":"text-red-600"}),e.jsx("span",{className:`font-medium ${u==="success"?"text-green-800":"text-red-800"}`,children:c})]})})]}),e.jsxs("div",{className:"flex justify-center space-x-4",children:[e.jsx("button",{onClick:()=>p(""),className:"px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors",children:"← Back to Status Selection"}),u==="success"&&o&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:I,className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors",children:"Update Status"}),e.jsx("button",{onClick:A,className:"px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors",children:"Complete Cleaning"})]})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800 mb-3",children:"Select Room Status"}),e.jsx("div",{className:"space-y-2",children:R.map(r=>e.jsx("button",{onClick:()=>M(r.id),className:"w-full p-3 rounded-lg border border-gray-200 shadow-sm transition-all duration-200 text-left hover:shadow-md hover:-translate-y-0.5 bg-white focus:outline-none focus:ring-2 focus:ring-[#4ECDC4]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`${r.bgColor} rounded-full p-2`,children:e.jsx(x,{path:r.icon,size:1,color:r.color,"aria-hidden":"true"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:`font-semibold text-sm ${r.textColor}`,children:r.name}),e.jsx("p",{className:`text-xs ${r.textColor} opacity-75`,children:r.description})]})]})},r.id))})]})})]})})})]})};export{Z as default};
